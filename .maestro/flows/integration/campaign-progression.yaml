# Campaign Progression Integration Test
# Tests full campaign flow from start through multiple levels
# Cross-platform: Web, Android, iOS
# This is an extended/nightly test

appId: ${PLATFORM == 'android' ? 'com.jbcom.stellardescent' : (PLATFORM == 'ios' ? 'com.jbcom.stellardescent' : null)}
url: ${PLATFORM == 'web' ? 'http://localhost:8080' : null}
tags:
  - integration
  - campaign
  - extended
  - nightly
name: "Campaign Progression - Multi-Level Flow"

---
- launchApp:
    clearState: true

# Wait for main menu
- extendedWaitUntil:
    visible: "NEW GAME"
    timeout: 30000

# Start new campaign
- tapOn:
    text: "NEW GAME"

# Handle difficulty selection
- tapOn:
    text: "NORMAL"
    optional: true

- wait: 500

- tapOn:
    text: "BEGIN"
    optional: true

# ==========================================
# LEVEL 1: ANCHOR STATION (Tutorial)
# ==========================================

- extendedWaitUntil:
    visible: "ANCHOR STATION PROMETHEUS"
    timeout: 15000

- takeScreenshot: "progression_level1_loading"

- extendedWaitUntil:
    visible: "SYSTEMS ONLINE"
    timeout: 60000

# Tutorial start
- extendedWaitUntil:
    visible: "Good morning"
    timeout: 30000

- takeScreenshot: "progression_level1_start"

# Skip through tutorial
- tapOn:
    text: "ACKNOWLEDGE"
    optional: true

- wait: 1000

- tapOn:
    text: "SKIP"
    optional: true

- wait: 2000

# Basic tutorial gameplay
- repeat:
    times: 3
    commands:
      - swipe:
          start: "10%, 70%"
          end: "15%, 55%"
          duration: 2000
      - wait: 500

- takeScreenshot: "progression_level1_gameplay"

# Wait for level completion or transition
- wait: 5000

# Check for level completion screen
- assertVisible:
    text: "MISSION COMPLETE"
    optional: true
    timeout: 60000

- takeScreenshot: "progression_level1_complete"

# If completion screen, click continue
- tapOn:
    text: "CONTINUE"
    optional: true

- wait: 2000

# ==========================================
# LEVEL 2: LANDFALL (Expected next level)
# ==========================================

# Look for Landfall loading or drop sequence
- assertVisible:
    text: "LANDFALL"
    optional: true
    timeout: 30000

- assertVisible:
    text: "ORBITAL DROP INITIATED"
    optional: true

- takeScreenshot: "progression_level2_start"

# Landfall gameplay
- repeat:
    times: 5
    commands:
      - swipe:
          start: "10%, 70%"
          end: "15%, 58%"
          duration: 2000
      - wait: 300
      - tapOn:
          id: "fire-button"
          optional: true
      - wait: 500

- takeScreenshot: "progression_level2_gameplay"

# Wait for level completion
- wait: 10000

- assertVisible:
    text: "MISSION COMPLETE"
    optional: true
    timeout: 120000

- takeScreenshot: "progression_level2_complete"

# Continue to next level
- tapOn:
    text: "CONTINUE"
    optional: true

- wait: 2000

# ==========================================
# VERIFY PROGRESSION
# ==========================================

# If we got this far, pause the game
- tapOn:
    id: "pause-button"
    optional: true

- tapOn:
    point: "95%, 5%"
    optional: true

- wait: 500

# Check pause menu
- assertVisible:
    text: "RESUME"
    optional: true

- assertVisible:
    text: "QUIT"
    optional: true

- takeScreenshot: "progression_pause_menu"

# Quit to main menu
- tapOn:
    text: "QUIT"
    optional: true

- tapOn:
    text: "MAIN MENU"
    optional: true

- wait: 2000

# Verify we're at main menu
- assertVisible:
    text: "CONTINUE"
    optional: true
    timeout: 10000

- takeScreenshot: "progression_main_menu_with_save"

# Check level select to verify progress
- tapOn:
    text: "SELECT MISSION"
    optional: true

- wait: 1000

# Level 2 should now be unlocked if we completed level 1
- assertVisible:
    text: "LANDFALL"
    optional: true

- takeScreenshot: "progression_level_select_progress"

# Close and finish
- tapOn:
    text: "BACK"
    optional: true

- wait: 500

- takeScreenshot: "progression_test_complete"
