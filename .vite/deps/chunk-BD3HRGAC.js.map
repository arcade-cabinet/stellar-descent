{
  "version": 3,
  "sources": ["../../node_modules/.pnpm/@babylonjs+core@8.49.1/dev/core/src/Meshes/meshSimplification.ts"],
  "sourcesContent": ["import type { IndicesArray } from \"../types\";\r\nimport { Vector3 } from \"../Maths/math.vector\";\r\nimport { VertexBuffer } from \"../Buffers/buffer\";\r\nimport { SubMesh } from \"../Meshes/subMesh\";\r\nimport { Mesh } from \"../Meshes/mesh\";\r\nimport { AsyncLoop } from \"../Misc/tools\";\r\nimport { Epsilon } from \"../Maths/math.constants\";\r\n/**\r\n * A simplifier interface for future simplification implementations\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport interface ISimplifier {\r\n    /**\r\n     * Simplification of a given mesh according to the given settings.\r\n     * Since this requires computation, it is assumed that the function runs async.\r\n     * @param settings The settings of the simplification, including quality and distance\r\n     * @param successCallback A callback that will be called after the mesh was simplified.\r\n     * @param errorCallback in case of an error, this callback will be called. optional.\r\n     */\r\n    simplify(settings: ISimplificationSettings, successCallback: (simplifiedMeshes: Mesh) => void, errorCallback?: () => void): void;\r\n}\r\n\r\n/**\r\n * Expected simplification settings.\r\n * Quality should be between 0 and 1 (1 being 100%, 0 being 0%)\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport interface ISimplificationSettings {\r\n    /**\r\n     * Gets or sets the expected quality\r\n     */\r\n    quality: number;\r\n    /**\r\n     * Gets or sets the distance when this optimized version should be used\r\n     */\r\n    distance: number;\r\n    /**\r\n     * Gets an already optimized mesh\r\n     */\r\n    optimizeMesh?: boolean | undefined;\r\n}\r\n\r\n/**\r\n * Class used to specify simplification options\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport class SimplificationSettings implements ISimplificationSettings {\r\n    /**\r\n     * Creates a SimplificationSettings\r\n     * @param quality expected quality\r\n     * @param distance distance when this optimized version should be used\r\n     * @param optimizeMesh already optimized mesh\r\n     */\r\n    constructor(\r\n        /** expected quality */\r\n        public quality: number,\r\n        /** distance when this optimized version should be used */\r\n        public distance: number,\r\n        /** already optimized mesh  */\r\n        public optimizeMesh?: boolean\r\n    ) {}\r\n}\r\n\r\n/**\r\n * Interface used to define a simplification task\r\n */\r\nexport interface ISimplificationTask {\r\n    /**\r\n     * Array of settings\r\n     */\r\n    settings: Array<ISimplificationSettings>;\r\n    /**\r\n     * Simplification type\r\n     */\r\n    simplificationType: SimplificationType;\r\n    /**\r\n     * Mesh to simplify\r\n     */\r\n    mesh: Mesh;\r\n    /**\r\n     * Callback called on success\r\n     */\r\n    successCallback?: () => void;\r\n    /**\r\n     * Defines if parallel processing can be used\r\n     */\r\n    parallelProcessing: boolean;\r\n}\r\n\r\n/**\r\n * Queue used to order the simplification tasks\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport class SimplificationQueue {\r\n    private _simplificationArray: Array<ISimplificationTask>;\r\n\r\n    /**\r\n     * Gets a boolean indicating that the process is still running\r\n     */\r\n    public running: boolean;\r\n\r\n    /**\r\n     * Creates a new queue\r\n     */\r\n    constructor() {\r\n        this.running = false;\r\n        this._simplificationArray = [];\r\n    }\r\n\r\n    /**\r\n     * Adds a new simplification task\r\n     * @param task defines a task to add\r\n     */\r\n    public addTask(task: ISimplificationTask) {\r\n        this._simplificationArray.push(task);\r\n    }\r\n\r\n    /**\r\n     * Execute next task\r\n     */\r\n    public executeNext() {\r\n        const task = this._simplificationArray.pop();\r\n        if (task) {\r\n            this.running = true;\r\n            this.runSimplification(task);\r\n        } else {\r\n            this.running = false;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Execute a simplification task\r\n     * @param task defines the task to run\r\n     */\r\n    public runSimplification(task: ISimplificationTask) {\r\n        if (task.parallelProcessing) {\r\n            //parallel simplifier\r\n            for (const setting of task.settings) {\r\n                const simplifier = this._getSimplifier(task);\r\n                simplifier.simplify(setting, (newMesh) => {\r\n                    if (setting.distance !== undefined) {\r\n                        task.mesh.addLODLevel(setting.distance, newMesh);\r\n                    }\r\n                    newMesh.isVisible = true;\r\n                    //check if it is the last\r\n                    if (setting.quality === task.settings[task.settings.length - 1].quality && task.successCallback) {\r\n                        //all done, run the success callback.\r\n                        task.successCallback();\r\n                    }\r\n                    this.executeNext();\r\n                });\r\n            }\r\n        } else {\r\n            //single simplifier.\r\n            const simplifier = this._getSimplifier(task);\r\n\r\n            const runDecimation = (setting: ISimplificationSettings, callback: () => void) => {\r\n                simplifier.simplify(setting, (newMesh) => {\r\n                    if (setting.distance !== undefined) {\r\n                        task.mesh.addLODLevel(setting.distance, newMesh);\r\n                    }\r\n                    newMesh.isVisible = true;\r\n                    //run the next quality level\r\n                    callback();\r\n                });\r\n            };\r\n\r\n            AsyncLoop.Run(\r\n                task.settings.length,\r\n                (loop: AsyncLoop) => {\r\n                    runDecimation(task.settings[loop.index], () => {\r\n                        loop.executeNext();\r\n                    });\r\n                },\r\n                () => {\r\n                    //execution ended, run the success callback.\r\n                    if (task.successCallback) {\r\n                        task.successCallback();\r\n                    }\r\n                    this.executeNext();\r\n                }\r\n            );\r\n        }\r\n    }\r\n\r\n    private _getSimplifier(task: ISimplificationTask): ISimplifier {\r\n        switch (task.simplificationType) {\r\n            case SimplificationType.QUADRATIC:\r\n            default:\r\n                return new QuadraticErrorSimplification(task.mesh);\r\n        }\r\n    }\r\n}\r\n\r\n/**\r\n * The implemented types of simplification\r\n * At the moment only Quadratic Error Decimation is implemented\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport const enum SimplificationType {\r\n    /** Quadratic error decimation */\r\n    QUADRATIC,\r\n}\r\n\r\nclass DecimationTriangle {\r\n    public normal: Vector3;\r\n    public error: Array<number>;\r\n    public deleted: boolean;\r\n    public isDirty: boolean;\r\n    public borderFactor: number;\r\n    public deletePending: boolean;\r\n\r\n    public originalOffset: number;\r\n\r\n    constructor(public _vertices: Array<DecimationVertex>) {\r\n        this.error = new Array<number>(4);\r\n        this.deleted = false;\r\n        this.isDirty = false;\r\n        this.deletePending = false;\r\n        this.borderFactor = 0;\r\n    }\r\n}\r\n\r\nclass DecimationVertex {\r\n    public q: QuadraticMatrix;\r\n    public isBorder: boolean;\r\n\r\n    public triangleStart: number;\r\n    public triangleCount: number;\r\n\r\n    public originalOffsets: Array<number>;\r\n\r\n    constructor(\r\n        public position: Vector3,\r\n        public id: number\r\n    ) {\r\n        this.isBorder = true;\r\n        this.q = new QuadraticMatrix();\r\n        this.triangleCount = 0;\r\n        this.triangleStart = 0;\r\n        this.originalOffsets = [];\r\n    }\r\n\r\n    public updatePosition(newPosition: Vector3) {\r\n        this.position.copyFrom(newPosition);\r\n    }\r\n}\r\n\r\nclass QuadraticMatrix {\r\n    public data: Array<number>;\r\n\r\n    constructor(data?: Array<number>) {\r\n        this.data = new Array(10);\r\n        for (let i = 0; i < 10; ++i) {\r\n            if (data && data[i]) {\r\n                this.data[i] = data[i];\r\n            } else {\r\n                this.data[i] = 0;\r\n            }\r\n        }\r\n    }\r\n\r\n    public det(a11: number, a12: number, a13: number, a21: number, a22: number, a23: number, a31: number, a32: number, a33: number): number {\r\n        const det =\r\n            this.data[a11] * this.data[a22] * this.data[a33] +\r\n            this.data[a13] * this.data[a21] * this.data[a32] +\r\n            this.data[a12] * this.data[a23] * this.data[a31] -\r\n            this.data[a13] * this.data[a22] * this.data[a31] -\r\n            this.data[a11] * this.data[a23] * this.data[a32] -\r\n            this.data[a12] * this.data[a21] * this.data[a33];\r\n        return det;\r\n    }\r\n\r\n    public addInPlace(matrix: QuadraticMatrix) {\r\n        for (let i = 0; i < 10; ++i) {\r\n            this.data[i] += matrix.data[i];\r\n        }\r\n    }\r\n\r\n    public addArrayInPlace(data: Array<number>) {\r\n        for (let i = 0; i < 10; ++i) {\r\n            this.data[i] += data[i];\r\n        }\r\n    }\r\n\r\n    public add(matrix: QuadraticMatrix): QuadraticMatrix {\r\n        const m = new QuadraticMatrix();\r\n        for (let i = 0; i < 10; ++i) {\r\n            m.data[i] = this.data[i] + matrix.data[i];\r\n        }\r\n        return m;\r\n    }\r\n\r\n    public static FromData(a: number, b: number, c: number, d: number): QuadraticMatrix {\r\n        return new QuadraticMatrix(QuadraticMatrix.DataFromNumbers(a, b, c, d));\r\n    }\r\n\r\n    //returning an array to avoid garbage collection\r\n    public static DataFromNumbers(a: number, b: number, c: number, d: number) {\r\n        return [a * a, a * b, a * c, a * d, b * b, b * c, b * d, c * c, c * d, d * d];\r\n    }\r\n}\r\n\r\nclass Reference {\r\n    constructor(\r\n        public vertexId: number,\r\n        public triangleId: number\r\n    ) {}\r\n}\r\n\r\n/**\r\n * An implementation of the Quadratic Error simplification algorithm.\r\n * Original paper : http://www1.cs.columbia.edu/~cs4162/html05s/garland97.pdf\r\n * Ported mostly from QSlim and http://voxels.blogspot.de/2014/05/quadric-mesh-simplification-with-source.html to babylon JS\r\n * @author RaananW\r\n * @see https://doc.babylonjs.com/features/featuresDeepDive/mesh/simplifyingMeshes\r\n */\r\nexport class QuadraticErrorSimplification implements ISimplifier {\r\n    private _triangles: Array<DecimationTriangle>;\r\n    private _vertices: Array<DecimationVertex>;\r\n    private _references: Array<Reference>;\r\n\r\n    private _reconstructedMesh: Mesh;\r\n\r\n    /** Gets or sets the number pf sync iterations */\r\n    public syncIterations = 5000;\r\n\r\n    /** Gets or sets the aggressiveness of the simplifier */\r\n    public aggressiveness: number;\r\n\r\n    /** Gets or sets the number of allowed iterations for decimation */\r\n    public decimationIterations: number;\r\n\r\n    /** Gets or sets the espilon to use for bounding box computation */\r\n    public boundingBoxEpsilon: number;\r\n\r\n    /**\r\n     * Creates a new QuadraticErrorSimplification\r\n     * @param _mesh defines the target mesh\r\n     */\r\n    constructor(private _mesh: Mesh) {\r\n        this.aggressiveness = 7;\r\n        this.decimationIterations = 100;\r\n        this.boundingBoxEpsilon = Epsilon;\r\n    }\r\n\r\n    /**\r\n     * Simplification of a given mesh according to the given settings.\r\n     * Since this requires computation, it is assumed that the function runs async.\r\n     * @param settings The settings of the simplification, including quality and distance\r\n     * @param successCallback A callback that will be called after the mesh was simplified.\r\n     */\r\n    public simplify(settings: ISimplificationSettings, successCallback: (simplifiedMesh: Mesh) => void) {\r\n        this._initDecimatedMesh();\r\n        //iterating through the submeshes array, one after the other.\r\n        AsyncLoop.Run(\r\n            this._mesh.subMeshes.length,\r\n            (loop: AsyncLoop) => {\r\n                this._initWithMesh(\r\n                    loop.index,\r\n                    () => {\r\n                        this._runDecimation(settings, loop.index, () => {\r\n                            loop.executeNext();\r\n                        });\r\n                    },\r\n                    settings.optimizeMesh\r\n                );\r\n            },\r\n            () => {\r\n                setTimeout(() => {\r\n                    successCallback(this._reconstructedMesh);\r\n                }, 0);\r\n            }\r\n        );\r\n    }\r\n\r\n    private _runDecimation(settings: ISimplificationSettings, submeshIndex: number, successCallback: () => void) {\r\n        const targetCount = ~~(this._triangles.length * settings.quality);\r\n        let deletedTriangles = 0;\r\n\r\n        const triangleCount = this._triangles.length;\r\n\r\n        const iterationFunction = (iteration: number, callback: () => void) => {\r\n            setTimeout(() => {\r\n                if (iteration % 5 === 0) {\r\n                    this._updateMesh(iteration === 0);\r\n                }\r\n\r\n                for (let i = 0; i < this._triangles.length; ++i) {\r\n                    this._triangles[i].isDirty = false;\r\n                }\r\n\r\n                const threshold = 0.000000001 * Math.pow(iteration + 3, this.aggressiveness);\r\n\r\n                const trianglesIterator = (i: number) => {\r\n                    const tIdx = ~~((this._triangles.length / 2 + i) % this._triangles.length);\r\n                    const t = this._triangles[tIdx];\r\n                    if (!t) {\r\n                        return;\r\n                    }\r\n                    if (t.error[3] > threshold || t.deleted || t.isDirty) {\r\n                        return;\r\n                    }\r\n                    for (let j = 0; j < 3; ++j) {\r\n                        if (t.error[j] < threshold) {\r\n                            const deleted0: Array<boolean> = [];\r\n                            const deleted1: Array<boolean> = [];\r\n\r\n                            const v0 = t._vertices[j];\r\n                            const v1 = t._vertices[(j + 1) % 3];\r\n\r\n                            if (v0.isBorder || v1.isBorder) {\r\n                                continue;\r\n                            }\r\n\r\n                            const p = Vector3.Zero();\r\n                            // var n = Vector3.Zero();\r\n                            // var uv = Vector2.Zero();\r\n                            // var color = new Color4(0, 0, 0, 1);\r\n\r\n                            this._calculateError(v0, v1, p);\r\n\r\n                            const delTr: DecimationTriangle[] = [];\r\n\r\n                            if (this._isFlipped(v0, v1, p, deleted0, delTr)) {\r\n                                continue;\r\n                            }\r\n                            if (this._isFlipped(v1, v0, p, deleted1, delTr)) {\r\n                                continue;\r\n                            }\r\n\r\n                            if (deleted0.indexOf(true) < 0 || deleted1.indexOf(true) < 0) {\r\n                                continue;\r\n                            }\r\n\r\n                            const uniqueArray: DecimationTriangle[] = [];\r\n                            for (const deletedT of delTr) {\r\n                                if (uniqueArray.indexOf(deletedT) === -1) {\r\n                                    deletedT.deletePending = true;\r\n                                    uniqueArray.push(deletedT);\r\n                                }\r\n                            }\r\n\r\n                            if (uniqueArray.length % 2 !== 0) {\r\n                                continue;\r\n                            }\r\n\r\n                            v0.q = v1.q.add(v0.q);\r\n\r\n                            v0.updatePosition(p);\r\n\r\n                            const tStart = this._references.length;\r\n\r\n                            deletedTriangles = this._updateTriangles(v0, v0, deleted0, deletedTriangles);\r\n                            deletedTriangles = this._updateTriangles(v0, v1, deleted1, deletedTriangles);\r\n\r\n                            const tCount = this._references.length - tStart;\r\n\r\n                            if (tCount <= v0.triangleCount) {\r\n                                if (tCount) {\r\n                                    for (let c = 0; c < tCount; c++) {\r\n                                        this._references[v0.triangleStart + c] = this._references[tStart + c];\r\n                                    }\r\n                                }\r\n                            } else {\r\n                                v0.triangleStart = tStart;\r\n                            }\r\n\r\n                            v0.triangleCount = tCount;\r\n                            break;\r\n                        }\r\n                    }\r\n                };\r\n                AsyncLoop.SyncAsyncForLoop(this._triangles.length, this.syncIterations, trianglesIterator, callback, () => {\r\n                    return triangleCount - deletedTriangles <= targetCount;\r\n                });\r\n            }, 0);\r\n        };\r\n\r\n        AsyncLoop.Run(\r\n            this.decimationIterations,\r\n            (loop: AsyncLoop) => {\r\n                if (triangleCount - deletedTriangles <= targetCount) {\r\n                    loop.breakLoop();\r\n                } else {\r\n                    iterationFunction(loop.index, () => {\r\n                        loop.executeNext();\r\n                    });\r\n                }\r\n            },\r\n            () => {\r\n                setTimeout(() => {\r\n                    //reconstruct this part of the mesh\r\n                    this._reconstructMesh(submeshIndex);\r\n                    successCallback();\r\n                }, 0);\r\n            }\r\n        );\r\n    }\r\n\r\n    private _initWithMesh(submeshIndex: number, callback: Function, optimizeMesh?: boolean) {\r\n        this._vertices = [];\r\n        this._triangles = [];\r\n\r\n        const positionData = this._mesh.getVerticesData(VertexBuffer.PositionKind);\r\n\r\n        const indices = this._mesh.getIndices();\r\n        const submesh = this._mesh.subMeshes[submeshIndex];\r\n\r\n        const findInVertices = (positionToSearch: Vector3) => {\r\n            if (optimizeMesh) {\r\n                for (let ii = 0; ii < this._vertices.length; ++ii) {\r\n                    if (this._vertices[ii].position.equalsWithEpsilon(positionToSearch, 0.0001)) {\r\n                        return this._vertices[ii];\r\n                    }\r\n                }\r\n            }\r\n            return null;\r\n        };\r\n\r\n        const vertexReferences: Array<number> = [];\r\n\r\n        const vertexInit = (i: number) => {\r\n            if (!positionData) {\r\n                return;\r\n            }\r\n\r\n            const offset = i + submesh.verticesStart;\r\n            const position = Vector3.FromArray(positionData, offset * 3);\r\n\r\n            const vertex = findInVertices(position) || new DecimationVertex(position, this._vertices.length);\r\n            vertex.originalOffsets.push(offset);\r\n            if (vertex.id === this._vertices.length) {\r\n                this._vertices.push(vertex);\r\n            }\r\n            vertexReferences.push(vertex.id);\r\n        };\r\n        //var totalVertices = mesh.getTotalVertices();\r\n        const totalVertices = submesh.verticesCount;\r\n        AsyncLoop.SyncAsyncForLoop(totalVertices, (this.syncIterations / 4) >> 0, vertexInit, () => {\r\n            const indicesInit = (i: number) => {\r\n                if (!indices) {\r\n                    return;\r\n                }\r\n\r\n                const offset = submesh.indexStart / 3 + i;\r\n                const pos = offset * 3;\r\n                const i0 = indices[pos + 0];\r\n                const i1 = indices[pos + 1];\r\n                const i2 = indices[pos + 2];\r\n                const v0: DecimationVertex = this._vertices[vertexReferences[i0 - submesh.verticesStart]];\r\n                const v1: DecimationVertex = this._vertices[vertexReferences[i1 - submesh.verticesStart]];\r\n                const v2: DecimationVertex = this._vertices[vertexReferences[i2 - submesh.verticesStart]];\r\n                const triangle = new DecimationTriangle([v0, v1, v2]);\r\n                triangle.originalOffset = pos;\r\n                this._triangles.push(triangle);\r\n            };\r\n            AsyncLoop.SyncAsyncForLoop(submesh.indexCount / 3, this.syncIterations, indicesInit, () => {\r\n                this._init(callback);\r\n            });\r\n        });\r\n    }\r\n\r\n    private _init(callback: Function) {\r\n        const triangleInit1 = (i: number) => {\r\n            const t = this._triangles[i];\r\n            t.normal = Vector3.Cross(t._vertices[1].position.subtract(t._vertices[0].position), t._vertices[2].position.subtract(t._vertices[0].position)).normalize();\r\n            for (let j = 0; j < 3; j++) {\r\n                t._vertices[j].q.addArrayInPlace(QuadraticMatrix.DataFromNumbers(t.normal.x, t.normal.y, t.normal.z, -Vector3.Dot(t.normal, t._vertices[0].position)));\r\n            }\r\n        };\r\n        AsyncLoop.SyncAsyncForLoop(this._triangles.length, this.syncIterations, triangleInit1, () => {\r\n            const triangleInit2 = (i: number) => {\r\n                const t = this._triangles[i];\r\n                for (let j = 0; j < 3; ++j) {\r\n                    t.error[j] = this._calculateError(t._vertices[j], t._vertices[(j + 1) % 3]);\r\n                }\r\n                t.error[3] = Math.min(t.error[0], t.error[1], t.error[2]);\r\n            };\r\n            AsyncLoop.SyncAsyncForLoop(this._triangles.length, this.syncIterations, triangleInit2, () => {\r\n                callback();\r\n            });\r\n        });\r\n    }\r\n\r\n    private _reconstructMesh(submeshIndex: number) {\r\n        const newTriangles: Array<DecimationTriangle> = [];\r\n        let i: number;\r\n        for (i = 0; i < this._vertices.length; ++i) {\r\n            this._vertices[i].triangleCount = 0;\r\n        }\r\n        let t: DecimationTriangle;\r\n        let j: number;\r\n        for (i = 0; i < this._triangles.length; ++i) {\r\n            if (!this._triangles[i].deleted) {\r\n                t = this._triangles[i];\r\n                for (j = 0; j < 3; ++j) {\r\n                    t._vertices[j].triangleCount = 1;\r\n                }\r\n                newTriangles.push(t);\r\n            }\r\n        }\r\n\r\n        const newPositionData = <number[]>(this._reconstructedMesh.getVerticesData(VertexBuffer.PositionKind) || []);\r\n        const newNormalData = <number[]>(this._reconstructedMesh.getVerticesData(VertexBuffer.NormalKind) || []);\r\n        const newUVsData = <number[]>(this._reconstructedMesh.getVerticesData(VertexBuffer.UVKind) || []);\r\n        const newColorsData = <number[]>(this._reconstructedMesh.getVerticesData(VertexBuffer.ColorKind) || []);\r\n\r\n        const normalData = this._mesh.getVerticesData(VertexBuffer.NormalKind);\r\n        const uvs = this._mesh.getVerticesData(VertexBuffer.UVKind);\r\n        const colorsData = this._mesh.getVerticesData(VertexBuffer.ColorKind);\r\n\r\n        let vertexCount = 0;\r\n        for (i = 0; i < this._vertices.length; ++i) {\r\n            const vertex = this._vertices[i];\r\n            vertex.id = vertexCount;\r\n            if (vertex.triangleCount) {\r\n                for (const originalOffset of vertex.originalOffsets) {\r\n                    newPositionData.push(vertex.position.x);\r\n                    newPositionData.push(vertex.position.y);\r\n                    newPositionData.push(vertex.position.z);\r\n\r\n                    if (normalData && normalData.length) {\r\n                        newNormalData.push(normalData[originalOffset * 3]);\r\n                        newNormalData.push(normalData[originalOffset * 3 + 1]);\r\n                        newNormalData.push(normalData[originalOffset * 3 + 2]);\r\n                    }\r\n                    if (uvs && uvs.length) {\r\n                        newUVsData.push(uvs[originalOffset * 2]);\r\n                        newUVsData.push(uvs[originalOffset * 2 + 1]);\r\n                    }\r\n                    if (colorsData && colorsData.length) {\r\n                        newColorsData.push(colorsData[originalOffset * 4]);\r\n                        newColorsData.push(colorsData[originalOffset * 4 + 1]);\r\n                        newColorsData.push(colorsData[originalOffset * 4 + 2]);\r\n                        newColorsData.push(colorsData[originalOffset * 4 + 3]);\r\n                    }\r\n                    ++vertexCount;\r\n                }\r\n            }\r\n        }\r\n\r\n        const startingIndex = this._reconstructedMesh.getTotalIndices();\r\n        const startingVertex = this._reconstructedMesh.getTotalVertices();\r\n\r\n        const submeshesArray = this._reconstructedMesh.subMeshes;\r\n        this._reconstructedMesh.subMeshes = [];\r\n\r\n        const newIndicesArray: number[] = <number[]>this._reconstructedMesh.getIndices(); //[];\r\n        const originalIndices = <IndicesArray>this._mesh.getIndices();\r\n        for (i = 0; i < newTriangles.length; ++i) {\r\n            t = newTriangles[i]; //now get the new referencing point for each vertex\r\n            for (let idx = 0; idx < 3; ++idx) {\r\n                const id = originalIndices[t.originalOffset + idx];\r\n                let offset = t._vertices[idx].originalOffsets.indexOf(id);\r\n                if (offset < 0) {\r\n                    offset = 0;\r\n                }\r\n                newIndicesArray.push(t._vertices[idx].id + offset + startingVertex);\r\n            }\r\n        }\r\n\r\n        //overwriting the old vertex buffers and indices.\r\n\r\n        this._reconstructedMesh.setIndices(newIndicesArray);\r\n        this._reconstructedMesh.setVerticesData(VertexBuffer.PositionKind, newPositionData);\r\n        if (newNormalData.length > 0) {\r\n            this._reconstructedMesh.setVerticesData(VertexBuffer.NormalKind, newNormalData);\r\n        }\r\n        if (newUVsData.length > 0) {\r\n            this._reconstructedMesh.setVerticesData(VertexBuffer.UVKind, newUVsData);\r\n        }\r\n        if (newColorsData.length > 0) {\r\n            this._reconstructedMesh.setVerticesData(VertexBuffer.ColorKind, newColorsData);\r\n        }\r\n\r\n        //create submesh\r\n        const originalSubmesh = this._mesh.subMeshes[submeshIndex];\r\n        if (submeshIndex > 0) {\r\n            this._reconstructedMesh.subMeshes = [];\r\n            for (const submesh of submeshesArray) {\r\n                SubMesh.AddToMesh(\r\n                    submesh.materialIndex,\r\n                    submesh.verticesStart,\r\n                    submesh.verticesCount,\r\n                    /* 0, newPositionData.length/3, */ submesh.indexStart,\r\n                    submesh.indexCount,\r\n                    submesh.getMesh()\r\n                );\r\n            }\r\n            SubMesh.AddToMesh(\r\n                originalSubmesh.materialIndex,\r\n                startingVertex,\r\n                vertexCount,\r\n                /* 0, newPositionData.length / 3, */ startingIndex,\r\n                newTriangles.length * 3,\r\n                this._reconstructedMesh\r\n            );\r\n        }\r\n    }\r\n\r\n    private _initDecimatedMesh() {\r\n        this._reconstructedMesh = new Mesh(this._mesh.name + \"Decimated\", this._mesh.getScene());\r\n        this._reconstructedMesh.material = this._mesh.material;\r\n        this._reconstructedMesh.parent = this._mesh.parent;\r\n        this._reconstructedMesh.isVisible = false;\r\n        this._reconstructedMesh.renderingGroupId = this._mesh.renderingGroupId;\r\n    }\r\n\r\n    private _isFlipped(vertex1: DecimationVertex, vertex2: DecimationVertex, point: Vector3, deletedArray: Array<boolean>, delTr: Array<DecimationTriangle>): boolean {\r\n        for (let i = 0; i < vertex1.triangleCount; ++i) {\r\n            const t = this._triangles[this._references[vertex1.triangleStart + i].triangleId];\r\n            if (t.deleted) {\r\n                continue;\r\n            }\r\n\r\n            const s = this._references[vertex1.triangleStart + i].vertexId;\r\n\r\n            const v1 = t._vertices[(s + 1) % 3];\r\n            const v2 = t._vertices[(s + 2) % 3];\r\n\r\n            if (v1 === vertex2 || v2 === vertex2) {\r\n                deletedArray[i] = true;\r\n                delTr.push(t);\r\n                continue;\r\n            }\r\n\r\n            let d1 = v1.position.subtract(point);\r\n            d1 = d1.normalize();\r\n            let d2 = v2.position.subtract(point);\r\n            d2 = d2.normalize();\r\n            if (Math.abs(Vector3.Dot(d1, d2)) > 0.999) {\r\n                return true;\r\n            }\r\n            const normal = Vector3.Cross(d1, d2).normalize();\r\n            deletedArray[i] = false;\r\n            if (Vector3.Dot(normal, t.normal) < 0.2) {\r\n                return true;\r\n            }\r\n        }\r\n\r\n        return false;\r\n    }\r\n\r\n    private _updateTriangles(origVertex: DecimationVertex, vertex: DecimationVertex, deletedArray: Array<boolean>, deletedTriangles: number): number {\r\n        let newDeleted = deletedTriangles;\r\n        for (let i = 0; i < vertex.triangleCount; ++i) {\r\n            const ref = this._references[vertex.triangleStart + i];\r\n            const t = this._triangles[ref.triangleId];\r\n            if (t.deleted) {\r\n                continue;\r\n            }\r\n            if (deletedArray[i] && t.deletePending) {\r\n                t.deleted = true;\r\n                newDeleted++;\r\n                continue;\r\n            }\r\n            t._vertices[ref.vertexId] = origVertex;\r\n            t.isDirty = true;\r\n            t.error[0] = this._calculateError(t._vertices[0], t._vertices[1]) + t.borderFactor / 2;\r\n            t.error[1] = this._calculateError(t._vertices[1], t._vertices[2]) + t.borderFactor / 2;\r\n            t.error[2] = this._calculateError(t._vertices[2], t._vertices[0]) + t.borderFactor / 2;\r\n            t.error[3] = Math.min(t.error[0], t.error[1], t.error[2]);\r\n            this._references.push(ref);\r\n        }\r\n        return newDeleted;\r\n    }\r\n\r\n    private _identifyBorder() {\r\n        for (let i = 0; i < this._vertices.length; ++i) {\r\n            const vCount: Array<number> = [];\r\n            const vId: Array<number> = [];\r\n            const v = this._vertices[i];\r\n            let j: number;\r\n            for (j = 0; j < v.triangleCount; ++j) {\r\n                const triangle = this._triangles[this._references[v.triangleStart + j].triangleId];\r\n                for (let ii = 0; ii < 3; ii++) {\r\n                    let ofs = 0;\r\n                    const vv = triangle._vertices[ii];\r\n                    while (ofs < vCount.length) {\r\n                        if (vId[ofs] === vv.id) {\r\n                            break;\r\n                        }\r\n                        ++ofs;\r\n                    }\r\n                    if (ofs === vCount.length) {\r\n                        vCount.push(1);\r\n                        vId.push(vv.id);\r\n                    } else {\r\n                        vCount[ofs]++;\r\n                    }\r\n                }\r\n            }\r\n\r\n            for (j = 0; j < vCount.length; ++j) {\r\n                if (vCount[j] === 1) {\r\n                    this._vertices[vId[j]].isBorder = true;\r\n                } else {\r\n                    this._vertices[vId[j]].isBorder = false;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    private _updateMesh(identifyBorders: boolean = false) {\r\n        let i: number;\r\n        if (!identifyBorders) {\r\n            const newTrianglesVector: Array<DecimationTriangle> = [];\r\n            for (i = 0; i < this._triangles.length; ++i) {\r\n                if (!this._triangles[i].deleted) {\r\n                    newTrianglesVector.push(this._triangles[i]);\r\n                }\r\n            }\r\n            this._triangles = newTrianglesVector;\r\n        }\r\n\r\n        for (i = 0; i < this._vertices.length; ++i) {\r\n            this._vertices[i].triangleCount = 0;\r\n            this._vertices[i].triangleStart = 0;\r\n        }\r\n        let t: DecimationTriangle;\r\n        let j: number;\r\n        let v: DecimationVertex;\r\n        for (i = 0; i < this._triangles.length; ++i) {\r\n            t = this._triangles[i];\r\n            for (j = 0; j < 3; ++j) {\r\n                v = t._vertices[j];\r\n                v.triangleCount++;\r\n            }\r\n        }\r\n\r\n        let tStart = 0;\r\n\r\n        for (i = 0; i < this._vertices.length; ++i) {\r\n            this._vertices[i].triangleStart = tStart;\r\n            tStart += this._vertices[i].triangleCount;\r\n            this._vertices[i].triangleCount = 0;\r\n        }\r\n\r\n        const newReferences: Array<Reference> = new Array(this._triangles.length * 3);\r\n        for (i = 0; i < this._triangles.length; ++i) {\r\n            t = this._triangles[i];\r\n            for (j = 0; j < 3; ++j) {\r\n                v = t._vertices[j];\r\n                newReferences[v.triangleStart + v.triangleCount] = new Reference(j, i);\r\n                v.triangleCount++;\r\n            }\r\n        }\r\n        this._references = newReferences;\r\n\r\n        if (identifyBorders) {\r\n            this._identifyBorder();\r\n        }\r\n    }\r\n\r\n    private _vertexError(q: QuadraticMatrix, point: Vector3): number {\r\n        const x = point.x;\r\n        const y = point.y;\r\n        const z = point.z;\r\n        return (\r\n            q.data[0] * x * x +\r\n            2 * q.data[1] * x * y +\r\n            2 * q.data[2] * x * z +\r\n            2 * q.data[3] * x +\r\n            q.data[4] * y * y +\r\n            2 * q.data[5] * y * z +\r\n            2 * q.data[6] * y +\r\n            q.data[7] * z * z +\r\n            2 * q.data[8] * z +\r\n            q.data[9]\r\n        );\r\n    }\r\n\r\n    private _calculateError(vertex1: DecimationVertex, vertex2: DecimationVertex, pointResult?: Vector3): number {\r\n        const q = vertex1.q.add(vertex2.q);\r\n        const border = vertex1.isBorder && vertex2.isBorder;\r\n        let error: number = 0;\r\n        const qDet = q.det(0, 1, 2, 1, 4, 5, 2, 5, 7);\r\n\r\n        if (qDet !== 0 && !border) {\r\n            if (!pointResult) {\r\n                pointResult = Vector3.Zero();\r\n            }\r\n            pointResult.x = (-1 / qDet) * q.det(1, 2, 3, 4, 5, 6, 5, 7, 8);\r\n            pointResult.y = (1 / qDet) * q.det(0, 2, 3, 1, 5, 6, 2, 7, 8);\r\n            pointResult.z = (-1 / qDet) * q.det(0, 1, 3, 1, 4, 6, 2, 5, 8);\r\n            error = this._vertexError(q, pointResult);\r\n        } else {\r\n            const p3 = vertex1.position.add(vertex2.position).divide(new Vector3(2, 2, 2));\r\n            //var norm3 = (vertex1.normal.add(vertex2.normal)).divide(new Vector3(2, 2, 2)).normalize();\r\n            const error1 = this._vertexError(q, vertex1.position);\r\n            const error2 = this._vertexError(q, vertex2.position);\r\n            const error3 = this._vertexError(q, p3);\r\n            error = Math.min(error1, error2, error3);\r\n            if (error === error1) {\r\n                if (pointResult) {\r\n                    pointResult.copyFrom(vertex1.position);\r\n                }\r\n            } else if (error === error2) {\r\n                if (pointResult) {\r\n                    pointResult.copyFrom(vertex2.position);\r\n                }\r\n            } else {\r\n                if (pointResult) {\r\n                    pointResult.copyFrom(p3);\r\n                }\r\n            }\r\n        }\r\n        return error;\r\n    }\r\n}\r\n"],
  "mappings": "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",
  "names": ["SimplificationType"]
}
