name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  deploy-web:
    name: Deploy to Netlify
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Deploy to Netlify
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=dist --site=$NETLIFY_SITE_ID
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: 1df7d7e0-b11c-4a74-8530-3b673b5b36ce

  build-android:
    name: Build Android APKs
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.nvmrc'
          cache: 'pnpm'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build web assets
        run: pnpm build

      - name: Add Android platform
        run: npx cap add android || true

      - name: Sync Capacitor
        run: npx cap sync android

      - name: Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: gradle-${{ runner.os }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            gradle-${{ runner.os }}-

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Build debug APK (arm64-v8a)
        run: |
          cd android
          ./gradlew assembleDebug \
            -Pandroid.injected.build.abi=arm64-v8a

      - name: Build debug APK (armeabi-v7a)
        run: |
          cd android
          ./gradlew assembleDebug \
            -Pandroid.injected.build.abi=armeabi-v7a

      - name: Build debug APK (x86_64)
        run: |
          cd android
          ./gradlew assembleDebug \
            -Pandroid.injected.build.abi=x86_64

      - name: Rename APKs with version
        run: |
          VERSION=${{ needs.release-please.outputs.version }}
          mkdir -p release-apks

          # Find and rename APKs
          find android/app/build/outputs/apk/debug -name "*.apk" | while read apk; do
            filename=$(basename "$apk" .apk)
            # Extract ABI from path or filename
            if [[ "$apk" == *"arm64"* ]]; then
              cp "$apk" "release-apks/stellar-descent-${VERSION}-arm64-v8a-debug.apk"
            elif [[ "$apk" == *"armeabi"* ]] || [[ "$apk" == *"arm-"* ]]; then
              cp "$apk" "release-apks/stellar-descent-${VERSION}-armeabi-v7a-debug.apk"
            elif [[ "$apk" == *"x86_64"* ]]; then
              cp "$apk" "release-apks/stellar-descent-${VERSION}-x86_64-debug.apk"
            else
              cp "$apk" "release-apks/stellar-descent-${VERSION}-universal-debug.apk"
            fi
          done

          ls -la release-apks/

      - name: Upload APKs to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: release-apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload APKs as artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apks-${{ needs.release-please.outputs.version }}
          path: release-apks/
          retention-days: 30

  e2e-android:
    name: E2E Tests (Android)
    runs-on: ubuntu-latest
    needs: build-android
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Download APKs
        uses: actions/download-artifact@v4
        with:
          name: android-apks-${{ needs.release-please.outputs.version }}
          path: release-apks/

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Maestro CLI
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Create and start Android emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            # Install APK
            adb install release-apks/stellar-descent-*-x86_64-debug.apk || adb install release-apks/stellar-descent-*-universal-debug.apk

            # Run Maestro tests
            maestro test .maestro/flows/ \
              --env PLATFORM=android \
              --format junit \
              --output test-results/maestro-android-results.xml || true

      - name: Upload E2E test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: e2e-android-results
          path: test-results/
          retention-days: 7
