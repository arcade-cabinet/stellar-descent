name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # ============================================================================
  # Release Please - Manages versioning and changelog
  # ============================================================================
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
    steps:
      - name: Release Please
        id: release
        uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38 # v4.4.0
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  # ============================================================================
  # STAGING: Always runs on release (GitHub Releases + Netlify)
  # ============================================================================

  # Web Deployment (Staging/Production share same Netlify)
  deploy-web:
    name: Deploy Web
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build web
        uses: ./.github/actions/build-web
        with:
          upload-artifact: false

      - name: Deploy to Netlify
        run: |
          npm install -g netlify-cli
          netlify deploy --prod --dir=dist --site=$NETLIFY_SITE_ID
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: 1df7d7e0-b11c-4a74-8530-3b673b5b36ce

      - name: Create web dist archive
        run: |
          cd dist
          zip -r ../stellar-descent-${{ needs.release-please.outputs.version }}-web.zip .

      - name: Upload web dist to release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: stellar-descent-${{ needs.release-please.outputs.version }}-web.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Android Debug APKs (Staging - always released to GitHub)
  build-android-debug:
    name: Build Android (Debug APKs)
    runs-on: ubuntu-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build Android debug APKs
        uses: ./.github/actions/build-android
        with:
          build-type: debug
          abi: all
          version: ${{ needs.release-please.outputs.version }}

      - name: Upload APKs to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: release-apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Desktop Builds (Staging - always released to GitHub)
  build-desktop:
    name: Build Desktop (${{ matrix.platform }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: staging
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux
            os: ubuntu-latest
          - platform: mac
            os: macos-latest
          - platform: win
            os: windows-latest
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Build Electron (${{ matrix.platform }})
        uses: ./.github/actions/build-electron
        with:
          platform: ${{ matrix.platform }}
          version: ${{ needs.release-please.outputs.version }}
          upload-artifact: true

      - name: Upload to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: electron-builds/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # PRODUCTION: Only runs when PRODUCTION_ENABLED=true in environment
  # These jobs deploy to app stores (Google Play, App Store, Steam)
  # ============================================================================

  # Google Play Store (Production)
  publish-play-store:
    name: Publish to Google Play
    runs-on: ubuntu-latest
    needs: [release-please, build-android-debug]
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: production
    steps:
      - name: Check production enabled
        run: |
          if [ "${{ vars.PRODUCTION_ENABLED }}" != "true" ]; then
            echo "::notice::Production releases are disabled. Set PRODUCTION_ENABLED=true in the 'production' environment to enable."
            exit 0
          fi

      - name: Checkout
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/setup-node-pnpm

      - name: Publish to Google Play
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/publish-play-store
        with:
          track: internal
          release-status: completed
          service-account-json-base64: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_BASE64 }}
          keystore-base64: ${{ secrets.ANDROID_RELEASE_KEYSTORE_BASE64 }}
          keystore-password: ${{ secrets.ANDROID_RELEASE_KEYSTORE_PASSWORD }}
          key-alias: ${{ secrets.ANDROID_RELEASE_KEY_ALIAS }}
          key-password: ${{ secrets.ANDROID_RELEASE_KEY_PASSWORD }}
          version: ${{ needs.release-please.outputs.version }}

  # iOS TestFlight (Production)
  build-ios:
    name: Build iOS (TestFlight)
    runs-on: macos-latest
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: production
    steps:
      - name: Check production enabled
        run: |
          if [ "${{ vars.PRODUCTION_ENABLED }}" != "true" ]; then
            echo "::notice::Production releases are disabled. Set PRODUCTION_ENABLED=true in the 'production' environment to enable."
            exit 0
          fi

      - name: Checkout
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/setup-node-pnpm

      - name: Build iOS and upload to TestFlight
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/build-ios
        with:
          upload-testflight: true
          distribute-external: false
          apple-api-key-id: ${{ secrets.APPLE_API_KEY_ID }}
          apple-api-issuer-id: ${{ secrets.APPLE_API_ISSUER_ID }}
          apple-api-key-base64: ${{ secrets.APPLE_API_KEY_BASE64 }}
          apple-team-id: ${{ secrets.APPLE_TEAM_ID }}
          match-password: ${{ secrets.MATCH_PASSWORD }}
          match-git-url: ${{ secrets.MATCH_GIT_URL }}
          match-git-basic-auth: ${{ secrets.MATCH_GIT_BASIC_AUTH }}
          version: ${{ needs.release-please.outputs.version }}

  # Steam (Production)
  publish-steam:
    name: Publish to Steam (${{ matrix.platform }})
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created == 'true' }}
    environment: production
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: windows
            os: windows-latest
            depot-id-var: STEAM_DEPOT_WINDOWS
          - platform: macos
            os: macos-latest
            depot-id-var: STEAM_DEPOT_MACOS
          - platform: linux
            os: ubuntu-latest
            depot-id-var: STEAM_DEPOT_LINUX
    runs-on: ${{ matrix.os }}
    steps:
      - name: Check production enabled
        shell: bash
        run: |
          if [ "${{ vars.PRODUCTION_ENABLED }}" != "true" ]; then
            echo "::notice::Production releases are disabled. Set PRODUCTION_ENABLED=true in the 'production' environment to enable."
            exit 0
          fi

      - name: Checkout
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Node.js and pnpm
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/setup-node-pnpm

      - name: Build and upload to Steam
        if: ${{ vars.PRODUCTION_ENABLED == 'true' }}
        uses: ./.github/actions/build-steam
        with:
          platform: ${{ matrix.platform }}
          steam-username: ${{ secrets.STEAM_USERNAME }}
          steam-config-vdf: ${{ secrets.STEAM_CONFIG_VDF_BASE64 }}
          steam-app-id: ${{ vars.STEAM_APP_ID }}
          steam-depot-id: ${{ vars[matrix.depot-id-var] }}
          branch: beta
          version: ${{ needs.release-please.outputs.version }}

  # ============================================================================
  # E2E Tests (Run after staging builds)
  # ============================================================================
  e2e-android:
    name: E2E Tests (Android)
    runs-on: ubuntu-latest
    needs: [release-please, build-android-debug]
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          lfs: true

      - name: Setup Java
        uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Android SDK
        uses: android-actions/setup-android@9fc6c4e9069bf8d3d10b2204b1fb8f6ef7065407 # v3.2.2

      - name: Download APKs
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: android-apks-${{ needs.release-please.outputs.version }}
          path: release-apks/

      - name: Enable KVM
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Install Maestro CLI
        run: |
          curl -fsSL "https://get.maestro.mobile.dev" | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Create and start Android emulator
        uses: reactivecircus/android-emulator-runner@69c8581131285561115a2e413eb0037446bdc2d6 # v2.35.0
        with:
          api-level: 33
          arch: x86_64
          profile: pixel_6
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: true
          script: |
            # Install APK
            adb install release-apks/stellar-descent-*-x86_64-debug.apk || adb install release-apks/stellar-descent-*-universal-debug.apk

            # Run Maestro tests
            maestro test .maestro/flows/ \
              --env PLATFORM=android \
              --format junit \
              --output test-results/maestro-android-results.xml || true

      - name: Upload E2E test results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        if: always()
        with:
          name: e2e-android-release-results
          path: test-results/
          retention-days: 7
