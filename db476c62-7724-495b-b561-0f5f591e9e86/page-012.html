<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code transcript - page 12</title>
    <style>
:root { --bg-color: #f5f5f5; --card-bg: #ffffff; --user-bg: #e3f2fd; --user-border: #1976d2; --assistant-bg: #f5f5f5; --assistant-border: #9e9e9e; --thinking-bg: #fff8e1; --thinking-border: #ffc107; --thinking-text: #666; --tool-bg: #f3e5f5; --tool-border: #9c27b0; --tool-result-bg: #e8f5e9; --tool-error-bg: #ffebee; --text-color: #212121; --text-muted: #757575; --code-bg: #263238; --code-text: #aed581; }
* { box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 16px; line-height: 1.6; }
.container { max-width: 800px; margin: 0 auto; }
h1 { font-size: 1.5rem; margin-bottom: 24px; padding-bottom: 8px; border-bottom: 2px solid var(--user-border); }
.header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; border-bottom: 2px solid var(--user-border); padding-bottom: 8px; margin-bottom: 24px; }
.header-row h1 { border-bottom: none; padding-bottom: 0; margin-bottom: 0; flex: 1; min-width: 200px; }
.message { margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.message.user { background: var(--user-bg); border-left: 4px solid var(--user-border); }
.message.assistant { background: var(--card-bg); border-left: 4px solid var(--assistant-border); }
.message.tool-reply { background: #fff8e1; border-left: 4px solid #ff9800; }
.tool-reply .role-label { color: #e65100; }
.tool-reply .tool-result { background: transparent; padding: 0; margin: 0; }
.tool-reply .tool-result .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff8e1); }
.message-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(0,0,0,0.03); font-size: 0.85rem; }
.role-label { font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.user .role-label { color: var(--user-border); }
time { color: var(--text-muted); font-size: 0.8rem; }
.timestamp-link { color: inherit; text-decoration: none; }
.timestamp-link:hover { text-decoration: underline; }
.message:target { animation: highlight 2s ease-out; }
@keyframes highlight { 0% { background-color: rgba(25, 118, 210, 0.2); } 100% { background-color: transparent; } }
.message-content { padding: 16px; }
.message-content p { margin: 0 0 12px 0; }
.message-content p:last-child { margin-bottom: 0; }
.thinking { background: var(--thinking-bg); border: 1px solid var(--thinking-border); border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 0.9rem; color: var(--thinking-text); }
.thinking-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #f57c00; margin-bottom: 8px; }
.thinking p { margin: 8px 0; }
.assistant-text { margin: 8px 0; }
.tool-use { background: var(--tool-bg); border: 1px solid var(--tool-border); border-radius: 8px; padding: 12px; margin: 12px 0; }
.tool-header { font-weight: 600; color: var(--tool-border); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.tool-icon { font-size: 1.1rem; }
.tool-description { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; font-style: italic; }
.tool-result { background: var(--tool-result-bg); border-radius: 8px; padding: 12px; margin: 12px 0; }
.tool-result.tool-error { background: var(--tool-error-bg); }
.file-tool { border-radius: 8px; padding: 12px; margin: 12px 0; }
.write-tool { background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%); border: 1px solid #4caf50; }
.edit-tool { background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%); border: 1px solid #ff9800; }
.file-tool-header { font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
.write-header { color: #2e7d32; }
.edit-header { color: #e65100; }
.file-tool-icon { font-size: 1rem; }
.file-tool-path { font-family: monospace; background: rgba(0,0,0,0.08); padding: 2px 8px; border-radius: 4px; }
.file-tool-fullpath { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; word-break: break-all; }
.file-content { margin: 0; }
.edit-section { display: flex; margin: 4px 0; border-radius: 4px; overflow: hidden; }
.edit-label { padding: 8px 12px; font-weight: bold; font-family: monospace; display: flex; align-items: flex-start; }
.edit-old { background: #fce4ec; }
.edit-old .edit-label { color: #b71c1c; background: #f8bbd9; }
.edit-old .edit-content { color: #880e4f; }
.edit-new { background: #e8f5e9; }
.edit-new .edit-label { color: #1b5e20; background: #a5d6a7; }
.edit-new .edit-content { color: #1b5e20; }
.edit-content { margin: 0; flex: 1; background: transparent; font-size: 0.85rem; }
.edit-replace-all { font-size: 0.75rem; font-weight: normal; color: var(--text-muted); }
.write-tool .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #e6f4ea); }
.edit-tool .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff0e5); }
.todo-list { background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border: 1px solid #81c784; border-radius: 8px; padding: 12px; margin: 12px 0; }
.todo-header { font-weight: 600; color: #2e7d32; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
.todo-items { list-style: none; margin: 0; padding: 0; }
.todo-item { display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 0.9rem; }
.todo-item:last-child { border-bottom: none; }
.todo-icon { flex-shrink: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; }
.todo-completed .todo-icon { color: #2e7d32; background: rgba(46, 125, 50, 0.15); }
.todo-completed .todo-content { color: #558b2f; text-decoration: line-through; }
.todo-in-progress .todo-icon { color: #f57c00; background: rgba(245, 124, 0, 0.15); }
.todo-in-progress .todo-content { color: #e65100; font-weight: 500; }
.todo-pending .todo-icon { color: #757575; background: rgba(0,0,0,0.05); }
.todo-pending .todo-content { color: #616161; }
pre { background: var(--code-bg); color: var(--code-text); padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem; line-height: 1.5; margin: 8px 0; white-space: pre-wrap; word-wrap: break-word; }
pre.json { color: #e0e0e0; }
code { background: rgba(0,0,0,0.08); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
pre code { background: none; padding: 0; }
.user-content { margin: 0; }
.truncatable { position: relative; }
.truncatable.truncated .truncatable-content { max-height: 200px; overflow: hidden; }
.truncatable.truncated::after { content: ''; position: absolute; bottom: 32px; left: 0; right: 0; height: 60px; background: linear-gradient(to bottom, transparent, var(--card-bg)); pointer-events: none; }
.message.user .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--user-bg)); }
.message.tool-reply .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff8e1); }
.tool-use .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--tool-bg)); }
.tool-result .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--tool-result-bg)); }
.expand-btn { display: none; width: 100%; padding: 8px 16px; margin-top: 4px; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); }
.expand-btn:hover { background: rgba(0,0,0,0.1); }
.truncatable.truncated .expand-btn, .truncatable.expanded .expand-btn { display: block; }
.pagination { display: flex; justify-content: center; gap: 8px; margin: 24px 0; flex-wrap: wrap; }
.pagination a, .pagination span { padding: 5px 10px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; }
.pagination a { background: var(--card-bg); color: var(--user-border); border: 1px solid var(--user-border); }
.pagination a:hover { background: var(--user-bg); }
.pagination .current { background: var(--user-border); color: white; }
.pagination .disabled { color: var(--text-muted); border: 1px solid #ddd; }
.pagination .index-link { background: var(--user-border); color: white; }
details.continuation { margin-bottom: 16px; }
details.continuation summary { cursor: pointer; padding: 12px 16px; background: var(--user-bg); border-left: 4px solid var(--user-border); border-radius: 12px; font-weight: 500; color: var(--text-muted); }
details.continuation summary:hover { background: rgba(25, 118, 210, 0.15); }
details.continuation[open] summary { border-radius: 12px 12px 0 0; margin-bottom: 0; }
.index-item { margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: var(--user-bg); border-left: 4px solid var(--user-border); }
.index-item a { display: block; text-decoration: none; color: inherit; }
.index-item a:hover { background: rgba(25, 118, 210, 0.1); }
.index-item-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(0,0,0,0.03); font-size: 0.85rem; }
.index-item-number { font-weight: 600; color: var(--user-border); }
.index-item-content { padding: 16px; }
.index-item-stats { padding: 8px 16px 12px 32px; font-size: 0.85rem; color: var(--text-muted); border-top: 1px solid rgba(0,0,0,0.06); }
.index-item-commit { margin-top: 6px; padding: 4px 8px; background: #fff3e0; border-radius: 4px; font-size: 0.85rem; color: #e65100; }
.index-item-commit code { background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 3px; font-size: 0.8rem; margin-right: 6px; }
.commit-card { margin: 8px 0; padding: 10px 14px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 6px; }
.commit-card a { text-decoration: none; color: #5d4037; display: block; }
.commit-card a:hover { color: #e65100; }
.commit-card-hash { font-family: monospace; color: #e65100; font-weight: 600; margin-right: 8px; }
.index-commit { margin-bottom: 12px; padding: 10px 16px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.index-commit a { display: block; text-decoration: none; color: inherit; }
.index-commit a:hover { background: rgba(255, 152, 0, 0.1); margin: -10px -16px; padding: 10px 16px; border-radius: 8px; }
.index-commit-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-bottom: 4px; }
.index-commit-hash { font-family: monospace; color: #e65100; font-weight: 600; }
.index-commit-msg { color: #5d4037; }
.index-item-long-text { margin-top: 8px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 3px solid var(--assistant-border); }
.index-item-long-text .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--card-bg)); }
.index-item-long-text-content { color: var(--text-color); }
#search-box { display: none; align-items: center; gap: 8px; }
#search-box input { padding: 6px 12px; border: 1px solid var(--assistant-border); border-radius: 6px; font-size: 16px; width: 180px; }
#search-box button, #modal-search-btn, #modal-close-btn { background: var(--user-border); color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#search-box button:hover, #modal-search-btn:hover { background: #1565c0; }
#modal-close-btn { background: var(--text-muted); margin-left: 8px; }
#modal-close-btn:hover { background: #616161; }
#search-modal[open] { border: none; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.2); padding: 0; width: 90vw; max-width: 900px; height: 80vh; max-height: 80vh; display: flex; flex-direction: column; }
#search-modal::backdrop { background: rgba(0,0,0,0.5); }
.search-modal-header { display: flex; align-items: center; gap: 8px; padding: 16px; border-bottom: 1px solid var(--assistant-border); background: var(--bg-color); border-radius: 12px 12px 0 0; }
.search-modal-header input { flex: 1; padding: 8px 12px; border: 1px solid var(--assistant-border); border-radius: 6px; font-size: 16px; }
#search-status { padding: 8px 16px; font-size: 0.85rem; color: var(--text-muted); border-bottom: 1px solid rgba(0,0,0,0.06); }
#search-results { flex: 1; overflow-y: auto; padding: 16px; }
.search-result { margin-bottom: 16px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.search-result a { display: block; text-decoration: none; color: inherit; }
.search-result a:hover { background: rgba(25, 118, 210, 0.05); }
.search-result-page { padding: 6px 12px; background: rgba(0,0,0,0.03); font-size: 0.8rem; color: var(--text-muted); border-bottom: 1px solid rgba(0,0,0,0.06); }
.search-result-content { padding: 12px; }
.search-result mark { background: #fff59d; padding: 1px 2px; border-radius: 2px; }
@media (max-width: 600px) { body { padding: 8px; } .message, .index-item { border-radius: 8px; } .message-content, .index-item-content { padding: 12px; } pre { font-size: 0.8rem; padding: 8px; } #search-box input { width: 120px; } #search-modal[open] { width: 95vw; height: 90vh; } }
</style>
</head>
<body>
    <div class="container">
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">Claude Code transcript</a> - page 12/37</h1>
        

<div class="pagination">
<a href="index.html" class="index-link">Index</a>
<a href="page-011.html">&larr; Prev</a>
<a href="page-001.html">1</a>
<a href="page-002.html">2</a>
<a href="page-003.html">3</a>
<a href="page-004.html">4</a>
<a href="page-005.html">5</a>
<a href="page-006.html">6</a>
<a href="page-007.html">7</a>
<a href="page-008.html">8</a>
<a href="page-009.html">9</a>
<a href="page-010.html">10</a>
<a href="page-011.html">11</a>
<span class="current">12</span>
<a href="page-013.html">13</a>
<a href="page-014.html">14</a>
<a href="page-015.html">15</a>
<a href="page-016.html">16</a>
<a href="page-017.html">17</a>
<a href="page-018.html">18</a>
<a href="page-019.html">19</a>
<a href="page-020.html">20</a>
<a href="page-021.html">21</a>
<a href="page-022.html">22</a>
<a href="page-023.html">23</a>
<a href="page-024.html">24</a>
<a href="page-025.html">25</a>
<a href="page-026.html">26</a>
<a href="page-027.html">27</a>
<a href="page-028.html">28</a>
<a href="page-029.html">29</a>
<a href="page-030.html">30</a>
<a href="page-031.html">31</a>
<a href="page-032.html">32</a>
<a href="page-033.html">33</a>
<a href="page-034.html">34</a>
<a href="page-035.html">35</a>
<a href="page-036.html">36</a>
<a href="page-037.html">37</a>
<a href="page-013.html">Next &rarr;</a>
</div>

        
<div class="message user" id="msg-2026-01-30T06-44-10-058Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T06-44-10-058Z" class="timestamp-link"><time datetime="2026-01-30T06:44:10.058Z" data-timestamp="2026-01-30T06:44:10.058Z">2026-01-30T06:44:10.058Z</time></a></div><div class="message-content">
<div class="user-content"><p><local-command-stdout>[2mCompacted (ctrl+o to see full summary)[22m</local-command-stdout></p></div></div></div>
<div class="message user" id="msg-2026-01-30T06-44-24-700Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T06-44-24-700Z" class="timestamp-link"><time datetime="2026-01-30T06:44:24.700Z" data-timestamp="2026-01-30T06:44:24.700Z">2026-01-30T06:44:24.700Z</time></a></div><div class="message-content">
<div class="user-content"><p>I had to go BACK up in our conversation because it exceeeded maximum length and I couldn't compact. So a BUNCH of work was done but you won't be aware of it. Bcause of that I want you to FIRST make sure our memory-bank is up to date, you haven't updated in AWHIILE, and then I want you to do a thorough codebase review to determine any incomplete subagent implementations or other gaps, which you should ALSO document</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-28-274Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-28-274Z" class="timestamp-link"><time datetime="2026-01-30T06:44:28.274Z" data-timestamp="2026-01-30T06:44:28.274Z">2026-01-30T06:44:28.274Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>The user is asking me to:
1. Update the memory bank (which I haven't done in a while)
2. Do a thorough codebase review to find incomplete subagent implementations or gaps
3. Document those findings</p>
<p>Let me first check if there's an existing memory bank structure for this project, then do a comprehensive codebase review.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-28-837Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-28-837Z" class="timestamp-link"><time datetime="2026-01-30T06:44:28.837Z" data-timestamp="2026-01-30T06:44:28.837Z">2026-01-30T06:44:28.837Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>I'll start by checking the memory bank status and then do a comprehensive codebase review to find any gaps.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-29-455Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-29-455Z" class="timestamp-link"><time datetime="2026-01-30T06:44:29.455Z" data-timestamp="2026-01-30T06:44:29.455Z">2026-01-30T06:44:29.455Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_013cUart2kajJodvo7XG9aX2"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;**/.clinerules/**/*&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-29-680Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-29-680Z" class="timestamp-link"><time datetime="2026-01-30T06:44:29.680Z" data-timestamp="2026-01-30T06:44:29.680Z">2026-01-30T06:44:29.680Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_0145vuhwDcPoM3DQ4fghv4cS"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;**/memory-bank/**/*&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-30-101Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-30-101Z" class="timestamp-link"><time datetime="2026-01-30T06:44:30.101Z" data-timestamp="2026-01-30T06:44:30.101Z">2026-01-30T06:44:30.101Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_018wHKAhgARupYsWAKUAUxtb"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;**/.memory-bank/**/*&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-30-669Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-30-669Z" class="timestamp-link"><time datetime="2026-01-30T06:44:30.669Z" data-timestamp="2026-01-30T06:44:30.669Z">2026-01-30T06:44:30.669Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>No files found</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-30-882Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-30-882Z" class="timestamp-link"><time datetime="2026-01-30T06:44:30.882Z" data-timestamp="2026-01-30T06:44:30.882Z">2026-01-30T06:44:30.882Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-31-305Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-31-305Z" class="timestamp-link"><time datetime="2026-01-30T06:44:31.305Z" data-timestamp="2026-01-30T06:44:31.305Z">2026-01-30T06:44:31.305Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>No files found</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-34-573Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-34-573Z" class="timestamp-link"><time datetime="2026-01-30T06:44:34.573Z" data-timestamp="2026-01-30T06:44:34.573Z">2026-01-30T06:44:34.573Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Good, there's a memory bank at <code>docs/memory-bank/</code>. Let me read the current state of all memory bank files to understand what needs updating, and also do a comprehensive codebase review to find gaps.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-35-240Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-35-240Z" class="timestamp-link"><time datetime="2026-01-30T06:44:35.240Z" data-timestamp="2026-01-30T06:44:35.240Z">2026-01-30T06:44:35.240Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Found the memory bank. Let me read all memory bank files and do a comprehensive codebase scan in parallel.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-35-825Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-35-825Z" class="timestamp-link"><time datetime="2026-01-30T06:44:35.825Z" data-timestamp="2026-01-30T06:44:35.825Z">2026-01-30T06:44:35.825Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01242QtvN7j84DvucpPbTkWx"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-35-827Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-35-827Z" class="timestamp-link"><time datetime="2026-01-30T06:44:35.827Z" data-timestamp="2026-01-30T06:44:35.827Z">2026-01-30T06:44:35.827Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Active Context
     2‚Üí
     3‚Üí## Current Development Phase
     4‚Üí**Phase 3: Tutorial &amp; Story** (In Progress)
     5‚Üí
     6‚Üí## Recent Work (Session 4 - Jan 30, 2026)
     7‚Üí- **Testing Infrastructure**: Added Vitest (unit) and Playwright (E2E) testing.
     8‚Üí- **Shooting Range Mini-Game**: Implemented weapons calibration sequence in the tutorial.
     9‚Üí- **Tutorial Polish**: Expanded tutorial flow with equipment interaction, hangar depressurization, and launch sequence.
    10‚Üí- **Loading Screen**: Fixed fake loading to use real asset loading progress.
    11‚Üí
    12‚Üí## Immediate Priorities
    13‚Üí1. **First-person view**: Add gloved hands holding weapon models.
    14‚Üí2. **HALO drop polish**: Visualize the planet during descent; lock camera looking down.
    15‚Üí3. **Weapon System**: Implement functional weapon switching (Rifle, Pistol, Grenade).
    16‚Üí4. **View Bobbing**: Add head bob while walking for immersion.
    17‚Üí5. **Sound Effects**: Add audio for suit equip, depressurization, doors, and launch.
    18‚Üí6. **E2E Tests**: Expand coverage for full playthroughs.
    19‚Üí
    20‚Üí## Active Decisions
    21‚Üí- **Modular Levels**: Levels are self-contained packages (e.g., `src/game/levels/anchor-station/`) to avoid monolithic files.
    22‚Üí- **Ref-Based Updates**: The render loop uses `useRef` values to avoid stale closures in React state.
    23‚Üí- **Touch Controls**: Redesigned to &quot;DOOM-style&quot; - left joystick move, screen drag look, right side buttons.
    24‚Üí- **No Anime.js for Babylon**: Strictly enforced. Use manual `requestAnimationFrame` loops.
    25‚Üí
    26‚Üí## Known Issues
    27‚Üí- **Camera Sync**: Needs verification when syncing player turning with camera.
    28‚Üí- **Touch Testing**: Needs validation on real physical devices.
    29‚Üí- **Drop Sequence**: Transition needs visual polish.
    30‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-36-112Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-36-112Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.112Z" data-timestamp="2026-01-30T06:44:36.112Z">2026-01-30T06:44:36.112Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01VwuGRWuBytikzRFDjvoK2e"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-36-115Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-36-115Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.115Z" data-timestamp="2026-01-30T06:44:36.115Z">2026-01-30T06:44:36.115Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Progress
     2‚Üí
     3‚Üí## Project Timeline
     4‚Üí
     5‚Üí| Phase | Status | Description |
     6‚Üí|-------|--------|-------------|
     7‚Üí| **Phase 1: Foundation** | ‚úÖ Complete | Project setup, core systems (ECS, World Gen). |
     8‚Üí| **Phase 2: Core Gameplay** | ‚úÖ Complete | Combat loop, AI behaviors, procedural world. |
     9‚Üí| **Phase 3: Tutorial &amp; Story** | üîÑ In Progress | Anchor Station level, dialogue system, shooting range. |
    10‚Üí| **Phase 4: Content** | ‚è≥ Planned | Full mission set, enemies, bosses. |
    11‚Üí| **Phase 5: Polish** | ‚è≥ Planned | Audio, effects, optimization. |
    12‚Üí| **Phase 6: Release** | ‚è≥ Planned | Testing, deployment. |
    13‚Üí
    14‚Üí## Current Status (Phase 3)
    15‚Üí- **Completed**:
    16‚Üí    - Anchor Station environment.
    17‚Üí    - Tutorial flow (Movement -&gt; Equipment -&gt; Launch).
    18‚Üí    - Dialogue system (CommsDisplay).
    19‚Üí    - Shooting Range mini-game.
    20‚Üí    - Touch controls redesign (DOOM-style).
    21‚Üí    - Testing infrastructure (Vitest/Playwright).
    22‚Üí- **In Progress**:
    23‚Üí    - First-person hands/weapon visualization.
    24‚Üí    - HALO drop visual polish.
    25‚Üí    - Weapon switching system.
    26‚Üí
    27‚Üí## Known Issues
    28‚Üí- Touch controls need physical device validation.
    29‚Üí- Camera sync with player turning needs verification.
    30‚Üí- Drop sequence transition is functional but needs visual polish.
    31‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-36-539Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-36-539Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.539Z" data-timestamp="2026-01-30T06:44:36.539Z">2026-01-30T06:44:36.539Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01UafhQMDVAVb6RT9CyqBFzm"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-36-541Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-36-541Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.541Z" data-timestamp="2026-01-30T06:44:36.541Z">2026-01-30T06:44:36.541Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Product Context
     2‚Üí
     3‚Üí## The Narrative
     4‚ÜíThe year is 3147 CE. Humanity has spread to Proxima Centauri b (&quot;Kepler&#x27;s Promise&quot;). The Terran Expansion Authority (TEA) oversees colonization.
     5‚ÜíThe player controls **Sergeant James Cole (Callsign: SPECTER)**, a &quot;Hell Jumper&quot; marine.
     6‚Üí**The Mission**: Find his brother, **Corporal Marcus Cole (Callsign: HAMMER)**, who went missing with Recon Team Vanguard at FOB Delta.
     7‚Üí
     8‚Üí## The Enemy
     9‚Üí**Strain-X / &quot;Chitin&quot;**: An insectoid hive species living deep underground. They were awakened by mining operations.
    10‚Üí- **Characteristics**: Insectoid, hive mind, bioluminescent, subterranean.
    11‚Üí- **Variants**: Drones, Grunts, Brutes, Spitters, and the Queen.
    12‚Üí
    13‚Üí## User Experience Goals
    14‚Üí- **Grounded &amp; Human**: A military story about brotherhood, not a generic sci-fi shooter.
    15‚Üí- **Visceral Combat**: Heavy weapons, tactical movement, intense firefights.
    16‚Üí- **Exploration**: Procedurally generated world that feels alive and dangerous.
    17‚Üí- **Persistence**: Changes to the world (destroyed buildings, dead enemies) are saved.
    18‚Üí
    19‚Üí## Design Guidelines
    20‚Üí- **Visuals**: Modern military equipment, worn and battle-tested. High contrast lighting.
    21‚Üí- **UI**: Utilitarian, functional, &quot;heads-up display&quot; style.
    22‚Üí- **Controls**: Optimized for touch (virtual joysticks, screen drag for look).
    23‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-36-963Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-36-963Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.963Z" data-timestamp="2026-01-30T06:44:36.963Z">2026-01-30T06:44:36.963Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01MD3stffbBEz8DUxFDiSCvm"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-36-965Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-36-965Z" class="timestamp-link"><time datetime="2026-01-30T06:44:36.965Z" data-timestamp="2026-01-30T06:44:36.965Z">2026-01-30T06:44:36.965Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# System Patterns
     2‚Üí
     3‚Üí## System Overview
     4‚ÜíThe application follows a strict hierarchical flow:
     5‚Üí`App.tsx` -&gt; `GameManager.ts` -&gt; Systems (Player, ChunkManager, ECS, AI).
     6‚Üí
     7‚Üí## Core Architecture
     8‚Üí
     9‚Üí### Entry Point
    10‚Üí- **App.tsx**: Initializes the BabylonJS Engine (WebGL2) and Havok Physics.
    11‚Üí- **GameCanvas.tsx**: React component hosting the canvas and HUD.
    12‚Üí
    13‚Üí### Game Manager
    14‚Üí- **GameManager.ts**: The central orchestrator. Manages game state (Menu, Playing, Paused), scene setup, and system coordination.
    15‚Üí
    16‚Üí### Entity Component System (ECS)
    17‚Üí- **Library**: Miniplex.
    18‚Üí- **Usage**: All game objects (Player, Enemies, Projectiles) are entities composed of data components (Transform, Health, Velocity, AI).
    19‚Üí- **Queries**: Systems query the ECS world for specific component combinations (e.g., `world.with(&#x27;ai&#x27;, &#x27;transform&#x27;)`).
    20‚Üí
    21‚Üí### AI System
    22‚Üí- **Library**: Yuka.
    23‚Üí- **Pattern**: Finite State Machine (FSM).
    24‚Üí- **States**: Idle, Patrol, Chase, Attack, Flee, Support.
    25‚Üí- **Behaviors**: Steering behaviors (Wander, Seek, Pursuit, Flee).
    26‚Üí
    27‚Üí### World Generation
    28‚Üí- **Chunk System**: World is divided into 100x100 unit chunks.
    29‚Üí- **Procedural**: Content generated deterministically based on coordinates and a seed.
    30‚Üí- **Persistence**: `SQL.js` stores the state of each chunk (entities, visited status) in a local SQLite database.
    31‚Üí
    32‚Üí### Modular Levels
    33‚Üí- **Structure**: Each level (e.g., `anchor-station`) is a self-contained module.
    34‚Üí- **Files**: `index.ts` (entry), `environment.ts` (meshes), `TutorialManager.ts` (logic), `materials.ts` (assets).
    35‚Üí
    36‚Üí## Data Flow
    37‚Üí1. **Input**: Touch/Keyboard -&gt; `GameManager` -&gt; `Player`.
    38‚Üí2. **Simulation**: `GameManager` loop -&gt; `AISystem` / `CombatSystem` -&gt; `ECS World` updates.
    39‚Üí3. **Rendering**: BabylonJS Engine renders the scene based on `ECS` transforms.
    40‚Üí4. **Persistence**: `ChunkManager` saves/loads from `WorldDatabase` on chunk boundaries.
    41‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-37-412Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-37-412Z" class="timestamp-link"><time datetime="2026-01-30T06:44:37.412Z" data-timestamp="2026-01-30T06:44:37.412Z">2026-01-30T06:44:37.412Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01D5RmBPsBfdGeDstdMLiKKH"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-37-415Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-37-415Z" class="timestamp-link"><time datetime="2026-01-30T06:44:37.415Z" data-timestamp="2026-01-30T06:44:37.415Z">2026-01-30T06:44:37.415Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Technical Context
     2‚Üí
     3‚Üí## Technologies
     4‚Üí- **Language**: TypeScript.
     5‚Üí- **Runtime**: Browser (Vite).
     6‚Üí- **Rendering**: BabylonJS 8.x (WebGL2).
     7‚Üí- **Physics**: Havok Physics.
     8‚Üí- **ECS**: Miniplex.
     9‚Üí- **AI**: Yuka.
    10‚Üí- **Persistence**: SQL.js (SQLite).
    11‚Üí- **Animation**: Anime.js (DOM only), Manual RAF (Babylon objects).
    12‚Üí- **UI**: React 19, CSS Modules.
    13‚Üí
    14‚Üí## Development Setup
    15‚Üí- **Build Tool**: Vite.
    16‚Üí- **Package Manager**: pnpm.
    17‚Üí- **Linting**: Biome.
    18‚Üí- **Testing**:
    19‚Üí    - **Unit**: Vitest + Happy-DOM.
    20‚Üí    - **E2E**: Playwright.
    21‚Üí
    22‚Üí## Constraints
    23‚Üí- **Mobile Performance**: Optimized for mobile devices. Limit draw calls, shadow map resolution, and complex physics.
    24‚Üí- **No WebGPU**: Explicit decision to stick to WebGL2 for stability and &quot;fail fast&quot; debugging.
    25‚Üí- **Asset Management**: No external models yet (using primitives). Textures from BabylonJS assets library.
    26‚Üí
    27‚Üí## Dependencies
    28‚Üí- `@babylonjs/core`, `@babylonjs/gui`, `@babylonjs/havok`: Core engine.
    29‚Üí- `miniplex`: ECS.
    30‚Üí- `yuka`: AI.
    31‚Üí- `sql.js`: Database.
    32‚Üí- `react`, `react-dom`: UI.
    33‚Üí- `vitest`, `playwright`: Testing.
    34‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-37-860Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-37-860Z" class="timestamp-link"><time datetime="2026-01-30T06:44:37.860Z" data-timestamp="2026-01-30T06:44:37.860Z">2026-01-30T06:44:37.860Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_015EtSkphgKWEgCLCqnDJchc"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-37-862Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-37-862Z" class="timestamp-link"><time datetime="2026-01-30T06:44:37.862Z" data-timestamp="2026-01-30T06:44:37.862Z">2026-01-30T06:44:37.862Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Project Brief
     2‚Üí
     3‚Üí**STELLAR DESCENT: PROXIMA BREACH** is a mobile-first, 3D arcade shooter built with BabylonJS. The game features procedural world generation, persistent state via SQLite, and a mission-based story campaign.
     4‚Üí
     5‚Üí## Core Philosophy
     6‚Üí1. **Mobile-first**: All UI and controls must work on phones first, then scale up.
     7‚Üí2. **Military aesthetic**: Olive, khaki, brass colors. NO cyberpunk (no neon, no purple/blue gradients).
     8‚Üí3. **Harsh lighting**: Bright alien sun, high contrast, HDR visuals.
     9‚Üí4. **Persistent world**: Areas remember their state when revisited.
    10‚Üí5. **Story-driven**: Clear narrative with characters players care about.
    11‚Üí
    12‚Üí## Critical Development Rules
    13‚Üí- **NO FALLBACKS**: Code should fail fast and explicitly. Do not write try/catch that silently falls back.
    14‚Üí- **Fail Fast**: If WebGPU fails, show the error. Do not fallback to WebGL1.
    15‚Üí- **No anime.js for Babylon Objects**: Use `requestAnimationFrame` loops for mesh/material animations.
    16‚Üí
    17‚Üí## Key Technical Decisions
    18‚Üí- **Engine**: BabylonJS 8.x (WebGL2 only).
    19‚Üí- **Physics**: Havok.
    20‚Üí- **ECS**: Miniplex.
    21‚Üí- **AI**: Yuka.
    22‚Üí- **Persistence**: SQL.js (SQLite in browser).
    23‚Üí- **Styling**: CSS Modules with Design Tokens.
    24‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-38-179Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-38-179Z" class="timestamp-link"><time datetime="2026-01-30T06:44:38.179Z" data-timestamp="2026-01-30T06:44:38.179Z">2026-01-30T06:44:38.179Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01FVPx354CVu3H9wJyPXs8Qc"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/levels/**/*.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-38-435Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-38-435Z" class="timestamp-link"><time datetime="2026-01-30T06:44:38.435Z" data-timestamp="2026-01-30T06:44:38.435Z">2026-01-30T06:44:38.435Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01WJBqbJYwmS93woa3mqNtVy"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/components/**/*.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-38-693Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-38-693Z" class="timestamp-link"><time datetime="2026-01-30T06:44:38.693Z" data-timestamp="2026-01-30T06:44:38.693Z">2026-01-30T06:44:38.693Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01NFCcCZe8Qo3NdF1ZaVsLQz"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/context/**/*.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-39-385Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-39-385Z" class="timestamp-link"><time datetime="2026-01-30T06:44:39.385Z" data-timestamp="2026-01-30T06:44:39.385Z">2026-01-30T06:44:39.385Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/shared/types.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/LevelManager.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/landfall/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/fob-delta/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/brothers-in-arms/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/extraction/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/factories.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/StationLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/SurfaceLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/useLevelManager.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/extraction/ExtractionLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/brothers-in-arms/BrothersInArmsLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/constants.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/landfall/LandfallLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/TutorialManager.test.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/tutorialSteps.test.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/TutorialManager.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/platformingRoom.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/BaseLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/tutorialSteps.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/comms.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/index.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/scenicRooms.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/types.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/environment.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/hazards.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/materials.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/curvedCorridor.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/queen.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/environment.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/AnchorStationLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/enemies.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/TheBreachLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/AnchorStationLevelV2.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/fob-delta/FOBDeltaLevel.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-39-632Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-39-632Z" class="timestamp-link"><time datetime="2026-01-30T06:44:39.632Z" data-timestamp="2026-01-30T06:44:39.632Z">2026-01-30T06:44:39.632Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/LoadingModal.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/CommsDisplay.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/ActionButtons.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/TouchControls.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/LandscapeEnforcer.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/HUD.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/LevelSelect.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/AchievementPopup.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/Crosshair.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/Compass.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/AchievementsPanel.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/DeathScreen.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/MainMenu.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/SettingsMenu.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/ControlHints.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/MobileTutorial.tsx</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-39-887Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-39-887Z" class="timestamp-link"><time datetime="2026-01-30T06:44:39.887Z" data-timestamp="2026-01-30T06:44:39.887Z">2026-01-30T06:44:39.887Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/WeaponContext.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/GameContext.test.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/KeybindingsContext.tsx
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/GameContext.tsx</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-46-443Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-46-443Z" class="timestamp-link"><time datetime="2026-01-30T06:44:46.443Z" data-timestamp="2026-01-30T06:44:46.443Z">2026-01-30T06:44:46.443Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a good overview. The memory bank is significantly outdated - it's still describing Phase 3 work (tutorial/shooting range) but based on the conversation summary, we've moved well past that into:
- Multi-level system with 6+ levels (anchor-station, landfall, fob-delta, the-breach, brothers-in-arms, extraction)
- Full CI/CD with Netlify deployment
- Node 22 LTS
- Health clamping, death detection
- Landscape enforcer for mobile
- Settings menu with keybindings
- FOV system for HALO drop
- Many new UI components</p>
<p>Let me do a thorough codebase review to find gaps. I should read key files to understand what's been implemented.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-47-303Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-47-303Z" class="timestamp-link"><time datetime="2026-01-30T06:44:47.303Z" data-timestamp="2026-01-30T06:44:47.303Z">2026-01-30T06:44:47.303Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Good, I can see the memory bank is significantly outdated. Let me do a thorough codebase review of the key files to understand current state and gaps.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-47-908Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-47-908Z" class="timestamp-link"><time datetime="2026-01-30T06:44:47.908Z" data-timestamp="2026-01-30T06:44:47.908Z">2026-01-30T06:44:47.908Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01361qWiGngKBeZdDCFxGJbb"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/landfall/LandfallLevel.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-48-076Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-48-076Z" class="timestamp-link"><time datetime="2026-01-30T06:44:48.076Z" data-timestamp="2026-01-30T06:44:48.076Z">2026-01-30T06:44:48.076Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * LandfallLevel - INTERACTIVE HALO Jump with Precision Landing
     3‚Üí *
     4‚Üí * TWO DISTINCT PHASES:
     5‚Üí *
     6‚Üí * PHASE 1: FREEFALL (first 2/3 of descent)
     7‚Üí * - Camera looking DOWN at planet
     8‚Üí * - Arms extended toward planet (skydiver pose)
     9‚Üí * - WASD to dodge asteroids in debris belt
    10‚Üí * - When ready, player hits &quot;IGNITE JETS&quot; to transition
    11‚Üí *
    12‚Üí * PHASE 2: POWERED DESCENT (final 1/3)
    13‚Üí * - Camera looking OUT (forward)
    14‚Üí * - Hands gripping thruster handles (visible)
    15‚Üí * - Balance fuel, velocity, and position
    16‚Üí * - Target the LZ pad (visible cement pad on surface)
    17‚Üí *
    18‚Üí * LANDING OUTCOMES:
    19‚Üí * - Perfect (on pad): Smooth transition to FOB Delta
    20‚Üí * - Near miss: Fight through hostiles to reach LZ
    21‚Üí * - Bad landing: Injury, reduced health
    22‚Üí * - Catastrophic: Death / slingshot into space
    23‚Üí */
    24‚Üí
    25‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    26‚Üíimport { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    27‚Üíimport { Color3, Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    28‚Üíimport { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    29‚Üíimport type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    30‚Üíimport { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    31‚Üíimport { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    32‚Üíimport { getAchievementManager } from &#x27;../../achievements&#x27;;
    33‚Üíimport { AssetManager } from &#x27;../../core/AssetManager&#x27;;
    34‚Üíimport { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    35‚Üíimport { BaseLevel } from &#x27;../BaseLevel&#x27;;
    36‚Üíimport type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    37‚Üí
    38‚Üíimport &#x27;@babylonjs/core/Animations/animatable&#x27;;
    39‚Üíimport { Animation } from &#x27;@babylonjs/core/Animations/animation&#x27;;
    40‚Üíimport { CubicEase, EasingFunction } from &#x27;@babylonjs/core/Animations/easing&#x27;;
    41‚Üí
    42‚Üítype DropPhase =
    43‚Üí  | &#x27;freefall_start&#x27; // Initial orientation
    44‚Üí  | &#x27;freefall_belt&#x27; // Asteroid dodging
    45‚Üí  | &#x27;freefall_clear&#x27; // Past asteroids, waiting for jets
    46‚Üí  | &#x27;powered_descent&#x27; // Jets active, targeting LZ
    47‚Üí  | &#x27;landing&#x27; // Final approach
    48‚Üí  | &#x27;surface&#x27;; // On ground
    49‚Üí
    50‚Üítype LandingOutcome = &#x27;perfect&#x27; | &#x27;near_miss&#x27; | &#x27;rough&#x27; | &#x27;crash&#x27; | &#x27;slingshot&#x27;;
    51‚Üí
    52‚Üíinterface Asteroid {
    53‚Üí  mesh: Mesh;
    54‚Üí  velocity: Vector3;
    55‚Üí  rotationSpeed: Vector3;
    56‚Üí  passed: boolean;
    57‚Üí}
    58‚Üí
    59‚Üíinterface DistantThreat {
    60‚Üí  node: TransformNode;
    61‚Üí  position: Vector3;
    62‚Üí  velocity: Vector3;
    63‚Üí  rotationSpeed: number;
    64‚Üí  type: &#x27;wraith&#x27; | &#x27;phantom&#x27;;
    65‚Üí  spawnAltitude: number; // Altitude at which it appears
    66‚Üí}
    67‚Üí
    68‚Üíexport class LandfallLevel extends BaseLevel {
    69‚Üí  // Phase management
    70‚Üí  private phase: DropPhase = &#x27;freefall_start&#x27;;
    71‚Üí  private phaseTime = 0;
    72‚Üí
    73‚Üí  // Descent metrics
    74‚Üí  private altitude = 1000;
    75‚Üí  private velocity = 10; // Current downward velocity
    76‚Üí  private lateralVelocityX = 0;
    77‚Üí  private lateralVelocityZ = 0;
    78‚Üí
    79‚Üí  // Camera FOV settings (in radians)
    80‚Üí  // Wide cinematic FOV during freefall for dramatic ODST-style drop
    81‚Üí  private readonly FREEFALL_FOV = 1.75; // ~100 degrees - epic wide view
    82‚Üí  private readonly POWERED_DESCENT_FOV = 1.4; // ~80 degrees - still dramatic
    83‚Üí  private readonly SURFACE_FOV = 1.2; // ~69 degrees - standard FPS
    84‚Üí  private targetFOV = 1.75;
    85‚Üí  private currentFOV = 1.75;
    86‚Üí
    87‚Üí  // Terrain collision constants
    88‚Üí  private readonly MIN_PLAYER_HEIGHT = 1.7; // Player eye height above terrain
    89‚Üí  private readonly TERRAIN_BOUNDS = 280; // Half of terrain size (600/2 - margin)
    90‚Üí
    91‚Üí  // Fuel for powered descent
    92‚Üí  private fuel = 100;
    93‚Üí  private readonly maxFuel = 100;
    94‚Üí  private readonly fuelBurnRate = 8; // Per second when boosting
    95‚Üí  private readonly fuelRegenRate = 2; // Passive regen
    96‚Üí
    97‚Üí  // Position relative to LZ (0,0 = perfect)
    98‚Üí  private positionX = 0;
    99‚Üí  private positionZ = 0;
   100‚Üí  private readonly maxDrift = 100; // Too far = slingshot
   101‚Üí
   102‚Üí  // LZ target
   103‚Üí  private lzPad: Mesh | null = null;
   104‚Üí  private lzBeacon: Mesh | null = null;
   105‚Üí  private readonly lzRadius = 8; // Perfect landing zone
   106‚Üí  private readonly nearMissRadius = 25; // Near miss zone
   107‚Üí
   108‚Üí  // Camera effects (using BaseLevel&#x27;s shake system)
   109‚Üí  // Note: cameraShake/baseShake now managed by BaseLevel.shakeConfig
   110‚Üí
   111‚Üí  // Environment - Freefall
   112‚Üí  private planet: Mesh | null = null;
   113‚Üí  private planetAtmosphere: Mesh | null = null;
   114‚Üí  private starfield: Mesh | null = null;
   115‚Üí  private leftArm: Mesh | null = null;
   116‚Üí  private rightArm: Mesh | null = null;
   117‚Üí  private leftGlove: Mesh | null = null;
   118‚Üí  private rightGlove: Mesh | null = null;
   119‚Üí  private visorFrame: Mesh | null = null;
   120‚Üí
   121‚Üí  // Anchor Station (visible above player during drop)
   122‚Üí  private anchorStation: TransformNode | null = null;
   123‚Üí  private stationRing: Mesh | null = null;
   124‚Üí  private stationHub: Mesh | null = null;
   125‚Üí  private stationSolarPanels: Mesh[] = [];
   126‚Üí  private stationLights: Mesh[] = [];
   127‚Üí  private stationDropBay: Mesh | null = null;
   128‚Üí  private stationInitialDistance = 50; // Initial distance above player
   129‚Üí  private stationRecedeSpeed = 8; // How fast it appears to recede
   130‚Üí
   131‚Üí  // Environment - Powered descent
   132‚Üí  private leftHandle: Mesh | null = null;
   133‚Üí  private rightHandle: Mesh | null = null;
   134‚Üí  private thrusterGlow: Mesh | null = null;
   135‚Üí
   136‚Üí  // Asteroids
   137‚Üí  private asteroids: Asteroid[] = [];
   138‚Üí  private asteroidSpawnTimer = 0;
   139‚Üí  private asteroidSpawnRate = 0.35;
   140‚Üí  private asteroidsSpawned = 0;
   141‚Üí
   142‚Üí  // Stats
   143‚Üí  private suitIntegrity = 100;
   144‚Üí  private asteroidsHit = 0;
   145‚Üí  private asteroidsDodged = 0;
   146‚Üí
   147‚Üí  // Entry effects
   148‚Üí  private plasmaGlow: Mesh | null = null;
   149‚Üí
   150‚Üí  // Surface
   151‚Üí  private terrain: Mesh | null = null;
   152‚Üí  private canyonWalls: Mesh[] = [];
   153‚Üí  private skyDome: Mesh | null = null;
   154‚Üí
   155‚Üí  // Landing outcome
   156‚Üí  private landingOutcome: LandingOutcome = &#x27;perfect&#x27;;
   157‚Üí
   158‚Üí  // Distant alien vehicle threats during descent
   159‚Üí  private distantThreats: DistantThreat[] = [];
   160‚Üí  private threatsSpawned = false;
   161‚Üí
   162‚Üí  // Action button callback reference
   163‚Üí  private actionCallback: ((actionId: string) =&gt; void) | null = null;
   164‚Üí
   165‚Üí  constructor(
   166‚Üí    engine: Engine,
   167‚Üí    canvas: HTMLCanvasElement,
   168‚Üí    config: LevelConfig,
   169‚Üí    callbacks: LevelCallbacks
   170‚Üí  ) {
   171‚Üí    super(engine, canvas, config, callbacks);
   172‚Üí  }
   173‚Üí
   174‚Üí  protected getBackgroundColor(): Color4 {
   175‚Üí    switch (this.phase) {
   176‚Üí      case &#x27;freefall_start&#x27;:
   177‚Üí      case &#x27;freefall_belt&#x27;:
   178‚Üí      case &#x27;freefall_clear&#x27;:
   179‚Üí        return new Color4(0.0, 0.0, 0.03, 1);
   180‚Üí      case &#x27;powered_descent&#x27;:
   181‚Üí        return new Color4(0.5, 0.3, 0.2, 1);
   182‚Üí      case &#x27;landing&#x27;:
   183‚Üí      case &#x27;surface&#x27;:
   184‚Üí        return new Color4(0.75, 0.5, 0.35, 1);
   185‚Üí      default:
   186‚Üí        return new Color4(0.0, 0.0, 0.03, 1);
   187‚Üí    }
   188‚Üí  }
   189‚Üí
   190‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   191‚Üí    // Start looking DOWN with wide cinematic FOV for epic HALO drop feel
   192‚Üí    this.camera.position.set(0, 0, 0);
   193‚Üí    this.camera.rotation.x = Math.PI / 2;
   194‚Üí    this.rotationX = Math.PI / 2;
   195‚Üí    this.rotationY = 0;
   196‚Üí
   197‚Üí    // Set initial wide FOV for dramatic freefall view
   198‚Üí    this.camera.fov = this.FREEFALL_FOV;
   199‚Üí    this.currentFOV = this.FREEFALL_FOV;
   200‚Üí    this.targetFOV = this.FREEFALL_FOV;
   201‚Üí
   202‚Üí    // Initialize AssetManager
   203‚Üí    AssetManager.init(this.scene);
   204‚Üí
   205‚Üí    this.createStarfield();
   206‚Üí    this.createPlanet();
   207‚Üí    this.createAnchorStation(); // Station visible above during drop
   208‚Üí    this.createFreefallView();
   209‚Üí    this.createPoweredDescentView();
   210‚Üí    this.createEntryEffects();
   211‚Üí    this.createLandingZone();
   212‚Üí    this.createSurface();
   213‚Üí
   214‚Üí    // Preload alien vehicle models for distant threats
   215‚Üí    await this.preloadDistantThreats();
   216‚Üí
   217‚Üí    // Hide powered descent elements initially
   218‚Üí    this.setPoweredDescentVisible(false);
   219‚Üí
   220‚Üí    this.startJump();
   221‚Üí  }
   222‚Üí
   223‚Üí  private createStarfield(): void {
   224‚Üí    this.starfield = MeshBuilder.CreateSphere(
   225‚Üí      &#x27;stars&#x27;,
   226‚Üí      { diameter: 8000, segments: 16, sideOrientation: 1 },
   227‚Üí      this.scene
   228‚Üí    );
   229‚Üí    const mat = new StandardMaterial(&#x27;starsMat&#x27;, this.scene);
   230‚Üí    mat.emissiveColor = new Color3(0.03, 0.03, 0.06);
   231‚Üí    mat.disableLighting = true;
   232‚Üí    this.starfield.material = mat;
   233‚Üí    this.starfield.infiniteDistance = true;
   234‚Üí  }
   235‚Üí
   236‚Üí  private createPlanet(): void {
   237‚Üí    this.planet = MeshBuilder.CreateSphere(&#x27;planet&#x27;, { diameter: 80, segments: 64 }, this.scene);
   238‚Üí    const planetMat = new StandardMaterial(&#x27;planetMat&#x27;, this.scene);
   239‚Üí    planetMat.diffuseColor = Color3.FromHexString(&#x27;#9B7B5A&#x27;);
   240‚Üí    planetMat.specularColor = new Color3(0.08, 0.06, 0.04);
   241‚Üí    this.planet.material = planetMat;
   242‚Üí    this.planet.position.set(0, -150, 0);
   243‚Üí
   244‚Üí    this.planetAtmosphere = MeshBuilder.CreateSphere(
   245‚Üí      &#x27;atmos&#x27;,
   246‚Üí      { diameter: 90, segments: 32 },
   247‚Üí      this.scene
   248‚Üí    );
   249‚Üí    const atmosMat = new StandardMaterial(&#x27;atmosMat&#x27;, this.scene);
   250‚Üí    atmosMat.emissiveColor = new Color3(0.9, 0.6, 0.4);
   251‚Üí    atmosMat.alpha = 0.15;
   252‚Üí    atmosMat.backFaceCulling = false;
   253‚Üí    this.planetAtmosphere.material = atmosMat;
   254‚Üí    this.planetAtmosphere.position.copyFrom(this.planet.position);
   255‚Üí  }
   256‚Üí
   257‚Üí  /**
   258‚Üí   * Creates the Anchor Station Prometheus visible above the player during the HALO drop.
   259‚Üí   * The station is a procedural model featuring:
   260‚Üí   * - Large rotating ring structure (main habitat)
   261‚Üí   * - Central hub cylinder
   262‚Üí   * - Solar panels extending outward
   263‚Üí   * - Drop pod bay (where the player just left)
   264‚Üí   * - Running lights for visual detail
   265‚Üí   *
   266‚Üí   * The station slowly rotates and recedes as the player falls, creating
   267‚Üí   * a powerful &quot;leaving home&quot; moment that adds scale and immersion to the drop.
   268‚Üí   */
   269‚Üí  private createAnchorStation(): void {
   270‚Üí    // Parent node for the entire station
   271‚Üí    this.anchorStation = new TransformNode(&#x27;anchorStation&#x27;, this.scene);
   272‚Üí    this.anchorStation.position.set(0, this.stationInitialDistance, 0);
   273‚Üí
   274‚Üí    // Station materials
   275‚Üí    const hullMat = new StandardMaterial(&#x27;stationHullMat&#x27;, this.scene);
   276‚Üí    hullMat.diffuseColor = new Color3(0.35, 0.38, 0.42);
   277‚Üí    hullMat.specularColor = new Color3(0.2, 0.2, 0.25);
   278‚Üí
   279‚Üí    const panelMat = new StandardMaterial(&#x27;stationPanelMat&#x27;, this.scene);
   280‚Üí    panelMat.diffuseColor = new Color3(0.1, 0.12, 0.2);
   281‚Üí    panelMat.specularColor = new Color3(0.4, 0.45, 0.6);
   282‚Üí
   283‚Üí    const lightMat = new StandardMaterial(&#x27;stationLightMat&#x27;, this.scene);
   284‚Üí    lightMat.emissiveColor = new Color3(0.2, 0.8, 1.0);
   285‚Üí    lightMat.disableLighting = true;
   286‚Üí
   287‚Üí    const warningLightMat = new StandardMaterial(&#x27;stationWarningMat&#x27;, this.scene);
   288‚Üí    warningLightMat.emissiveColor = new Color3(1.0, 0.3, 0.1);
   289‚Üí    warningLightMat.disableLighting = true;
   290‚Üí
   291‚Üí    // === MAIN RING (Habitat Torus) ===
   292‚Üí    // Large rotating ring - the main living quarters of the station
   293‚Üí    this.stationRing = MeshBuilder.CreateTorus(
   294‚Üí      &#x27;stationRing&#x27;,
   295‚Üí      {
   296‚Üí        diameter: 40,
   297‚Üí        thickness: 4,
   298‚Üí        tessellation: 48,
   299‚Üí      },
   300‚Üí      this.scene
   301‚Üí    );
   302‚Üí    this.stationRing.material = hullMat;
   303‚Üí    this.stationRing.rotation.x = Math.PI / 2; // Flat orientation
   304‚Üí    this.stationRing.parent = this.anchorStation;
   305‚Üí
   306‚Üí    // Ring detail - inner supports
   307‚Üí    for (let i = 0; i &lt; 8; i++) {
   308‚Üí      const angle = (i / 8) * Math.PI * 2;
   309‚Üí      const spoke = MeshBuilder.CreateCylinder(
   310‚Üí        `ringSpoke_${i}`,
   311‚Üí        {
   312‚Üí          height: 16,
   313‚Üí          diameter: 0.8,
   314‚Üí          tessellation: 8,
   315‚Üí        },
   316‚Üí        this.scene
   317‚Üí      );
   318‚Üí      spoke.material = hullMat;
   319‚Üí      spoke.rotation.z = Math.PI / 2;
   320‚Üí      spoke.rotation.y = angle;
   321‚Üí      spoke.position.x = Math.cos(angle) * 10;
   322‚Üí      spoke.position.z = Math.sin(angle) * 10;
   323‚Üí      spoke.parent = this.anchorStation;
   324‚Üí    }
   325‚Üí
   326‚Üí    // === CENTRAL HUB ===
   327‚Üí    // The command center and docking hub
   328‚Üí    this.stationHub = MeshBuilder.CreateCylinder(
   329‚Üí      &#x27;stationHub&#x27;,
   330‚Üí      {
   331‚Üí        height: 12,
   332‚Üí        diameter: 8,
   333‚Üí        tessellation: 16,
   334‚Üí      },
   335‚Üí      this.scene
   336‚Üí    );
   337‚Üí    this.stationHub.material = hullMat;
   338‚Üí    this.stationHub.parent = this.anchorStation;
   339‚Üí
   340‚Üí    // Hub caps (top and bottom)
   341‚Üí    const hubCapTop = MeshBuilder.CreateCylinder(
   342‚Üí      &#x27;hubCapTop&#x27;,
   343‚Üí      {
   344‚Üí        height: 2,
   345‚Üí        diameterTop: 2,
   346‚Üí        diameterBottom: 8,
   347‚Üí        tessellation: 16,
   348‚Üí      },
   349‚Üí      this.scene
   350‚Üí    );
   351‚Üí    hubCapTop.material = hullMat;
   352‚Üí    hubCapTop.position.y = 7;
   353‚Üí    hubCapTop.parent = this.anchorStation;
   354‚Üí
   355‚Üí    const hubCapBottom = MeshBuilder.CreateCylinder(
   356‚Üí      &#x27;hubCapBottom&#x27;,
   357‚Üí      {
   358‚Üí        height: 2,
   359‚Üí        diameterTop: 8,
   360‚Üí        diameterBottom: 2,
   361‚Üí        tessellation: 16,
   362‚Üí      },
   363‚Üí      this.scene
   364‚Üí    );
   365‚Üí    hubCapBottom.material = hullMat;
   366‚Üí    hubCapBottom.position.y = -7;
   367‚Üí    hubCapBottom.parent = this.anchorStation;
   368‚Üí
   369‚Üí    // === SOLAR PANELS ===
   370‚Üí    // Four large solar panel arrays extending from the hub
   371‚Üí    for (let i = 0; i &lt; 4; i++) {
   372‚Üí      const angle = (i / 4) * Math.PI * 2 + Math.PI / 4; // Offset 45 degrees from spokes
   373‚Üí
   374‚Üí      // Panel arm
   375‚Üí      const arm = MeshBuilder.CreateCylinder(
   376‚Üí        `solarArm_${i}`,
   377‚Üí        {
   378‚Üí          height: 15,
   379‚Üí          diameter: 0.6,
   380‚Üí          tessellation: 6,
   381‚Üí        },
   382‚Üí        this.scene
   383‚Üí      );
   384‚Üí      arm.material = hullMat;
   385‚Üí      arm.rotation.z = Math.PI / 2;
   386‚Üí      arm.rotation.y = angle;
   387‚Üí      arm.position.x = Math.cos(angle) * 11.5;
   388‚Üí      arm.position.z = Math.sin(angle) * 11.5;
   389‚Üí      arm.position.y = 3;
   390‚Üí      arm.parent = this.anchorStation;
   391‚Üí
   392‚Üí      // Solar panel (large rectangle)
   393‚Üí      const panel = MeshBuilder.CreateBox(
   394‚Üí        `solarPanel_${i}`,
   395‚Üí        {
   396‚Üí          width: 12,
   397‚Üí          height: 0.2,
   398‚Üí          depth: 6,
   399‚Üí        },
   400‚Üí        this.scene
   401‚Üí      );
   402‚Üí      panel.material = panelMat;
   403‚Üí      panel.rotation.y = angle;
   404‚Üí      panel.position.x = Math.cos(angle) * 25;
   405‚Üí      panel.position.z = Math.sin(angle) * 25;
   406‚Üí      panel.position.y = 3;
   407‚Üí      panel.parent = this.anchorStation;
   408‚Üí      this.stationSolarPanels.push(panel);
   409‚Üí
   410‚Üí      // Panel frame
   411‚Üí      const frameOuter = MeshBuilder.CreateBox(
   412‚Üí        `panelFrame_${i}`,
   413‚Üí        {
   414‚Üí          width: 12.5,
   415‚Üí          height: 0.4,
   416‚Üí          depth: 6.5,
   417‚Üí        },
   418‚Üí        this.scene
   419‚Üí      );
   420‚Üí      frameOuter.material = hullMat;
   421‚Üí      frameOuter.rotation.y = angle;
   422‚Üí      frameOuter.position.x = Math.cos(angle) * 25;
   423‚Üí      frameOuter.position.z = Math.sin(angle) * 25;
   424‚Üí      frameOuter.position.y = 3;
   425‚Üí      frameOuter.parent = this.anchorStation;
   426‚Üí    }
   427‚Üí
   428‚Üí    // === DROP POD BAY ===
   429‚Üí    // The bay the player just launched from - positioned at the bottom of the hub
   430‚Üí    this.stationDropBay = MeshBuilder.CreateBox(
   431‚Üí      &#x27;dropBay&#x27;,
   432‚Üí      {
   433‚Üí        width: 6,
   434‚Üí        height: 4,
   435‚Üí        depth: 6,
   436‚Üí      },
   437‚Üí      this.scene
   438‚Üí    );
   439‚Üí    this.stationDropBay.material = hullMat;
   440‚Üí    this.stationDropBay.position.y = -10;
   441‚Üí    this.stationDropBay.parent = this.anchorStation;
   442‚Üí
   443‚Üí    // Drop bay opening (where the player came from) - glowing
   444‚Üí    const bayOpening = MeshBuilder.CreatePlane(
   445‚Üí      &#x27;bayOpening&#x27;,
   446‚Üí      {
   447‚Üí        width: 4,
   448‚Üí        height: 4,
   449‚Üí      },
   450‚Üí      this.scene
   451‚Üí    );
   452‚Üí    const bayOpeningMat = new StandardMaterial(&#x27;bayOpeningMat&#x27;, this.scene);
   453‚Üí    bayOpeningMat.emissiveColor = new Color3(1.0, 0.6, 0.2);
   454‚Üí    bayOpeningMat.alpha = 0.6;
   455‚Üí    bayOpeningMat.disableLighting = true;
   456‚Üí    bayOpening.material = bayOpeningMat;
   457‚Üí    bayOpening.position.y = -12;
   458‚Üí    bayOpening.rotation.x = Math.PI / 2;
   459‚Üí    bayOpening.parent = this.anchorStation;
   460‚Üí
   461‚Üí    // === RUNNING LIGHTS ===
   462‚Üí    // Station navigation and warning lights
   463‚Üí    const lightPositions = [
   464‚Üí      { pos: new Vector3(20, 0, 0), mat: lightMat },
   465‚Üí      { pos: new Vector3(-20, 0, 0), mat: lightMat },
   466‚Üí      { pos: new Vector3(0, 0, 20), mat: lightMat },
   467‚Üí      { pos: new Vector3(0, 0, -20), mat: lightMat },
   468‚Üí      { pos: new Vector3(0, 8, 0), mat: warningLightMat },
   469‚Üí      { pos: new Vector3(0, -8, 0), mat: warningLightMat },
   470‚Üí      { pos: new Vector3(3, -12, 3), mat: warningLightMat },
   471‚Üí      { pos: new Vector3(-3, -12, 3), mat: warningLightMat },
   472‚Üí      { pos: new Vector3(3, -12, -3), mat: warningLightMat },
   473‚Üí      { pos: new Vector3(-3, -12, -3), mat: warningLightMat },
   474‚Üí    ];
   475‚Üí
   476‚Üí    for (let i = 0; i &lt; lightPositions.length; i++) {
   477‚Üí      const light = MeshBuilder.CreateSphere(
   478‚Üí        `stationLight_${i}`,
   479‚Üí        { diameter: 0.5, segments: 8 },
   480‚Üí        this.scene
   481‚Üí      );
   482‚Üí      light.material = lightPositions[i].mat;
   483‚Üí      light.position = lightPositions[i].pos;
   484‚Üí      light.parent = this.anchorStation;
   485‚Üí      this.stationLights.push(light);
   486‚Üí    }
   487‚Üí
   488‚Üí    // === DOCKING PORTS ===
   489‚Üí    // Small docking ports around the ring
   490‚Üí    for (let i = 0; i &lt; 4; i++) {
   491‚Üí      const angle = (i / 4) * Math.PI * 2;
   492‚Üí      const port = MeshBuilder.CreateCylinder(
   493‚Üí        `dockingPort_${i}`,
   494‚Üí        {
   495‚Üí          height: 1.5,
   496‚Üí          diameter: 2,
   497‚Üí          tessellation: 8,
   498‚Üí        },
   499‚Üí        this.scene
   500‚Üí      );
   501‚Üí      port.material = hullMat;
   502‚Üí      port.rotation.z = Math.PI / 2;
   503‚Üí      port.rotation.y = angle;
   504‚Üí      port.position.x = Math.cos(angle) * 22;
   505‚Üí      port.position.z = Math.sin(angle) * 22;
   506‚Üí      port.parent = this.anchorStation;
   507‚Üí    }
   508‚Üí
   509‚Üí    // === ANTENNA ARRAY ===
   510‚Üí    // Communication array on top of hub
   511‚Üí    const antenna = MeshBuilder.CreateCylinder(
   512‚Üí      &#x27;antenna&#x27;,
   513‚Üí      {
   514‚Üí        height: 6,
   515‚Üí        diameter: 0.3,
   516‚Üí        tessellation: 6,
   517‚Üí      },
   518‚Üí      this.scene
   519‚Üí    );
   520‚Üí    antenna.material = hullMat;
   521‚Üí    antenna.position.y = 11;
   522‚Üí    antenna.parent = this.anchorStation;
   523‚Üí
   524‚Üí    const dish = MeshBuilder.CreateDisc(
   525‚Üí      &#x27;dish&#x27;,
   526‚Üí      {
   527‚Üí        radius: 2,
   528‚Üí        tessellation: 12,
   529‚Üí      },
   530‚Üí      this.scene
   531‚Üí    );
   532‚Üí    dish.material = panelMat;
   533‚Üí    dish.position.y = 13;
   534‚Üí    dish.rotation.x = -Math.PI / 6;
   535‚Üí    dish.parent = this.anchorStation;
   536‚Üí  }
   537‚Üí
   538‚Üí  /**
   539‚Üí   * Updates the Anchor Station position and rotation during freefall.
   540‚Üí   * The station slowly rotates and recedes into the distance as the player falls.
   541‚Üí   */
   542‚Üí  private updateAnchorStation(deltaTime: number): void {
   543‚Üí    if (!this.anchorStation) return;
   544‚Üí
   545‚Üí    // Station is only visible during freefall phases
   546‚Üí    if (
   547‚Üí      this.phase !== &#x27;freefall_start&#x27; &amp;&amp;
   548‚Üí      this.phase !== &#x27;freefall_belt&#x27; &amp;&amp;
   549‚Üí      this.phase !== &#x27;freefall_clear&#x27;
   550‚Üí    ) {
   551‚Üí      this.anchorStation.setEnabled(false);
   552‚Üí      return;
   553‚Üí    }
   554‚Üí
   555‚Üí    // Slowly rotate the station (creates sense of scale and realism)
   556‚Üí    this.anchorStation.rotation.y += deltaTime * 0.1;
   557‚Üí
   558‚Üí    // Station recedes as player falls - exponential distance increase
   559‚Üí    // At altitude 1000, station is close; at altitude 650, station is far
   560‚Üí    const altitudeFactor = Math.max(0, (this.altitude - 600) / 400); // 1.0 at 1000, 0 at 600
   561‚Üí    const distance = this.stationInitialDistance + (1 - altitudeFactor) * 150;
   562‚Üí    this.anchorStation.position.y = distance;
   563‚Üí
   564‚Üí    // Scale down as it gets further (perspective effect)
   565‚Üí    const scale = Math.max(0.3, altitudeFactor);
   566‚Üí    this.anchorStation.scaling.setAll(scale);
   567‚Üí
   568‚Üí    // Fade station lights based on distance
   569‚Üí    const lightIntensity = Math.max(0.2, altitudeFactor);
   570‚Üí    for (const light of this.stationLights) {
   571‚Üí      if (light.material) {
   572‚Üí        (light.material as StandardMaterial).alpha = lightIntensity;
   573‚Üí      }
   574‚Üí    }
   575‚Üí
   576‚Üí    // Add slight drift to simulate relative motion
   577‚Üí    this.anchorStation.position.x = -this.positionX * 0.02;
   578‚Üí    this.anchorStation.position.z = -this.positionZ * 0.02;
   579‚Üí  }
   580‚Üí
   581‚Üí  private createFreefallView(): void {
   582‚Üí    // Arms reaching down (skydiver pose)
   583‚Üí    const armMat = new StandardMaterial(&#x27;armMat&#x27;, this.scene);
   584‚Üí    armMat.diffuseColor = new Color3(0.15, 0.15, 0.18);
   585‚Üí
   586‚Üí    this.leftArm = MeshBuilder.CreateCylinder(
   587‚Üí      &#x27;leftArm&#x27;,
   588‚Üí      {
   589‚Üí        height: 3,
   590‚Üí        diameterTop: 0.25,
   591‚Üí        diameterBottom: 0.3,
   592‚Üí      },
   593‚Üí      this.scene
   594‚Üí    );
   595‚Üí    this.leftArm.material = armMat;
   596‚Üí    this.leftArm.position.set(-1.8, -2.5, 0);
   597‚Üí
   598‚Üí    this.rightArm = MeshBuilder.CreateCylinder(
   599‚Üí      &#x27;rightArm&#x27;,
   600‚Üí      {
   601‚Üí        height: 3,
   602‚Üí        diameterTop: 0.25,
   603‚Üí        diameterBottom: 0.3,
   604‚Üí      },
   605‚Üí      this.scene
   606‚Üí    );
   607‚Üí    this.rightArm.material = armMat;
   608‚Üí    this.rightArm.position.set(1.8, -2.5, 0);
   609‚Üí
   610‚Üí    const gloveMat = new StandardMaterial(&#x27;gloveMat&#x27;, this.scene);
   611‚Üí    gloveMat.diffuseColor = new Color3(0.3, 0.25, 0.2);
   612‚Üí
   613‚Üí    this.leftGlove = MeshBuilder.CreateSphere(&#x27;leftGlove&#x27;, { diameter: 0.5 }, this.scene);
   614‚Üí    this.leftGlove.material = gloveMat;
   615‚Üí    this.leftGlove.position.set(-1.8, -4.2, 0.3);
   616‚Üí    this.leftGlove.scaling.set(1, 0.6, 1.2);
   617‚Üí
   618‚Üí    this.rightGlove = MeshBuilder.CreateSphere(&#x27;rightGlove&#x27;, { diameter: 0.5 }, this.scene);
   619‚Üí    this.rightGlove.material = gloveMat;
   620‚Üí    this.rightGlove.position.set(1.8, -4.2, 0.3);
   621‚Üí    this.rightGlove.scaling.set(1, 0.6, 1.2);
   622‚Üí
   623‚Üí    // Visor frame
   624‚Üí    this.visorFrame = MeshBuilder.CreateTorus(
   625‚Üí      &#x27;visor&#x27;,
   626‚Üí      {
   627‚Üí        diameter: 10,
   628‚Üí        thickness: 0.3,
   629‚Üí      },
   630‚Üí      this.scene
   631‚Üí    );
   632‚Üí    const visorMat = new StandardMaterial(&#x27;visorMat&#x27;, this.scene);
   633‚Üí    visorMat.diffuseColor = new Color3(0.1, 0.1, 0.12);
   634‚Üí    visorMat.alpha = 0.6;
   635‚Üí    this.visorFrame.material = visorMat;
   636‚Üí    this.visorFrame.rotation.x = Math.PI / 2;
   637‚Üí    this.visorFrame.position.y = -2;
   638‚Üí  }
   639‚Üí
   640‚Üí  private createPoweredDescentView(): void {
   641‚Üí    // Hands gripping thruster handles (looking OUT)
   642‚Üí    const handleMat = new StandardMaterial(&#x27;handleMat&#x27;, this.scene);
   643‚Üí    handleMat.diffuseColor = new Color3(0.2, 0.2, 0.22);
   644‚Üí
   645‚Üí    // Left handle bar
   646‚Üí    this.leftHandle = MeshBuilder.CreateCylinder(
   647‚Üí      &#x27;leftHandle&#x27;,
   648‚Üí      {
   649‚Üí        height: 0.8,
   650‚Üí        diameter: 0.12,
   651‚Üí      },
   652‚Üí      this.scene
   653‚Üí    );
   654‚Üí    this.leftHandle.material = handleMat;
   655‚Üí    this.leftHandle.position.set(-0.6, -0.3, 0.5);
   656‚Üí    this.leftHandle.rotation.z = Math.PI / 2;
   657‚Üí
   658‚Üí    // Right handle bar
   659‚Üí    this.rightHandle = MeshBuilder.CreateCylinder(
   660‚Üí      &#x27;rightHandle&#x27;,
   661‚Üí      {
   662‚Üí        height: 0.8,
   663‚Üí        diameter: 0.12,
   664‚Üí      },
   665‚Üí      this.scene
   666‚Üí    );
   667‚Üí    this.rightHandle.material = handleMat;
   668‚Üí    this.rightHandle.position.set(0.6, -0.3, 0.5);
   669‚Üí    this.rightHandle.rotation.z = Math.PI / 2;
   670‚Üí
   671‚Üí    // Thruster glow (below view)
   672‚Üí    this.thrusterGlow = MeshBuilder.CreateDisc(
   673‚Üí      &#x27;thrusterGlow&#x27;,
   674‚Üí      {
   675‚Üí        radius: 0.8,
   676‚Üí      },
   677‚Üí      this.scene
   678‚Üí    );
   679‚Üí    const thrusterMat = new StandardMaterial(&#x27;thrusterMat&#x27;, this.scene);
   680‚Üí    thrusterMat.emissiveColor = new Color3(0.3, 0.5, 1);
   681‚Üí    thrusterMat.alpha = 0;
   682‚Üí    thrusterMat.disableLighting = true;
   683‚Üí    this.thrusterGlow.material = thrusterMat;
   684‚Üí    this.thrusterGlow.position.set(0, -1, 1);
   685‚Üí    this.thrusterGlow.rotation.x = Math.PI / 2;
   686‚Üí  }
   687‚Üí
   688‚Üí  private createEntryEffects(): void {
   689‚Üí    this.plasmaGlow = MeshBuilder.CreateTorus(
   690‚Üí      &#x27;plasma&#x27;,
   691‚Üí      {
   692‚Üí        diameter: 12,
   693‚Üí        thickness: 2,
   694‚Üí      },
   695‚Üí      this.scene
   696‚Üí    );
   697‚Üí    const plasmaMat = new StandardMaterial(&#x27;plasmaMat&#x27;, this.scene);
   698‚Üí    plasmaMat.emissiveColor = new Color3(1, 0.5, 0.15);
   699‚Üí    plasmaMat.alpha = 0;
   700‚Üí    plasmaMat.disableLighting = true;
   701‚Üí    this.plasmaGlow.material = plasmaMat;
   702‚Üí    this.plasmaGlow.rotation.x = Math.PI / 2;
   703‚Üí    this.plasmaGlow.position.y = -3;
   704‚Üí  }
   705‚Üí
   706‚Üí  private createLandingZone(): void {
   707‚Üí    // LZ pad - cement circle
   708‚Üí    this.lzPad = MeshBuilder.CreateCylinder(
   709‚Üí      &#x27;lzPad&#x27;,
   710‚Üí      {
   711‚Üí        height: 0.3,
   712‚Üí        diameter: this.lzRadius * 2,
   713‚Üí      },
   714‚Üí      this.scene
   715‚Üí    );
   716‚Üí    const padMat = new StandardMaterial(&#x27;padMat&#x27;, this.scene);
   717‚Üí    padMat.diffuseColor = new Color3(0.5, 0.5, 0.5);
   718‚Üí    this.lzPad.material = padMat;
   719‚Üí    this.lzPad.position.y = 0.15;
   720‚Üí    this.lzPad.isVisible = false;
   721‚Üí
   722‚Üí    // Beacon
   723‚Üí    this.lzBeacon = MeshBuilder.CreateCylinder(
   724‚Üí      &#x27;beacon&#x27;,
   725‚Üí      {
   726‚Üí        height: 20,
   727‚Üí        diameter: 2,
   728‚Üí      },
   729‚Üí      this.scene
   730‚Üí    );
   731‚Üí    const beaconMat = new StandardMaterial(&#x27;beaconMat&#x27;, this.scene);
   732‚Üí    beaconMat.emissiveColor = new Color3(0.2, 1, 0.3);
   733‚Üí    beaconMat.alpha = 0.3;
   734‚Üí    this.lzBeacon.material = beaconMat;
   735‚Üí    this.lzBeacon.position.y = 10;
   736‚Üí    this.lzBeacon.isVisible = false;
   737‚Üí  }
   738‚Üí
   739‚Üí  private createSurface(): void {
   740‚Üí    this.terrain = MeshBuilder.CreateGround(
   741‚Üí      &#x27;terrain&#x27;,
   742‚Üí      {
   743‚Üí        width: 600,
   744‚Üí        height: 600,
   745‚Üí        subdivisions: 64,
   746‚Üí      },
   747‚Üí      this.scene
   748‚Üí    );
   749‚Üí    const terrainMat = new StandardMaterial(&#x27;terrainMat&#x27;, this.scene);
   750‚Üí    terrainMat.diffuseColor = Color3.FromHexString(&#x27;#8B5A2B&#x27;);
   751‚Üí    this.terrain.material = terrainMat;
   752‚Üí    this.terrain.isVisible = false;
   753‚Üí
   754‚Üí    // Canyon walls
   755‚Üí    for (let i = 0; i &lt; 4; i++) {
   756‚Üí      const wall = MeshBuilder.CreateBox(
   757‚Üí        `wall_${i}`,
   758‚Üí        {
   759‚Üí          width: 25,
   760‚Üí          height: 100,
   761‚Üí          depth: 180,
   762‚Üí        },
   763‚Üí        this.scene
   764‚Üí      );
   765‚Üí      const wallMat = new StandardMaterial(`wallMat_${i}`, this.scene);
   766‚Üí      wallMat.diffuseColor = Color3.FromHexString(&#x27;#6B4423&#x27;);
   767‚Üí      wall.material = wallMat;
   768‚Üí      wall.position.set((i % 2 === 0 ? -1 : 1) * (60 + i * 10), 50, -50 - i * 30);
   769‚Üí      wall.isVisible = false;
   770‚Üí      this.canyonWalls.push(wall);
   771‚Üí    }
   772‚Üí
   773‚Üí    this.skyDome = MeshBuilder.CreateSphere(
   774‚Üí      &#x27;sky&#x27;,
   775‚Üí      {
   776‚Üí        diameter: 5000,
   777‚Üí        segments: 16,
   778‚Üí        sideOrientation: 1,
   779‚Üí      },
   780‚Üí      this.scene
   781‚Üí    );
   782‚Üí    const skyMat = new StandardMaterial(&#x27;skyMat&#x27;, this.scene);
   783‚Üí    skyMat.emissiveColor = new Color3(0.75, 0.5, 0.35);
   784‚Üí    skyMat.disableLighting = true;
   785‚Üí    this.skyDome.material = skyMat;
   786‚Üí    this.skyDome.isVisible = false;
   787‚Üí  }
   788‚Üí
   789‚Üí  /**
   790‚Üí   * Preload alien vehicle models for distant threats during descent.
   791‚Üí   * Wraith hover tanks and Phantom dropships appear as distant silhouettes.
   792‚Üí   */
   793‚Üí  private async preloadDistantThreats(): Promise&lt;void&gt; {
   794‚Üí    try {
   795‚Üí      // Load both vehicle models
   796‚Üí      await Promise.all([
   797‚Üí        AssetManager.loadAsset(&#x27;vehicles&#x27;, &#x27;wraith&#x27;, this.scene),
   798‚Üí        AssetManager.loadAsset(&#x27;vehicles&#x27;, &#x27;phantom&#x27;, this.scene),
   799‚Üí      ]);
   800‚Üí      console.log(&#x27;[Landfall] Preloaded alien vehicle models for distant threats&#x27;);
   801‚Üí    } catch (error) {
   802‚Üí      console.warn(&#x27;[Landfall] Could not preload vehicle models:&#x27;, error);
   803‚Üí    }
   804‚Üí  }
   805‚Üí
   806‚Üí  /**
   807‚Üí   * Spawn distant alien vehicles during the HALO jump.
   808‚Üí   * These are visual threats that add tension without direct gameplay impact.
   809‚Üí   */
   810‚Üí  private spawnDistantThreats(): void {
   811‚Üí    if (this.threatsSpawned) return;
   812‚Üí    this.threatsSpawned = true;
   813‚Üí
   814‚Üí    // Define distant threat patterns - alien vehicles patrolling during descent
   815‚Üí    const threatDefinitions = [
   816‚Üí      {
   817‚Üí        type: &#x27;wraith&#x27; as const,
   818‚Üí        position: new Vector3(-80, -40, -60), // Far left
   819‚Üí        velocity: new Vector3(8, 0, 3),
   820‚Üí        rotationSpeed: 0.2,
   821‚Üí        scale: 10,
   822‚Üí      },
   823‚Üí      {
   824‚Üí        type: &#x27;phantom&#x27; as const,
   825‚Üí        position: new Vector3(100, -30, -80), // Far right
   826‚Üí        velocity: new Vector3(-5, 1, 4),
   827‚Üí        rotationSpeed: 0.15,
   828‚Üí        scale: 12,
   829‚Üí      },
   830‚Üí      {
   831‚Üí        type: &#x27;wraith&#x27; as const,
   832‚Üí        position: new Vector3(50, -60, 70), // Behind
   833‚Üí        velocity: new Vector3(-3, 0.5, -2),
   834‚Üí        rotationSpeed: 0.25,
   835‚Üí        scale: 8,
   836‚Üí      },
   837‚Üí    ];
   838‚Üí
   839‚Üí    for (let i = 0; i &lt; threatDefinitions.length; i++) {
   840‚Üí      const def = threatDefinitions[i];
   841‚Üí
   842‚Üí      try {
   843‚Üí        const instance = AssetManager.createInstance(
   844‚Üí          &#x27;vehicles&#x27;,
   845‚Üí          def.type,
   846‚Üí          `distant_${def.type}_${i}`,
   847‚Üí          this.scene
   848‚Üí        );
   849‚Üí
   850‚Üí        if (instance) {
   851‚Üí          instance.position = def.position.clone();
   852‚Üí          instance.scaling.setAll(def.scale);
   853‚Üí          // Start hidden, will fade in
   854‚Üí          instance.setEnabled(true);
   855‚Üí
   856‚Üí          this.distantThreats.push({
   857‚Üí            node: instance,
   858‚Üí            position: def.position.clone(),
   859‚Üí            velocity: def.velocity,
   860‚Üí            rotationSpeed: def.rotationSpeed,
   861‚Üí            type: def.type,
   862‚Üí            spawnAltitude: 900,
   863‚Üí          });
   864‚Üí        }
   865‚Üí      } catch (error) {
   866‚Üí        // Create fallback simple mesh if GLB loading fails
   867‚Üí        const fallback = MeshBuilder.CreateBox(
   868‚Üí          `threat_fallback_${i}`,
   869‚Üí          { width: 3, height: 1, depth: 5 },
   870‚Üí          this.scene
   871‚Üí        );
   872‚Üí        const mat = new StandardMaterial(`threatMat_${i}`, this.scene);
   873‚Üí        mat.diffuseColor = new Color3(0.2, 0.15, 0.25);
   874‚Üí        mat.alpha = 0.6;
   875‚Üí        fallback.material = mat;
   876‚Üí        fallback.position = def.position.clone();
   877‚Üí
   878‚Üí        // Wrap in TransformNode for consistent interface
   879‚Üí        const wrapper = new TransformNode(`threat_wrapper_${i}`, this.scene);
   880‚Üí        fallback.parent = wrapper;
   881‚Üí
   882‚Üí        this.distantThreats.push({
   883‚Üí          node: wrapper,
   884‚Üí          position: def.position.clone(),
   885‚Üí          velocity: def.velocity,
   886‚Üí          rotationSpeed: def.rotationSpeed,
   887‚Üí          type: def.type,
   888‚Üí          spawnAltitude: 900,
   889‚Üí        });
   890‚Üí      }
   891‚Üí    }
   892‚Üí
   893‚Üí    // Comms message about detecting enemy air traffic
   894‚Üí    setTimeout(() =&gt; {
   895‚Üí      this.callbacks.onCommsMessage({
   896‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
   897‚Üí        callsign: &#x27;ATHENA&#x27;,
   898‚Üí        portrait: &#x27;ai&#x27;,
   899‚Üí        text: &#x27;Warning: Enemy air traffic detected. Wraith patrols in the area. Maintain stealth profile.&#x27;,
   900‚Üí      });
   901‚Üí    }, 500);
   902‚Üí  }
   903‚Üí
   904‚Üí  /**
   905‚Üí   * Update distant threat positions and animations
   906‚Üí   */
   907‚Üí  private updateDistantThreats(deltaTime: number): void {
   908‚Üí    for (const threat of this.distantThreats) {
   909‚Üí      // Move the threat
   910‚Üí      threat.position.addInPlace(threat.velocity.scale(deltaTime));
   911‚Üí      threat.node.position = threat.position;
   912‚Üí
   913‚Üí      // Rotate slowly (banking motion)
   914‚Üí      threat.node.rotation.y += threat.rotationSpeed * deltaTime;
   915‚Üí
   916‚Üí      // Slight bobbing for Phantom dropships
   917‚Üí      if (threat.type === &#x27;phantom&#x27;) {
   918‚Üí        threat.node.position.y += Math.sin(performance.now() * 0.001) * 0.02;
   919‚Üí      }
   920‚Üí    }
   921‚Üí  }
   922‚Üí
   923‚Üí  private setFreefallVisible(visible: boolean): void {
   924‚Üí    if (this.leftArm) this.leftArm.isVisible = visible;
   925‚Üí    if (this.rightArm) this.rightArm.isVisible = visible;
   926‚Üí    if (this.leftGlove) this.leftGlove.isVisible = visible;
   927‚Üí    if (this.rightGlove) this.rightGlove.isVisible = visible;
   928‚Üí    if (this.visorFrame) this.visorFrame.isVisible = visible;
   929‚Üí  }
   930‚Üí
   931‚Üí  private setPoweredDescentVisible(visible: boolean): void {
   932‚Üí    if (this.leftHandle) this.leftHandle.isVisible = visible;
   933‚Üí    if (this.rightHandle) this.rightHandle.isVisible = visible;
   934‚Üí    if (this.thrusterGlow) this.thrusterGlow.isVisible = visible;
   935‚Üí  }
   936‚Üí
   937‚Üí  private startJump(): void {
   938‚Üí    this.phase = &#x27;freefall_start&#x27;;
   939‚Üí    this.altitude = 1000;
   940‚Üí    this.velocity = 10;
   941‚Üí    this.phaseTime = 0;
   942‚Üí
   943‚Üí    this.callbacks.onCinematicStart?.();
   944‚Üí    this.callbacks.onNotification(&#x27;HALO JUMP INITIATED&#x27;, 3000);
   945‚Üí
   946‚Üí    // Setup action handler
   947‚Üí    this.actionCallback = this.handleAction.bind(this);
   948‚Üí    this.callbacks.onActionHandlerRegister(this.actionCallback);
   949‚Üí
   950‚Üí    setTimeout(() =&gt; {
   951‚Üí      this.callbacks.onCommsMessage({
   952‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
   953‚Üí        callsign: &#x27;ATHENA&#x27;,
   954‚Üí        portrait: &#x27;ai&#x27;,
   955‚Üí        text: &#x27;Clear of station. Debris belt ahead. Spread and stabilize.&#x27;,
   956‚Üí      });
   957‚Üí    }, 1500);
   958‚Üí
   959‚Üí    setTimeout(() =&gt; {
   960‚Üí      this.transitionToPhase(&#x27;freefall_belt&#x27;);
   961‚Üí    }, 4000);
   962‚Üí  }
   963‚Üí
   964‚Üí  private handleAction(actionId: string): void {
   965‚Üí    switch (actionId) {
   966‚Üí      case &#x27;ignite_jets&#x27;:
   967‚Üí        if (this.phase === &#x27;freefall_clear&#x27; &amp;&amp; this.altitude &lt; 600) {
   968‚Üí          this.transitionToPhase(&#x27;powered_descent&#x27;);
   969‚Üí        } else {
   970‚Üí          this.callbacks.onNotification(&#x27;TOO HIGH FOR IGNITION&#x27;, 1500);
   971‚Üí        }
   972‚Üí        break;
   973‚Üí
   974‚Üí      case &#x27;boost&#x27;:
   975‚Üí        if (this.phase === &#x27;powered_descent&#x27; &amp;&amp; this.fuel &gt; 0) {
   976‚Üí          this.velocity = Math.max(5, this.velocity - 30 * 0.016);
   977‚Üí          this.fuel -= this.fuelBurnRate * 0.016;
   978‚Üí          this.showThrusterGlow(0.8);
   979‚Üí        }
   980‚Üí        break;
   981‚Üí
   982‚Üí      case &#x27;brake&#x27;:
   983‚Üí        if (this.phase === &#x27;powered_descent&#x27; &amp;&amp; this.fuel &gt; 0) {
   984‚Üí          this.velocity = Math.min(80, this.velocity + 10 * 0.016);
   985‚Üí          this.fuel -= this.fuelBurnRate * 0.5 * 0.016;
   986‚Üí        }
   987‚Üí        break;
   988‚Üí
   989‚Üí      case &#x27;stabilize&#x27;:
   990‚Üí        if (this.phase === &#x27;powered_descent&#x27; &amp;&amp; this.fuel &gt; 5) {
   991‚Üí          this.lateralVelocityX *= 0.8;
   992‚Üí          this.lateralVelocityZ *= 0.8;
   993‚Üí          this.fuel -= 5;
   994‚Üí          this.callbacks.onNotification(&#x27;STABILIZING&#x27;, 500);
   995‚Üí        }
   996‚Üí        break;
   997‚Üí
   998‚Üí      // Surface combat actions
   999‚Üí      case &#x27;grenade&#x27;:
  1000‚Üí        if (this.phase === &#x27;surface&#x27;) {
  1001‚Üí          this.callbacks.onNotification(&#x27;GRENADE THROWN&#x27;, 1000);
  1002‚Üí          // Grenade logic would be implemented here
  1003‚Üí          // For now, just trigger the notification and damage callback
  1004‚Üí          this.callbacks.onDamage();
  1005‚Üí        }
  1006‚Üí        break;
  1007‚Üí
  1008‚Üí      case &#x27;melee&#x27;:
  1009‚Üí        if (this.phase === &#x27;surface&#x27;) {
  1010‚Üí          this.callbacks.onNotification(&#x27;MELEE ATTACK&#x27;, 500);
  1011‚Üí          // Melee logic would be implemented here
  1012‚Üí        }
  1013‚Üí        break;
  1014‚Üí    }
  1015‚Üí  }
  1016‚Üí
  1017‚Üí  private showThrusterGlow(intensity: number): void {
  1018‚Üí    if (this.thrusterGlow?.material) {
  1019‚Üí      (this.thrusterGlow.material as StandardMaterial).alpha = intensity;
  1020‚Üí    }
  1021‚Üí  }
  1022‚Üí
  1023‚Üí  private transitionToPhase(newPhase: DropPhase): void {
  1024‚Üí    this.phase = newPhase;
  1025‚Üí    this.phaseTime = 0;
  1026‚Üí
  1027‚Üí    switch (newPhase) {
  1028‚Üí      case &#x27;freefall_belt&#x27;:
  1029‚Üí        this.callbacks.onNotification(&#x27;‚ö†Ô∏è ENTERING DEBRIS FIELD&#x27;, 2000);
  1030‚Üí        this.callbacks.onObjectiveUpdate(
  1031‚Üí          &#x27;NAVIGATE DEBRIS&#x27;,
  1032‚Üí          &#x27;WASD: Body position | Dodge asteroids&#x27;
  1033‚Üí        );
  1034‚Üí        this.asteroidSpawnRate = 0.35;
  1035‚Üí        this.setBaseShake(0.3);
  1036‚Üí        break;
  1037‚Üí
  1038‚Üí      case &#x27;freefall_clear&#x27;:
  1039‚Üí        this.callbacks.onNotification(&#x27;DEBRIS FIELD CLEARED&#x27;, 2000);
  1040‚Üí        this.callbacks.onCommsMessage({
  1041‚Üí          sender: &#x27;PROMETHEUS A.I.&#x27;,
  1042‚Üí          callsign: &#x27;ATHENA&#x27;,
  1043‚Üí          portrait: &#x27;ai&#x27;,
  1044‚Üí          text: &#x27;Debris cleared. Ignite retros when ready. LZ beacon locked.&#x27;,
  1045‚Üí        });
  1046‚Üí        // Show ignite jets button
  1047‚Üí        this.updateActionButtons(&#x27;ignite&#x27;);
  1048‚Üí        break;
  1049‚Üí
  1050‚Üí      case &#x27;powered_descent&#x27;:
  1051‚Üí        this.callbacks.onNotification(&#x27;JETS IGNITED&#x27;, 2000);
  1052‚Üí        this.callbacks.onCommsMessage({
  1053‚Üí          sender: &#x27;PROMETHEUS A.I.&#x27;,
  1054‚Üí          callsign: &#x27;ATHENA&#x27;,
  1055‚Üí          portrait: &#x27;ai&#x27;,
  1056‚Üí          text: &#x27;Retros online. Target the LZ pad. Watch your fuel.&#x27;,
  1057‚Üí        });
  1058‚Üí        // Switch camera perspective and narrow FOV slightly
  1059‚Üí        this.targetFOV = this.POWERED_DESCENT_FOV;
  1060‚Üí        this.switchToPoweredDescent();
  1061‚Üí        // Show descent controls
  1062‚Üí        this.updateActionButtons(&#x27;descent&#x27;);
  1063‚Üí        break;
  1064‚Üí
  1065‚Üí      case &#x27;landing&#x27;:
  1066‚Üí        this.callbacks.onNotification(&#x27;‚ö†Ô∏è FINAL APPROACH&#x27;, 2000);
  1067‚Üí        this.setBaseShake(2);
  1068‚Üí        break;
  1069‚Üí
  1070‚Üí      case &#x27;surface&#x27;:
  1071‚Üí        this.completeLanding();
  1072‚Üí        break;
  1073‚Üí    }
  1074‚Üí  }
  1075‚Üí
  1076‚Üí  private updateActionButtons(mode: &#x27;ignite&#x27; | &#x27;descent&#x27; | &#x27;combat&#x27; | &#x27;none&#x27;): void {
  1077‚Üí    let groups: ActionButtonGroup[] = [];
  1078‚Üí
  1079‚Üí    switch (mode) {
  1080‚Üí      case &#x27;ignite&#x27;:
  1081‚Üí        groups = [
  1082‚Üí          {
  1083‚Üí            id: &#x27;ignite&#x27;,
  1084‚Üí            label: &#x27;RETROS&#x27;,
  1085‚Üí            position: &#x27;right&#x27;,
  1086‚Üí            buttons: [
  1087‚Üí              createAction(&#x27;ignite_jets&#x27;, &#x27;IGNITE JETS&#x27;, &#x27;Space&#x27;, {
  1088‚Üí                variant: &#x27;danger&#x27;,
  1089‚Üí                size: &#x27;large&#x27;,
  1090‚Üí                highlighted: true,
  1091‚Üí                icon: &#x27;üî•&#x27;,
  1092‚Üí              }),
  1093‚Üí            ],
  1094‚Üí          },
  1095‚Üí        ];
  1096‚Üí        break;
  1097‚Üí
  1098‚Üí      case &#x27;descent&#x27;:
  1099‚Üí        groups = [
  1100‚Üí          {
  1101‚Üí            id: &#x27;descent&#x27;,
  1102‚Üí            label: &#x27;THRUSTERS&#x27;,
  1103‚Üí            position: &#x27;right&#x27;,
  1104‚Üí            buttons: [
  1105‚Üí              createAction(&#x27;boost&#x27;, &#x27;BOOST&#x27;, &#x27;Space&#x27;, {
  1106‚Üí                variant: &#x27;primary&#x27;,
  1107‚Üí                size: &#x27;large&#x27;,
  1108‚Üí                icon: &#x27;‚¨ÜÔ∏è&#x27;,
  1109‚Üí              }),
  1110‚Üí              createAction(&#x27;stabilize&#x27;, &#x27;STABILIZE&#x27;, &#x27;KeyQ&#x27;, {
  1111‚Üí                variant: &#x27;secondary&#x27;,
  1112‚Üí                icon: &#x27;‚öñÔ∏è&#x27;,
  1113‚Üí              }),
  1114‚Üí              createAction(&#x27;brake&#x27;, &#x27;BRAKE&#x27;, &#x27;KeyE&#x27;, {
  1115‚Üí                variant: &#x27;warning&#x27;,
  1116‚Üí                icon: &#x27;‚¨áÔ∏è&#x27;,
  1117‚Üí              }),
  1118‚Üí            ],
  1119‚Üí          },
  1120‚Üí        ];
  1121‚Üí        break;
  1122‚Üí
  1123‚Üí      case &#x27;combat&#x27;:
  1124‚Üí        groups = [
  1125‚Üí          {
  1126‚Üí            id: &#x27;combat&#x27;,
  1127‚Üí            label: &#x27;COMBAT&#x27;,
  1128‚Üí            position: &#x27;right&#x27;,
  1129‚Üí            buttons: [
  1130‚Üí              createAction(&#x27;grenade&#x27;, &#x27;GRENADE&#x27;, &#x27;KeyG&#x27;, {
  1131‚Üí                variant: &#x27;danger&#x27;,
  1132‚Üí                cooldown: 5000,
  1133‚Üí                icon: &#x27;üí•&#x27;,
  1134‚Üí              }),
  1135‚Üí              createAction(&#x27;melee&#x27;, &#x27;MELEE&#x27;, &#x27;KeyV&#x27;, {
  1136‚Üí                variant: &#x27;primary&#x27;,
  1137‚Üí                icon: &#x27;üî™&#x27;,
  1138‚Üí              }),
  1139‚Üí            ],
  1140‚Üí          },
  1141‚Üí        ];
  1142‚Üí        break;
  1143‚Üí    }
  1144‚Üí
  1145‚Üí    // Send action button configuration to the HUD
  1146‚Üí    this.callbacks.onActionGroupsChange(groups);
  1147‚Üí  }
  1148‚Üí
  1149‚Üí  private switchToPoweredDescent(): void {
  1150‚Üí    // Hide freefall view
  1151‚Üí    this.setFreefallVisible(false);
  1152‚Üí
  1153‚Üí    // Show powered descent view
  1154‚Üí    this.setPoweredDescentVisible(true);
  1155‚Üí
  1156‚Üí    // Smooth camera rotation transition over ~1 second
  1157‚Üí    // Store the starting rotation
  1158‚Üí    const startRotX = this.camera.rotation.x;
  1159‚Üí    const targetRotX = 0.3; // Slight downward angle
  1160‚Üí
  1161‚Üí    // Create camera rotation animation
  1162‚Üí    const rotationAnim = new Animation(
  1163‚Üí      &#x27;cameraRotationTransition&#x27;,
  1164‚Üí      &#x27;rotation.x&#x27;,
  1165‚Üí      60, // 60 fps
  1166‚Üí      Animation.ANIMATIONTYPE_FLOAT,
  1167‚Üí      Animation.ANIMATIONLOOPMODE_CONSTANT
  1168‚Üí    );
  1169‚Üí
  1170‚Üí    // Create easing function for smooth transition
  1171‚Üí    const easingFunction = new CubicEase();
  1172‚Üí    easingFunction.setEasingMode(EasingFunction.EASINGMODE_EASEOUT);
  1173‚Üí    rotationAnim.setEasingFunction(easingFunction);
  1174‚Üí
  1175‚Üí    // Define keyframes (60 frames = 1 second)
  1176‚Üí    rotationAnim.setKeys([
  1177‚Üí      { frame: 0, value: startRotX },
  1178‚Üí      { frame: 60, value: targetRotX },
  1179‚Üí    ]);
  1180‚Üí
  1181‚Üí    // Apply animation
  1182‚Üí    this.camera.animations = [rotationAnim];
  1183‚Üí    this.scene.beginAnimation(this.camera, 0, 60, false, 1, () =&gt; {
  1184‚Üí      // Animation complete - ensure final values are set
  1185‚Üí      this.camera.rotation.x = targetRotX;
  1186‚Üí      this.rotationX = targetRotX;
  1187‚Üí    });
  1188‚Üí
  1189‚Üí    // Set Y rotation immediately (no transition needed)
  1190‚Üí    this.rotationY = 0;
  1191‚Üí    this.camera.rotation.y = 0;
  1192‚Üí
  1193‚Üí    // Show LZ
  1194‚Üí    if (this.lzPad) this.lzPad.isVisible = true;
  1195‚Üí    if (this.lzBeacon) this.lzBeacon.isVisible = true;
  1196‚Üí
  1197‚Üí    // Show terrain in distance
  1198‚Üí    if (this.terrain) this.terrain.isVisible = true;
  1199‚Üí
  1200‚Üí    // Update background
  1201‚Üí    this.scene.clearColor = new Color4(0.5, 0.3, 0.2, 1);
  1202‚Üí  }
  1203‚Üí
  1204‚Üí  private spawnAsteroid(): void {
  1205‚Üí    if (this.asteroids.length &gt;= 60 || this.phase !== &#x27;freefall_belt&#x27;) return;
  1206‚Üí
  1207‚Üí    const size = 0.8 + Math.random() * 2.5;
  1208‚Üí    const asteroid = MeshBuilder.CreatePolyhedron(
  1209‚Üí      `ast_${this.asteroidsSpawned++}`,
  1210‚Üí      { type: Math.floor(Math.random() * 4), size },
  1211‚Üí      this.scene
  1212‚Üí    );
  1213‚Üí
  1214‚Üí    const mat = new StandardMaterial(`astMat_${this.asteroidsSpawned}`, this.scene);
  1215‚Üí    mat.diffuseColor = new Color3(
  1216‚Üí      0.25 + Math.random() * 0.2,
  1217‚Üí      0.2 + Math.random() * 0.15,
  1218‚Üí      0.15 + Math.random() * 0.1
  1219‚Üí    );
  1220‚Üí    asteroid.material = mat;
  1221‚Üí
  1222‚Üí    asteroid.position.set(
  1223‚Üí      (Math.random() - 0.5) * 50,
  1224‚Üí      -120 - Math.random() * 40,
  1225‚Üí      (Math.random() - 0.5) * 50
  1226‚Üí    );
  1227‚Üí
  1228‚Üí    this.asteroids.push({
  1229‚Üí      mesh: asteroid,
  1230‚Üí      velocity: new Vector3(
  1231‚Üí        (Math.random() - 0.5) * 8,
  1232‚Üí        35 + Math.random() * 25,
  1233‚Üí        (Math.random() - 0.5) * 8
  1234‚Üí      ),
  1235‚Üí      rotationSpeed: new Vector3(Math.random() * 3, Math.random() * 3, Math.random() * 3),
  1236‚Üí      passed: false,
  1237‚Üí    });
  1238‚Üí  }
  1239‚Üí
  1240‚Üí  private updateAsteroids(deltaTime: number): void {
  1241‚Üí    for (let i = this.asteroids.length - 1; i &gt;= 0; i--) {
  1242‚Üí      const ast = this.asteroids[i];
  1243‚Üí
  1244‚Üí      ast.mesh.position.addInPlace(ast.velocity.scale(deltaTime));
  1245‚Üí      ast.mesh.rotation.addInPlace(ast.rotationSpeed.scale(deltaTime));
  1246‚Üí
  1247‚Üí      // Collision check
  1248‚Üí      const dist = Math.sqrt(ast.mesh.position.x ** 2 + ast.mesh.position.z ** 2);
  1249‚Üí      const inZone = ast.mesh.position.y &gt; -6 &amp;&amp; ast.mesh.position.y &lt; 6;
  1250‚Üí
  1251‚Üí      if (inZone &amp;&amp; dist &lt; 3.5 &amp;&amp; !ast.passed) {
  1252‚Üí        this.onAsteroidHit(ast);
  1253‚Üí        ast.passed = true;
  1254‚Üí      }
  1255‚Üí
  1256‚Üí      if (ast.mesh.position.y &gt; 15 &amp;&amp; !ast.passed) {
  1257‚Üí        ast.passed = true;
  1258‚Üí        this.asteroidsDodged++;
  1259‚Üí      }
  1260‚Üí
  1261‚Üí      if (ast.mesh.position.y &gt; 60) {
  1262‚Üí        ast.mesh.dispose();
  1263‚Üí        this.asteroids.splice(i, 1);
  1264‚Üí      }
  1265‚Üí    }
  1266‚Üí  }
  1267‚Üí
  1268‚Üí  private onAsteroidHit(asteroid: Asteroid): void {
  1269‚Üí    // Don&#x27;t process hits if already dead
  1270‚Üí    if (this.suitIntegrity &lt;= 0) return;
  1271‚Üí
  1272‚Üí    this.asteroidsHit++;
  1273‚Üí    // Clamp suit integrity to minimum 0
  1274‚Üí    this.suitIntegrity = Math.max(0, this.suitIntegrity - 12);
  1275‚Üí    this.triggerShake(6);
  1276‚Üí    this.callbacks.onDamage();
  1277‚Üí    this.callbacks.onHealthChange(this.suitIntegrity);
  1278‚Üí
  1279‚Üí    if (this.suitIntegrity &lt;= 0) {
  1280‚Üí      this.callbacks.onNotification(&#x27;SUIT BREACH - CRITICAL&#x27;, 3000);
  1281‚Üí    } else {
  1282‚Üí      this.callbacks.onNotification(&#x27;IMPACT&#x27;, 800);
  1283‚Üí    }
  1284‚Üí
  1285‚Üí    asteroid.mesh.scaling.setAll(0.1);
  1286‚Üí    setTimeout(() =&gt; asteroid.mesh.dispose(), 50);
  1287‚Üí  }
  1288‚Üí
  1289‚Üí  protected override processMovement(deltaTime: number): void {
  1290‚Üí    if (this.phase === &#x27;freefall_belt&#x27; || this.phase === &#x27;freefall_start&#x27;) {
  1291‚Üí      // Freefall body steering - use InputTracker for configurable keybindings
  1292‚Üí      if (this.inputTracker.isActionActive(&#x27;moveLeft&#x27;)) this.lateralVelocityX -= 40 * deltaTime;
  1293‚Üí      if (this.inputTracker.isActionActive(&#x27;moveRight&#x27;)) this.lateralVelocityX += 40 * deltaTime;
  1294‚Üí      if (this.inputTracker.isActionActive(&#x27;moveForward&#x27;)) this.lateralVelocityZ += 40 * deltaTime;
  1295‚Üí      if (this.inputTracker.isActionActive(&#x27;moveBackward&#x27;)) this.lateralVelocityZ -= 40 * deltaTime;
  1296‚Üí
  1297‚Üí      this.lateralVelocityX *= 0.95;
  1298‚Üí      this.lateralVelocityZ *= 0.95;
  1299‚Üí    } else if (this.phase === &#x27;powered_descent&#x27;) {
  1300‚Üí      // Powered descent steering - use InputTracker for configurable keybindings
  1301‚Üí      if (this.inputTracker.isActionActive(&#x27;moveLeft&#x27;)) this.lateralVelocityX -= 20 * deltaTime;
  1302‚Üí      if (this.inputTracker.isActionActive(&#x27;moveRight&#x27;)) this.lateralVelocityX += 20 * deltaTime;
  1303‚Üí      if (this.inputTracker.isActionActive(&#x27;moveForward&#x27;)) this.lateralVelocityZ += 20 * deltaTime;
  1304‚Üí      if (this.inputTracker.isActionActive(&#x27;moveBackward&#x27;)) this.lateralVelocityZ -= 20 * deltaTime;
  1305‚Üí
  1306‚Üí      // Boost (fire action - typically Space/Mouse0)
  1307‚Üí      if (this.inputTracker.isActionActive(&#x27;fire&#x27;) &amp;&amp; this.fuel &gt; 0) {
  1308‚Üí        this.velocity = Math.max(5, this.velocity - 60 * deltaTime);
  1309‚Üí        this.fuel = Math.max(0, this.fuel - this.fuelBurnRate * deltaTime);
  1310‚Üí        this.showThrusterGlow(0.8);
  1311‚Üí      } else {
  1312‚Üí        this.showThrusterGlow(0.2);
  1313‚Üí      }
  1314‚Üí
  1315‚Üí      // Stabilize (reload action - typically R, or check raw key)
  1316‚Üí      if (this.inputTracker.isActionActive(&#x27;reload&#x27;) &amp;&amp; this.fuel &gt; 0) {
  1317‚Üí        this.lateralVelocityX *= 0.9;
  1318‚Üí        this.lateralVelocityZ *= 0.9;
  1319‚Üí        this.fuel = Math.max(0, this.fuel - 2 * deltaTime);
  1320‚Üí      }
  1321‚Üí
  1322‚Üí      this.lateralVelocityX *= 0.98;
  1323‚Üí      this.lateralVelocityZ *= 0.98;
  1324‚Üí    }
  1325‚Üí
  1326‚Üí    // Update position
  1327‚Üí    this.positionX += this.lateralVelocityX * deltaTime;
  1328‚Üí    this.positionZ += this.lateralVelocityZ * deltaTime;
  1329‚Üí  }
  1330‚Üí
  1331‚Üí  protected updateLevel(deltaTime: number): void {
  1332‚Üí    this.phaseTime += deltaTime;
  1333‚Üí
  1334‚Üí    // Smooth FOV interpolation for cinematic transitions
  1335‚Üí    if (Math.abs(this.currentFOV - this.targetFOV) &gt; 0.01) {
  1336‚Üí      const fovLerpSpeed = 2.0; // Adjust for smooth transition speed
  1337‚Üí      this.currentFOV += (this.targetFOV - this.currentFOV) * fovLerpSpeed * deltaTime;
  1338‚Üí      this.camera.fov = this.currentFOV;
  1339‚Üí    }
  1340‚Üí
  1341‚Üí    // Gravity / descent
  1342‚Üí    if (this.phase !== &#x27;surface&#x27;) {
  1343‚Üí      if (this.phase === &#x27;powered_descent&#x27; || this.phase === &#x27;landing&#x27;) {
  1344‚Üí        // Gravity pulls down, jets counter
  1345‚Üí        this.velocity = Math.min(100, this.velocity + 15 * deltaTime);
  1346‚Üí      } else {
  1347‚Üí        // Freefall acceleration
  1348‚Üí        this.velocity = Math.min(80, this.velocity + 8 * deltaTime);
  1349‚Üí      }
  1350‚Üí
  1351‚Üí      this.altitude -= this.velocity * deltaTime;
  1352‚Üí
  1353‚Üí      // Fuel passive regen (tiny)
  1354‚Üí      if (this.phase === &#x27;powered_descent&#x27;) {
  1355‚Üí        this.fuel = Math.min(this.maxFuel, this.fuel + this.fuelRegenRate * deltaTime * 0.1);
  1356‚Üí      }
  1357‚Üí    } else {
  1358‚Üí      // On surface - enforce ground collision and terrain bounds
  1359‚Üí      this.enforceTerrainConstraints();
  1360‚Üí    }
  1361‚Üí
  1362‚Üí    // Update planet visual
  1363‚Üí    if (this.planet &amp;&amp; this.phase !== &#x27;surface&#x27; &amp;&amp; this.phase !== &#x27;powered_descent&#x27;) {
  1364‚Üí      const scale = Math.max(1, (1000 - this.altitude) / 40 + 1);
  1365‚Üí      this.planet.scaling.setAll(scale);
  1366‚Üí      this.planet.position.y = -150 + (1000 - this.altitude) * 0.12;
  1367‚Üí      this.planet.position.x = -this.positionX * 0.1;
  1368‚Üí      this.planet.position.z = -this.positionZ * 0.1;
  1369‚Üí      if (this.planetAtmosphere) {
  1370‚Üí        this.planetAtmosphere.scaling.setAll(scale * 1.08);
  1371‚Üí        this.planetAtmosphere.position.copyFrom(this.planet.position);
  1372‚Üí      }
  1373‚Üí    }
  1374‚Üí
  1375‚Üí    // Update Anchor Station (visible above during freefall)
  1376‚Üí    this.updateAnchorStation(deltaTime);
  1377‚Üí
  1378‚Üí    // Update LZ position indicator during powered descent
  1379‚Üí    if (this.phase === &#x27;powered_descent&#x27; || this.phase === &#x27;landing&#x27;) {
  1380‚Üí      // LZ stays at origin, we&#x27;re drifting relative to it
  1381‚Üí      const distToLZ = Math.sqrt(this.positionX ** 2 + this.positionZ ** 2);
  1382‚Üí
  1383‚Üí      // Visual feedback on LZ beacon
  1384‚Üí      if (this.lzBeacon?.material) {
  1385‚Üí        const mat = this.lzBeacon.material as StandardMaterial;
  1386‚Üí        if (distToLZ &lt; this.lzRadius) {
  1387‚Üí          mat.emissiveColor = new Color3(0.2, 1, 0.3); // Green - on target
  1388‚Üí        } else if (distToLZ &lt; this.nearMissRadius) {
  1389‚Üí          mat.emissiveColor = new Color3(1, 1, 0.2); // Yellow - close
  1390‚Üí        } else {
  1391‚Üí          mat.emissiveColor = new Color3(1, 0.3, 0.2); // Red - off target
  1392‚Üí        }
  1393‚Üí      }
  1394‚Üí
  1395‚Üí      // Check for slingshot (too far off course)
  1396‚Üí      if (distToLZ &gt; this.maxDrift) {
  1397‚Üí        this.landingOutcome = &#x27;slingshot&#x27;;
  1398‚Üí        this.callbacks.onNotification(&#x27;‚ö†Ô∏è TRAJECTORY LOST&#x27;, 2000);
  1399‚Üí      }
  1400‚Üí    }
  1401‚Üí
  1402‚Üí    // Phase transitions
  1403‚Üí    switch (this.phase) {
  1404‚Üí      case &#x27;freefall_start&#x27;:
  1405‚Üí        if (this.phaseTime &gt; 3) {
  1406‚Üí          this.transitionToPhase(&#x27;freefall_belt&#x27;);
  1407‚Üí        }
  1408‚Üí        break;
  1409‚Üí
  1410‚Üí      case &#x27;freefall_belt&#x27;:
  1411‚Üí        this.asteroidSpawnTimer += deltaTime;
  1412‚Üí        if (this.asteroidSpawnTimer &gt; this.asteroidSpawnRate) {
  1413‚Üí          this.spawnAsteroid();
  1414‚Üí          this.asteroidSpawnTimer = 0;
  1415‚Üí          this.asteroidSpawnRate = Math.max(0.12, this.asteroidSpawnRate - 0.005);
  1416‚Üí        }
  1417‚Üí        this.updateAsteroids(deltaTime);
  1418‚Üí
  1419‚Üí        // Spawn distant threats at altitude 900 (visual storytelling)
  1420‚Üí        if (this.altitude &lt; 900 &amp;&amp; !this.threatsSpawned) {
  1421‚Üí          this.spawnDistantThreats();
  1422‚Üí        }
  1423‚Üí
  1424‚Üí        // Update distant threats
  1425‚Üí        if (this.distantThreats.length &gt; 0) {
  1426‚Üí          this.updateDistantThreats(deltaTime);
  1427‚Üí        }
  1428‚Üí
  1429‚Üí        // Clear debris field at altitude 650
  1430‚Üí        if (this.altitude &lt; 650) {
  1431‚Üí          this.transitionToPhase(&#x27;freefall_clear&#x27;);
  1432‚Üí        }
  1433‚Üí        break;
  1434‚Üí
  1435‚Üí      case &#x27;freefall_clear&#x27;:
  1436‚Üí        this.updateAsteroids(deltaTime);
  1437‚Üí        // Update distant threats
  1438‚Üí        if (this.distantThreats.length &gt; 0) {
  1439‚Üí          this.updateDistantThreats(deltaTime);
  1440‚Üí        }
  1441‚Üí        // Player must hit &quot;Ignite Jets&quot; - if they wait too long...
  1442‚Üí        if (this.altitude &lt; 200 &amp;&amp; this.phase === &#x27;freefall_clear&#x27;) {
  1443‚Üí          this.callbacks.onNotification(&#x27;‚ö†Ô∏è IGNITE JETS NOW!&#x27;, 1000);
  1444‚Üí        }
  1445‚Üí        if (this.altitude &lt; 50 &amp;&amp; this.phase === &#x27;freefall_clear&#x27;) {
  1446‚Üí          // Forced crash - didn&#x27;t ignite in time
  1447‚Üí          this.landingOutcome = &#x27;crash&#x27;;
  1448‚Üí          this.transitionToPhase(&#x27;surface&#x27;);
  1449‚Üí        }
  1450‚Üí        break;
  1451‚Üí
  1452‚Üí      case &#x27;powered_descent&#x27;:
  1453‚Üí        // Transition to landing at low altitude
  1454‚Üí        if (this.altitude &lt; 80) {
  1455‚Üí          this.transitionToPhase(&#x27;landing&#x27;);
  1456‚Üí        }
  1457‚Üí        break;
  1458‚Üí
  1459‚Üí      case &#x27;landing&#x27;:
  1460‚Üí        if (this.altitude &lt;= 0) {
  1461‚Üí          this.altitude = 0;
  1462‚Üí          this.determineLandingOutcome();
  1463‚Üí          this.transitionToPhase(&#x27;surface&#x27;);
  1464‚Üí        }
  1465‚Üí        break;
  1466‚Üí    }
  1467‚Üí
  1468‚Üí    // HUD update
  1469‚Üí    if (this.phase !== &#x27;surface&#x27;) {
  1470‚Üí      const altStr = Math.max(0, this.altitude).toFixed(0);
  1471‚Üí      const velStr = this.velocity.toFixed(0);
  1472‚Üí
  1473‚Üí      if (this.phase === &#x27;powered_descent&#x27; || this.phase === &#x27;landing&#x27;) {
  1474‚Üí        const fuelStr = this.fuel.toFixed(0);
  1475‚Üí        const distToLZ = Math.sqrt(this.positionX ** 2 + this.positionZ ** 2).toFixed(0);
  1476‚Üí        this.callbacks.onObjectiveUpdate(
  1477‚Üí          &#x27;TARGET LZ&#x27;,
  1478‚Üí          `ALT: ${altStr} | VEL: ${velStr} | FUEL: ${fuelStr}% | LZ: ${distToLZ}m`
  1479‚Üí        );
  1480‚Üí      } else {
  1481‚Üí        this.callbacks.onObjectiveUpdate(
  1482‚Üí          this.phase === &#x27;freefall_belt&#x27; ? &#x27;NAVIGATE DEBRIS&#x27; : &#x27;FREEFALL&#x27;,
  1483‚Üí          `ALT: ${altStr} | VEL: ${velStr} m/s | SUIT: ${this.suitIntegrity}%`
  1484‚Üí        );
  1485‚Üí      }
  1486‚Üí    }
  1487‚Üí  }
  1488‚Üí
  1489‚Üí  private determineLandingOutcome(): void {
  1490‚Üí    const distToLZ = Math.sqrt(this.positionX ** 2 + this.positionZ ** 2);
  1491‚Üí
  1492‚Üí    if (this.velocity &gt; 60) {
  1493‚Üí      this.landingOutcome = &#x27;crash&#x27;;
  1494‚Üí    } else if (distToLZ &lt;= this.lzRadius &amp;&amp; this.velocity &lt; 25) {
  1495‚Üí      this.landingOutcome = &#x27;perfect&#x27;;
  1496‚Üí    } else if (distToLZ &lt;= this.nearMissRadius) {
  1497‚Üí      this.landingOutcome = this.velocity &lt; 40 ? &#x27;near_miss&#x27; : &#x27;rough&#x27;;
  1498‚Üí    } else if (distToLZ &gt; this.maxDrift) {
  1499‚Üí      this.landingOutcome = &#x27;slingshot&#x27;;
  1500‚Üí    } else {
  1501‚Üí      this.landingOutcome = &#x27;rough&#x27;;
  1502‚Üí    }
  1503‚Üí  }
  1504‚Üí
  1505‚Üí  private completeLanding(): void {
  1506‚Üí    this.setBaseShake(0);
  1507‚Üí    this.callbacks.onCinematicEnd?.();
  1508‚Üí
  1509‚Üí    // Clear action buttons
  1510‚Üí    this.updateActionButtons(&#x27;none&#x27;);
  1511‚Üí
  1512‚Üí    switch (this.landingOutcome) {
  1513‚Üí      case &#x27;perfect&#x27;:
  1514‚Üí        this.triggerShake(2);
  1515‚Üí        this.callbacks.onNotification(&#x27;üéØ PERFECT LANDING&#x27;, 3000);
  1516‚Üí        setTimeout(() =&gt; {
  1517‚Üí          this.callbacks.onCommsMessage({
  1518‚Üí            sender: &#x27;PROMETHEUS A.I.&#x27;,
  1519‚Üí            callsign: &#x27;ATHENA&#x27;,
  1520‚Üí            portrait: &#x27;ai&#x27;,
  1521‚Üí            text: `Touchdown on LZ pad. ${this.asteroidsDodged} debris dodged. Exemplary, Sergeant.`,
  1522‚Üí          });
  1523‚Üí        }, 2000);
  1524‚Üí        this.transitionToSurface(false);
  1525‚Üí        break;
  1526‚Üí
  1527‚Üí      case &#x27;near_miss&#x27;:
  1528‚Üí        this.triggerShake(4);
  1529‚Üí        this.callbacks.onNotification(&#x27;‚ö†Ô∏è NEAR MISS - HOSTILES INBOUND&#x27;, 3000);
  1530‚Üí        setTimeout(() =&gt; {
  1531‚Üí          this.callbacks.onCommsMessage({
  1532‚Üí            sender: &#x27;PROMETHEUS A.I.&#x27;,
  1533‚Üí            callsign: &#x27;ATHENA&#x27;,
  1534‚Üí            portrait: &#x27;ai&#x27;,
  1535‚Üí            text: &#x27;Landed outside LZ perimeter. Movement detected. Fight to the pad!&#x27;,
  1536‚Üí          });
  1537‚Üí        }, 2000);
  1538‚Üí        this.transitionToSurface(true); // Combat on way to LZ
  1539‚Üí        break;
  1540‚Üí
  1541‚Üí      case &#x27;rough&#x27;:
  1542‚Üí        this.triggerShake(6);
  1543‚Üí        // Clamp suit integrity to minimum 0
  1544‚Üí        this.suitIntegrity = Math.max(0, this.suitIntegrity - 25);
  1545‚Üí        this.callbacks.onHealthChange(this.suitIntegrity);
  1546‚Üí        this.callbacks.onNotification(&#x27;ROUGH LANDING - DAMAGE TAKEN&#x27;, 3000);
  1547‚Üí        setTimeout(() =&gt; {
  1548‚Üí          this.callbacks.onCommsMessage({
  1549‚Üí            sender: &#x27;PROMETHEUS A.I.&#x27;,
  1550‚Üí            callsign: &#x27;ATHENA&#x27;,
  1551‚Üí            portrait: &#x27;ai&#x27;,
  1552‚Üí            text: `Hard touchdown. Suit integrity compromised. Multiple hostiles converging.`,
  1553‚Üí          });
  1554‚Üí        }, 2000);
  1555‚Üí        this.transitionToSurface(true);
  1556‚Üí        break;
  1557‚Üí
  1558‚Üí      case &#x27;crash&#x27;:
  1559‚Üí        this.triggerShake(10);
  1560‚Üí        this.suitIntegrity = Math.max(10, this.suitIntegrity - 50);
  1561‚Üí        this.callbacks.onHealthChange(this.suitIntegrity);
  1562‚Üí        this.callbacks.onNotification(&#x27;üíÄ CRASH LANDING&#x27;, 3000);
  1563‚Üí        setTimeout(() =&gt; {
  1564‚Üí          this.callbacks.onCommsMessage({
  1565‚Üí            sender: &#x27;PROMETHEUS A.I.&#x27;,
  1566‚Üí            callsign: &#x27;ATHENA&#x27;,
  1567‚Üí            portrait: &#x27;ai&#x27;,
  1568‚Üí            text: &#x27;Critical impact. Medical nanites deployed. You need to move, Sergeant.&#x27;,
  1569‚Üí          });
  1570‚Üí        }, 2000);
  1571‚Üí        this.transitionToSurface(true);
  1572‚Üí        break;
  1573‚Üí
  1574‚Üí      case &#x27;slingshot&#x27;:
  1575‚Üí        this.callbacks.onNotification(&#x27;üíÄ TRAJECTORY LOST - KIA&#x27;, 3000);
  1576‚Üí        setTimeout(() =&gt; {
  1577‚Üí          this.callbacks.onCommsMessage({
  1578‚Üí            sender: &#x27;Commander Vasquez&#x27;,
  1579‚Üí            callsign: &#x27;PROMETHEUS ACTUAL&#x27;,
  1580‚Üí            portrait: &#x27;commander&#x27;,
  1581‚Üí            text: &quot;Specter, we&#x27;ve lost your signal. Specter, respond... Damn it.&quot;,
  1582‚Üí          });
  1583‚Üí        }, 2000);
  1584‚Üí        // Game over - would restart level
  1585‚Üí        break;
  1586‚Üí    }
  1587‚Üí  }
  1588‚Üí
  1589‚Üí  /**
  1590‚Üí   * Enforces terrain constraints to prevent player from falling through ground
  1591‚Üí   * or wandering outside playable area. Called every frame on surface.
  1592‚Üí   */
  1593‚Üí  private enforceTerrainConstraints(): void {
  1594‚Üí    // Ensure player stays above terrain (ground collision)
  1595‚Üí    if (this.camera.position.y &lt; this.MIN_PLAYER_HEIGHT) {
  1596‚Üí      this.camera.position.y = this.MIN_PLAYER_HEIGHT;
  1597‚Üí    }
  1598‚Üí
  1599‚Üí    // Clamp player position to terrain bounds (prevent wandering off map)
  1600‚Üí    this.camera.position.x = Math.max(
  1601‚Üí      -this.TERRAIN_BOUNDS,
  1602‚Üí      Math.min(this.TERRAIN_BOUNDS, this.camera.position.x)
  1603‚Üí    );
  1604‚Üí    this.camera.position.z = Math.max(
  1605‚Üí      -this.TERRAIN_BOUNDS,
  1606‚Üí      Math.min(this.TERRAIN_BOUNDS, this.camera.position.z)
  1607‚Üí    );
  1608‚Üí  }
  1609‚Üí
  1610‚Üí  private transitionToSurface(combatRequired: boolean): void {
  1611‚Üí    // Unlock HALO drop achievement
  1612‚Üí    getAchievementManager().onHaloDropComplete();
  1613‚Üí
  1614‚Üí    // Hide descent elements
  1615‚Üí    this.setPoweredDescentVisible(false);
  1616‚Üí    if (this.planet) this.planet.isVisible = false;
  1617‚Üí    if (this.planetAtmosphere) this.planetAtmosphere.isVisible = false;
  1618‚Üí    if (this.starfield) this.starfield.isVisible = false;
  1619‚Üí    if (this.plasmaGlow) this.plasmaGlow.isVisible = false;
  1620‚Üí    if (this.lzBeacon) this.lzBeacon.isVisible = false;
  1621‚Üí
  1622‚Üí    // Clear asteroids
  1623‚Üí    this.asteroids.forEach((a) =&gt; a.mesh.dispose());
  1624‚Üí    this.asteroids = [];
  1625‚Üí
  1626‚Üí    // Dispose distant threats on landing
  1627‚Üí    for (const threat of this.distantThreats) {
  1628‚Üí      threat.node.dispose();
  1629‚Üí    }
  1630‚Üí    this.distantThreats = [];
  1631‚Üí
  1632‚Üí    // Show surface
  1633‚Üí    if (this.terrain) this.terrain.isVisible = true;
  1634‚Üí    if (this.skyDome) this.skyDome.isVisible = true;
  1635‚Üí    if (this.lzPad) this.lzPad.isVisible = true;
  1636‚Üí    this.canyonWalls.forEach((w) =&gt; (w.isVisible = true));
  1637‚Üí
  1638‚Üí    // Transition to standard FPS FOV for ground combat
  1639‚Üí    this.targetFOV = this.SURFACE_FOV;
  1640‚Üí
  1641‚Üí    // FPS camera - clamp position to valid terrain bounds
  1642‚Üí    const clampedX = Math.max(-this.TERRAIN_BOUNDS, Math.min(this.TERRAIN_BOUNDS, this.positionX));
  1643‚Üí    const clampedZ = Math.max(-this.TERRAIN_BOUNDS, Math.min(this.TERRAIN_BOUNDS, this.positionZ));
  1644‚Üí    this.camera.position.set(clampedX, this.MIN_PLAYER_HEIGHT, clampedZ);
  1645‚Üí    this.camera.rotation.set(0, Math.PI, 0);
  1646‚Üí    this.rotationX = 0;
  1647‚Üí    this.rotationY = Math.PI;
  1648‚Üí
  1649‚Üí    this.scene.clearColor = new Color4(0.75, 0.5, 0.35, 1);
  1650‚Üí
  1651‚Üí    if (combatRequired) {
  1652‚Üí      setTimeout(() =&gt; {
  1653‚Üí        this.callbacks.onObjectiveUpdate(
  1654‚Üí          &#x27;REACH THE LZ&#x27;,
  1655‚Üí          &#x27;Fight through hostiles to the landing pad.&#x27;
  1656‚Üí        );
  1657‚Üí        this.callbacks.onCombatStateChange(true);
  1658‚Üí        // Switch to combat action buttons
  1659‚Üí        this.updateActionButtons(&#x27;combat&#x27;);
  1660‚Üí      }, 3000);
  1661‚Üí    } else {
  1662‚Üí      setTimeout(() =&gt; {
  1663‚Üí        this.callbacks.onObjectiveUpdate(&#x27;PROCEED TO FOB DELTA&#x27;, &#x27;LZ secure. Move out.&#x27;);
  1664‚Üí        // Auto-complete after perfect landing
  1665‚Üí        setTimeout(() =&gt; this.completeLevel(), 5000);
  1666‚Üí      }, 3000);
  1667‚Üí    }
  1668‚Üí  }
  1669‚Üí
  1670‚Üí  override canTransitionTo(levelId: LevelId): boolean {
  1671‚Üí    return levelId === &#x27;fob_delta&#x27; &amp;&amp; this.phase === &#x27;surface&#x27;;
  1672‚Üí  }
  1673‚Üí
  1674‚Üí  protected disposeLevel(): void {
  1675‚Üí    // Unregister action handler
  1676‚Üí    this.callbacks.onActionHandlerRegister(null);
  1677‚Üí    this.callbacks.onActionGroupsChange([]);
  1678‚Üí
  1679‚Üí    this.planet?.dispose();
  1680‚Üí    this.planetAtmosphere?.dispose();
  1681‚Üí    this.starfield?.dispose();
  1682‚Üí    this.leftArm?.dispose();
  1683‚Üí    this.rightArm?.dispose();
  1684‚Üí    this.leftGlove?.dispose();
  1685‚Üí    this.rightGlove?.dispose();
  1686‚Üí    this.visorFrame?.dispose();
  1687‚Üí    this.leftHandle?.dispose();
  1688‚Üí    this.rightHandle?.dispose();
  1689‚Üí    this.thrusterGlow?.dispose();
  1690‚Üí    this.plasmaGlow?.dispose();
  1691‚Üí    this.lzPad?.dispose();
  1692‚Üí    this.lzBeacon?.dispose();
  1693‚Üí    this.terrain?.dispose();
  1694‚Üí    this.skyDome?.dispose();
  1695‚Üí    this.canyonWalls.forEach((w) =&gt; w.dispose());
  1696‚Üí    this.asteroids.forEach((a) =&gt; a.mesh.dispose());
  1697‚Üí
  1698‚Üí    // Dispose Anchor Station
  1699‚Üí    this.stationRing?.dispose();
  1700‚Üí    this.stationHub?.dispose();
  1701‚Üí    this.stationDropBay?.dispose();
  1702‚Üí    this.stationSolarPanels.forEach((p) =&gt; p.dispose());
  1703‚Üí    this.stationLights.forEach((l) =&gt; l.dispose());
  1704‚Üí    this.anchorStation?.dispose();
  1705‚Üí    this.stationSolarPanels = [];
  1706‚Üí    this.stationLights = [];
  1707‚Üí
  1708‚Üí    // Dispose distant threats
  1709‚Üí    for (const threat of this.distantThreats) {
  1710‚Üí      threat.node.dispose();
  1711‚Üí    }
  1712‚Üí    this.distantThreats = [];
  1713‚Üí  }
  1714‚Üí}
  1715‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-48-427Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-48-427Z" class="timestamp-link"><time datetime="2026-01-30T06:44:48.427Z" data-timestamp="2026-01-30T06:44:48.427Z">2026-01-30T06:44:48.427Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01E3judz1Vmz7yQsUQ8cyBnU"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/fob-delta/FOBDeltaLevel.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-48-584Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-48-584Z" class="timestamp-link"><time datetime="2026-01-30T06:44:48.584Z" data-timestamp="2026-01-30T06:44:48.584Z">2026-01-30T06:44:48.584Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * FOBDeltaLevel - Abandoned Military Base with Horror Atmosphere
     3‚Üí *
     4‚Üí * LEVEL 3: FOB DELTA
     5‚Üí * An abandoned forward operating base with a horror/investigation theme.
     6‚Üí * The player searches for clues about what happened to the garrison
     7‚Üí * and locates Marcus&#x27;s mech signature.
     8‚Üí *
     9‚Üí * AREAS:
    10‚Üí * 1. PERIMETER - Breached barriers, entry point
    11‚Üí * 2. COURTYARD - Central open area, overturned vehicles
    12‚Üí * 3. BARRACKS - Bunks, personal effects, bodies (horror)
    13‚Üí * 4. COMMAND CENTER - Terminals, mission logs
    14‚Üí * 5. VEHICLE BAY - Marcus&#x27;s mech signature detected
    15‚Üí * 6. UNDERGROUND ACCESS - Exit to The Breach
    16‚Üí *
    17‚Üí * ATMOSPHERE:
    18‚Üí * - Flickering lights
    19‚Üí * - Environmental storytelling
    20‚Üí * - Jump scares (carefully placed)
    21‚Üí * - Motion tracker mechanic introduction
    22‚Üí * - Increasing dread
    23‚Üí */
    24‚Üí
    25‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    26‚Üíimport { HemisphericLight } from &#x27;@babylonjs/core/Lights/hemisphericLight&#x27;;
    27‚Üíimport { PointLight } from &#x27;@babylonjs/core/Lights/pointLight&#x27;;
    28‚Üíimport { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    29‚Üíimport { Color3, Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    30‚Üíimport { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    31‚Üíimport type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    32‚Üíimport { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    33‚Üíimport { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    34‚Üíimport { getAchievementManager } from &#x27;../../achievements&#x27;;
    35‚Üíimport { fireWeapon, getWeaponActions, startReload } from &#x27;../../context/useWeaponActions&#x27;;
    36‚Üíimport { AssetManager, SPECIES_TO_ASSET } from &#x27;../../core/AssetManager&#x27;;
    37‚Üíimport { particleManager } from &#x27;../../effects/ParticleManager&#x27;;
    38‚Üíimport { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    39‚Üíimport { BaseLevel } from &#x27;../BaseLevel&#x27;;
    40‚Üíimport type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    41‚Üí
    42‚Üí// Map for ambush enemy types to GLB assets
    43‚Üíconst AMBUSH_ENEMY_SPECIES = &#x27;lurker&#x27;; // Maps to scout.glb - tall stalker type
    44‚Üíconst AMBUSH_ENEMY_SCALE = 0.6;
    45‚Üí
    46‚Üíimport &#x27;@babylonjs/core/Animations/animatable&#x27;;
    47‚Üí
    48‚Üí// Phase progression through the level
    49‚Üítype FOBPhase =
    50‚Üí  | &#x27;approach&#x27; // Initial approach to FOB
    51‚Üí  | &#x27;courtyard&#x27; // Exploring the central courtyard
    52‚Üí  | &#x27;investigation&#x27; // Searching barracks and command center
    53‚Üí  | &#x27;ambush&#x27; // Enemy ambush in vehicle bay
    54‚Üí  | &#x27;discovery&#x27; // Finding the underground access
    55‚Üí  | &#x27;exit&#x27;; // Ready to proceed to next level
    56‚Üí
    57‚Üí// Area definitions for trigger zones
    58‚Üíinterface AreaZone {
    59‚Üí  id: string;
    60‚Üí  name: string;
    61‚Üí  center: Vector3;
    62‚Üí  radius: number;
    63‚Üí  triggered: boolean;
    64‚Üí}
    65‚Üí
    66‚Üí// Flickering light definition
    67‚Üíinterface FlickerLight {
    68‚Üí  light: PointLight;
    69‚Üí  baseIntensity: number;
    70‚Üí  flickerSpeed: number;
    71‚Üí  flickerAmount: number;
    72‚Üí  timer: number;
    73‚Üí  isOff: boolean;
    74‚Üí  offDuration: number;
    75‚Üí  offTimer: number;
    76‚Üí}
    77‚Üí
    78‚Üíexport class FOBDeltaLevel extends BaseLevel {
    79‚Üí  // Phase management
    80‚Üí  private phase: FOBPhase = &#x27;approach&#x27;;
    81‚Üí  private phaseTime = 0;
    82‚Üí
    83‚Üí  // Environment containers
    84‚Üí  private fobRoot: TransformNode | null = null;
    85‚Üí  private allMeshes: Mesh[] = [];
    86‚Üí  private materials: Map&lt;string, StandardMaterial&gt; = new Map();
    87‚Üí
    88‚Üí  // Lighting
    89‚Üí  private flickerLights: FlickerLight[] = [];
    90‚Üí  private horrorAmbient: HemisphericLight | null = null;
    91‚Üí
    92‚Üí  // Area zones for phase triggers
    93‚Üí  private areaZones: AreaZone[] = [];
    94‚Üí
    95‚Üí  // Terminal interaction
    96‚Üí  private terminal: Mesh | null = null;
    97‚Üí  private terminalLight: PointLight | null = null;
    98‚Üí  private logsAccessed = false;
    99‚Üí
   100‚Üí  // Marcus&#x27;s mech
   101‚Üí  private mechMesh: Mesh | null = null;
   102‚Üí  private mechEyeLight: PointLight | null = null;
   103‚Üí
   104‚Üí  // Underground hatch
   105‚Üí  private undergroundHatch: Mesh | null = null;
   106‚Üí  private hatchOpen = false;
   107‚Üí
   108‚Üí  // Objective marker
   109‚Üí  private objectiveMarker: Mesh | null = null;
   110‚Üí  private currentObjective: Vector3 | null = null;
   111‚Üí
   112‚Üí  // Flashlight system
   113‚Üí  private flashlight: PointLight | null = null;
   114‚Üí  private flashlightOn = false;
   115‚Üí
   116‚Üí  // Enemy spawns for ambush
   117‚Üí  private ambushTriggered = false;
   118‚Üí  private enemyCount = 0;
   119‚Üí  private readonly maxEnemies = 5;
   120‚Üí  private enemies: Array&lt;{
   121‚Üí    mesh: Mesh | TransformNode;
   122‚Üí    health: number;
   123‚Üí    position: Vector3;
   124‚Üí    state: &#x27;idle&#x27; | &#x27;chase&#x27; | &#x27;attack&#x27;;
   125‚Üí    attackCooldown: number;
   126‚Üí  }&gt; = [];
   127‚Üí  private ambushEnemiesPreloaded = false;
   128‚Üí
   129‚Üí  // Stats tracking
   130‚Üí  private killCount = 0;
   131‚Üí
   132‚Üí  // Action button callback
   133‚Üí  private actionCallback: ((actionId: string) =&gt; void) | null = null;
   134‚Üí
   135‚Üí  // Blood decals for horror atmosphere
   136‚Üí  private bloodDecals: Mesh[] = [];
   137‚Üí
   138‚Üí  // Alien vehicle wrecks in courtyard
   139‚Üí  private alienVehicles: TransformNode[] = [];
   140‚Üí
   141‚Üí  // Comms messages delivered
   142‚Üí  private messageFlags: Set&lt;string&gt; = new Set();
   143‚Üí
   144‚Üí  // Combat state
   145‚Üí  private meleeCooldown = 0;
   146‚Üí  private primaryFireCooldown = 0;
   147‚Üí  private readonly MELEE_DAMAGE = 50;
   148‚Üí  private readonly MELEE_RANGE = 3;
   149‚Üí  private readonly MELEE_COOLDOWN = 800; // ms
   150‚Üí  private readonly PRIMARY_FIRE_DAMAGE = 25;
   151‚Üí  private readonly PRIMARY_FIRE_RANGE = 50;
   152‚Üí  private readonly PRIMARY_FIRE_COOLDOWN = 150; // ms
   153‚Üí
   154‚Üí  constructor(
   155‚Üí    engine: Engine,
   156‚Üí    canvas: HTMLCanvasElement,
   157‚Üí    config: LevelConfig,
   158‚Üí    callbacks: LevelCallbacks
   159‚Üí  ) {
   160‚Üí    super(engine, canvas, config, callbacks);
   161‚Üí  }
   162‚Üí
   163‚Üí  protected getBackgroundColor(): Color4 {
   164‚Üí    // Very dark, almost black - horror atmosphere
   165‚Üí    return new Color4(0.008, 0.008, 0.012, 1);
   166‚Üí  }
   167‚Üí
   168‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   169‚Üí    // Create root node
   170‚Üí    this.fobRoot = new TransformNode(&#x27;fobDelta&#x27;, this.scene);
   171‚Üí
   172‚Üí    // Initialize AssetManager with scene
   173‚Üí    AssetManager.init(this.scene);
   174‚Üí
   175‚Üí    // Initialize particle manager for combat effects
   176‚Üí    particleManager.init(this.scene);
   177‚Üí
   178‚Üí    // Create materials
   179‚Üí    this.createMaterials();
   180‚Üí
   181‚Üí    // Set up horror lighting
   182‚Üí    this.setupHorrorLighting();
   183‚Üí
   184‚Üí    // Build the FOB
   185‚Üí    this.createPerimeter();
   186‚Üí    this.createCourtyard();
   187‚Üí    this.createBarracks();
   188‚Üí    this.createCommandCenter();
   189‚Üí    this.createVehicleBay();
   190‚Üí    this.createUndergroundAccess();
   191‚Üí
   192‚Üí    // Add blood decals
   193‚Üí    this.createBloodDecals();
   194‚Üí
   195‚Üí    // Load and place crashed alien vehicles
   196‚Üí    await this.createAlienVehicleWrecks();
   197‚Üí
   198‚Üí    // Preload ambush enemy GLB models
   199‚Üí    await this.preloadAmbushEnemyModels();
   200‚Üí
   201‚Üí    // Create objective marker
   202‚Üí    this.createObjectiveMarker();
   203‚Üí
   204‚Üí    // Create player flashlight
   205‚Üí    this.createFlashlight();
   206‚Üí
   207‚Üí    // Setup area zones
   208‚Üí    this.setupAreaZones();
   209‚Üí
   210‚Üí    // Start the level
   211‚Üí    this.startLevel();
   212‚Üí  }
   213‚Üí
   214‚Üí  private createMaterials(): void {
   215‚Üí    // Concrete/cement - base walls and floors
   216‚Üí    const concrete = new StandardMaterial(&#x27;concrete&#x27;, this.scene);
   217‚Üí    concrete.diffuseColor = Color3.FromHexString(&#x27;#3A3A3A&#x27;);
   218‚Üí    concrete.specularColor = new Color3(0.1, 0.1, 0.1);
   219‚Üí    this.materials.set(&#x27;concrete&#x27;, concrete);
   220‚Üí
   221‚Üí    // Military prefab - olive drab
   222‚Üí    const military = new StandardMaterial(&#x27;military&#x27;, this.scene);
   223‚Üí    military.diffuseColor = Color3.FromHexString(&#x27;#4A4A32&#x27;);
   224‚Üí    military.specularColor = new Color3(0.15, 0.15, 0.1);
   225‚Üí    this.materials.set(&#x27;military&#x27;, military);
   226‚Üí
   227‚Üí    // Metal - darker industrial
   228‚Üí    const metal = new StandardMaterial(&#x27;metal&#x27;, this.scene);
   229‚Üí    metal.diffuseColor = Color3.FromHexString(&#x27;#2A2A2A&#x27;);
   230‚Üí    metal.specularColor = new Color3(0.3, 0.3, 0.3);
   231‚Üí    this.materials.set(&#x27;metal&#x27;, metal);
   232‚Üí
   233‚Üí    // Damaged metal - rusted
   234‚Üí    const damaged = new StandardMaterial(&#x27;damaged&#x27;, this.scene);
   235‚Üí    damaged.diffuseColor = Color3.FromHexString(&#x27;#4A3228&#x27;);
   236‚Üí    damaged.specularColor = new Color3(0.1, 0.08, 0.06);
   237‚Üí    this.materials.set(&#x27;damaged&#x27;, damaged);
   238‚Üí
   239‚Üí    // Blood - red decals
   240‚Üí    const blood = new StandardMaterial(&#x27;blood&#x27;, this.scene);
   241‚Üí    blood.diffuseColor = Color3.FromHexString(&#x27;#3A0808&#x27;);
   242‚Üí    blood.specularColor = new Color3(0.4, 0.1, 0.1);
   243‚Üí    this.materials.set(&#x27;blood&#x27;, blood);
   244‚Üí
   245‚Üí    // Terminal screen - glowing
   246‚Üí    const terminal = new StandardMaterial(&#x27;terminal&#x27;, this.scene);
   247‚Üí    terminal.diffuseColor = Color3.FromHexString(&#x27;#001A00&#x27;);
   248‚Üí    terminal.emissiveColor = Color3.FromHexString(&#x27;#00FF44&#x27;);
   249‚Üí    terminal.specularColor = new Color3(0.5, 0.5, 0.5);
   250‚Üí    this.materials.set(&#x27;terminal&#x27;, terminal);
   251‚Üí
   252‚Üí    // Mech - Marcus&#x27;s damaged Titan
   253‚Üí    const mech = new StandardMaterial(&#x27;mech&#x27;, this.scene);
   254‚Üí    mech.diffuseColor = Color3.FromHexString(&#x27;#3A3A32&#x27;);
   255‚Üí    mech.specularColor = new Color3(0.2, 0.2, 0.2);
   256‚Üí    this.materials.set(&#x27;mech&#x27;, mech);
   257‚Üí
   258‚Üí    // Mech eyes - eerie glow
   259‚Üí    const mechEyes = new StandardMaterial(&#x27;mechEyes&#x27;, this.scene);
   260‚Üí    mechEyes.diffuseColor = Color3.FromHexString(&#x27;#220000&#x27;);
   261‚Üí    mechEyes.emissiveColor = Color3.FromHexString(&#x27;#FF2200&#x27;);
   262‚Üí    this.materials.set(&#x27;mechEyes&#x27;, mechEyes);
   263‚Üí
   264‚Üí    // Sandbag
   265‚Üí    const sandbag = new StandardMaterial(&#x27;sandbag&#x27;, this.scene);
   266‚Üí    sandbag.diffuseColor = Color3.FromHexString(&#x27;#6A5A4A&#x27;);
   267‚Üí    sandbag.specularColor = new Color3(0.05, 0.05, 0.05);
   268‚Üí    this.materials.set(&#x27;sandbag&#x27;, sandbag);
   269‚Üí
   270‚Üí    // Caution stripes
   271‚Üí    const caution = new StandardMaterial(&#x27;caution&#x27;, this.scene);
   272‚Üí    caution.diffuseColor = Color3.FromHexString(&#x27;#C4A000&#x27;);
   273‚Üí    caution.specularColor = new Color3(0.2, 0.2, 0.1);
   274‚Üí    this.materials.set(&#x27;caution&#x27;, caution);
   275‚Üí
   276‚Üí    // Hatch - underground access
   277‚Üí    const hatch = new StandardMaterial(&#x27;hatch&#x27;, this.scene);
   278‚Üí    hatch.diffuseColor = Color3.FromHexString(&#x27;#2A2A2A&#x27;);
   279‚Üí    hatch.specularColor = new Color3(0.4, 0.4, 0.4);
   280‚Üí    this.materials.set(&#x27;hatch&#x27;, hatch);
   281‚Üí
   282‚Üí    // Ground - rocky dirt
   283‚Üí    const ground = new StandardMaterial(&#x27;ground&#x27;, this.scene);
   284‚Üí    ground.diffuseColor = Color3.FromHexString(&#x27;#4A3A2A&#x27;);
   285‚Üí    ground.specularColor = new Color3(0.05, 0.05, 0.05);
   286‚Üí    this.materials.set(&#x27;ground&#x27;, ground);
   287‚Üí  }
   288‚Üí
   289‚Üí  private setupHorrorLighting(): void {
   290‚Üí    // Disable base level lights
   291‚Üí    if (this.sunLight) {
   292‚Üí      this.sunLight.intensity = 0;
   293‚Üí    }
   294‚Üí    if (this.ambientLight) {
   295‚Üí      this.ambientLight.intensity = 0;
   296‚Üí    }
   297‚Üí
   298‚Üí    // Very dark ambient - minimal visibility (horror atmosphere)
   299‚Üí    this.horrorAmbient = new HemisphericLight(&#x27;horrorAmbient&#x27;, new Vector3(0, 1, 0), this.scene);
   300‚Üí    this.horrorAmbient.intensity = 0.12;
   301‚Üí    this.horrorAmbient.diffuse = new Color3(0.2, 0.2, 0.25);
   302‚Üí    this.horrorAmbient.groundColor = new Color3(0.05, 0.05, 0.08);
   303‚Üí  }
   304‚Üí
   305‚Üí  private addFlickerLight(
   306‚Üí    position: Vector3,
   307‚Üí    color: Color3 = new Color3(1, 0.9, 0.7),
   308‚Üí    intensity: number = 0.6,
   309‚Üí    flickerAmount: number = 0.4,
   310‚Üí    flickerSpeed: number = 10
   311‚Üí  ): PointLight {
   312‚Üí    const light = new PointLight(`flicker_${this.flickerLights.length}`, position, this.scene);
   313‚Üí    light.diffuse = color;
   314‚Üí    light.intensity = intensity;
   315‚Üí    light.range = 15;
   316‚Üí
   317‚Üí    this.flickerLights.push({
   318‚Üí      light,
   319‚Üí      baseIntensity: intensity,
   320‚Üí      flickerSpeed,
   321‚Üí      flickerAmount,
   322‚Üí      timer: Math.random() * Math.PI * 2,
   323‚Üí      isOff: false,
   324‚Üí      offDuration: 0,
   325‚Üí      offTimer: 0,
   326‚Üí    });
   327‚Üí
   328‚Üí    return light;
   329‚Üí  }
   330‚Üí
   331‚Üí  private createPerimeter(): void {
   332‚Üí    // Ground plane
   333‚Üí    const ground = MeshBuilder.CreateGround(
   334‚Üí      &#x27;fobGround&#x27;,
   335‚Üí      { width: 200, height: 200, subdivisions: 32 },
   336‚Üí      this.scene
   337‚Üí    );
   338‚Üí    ground.material = this.materials.get(&#x27;ground&#x27;)!;
   339‚Üí    ground.parent = this.fobRoot;
   340‚Üí    this.allMeshes.push(ground);
   341‚Üí
   342‚Üí    // Perimeter walls (damaged)
   343‚Üí    const wallHeight = 4;
   344‚Üí    const wallThickness = 0.5;
   345‚Üí    const perimeterSize = 80;
   346‚Üí
   347‚Üí    // Create damaged perimeter walls with gaps
   348‚Üí    const wallSegments = [
   349‚Üí      // Front wall (with breach)
   350‚Üí      { start: -perimeterSize / 2, end: -10, z: -perimeterSize / 2, dir: &#x27;x&#x27; },
   351‚Üí      { start: 10, end: perimeterSize / 2, z: -perimeterSize / 2, dir: &#x27;x&#x27; },
   352‚Üí      // Left wall
   353‚Üí      { start: -perimeterSize / 2, end: perimeterSize / 2, x: -perimeterSize / 2, dir: &#x27;z&#x27; },
   354‚Üí      // Right wall
   355‚Üí      { start: -perimeterSize / 2, end: perimeterSize / 2, x: perimeterSize / 2, dir: &#x27;z&#x27; },
   356‚Üí      // Back wall
   357‚Üí      { start: -perimeterSize / 2, end: perimeterSize / 2, z: perimeterSize / 2, dir: &#x27;x&#x27; },
   358‚Üí    ];
   359‚Üí
   360‚Üí    for (let i = 0; i &lt; wallSegments.length; i++) {
   361‚Üí      const seg = wallSegments[i];
   362‚Üí      const length = seg.end - seg.start;
   363‚Üí
   364‚Üí      const wall = MeshBuilder.CreateBox(
   365‚Üí        `perimeterWall_${i}`,
   366‚Üí        {
   367‚Üí          width: seg.dir === &#x27;x&#x27; ? length : wallThickness,
   368‚Üí          height: wallHeight,
   369‚Üí          depth: seg.dir === &#x27;z&#x27; ? length : wallThickness,
   370‚Üí        },
   371‚Üí        this.scene
   372‚Üí      );
   373‚Üí
   374‚Üí      if (seg.dir === &#x27;x&#x27;) {
   375‚Üí        wall.position.set((seg.start + seg.end) / 2, wallHeight / 2, seg.z!);
   376‚Üí      } else {
   377‚Üí        wall.position.set(seg.x!, wallHeight / 2, (seg.start + seg.end) / 2);
   378‚Üí      }
   379‚Üí
   380‚Üí      wall.material = this.materials.get(&#x27;concrete&#x27;)!;
   381‚Üí      wall.parent = this.fobRoot;
   382‚Üí      this.allMeshes.push(wall);
   383‚Üí    }
   384‚Üí
   385‚Üí    // Breach debris at entry
   386‚Üí    for (let i = 0; i &lt; 8; i++) {
   387‚Üí      const debris = MeshBuilder.CreateBox(
   388‚Üí        `debris_${i}`,
   389‚Üí        {
   390‚Üí          width: 1 + Math.random() * 2,
   391‚Üí          height: 0.5 + Math.random() * 1.5,
   392‚Üí          depth: 1 + Math.random() * 2,
   393‚Üí        },
   394‚Üí        this.scene
   395‚Üí      );
   396‚Üí      debris.position.set(
   397‚Üí        -8 + Math.random() * 16,
   398‚Üí        debris.scaling.y / 2,
   399‚Üí        -perimeterSize / 2 + Math.random() * 8
   400‚Üí      );
   401‚Üí      debris.rotation.y = Math.random() * Math.PI;
   402‚Üí      debris.material = this.materials.get(&#x27;damaged&#x27;)!;
   403‚Üí      debris.parent = this.fobRoot;
   404‚Üí      this.allMeshes.push(debris);
   405‚Üí    }
   406‚Üí
   407‚Üí    // Sandbag barriers at entry (damaged)
   408‚Üí    for (let i = 0; i &lt; 4; i++) {
   409‚Üí      const sandbag = MeshBuilder.CreateBox(
   410‚Üí        `sandbag_${i}`,
   411‚Üí        { width: 3, height: 1, depth: 1 },
   412‚Üí        this.scene
   413‚Üí      );
   414‚Üí      const angle = (i / 4) * Math.PI - Math.PI / 2;
   415‚Üí      sandbag.position.set(
   416‚Üí        Math.sin(angle) * 12,
   417‚Üí        0.5,
   418‚Üí        -perimeterSize / 2 + 10 + Math.cos(angle) * 5
   419‚Üí      );
   420‚Üí      sandbag.rotation.y = angle + Math.random() * 0.5;
   421‚Üí      sandbag.material = this.materials.get(&#x27;sandbag&#x27;)!;
   422‚Üí      sandbag.parent = this.fobRoot;
   423‚Üí      this.allMeshes.push(sandbag);
   424‚Üí    }
   425‚Üí
   426‚Üí    // Entry light (flickering)
   427‚Üí    this.addFlickerLight(
   428‚Üí      new Vector3(0, 3.5, -perimeterSize / 2 + 5),
   429‚Üí      new Color3(1, 0.8, 0.6),
   430‚Üí      0.4,
   431‚Üí      0.6,
   432‚Üí      15
   433‚Üí    );
   434‚Üí  }
   435‚Üí
   436‚Üí  private createCourtyard(): void {
   437‚Üí    // Central open area with overturned vehicles and crates
   438‚Üí
   439‚Üí    // Overturned vehicle (simple box representation)
   440‚Üí    const vehicle = MeshBuilder.CreateBox(
   441‚Üí      &#x27;overturnedVehicle&#x27;,
   442‚Üí      { width: 3, height: 2, depth: 6 },
   443‚Üí      this.scene
   444‚Üí    );
   445‚Üí    vehicle.position.set(-8, 1.5, 0);
   446‚Üí    vehicle.rotation.z = Math.PI / 3; // Tipped over
   447‚Üí    vehicle.rotation.y = 0.3;
   448‚Üí    vehicle.material = this.materials.get(&#x27;military&#x27;)!;
   449‚Üí    vehicle.parent = this.fobRoot;
   450‚Üí    this.allMeshes.push(vehicle);
   451‚Üí
   452‚Üí    // Wheels (cylinders)
   453‚Üí    for (let i = 0; i &lt; 4; i++) {
   454‚Üí      const wheel = MeshBuilder.CreateCylinder(
   455‚Üí        `wheel_${i}`,
   456‚Üí        { height: 0.4, diameter: 0.8, tessellation: 12 },
   457‚Üí        this.scene
   458‚Üí      );
   459‚Üí      const xOff = i &lt; 2 ? -1.2 : 1.2;
   460‚Üí      const zOff = i % 2 === 0 ? -2 : 2;
   461‚Üí      wheel.position.set(-8 + xOff, 0.8 + xOff * 0.5, zOff);
   462‚Üí      wheel.rotation.z = Math.PI / 2;
   463‚Üí      wheel.material = this.materials.get(&#x27;metal&#x27;)!;
   464‚Üí      wheel.parent = this.fobRoot;
   465‚Üí      this.allMeshes.push(wheel);
   466‚Üí    }
   467‚Üí
   468‚Üí    // Scattered crates
   469‚Üí    const cratePositions = [
   470‚Üí      new Vector3(5, 0.5, -5),
   471‚Üí      new Vector3(7, 0.5, -3),
   472‚Üí      new Vector3(5, 1.5, -4),
   473‚Üí      new Vector3(-3, 0.5, 8),
   474‚Üí      new Vector3(-5, 0.5, 7),
   475‚Üí      new Vector3(12, 0.5, 5),
   476‚Üí      new Vector3(10, 0.5, 3),
   477‚Üí    ];
   478‚Üí
   479‚Üí    for (let i = 0; i &lt; cratePositions.length; i++) {
   480‚Üí      const size = 0.8 + Math.random() * 0.4;
   481‚Üí      const crate = MeshBuilder.CreateBox(
   482‚Üí        `crate_${i}`,
   483‚Üí        { width: size, height: size, depth: size },
   484‚Üí        this.scene
   485‚Üí      );
   486‚Üí      crate.position = cratePositions[i].clone();
   487‚Üí      crate.rotation.y = Math.random() * Math.PI;
   488‚Üí      crate.material = this.materials.get(&#x27;military&#x27;)!;
   489‚Üí      crate.parent = this.fobRoot;
   490‚Üí      this.allMeshes.push(crate);
   491‚Üí    }
   492‚Üí
   493‚Üí    // Barrels
   494‚Üí    for (let i = 0; i &lt; 5; i++) {
   495‚Üí      const barrel = MeshBuilder.CreateCylinder(
   496‚Üí        `barrel_${i}`,
   497‚Üí        { height: 1.2, diameter: 0.6, tessellation: 12 },
   498‚Üí        this.scene
   499‚Üí      );
   500‚Üí      barrel.position.set(-15 + Math.random() * 30, 0.6, -10 + Math.random() * 20);
   501‚Üí      barrel.material = this.materials.get(&#x27;damaged&#x27;)!;
   502‚Üí      barrel.parent = this.fobRoot;
   503‚Üí      this.allMeshes.push(barrel);
   504‚Üí    }
   505‚Üí
   506‚Üí    // Courtyard lights (flickering)
   507‚Üí    this.addFlickerLight(new Vector3(0, 4, 0), new Color3(1, 0.9, 0.7), 0.5, 0.5, 8);
   508‚Üí    this.addFlickerLight(new Vector3(-15, 4, 10), new Color3(1, 0.8, 0.6), 0.4, 0.7, 12);
   509‚Üí    this.addFlickerLight(new Vector3(15, 4, -10), new Color3(1, 0.7, 0.5), 0.3, 0.8, 20);
   510‚Üí  }
   511‚Üí
   512‚Üí  private createBarracks(): void {
   513‚Üí    // Barracks building - west side
   514‚Üí    const barracksX = -25;
   515‚Üí    const barracksZ = 0;
   516‚Üí
   517‚Üí    // Main structure
   518‚Üí    const barracks = MeshBuilder.CreateBox(
   519‚Üí      &#x27;barracks&#x27;,
   520‚Üí      { width: 12, height: 4, depth: 20 },
   521‚Üí      this.scene
   522‚Üí    );
   523‚Üí    barracks.position.set(barracksX, 2, barracksZ);
   524‚Üí    barracks.material = this.materials.get(&#x27;military&#x27;)!;
   525‚Üí    barracks.parent = this.fobRoot;
   526‚Üí    this.allMeshes.push(barracks);
   527‚Üí
   528‚Üí    // Door opening (represented as dark recess)
   529‚Üí    const doorway = MeshBuilder.CreateBox(
   530‚Üí      &#x27;barracksDoor&#x27;,
   531‚Üí      { width: 2, height: 2.5, depth: 0.5 },
   532‚Üí      this.scene
   533‚Üí    );
   534‚Üí    doorway.position.set(barracksX + 6.3, 1.25, barracksZ);
   535‚Üí    doorway.material = this.materials.get(&#x27;metal&#x27;)!;
   536‚Üí    doorway.parent = this.fobRoot;
   537‚Üí    this.allMeshes.push(doorway);
   538‚Üí
   539‚Üí    // Interior bunks (visible through door)
   540‚Üí    for (let i = 0; i &lt; 4; i++) {
   541‚Üí      const bunk = MeshBuilder.CreateBox(
   542‚Üí        `bunk_${i}`,
   543‚Üí        { width: 2, height: 0.8, depth: 1 },
   544‚Üí        this.scene
   545‚Üí      );
   546‚Üí      bunk.position.set(barracksX - 3, 0.4 + (i % 2) * 1.2, barracksZ - 6 + i * 4);
   547‚Üí      bunk.material = this.materials.get(&#x27;metal&#x27;)!;
   548‚Üí      bunk.parent = this.fobRoot;
   549‚Üí      this.allMeshes.push(bunk);
   550‚Üí    }
   551‚Üí
   552‚Üí    // Barracks interior light (dim, flickering)
   553‚Üí    this.addFlickerLight(
   554‚Üí      new Vector3(barracksX, 3.5, barracksZ),
   555‚Üí      new Color3(1, 0.7, 0.5),
   556‚Üí      0.3,
   557‚Üí      0.9,
   558‚Üí      25
   559‚Üí    );
   560‚Üí
   561‚Üí    // Bodies represented as capsules (horror element)
   562‚Üí    const bodyPositions = [
   563‚Üí      new Vector3(barracksX + 2, 0.3, barracksZ - 3),
   564‚Üí      new Vector3(barracksX - 2, 0.3, barracksZ + 5),
   565‚Üí    ];
   566‚Üí
   567‚Üí    for (let i = 0; i &lt; bodyPositions.length; i++) {
   568‚Üí      const body = MeshBuilder.CreateCapsule(
   569‚Üí        `body_${i}`,
   570‚Üí        { height: 1.8, radius: 0.25 },
   571‚Üí        this.scene
   572‚Üí      );
   573‚Üí      body.position = bodyPositions[i].clone();
   574‚Üí      body.rotation.z = Math.PI / 2;
   575‚Üí      body.rotation.y = Math.random() * Math.PI;
   576‚Üí      body.material = this.materials.get(&#x27;military&#x27;)!;
   577‚Üí      body.parent = this.fobRoot;
   578‚Üí      this.allMeshes.push(body);
   579‚Üí    }
   580‚Üí  }
   581‚Üí
   582‚Üí  private createCommandCenter(): void {
   583‚Üí    // Command Center - north side
   584‚Üí    const cmdX = 0;
   585‚Üí    const cmdZ = 25;
   586‚Üí
   587‚Üí    // Main structure
   588‚Üí    const cmdCenter = MeshBuilder.CreateBox(
   589‚Üí      &#x27;commandCenter&#x27;,
   590‚Üí      { width: 15, height: 5, depth: 10 },
   591‚Üí      this.scene
   592‚Üí    );
   593‚Üí    cmdCenter.position.set(cmdX, 2.5, cmdZ);
   594‚Üí    cmdCenter.material = this.materials.get(&#x27;military&#x27;)!;
   595‚Üí    cmdCenter.parent = this.fobRoot;
   596‚Üí    this.allMeshes.push(cmdCenter);
   597‚Üí
   598‚Üí    // Door
   599‚Üí    const cmdDoor = MeshBuilder.CreateBox(
   600‚Üí      &#x27;cmdDoor&#x27;,
   601‚Üí      { width: 2, height: 2.5, depth: 0.5 },
   602‚Üí      this.scene
   603‚Üí    );
   604‚Üí    cmdDoor.position.set(cmdX, 1.25, cmdZ - 5.3);
   605‚Üí    cmdDoor.material = this.materials.get(&#x27;metal&#x27;)!;
   606‚Üí    cmdDoor.parent = this.fobRoot;
   607‚Üí    this.allMeshes.push(cmdDoor);
   608‚Üí
   609‚Üí    // Terminal
   610‚Üí    const terminalBase = MeshBuilder.CreateBox(
   611‚Üí      &#x27;terminalBase&#x27;,
   612‚Üí      { width: 1.5, height: 1.2, depth: 0.8 },
   613‚Üí      this.scene
   614‚Üí    );
   615‚Üí    terminalBase.position.set(cmdX, 0.6, cmdZ + 2);
   616‚Üí    terminalBase.material = this.materials.get(&#x27;metal&#x27;)!;
   617‚Üí    terminalBase.parent = this.fobRoot;
   618‚Üí    this.allMeshes.push(terminalBase);
   619‚Üí
   620‚Üí    // Terminal screen
   621‚Üí    this.terminal = MeshBuilder.CreatePlane(
   622‚Üí      &#x27;terminalScreen&#x27;,
   623‚Üí      { width: 1.2, height: 0.8 },
   624‚Üí      this.scene
   625‚Üí    );
   626‚Üí    this.terminal.position.set(cmdX, 1.5, cmdZ + 1.6);
   627‚Üí    this.terminal.rotation.x = -0.2; // Tilted toward player
   628‚Üí    this.terminal.material = this.materials.get(&#x27;terminal&#x27;)!;
   629‚Üí    this.terminal.parent = this.fobRoot;
   630‚Üí    this.allMeshes.push(this.terminal);
   631‚Üí
   632‚Üí    // Terminal light (green glow)
   633‚Üí    this.terminalLight = new PointLight(
   634‚Üí      &#x27;terminalLight&#x27;,
   635‚Üí      new Vector3(cmdX, 1.5, cmdZ + 1),
   636‚Üí      this.scene
   637‚Üí    );
   638‚Üí    this.terminalLight.diffuse = Color3.FromHexString(&#x27;#00FF44&#x27;);
   639‚Üí    this.terminalLight.intensity = 0.3;
   640‚Üí    this.terminalLight.range = 5;
   641‚Üí
   642‚Üí    // Command center interior light
   643‚Üí    this.addFlickerLight(new Vector3(cmdX, 4, cmdZ), new Color3(0.8, 0.9, 1), 0.4, 0.3, 5);
   644‚Üí
   645‚Üí    // Comm tower outside
   646‚Üí    const commTower = MeshBuilder.CreateCylinder(
   647‚Üí      &#x27;commTower&#x27;,
   648‚Üí      { height: 12, diameter: 1, tessellation: 8 },
   649‚Üí      this.scene
   650‚Üí    );
   651‚Üí    commTower.position.set(cmdX + 10, 6, cmdZ);
   652‚Üí    commTower.material = this.materials.get(&#x27;metal&#x27;)!;
   653‚Üí    commTower.parent = this.fobRoot;
   654‚Üí    this.allMeshes.push(commTower);
   655‚Üí
   656‚Üí    // Antenna dish
   657‚Üí    const dish = MeshBuilder.CreateDisc(&#x27;dish&#x27;, { radius: 2, tessellation: 16 }, this.scene);
   658‚Üí    dish.position.set(cmdX + 10, 10, cmdZ);
   659‚Üí    dish.rotation.x = -Math.PI / 4;
   660‚Üí    dish.material = this.materials.get(&#x27;metal&#x27;)!;
   661‚Üí    dish.parent = this.fobRoot;
   662‚Üí    this.allMeshes.push(dish);
   663‚Üí  }
   664‚Üí
   665‚Üí  private createVehicleBay(): void {
   666‚Üí    // Vehicle Bay - east side (where mech is)
   667‚Üí    const bayX = 25;
   668‚Üí    const bayZ = 0;
   669‚Üí
   670‚Üí    // Hangar-style structure
   671‚Üí    const hangar = MeshBuilder.CreateBox(
   672‚Üí      &#x27;vehicleBay&#x27;,
   673‚Üí      { width: 20, height: 8, depth: 25 },
   674‚Üí      this.scene
   675‚Üí    );
   676‚Üí    hangar.position.set(bayX, 4, bayZ);
   677‚Üí    hangar.material = this.materials.get(&#x27;military&#x27;)!;
   678‚Üí    hangar.parent = this.fobRoot;
   679‚Üí    this.allMeshes.push(hangar);
   680‚Üí
   681‚Üí    // Large rolling door (open)
   682‚Üí    const doorFrame = MeshBuilder.CreateBox(
   683‚Üí      &#x27;bayDoorFrame&#x27;,
   684‚Üí      { width: 10, height: 7, depth: 0.5 },
   685‚Üí      this.scene
   686‚Üí    );
   687‚Üí    doorFrame.position.set(bayX - 10.3, 3.5, bayZ);
   688‚Üí    doorFrame.material = this.materials.get(&#x27;metal&#x27;)!;
   689‚Üí    doorFrame.parent = this.fobRoot;
   690‚Üí    this.allMeshes.push(doorFrame);
   691‚Üí
   692‚Üí    // Caution stripes around door
   693‚Üí    for (let i = 0; i &lt; 3; i++) {
   694‚Üí      const stripe = MeshBuilder.CreateBox(
   695‚Üí        `bayStripe_${i}`,
   696‚Üí        { width: 10, height: 0.3, depth: 0.55 },
   697‚Üí        this.scene
   698‚Üí      );
   699‚Üí      stripe.position.set(bayX - 10.3, 1 + i * 2.5, bayZ);
   700‚Üí      stripe.material = this.materials.get(&#x27;caution&#x27;)!;
   701‚Üí      stripe.parent = this.fobRoot;
   702‚Üí      this.allMeshes.push(stripe);
   703‚Üí    }
   704‚Üí
   705‚Üí    // Marcus&#x27;s damaged mech (TITAN)
   706‚Üí    this.createMech(new Vector3(bayX + 2, 0, bayZ));
   707‚Üí
   708‚Üí    // Vehicle bay lights (most are dead/flickering badly)
   709‚Üí    this.addFlickerLight(new Vector3(bayX, 7, bayZ - 8), new Color3(1, 0.6, 0.4), 0.2, 0.95, 30);
   710‚Üí    this.addFlickerLight(new Vector3(bayX, 7, bayZ + 8), new Color3(1, 0.7, 0.5), 0.15, 0.9, 25);
   711‚Üí  }
   712‚Üí
   713‚Üí  private createMech(position: Vector3): void {
   714‚Üí    // Marcus&#x27;s TITAN mech - damaged, eyes glowing ominously
   715‚Üí
   716‚Üí    // Legs
   717‚Üí    const leftLeg = MeshBuilder.CreateBox(
   718‚Üí      &#x27;mechLeftLeg&#x27;,
   719‚Üí      { width: 1, height: 4, depth: 1.2 },
   720‚Üí      this.scene
   721‚Üí    );
   722‚Üí    leftLeg.position.set(position.x - 1, 2, position.z);
   723‚Üí    leftLeg.material = this.materials.get(&#x27;mech&#x27;)!;
   724‚Üí    leftLeg.parent = this.fobRoot;
   725‚Üí    this.allMeshes.push(leftLeg);
   726‚Üí
   727‚Üí    const rightLeg = MeshBuilder.CreateBox(
   728‚Üí      &#x27;mechRightLeg&#x27;,
   729‚Üí      { width: 1, height: 4, depth: 1.2 },
   730‚Üí      this.scene
   731‚Üí    );
   732‚Üí    rightLeg.position.set(position.x + 1, 2, position.z);
   733‚Üí    rightLeg.material = this.materials.get(&#x27;mech&#x27;)!;
   734‚Üí    rightLeg.parent = this.fobRoot;
   735‚Üí    this.allMeshes.push(rightLeg);
   736‚Üí
   737‚Üí    // Torso
   738‚Üí    const torso = MeshBuilder.CreateBox(&#x27;mechTorso&#x27;, { width: 3, height: 3, depth: 2 }, this.scene);
   739‚Üí    torso.position.set(position.x, 5.5, position.z);
   740‚Üí    torso.material = this.materials.get(&#x27;mech&#x27;)!;
   741‚Üí    torso.parent = this.fobRoot;
   742‚Üí    this.allMeshes.push(torso);
   743‚Üí
   744‚Üí    // Head/cockpit
   745‚Üí    this.mechMesh = MeshBuilder.CreateBox(
   746‚Üí      &#x27;mechHead&#x27;,
   747‚Üí      { width: 2, height: 1.5, depth: 1.5 },
   748‚Üí      this.scene
   749‚Üí    );
   750‚Üí    this.mechMesh.position.set(position.x, 7.5, position.z);
   751‚Üí    this.mechMesh.material = this.materials.get(&#x27;mech&#x27;)!;
   752‚Üí    this.mechMesh.parent = this.fobRoot;
   753‚Üí    this.allMeshes.push(this.mechMesh);
   754‚Üí
   755‚Üí    // Eyes (glowing red - eerie)
   756‚Üí    const leftEye = MeshBuilder.CreateSphere(
   757‚Üí      &#x27;mechLeftEye&#x27;,
   758‚Üí      { diameter: 0.3, segments: 8 },
   759‚Üí      this.scene
   760‚Üí    );
   761‚Üí    leftEye.position.set(position.x - 0.4, 7.6, position.z - 0.8);
   762‚Üí    leftEye.material = this.materials.get(&#x27;mechEyes&#x27;)!;
   763‚Üí    leftEye.parent = this.fobRoot;
   764‚Üí    this.allMeshes.push(leftEye);
   765‚Üí
   766‚Üí    const rightEye = MeshBuilder.CreateSphere(
   767‚Üí      &#x27;mechRightEye&#x27;,
   768‚Üí      { diameter: 0.3, segments: 8 },
   769‚Üí      this.scene
   770‚Üí    );
   771‚Üí    rightEye.position.set(position.x + 0.4, 7.6, position.z - 0.8);
   772‚Üí    rightEye.material = this.materials.get(&#x27;mechEyes&#x27;)!;
   773‚Üí    rightEye.parent = this.fobRoot;
   774‚Üí    this.allMeshes.push(rightEye);
   775‚Üí
   776‚Üí    // Eye light
   777‚Üí    this.mechEyeLight = new PointLight(
   778‚Üí      &#x27;mechEyeLight&#x27;,
   779‚Üí      new Vector3(position.x, 7.6, position.z - 1),
   780‚Üí      this.scene
   781‚Üí    );
   782‚Üí    this.mechEyeLight.diffuse = Color3.FromHexString(&#x27;#FF2200&#x27;);
   783‚Üí    this.mechEyeLight.intensity = 0.3;
   784‚Üí    this.mechEyeLight.range = 8;
   785‚Üí
   786‚Üí    // Arm cannons (damaged, pointing down)
   787‚Üí    const leftArm = MeshBuilder.CreateCylinder(
   788‚Üí      &#x27;mechLeftArm&#x27;,
   789‚Üí      { height: 3, diameter: 0.8, tessellation: 8 },
   790‚Üí      this.scene
   791‚Üí    );
   792‚Üí    leftArm.position.set(position.x - 2, 4.5, position.z);
   793‚Üí    leftArm.rotation.z = 0.3;
   794‚Üí    leftArm.material = this.materials.get(&#x27;mech&#x27;)!;
   795‚Üí    leftArm.parent = this.fobRoot;
   796‚Üí    this.allMeshes.push(leftArm);
   797‚Üí
   798‚Üí    const rightArm = MeshBuilder.CreateCylinder(
   799‚Üí      &#x27;mechRightArm&#x27;,
   800‚Üí      { height: 3, diameter: 0.8, tessellation: 8 },
   801‚Üí      this.scene
   802‚Üí    );
   803‚Üí    rightArm.position.set(position.x + 2, 4.5, position.z);
   804‚Üí    rightArm.rotation.z = -0.3;
   805‚Üí    rightArm.material = this.materials.get(&#x27;mech&#x27;)!;
   806‚Üí    rightArm.parent = this.fobRoot;
   807‚Üí    this.allMeshes.push(rightArm);
   808‚Üí  }
   809‚Üí
   810‚Üí  private createUndergroundAccess(): void {
   811‚Üí    // Underground access hatch - in vehicle bay
   812‚Üí    const hatchX = 30;
   813‚Üí    const hatchZ = 10;
   814‚Üí
   815‚Üí    // Floor plate around hatch
   816‚Üí    const floorPlate = MeshBuilder.CreateCylinder(
   817‚Üí      &#x27;hatchFloor&#x27;,
   818‚Üí      { height: 0.1, diameter: 4, tessellation: 16 },
   819‚Üí      this.scene
   820‚Üí    );
   821‚Üí    floorPlate.position.set(hatchX, 0.05, hatchZ);
   822‚Üí    floorPlate.material = this.materials.get(&#x27;metal&#x27;)!;
   823‚Üí    floorPlate.parent = this.fobRoot;
   824‚Üí    this.allMeshes.push(floorPlate);
   825‚Üí
   826‚Üí    // Hatch itself
   827‚Üí    this.undergroundHatch = MeshBuilder.CreateCylinder(
   828‚Üí      &#x27;hatch&#x27;,
   829‚Üí      { height: 0.2, diameter: 2.5, tessellation: 16 },
   830‚Üí      this.scene
   831‚Üí    );
   832‚Üí    this.undergroundHatch.position.set(hatchX, 0.15, hatchZ);
   833‚Üí    this.undergroundHatch.material = this.materials.get(&#x27;hatch&#x27;)!;
   834‚Üí    this.undergroundHatch.parent = this.fobRoot;
   835‚Üí    this.allMeshes.push(this.undergroundHatch);
   836‚Üí
   837‚Üí    // Hatch handle
   838‚Üí    const handle = MeshBuilder.CreateTorus(
   839‚Üí      &#x27;hatchHandle&#x27;,
   840‚Üí      { diameter: 0.6, thickness: 0.08, tessellation: 16 },
   841‚Üí      this.scene
   842‚Üí    );
   843‚Üí    handle.position.set(hatchX, 0.35, hatchZ);
   844‚Üí    handle.rotation.x = Math.PI / 2;
   845‚Üí    handle.material = this.materials.get(&#x27;metal&#x27;)!;
   846‚Üí    handle.parent = this.fobRoot;
   847‚Üí    this.allMeshes.push(handle);
   848‚Üí
   849‚Üí    // Caution marking
   850‚Üí    const cautionRing = MeshBuilder.CreateTorus(
   851‚Üí      &#x27;hatchCaution&#x27;,
   852‚Üí      { diameter: 3.5, thickness: 0.15, tessellation: 32 },
   853‚Üí      this.scene
   854‚Üí    );
   855‚Üí    cautionRing.position.set(hatchX, 0.1, hatchZ);
   856‚Üí    cautionRing.rotation.x = Math.PI / 2;
   857‚Üí    cautionRing.material = this.materials.get(&#x27;caution&#x27;)!;
   858‚Üí    cautionRing.parent = this.fobRoot;
   859‚Üí    this.allMeshes.push(cautionRing);
   860‚Üí  }
   861‚Üí
   862‚Üí  private createBloodDecals(): void {
   863‚Üí    // Blood splatters for horror atmosphere
   864‚Üí    const decalPositions = [
   865‚Üí      { pos: new Vector3(-20, 0.02, -5), size: 2, rot: 0 },
   866‚Üí      { pos: new Vector3(-22, 0.02, 2), size: 1.5, rot: 0.5 },
   867‚Üí      { pos: new Vector3(5, 0.02, 15), size: 1, rot: 1.2 },
   868‚Üí      { pos: new Vector3(-8, 0.02, -2), size: 2.5, rot: 2.1 },
   869‚Üí      { pos: new Vector3(15, 0.02, -15), size: 1.2, rot: 3.0 },
   870‚Üí      // Wall splatters (vertical)
   871‚Üí      { pos: new Vector3(-25 + 6.05, 1.5, 3), size: 1, rot: 0, wall: true, rotX: Math.PI / 2 },
   872‚Üí    ];
   873‚Üí
   874‚Üí    for (let i = 0; i &lt; decalPositions.length; i++) {
   875‚Üí      const d = decalPositions[i];
   876‚Üí      const decal = MeshBuilder.CreateDisc(
   877‚Üí        `blood_${i}`,
   878‚Üí        { radius: d.size, tessellation: 12 },
   879‚Üí        this.scene
   880‚Üí      );
   881‚Üí
   882‚Üí      if (d.wall) {
   883‚Üí        decal.position = d.pos.clone();
   884‚Üí        decal.rotation.y = d.rot;
   885‚Üí        decal.rotation.z = Math.PI / 2;
   886‚Üí      } else {
   887‚Üí        decal.position = d.pos.clone();
   888‚Üí        decal.rotation.x = Math.PI / 2;
   889‚Üí        decal.rotation.z = d.rot;
   890‚Üí      }
   891‚Üí
   892‚Üí      decal.material = this.materials.get(&#x27;blood&#x27;)!;
   893‚Üí      decal.parent = this.fobRoot;
   894‚Üí      this.allMeshes.push(decal);
   895‚Üí      this.bloodDecals.push(decal);
   896‚Üí    }
   897‚Üí  }
   898‚Üí
   899‚Üí  /**
   900‚Üí   * Load and place crashed alien vehicle wrecks in the courtyard.
   901‚Üí   * These Wraith hover tanks were destroyed during the base assault.
   902‚Üí   */
   903‚Üí  private async createAlienVehicleWrecks(): Promise&lt;void&gt; {
   904‚Üí    // Define positions for crashed Wraith vehicles (alien hover tanks)
   905‚Üí    // These tell the story of the battle - crashed/abandoned in the courtyard
   906‚Üí    const vehicleWrecks = [
   907‚Üí      {
   908‚Üí        position: new Vector3(12, 0.3, -18), // Near perimeter breach - crash landed
   909‚Üí        rotation: new Vector3(0.4, 0.8, 0.3), // Tilted/crashed orientation
   910‚Üí        scale: 7, // Large alien hover tank (~7m scale)
   911‚Üí      },
   912‚Üí      {
   913‚Üí        position: new Vector3(-18, 0.5, 12), // In courtyard - shot down
   914‚Üí        rotation: new Vector3(-0.2, 2.1, 0.5), // Different crash angle
   915‚Üí        scale: 6,
   916‚Üí      },
   917‚Üí    ];
   918‚Üí
   919‚Üí    // Try to load the Wraith model
   920‚Üí    try {
   921‚Üí      await AssetManager.loadAsset(&#x27;vehicles&#x27;, &#x27;wraith&#x27;, this.scene);
   922‚Üí
   923‚Üí      for (let i = 0; i &lt; vehicleWrecks.length; i++) {
   924‚Üí        const wreck = vehicleWrecks[i];
   925‚Üí        const instance = AssetManager.createInstance(
   926‚Üí          &#x27;vehicles&#x27;,
   927‚Üí          &#x27;wraith&#x27;,
   928‚Üí          `wraith_wreck_${i}`,
   929‚Üí          this.scene
   930‚Üí        );
   931‚Üí
   932‚Üí        if (instance) {
   933‚Üí          instance.position = wreck.position;
   934‚Üí          instance.rotation = wreck.rotation;
   935‚Üí          instance.scaling.setAll(wreck.scale);
   936‚Üí
   937‚Üí          if (this.fobRoot) {
   938‚Üí            instance.parent = this.fobRoot;
   939‚Üí          }
   940‚Üí
   941‚Üí          this.alienVehicles.push(instance);
   942‚Üí
   943‚Üí          // Add a dim red glow underneath the crashed vehicle (damaged reactor)
   944‚Üí          const damageGlow = new PointLight(
   945‚Üí            `wreckGlow_${i}`,
   946‚Üí            wreck.position.add(new Vector3(0, 0.5, 0)),
   947‚Üí            this.scene
   948‚Üí          );
   949‚Üí          damageGlow.diffuse = new Color3(0.8, 0.2, 0.1);
   950‚Üí          damageGlow.intensity = 0.2;
   951‚Üí          damageGlow.range = 6;
   952‚Üí
   953‚Üí          // Add to flicker lights for atmospheric effect
   954‚Üí          this.flickerLights.push({
   955‚Üí            light: damageGlow,
   956‚Üí            baseIntensity: 0.2,
   957‚Üí            flickerSpeed: 3 + Math.random() * 2,
   958‚Üí            flickerAmount: 0.8,
   959‚Üí            timer: Math.random() * Math.PI * 2,
   960‚Üí            isOff: false,
   961‚Üí            offDuration: 0,
   962‚Üí            offTimer: 0,
   963‚Üí          });
   964‚Üí        }
   965‚Üí      }
   966‚Üí
   967‚Üí      console.log(`[FOBDelta] Loaded ${this.alienVehicles.length} alien vehicle wrecks`);
   968‚Üí    } catch (error) {
   969‚Üí      console.warn(&#x27;[FOBDelta] Could not load alien vehicle models, using fallback:&#x27;, error);
   970‚Üí      // Fallback: Create simple placeholder meshes if GLB fails to load
   971‚Üí      for (let i = 0; i &lt; vehicleWrecks.length; i++) {
   972‚Üí        const wreck = vehicleWrecks[i];
   973‚Üí        const placeholder = MeshBuilder.CreateBox(
   974‚Üí          `wraith_placeholder_${i}`,
   975‚Üí          { width: 4, height: 1.5, depth: 6 },
   976‚Üí          this.scene
   977‚Üí        );
   978‚Üí        placeholder.position = wreck.position;
   979‚Üí        placeholder.rotation = wreck.rotation;
   980‚Üí        placeholder.material = this.materials.get(&#x27;damaged&#x27;)!;
   981‚Üí        if (this.fobRoot) {
   982‚Üí          placeholder.parent = this.fobRoot;
   983‚Üí        }
   984‚Üí        this.allMeshes.push(placeholder);
   985‚Üí      }
   986‚Üí    }
   987‚Üí  }
   988‚Üí
   989‚Üí  /**
   990‚Üí   * Preload GLB models for ambush enemies so they spawn instantly
   991‚Üí   */
   992‚Üí  private async preloadAmbushEnemyModels(): Promise&lt;void&gt; {
   993‚Üí    const assetName = SPECIES_TO_ASSET[AMBUSH_ENEMY_SPECIES];
   994‚Üí    if (!assetName) {
   995‚Üí      console.warn(&#x27;[FOBDelta] No asset mapping for ambush enemy species&#x27;);
   996‚Üí      return;
   997‚Üí    }
   998‚Üí
   999‚Üí    try {
  1000‚Üí      await AssetManager.loadAsset(&#x27;aliens&#x27;, assetName, this.scene);
  1001‚Üí      this.ambushEnemiesPreloaded = true;
  1002‚Üí      console.log(`[FOBDelta] Preloaded ambush enemy GLB: ${assetName}`);
  1003‚Üí    } catch (error) {
  1004‚Üí      console.warn(&#x27;[FOBDelta] Failed to preload ambush enemy GLB:&#x27;, error);
  1005‚Üí      this.ambushEnemiesPreloaded = false;
  1006‚Üí    }
  1007‚Üí  }
  1008‚Üí
  1009‚Üí  private createObjectiveMarker(): void {
  1010‚Üí    this.objectiveMarker = MeshBuilder.CreateTorus(
  1011‚Üí      &#x27;objectiveMarker&#x27;,
  1012‚Üí      { diameter: 2, thickness: 0.1, tessellation: 32 },
  1013‚Üí      this.scene
  1014‚Üí    );
  1015‚Üí    this.objectiveMarker.rotation.x = Math.PI / 2;
  1016‚Üí
  1017‚Üí    const markerMat = new StandardMaterial(&#x27;markerMat&#x27;, this.scene);
  1018‚Üí    markerMat.emissiveColor = Color3.FromHexString(&#x27;#FFD700&#x27;);
  1019‚Üí    markerMat.alpha = 0.6;
  1020‚Üí    this.objectiveMarker.material = markerMat;
  1021‚Üí    this.objectiveMarker.isVisible = false;
  1022‚Üí    this.objectiveMarker.parent = this.fobRoot;
  1023‚Üí  }
  1024‚Üí
  1025‚Üí  private createFlashlight(): void {
  1026‚Üí    // Player&#x27;s flashlight (attached to camera)
  1027‚Üí    this.flashlight = new PointLight(&#x27;flashlight&#x27;, new Vector3(0, 0, 0), this.scene);
  1028‚Üí    this.flashlight.diffuse = new Color3(1, 1, 0.95);
  1029‚Üí    this.flashlight.intensity = 0;
  1030‚Üí    this.flashlight.range = 25;
  1031‚Üí  }
  1032‚Üí
  1033‚Üí  private setupAreaZones(): void {
  1034‚Üí    this.areaZones = [
  1035‚Üí      {
  1036‚Üí        id: &#x27;perimeter&#x27;,
  1037‚Üí        name: &#x27;Perimeter&#x27;,
  1038‚Üí        center: new Vector3(0, 0, -35),
  1039‚Üí        radius: 15,
  1040‚Üí        triggered: false,
  1041‚Üí      },
  1042‚Üí      {
  1043‚Üí        id: &#x27;courtyard&#x27;,
  1044‚Üí        name: &#x27;Courtyard&#x27;,
  1045‚Üí        center: new Vector3(0, 0, 0),
  1046‚Üí        radius: 20,
  1047‚Üí        triggered: false,
  1048‚Üí      },
  1049‚Üí      {
  1050‚Üí        id: &#x27;barracks&#x27;,
  1051‚Üí        name: &#x27;Barracks&#x27;,
  1052‚Üí        center: new Vector3(-25, 0, 0),
  1053‚Üí        radius: 12,
  1054‚Üí        triggered: false,
  1055‚Üí      },
  1056‚Üí      {
  1057‚Üí        id: &#x27;command&#x27;,
  1058‚Üí        name: &#x27;Command Center&#x27;,
  1059‚Üí        center: new Vector3(0, 0, 25),
  1060‚Üí        radius: 12,
  1061‚Üí        triggered: false,
  1062‚Üí      },
  1063‚Üí      {
  1064‚Üí        id: &#x27;vehiclebay&#x27;,
  1065‚Üí        name: &#x27;Vehicle Bay&#x27;,
  1066‚Üí        center: new Vector3(25, 0, 0),
  1067‚Üí        radius: 15,
  1068‚Üí        triggered: false,
  1069‚Üí      },
  1070‚Üí      {
  1071‚Üí        id: &#x27;hatch&#x27;,
  1072‚Üí        name: &#x27;Underground Access&#x27;,
  1073‚Üí        center: new Vector3(30, 0, 10),
  1074‚Üí        radius: 5,
  1075‚Üí        triggered: false,
  1076‚Üí      },
  1077‚Üí    ];
  1078‚Üí  }
  1079‚Üí
  1080‚Üí  private startLevel(): void {
  1081‚Üí    this.phase = &#x27;approach&#x27;;
  1082‚Üí    this.phaseTime = 0;
  1083‚Üí
  1084‚Üí    // Set up action handler
  1085‚Üí    this.actionCallback = this.handleAction.bind(this);
  1086‚Üí    this.callbacks.onActionHandlerRegister(this.actionCallback);
  1087‚Üí
  1088‚Üí    // Set exploration action buttons
  1089‚Üí    this.updateActionButtons();
  1090‚Üí
  1091‚Üí    // Initial comms
  1092‚Üí    this.callbacks.onNotification(&#x27;FOB DELTA - FORWARD OPERATING BASE&#x27;, 3000);
  1093‚Üí    this.callbacks.onObjectiveUpdate(
  1094‚Üí      &#x27;INVESTIGATE FOB DELTA&#x27;,
  1095‚Üí      &#x27;Search the base for survivors and intel.&#x27;
  1096‚Üí    );
  1097‚Üí
  1098‚Üí    setTimeout(() =&gt; {
  1099‚Üí      this.sendCommsMessage(&#x27;approach_entry&#x27;, {
  1100‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
  1101‚Üí        callsign: &#x27;ATHENA&#x27;,
  1102‚Üí        portrait: &#x27;ai&#x27;,
  1103‚Üí        text: &#x27;FOB Delta beacon located. Detecting no active transponders. Proceed with caution, Sergeant.&#x27;,
  1104‚Üí      });
  1105‚Üí    }, 2000);
  1106‚Üí
  1107‚Üí    // Set initial objective
  1108‚Üí    this.setObjective(new Vector3(0, 0, 0)); // Courtyard
  1109‚Üí  }
  1110‚Üí
  1111‚Üí  private handleAction(actionId: string): void {
  1112‚Üí    switch (actionId) {
  1113‚Üí      case &#x27;flashlight&#x27;:
  1114‚Üí        this.toggleFlashlight();
  1115‚Üí        break;
  1116‚Üí
  1117‚Üí      case &#x27;scanner&#x27;:
  1118‚Üí        this.activateScanner();
  1119‚Üí        break;
  1120‚Üí
  1121‚Üí      case &#x27;interact&#x27;:
  1122‚Üí        this.tryInteract();
  1123‚Üí        break;
  1124‚Üí
  1125‚Üí      case &#x27;melee&#x27;:
  1126‚Üí        this.meleeAttack();
  1127‚Üí        break;
  1128‚Üí
  1129‚Üí      case &#x27;reload&#x27;:
  1130‚Üí        this.handleReload();
  1131‚Üí        break;
  1132‚Üí    }
  1133‚Üí  }
  1134‚Üí
  1135‚Üí  private toggleFlashlight(): void {
  1136‚Üí    this.flashlightOn = !this.flashlightOn;
  1137‚Üí
  1138‚Üí    if (this.flashlight) {
  1139‚Üí      this.flashlight.intensity = this.flashlightOn ? 1.5 : 0;
  1140‚Üí    }
  1141‚Üí
  1142‚Üí    this.callbacks.onNotification(this.flashlightOn ? &#x27;FLASHLIGHT ON&#x27; : &#x27;FLASHLIGHT OFF&#x27;, 800);
  1143‚Üí  }
  1144‚Üí
  1145‚Üí  private activateScanner(): void {
  1146‚Üí    // Simple scanner pulse - shows nearby points of interest
  1147‚Üí    this.callbacks.onNotification(&#x27;SCANNING...&#x27;, 1500);
  1148‚Üí
  1149‚Üí    // Check if near terminal
  1150‚Üí    if (this.terminal) {
  1151‚Üí      const dist = Vector3.Distance(this.camera.position, this.terminal.position);
  1152‚Üí      if (dist &lt; 15 &amp;&amp; !this.logsAccessed) {
  1153‚Üí        setTimeout(() =&gt; {
  1154‚Üí          this.callbacks.onNotification(&#x27;TERMINAL DETECTED - 12M&#x27;, 2000);
  1155‚Üí          this.setObjective(this.terminal!.position);
  1156‚Üí        }, 1500);
  1157‚Üí      }
  1158‚Üí    }
  1159‚Üí
  1160‚Üí    // Check if near mech
  1161‚Üí    if (this.mechMesh) {
  1162‚Üí      const dist = Vector3.Distance(this.camera.position, this.mechMesh.position);
  1163‚Üí      if (dist &lt; 20) {
  1164‚Üí        setTimeout(() =&gt; {
  1165‚Üí          this.callbacks.onNotification(&#x27;MECH SIGNATURE DETECTED&#x27;, 2000);
  1166‚Üí        }, 1500);
  1167‚Üí      }
  1168‚Üí    }
  1169‚Üí
  1170‚Üí    // Check if near hatch
  1171‚Üí    if (this.undergroundHatch &amp;&amp; this.logsAccessed) {
  1172‚Üí      const dist = Vector3.Distance(this.camera.position, this.undergroundHatch.position);
  1173‚Üí      if (dist &lt; 15 &amp;&amp; !this.hatchOpen) {
  1174‚Üí        setTimeout(() =&gt; {
  1175‚Üí          this.callbacks.onNotification(&#x27;UNDERGROUND ACCESS DETECTED&#x27;, 2000);
  1176‚Üí          this.setObjective(this.undergroundHatch!.position);
  1177‚Üí        }, 1500);
  1178‚Üí      }
  1179‚Üí    }
  1180‚Üí  }
  1181‚Üí
  1182‚Üí  private tryInteract(): void {
  1183‚Üí    // Check terminal interaction
  1184‚Üí    if (this.terminal &amp;&amp; !this.logsAccessed) {
  1185‚Üí      const dist = Vector3.Distance(this.camera.position, this.terminal.position);
  1186‚Üí      if (dist &lt; 4) {
  1187‚Üí        this.accessLogs();
  1188‚Üí        return;
  1189‚Üí      }
  1190‚Üí    }
  1191‚Üí
  1192‚Üí    // Check hatch interaction
  1193‚Üí    if (this.undergroundHatch &amp;&amp; this.logsAccessed &amp;&amp; !this.hatchOpen) {
  1194‚Üí      const dist = Vector3.Distance(this.camera.position, this.undergroundHatch.position);
  1195‚Üí      if (dist &lt; 4) {
  1196‚Üí        this.openHatch();
  1197‚Üí        return;
  1198‚Üí      }
  1199‚Üí    }
  1200‚Üí  }
  1201‚Üí
  1202‚Üí  private accessLogs(): void {
  1203‚Üí    this.logsAccessed = true;
  1204‚Üí    this.callbacks.onNotification(&#x27;ACCESSING MISSION LOGS...&#x27;, 2000);
  1205‚Üí
  1206‚Üí    // Series of comms messages revealing what happened
  1207‚Üí    setTimeout(() =&gt; {
  1208‚Üí      this.sendCommsMessage(&#x27;log_1&#x27;, {
  1209‚Üí        sender: &#x27;Mission Log&#x27;,
  1210‚Üí        callsign: &#x27;FOB DELTA&#x27;,
  1211‚Üí        portrait: &#x27;ai&#x27;,
  1212‚Üí        text: &#x27;[DAY 3] Contact with forward scouts lost. Reports of hostile creatures in the canyons. Perimeter defense activated.&#x27;,
  1213‚Üí      });
  1214‚Üí    }, 2500);
  1215‚Üí
  1216‚Üí    setTimeout(() =&gt; {
  1217‚Üí      this.sendCommsMessage(&#x27;log_2&#x27;, {
  1218‚Üí        sender: &#x27;Mission Log&#x27;,
  1219‚Üí        callsign: &#x27;FOB DELTA&#x27;,
  1220‚Üí        portrait: &#x27;ai&#x27;,
  1221‚Üí        text: &#x27;[DAY 5] They came at night. Hundreds of them. Perimeter breached. Heavy casualties. Corporal Cole took his mech to cover the evacuation.&#x27;,
  1222‚Üí      });
  1223‚Üí    }, 8000);
  1224‚Üí
  1225‚Üí    setTimeout(() =&gt; {
  1226‚Üí      this.sendCommsMessage(&#x27;log_3&#x27;, {
  1227‚Üí        sender: &#x27;Mission Log&#x27;,
  1228‚Üí        callsign: &#x27;FOB DELTA&#x27;,
  1229‚Üí        portrait: &#x27;ai&#x27;,
  1230‚Üí        text: &quot;[DAY 5 - FINAL] Cole&#x27;s mech went down in the vehicle bay. Underground tunnels discovered. That&#x27;s where they came from. That&#x27;s where they took our people.&quot;,
  1231‚Üí      });
  1232‚Üí    }, 14000);
  1233‚Üí
  1234‚Üí    setTimeout(() =&gt; {
  1235‚Üí      this.callbacks.onObjectiveUpdate(
  1236‚Üí        &#x27;LOCATE UNDERGROUND ACCESS&#x27;,
  1237‚Üí        &#x27;Find the tunnel entrance in the Vehicle Bay.&#x27;
  1238‚Üí      );
  1239‚Üí      this.transitionToPhase(&#x27;discovery&#x27;);
  1240‚Üí      this.setObjective(new Vector3(30, 0, 10)); // Hatch location
  1241‚Üí    }, 20000);
  1242‚Üí  }
  1243‚Üí
  1244‚Üí  private openHatch(): void {
  1245‚Üí    this.hatchOpen = true;
  1246‚Üí    this.callbacks.onNotification(&#x27;HATCH OPENED&#x27;, 1500);
  1247‚Üí
  1248‚Üí    // Animate hatch opening (simple position change)
  1249‚Üí    if (this.undergroundHatch) {
  1250‚Üí      this.undergroundHatch.position.y = -0.5;
  1251‚Üí    }
  1252‚Üí
  1253‚Üí    setTimeout(() =&gt; {
  1254‚Üí      this.sendCommsMessage(&#x27;hatch_open&#x27;, {
  1255‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
  1256‚Üí        callsign: &#x27;ATHENA&#x27;,
  1257‚Üí        portrait: &#x27;ai&#x27;,
  1258‚Üí        text: &quot;Underground access secured. Detecting Corporal Cole&#x27;s transponder signal below. He&#x27;s alive, Sergeant.&quot;,
  1259‚Üí      });
  1260‚Üí    }, 1500);
  1261‚Üí
  1262‚Üí    setTimeout(() =&gt; {
  1263‚Üí      this.callbacks.onObjectiveUpdate(
  1264‚Üí        &#x27;DESCEND INTO THE BREACH&#x27;,
  1265‚Üí        &#x27;Enter the underground tunnels to find Marcus.&#x27;
  1266‚Üí      );
  1267‚Üí      this.transitionToPhase(&#x27;exit&#x27;);
  1268‚Üí    }, 6000);
  1269‚Üí
  1270‚Üí    setTimeout(() =&gt; {
  1271‚Üí      this.callbacks.onNotification(&#x27;PROCEED TO UNDERGROUND ACCESS&#x27;, 3000);
  1272‚Üí    }, 8000);
  1273‚Üí  }
  1274‚Üí
  1275‚Üí  private updateActionButtons(): void {
  1276‚Üí    const groups: ActionButtonGroup[] = [
  1277‚Üí      {
  1278‚Üí        id: &#x27;tools&#x27;,
  1279‚Üí        label: &#x27;TOOLS&#x27;,
  1280‚Üí        position: &#x27;right&#x27;,
  1281‚Üí        buttons: [
  1282‚Üí          createAction(&#x27;flashlight&#x27;, &#x27;FLASHLIGHT&#x27;, &#x27;KeyF&#x27;, {
  1283‚Üí            variant: &#x27;secondary&#x27;,
  1284‚Üí            icon: &#x27;üî¶&#x27;,
  1285‚Üí          }),
  1286‚Üí          createAction(&#x27;scanner&#x27;, &#x27;SCANNER&#x27;, &#x27;KeyT&#x27;, {
  1287‚Üí            variant: &#x27;primary&#x27;,
  1288‚Üí            icon: &#x27;üì°&#x27;,
  1289‚Üí          }),
  1290‚Üí        ],
  1291‚Üí      },
  1292‚Üí    ];
  1293‚Üí
  1294‚Üí    // Add combat buttons during ambush phase
  1295‚Üí    if (this.phase === &#x27;ambush&#x27; &amp;&amp; this.enemies.length &gt; 0) {
  1296‚Üí      groups.push({
  1297‚Üí        id: &#x27;combat&#x27;,
  1298‚Üí        label: &#x27;COMBAT&#x27;,
  1299‚Üí        position: &#x27;left&#x27;,
  1300‚Üí        buttons: [
  1301‚Üí          createAction(&#x27;melee&#x27;, &#x27;MELEE&#x27;, &#x27;KeyV&#x27;, {
  1302‚Üí            variant: &#x27;danger&#x27;,
  1303‚Üí            icon: &#x27;üî™&#x27;,
  1304‚Üí          }),
  1305‚Üí          createAction(&#x27;reload&#x27;, &#x27;RELOAD&#x27;, &#x27;KeyR&#x27;, {
  1306‚Üí            variant: &#x27;secondary&#x27;,
  1307‚Üí            icon: &#x27;üîÑ&#x27;,
  1308‚Üí          }),
  1309‚Üí        ],
  1310‚Üí      });
  1311‚Üí    }
  1312‚Üí
  1313‚Üí    // Add interact button when near interactables
  1314‚Üí    const nearInteractable = this.checkNearInteractable();
  1315‚Üí    if (nearInteractable) {
  1316‚Üí      groups.push({
  1317‚Üí        id: &#x27;interact&#x27;,
  1318‚Üí        position: &#x27;bottom&#x27;,
  1319‚Üí        buttons: [
  1320‚Üí          createAction(&#x27;interact&#x27;, nearInteractable, &#x27;KeyE&#x27;, {
  1321‚Üí            variant: &#x27;primary&#x27;,
  1322‚Üí            size: &#x27;large&#x27;,
  1323‚Üí            highlighted: true,
  1324‚Üí          }),
  1325‚Üí        ],
  1326‚Üí      });
  1327‚Üí    }
  1328‚Üí
  1329‚Üí    this.callbacks.onActionGroupsChange(groups);
  1330‚Üí  }
  1331‚Üí
  1332‚Üí  private checkNearInteractable(): string | null {
  1333‚Üí    // Terminal
  1334‚Üí    if (this.terminal &amp;&amp; !this.logsAccessed) {
  1335‚Üí      const dist = Vector3.Distance(this.camera.position, this.terminal.position);
  1336‚Üí      if (dist &lt; 4) return &#x27;ACCESS TERMINAL&#x27;;
  1337‚Üí    }
  1338‚Üí
  1339‚Üí    // Hatch
  1340‚Üí    if (this.undergroundHatch &amp;&amp; this.logsAccessed &amp;&amp; !this.hatchOpen) {
  1341‚Üí      const dist = Vector3.Distance(this.camera.position, this.undergroundHatch.position);
  1342‚Üí      if (dist &lt; 4) return &#x27;OPEN HATCH&#x27;;
  1343‚Üí    }
  1344‚Üí
  1345‚Üí    // Exit
  1346‚Üí    if (this.undergroundHatch &amp;&amp; this.hatchOpen) {
  1347‚Üí      const dist = Vector3.Distance(this.camera.position, this.undergroundHatch.position);
  1348‚Üí      if (dist &lt; 3) return &#x27;ENTER TUNNELS&#x27;;
  1349‚Üí    }
  1350‚Üí
  1351‚Üí    return null;
  1352‚Üí  }
  1353‚Üí
  1354‚Üí  private setObjective(position: Vector3): void {
  1355‚Üí    this.currentObjective = position;
  1356‚Üí    if (this.objectiveMarker) {
  1357‚Üí      this.objectiveMarker.position.set(position.x, 0.5, position.z);
  1358‚Üí      this.objectiveMarker.isVisible = true;
  1359‚Üí    }
  1360‚Üí  }
  1361‚Üí
  1362‚Üí  private clearObjective(): void {
  1363‚Üí    this.currentObjective = null;
  1364‚Üí    if (this.objectiveMarker) {
  1365‚Üí      this.objectiveMarker.isVisible = false;
  1366‚Üí    }
  1367‚Üí  }
  1368‚Üí
  1369‚Üí  private sendCommsMessage(
  1370‚Üí    flag: string,
  1371‚Üí    message: {
  1372‚Üí      sender: string;
  1373‚Üí      callsign: string;
  1374‚Üí      portrait: &#x27;commander&#x27; | &#x27;ai&#x27; | &#x27;marcus&#x27; | &#x27;armory&#x27; | &#x27;player&#x27;;
  1375‚Üí      text: string;
  1376‚Üí    }
  1377‚Üí  ): void {
  1378‚Üí    if (this.messageFlags.has(flag)) return;
  1379‚Üí    this.messageFlags.add(flag);
  1380‚Üí    this.callbacks.onCommsMessage(message);
  1381‚Üí  }
  1382‚Üí
  1383‚Üí  private transitionToPhase(newPhase: FOBPhase): void {
  1384‚Üí    this.phase = newPhase;
  1385‚Üí    this.phaseTime = 0;
  1386‚Üí
  1387‚Üí    switch (newPhase) {
  1388‚Üí      case &#x27;courtyard&#x27;:
  1389‚Üí        this.sendCommsMessage(&#x27;courtyard_entry&#x27;, {
  1390‚Üí          sender: &#x27;PROMETHEUS A.I.&#x27;,
  1391‚Üí          callsign: &#x27;ATHENA&#x27;,
  1392‚Üí          portrait: &#x27;ai&#x27;,
  1393‚Üí          text: &#x27;Signs of heavy combat. Recommend searching Command Center for mission logs.&#x27;,
  1394‚Üí        });
  1395‚Üí        this.setObjective(new Vector3(0, 0, 25)); // Command center
  1396‚Üí        break;
  1397‚Üí
  1398‚Üí      case &#x27;investigation&#x27;:
  1399‚Üí        this.callbacks.onObjectiveUpdate(
  1400‚Üí          &#x27;ACCESS COMMAND LOGS&#x27;,
  1401‚Üí          &#x27;Find the terminal in the Command Center.&#x27;
  1402‚Üí        );
  1403‚Üí        break;
  1404‚Üí
  1405‚Üí      case &#x27;ambush&#x27;:
  1406‚Üí        this.triggerAmbush();
  1407‚Üí        break;
  1408‚Üí
  1409‚Üí      case &#x27;discovery&#x27;:
  1410‚Üí        // Objective already set in accessLogs
  1411‚Üí        break;
  1412‚Üí
  1413‚Üí      case &#x27;exit&#x27;:
  1414‚Üí        this.clearObjective();
  1415‚Üí        break;
  1416‚Üí    }
  1417‚Üí  }
  1418‚Üí
  1419‚Üí  private triggerAmbush(): void {
  1420‚Üí    if (this.ambushTriggered) return;
  1421‚Üí    this.ambushTriggered = true;
  1422‚Üí
  1423‚Üí    this.callbacks.onNotification(&#x27;HOSTILES DETECTED!&#x27;, 2000);
  1424‚Üí    this.callbacks.onCombatStateChange(true);
  1425‚Üí
  1426‚Üí    this.sendCommsMessage(&#x27;ambush&#x27;, {
  1427‚Üí      sender: &#x27;PROMETHEUS A.I.&#x27;,
  1428‚Üí      callsign: &#x27;ATHENA&#x27;,
  1429‚Üí      portrait: &#x27;ai&#x27;,
  1430‚Üí      text: &#x27;Multiple hostile signatures converging on your position! They were hiding in the tunnels!&#x27;,
  1431‚Üí    });
  1432‚Üí
  1433‚Üí    // Spawn enemies from dark corners of the base
  1434‚Üí    const spawnPoints = [
  1435‚Üí      new Vector3(-30, 0, -20), // Behind barracks
  1436‚Üí      new Vector3(30, 0, -25), // Vehicle bay entrance
  1437‚Üí      new Vector3(-25, 0, 15), // Command center side
  1438‚Üí      new Vector3(20, 0, 30), // Courtyard corner
  1439‚Üí      new Vector3(0, 0, -40), // Underground entrance
  1440‚Üí    ];
  1441‚Üí
  1442‚Üí    // Materials for fallback procedural enemies
  1443‚Üí    const enemyMat = new StandardMaterial(&#x27;ambushEnemyMat&#x27;, this.scene);
  1444‚Üí    enemyMat.diffuseColor = new Color3(0.2, 0.15, 0.25);
  1445‚Üí    enemyMat.specularColor = new Color3(0.1, 0.1, 0.1);
  1446‚Üí
  1447‚Üí    const glowMat = new StandardMaterial(&#x27;enemyGlowMat&#x27;, this.scene);
  1448‚Üí    glowMat.emissiveColor = Color3.FromHexString(&#x27;#4AFF9F&#x27;);
  1449‚Üí    glowMat.disableLighting = true;
  1450‚Üí
  1451‚Üí    for (let i = 0; i &lt; this.maxEnemies; i++) {
  1452‚Üí      const spawnPos = spawnPoints[i % spawnPoints.length].clone();
  1453‚Üí      spawnPos.x += (Math.random() - 0.5) * 10;
  1454‚Üí      spawnPos.z += (Math.random() - 0.5) * 10;
  1455‚Üí
  1456‚Üí      // Try GLB model first
  1457‚Üí      let enemyMesh: Mesh | TransformNode;
  1458‚Üí      const assetName = SPECIES_TO_ASSET[AMBUSH_ENEMY_SPECIES];
  1459‚Üí
  1460‚Üí      if (this.ambushEnemiesPreloaded &amp;&amp; assetName) {
  1461‚Üí        const glbInstance = AssetManager.createInstance(
  1462‚Üí          &#x27;aliens&#x27;,
  1463‚Üí          assetName,
  1464‚Üí          `ambushEnemy_${i}`,
  1465‚Üí          this.scene
  1466‚Üí        );
  1467‚Üí
  1468‚Üí        if (glbInstance) {
  1469‚Üí          glbInstance.scaling.setAll(AMBUSH_ENEMY_SCALE);
  1470‚Üí          enemyMesh = glbInstance;
  1471‚Üí          console.log(`[FOBDelta] Created GLB enemy instance ${i} (${assetName})`);
  1472‚Üí        } else {
  1473‚Üí          // Fallback to procedural
  1474‚Üí          enemyMesh = this.createProceduralEnemy(i, enemyMat, glowMat);
  1475‚Üí        }
  1476‚Üí      } else {
  1477‚Üí        // Fallback to procedural
  1478‚Üí        enemyMesh = this.createProceduralEnemy(i, enemyMat, glowMat);
  1479‚Üí      }
  1480‚Üí
  1481‚Üí      enemyMesh.position = spawnPos.clone();
  1482‚Üí      enemyMesh.position.y = 1;
  1483‚Üí
  1484‚Üí      // Spawn animation
  1485‚Üí      enemyMesh.scaling.setAll(0.1);
  1486‚Üí      const targetScale = this.ambushEnemiesPreloaded ? AMBUSH_ENEMY_SCALE : 1;
  1487‚Üí      const spawnStart = performance.now();
  1488‚Üí      const animateSpawn = () =&gt; {
  1489‚Üí        const elapsed = performance.now() - spawnStart;
  1490‚Üí        const progress = Math.min(elapsed / 500, 1);
  1491‚Üí        enemyMesh.scaling.setAll(0.1 + progress * (targetScale - 0.1));
  1492‚Üí        if (progress &lt; 1) requestAnimationFrame(animateSpawn);
  1493‚Üí      };
  1494‚Üí      requestAnimationFrame(animateSpawn);
  1495‚Üí
  1496‚Üí      this.enemies.push({
  1497‚Üí        mesh: enemyMesh,
  1498‚Üí        health: 60,
  1499‚Üí        position: spawnPos,
  1500‚Üí        state: &#x27;chase&#x27;,
  1501‚Üí        attackCooldown: 0,
  1502‚Üí      });
  1503‚Üí    }
  1504‚Üí
  1505‚Üí    this.enemyCount = this.maxEnemies;
  1506‚Üí  }
  1507‚Üí
  1508‚Üí  /**
  1509‚Üí   * Create a procedural fallback enemy mesh
  1510‚Üí   */
  1511‚Üí  private createProceduralEnemy(
  1512‚Üí    index: number,
  1513‚Üí    enemyMat: StandardMaterial,
  1514‚Üí    glowMat: StandardMaterial
  1515‚Üí  ): Mesh {
  1516‚Üí    console.log(`[FOBDelta] Creating procedural enemy ${index} (GLB not available)`);
  1517‚Üí
  1518‚Üí    // Create lurker-style enemy mesh (tall, thin horrors from the shadows)
  1519‚Üí    const body = MeshBuilder.CreateCapsule(
  1520‚Üí      `ambushEnemy_${index}`,
  1521‚Üí      { height: 2, radius: 0.3 },
  1522‚Üí      this.scene
  1523‚Üí    );
  1524‚Üí    body.material = enemyMat;
  1525‚Üí
  1526‚Üí    // Glowing eyes
  1527‚Üí    const leftEye = MeshBuilder.CreateSphere(&#x27;eye&#x27;, { diameter: 0.08 }, this.scene);
  1528‚Üí    leftEye.material = glowMat;
  1529‚Üí    leftEye.parent = body;
  1530‚Üí    leftEye.position.set(-0.1, 0.7, -0.25);
  1531‚Üí
  1532‚Üí    const rightEye = MeshBuilder.CreateSphere(&#x27;eye&#x27;, { diameter: 0.08 }, this.scene);
  1533‚Üí    rightEye.material = glowMat;
  1534‚Üí    rightEye.parent = body;
  1535‚Üí    rightEye.position.set(0.1, 0.7, -0.25);
  1536‚Üí
  1537‚Üí    return body;
  1538‚Üí  }
  1539‚Üí
  1540‚Üí  private checkAreaTriggers(): void {
  1541‚Üí    const playerPos = this.camera.position;
  1542‚Üí
  1543‚Üí    for (const zone of this.areaZones) {
  1544‚Üí      if (zone.triggered) continue;
  1545‚Üí
  1546‚Üí      const dist = Vector3.Distance(new Vector3(playerPos.x, 0, playerPos.z), zone.center);
  1547‚Üí
  1548‚Üí      if (dist &lt; zone.radius) {
  1549‚Üí        zone.triggered = true;
  1550‚Üí        this.onEnterArea(zone.id);
  1551‚Üí      }
  1552‚Üí    }
  1553‚Üí  }
  1554‚Üí
  1555‚Üí  private onEnterArea(areaId: string): void {
  1556‚Üí    switch (areaId) {
  1557‚Üí      case &#x27;perimeter&#x27;:
  1558‚Üí        // Already handled in start
  1559‚Üí        break;
  1560‚Üí
  1561‚Üí      case &#x27;courtyard&#x27;:
  1562‚Üí        if (this.phase === &#x27;approach&#x27;) {
  1563‚Üí          this.transitionToPhase(&#x27;courtyard&#x27;);
  1564‚Üí        }
  1565‚Üí        break;
  1566‚Üí
  1567‚Üí      case &#x27;barracks&#x27;:
  1568‚Üí        this.sendCommsMessage(&#x27;barracks_entry&#x27;, {
  1569‚Üí          sender: &#x27;PROMETHEUS A.I.&#x27;,
  1570‚Üí          callsign: &#x27;ATHENA&#x27;,
  1571‚Üí          portrait: &#x27;ai&#x27;,
  1572‚Üí          text: &#x27;Barracks area. Signs of struggle. No survivors detected.&#x27;,
  1573‚Üí        });
  1574‚Üí        break;
  1575‚Üí
  1576‚Üí      case &#x27;command&#x27;:
  1577‚Üí        if (this.phase === &#x27;courtyard&#x27;) {
  1578‚Üí          this.transitionToPhase(&#x27;investigation&#x27;);
  1579‚Üí        }
  1580‚Üí        break;
  1581‚Üí
  1582‚Üí      case &#x27;vehiclebay&#x27;:
  1583‚Üí        this.sendCommsMessage(&#x27;vehiclebay_entry&#x27;, {
  1584‚Üí          sender: &#x27;PROMETHEUS A.I.&#x27;,
  1585‚Üí          callsign: &#x27;ATHENA&#x27;,
  1586‚Üí          portrait: &#x27;ai&#x27;,
  1587‚Üí          text: &quot;Vehicle Bay. That&#x27;s... that&#x27;s Corporal Cole&#x27;s TITAN. The mech is powered down but intact.&quot;,
  1588‚Üí        });
  1589‚Üí
  1590‚Üí        // Trigger ambush if not already done and logs accessed
  1591‚Üí        if (this.logsAccessed &amp;&amp; !this.ambushTriggered) {
  1592‚Üí          setTimeout(() =&gt; {
  1593‚Üí            this.transitionToPhase(&#x27;ambush&#x27;);
  1594‚Üí          }, 3000);
  1595‚Üí        }
  1596‚Üí        break;
  1597‚Üí
  1598‚Üí      case &#x27;hatch&#x27;:
  1599‚Üí        if (this.phase === &#x27;discovery&#x27; || this.phase === &#x27;exit&#x27;) {
  1600‚Üí          // Near the exit
  1601‚Üí          if (this.hatchOpen) {
  1602‚Üí            this.callbacks.onNotification(&#x27;PRESS E TO ENTER TUNNELS&#x27;, 2000);
  1603‚Üí          }
  1604‚Üí        }
  1605‚Üí        break;
  1606‚Üí    }
  1607‚Üí  }
  1608‚Üí
  1609‚Üí  protected override handleKeyDown(e: KeyboardEvent): void {
  1610‚Üí    super.handleKeyDown(e);
  1611‚Üí
  1612‚Üí    // Get keybindings for action mapping
  1613‚Üí    const interactKey = this.inputTracker.getKeyForAction(&#x27;interact&#x27;);
  1614‚Üí    const fireKey = this.inputTracker.getKeyForAction(&#x27;fire&#x27;);
  1615‚Üí
  1616‚Üí    // Handle action keys - some are level-specific (F, T, V, R), others use keybindings
  1617‚Üí    switch (e.code) {
  1618‚Üí      case &#x27;KeyF&#x27;:
  1619‚Üí        this.toggleFlashlight();
  1620‚Üí        break;
  1621‚Üí      case &#x27;KeyT&#x27;:
  1622‚Üí        this.activateScanner();
  1623‚Üí        break;
  1624‚Üí      case &#x27;KeyV&#x27;:
  1625‚Üí        // Melee attack
  1626‚Üí        this.meleeAttack();
  1627‚Üí        break;
  1628‚Üí      case &#x27;KeyR&#x27;:
  1629‚Üí        // Reload weapon
  1630‚Üí        this.handleReload();
  1631‚Üí        break;
  1632‚Üí    }
  1633‚Üí
  1634‚Üí    // Handle interact action (configurable keybinding)
  1635‚Üí    if (e.code === interactKey) {
  1636‚Üí      // Check for level exit
  1637‚Üí      if (this.hatchOpen &amp;&amp; this.undergroundHatch) {
  1638‚Üí        const dist = Vector3.Distance(this.camera.position, this.undergroundHatch.position);
  1639‚Üí        if (dist &lt; 3) {
  1640‚Üí          this.completeLevel();
  1641‚Üí          return;
  1642‚Üí        }
  1643‚Üí      }
  1644‚Üí      this.tryInteract();
  1645‚Üí    }
  1646‚Üí
  1647‚Üí    // Handle fire action (configurable keybinding, for non-mouse bindings)
  1648‚Üí    if (e.code === fireKey &amp;&amp; !fireKey.startsWith(&#x27;Mouse&#x27;)) {
  1649‚Üí      this.firePrimaryWeapon();
  1650‚Üí    }
  1651‚Üí  }
  1652‚Üí
  1653‚Üí  protected override handleClick(): void {
  1654‚Üí    super.handleClick();
  1655‚Üí
  1656‚Üí    // Fire weapon when pointer is locked (in game)
  1657‚Üí    if (this.isPointerLocked()) {
  1658‚Üí      this.firePrimaryWeapon();
  1659‚Üí    }
  1660‚Üí  }
  1661‚Üí
  1662‚Üí  protected updateLevel(deltaTime: number): void {
  1663‚Üí    this.phaseTime += deltaTime;
  1664‚Üí
  1665‚Üí    // Update flashlight position
  1666‚Üí    if (this.flashlight) {
  1667‚Üí      this.flashlight.position.copyFrom(this.camera.position);
  1668‚Üí    }
  1669‚Üí
  1670‚Üí    // Update flickering lights
  1671‚Üí    this.updateFlickerLights(deltaTime);
  1672‚Üí
  1673‚Üí    // Check area triggers
  1674‚Üí    this.checkAreaTriggers();
  1675‚Üí
  1676‚Üí    // Update action buttons (for interact prompts)
  1677‚Üí    this.updateActionButtons();
  1678‚Üí
  1679‚Üí    // Update enemies (ambush AI)
  1680‚Üí    this.updateEnemies(deltaTime);
  1681‚Üí
  1682‚Üí    // Update combat cooldowns
  1683‚Üí    if (this.meleeCooldown &gt; 0) {
  1684‚Üí      this.meleeCooldown -= deltaTime * 1000;
  1685‚Üí    }
  1686‚Üí    if (this.primaryFireCooldown &gt; 0) {
  1687‚Üí      this.primaryFireCooldown -= deltaTime * 1000;
  1688‚Üí    }
  1689‚Üí
  1690‚Üí    // Animate objective marker
  1691‚Üí    if (this.objectiveMarker?.isVisible) {
  1692‚Üí      this.objectiveMarker.rotation.y += deltaTime * 2;
  1693‚Üí      const pulse = 0.4 + Math.sin(performance.now() * 0.003) * 0.2;
  1694‚Üí      (this.objectiveMarker.material as StandardMaterial).alpha = pulse;
  1695‚Üí    }
  1696‚Üí
  1697‚Üí    // Animate mech eyes (subtle pulsing)
  1698‚Üí    if (this.mechEyeLight) {
  1699‚Üí      const eyePulse = 0.25 + Math.sin(performance.now() * 0.002) * 0.1;
  1700‚Üí      this.mechEyeLight.intensity = eyePulse;
  1701‚Üí    }
  1702‚Üí
  1703‚Üí    // Keep player at eye height
  1704‚Üí    this.camera.position.y = 1.7;
  1705‚Üí
  1706‚Üí    // Boundary constraints
  1707‚Üí    const bounds = 38;
  1708‚Üí    this.camera.position.x = Math.max(-bounds, Math.min(bounds, this.camera.position.x));
  1709‚Üí    this.camera.position.z = Math.max(-bounds, Math.min(bounds, this.camera.position.z));
  1710‚Üí  }
  1711‚Üí
  1712‚Üí  private updateEnemies(deltaTime: number): void {
  1713‚Üí    if (this.enemies.length === 0) return;
  1714‚Üí
  1715‚Üí    const playerPos = this.camera.position;
  1716‚Üí    const chaseSpeed = 4; // units per second
  1717‚Üí    const attackRange = 2.5;
  1718‚Üí    const attackDamage = 8;
  1719‚Üí    const attackCooldownTime = 1.5; // seconds
  1720‚Üí
  1721‚Üí    for (let i = this.enemies.length - 1; i &gt;= 0; i--) {
  1722‚Üí      const enemy = this.enemies[i];
  1723‚Üí
  1724‚Üí      // Skip dead enemies
  1725‚Üí      if (enemy.health &lt;= 0) {
  1726‚Üí        this.onEnemyKilled(enemy, i);
  1727‚Üí        continue;
  1728‚Üí      }
  1729‚Üí
  1730‚Üí      // Calculate distance to player
  1731‚Üí      const toPlayer = new Vector3(
  1732‚Üí        playerPos.x - enemy.mesh.position.x,
  1733‚Üí        0,
  1734‚Üí        playerPos.z - enemy.mesh.position.z
  1735‚Üí      );
  1736‚Üí      const distance = toPlayer.length();
  1737‚Üí
  1738‚Üí      // Update attack cooldown
  1739‚Üí      if (enemy.attackCooldown &gt; 0) {
  1740‚Üí        enemy.attackCooldown -= deltaTime;
  1741‚Üí      }
  1742‚Üí
  1743‚Üí      // State machine for enemy AI
  1744‚Üí      if (distance &lt; attackRange) {
  1745‚Üí        // In attack range
  1746‚Üí        enemy.state = &#x27;attack&#x27;;
  1747‚Üí
  1748‚Üí        // Face the player
  1749‚Üí        if (distance &gt; 0.1) {
  1750‚Üí          const angle = Math.atan2(toPlayer.x, toPlayer.z);
  1751‚Üí          enemy.mesh.rotation.y = angle;
  1752‚Üí        }
  1753‚Üí
  1754‚Üí        // Attack if cooldown is ready
  1755‚Üí        if (enemy.attackCooldown &lt;= 0) {
  1756‚Üí          this.onEnemyAttack(enemy, attackDamage);
  1757‚Üí          enemy.attackCooldown = attackCooldownTime;
  1758‚Üí        }
  1759‚Üí      } else {
  1760‚Üí        // Chase the player
  1761‚Üí        enemy.state = &#x27;chase&#x27;;
  1762‚Üí
  1763‚Üí        // Move toward player
  1764‚Üí        toPlayer.normalize();
  1765‚Üí        enemy.mesh.position.x += toPlayer.x * chaseSpeed * deltaTime;
  1766‚Üí        enemy.mesh.position.z += toPlayer.z * chaseSpeed * deltaTime;
  1767‚Üí        enemy.position.copyFrom(enemy.mesh.position);
  1768‚Üí
  1769‚Üí        // Face movement direction
  1770‚Üí        const angle = Math.atan2(toPlayer.x, toPlayer.z);
  1771‚Üí        enemy.mesh.rotation.y = angle;
  1772‚Üí
  1773‚Üí        // Subtle bobbing animation while moving
  1774‚Üí        enemy.mesh.position.y = 1 + Math.sin(performance.now() * 0.01) * 0.1;
  1775‚Üí      }
  1776‚Üí    }
  1777‚Üí  }
  1778‚Üí
  1779‚Üí  private onEnemyAttack(enemy: (typeof this.enemies)[0], damage: number): void {
  1780‚Üí    // Visual feedback - enemy lunges
  1781‚Üí    const originalY = enemy.mesh.position.y;
  1782‚Üí    enemy.mesh.position.y += 0.3;
  1783‚Üí    setTimeout(() =&gt; {
  1784‚Üí      if (enemy.mesh &amp;&amp; !enemy.mesh.isDisposed()) {
  1785‚Üí        enemy.mesh.position.y = originalY;
  1786‚Üí      }
  1787‚Üí    }, 150);
  1788‚Üí
  1789‚Üí    // Apply damage to player
  1790‚Üí    this.callbacks.onHealthChange(-damage);
  1791‚Üí
  1792‚Üí    // Screen shake effect
  1793‚Üí    this.triggerDamageShake(damage);
  1794‚Üí    this.callbacks.onNotification(&#x27;TAKING DAMAGE!&#x27;, 500);
  1795‚Üí  }
  1796‚Üí
  1797‚Üí  private onEnemyKilled(enemy: (typeof this.enemies)[0], index: number): void {
  1798‚Üí    this.killCount++;
  1799‚Üí    this.enemyCount--;
  1800‚Üí
  1801‚Üí    // Emit alien death particle effect (green goo burst)
  1802‚Üí    particleManager.emitAlienDeath(enemy.mesh.position.clone(), 1.2);
  1803‚Üí
  1804‚Üí    // Death animation - shrink and fade
  1805‚Üí    const deathStart = performance.now();
  1806‚Üí    const animateDeath = () =&gt; {
  1807‚Üí      const elapsed = performance.now() - deathStart;
  1808‚Üí      const progress = Math.min(elapsed / 300, 1);
  1809‚Üí
  1810‚Üí      if (enemy.mesh &amp;&amp; !enemy.mesh.isDisposed()) {
  1811‚Üí        enemy.mesh.scaling.setAll(1 - progress);
  1812‚Üí        enemy.mesh.position.y = 1 - progress * 0.5;
  1813‚Üí
  1814‚Üí        if (progress &gt;= 1) {
  1815‚Üí          enemy.mesh.dispose();
  1816‚Üí        } else {
  1817‚Üí          requestAnimationFrame(animateDeath);
  1818‚Üí        }
  1819‚Üí      }
  1820‚Üí    };
  1821‚Üí    requestAnimationFrame(animateDeath);
  1822‚Üí
  1823‚Üí    // Remove from array
  1824‚Üí    this.enemies.splice(index, 1);
  1825‚Üí
  1826‚Üí    // Check if all enemies defeated
  1827‚Üí    if (this.enemies.length === 0 &amp;&amp; this.ambushTriggered) {
  1828‚Üí      this.onAmbushCleared();
  1829‚Üí    }
  1830‚Üí  }
  1831‚Üí
  1832‚Üí  private onAmbushCleared(): void {
  1833‚Üí    this.callbacks.onCombatStateChange(false);
  1834‚Üí    this.callbacks.onNotification(&#x27;AREA CLEAR&#x27;, 2000);
  1835‚Üí
  1836‚Üí    setTimeout(() =&gt; {
  1837‚Üí      this.sendCommsMessage(&#x27;ambush_clear&#x27;, {
  1838‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
  1839‚Üí        callsign: &#x27;ATHENA&#x27;,
  1840‚Üí        portrait: &#x27;ai&#x27;,
  1841‚Üí        text: &#x27;Hostile contacts eliminated. Proceed to the underground access, Sergeant.&#x27;,
  1842‚Üí      });
  1843‚Üí    }, 1500);
  1844‚Üí  }
  1845‚Üí
  1846‚Üí  /**
  1847‚Üí   * Handle reload action
  1848‚Üí   */
  1849‚Üí  private handleReload(): void {
  1850‚Üí    const weaponActions = getWeaponActions();
  1851‚Üí    if (!weaponActions) return;
  1852‚Üí
  1853‚Üí    const state = weaponActions.getState();
  1854‚Üí    if (state.isReloading) {
  1855‚Üí      // Already reloading
  1856‚Üí      return;
  1857‚Üí    }
  1858‚Üí
  1859‚Üí    if (state.currentAmmo &gt;= state.maxMagazineSize) {
  1860‚Üí      this.callbacks.onNotification(&#x27;MAGAZINE FULL&#x27;, 800);
  1861‚Üí      return;
  1862‚Üí    }
  1863‚Üí
  1864‚Üí    if (state.reserveAmmo &lt;= 0) {
  1865‚Üí      this.callbacks.onNotification(&#x27;NO RESERVE AMMO&#x27;, 800);
  1866‚Üí      return;
  1867‚Üí    }
  1868‚Üí
  1869‚Üí    startReload();
  1870‚Üí    this.callbacks.onNotification(&#x27;RELOADING...&#x27;, 1500);
  1871‚Üí  }
  1872‚Üí
  1873‚Üí  /**
  1874‚Üí   * Melee attack - close range, high damage
  1875‚Üí   */
  1876‚Üí  private meleeAttack(): void {
  1877‚Üí    if (this.meleeCooldown &gt; 0) return;
  1878‚Üí    if (this.phase !== &#x27;ambush&#x27; || this.enemies.length === 0) return;
  1879‚Üí
  1880‚Üí    this.meleeCooldown = this.MELEE_COOLDOWN;
  1881‚Üí    this.callbacks.onNotification(&#x27;MELEE!&#x27;, 500);
  1882‚Üí
  1883‚Üí    const playerPos = this.camera.position;
  1884‚Üí    const forward = new Vector3(Math.sin(this.rotationY), 0, Math.cos(this.rotationY));
  1885‚Üí
  1886‚Üí    // Attack position is in front of the player
  1887‚Üí    const attackPos = playerPos.add(forward.scale(this.MELEE_RANGE / 2));
  1888‚Üí
  1889‚Üí    // Damage enemies in melee range
  1890‚Üí    const hitAny = this.damageEnemyAtPosition(attackPos, this.MELEE_DAMAGE, this.MELEE_RANGE);
  1891‚Üí
  1892‚Üí    if (hitAny) {
  1893‚Üí      this.callbacks.onNotification(&#x27;HIT!&#x27;, 300);
  1894‚Üí      this.callbacks.onKill(); // Trigger hit feedback
  1895‚Üí    }
  1896‚Üí  }
  1897‚Üí
  1898‚Üí  /**
  1899‚Üí   * Primary fire - ranged weapon attack (pistol/rifle)
  1900‚Üí   */
  1901‚Üí  private firePrimaryWeapon(): void {
  1902‚Üí    if (this.primaryFireCooldown &gt; 0) return;
  1903‚Üí    if (!this.isPointerLocked()) return;
  1904‚Üí
  1905‚Üí    // Only allow shooting during combat
  1906‚Üí    if (this.phase !== &#x27;ambush&#x27; || this.enemies.length === 0) return;
  1907‚Üí
  1908‚Üí    // Check ammo - use weapon system if available
  1909‚Üí    if (!fireWeapon()) {
  1910‚Üí      // No ammo - show notification and auto-start reload
  1911‚Üí      this.callbacks.onNotification(&#x27;NO AMMO - RELOADING&#x27;, 800);
  1912‚Üí      startReload();
  1913‚Üí      return;
  1914‚Üí    }
  1915‚Üí
  1916‚Üí    this.primaryFireCooldown = this.PRIMARY_FIRE_COOLDOWN;
  1917‚Üí
  1918‚Üí    const playerPos = this.camera.position;
  1919‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
  1920‚Üí
  1921‚Üí    // Check for enemy hits using simple ray-like detection
  1922‚Üí    let closestEnemy: (typeof this.enemies)[0] | null = null;
  1923‚Üí    let closestDist = this.PRIMARY_FIRE_RANGE;
  1924‚Üí
  1925‚Üí    for (const enemy of this.enemies) {
  1926‚Üí      if (enemy.health &lt;= 0) continue;
  1927‚Üí
  1928‚Üí      const toEnemy = enemy.mesh.position.subtract(playerPos);
  1929‚Üí      const dist = toEnemy.length();
  1930‚Üí
  1931‚Üí      if (dist &gt; this.PRIMARY_FIRE_RANGE) continue;
  1932‚Üí
  1933‚Üí      // Check if enemy is in line of fire (dot product)
  1934‚Üí      const dot = Vector3.Dot(toEnemy.normalize(), forward);
  1935‚Üí      const crossDist = Math.sqrt(1 - dot * dot) * dist;
  1936‚Üí
  1937‚Üí      // Enemy must be in front and within a narrow cone
  1938‚Üí      if (dot &gt; 0.9 &amp;&amp; crossDist &lt; 1.0 &amp;&amp; dist &lt; closestDist) {
  1939‚Üí        closestEnemy = enemy;
  1940‚Üí        closestDist = dist;
  1941‚Üí      }
  1942‚Üí    }
  1943‚Üí
  1944‚Üí    if (closestEnemy) {
  1945‚Üí      // Hit the enemy
  1946‚Üí      closestEnemy.health -= this.PRIMARY_FIRE_DAMAGE;
  1947‚Üí
  1948‚Üí      // Visual hit feedback - flash the enemy red
  1949‚Üí      this.flashEnemyRed(closestEnemy.mesh);
  1950‚Üí
  1951‚Üí      this.callbacks.onNotification(&#x27;HIT!&#x27;, 200);
  1952‚Üí    }
  1953‚Üí
  1954‚Üí    // Create muzzle flash effect
  1955‚Üí    this.createMuzzleFlash();
  1956‚Üí  }
  1957‚Üí
  1958‚Üí  /**
  1959‚Üí   * Create a brief muzzle flash visual effect using particle system
  1960‚Üí   */
  1961‚Üí  private createMuzzleFlash(): void {
  1962‚Üí    // Position slightly in front of camera
  1963‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
  1964‚Üí    const flashPos = this.camera.position.add(forward.scale(0.5));
  1965‚Üí
  1966‚Üí    // Emit particle muzzle flash
  1967‚Üí    particleManager.emitMuzzleFlash(flashPos, forward);
  1968‚Üí
  1969‚Üí    // Also keep the point light flash for additional visual impact
  1970‚Üí    const flashLight = new PointLight(&#x27;muzzleFlash&#x27;, flashPos, this.scene);
  1971‚Üí    flashLight.diffuse = new Color3(1, 0.8, 0.4);
  1972‚Üí    flashLight.intensity = 2;
  1973‚Üí    flashLight.range = 10;
  1974‚Üí
  1975‚Üí    // Fade out quickly
  1976‚Üí    const startTime = performance.now();
  1977‚Üí    const animateFlash = () =&gt; {
  1978‚Üí      const elapsed = performance.now() - startTime;
  1979‚Üí      const progress = Math.min(elapsed / 80, 1);
  1980‚Üí      flashLight.intensity = 2 * (1 - progress);
  1981‚Üí
  1982‚Üí      if (progress &lt; 1) {
  1983‚Üí        requestAnimationFrame(animateFlash);
  1984‚Üí      } else {
  1985‚Üí        flashLight.dispose();
  1986‚Üí      }
  1987‚Üí    };
  1988‚Üí    requestAnimationFrame(animateFlash);
  1989‚Üí  }
  1990‚Üí
  1991‚Üí  /**
  1992‚Üí   * Handle damage to enemies from player attacks
  1993‚Üí   */
  1994‚Üí  public damageEnemyAtPosition(position: Vector3, damage: number, radius: number = 2): boolean {
  1995‚Üí    let hitAny = false;
  1996‚Üí
  1997‚Üí    for (const enemy of this.enemies) {
  1998‚Üí      const dist = Vector3.Distance(position, enemy.mesh.position);
  1999‚Üí      if (dist &lt; radius) {
  2000‚Üí        enemy.health -= damage;
  2001‚Üí        hitAny = true;
  2002‚Üí
  2003‚Üí        // Emit blood/splatter particle effect at enemy position
  2004‚Üí        particleManager.emitAlienSplatter(enemy.mesh.position, 0.8);
  2005‚Üí
  2006‚Üí        // Visual hit feedback - flash red
  2007‚Üí        this.flashEnemyRed(enemy.mesh);
  2008‚Üí      }
  2009‚Üí    }
  2010‚Üí
  2011‚Üí    return hitAny;
  2012‚Üí  }
  2013‚Üí
  2014‚Üí  /**
  2015‚Üí   * Flash an enemy mesh red when hit (works with both Mesh and TransformNode)
  2016‚Üí   */
  2017‚Üí  private flashEnemyRed(mesh: Mesh | TransformNode): void {
  2018‚Üí    // For a direct Mesh with material
  2019‚Üí    if (&#x27;material&#x27; in mesh &amp;&amp; mesh.material instanceof StandardMaterial) {
  2020‚Üí      const mat = mesh.material;
  2021‚Üí      const origColor = mat.diffuseColor.clone();
  2022‚Üí      mat.diffuseColor = new Color3(1, 0.2, 0.2);
  2023‚Üí      setTimeout(() =&gt; {
  2024‚Üí        try {
  2025‚Üí          mat.diffuseColor = origColor;
  2026‚Üí        } catch {
  2027‚Üí          // Material already disposed
  2028‚Üí        }
  2029‚Üí      }, 100);
  2030‚Üí      return;
  2031‚Üí    }
  2032‚Üí
  2033‚Üí    // For TransformNode (GLB instance), find child meshes
  2034‚Üí    const children = mesh.getChildMeshes();
  2035‚Üí    for (const child of children) {
  2036‚Üí      if (child.material instanceof StandardMaterial) {
  2037‚Üí        const mat = child.material;
  2038‚Üí        const origColor = mat.diffuseColor.clone();
  2039‚Üí        mat.diffuseColor = new Color3(1, 0.2, 0.2);
  2040‚Üí        setTimeout(() =&gt; {
  2041‚Üí          try {
  2042‚Üí            mat.diffuseColor = origColor;
  2043‚Üí          } catch {
  2044‚Üí            // Material already disposed
  2045‚Üí          }
  2046‚Üí        }, 100);
  2047‚Üí      }
  2048‚Üí    }
  2049‚Üí  }
  2050‚Üí
  2051‚Üí  private updateFlickerLights(deltaTime: number): void {
  2052‚Üí    for (const fl of this.flickerLights) {
  2053‚Üí      fl.timer += deltaTime * fl.flickerSpeed;
  2054‚Üí
  2055‚Üí      if (fl.isOff) {
  2056‚Üí        fl.offTimer += deltaTime;
  2057‚Üí        if (fl.offTimer &gt;= fl.offDuration) {
  2058‚Üí          fl.isOff = false;
  2059‚Üí          fl.offTimer = 0;
  2060‚Üí        }
  2061‚Üí        fl.light.intensity = 0;
  2062‚Üí      } else {
  2063‚Üí        // Random chance to turn off
  2064‚Üí        if (Math.random() &lt; 0.002 * fl.flickerAmount) {
  2065‚Üí          fl.isOff = true;
  2066‚Üí          fl.offDuration = 0.1 + Math.random() * 0.5;
  2067‚Üí        }
  2068‚Üí
  2069‚Üí        // Flickering intensity
  2070‚Üí        const noise = Math.sin(fl.timer) * Math.sin(fl.timer * 2.3) * Math.sin(fl.timer * 0.7);
  2071‚Üí        fl.light.intensity = fl.baseIntensity + noise * fl.flickerAmount * fl.baseIntensity;
  2072‚Üí        fl.light.intensity = Math.max(0, fl.light.intensity);
  2073‚Üí      }
  2074‚Üí    }
  2075‚Üí  }
  2076‚Üí
  2077‚Üí  override canTransitionTo(levelId: LevelId): boolean {
  2078‚Üí    return levelId === &#x27;brothers_in_arms&#x27; &amp;&amp; this.phase === &#x27;exit&#x27; &amp;&amp; this.hatchOpen;
  2079‚Üí  }
  2080‚Üí
  2081‚Üí  protected disposeLevel(): void {
  2082‚Üí    // Unregister action handler
  2083‚Üí    this.callbacks.onActionHandlerRegister(null);
  2084‚Üí    this.callbacks.onActionGroupsChange([]);
  2085‚Üí
  2086‚Üí    // Dispose flicker lights
  2087‚Üí    for (const fl of this.flickerLights) {
  2088‚Üí      fl.light.dispose();
  2089‚Üí    }
  2090‚Üí    this.flickerLights = [];
  2091‚Üí
  2092‚Üí    // Dispose enemies
  2093‚Üí    for (const enemy of this.enemies) {
  2094‚Üí      enemy.mesh.dispose();
  2095‚Üí    }
  2096‚Üí    this.enemies = [];
  2097‚Üí
  2098‚Üí    // Dispose alien vehicle wrecks
  2099‚Üí    for (const vehicle of this.alienVehicles) {
  2100‚Üí      vehicle.dispose();
  2101‚Üí    }
  2102‚Üí    this.alienVehicles = [];
  2103‚Üí
  2104‚Üí    // Dispose special lights
  2105‚Üí    this.terminalLight?.dispose();
  2106‚Üí    this.mechEyeLight?.dispose();
  2107‚Üí    this.flashlight?.dispose();
  2108‚Üí    this.horrorAmbient?.dispose();
  2109‚Üí
  2110‚Üí    // Dispose materials
  2111‚Üí    for (const mat of this.materials.values()) {
  2112‚Üí      mat.dispose();
  2113‚Üí    }
  2114‚Üí    this.materials.clear();
  2115‚Üí
  2116‚Üí    // Dispose all meshes
  2117‚Üí    for (const mesh of this.allMeshes) {
  2118‚Üí      mesh.dispose();
  2119‚Üí    }
  2120‚Üí    this.allMeshes = [];
  2121‚Üí
  2122‚Üí    // Dispose root
  2123‚Üí    this.fobRoot?.dispose();
  2124‚Üí    this.fobRoot = null;
  2125‚Üí
  2126‚Üí    // Clear references
  2127‚Üí    this.terminal = null;
  2128‚Üí    this.mechMesh = null;
  2129‚Üí    this.undergroundHatch = null;
  2130‚Üí    this.objectiveMarker = null;
  2131‚Üí  }
  2132‚Üí}
  2133‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-48-879Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-48-879Z" class="timestamp-link"><time datetime="2026-01-30T06:44:48.879Z" data-timestamp="2026-01-30T06:44:48.879Z">2026-01-30T06:44:48.879Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01NaxgUurgzzFVWhRmxD9JFz"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/TheBreachLevel.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-49-027Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-49-027Z" class="timestamp-link"><time datetime="2026-01-30T06:44:49.027Z" data-timestamp="2026-01-30T06:44:49.027Z">2026-01-30T06:44:49.027Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * TheBreachLevel - Underground Hive Tunnels with Queen Boss Fight
     3‚Üí *
     4‚Üí * LEVEL STRUCTURE:
     5‚Üí * 1. UPPER HIVE (0-50m depth) - Linear tunnels, drones
     6‚Üí * 2. MID HIVE (50-100m) - Branching tunnels, grunts/spitters, acid pools
     7‚Üí * 3. LOWER HIVE (100-150m) - Large chambers, egg clusters, all enemy types
     8‚Üí * 4. QUEEN&#x27;S CHAMBER - 200m cavern, boss fight
     9‚Üí *
    10‚Üí * FEATURES:
    11‚Üí * - Organic tunnel environment with bioluminescent lighting
    12‚Üí * - Environmental hazards (acid pools, egg clusters, pheromone clouds)
    13‚Üí * - Progressive enemy density increase
    14‚Üí * - 3-phase Queen boss fight with weak point mechanic
    15‚Üí * - Death sequence triggers escape to extraction level
    16‚Üí */
    17‚Üí
    18‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    19‚Üíimport { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    20‚Üíimport { Color3, type Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    21‚Üíimport { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    22‚Üíimport type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    23‚Üíimport { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    24‚Üíimport { getAchievementManager } from &#x27;../../achievements&#x27;;
    25‚Üíimport { fireWeapon, getWeaponActions, startReload } from &#x27;../../context/useWeaponActions&#x27;;
    26‚Üíimport { AssetManager } from &#x27;../../core/AssetManager&#x27;;
    27‚Üíimport { particleManager } from &#x27;../../effects/ParticleManager&#x27;;
    28‚Üíimport { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    29‚Üíimport { BaseLevel } from &#x27;../BaseLevel&#x27;;
    30‚Üíimport type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    31‚Üíimport {
    32‚Üí  COMMS_BOSS_DEATH,
    33‚Üí  COMMS_BOSS_DETECTED,
    34‚Üí  COMMS_BOSS_PHASE_2,
    35‚Üí  COMMS_BOSS_PHASE_3,
    36‚Üí  COMMS_LEVEL_START,
    37‚Üí  NOTIFICATIONS,
    38‚Üí  OBJECTIVES,
    39‚Üí} from &#x27;./comms&#x27;;
    40‚Üí// Import from subpackage modules
    41‚Üíimport {
    42‚Üí  COLORS,
    43‚Üí  DAMAGE_INVINCIBILITY_MS,
    44‚Üí  GRENADE_COOLDOWN,
    45‚Üí  GRENADE_MAX_DAMAGE,
    46‚Üí  GRENADE_RADIUS,
    47‚Üí  MELEE_COOLDOWN,
    48‚Üí  MELEE_DAMAGE,
    49‚Üí  MELEE_RANGE,
    50‚Üí  PLAYER_MAX_HEALTH,
    51‚Üí  STARTING_GRENADES,
    52‚Üí  TUNNEL_DIAMETER,
    53‚Üí  TUNNEL_SEGMENT_LENGTH,
    54‚Üí  WEAK_POINT_COOLDOWN,
    55‚Üí  WEAK_POINT_DURATION,
    56‚Üí} from &#x27;./constants&#x27;;
    57‚Üíimport {
    58‚Üí  checkEnemyHit,
    59‚Üí  damageEnemy,
    60‚Üí  disposeEnemies,
    61‚Üí  getEnemyAttackDamage,
    62‚Üí  getInitialSpawnConfig,
    63‚Üí  preloadEnemyModels,
    64‚Üí  spawnEnemy,
    65‚Üí  updateEnemyAI,
    66‚Üí} from &#x27;./enemies&#x27;;
    67‚Üíimport { HiveEnvironmentBuilder, updateBiolights } from &#x27;./environment&#x27;;
    68‚Üíimport {
    69‚Üí  checkAcidPoolDamage,
    70‚Üí  checkEggClusterTrigger,
    71‚Üí  checkPheromoneCloud,
    72‚Üí  HazardBuilder,
    73‚Üí} from &#x27;./hazards&#x27;;
    74‚Üíimport {
    75‚Üí  animateClawSwipe,
    76‚Üí  animateQueen,
    77‚Üí  calculateQueenDamage,
    78‚Üí  createQueen,
    79‚Üí  disposeQueen,
    80‚Üí  getAvailableAttacks,
    81‚Üí  getPhaseMultiplier,
    82‚Üí  getQueenPhase,
    83‚Üí  getSpawnCooldown,
    84‚Üí  getSpawnCount,
    85‚Üí  getSpawnType,
    86‚Üí} from &#x27;./queen&#x27;;
    87‚Üíimport type { Enemy, HiveZone, LevelPhase, Queen, QueenPhase } from &#x27;./types&#x27;;
    88‚Üí
    89‚Üí// ============================================================================
    90‚Üí// LEVEL CLASS
    91‚Üí// ============================================================================
    92‚Üí
    93‚Üíexport class TheBreachLevel extends BaseLevel {
    94‚Üí  // Level state
    95‚Üí  private phase: LevelPhase = &#x27;exploration&#x27;;
    96‚Üí  private currentZone: HiveZone = &#x27;upper&#x27;;
    97‚Üí  private depth = 0;
    98‚Üí
    99‚Üí  // Environment builders
   100‚Üí  private environmentBuilder: HiveEnvironmentBuilder | null = null;
   101‚Üí  private hazardBuilder: HazardBuilder | null = null;
   102‚Üí
   103‚Üí  // Queen boss
   104‚Üí  private queen: Queen | null = null;
   105‚Üí  private queenArena: Mesh | null = null;
   106‚Üí  private queenDoorMesh: Mesh | null = null;
   107‚Üí  private queenDefeated = false;
   108‚Üí
   109‚Üí  // Enemies
   110‚Üí  private enemies: Enemy[] = [];
   111‚Üí  private enemiesKilled = 0;
   112‚Üí
   113‚Üí  // Player state
   114‚Üí  private playerHealth = PLAYER_MAX_HEALTH;
   115‚Üí  private lastDamageTime = 0;
   116‚Üí  private grenadeCount = STARTING_GRENADES;
   117‚Üí  private grenadeCooldown = 0;
   118‚Üí  private meleeCooldown = 0;
   119‚Üí  private scanCooldown = 0;
   120‚Üí
   121‚Üí  // Screen effects
   122‚Üí  private screenFlash = 0;
   123‚Üí  private screenFlashColor = new Color3(1, 1, 1);
   124‚Üí
   125‚Üí  // Action callback
   126‚Üí  private actionCallback: ((actionId: string) =&gt; void) | null = null;
   127‚Üí
   128‚Üí  // Timers
   129‚Üí  private phaseTimer = 0;
   130‚Üí  private escapeTimer = 0;
   131‚Üí
   132‚Üí  constructor(
   133‚Üí    engine: Engine,
   134‚Üí    canvas: HTMLCanvasElement,
   135‚Üí    config: LevelConfig,
   136‚Üí    callbacks: LevelCallbacks
   137‚Üí  ) {
   138‚Üí    super(engine, canvas, config, callbacks);
   139‚Üí  }
   140‚Üí
   141‚Üí  protected getBackgroundColor(): Color4 {
   142‚Üí    return COLORS.background;
   143‚Üí  }
   144‚Üí
   145‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   146‚Üí    // Initialize environment builder
   147‚Üí    this.environmentBuilder = new HiveEnvironmentBuilder(this.scene);
   148‚Üí    this.environmentBuilder.setupGlowLayer();
   149‚Üí
   150‚Üí    // Override lighting for dark hive atmosphere
   151‚Üí    this.setupHiveLighting();
   152‚Üí
   153‚Üí    // Initialize AssetManager and particle manager
   154‚Üí    AssetManager.init(this.scene);
   155‚Üí    particleManager.init(this.scene);
   156‚Üí
   157‚Üí    // Load assets
   158‚Üí    await this.environmentBuilder.loadHiveStructures();
   159‚Üí    await this.environmentBuilder.loadCapturedVehicles();
   160‚Üí
   161‚Üí    // Build the hive structure
   162‚Üí    this.createUpperHive();
   163‚Üí    this.createMidHive();
   164‚Üí    this.createLowerHive();
   165‚Üí    this.createQueenChamber();
   166‚Üí
   167‚Üí    // Place hive structures and vehicles
   168‚Üí    this.placeHiveStructures();
   169‚Üí    this.placeCapturedVehicles();
   170‚Üí
   171‚Üí    // Initialize hazard builder
   172‚Üí    this.hazardBuilder = new HazardBuilder(this.scene, this.environmentBuilder.getGlowLayer());
   173‚Üí    this.hazardBuilder.createStandardAcidPools();
   174‚Üí    this.hazardBuilder.createStandardEggClusters();
   175‚Üí
   176‚Üí    // Preload enemy GLB models before spawning
   177‚Üí    await preloadEnemyModels(this.scene);
   178‚Üí
   179‚Üí    // Spawn initial enemies (now using GLB models)
   180‚Üí    this.spawnInitialEnemies();
   181‚Üí
   182‚Üí    // Setup player
   183‚Üí    this.camera.position.set(0, 1.7, 0);
   184‚Üí    this.callbacks.onHealthChange(this.playerHealth);
   185‚Üí
   186‚Üí    // Start level
   187‚Üí    this.startLevel();
   188‚Üí  }
   189‚Üí
   190‚Üí  private setupHiveLighting(): void {
   191‚Üí    if (this.sunLight) {
   192‚Üí      this.sunLight.dispose();
   193‚Üí      this.sunLight = null;
   194‚Üí    }
   195‚Üí    if (this.ambientLight) {
   196‚Üí      this.ambientLight.intensity = 0.05;
   197‚Üí      this.ambientLight.diffuse = Color3.FromHexString(&#x27;#1A1020&#x27;);
   198‚Üí      this.ambientLight.groundColor = Color3.FromHexString(&#x27;#0A0810&#x27;);
   199‚Üí    }
   200‚Üí  }
   201‚Üí
   202‚Üí  private startLevel(): void {
   203‚Üí    this.phase = &#x27;exploration&#x27;;
   204‚Üí
   205‚Üí    this.actionCallback = this.handleAction.bind(this);
   206‚Üí    this.callbacks.onActionHandlerRegister(this.actionCallback);
   207‚Üí
   208‚Üí    this.callbacks.onNotification(NOTIFICATIONS.LEVEL_START, 3000);
   209‚Üí    this.callbacks.onObjectiveUpdate(OBJECTIVES.DESCENT.title, OBJECTIVES.DESCENT.description);
   210‚Üí
   211‚Üí    setTimeout(() =&gt; {
   212‚Üí      this.callbacks.onCommsMessage(COMMS_LEVEL_START);
   213‚Üí    }, 2000);
   214‚Üí
   215‚Üí    setTimeout(() =&gt; {
   216‚Üí      this.updateActionButtons(&#x27;exploration&#x27;);
   217‚Üí    }, 1000);
   218‚Üí  }
   219‚Üí
   220‚Üí  // ============================================================================
   221‚Üí  // ENVIRONMENT CREATION (delegated to builder)
   222‚Üí  // ============================================================================
   223‚Üí
   224‚Üí  private createUpperHive(): void {
   225‚Üí    if (!this.environmentBuilder) return;
   226‚Üí
   227‚Üí    const segments = 7;
   228‚Üí    for (let i = 0; i &lt; segments; i++) {
   229‚Üí      const depth = -i * TUNNEL_SEGMENT_LENGTH;
   230‚Üí      this.environmentBuilder.createTunnelSegment(
   231‚Üí        new Vector3(0, depth - 2, i * TUNNEL_SEGMENT_LENGTH),
   232‚Üí        0,
   233‚Üí        &#x27;upper&#x27;
   234‚Üí      );
   235‚Üí
   236‚Üí      if (i % 2 === 0) {
   237‚Üí        this.environmentBuilder.createBiolight(
   238‚Üí          new Vector3((Math.random() - 0.5) * 2, depth, i * TUNNEL_SEGMENT_LENGTH + 4),
   239‚Üí          0.5 + Math.random() * 0.3
   240‚Üí        );
   241‚Üí      }
   242‚Üí    }
   243‚Üí  }
   244‚Üí
   245‚Üí  private createMidHive(): void {
   246‚Üí    if (!this.environmentBuilder) return;
   247‚Üí
   248‚Üí    const baseZ = 7 * TUNNEL_SEGMENT_LENGTH;
   249‚Üí    const baseY = -7 * TUNNEL_SEGMENT_LENGTH - 2;
   250‚Üí
   251‚Üí    for (let i = 0; i &lt; 6; i++) {
   252‚Üí      const depth = baseY - i * TUNNEL_SEGMENT_LENGTH * 0.8;
   253‚Üí      this.environmentBuilder.createTunnelSegment(
   254‚Üí        new Vector3(0, depth, baseZ + i * TUNNEL_SEGMENT_LENGTH),
   255‚Üí        0,
   256‚Üí        &#x27;mid&#x27;
   257‚Üí      );
   258‚Üí
   259‚Üí      if (i % 2 === 1) {
   260‚Üí        const side = i % 4 === 1 ? 1 : -1;
   261‚Üí        this.environmentBuilder.createTunnelSegment(
   262‚Üí          new Vector3(side * 6, depth, baseZ + i * TUNNEL_SEGMENT_LENGTH),
   263‚Üí          (side * Math.PI) / 4,
   264‚Üí          &#x27;mid&#x27;
   265‚Üí        );
   266‚Üí      }
   267‚Üí
   268‚Üí      this.environmentBuilder.createBiolight(
   269‚Üí        new Vector3((Math.random() - 0.5) * 3, depth + 1, baseZ + i * TUNNEL_SEGMENT_LENGTH + 4),
   270‚Üí        0.4 + Math.random() * 0.4
   271‚Üí      );
   272‚Üí    }
   273‚Üí
   274‚Üí    this.environmentBuilder.createChamber(new Vector3(0, baseY - 30, baseZ + 40), 8, &#x27;mid&#x27;);
   275‚Üí  }
   276‚Üí
   277‚Üí  private createLowerHive(): void {
   278‚Üí    if (!this.environmentBuilder) return;
   279‚Üí
   280‚Üí    const baseZ = 7 * TUNNEL_SEGMENT_LENGTH + 6 * TUNNEL_SEGMENT_LENGTH;
   281‚Üí    const baseY = -100;
   282‚Üí
   283‚Üí    this.environmentBuilder.createChamber(new Vector3(0, baseY, baseZ + 20), 12, &#x27;lower&#x27;);
   284‚Üí
   285‚Üí    for (let i = 0; i &lt; 4; i++) {
   286‚Üí      this.environmentBuilder.createTunnelSegment(
   287‚Üí        new Vector3(0, baseY - 10 - i * 6, baseZ + 40 + i * 8),
   288‚Üí        0,
   289‚Üí        &#x27;lower&#x27;
   290‚Üí      );
   291‚Üí      this.environmentBuilder.createBiolight(
   292‚Üí        new Vector3((Math.random() - 0.5) * 2, baseY - 10 - i * 6 + 1.5, baseZ + 44 + i * 8),
   293‚Üí        0.6 + Math.random() * 0.3
   294‚Üí      );
   295‚Üí    }
   296‚Üí  }
   297‚Üí
   298‚Üí  private createQueenChamber(): void {
   299‚Üí    if (!this.environmentBuilder) return;
   300‚Üí
   301‚Üí    const chamberCenter = new Vector3(0, -150, 180);
   302‚Üí    const chamberRadius = 25;
   303‚Üí
   304‚Üí    // Arena floor
   305‚Üí    this.queenArena = MeshBuilder.CreateDisc(
   306‚Üí      &#x27;queenArena&#x27;,
   307‚Üí      { radius: chamberRadius, tessellation: 48 },
   308‚Üí      this.scene
   309‚Üí    );
   310‚Üí    const arenaMat = new StandardMaterial(&#x27;arenaMat&#x27;, this.scene);
   311‚Üí    arenaMat.diffuseColor = Color3.FromHexString(COLORS.chitinDark);
   312‚Üí    arenaMat.specularColor = new Color3(0.1, 0.1, 0.1);
   313‚Üí    this.queenArena.material = arenaMat;
   314‚Üí    this.queenArena.position = chamberCenter.clone();
   315‚Üí    this.queenArena.rotation.x = Math.PI / 2;
   316‚Üí
   317‚Üí    // Dome ceiling
   318‚Üí    const dome = MeshBuilder.CreateSphere(
   319‚Üí      &#x27;queenDome&#x27;,
   320‚Üí      { diameter: chamberRadius * 2.5, segments: 24, slice: 0.5, sideOrientation: 1 },
   321‚Üí      this.scene
   322‚Üí    );
   323‚Üí    const domeMat = new StandardMaterial(&#x27;domeMat&#x27;, this.scene);
   324‚Üí    domeMat.diffuseColor = Color3.FromHexString(COLORS.chitinPurple);
   325‚Üí    domeMat.emissiveColor = new Color3(0.02, 0.01, 0.03);
   326‚Üí    dome.material = domeMat;
   327‚Üí    dome.position.set(chamberCenter.x, chamberCenter.y + 5, chamberCenter.z);
   328‚Üí    dome.rotation.x = Math.PI;
   329‚Üí
   330‚Üí    // Entrance tunnel
   331‚Üí    this.environmentBuilder.createTunnelSegment(
   332‚Üí      new Vector3(0, chamberCenter.y + 5, chamberCenter.z - chamberRadius - 4),
   333‚Üí      0,
   334‚Üí      &#x27;queen_chamber&#x27;
   335‚Üí    );
   336‚Üí
   337‚Üí    // Door for boss fight
   338‚Üí    this.queenDoorMesh = MeshBuilder.CreateBox(
   339‚Üí      &#x27;queenDoor&#x27;,
   340‚Üí      { width: TUNNEL_DIAMETER + 1, height: TUNNEL_DIAMETER + 1, depth: 0.5 },
   341‚Üí      this.scene
   342‚Üí    );
   343‚Üí    const doorMat = new StandardMaterial(&#x27;doorMat&#x27;, this.scene);
   344‚Üí    doorMat.diffuseColor = Color3.FromHexString(&#x27;#2A1A2A&#x27;);
   345‚Üí    this.queenDoorMesh.material = doorMat;
   346‚Üí    this.queenDoorMesh.position.set(0, chamberCenter.y + 5, chamberCenter.z - chamberRadius);
   347‚Üí    this.queenDoorMesh.isVisible = false;
   348‚Üí
   349‚Üí    // Ring of biolights
   350‚Üí    for (let i = 0; i &lt; 12; i++) {
   351‚Üí      const angle = (i / 12) * Math.PI * 2;
   352‚Üí      this.environmentBuilder.createBiolight(
   353‚Üí        new Vector3(
   354‚Üí          chamberCenter.x + Math.cos(angle) * (chamberRadius - 2),
   355‚Üí          chamberCenter.y + 2,
   356‚Üí          chamberCenter.z + Math.sin(angle) * (chamberRadius - 2)
   357‚Üí        ),
   358‚Üí        0.8 + Math.random() * 0.4
   359‚Üí      );
   360‚Üí    }
   361‚Üí
   362‚Üí    // Create the Queen
   363‚Üí    this.queen = createQueen(
   364‚Üí      this.scene,
   365‚Üí      new Vector3(0, chamberCenter.y, chamberCenter.z + chamberRadius - 5),
   366‚Üí      this.environmentBuilder.getGlowLayer()
   367‚Üí    );
   368‚Üí  }
   369‚Üí
   370‚Üí  private placeHiveStructures(): void {
   371‚Üí    if (!this.environmentBuilder) return;
   372‚Üí
   373‚Üí    // Structure placements defined in environment.ts would be called here
   374‚Üí    // For brevity, using direct placement calls
   375‚Üí    const placements = this.getStructurePlacements();
   376‚Üí    for (const p of placements) {
   377‚Üí      this.environmentBuilder.placeStructure(p.type, p.position, p.zone, p.scale, p.rotationY);
   378‚Üí    }
   379‚Üí  }
   380‚Üí
   381‚Üí  private getStructurePlacements(): Array&lt;{
   382‚Üí    type: &#x27;birther&#x27; | &#x27;brain&#x27; | &#x27;claw&#x27; | &#x27;crystals&#x27; | &#x27;stomach&#x27; | &#x27;terraformer&#x27; | &#x27;undercrystal&#x27;;
   383‚Üí    position: Vector3;
   384‚Üí    zone: HiveZone;
   385‚Üí    scale: number;
   386‚Üí    rotationY: number;
   387‚Üí  }&gt; {
   388‚Üí    // Returns the structure placement configuration
   389‚Üí    // This could be moved to a separate config file if needed
   390‚Üí    return [
   391‚Üí      // Upper tunnels
   392‚Üí      {
   393‚Üí        type: &#x27;crystals&#x27;,
   394‚Üí        position: new Vector3(1.5, -15, 25),
   395‚Üí        zone: &#x27;upper&#x27;,
   396‚Üí        scale: 0.4,
   397‚Üí        rotationY: Math.PI / 4,
   398‚Üí      },
   399‚Üí      {
   400‚Üí        type: &#x27;crystals&#x27;,
   401‚Üí        position: new Vector3(-1.8, -25, 35),
   402‚Üí        zone: &#x27;upper&#x27;,
   403‚Üí        scale: 0.35,
   404‚Üí        rotationY: -Math.PI / 6,
   405‚Üí      },
   406‚Üí      // Mid hive
   407‚Üí      {
   408‚Üí        type: &#x27;birther&#x27;,
   409‚Üí        position: new Vector3(-4, -58, 75),
   410‚Üí        zone: &#x27;mid&#x27;,
   411‚Üí        scale: 0.6,
   412‚Üí        rotationY: Math.PI,
   413‚Üí      },
   414‚Üí      {
   415‚Üí        type: &#x27;terraformer&#x27;,
   416‚Üí        position: new Vector3(5, -65, 82),
   417‚Üí        zone: &#x27;mid&#x27;,
   418‚Üí        scale: 0.5,
   419‚Üí        rotationY: -Math.PI / 4,
   420‚Üí      },
   421‚Üí      // Lower hive
   422‚Üí      {
   423‚Üí        type: &#x27;brain&#x27;,
   424‚Üí        position: new Vector3(0, -95, 112),
   425‚Üí        zone: &#x27;lower&#x27;,
   426‚Üí        scale: 0.8,
   427‚Üí        rotationY: 0,
   428‚Üí      },
   429‚Üí      // Queen chamber
   430‚Üí      {
   431‚Üí        type: &#x27;brain&#x27;,
   432‚Üí        position: new Vector3(0, -148, 198),
   433‚Üí        zone: &#x27;queen_chamber&#x27;,
   434‚Üí        scale: 1.2,
   435‚Üí        rotationY: Math.PI,
   436‚Üí      },
   437‚Üí    ];
   438‚Üí  }
   439‚Üí
   440‚Üí  private placeCapturedVehicles(): void {
   441‚Üí    if (!this.environmentBuilder) return;
   442‚Üí
   443‚Üí    this.environmentBuilder.placeCapturedVehicle(
   444‚Üí      &#x27;wraith&#x27;,
   445‚Üí      new Vector3(-5, -75, 95),
   446‚Üí      &#x27;mid&#x27;,
   447‚Üí      6,
   448‚Üí      new Vector3(0.4, 1.2, 0.2)
   449‚Üí    );
   450‚Üí    this.environmentBuilder.placeCapturedVehicle(
   451‚Üí      &#x27;phantom&#x27;,
   452‚Üí      new Vector3(8, -108, 128),
   453‚Üí      &#x27;lower&#x27;,
   454‚Üí      8,
   455‚Üí      new Vector3(-0.3, 2.5, 0.5)
   456‚Üí    );
   457‚Üí  }
   458‚Üí
   459‚Üí  // ============================================================================
   460‚Üí  // ENEMIES
   461‚Üí  // ============================================================================
   462‚Üí
   463‚Üí  private spawnInitialEnemies(): void {
   464‚Üí    const config = getInitialSpawnConfig();
   465‚Üí    for (const spawn of config) {
   466‚Üí      const enemy = spawnEnemy(
   467‚Üí        this.scene,
   468‚Üí        spawn.position,
   469‚Üí        spawn.type,
   470‚Üí        spawn.zone,
   471‚Üí        this.enemies.length
   472‚Üí      );
   473‚Üí      this.enemies.push(enemy);
   474‚Üí    }
   475‚Üí  }
   476‚Üí
   477‚Üí  private spawnEnemyAtPosition(position: Vector3, type: &#x27;drone&#x27; | &#x27;grunt&#x27;, zone: HiveZone): void {
   478‚Üí    const enemy = spawnEnemy(this.scene, position, type, zone, this.enemies.length);
   479‚Üí    this.enemies.push(enemy);
   480‚Üí  }
   481‚Üí
   482‚Üí  // ============================================================================
   483‚Üí  // BOSS FIGHT
   484‚Üí  // ============================================================================
   485‚Üí
   486‚Üí  private startBossFight(): void {
   487‚Üí    if (this.phase !== &#x27;exploration&#x27; || !this.queen) return;
   488‚Üí
   489‚Üí    this.phase = &#x27;boss_intro&#x27;;
   490‚Üí
   491‚Üí    if (this.queenDoorMesh) {
   492‚Üí      this.queenDoorMesh.isVisible = true;
   493‚Üí    }
   494‚Üí
   495‚Üí    this.callbacks.onNotification(NOTIFICATIONS.BOSS_AWAKEN, 3000);
   496‚Üí    this.triggerShake(3);
   497‚Üí
   498‚Üí    setTimeout(() =&gt; {
   499‚Üí      this.callbacks.onCommsMessage(COMMS_BOSS_DETECTED);
   500‚Üí    }, 2000);
   501‚Üí
   502‚Üí    setTimeout(() =&gt; {
   503‚Üí      this.phase = &#x27;boss_fight&#x27;;
   504‚Üí      this.callbacks.onCombatStateChange(true);
   505‚Üí      this.updateActionButtons(&#x27;boss&#x27;);
   506‚Üí      this.callbacks.onObjectiveUpdate(
   507‚Üí        OBJECTIVES.KILL_QUEEN.title,
   508‚Üí        OBJECTIVES.KILL_QUEEN.getDescription(this.queen!.health, this.queen!.maxHealth)
   509‚Üí      );
   510‚Üí    }, 5000);
   511‚Üí  }
   512‚Üí
   513‚Üí  private updateQueen(deltaTime: number): void {
   514‚Üí    if (!this.queen || this.phase !== &#x27;boss_fight&#x27;) return;
   515‚Üí
   516‚Üí    // Update weak point visibility
   517‚Üí    if (this.queen.weakPointVisible) {
   518‚Üí      this.queen.weakPointTimer -= deltaTime * 1000;
   519‚Üí      if (this.queen.weakPointTimer &lt;= 0) {
   520‚Üí        this.queen.weakPointVisible = false;
   521‚Üí        this.queen.isVulnerable = false;
   522‚Üí        if (this.queen.weakPointMesh) {
   523‚Üí          this.queen.weakPointMesh.isVisible = false;
   524‚Üí        }
   525‚Üí      }
   526‚Üí    }
   527‚Üí
   528‚Üí    // Cooldowns
   529‚Üí    this.queen.attackCooldown -= deltaTime * 1000;
   530‚Üí    this.queen.spawnCooldown -= deltaTime * 1000;
   531‚Üí
   532‚Üí    // Phase transitions
   533‚Üí    const newPhase = getQueenPhase(this.queen.health, this.queen.maxHealth, this.queen.phase);
   534‚Üí    if (newPhase !== this.queen.phase) {
   535‚Üí      this.transitionQueenPhase(newPhase);
   536‚Üí    }
   537‚Üí
   538‚Üí    // Execute attacks
   539‚Üí    if (this.queen.attackCooldown &lt;= 0) {
   540‚Üí      this.queenAttack();
   541‚Üí    }
   542‚Üí
   543‚Üí    // Spawn minions
   544‚Üí    if (this.queen.spawnCooldown &lt;= 0) {
   545‚Üí      this.queenSpawnMinions();
   546‚Üí    }
   547‚Üí
   548‚Üí    // Animate
   549‚Üí    animateQueen(this.queen, performance.now() / 1000);
   550‚Üí
   551‚Üí    // Update HUD
   552‚Üí    this.callbacks.onObjectiveUpdate(
   553‚Üí      OBJECTIVES.QUEEN_PHASE.getTitle(this.queen.phase),
   554‚Üí      OBJECTIVES.QUEEN_PHASE.getDescription(this.queen.health, this.queen.maxHealth)
   555‚Üí    );
   556‚Üí  }
   557‚Üí
   558‚Üí  private transitionQueenPhase(newPhase: QueenPhase): void {
   559‚Üí    if (!this.queen) return;
   560‚Üí
   561‚Üí    this.queen.phase = newPhase;
   562‚Üí    this.triggerShake(5);
   563‚Üí
   564‚Üí    if (newPhase === 2) {
   565‚Üí      this.callbacks.onNotification(NOTIFICATIONS.BOSS_PHASE_2, 2000);
   566‚Üí      this.callbacks.onCommsMessage(COMMS_BOSS_PHASE_2);
   567‚Üí    } else if (newPhase === 3) {
   568‚Üí      this.callbacks.onNotification(NOTIFICATIONS.BOSS_PHASE_3, 2000);
   569‚Üí      this.callbacks.onCommsMessage(COMMS_BOSS_PHASE_3);
   570‚Üí    }
   571‚Üí  }
   572‚Üí
   573‚Üí  private queenAttack(): void {
   574‚Üí    if (!this.queen) return;
   575‚Üí
   576‚Üí    const phaseMultiplier = getPhaseMultiplier(this.queen.phase);
   577‚Üí    const attacks = getAvailableAttacks(this.queen.phase);
   578‚Üí    const attackType = attacks[Math.floor(Math.random() * attacks.length)];
   579‚Üí
   580‚Üí    const playerPos = this.camera.position;
   581‚Üí    const queenPos = this.queen.mesh.position;
   582‚Üí    const dist = Vector3.Distance(playerPos, queenPos);
   583‚Üí
   584‚Üí    switch (attackType) {
   585‚Üí      case &#x27;acid_spit&#x27;:
   586‚Üí        this.queenAcidSpit();
   587‚Üí        this.queen.attackCooldown = 3000 * phaseMultiplier;
   588‚Üí        break;
   589‚Üí
   590‚Üí      case &#x27;claw_swipe&#x27;:
   591‚Üí        if (dist &lt; 8) {
   592‚Üí          this.queenClawSwipe();
   593‚Üí          this.queen.attackCooldown = 2500 * phaseMultiplier;
   594‚Üí        } else {
   595‚Üí          this.queenAcidSpit();
   596‚Üí          this.queen.attackCooldown = 3000 * phaseMultiplier;
   597‚Üí        }
   598‚Üí        break;
   599‚Üí
   600‚Üí      case &#x27;tail_slam&#x27;:
   601‚Üí        if (dist &lt; 10) {
   602‚Üí          this.queenTailSlam();
   603‚Üí          this.queen.attackCooldown = 4000 * phaseMultiplier;
   604‚Üí        } else {
   605‚Üí          this.queenAcidSpit();
   606‚Üí          this.queen.attackCooldown = 3000 * phaseMultiplier;
   607‚Üí        }
   608‚Üí        break;
   609‚Üí
   610‚Üí      case &#x27;ground_pound&#x27;:
   611‚Üí        this.queenGroundPound();
   612‚Üí        this.queen.attackCooldown = 5000 * phaseMultiplier;
   613‚Üí        break;
   614‚Üí    }
   615‚Üí  }
   616‚Üí
   617‚Üí  private queenAcidSpit(): void {
   618‚Üí    this.callbacks.onNotification(NOTIFICATIONS.ACID_INCOMING, 1000);
   619‚Üí
   620‚Üí    const playerPos = this.camera.position.clone();
   621‚Üí    setTimeout(() =&gt; {
   622‚Üí      if (this.hazardBuilder) {
   623‚Üí        this.hazardBuilder.createPheromoneCloud(
   624‚Üí          new Vector3(
   625‚Üí            playerPos.x + (Math.random() - 0.5) * 3,
   626‚Üí            playerPos.y,
   627‚Üí            playerPos.z + (Math.random() - 0.5) * 3
   628‚Üí          ),
   629‚Üí          2,
   630‚Üí          5000
   631‚Üí        );
   632‚Üí      }
   633‚Üí      const dist = Vector3.Distance(this.camera.position, playerPos);
   634‚Üí      if (dist &lt; 3) {
   635‚Üí        this.damagePlayer(20, &#x27;Acid Spit&#x27;);
   636‚Üí      }
   637‚Üí    }, 800);
   638‚Üí  }
   639‚Üí
   640‚Üí  private queenClawSwipe(): void {
   641‚Üí    this.callbacks.onNotification(NOTIFICATIONS.CLAW_ATTACK, 800);
   642‚Üí    this.triggerShake(2);
   643‚Üí
   644‚Üí    if (this.queen) {
   645‚Üí      animateClawSwipe(this.queen);
   646‚Üí    }
   647‚Üí
   648‚Üí    const dist = Vector3.Distance(this.camera.position, this.queen!.mesh.position);
   649‚Üí    if (dist &lt; 6) {
   650‚Üí      this.damagePlayer(35, &#x27;Claw Swipe&#x27;);
   651‚Üí    }
   652‚Üí  }
   653‚Üí
   654‚Üí  private queenTailSlam(): void {
   655‚Üí    this.callbacks.onNotification(NOTIFICATIONS.TAIL_SLAM, 1000);
   656‚Üí
   657‚Üí    setTimeout(() =&gt; {
   658‚Üí      this.triggerShake(4);
   659‚Üí      const dist = Vector3.Distance(this.camera.position, this.queen!.mesh.position);
   660‚Üí      if (dist &lt; 8) {
   661‚Üí        this.damagePlayer(40, &#x27;Tail Slam&#x27;);
   662‚Üí      }
   663‚Üí    }, 500);
   664‚Üí  }
   665‚Üí
   666‚Üí  private queenGroundPound(): void {
   667‚Üí    this.callbacks.onNotification(NOTIFICATIONS.GROUND_POUND, 1500);
   668‚Üí
   669‚Üí    setTimeout(() =&gt; {
   670‚Üí      this.triggerShake(6);
   671‚Üí      this.damagePlayer(25, &#x27;Ground Pound&#x27;);
   672‚Üí    }, 1000);
   673‚Üí  }
   674‚Üí
   675‚Üí  private queenSpawnMinions(): void {
   676‚Üí    if (!this.queen) return;
   677‚Üí
   678‚Üí    const spawnCount = getSpawnCount(this.queen.phase);
   679‚Üí    const spawnType = getSpawnType(this.queen.phase);
   680‚Üí
   681‚Üí    for (let i = 0; i &lt; spawnCount; i++) {
   682‚Üí      const angle = Math.random() * Math.PI * 2;
   683‚Üí      const dist = 8 + Math.random() * 5;
   684‚Üí      const spawnPos = new Vector3(
   685‚Üí        this.queen.mesh.position.x + Math.cos(angle) * dist,
   686‚Üí        this.queen.mesh.position.y,
   687‚Üí        this.queen.mesh.position.z + Math.sin(angle) * dist
   688‚Üí      );
   689‚Üí      this.spawnEnemyAtPosition(spawnPos, spawnType, &#x27;queen_chamber&#x27;);
   690‚Üí    }
   691‚Üí
   692‚Üí    this.queen.spawnCooldown = getSpawnCooldown(this.queen.phase);
   693‚Üí    this.callbacks.onNotification(NOTIFICATIONS.MINIONS_SPAWNED(spawnCount, spawnType), 1500);
   694‚Üí  }
   695‚Üí
   696‚Üí  private damageQueenInternal(amount: number, isWeakPoint: boolean): void {
   697‚Üí    if (!this.queen || this.queen.health &lt;= 0) return;
   698‚Üí
   699‚Üí    const actualDamage = calculateQueenDamage(amount, isWeakPoint);
   700‚Üí    this.queen.health -= actualDamage;
   701‚Üí
   702‚Üí    if (isWeakPoint) {
   703‚Üí      this.callbacks.onNotification(NOTIFICATIONS.CRITICAL_HIT(actualDamage), 1000);
   704‚Üí      this.screenFlash = 0.3;
   705‚Üí      this.screenFlashColor = new Color3(1, 0.3, 0.3);
   706‚Üí    }
   707‚Üí
   708‚Üí    if (this.queen.health &lt;= 0) {
   709‚Üí      this.queen.health = 0;
   710‚Üí      this.queenDeath();
   711‚Üí    }
   712‚Üí  }
   713‚Üí
   714‚Üí  private queenDeath(): void {
   715‚Üí    if (!this.queen) return;
   716‚Üí
   717‚Üí    this.phase = &#x27;boss_death&#x27;;
   718‚Üí    this.queen.screaming = true;
   719‚Üí    this.queenDefeated = true;
   720‚Üí
   721‚Üí    getAchievementManager().onQueenDefeated();
   722‚Üí
   723‚Üí    this.callbacks.onNotification(NOTIFICATIONS.BOSS_DEFEATED, 3000);
   724‚Üí    this.triggerShake(8);
   725‚Üí
   726‚Üí    setTimeout(() =&gt; {
   727‚Üí      this.callbacks.onCommsMessage(COMMS_BOSS_DEATH);
   728‚Üí    }, 2000);
   729‚Üí
   730‚Üí    setTimeout(() =&gt; {
   731‚Üí      this.callbacks.onNotification(NOTIFICATIONS.ESCAPE, 3000);
   732‚Üí
   733‚Üí      if (this.queenDoorMesh) {
   734‚Üí        this.queenDoorMesh.isVisible = false;
   735‚Üí      }
   736‚Üí
   737‚Üí      this.phase = &#x27;escape_trigger&#x27;;
   738‚Üí      this.escapeTimer = 0;
   739‚Üí
   740‚Üí      setTimeout(() =&gt; {
   741‚Üí        this.completeLevel();
   742‚Üí      }, 5000);
   743‚Üí    }, 5000);
   744‚Üí  }
   745‚Üí
   746‚Üí  // ============================================================================
   747‚Üí  // PLAYER
   748‚Üí  // ============================================================================
   749‚Üí
   750‚Üí  private damagePlayer(amount: number, source: string): void {
   751‚Üí    const now = performance.now();
   752‚Üí    if (now - this.lastDamageTime &lt; DAMAGE_INVINCIBILITY_MS) return;
   753‚Üí
   754‚Üí    this.playerHealth -= amount;
   755‚Üí    this.lastDamageTime = now;
   756‚Üí    this.triggerShake(2);
   757‚Üí    this.callbacks.onDamage();
   758‚Üí    this.callbacks.onHealthChange(Math.max(0, this.playerHealth));
   759‚Üí
   760‚Üí    if (this.playerHealth &lt;= 0) {
   761‚Üí      this.callbacks.onNotification(`KILLED BY ${source}`, 3000);
   762‚Üí    }
   763‚Üí  }
   764‚Üí
   765‚Üí  private checkHazards(): void {
   766‚Üí    if (!this.hazardBuilder) return;
   767‚Üí
   768‚Üí    const playerPos = this.camera.position;
   769‚Üí
   770‚Üí    // Acid pools
   771‚Üí    const acidDamage = checkAcidPoolDamage(playerPos, this.hazardBuilder.getAcidPools());
   772‚Üí    if (acidDamage &gt; 0) {
   773‚Üí      this.damagePlayer(acidDamage * 0.016, &#x27;ACID POOL&#x27;);
   774‚Üí    }
   775‚Üí
   776‚Üí    // Egg clusters
   777‚Üí    const triggeredCluster = checkEggClusterTrigger(playerPos, this.hazardBuilder.getEggClusters());
   778‚Üí    if (triggeredCluster) {
   779‚Üí      triggeredCluster.triggered = true;
   780‚Üí      this.callbacks.onNotification(NOTIFICATIONS.EGGS_HATCHING, 1500);
   781‚Üí
   782‚Üí      for (let i = 0; i &lt; triggeredCluster.droneCount; i++) {
   783‚Üí        const angle = (i / triggeredCluster.droneCount) * Math.PI * 2;
   784‚Üí        const spawnPos = triggeredCluster.position.add(
   785‚Üí          new Vector3(Math.cos(angle) * 2, 0, Math.sin(angle) * 2)
   786‚Üí        );
   787‚Üí        this.spawnEnemyAtPosition(spawnPos, &#x27;drone&#x27;, this.currentZone);
   788‚Üí      }
   789‚Üí    }
   790‚Üí
   791‚Üí    // Pheromone clouds
   792‚Üí    if (checkPheromoneCloud(playerPos, this.hazardBuilder.getPheromoneClouds())) {
   793‚Üí      this.screenFlash = 0.1;
   794‚Üí      this.screenFlashColor = Color3.FromHexString(COLORS.acidGreen);
   795‚Üí    }
   796‚Üí  }
   797‚Üí
   798‚Üí  private updateZone(): void {
   799‚Üí    const playerZ = this.camera.position.z;
   800‚Üí    const playerY = this.camera.position.y;
   801‚Üí
   802‚Üí    if (playerZ &gt; 150 &amp;&amp; playerY &lt; -140) {
   803‚Üí      if (this.currentZone !== &#x27;queen_chamber&#x27;) {
   804‚Üí        this.currentZone = &#x27;queen_chamber&#x27;;
   805‚Üí        if (this.phase === &#x27;exploration&#x27;) {
   806‚Üí          this.startBossFight();
   807‚Üí        }
   808‚Üí      }
   809‚Üí    } else if (playerZ &gt; 100 &amp;&amp; playerY &lt; -90) {
   810‚Üí      this.currentZone = &#x27;lower&#x27;;
   811‚Üí      this.depth = 100 + (playerZ - 100) * 0.5;
   812‚Üí    } else if (playerZ &gt; 50 &amp;&amp; playerY &lt; -45) {
   813‚Üí      this.currentZone = &#x27;mid&#x27;;
   814‚Üí      this.depth = 50 + (playerZ - 50) * 0.8;
   815‚Üí    } else {
   816‚Üí      this.currentZone = &#x27;upper&#x27;;
   817‚Üí      this.depth = playerZ * 0.7;
   818‚Üí    }
   819‚Üí  }
   820‚Üí
   821‚Üí  // ============================================================================
   822‚Üí  // ACTION HANDLING
   823‚Üí  // ============================================================================
   824‚Üí
   825‚Üí  private handleAction(actionId: string): void {
   826‚Üí    switch (actionId) {
   827‚Üí      case &#x27;grenade&#x27;:
   828‚Üí        this.throwGrenade();
   829‚Üí        break;
   830‚Üí      case &#x27;melee&#x27;:
   831‚Üí        this.meleeAttack();
   832‚Üí        break;
   833‚Üí      case &#x27;weak_point&#x27;:
   834‚Üí        this.scanWeakPoint();
   835‚Üí        break;
   836‚Üí      case &#x27;reload&#x27;:
   837‚Üí        this.handleReload();
   838‚Üí        break;
   839‚Üí    }
   840‚Üí  }
   841‚Üí
   842‚Üí  private throwGrenade(): void {
   843‚Üí    if (this.grenadeCooldown &gt; 0 || this.grenadeCount &lt;= 0) {
   844‚Üí      this.callbacks.onNotification(NOTIFICATIONS.GRENADE_NOT_READY, 800);
   845‚Üí      return;
   846‚Üí    }
   847‚Üí
   848‚Üí    this.grenadeCount--;
   849‚Üí    this.grenadeCooldown = GRENADE_COOLDOWN;
   850‚Üí
   851‚Üí    const targetPos = this.camera.position.add(
   852‚Üí      this.camera.getDirection(Vector3.Forward()).scale(10)
   853‚Üí    );
   854‚Üí
   855‚Üí    this.callbacks.onNotification(NOTIFICATIONS.GRENADE_OUT, 1000);
   856‚Üí
   857‚Üí    setTimeout(() =&gt; {
   858‚Üí      this.triggerShake(3);
   859‚Üí      this.screenFlash = 0.5;
   860‚Üí      this.screenFlashColor = new Color3(1, 0.8, 0.4);
   861‚Üí
   862‚Üí      particleManager.emitSmallExplosion(targetPos, 1.5);
   863‚Üí
   864‚Üí      // Damage enemies
   865‚Üí      for (const enemy of this.enemies) {
   866‚Üí        const dist = Vector3.Distance(enemy.position, targetPos);
   867‚Üí        if (dist &lt; GRENADE_RADIUS) {
   868‚Üí          const damage = GRENADE_MAX_DAMAGE * (1 - dist / GRENADE_RADIUS);
   869‚Üí          if (damageEnemy(enemy, damage)) {
   870‚Üí            this.enemiesKilled++;
   871‚Üí            this.callbacks.onKill();
   872‚Üí          }
   873‚Üí        }
   874‚Üí      }
   875‚Üí      this.enemies = this.enemies.filter((e) =&gt; e.state !== &#x27;dead&#x27;);
   876‚Üí
   877‚Üí      // Damage queen
   878‚Üí      if (this.queen &amp;&amp; this.phase === &#x27;boss_fight&#x27;) {
   879‚Üí        const queenDist = Vector3.Distance(this.queen.mesh.position, targetPos);
   880‚Üí        if (queenDist &lt; 10) {
   881‚Üí          const damage = 100 * (1 - queenDist / 10);
   882‚Üí          this.damageQueenInternal(damage, false);
   883‚Üí        }
   884‚Üí      }
   885‚Üí    }, 1500);
   886‚Üí  }
   887‚Üí
   888‚Üí  private handleReload(): void {
   889‚Üí    const weaponActions = getWeaponActions();
   890‚Üí    if (!weaponActions) return;
   891‚Üí
   892‚Üí    const state = weaponActions.getState();
   893‚Üí    if (state.isReloading) return;
   894‚Üí
   895‚Üí    if (state.currentAmmo &gt;= state.maxMagazineSize) {
   896‚Üí      this.callbacks.onNotification(NOTIFICATIONS.MAGAZINE_FULL, 800);
   897‚Üí      return;
   898‚Üí    }
   899‚Üí
   900‚Üí    if (state.reserveAmmo &lt;= 0) {
   901‚Üí      this.callbacks.onNotification(NOTIFICATIONS.NO_RESERVE_AMMO, 800);
   902‚Üí      return;
   903‚Üí    }
   904‚Üí
   905‚Üí    startReload();
   906‚Üí    this.callbacks.onNotification(NOTIFICATIONS.RELOADING, 1500);
   907‚Üí  }
   908‚Üí
   909‚Üí  private meleeAttack(): void {
   910‚Üí    if (this.meleeCooldown &gt; 0) return;
   911‚Üí
   912‚Üí    this.meleeCooldown = MELEE_COOLDOWN;
   913‚Üí    this.callbacks.onNotification(NOTIFICATIONS.MELEE, 500);
   914‚Üí
   915‚Üí    const playerPos = this.camera.position;
   916‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
   917‚Üí
   918‚Üí    for (const enemy of this.enemies) {
   919‚Üí      const toEnemy = enemy.position.subtract(playerPos);
   920‚Üí      const dist = toEnemy.length();
   921‚Üí      if (dist &lt; MELEE_RANGE) {
   922‚Üí        const dot = Vector3.Dot(toEnemy.normalize(), forward);
   923‚Üí        if (dot &gt; 0.5) {
   924‚Üí          if (damageEnemy(enemy, MELEE_DAMAGE)) {
   925‚Üí            this.enemiesKilled++;
   926‚Üí            this.callbacks.onKill();
   927‚Üí          }
   928‚Üí        }
   929‚Üí      }
   930‚Üí    }
   931‚Üí    this.enemies = this.enemies.filter((e) =&gt; e.state !== &#x27;dead&#x27;);
   932‚Üí  }
   933‚Üí
   934‚Üí  private scanWeakPoint(): void {
   935‚Üí    if (!this.queen || this.phase !== &#x27;boss_fight&#x27; || this.scanCooldown &gt; 0) {
   936‚Üí      this.callbacks.onNotification(NOTIFICATIONS.SCAN_NOT_AVAILABLE, 800);
   937‚Üí      return;
   938‚Üí    }
   939‚Üí
   940‚Üí    this.scanCooldown = WEAK_POINT_COOLDOWN;
   941‚Üí    this.callbacks.onNotification(NOTIFICATIONS.SCANNING, 1500);
   942‚Üí
   943‚Üí    setTimeout(() =&gt; {
   944‚Üí      if (this.queen &amp;&amp; this.queen.weakPointMesh) {
   945‚Üí        this.queen.weakPointVisible = true;
   946‚Üí        this.queen.isVulnerable = true;
   947‚Üí        this.queen.weakPointTimer = WEAK_POINT_DURATION;
   948‚Üí        this.queen.weakPointMesh.isVisible = true;
   949‚Üí        this.callbacks.onNotification(NOTIFICATIONS.WEAK_POINT_REVEALED, 2000);
   950‚Üí      }
   951‚Üí    }, 1500);
   952‚Üí  }
   953‚Üí
   954‚Üí  private updateActionButtons(mode: &#x27;exploration&#x27; | &#x27;boss&#x27; | &#x27;none&#x27;): void {
   955‚Üí    let groups: ActionButtonGroup[] = [];
   956‚Üí
   957‚Üí    if (mode === &#x27;exploration&#x27; || mode === &#x27;boss&#x27;) {
   958‚Üí      const buttons = [
   959‚Üí        createAction(&#x27;grenade&#x27;, &#x27;GRENADE&#x27;, &#x27;KeyG&#x27;, {
   960‚Üí          cooldown: GRENADE_COOLDOWN,
   961‚Üí          variant: &#x27;danger&#x27;,
   962‚Üí        }),
   963‚Üí        createAction(&#x27;melee&#x27;, &#x27;MELEE&#x27;, &#x27;KeyV&#x27;, { variant: &#x27;primary&#x27; }),
   964‚Üí        createAction(&#x27;reload&#x27;, &#x27;RELOAD&#x27;, &#x27;KeyR&#x27;, { variant: &#x27;secondary&#x27; }),
   965‚Üí      ];
   966‚Üí
   967‚Üí      if (mode === &#x27;boss&#x27;) {
   968‚Üí        buttons.push(
   969‚Üí          createAction(&#x27;weak_point&#x27;, &#x27;SCAN WEAKNESS&#x27;, &#x27;KeyT&#x27;, {
   970‚Üí            cooldown: WEAK_POINT_COOLDOWN,
   971‚Üí            variant: &#x27;warning&#x27;,
   972‚Üí          })
   973‚Üí        );
   974‚Üí      }
   975‚Üí
   976‚Üí      groups = [{ id: mode === &#x27;boss&#x27; ? &#x27;boss&#x27; : &#x27;combat&#x27;, position: &#x27;right&#x27;, buttons }];
   977‚Üí    }
   978‚Üí
   979‚Üí    this.callbacks.onActionGroupsChange(groups);
   980‚Üí  }
   981‚Üí
   982‚Üí  // ============================================================================
   983‚Üí  // UPDATE LOOP
   984‚Üí  // ============================================================================
   985‚Üí
   986‚Üí  protected updateLevel(deltaTime: number): void {
   987‚Üí    this.phaseTimer += deltaTime;
   988‚Üí
   989‚Üí    // Update biolights
   990‚Üí    if (this.environmentBuilder) {
   991‚Üí      updateBiolights(this.environmentBuilder.getBiolights(), performance.now() / 1000);
   992‚Üí    }
   993‚Üí
   994‚Üí    // Update pheromone clouds
   995‚Üí    if (this.hazardBuilder) {
   996‚Üí      this.hazardBuilder.updatePheromoneClouds(deltaTime);
   997‚Üí    }
   998‚Üí
   999‚Üí    // Check zone and hazards
  1000‚Üí    this.updateZone();
  1001‚Üí    this.checkHazards();
  1002‚Üí
  1003‚Üí    // Update enemies
  1004‚Üí    for (const enemy of this.enemies) {
  1005‚Üí      updateEnemyAI(enemy, this.camera.position, deltaTime);
  1006‚Üí      const damage = getEnemyAttackDamage(enemy, this.camera.position);
  1007‚Üí      if (damage &gt; 0) {
  1008‚Üí        this.damagePlayer(damage, enemy.type.toUpperCase());
  1009‚Üí      }
  1010‚Üí    }
  1011‚Üí
  1012‚Üí    // Update queen
  1013‚Üí    if (this.queen &amp;&amp; this.phase === &#x27;boss_fight&#x27;) {
  1014‚Üí      this.updateQueen(deltaTime);
  1015‚Üí    }
  1016‚Üí
  1017‚Üí    // Update cooldowns
  1018‚Üí    if (this.grenadeCooldown &gt; 0) this.grenadeCooldown -= deltaTime * 1000;
  1019‚Üí    if (this.meleeCooldown &gt; 0) this.meleeCooldown -= deltaTime * 1000;
  1020‚Üí    if (this.scanCooldown &gt; 0) this.scanCooldown -= deltaTime * 1000;
  1021‚Üí
  1022‚Üí    // Screen flash decay
  1023‚Üí    if (this.screenFlash &gt; 0) {
  1024‚Üí      this.screenFlash *= 0.9;
  1025‚Üí      if (this.screenFlash &lt; 0.01) this.screenFlash = 0;
  1026‚Üí    }
  1027‚Üí
  1028‚Üí    // Escape sequence
  1029‚Üí    if (this.phase === &#x27;escape_trigger&#x27;) {
  1030‚Üí      this.escapeTimer += deltaTime;
  1031‚Üí      this.setBaseShake(Math.min(8, 2 + this.escapeTimer * 2));
  1032‚Üí    }
  1033‚Üí
  1034‚Üí    // HUD updates for exploration
  1035‚Üí    if (this.phase === &#x27;exploration&#x27;) {
  1036‚Üí      this.callbacks.onObjectiveUpdate(
  1037‚Üí        OBJECTIVES.EXPLORATION.getTitle(this.currentZone),
  1038‚Üí        OBJECTIVES.EXPLORATION.getDescription(this.depth, this.enemies.length, this.enemiesKilled)
  1039‚Üí      );
  1040‚Üí    }
  1041‚Üí  }
  1042‚Üí
  1043‚Üí  // ============================================================================
  1044‚Üí  // INPUT OVERRIDES
  1045‚Üí  // ============================================================================
  1046‚Üí
  1047‚Üí  protected override handleKeyDown(e: KeyboardEvent): void {
  1048‚Üí    super.handleKeyDown(e);
  1049‚Üí
  1050‚Üí    const fireKey = this.inputTracker.getKeyForAction(&#x27;fire&#x27;);
  1051‚Üí
  1052‚Üí    if (this.actionCallback) {
  1053‚Üí      switch (e.code) {
  1054‚Üí        case &#x27;KeyG&#x27;:
  1055‚Üí          this.actionCallback(&#x27;grenade&#x27;);
  1056‚Üí          break;
  1057‚Üí        case &#x27;KeyV&#x27;:
  1058‚Üí          this.actionCallback(&#x27;melee&#x27;);
  1059‚Üí          break;
  1060‚Üí        case &#x27;KeyT&#x27;:
  1061‚Üí          if (this.phase === &#x27;boss_fight&#x27;) {
  1062‚Üí            this.actionCallback(&#x27;weak_point&#x27;);
  1063‚Üí          }
  1064‚Üí          break;
  1065‚Üí        case &#x27;KeyR&#x27;:
  1066‚Üí          this.handleReload();
  1067‚Üí          break;
  1068‚Üí      }
  1069‚Üí    }
  1070‚Üí
  1071‚Üí    if (e.code === fireKey &amp;&amp; !fireKey.startsWith(&#x27;Mouse&#x27;)) {
  1072‚Üí      this.firePrimaryWeapon();
  1073‚Üí    }
  1074‚Üí  }
  1075‚Üí
  1076‚Üí  protected override handleClick(): void {
  1077‚Üí    super.handleClick();
  1078‚Üí
  1079‚Üí    if (this.isPointerLocked()) {
  1080‚Üí      this.firePrimaryWeapon();
  1081‚Üí    }
  1082‚Üí  }
  1083‚Üí
  1084‚Üí  private firePrimaryWeapon(): void {
  1085‚Üí    if (!this.isPointerLocked()) return;
  1086‚Üí
  1087‚Üí    if (!fireWeapon()) {
  1088‚Üí      this.callbacks.onNotification(NOTIFICATIONS.NO_AMMO_RELOADING, 800);
  1089‚Üí      startReload();
  1090‚Üí      return;
  1091‚Üí    }
  1092‚Üí
  1093‚Üí    const playerPos = this.camera.position;
  1094‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
  1095‚Üí
  1096‚Üí    // Check enemy hits
  1097‚Üí    const hitEnemy = checkEnemyHit(this.enemies, playerPos, forward);
  1098‚Üí    if (hitEnemy) {
  1099‚Üí      if (damageEnemy(hitEnemy, 20)) {
  1100‚Üí        this.enemiesKilled++;
  1101‚Üí        this.callbacks.onKill();
  1102‚Üí        this.enemies = this.enemies.filter((e) =&gt; e !== hitEnemy);
  1103‚Üí      }
  1104‚Üí      return;
  1105‚Üí    }
  1106‚Üí
  1107‚Üí    // Check queen hit
  1108‚Üí    if (this.queen &amp;&amp; this.phase === &#x27;boss_fight&#x27;) {
  1109‚Üí      const toQueen = this.queen.mesh.position.subtract(playerPos);
  1110‚Üí      const dist = toQueen.length();
  1111‚Üí      const dot = Vector3.Dot(toQueen.normalize(), forward);
  1112‚Üí
  1113‚Üí      if (dot &gt; 0.8 &amp;&amp; dist &lt; 40) {
  1114‚Üí        // Check weak point
  1115‚Üí        if (this.queen.weakPointVisible &amp;&amp; this.queen.weakPointMesh) {
  1116‚Üí          const toWeakPoint = this.queen.weakPointMesh.position.subtract(playerPos);
  1117‚Üí          const wpDot = Vector3.Dot(toWeakPoint.normalize(), forward);
  1118‚Üí          const wpDist = toWeakPoint.length();
  1119‚Üí          const wpCrossDist = Math.sqrt(1 - wpDot * wpDot) * wpDist;
  1120‚Üí
  1121‚Üí          if (wpDot &gt; 0.9 &amp;&amp; wpCrossDist &lt; 1) {
  1122‚Üí            this.damageQueenInternal(50, true);
  1123‚Üí            return;
  1124‚Üí          }
  1125‚Üí        }
  1126‚Üí
  1127‚Üí        this.damageQueenInternal(20, false);
  1128‚Üí      }
  1129‚Üí    }
  1130‚Üí  }
  1131‚Üí
  1132‚Üí  // ============================================================================
  1133‚Üí  // LIFECYCLE
  1134‚Üí  // ============================================================================
  1135‚Üí
  1136‚Üí  override canTransitionTo(levelId: LevelId): boolean {
  1137‚Üí    return levelId === &#x27;extraction&#x27; &amp;&amp; this.queenDefeated;
  1138‚Üí  }
  1139‚Üí
  1140‚Üí  protected disposeLevel(): void {
  1141‚Üí    this.callbacks.onActionHandlerRegister(null);
  1142‚Üí    this.callbacks.onActionGroupsChange([]);
  1143‚Üí
  1144‚Üí    // Dispose environment
  1145‚Üí    this.environmentBuilder?.dispose();
  1146‚Üí
  1147‚Üí    // Dispose hazards
  1148‚Üí    this.hazardBuilder?.dispose();
  1149‚Üí
  1150‚Üí    // Dispose enemies
  1151‚Üí    disposeEnemies(this.enemies);
  1152‚Üí    this.enemies = [];
  1153‚Üí
  1154‚Üí    // Dispose queen
  1155‚Üí    if (this.queen) {
  1156‚Üí      disposeQueen(this.queen);
  1157‚Üí    }
  1158‚Üí
  1159‚Üí    // Dispose arena
  1160‚Üí    this.queenArena?.dispose();
  1161‚Üí    this.queenDoorMesh?.dispose();
  1162‚Üí  }
  1163‚Üí}
  1164‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-49-361Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-49-361Z" class="timestamp-link"><time datetime="2026-01-30T06:44:49.361Z" data-timestamp="2026-01-30T06:44:49.361Z">2026-01-30T06:44:49.361Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01RzWkF5Tx8xYv8ZCbSFhrJc"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/brothers-in-arms/BrothersInArmsLevel.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-49-516Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-49-516Z" class="timestamp-link"><time datetime="2026-01-30T06:44:49.516Z" data-timestamp="2026-01-30T06:44:49.516Z">2026-01-30T06:44:49.516Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * BrothersInArmsLevel - Chapter 4: Reunite with Marcus, Wave Combat
     3‚Üí *
     4‚Üí * LEVEL STRUCTURE:
     5‚Üí * 1. REUNION - Emotional cutscene with Marcus
     6‚Üí * 2. WAVE COMBAT - 4 waves of increasing difficulty
     7‚Üí * 3. THE BREACH - Final battle at massive sinkhole entrance
     8‚Üí * 4. TRANSITION - Marcus can&#x27;t follow into tunnels
     9‚Üí *
    10‚Üí * KEY FEATURES:
    11‚Üí * - Marcus AI ally (8m tall Titan mech)
    12‚Üí * - Wave-based Chitin combat
    13‚Üí * - Open canyon arena (200m x 150m)
    14‚Üí * - The Breach: 100m diameter sinkhole
    15‚Üí * - Orange-red sunset lighting
    16‚Üí */
    17‚Üí
    18‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    19‚Üíimport { DirectionalLight } from &#x27;@babylonjs/core/Lights/directionalLight&#x27;;
    20‚Üíimport { PointLight } from &#x27;@babylonjs/core/Lights/pointLight&#x27;;
    21‚Üíimport { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    22‚Üíimport { Color3, Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    23‚Üíimport { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    24‚Üíimport type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    25‚Üíimport { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    26‚Üíimport { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    27‚Üíimport { getAchievementManager } from &#x27;../../achievements&#x27;;
    28‚Üíimport { createEntity, type Entity, removeEntity } from &#x27;../../core/ecs&#x27;;
    29‚Üíimport { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    30‚Üíimport { tokens } from &#x27;../../utils/designTokens&#x27;;
    31‚Üíimport { BaseLevel } from &#x27;../BaseLevel&#x27;;
    32‚Üíimport type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    33‚Üí
    34‚Üí// ============================================================================
    35‚Üí// TYPES &amp; INTERFACES
    36‚Üí// ============================================================================
    37‚Üí
    38‚Üítype LevelPhase = &#x27;reunion&#x27; | &#x27;wave_combat&#x27; | &#x27;breach_battle&#x27; | &#x27;transition&#x27;;
    39‚Üí
    40‚Üítype MarcusState = &#x27;patrol&#x27; | &#x27;combat&#x27; | &#x27;dialogue&#x27;;
    41‚Üí
    42‚Üíinterface MarcusMech {
    43‚Üí  rootNode: TransformNode;
    44‚Üí  body: Mesh;
    45‚Üí  leftArm: Mesh;
    46‚Üí  rightArm: Mesh;
    47‚Üí  legs: Mesh;
    48‚Üí  position: Vector3;
    49‚Üí  health: number;
    50‚Üí  maxHealth: number;
    51‚Üí  targetEnemy: Entity | null;
    52‚Üí  state: MarcusState;
    53‚Üí  lastFireTime: number;
    54‚Üí  fireRate: number;
    55‚Üí  damage: number;
    56‚Üí  range: number;
    57‚Üí}
    58‚Üí
    59‚Üítype EnemyType = &#x27;drone&#x27; | &#x27;grunt&#x27; | &#x27;spitter&#x27; | &#x27;brute&#x27;;
    60‚Üí
    61‚Üíinterface EnemyConfig {
    62‚Üí  type: EnemyType;
    63‚Üí  health: number;
    64‚Üí  damage: number;
    65‚Üí  speed: number;
    66‚Üí  size: number;
    67‚Üí  color: string;
    68‚Üí  attackRange: number;
    69‚Üí}
    70‚Üí
    71‚Üíinterface Wave {
    72‚Üí  id: number;
    73‚Üí  enemies: { type: EnemyType; count: number }[];
    74‚Üí  spawnPoints: Vector3[];
    75‚Üí  dialogue: string;
    76‚Üí  dialogueSender: string;
    77‚Üí}
    78‚Üí
    79‚Üíinterface ActiveEnemy {
    80‚Üí  entity: Entity;
    81‚Üí  mesh: Mesh;
    82‚Üí  type: EnemyType;
    83‚Üí  health: number;
    84‚Üí  maxHealth: number;
    85‚Üí  speed: number;
    86‚Üí  damage: number;
    87‚Üí  attackRange: number;
    88‚Üí  lastAttackTime: number;
    89‚Üí  targetPosition: Vector3;
    90‚Üí  state: &#x27;spawning&#x27; | &#x27;moving&#x27; | &#x27;attacking&#x27; | &#x27;dead&#x27;;
    91‚Üí}
    92‚Üí
    93‚Üí// ============================================================================
    94‚Üí// CONSTANTS
    95‚Üí// ============================================================================
    96‚Üí
    97‚Üíconst ENEMY_CONFIGS: Record&lt;EnemyType, EnemyConfig&gt; = {
    98‚Üí  drone: {
    99‚Üí    type: &#x27;drone&#x27;,
   100‚Üí    health: 30,
   101‚Üí    damage: 5,
   102‚Üí    speed: 18,
   103‚Üí    size: 0.6,
   104‚Üí    color: &#x27;#2D4A3E&#x27;,
   105‚Üí    attackRange: 8,
   106‚Üí  },
   107‚Üí  grunt: {
   108‚Üí    type: &#x27;grunt&#x27;,
   109‚Üí    health: 100,
   110‚Üí    damage: 15,
   111‚Üí    speed: 10,
   112‚Üí    size: 1.6,
   113‚Üí    color: &#x27;#3A3A4A&#x27;,
   114‚Üí    attackRange: 12,
   115‚Üí  },
   116‚Üí  spitter: {
   117‚Üí    type: &#x27;spitter&#x27;,
   118‚Üí    health: 50,
   119‚Üí    damage: 40,
   120‚Üí    speed: 6,
   121‚Üí    size: 1.3,
   122‚Üí    color: &#x27;#3E5A2D&#x27;,
   123‚Üí    attackRange: 25,
   124‚Üí  },
   125‚Üí  brute: {
   126‚Üí    type: &#x27;brute&#x27;,
   127‚Üí    health: 200,
   128‚Üí    damage: 25,
   129‚Üí    speed: 5,
   130‚Üí    size: 2.8,
   131‚Üí    color: &#x27;#5A2A2A&#x27;,
   132‚Üí    attackRange: 15,
   133‚Üí  },
   134‚Üí};
   135‚Üí
   136‚Üíconst WAVES: Wave[] = [
   137‚Üí  {
   138‚Üí    id: 1,
   139‚Üí    enemies: [{ type: &#x27;drone&#x27;, count: 15 }],
   140‚Üí    spawnPoints: [],
   141‚Üí    dialogue: &#x27;Contacts inbound! Just like the Europa job, eh James?&#x27;,
   142‚Üí    dialogueSender: &#x27;Marcus&#x27;,
   143‚Üí  },
   144‚Üí  {
   145‚Üí    id: 2,
   146‚Üí    enemies: [{ type: &#x27;grunt&#x27;, count: 10 }],
   147‚Üí    spawnPoints: [],
   148‚Üí    dialogue: &#x27;Grunts incoming! Keep your distance!&#x27;,
   149‚Üí    dialogueSender: &#x27;Marcus&#x27;,
   150‚Üí  },
   151‚Üí  {
   152‚Üí    id: 3,
   153‚Üí    enemies: [
   154‚Üí      { type: &#x27;grunt&#x27;, count: 8 },
   155‚Üí      { type: &#x27;drone&#x27;, count: 5 },
   156‚Üí      { type: &#x27;spitter&#x27;, count: 2 },
   157‚Üí    ],
   158‚Üí    spawnPoints: [],
   159‚Üí    dialogue: &#x27;Mixed wave! Watch for acid spitters!&#x27;,
   160‚Üí    dialogueSender: &#x27;Marcus&#x27;,
   161‚Üí  },
   162‚Üí  {
   163‚Üí    id: 4,
   164‚Üí    enemies: [
   165‚Üí      { type: &#x27;brute&#x27;, count: 1 },
   166‚Üí      { type: &#x27;grunt&#x27;, count: 6 },
   167‚Üí      { type: &#x27;drone&#x27;, count: 10 },
   168‚Üí    ],
   169‚Üí    spawnPoints: [],
   170‚Üí    dialogue: &#x27;Something big is coming... BRUTE! Focus fire!&#x27;,
   171‚Üí    dialogueSender: &#x27;Marcus&#x27;,
   172‚Üí  },
   173‚Üí];
   174‚Üí
   175‚Üíconst ARENA_WIDTH = 200;
   176‚Üíconst ARENA_DEPTH = 150;
   177‚Üíconst BREACH_DIAMETER = 100;
   178‚Üíconst BREACH_POSITION = new Vector3(0, 0, -60);
   179‚Üíconst MARCUS_START_POSITION = new Vector3(15, 0, 10);
   180‚Üíconst WAVE_REST_DURATION = 30000; // 30 seconds between waves
   181‚Üí
   182‚Üí// ============================================================================
   183‚Üí// LEVEL CLASS
   184‚Üí// ============================================================================
   185‚Üí
   186‚Üíexport class BrothersInArmsLevel extends BaseLevel {
   187‚Üí  // Phase management
   188‚Üí  private phase: LevelPhase = &#x27;reunion&#x27;;
   189‚Üí  private phaseTime = 0;
   190‚Üí
   191‚Üí  // Marcus AI ally
   192‚Üí  private marcus: MarcusMech | null = null;
   193‚Üí
   194‚Üí  // Wave combat
   195‚Üí  private currentWave = 0;
   196‚Üí  private waveEnemies: ActiveEnemy[] = [];
   197‚Üí  private waveComplete = false;
   198‚Üí  private waveRestTimer = 0;
   199‚Üí  private allWavesComplete = false;
   200‚Üí  private totalKills = 0;
   201‚Üí
   202‚Üí  // Environment
   203‚Üí  private terrain: Mesh | null = null;
   204‚Üí  private canyonWalls: Mesh[] = [];
   205‚Üí  private rockPillars: Mesh[] = [];
   206‚Üí  private breachMesh: Mesh | null = null;
   207‚Üí  private breachGlow: PointLight | null = null;
   208‚Üí  private skyDome: Mesh | null = null;
   209‚Üí
   210‚Üí  // Combat
   211‚Üí  private playerHealth = 100;
   212‚Üí  private fireSuportCooldown = 0;
   213‚Üí  private grenadeCooldown = 0;
   214‚Üí
   215‚Üí  // Action handler reference
   216‚Üí  private actionCallback: ((actionId: string) =&gt; void) | null = null;
   217‚Üí
   218‚Üí  // Spawn points generated once
   219‚Üí  private spawnPoints: Vector3[] = [];
   220‚Üí
   221‚Üí  constructor(
   222‚Üí    engine: Engine,
   223‚Üí    canvas: HTMLCanvasElement,
   224‚Üí    config: LevelConfig,
   225‚Üí    callbacks: LevelCallbacks
   226‚Üí  ) {
   227‚Üí    super(engine, canvas, config, callbacks);
   228‚Üí  }
   229‚Üí
   230‚Üí  protected getBackgroundColor(): Color4 {
   231‚Üí    // Orange-red sunset sky
   232‚Üí    return new Color4(0.85, 0.55, 0.35, 1);
   233‚Üí  }
   234‚Üí
   235‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   236‚Üí    // Override default lighting with sunset-style
   237‚Üí    this.setupSunsetLighting();
   238‚Üí
   239‚Üí    // Create environment
   240‚Üí    this.createTerrain();
   241‚Üí    this.createCanyonWalls();
   242‚Üí    this.createRockPillars();
   243‚Üí    this.createBreach();
   244‚Üí    this.createSkyDome();
   245‚Üí    this.generateSpawnPoints();
   246‚Üí
   247‚Üí    // Create Marcus
   248‚Üí    this.createMarcusMech();
   249‚Üí
   250‚Üí    // Setup camera for FPS
   251‚Üí    this.camera.position.set(0, 1.7, 50);
   252‚Üí    this.rotationY = Math.PI;
   253‚Üí    this.camera.rotation.y = this.rotationY;
   254‚Üí
   255‚Üí    // Setup action handler
   256‚Üí    this.actionCallback = this.handleAction.bind(this);
   257‚Üí    this.callbacks.onActionHandlerRegister(this.actionCallback);
   258‚Üí
   259‚Üí    // Start reunion phase
   260‚Üí    this.startReunionPhase();
   261‚Üí  }
   262‚Üí
   263‚Üí  private setupSunsetLighting(): void {
   264‚Üí    // Remove default lighting
   265‚Üí    if (this.sunLight) {
   266‚Üí      this.sunLight.dispose();
   267‚Üí      this.sunLight = null;
   268‚Üí    }
   269‚Üí    if (this.ambientLight) {
   270‚Üí      this.ambientLight.dispose();
   271‚Üí      this.ambientLight = null;
   272‚Üí    }
   273‚Üí
   274‚Üí    // Low-angle sunset sun
   275‚Üí    const sunDir = new Vector3(0.5, -0.3, -0.6).normalize();
   276‚Üí    const sun = new DirectionalLight(&#x27;sunsetSun&#x27;, sunDir, this.scene);
   277‚Üí    sun.intensity = 2.5;
   278‚Üí    sun.diffuse = Color3.FromHexString(&#x27;#FFA040&#x27;); // Orange-red
   279‚Üí    sun.specular = Color3.FromHexString(&#x27;#FFD080&#x27;);
   280‚Üí    this.sunLight = sun;
   281‚Üí
   282‚Üí    // Ambient fill with warm tones
   283‚Üí    const ambient = new DirectionalLight(&#x27;ambientFill&#x27;, new Vector3(0, 1, 0), this.scene);
   284‚Üí    ambient.intensity = 0.4;
   285‚Üí    ambient.diffuse = new Color3(0.5, 0.35, 0.25);
   286‚Üí  }
   287‚Üí
   288‚Üí  private createTerrain(): void {
   289‚Üí    this.terrain = MeshBuilder.CreateGround(
   290‚Üí      &#x27;terrain&#x27;,
   291‚Üí      {
   292‚Üí        width: ARENA_WIDTH * 1.5,
   293‚Üí        height: ARENA_DEPTH * 1.5,
   294‚Üí        subdivisions: 64,
   295‚Üí      },
   296‚Üí      this.scene
   297‚Üí    );
   298‚Üí
   299‚Üí    const terrainMat = new StandardMaterial(&#x27;terrainMat&#x27;, this.scene);
   300‚Üí    terrainMat.diffuseColor = Color3.FromHexString(&#x27;#9B7B5A&#x27;); // Rust brown
   301‚Üí    terrainMat.specularColor = new Color3(0.05, 0.04, 0.03);
   302‚Üí    this.terrain.material = terrainMat;
   303‚Üí  }
   304‚Üí
   305‚Üí  private createCanyonWalls(): void {
   306‚Üí    const wallMat = new StandardMaterial(&#x27;wallMat&#x27;, this.scene);
   307‚Üí    wallMat.diffuseColor = Color3.FromHexString(&#x27;#6B4423&#x27;); // Dark brown
   308‚Üí
   309‚Üí    // North wall
   310‚Üí    const northWall = MeshBuilder.CreateBox(
   311‚Üí      &#x27;northWall&#x27;,
   312‚Üí      { width: ARENA_WIDTH * 1.5, height: 80, depth: 30 },
   313‚Üí      this.scene
   314‚Üí    );
   315‚Üí    northWall.position.set(0, 40, -ARENA_DEPTH / 2 - 30);
   316‚Üí    northWall.material = wallMat;
   317‚Üí    this.canyonWalls.push(northWall);
   318‚Üí
   319‚Üí    // South wall
   320‚Üí    const southWall = MeshBuilder.CreateBox(
   321‚Üí      &#x27;southWall&#x27;,
   322‚Üí      { width: ARENA_WIDTH * 1.5, height: 80, depth: 30 },
   323‚Üí      this.scene
   324‚Üí    );
   325‚Üí    southWall.position.set(0, 40, ARENA_DEPTH / 2 + 30);
   326‚Üí    southWall.material = wallMat;
   327‚Üí    this.canyonWalls.push(southWall);
   328‚Üí
   329‚Üí    // East wall
   330‚Üí    const eastWall = MeshBuilder.CreateBox(
   331‚Üí      &#x27;eastWall&#x27;,
   332‚Üí      { width: 30, height: 80, depth: ARENA_DEPTH * 1.5 },
   333‚Üí      this.scene
   334‚Üí    );
   335‚Üí    eastWall.position.set(ARENA_WIDTH / 2 + 30, 40, 0);
   336‚Üí    eastWall.material = wallMat;
   337‚Üí    this.canyonWalls.push(eastWall);
   338‚Üí
   339‚Üí    // West wall
   340‚Üí    const westWall = MeshBuilder.CreateBox(
   341‚Üí      &#x27;westWall&#x27;,
   342‚Üí      { width: 30, height: 80, depth: ARENA_DEPTH * 1.5 },
   343‚Üí      this.scene
   344‚Üí    );
   345‚Üí    westWall.position.set(-ARENA_WIDTH / 2 - 30, 40, 0);
   346‚Üí    westWall.material = wallMat;
   347‚Üí    this.canyonWalls.push(westWall);
   348‚Üí  }
   349‚Üí
   350‚Üí  private createRockPillars(): void {
   351‚Üí    const pillarMat = new StandardMaterial(&#x27;pillarMat&#x27;, this.scene);
   352‚Üí    pillarMat.diffuseColor = Color3.FromHexString(&#x27;#8B5A2B&#x27;);
   353‚Üí    pillarMat.specularColor = new Color3(0.08, 0.06, 0.04);
   354‚Üí
   355‚Üí    // Create 10-15 rock pillars for cover
   356‚Üí    const pillarPositions = [
   357‚Üí      new Vector3(-40, 0, 30),
   358‚Üí      new Vector3(35, 0, 25),
   359‚Üí      new Vector3(-25, 0, -10),
   360‚Üí      new Vector3(50, 0, 0),
   361‚Üí      new Vector3(-55, 0, 15),
   362‚Üí      new Vector3(20, 0, -30),
   363‚Üí      new Vector3(-45, 0, -25),
   364‚Üí      new Vector3(60, 0, -20),
   365‚Üí      new Vector3(-30, 0, 50),
   366‚Üí      new Vector3(45, 0, 45),
   367‚Üí      new Vector3(-60, 0, -40),
   368‚Üí      new Vector3(25, 0, 55),
   369‚Üí      new Vector3(-15, 0, 40),
   370‚Üí    ];
   371‚Üí
   372‚Üí    pillarPositions.forEach((pos, i) =&gt; {
   373‚Üí      const height = 8 + Math.random() * 12;
   374‚Üí      const diameterBottom = 3 + Math.random() * 3;
   375‚Üí      const diameterTop = diameterBottom * (0.4 + Math.random() * 0.3);
   376‚Üí
   377‚Üí      const pillar = MeshBuilder.CreateCylinder(
   378‚Üí        `pillar_${i}`,
   379‚Üí        {
   380‚Üí          height,
   381‚Üí          diameterTop,
   382‚Üí          diameterBottom,
   383‚Üí          tessellation: 8,
   384‚Üí        },
   385‚Üí        this.scene
   386‚Üí      );
   387‚Üí
   388‚Üí      pillar.position = pos.clone();
   389‚Üí      pillar.position.y = height / 2;
   390‚Üí      pillar.material = pillarMat;
   391‚Üí
   392‚Üí      // Slight random rotation for variety
   393‚Üí      pillar.rotation.y = Math.random() * Math.PI * 2;
   394‚Üí
   395‚Üí      this.rockPillars.push(pillar);
   396‚Üí    });
   397‚Üí  }
   398‚Üí
   399‚Üí  private createBreach(): void {
   400‚Üí    // The Breach - massive sinkhole entrance to hive
   401‚Üí    // Create as a cylinder going down
   402‚Üí    this.breachMesh = MeshBuilder.CreateCylinder(
   403‚Üí      &#x27;breach&#x27;,
   404‚Üí      {
   405‚Üí        height: 50,
   406‚Üí        diameter: BREACH_DIAMETER,
   407‚Üí        tessellation: 32,
   408‚Üí      },
   409‚Üí      this.scene
   410‚Üí    );
   411‚Üí
   412‚Üí    const breachMat = new StandardMaterial(&#x27;breachMat&#x27;, this.scene);
   413‚Üí    breachMat.diffuseColor = new Color3(0.15, 0.1, 0.15);
   414‚Üí    breachMat.emissiveColor = new Color3(0.05, 0.15, 0.15); // Slight bioluminescent glow
   415‚Üí    this.breachMesh.material = breachMat;
   416‚Üí
   417‚Üí    this.breachMesh.position = BREACH_POSITION.clone();
   418‚Üí    this.breachMesh.position.y = -25;
   419‚Üí
   420‚Üí    // Create rim around breach
   421‚Üí    const rimMat = new StandardMaterial(&#x27;rimMat&#x27;, this.scene);
   422‚Üí    rimMat.diffuseColor = Color3.FromHexString(&#x27;#5A3A5A&#x27;);
   423‚Üí    rimMat.emissiveColor = new Color3(0.1, 0.3, 0.3);
   424‚Üí
   425‚Üí    const rim = MeshBuilder.CreateTorus(
   426‚Üí      &#x27;breachRim&#x27;,
   427‚Üí      {
   428‚Üí        diameter: BREACH_DIAMETER + 5,
   429‚Üí        thickness: 4,
   430‚Üí        tessellation: 32,
   431‚Üí      },
   432‚Üí      this.scene
   433‚Üí    );
   434‚Üí    rim.position = BREACH_POSITION.clone();
   435‚Üí    rim.position.y = 0.5;
   436‚Üí    rim.rotation.x = Math.PI / 2;
   437‚Üí    rim.material = rimMat;
   438‚Üí
   439‚Üí    // Bioluminescent glow from below
   440‚Üí    this.breachGlow = new PointLight(&#x27;breachGlow&#x27;, BREACH_POSITION.clone(), this.scene);
   441‚Üí    this.breachGlow.position.y = -10;
   442‚Üí    this.breachGlow.intensity = 1.5;
   443‚Üí    this.breachGlow.diffuse = Color3.FromHexString(&#x27;#4AC8C8&#x27;);
   444‚Üí    this.breachGlow.range = 80;
   445‚Üí  }
   446‚Üí
   447‚Üí  private createSkyDome(): void {
   448‚Üí    this.skyDome = MeshBuilder.CreateSphere(
   449‚Üí      &#x27;sky&#x27;,
   450‚Üí      {
   451‚Üí        diameter: 5000,
   452‚Üí        segments: 16,
   453‚Üí        sideOrientation: 1, // Inside facing
   454‚Üí      },
   455‚Üí      this.scene
   456‚Üí    );
   457‚Üí
   458‚Üí    const skyMat = new StandardMaterial(&#x27;skyMat&#x27;, this.scene);
   459‚Üí    skyMat.emissiveColor = new Color3(0.85, 0.55, 0.35); // Sunset orange
   460‚Üí    skyMat.disableLighting = true;
   461‚Üí    this.skyDome.material = skyMat;
   462‚Üí  }
   463‚Üí
   464‚Üí  private generateSpawnPoints(): void {
   465‚Üí    // Generate spawn points around arena edges
   466‚Üí    this.spawnPoints = [];
   467‚Üí
   468‚Üí    // North edge (behind breach)
   469‚Üí    for (let i = 0; i &lt; 5; i++) {
   470‚Üí      const x = (i - 2) * 30;
   471‚Üí      this.spawnPoints.push(new Vector3(x, 0, -ARENA_DEPTH / 2 + 20));
   472‚Üí    }
   473‚Üí
   474‚Üí    // East edge
   475‚Üí    for (let i = 0; i &lt; 4; i++) {
   476‚Üí      const z = (i - 1.5) * 30;
   477‚Üí      this.spawnPoints.push(new Vector3(ARENA_WIDTH / 2 - 20, 0, z));
   478‚Üí    }
   479‚Üí
   480‚Üí    // West edge
   481‚Üí    for (let i = 0; i &lt; 4; i++) {
   482‚Üí      const z = (i - 1.5) * 30;
   483‚Üí      this.spawnPoints.push(new Vector3(-ARENA_WIDTH / 2 + 20, 0, z));
   484‚Üí    }
   485‚Üí
   486‚Üí    // South edge (near player start)
   487‚Üí    for (let i = 0; i &lt; 5; i++) {
   488‚Üí      const x = (i - 2) * 30;
   489‚Üí      this.spawnPoints.push(new Vector3(x, 0, ARENA_DEPTH / 2 - 30));
   490‚Üí    }
   491‚Üí
   492‚Üí    // Assign to waves
   493‚Üí    WAVES.forEach((wave) =&gt; {
   494‚Üí      wave.spawnPoints = [...this.spawnPoints];
   495‚Üí    });
   496‚Üí  }
   497‚Üí
   498‚Üí  // ============================================================================
   499‚Üí  // MARCUS MECH
   500‚Üí  // ============================================================================
   501‚Üí
   502‚Üí  private createMarcusMech(): void {
   503‚Üí    const root = new TransformNode(&#x27;marcusRoot&#x27;, this.scene);
   504‚Üí    root.position = MARCUS_START_POSITION.clone();
   505‚Üí
   506‚Üí    // Materials
   507‚Üí    const bodyMat = new StandardMaterial(&#x27;mechBodyMat&#x27;, this.scene);
   508‚Üí    bodyMat.diffuseColor = Color3.FromHexString(tokens.colors.primary.oliveDark);
   509‚Üí    bodyMat.specularColor = new Color3(0.4, 0.4, 0.4);
   510‚Üí
   511‚Üí    const accentMat = new StandardMaterial(&#x27;mechAccentMat&#x27;, this.scene);
   512‚Üí    accentMat.diffuseColor = Color3.FromHexString(tokens.colors.accent.gunmetal);
   513‚Üí    accentMat.emissiveColor = new Color3(0.1, 0.15, 0.1);
   514‚Üí
   515‚Üí    // Body (torso) - scaled up to 8m tall total
   516‚Üí    const body = MeshBuilder.CreateBox(&#x27;mechBody&#x27;, { width: 4, height: 5, depth: 3 }, this.scene);
   517‚Üí    body.material = bodyMat;
   518‚Üí    body.parent = root;
   519‚Üí    body.position.y = 6;
   520‚Üí
   521‚Üí    // Cockpit
   522‚Üí    const cockpit = MeshBuilder.CreateBox(
   523‚Üí      &#x27;cockpit&#x27;,
   524‚Üí      { width: 2, height: 1.2, depth: 1 },
   525‚Üí      this.scene
   526‚Üí    );
   527‚Üí    cockpit.material = accentMat;
   528‚Üí    cockpit.parent = body;
   529‚Üí    cockpit.position.set(0, 2, 1);
   530‚Üí
   531‚Üí    // Left arm with autocannon
   532‚Üí    const leftArm = MeshBuilder.CreateCylinder(
   533‚Üí      &#x27;mechLeftArm&#x27;,
   534‚Üí      { height: 5, diameter: 1 },
   535‚Üí      this.scene
   536‚Üí    );
   537‚Üí    leftArm.material = bodyMat;
   538‚Üí    leftArm.parent = root;
   539‚Üí    leftArm.position.set(-3, 5.5, 0);
   540‚Üí    leftArm.rotation.z = 0.3;
   541‚Üí
   542‚Üí    // Left autocannon barrel
   543‚Üí    const leftBarrel = MeshBuilder.CreateCylinder(
   544‚Üí      &#x27;leftBarrel&#x27;,
   545‚Üí      { height: 3.5, diameter: 0.5 },
   546‚Üí      this.scene
   547‚Üí    );
   548‚Üí    leftBarrel.material = accentMat;
   549‚Üí    leftBarrel.parent = leftArm;
   550‚Üí    leftBarrel.position.y = -3.5;
   551‚Üí    leftBarrel.rotation.x = Math.PI / 2;
   552‚Üí
   553‚Üí    // Right arm with autocannon
   554‚Üí    const rightArm = MeshBuilder.CreateCylinder(
   555‚Üí      &#x27;mechRightArm&#x27;,
   556‚Üí      { height: 5, diameter: 1 },
   557‚Üí      this.scene
   558‚Üí    );
   559‚Üí    rightArm.material = bodyMat;
   560‚Üí    rightArm.parent = root;
   561‚Üí    rightArm.position.set(3, 5.5, 0);
   562‚Üí    rightArm.rotation.z = -0.3;
   563‚Üí
   564‚Üí    // Right autocannon barrel
   565‚Üí    const rightBarrel = MeshBuilder.CreateCylinder(
   566‚Üí      &#x27;rightBarrel&#x27;,
   567‚Üí      { height: 3.5, diameter: 0.5 },
   568‚Üí      this.scene
   569‚Üí    );
   570‚Üí    rightBarrel.material = accentMat;
   571‚Üí    rightBarrel.parent = rightArm;
   572‚Üí    rightBarrel.position.y = -3.5;
   573‚Üí    rightBarrel.rotation.x = Math.PI / 2;
   574‚Üí
   575‚Üí    // Legs container
   576‚Üí    const legs = MeshBuilder.CreateBox(
   577‚Üí      &#x27;mechLegs&#x27;,
   578‚Üí      { width: 3.5, height: 0.8, depth: 2 },
   579‚Üí      this.scene
   580‚Üí    );
   581‚Üí    legs.visibility = 0;
   582‚Üí    legs.parent = root;
   583‚Üí    legs.position.y = 3;
   584‚Üí
   585‚Üí    // Left leg
   586‚Üí    const leftLeg = MeshBuilder.CreateCylinder(
   587‚Üí      &#x27;leftLeg&#x27;,
   588‚Üí      { height: 5.5, diameterTop: 1, diameterBottom: 1.5 },
   589‚Üí      this.scene
   590‚Üí    );
   591‚Üí    leftLeg.material = bodyMat;
   592‚Üí    leftLeg.parent = legs;
   593‚Üí    leftLeg.position.set(-1, -2.75, 0);
   594‚Üí
   595‚Üí    // Right leg
   596‚Üí    const rightLeg = MeshBuilder.CreateCylinder(
   597‚Üí      &#x27;rightLeg&#x27;,
   598‚Üí      { height: 5.5, diameterTop: 1, diameterBottom: 1.5 },
   599‚Üí      this.scene
   600‚Üí    );
   601‚Üí    rightLeg.material = bodyMat;
   602‚Üí    rightLeg.parent = legs;
   603‚Üí    rightLeg.position.set(1, -2.75, 0);
   604‚Üí
   605‚Üí    // Feet
   606‚Üí    const footMat = new StandardMaterial(&#x27;footMat&#x27;, this.scene);
   607‚Üí    footMat.diffuseColor = Color3.FromHexString(tokens.colors.accent.gunmetal);
   608‚Üí
   609‚Üí    const leftFoot = MeshBuilder.CreateBox(
   610‚Üí      &#x27;leftFoot&#x27;,
   611‚Üí      { width: 2, height: 0.6, depth: 2.5 },
   612‚Üí      this.scene
   613‚Üí    );
   614‚Üí    leftFoot.material = footMat;
   615‚Üí    leftFoot.parent = legs;
   616‚Üí    leftFoot.position.set(-1, -5.8, 0.3);
   617‚Üí
   618‚Üí    const rightFoot = MeshBuilder.CreateBox(
   619‚Üí      &#x27;rightFoot&#x27;,
   620‚Üí      { width: 2, height: 0.6, depth: 2.5 },
   621‚Üí      this.scene
   622‚Üí    );
   623‚Üí    rightFoot.material = footMat;
   624‚Üí    rightFoot.parent = legs;
   625‚Üí    rightFoot.position.set(1, -5.8, 0.3);
   626‚Üí
   627‚Üí    this.marcus = {
   628‚Üí      rootNode: root,
   629‚Üí      body,
   630‚Üí      leftArm,
   631‚Üí      rightArm,
   632‚Üí      legs,
   633‚Üí      position: MARCUS_START_POSITION.clone(),
   634‚Üí      health: 100,
   635‚Üí      maxHealth: 100,
   636‚Üí      targetEnemy: null,
   637‚Üí      state: &#x27;dialogue&#x27;,
   638‚Üí      lastFireTime: 0,
   639‚Üí      fireRate: 2, // 2 shots per second
   640‚Üí      damage: 50,
   641‚Üí      range: 80,
   642‚Üí    };
   643‚Üí  }
   644‚Üí
   645‚Üí  private updateMarcus(deltaTime: number): void {
   646‚Üí    if (!this.marcus) return;
   647‚Üí
   648‚Üí    const playerPos = this.camera.position.clone();
   649‚Üí    playerPos.y = 0;
   650‚Üí
   651‚Üí    // Marcus behavior based on state
   652‚Üí    switch (this.marcus.state) {
   653‚Üí      case &#x27;dialogue&#x27;:
   654‚Üí        // Just face player
   655‚Üí        this.faceMarcusTowards(playerPos);
   656‚Üí        break;
   657‚Üí
   658‚Üí      case &#x27;patrol&#x27;:
   659‚Üí        // Follow player loosely (stay ~20m away)
   660‚Üí        this.marcusFollowPlayer(deltaTime);
   661‚Üí        break;
   662‚Üí
   663‚Üí      case &#x27;combat&#x27;:
   664‚Üí        // Target enemies &gt;15m from player, provide covering fire
   665‚Üí        this.marcusCombat(deltaTime);
   666‚Üí        break;
   667‚Üí    }
   668‚Üí
   669‚Üí    // Update root position
   670‚Üí    this.marcus.rootNode.position = this.marcus.position.clone();
   671‚Üí
   672‚Üí    // Walking animation when moving
   673‚Üí    const time = performance.now() * 0.003;
   674‚Üí    if (this.marcus.state !== &#x27;dialogue&#x27;) {
   675‚Üí      this.marcus.legs.position.y = 3 + Math.sin(time) * 0.15;
   676‚Üí    }
   677‚Üí  }
   678‚Üí
   679‚Üí  private faceMarcusTowards(target: Vector3): void {
   680‚Üí    if (!this.marcus) return;
   681‚Üí
   682‚Üí    const direction = target.subtract(this.marcus.position);
   683‚Üí    direction.y = 0;
   684‚Üí
   685‚Üí    if (direction.length() &gt; 0.1) {
   686‚Üí      const targetRotation = Math.atan2(direction.x, direction.z);
   687‚Üí      this.marcus.rootNode.rotation.y = targetRotation;
   688‚Üí    }
   689‚Üí  }
   690‚Üí
   691‚Üí  private marcusFollowPlayer(deltaTime: number): void {
   692‚Üí    if (!this.marcus) return;
   693‚Üí
   694‚Üí    const playerPos = this.camera.position.clone();
   695‚Üí    playerPos.y = 0;
   696‚Üí
   697‚Üí    const toPlayer = playerPos.subtract(this.marcus.position);
   698‚Üí    const distance = toPlayer.length();
   699‚Üí
   700‚Üí    // Stay between 15-25m from player
   701‚Üí    if (distance &gt; 25) {
   702‚Üí      toPlayer.normalize();
   703‚Üí      this.marcus.position.addInPlace(toPlayer.scale(10 * deltaTime));
   704‚Üí      this.faceMarcusTowards(playerPos);
   705‚Üí    } else if (distance &lt; 15) {
   706‚Üí      toPlayer.normalize();
   707‚Üí      this.marcus.position.subtractInPlace(toPlayer.scale(5 * deltaTime));
   708‚Üí    }
   709‚Üí
   710‚Üí    // Keep Marcus in arena bounds
   711‚Üí    this.marcus.position.x = Math.max(
   712‚Üí      -ARENA_WIDTH / 2 + 10,
   713‚Üí      Math.min(ARENA_WIDTH / 2 - 10, this.marcus.position.x)
   714‚Üí    );
   715‚Üí    this.marcus.position.z = Math.max(
   716‚Üí      -ARENA_DEPTH / 2 + 10,
   717‚Üí      Math.min(ARENA_DEPTH / 2 - 10, this.marcus.position.z)
   718‚Üí    );
   719‚Üí  }
   720‚Üí
   721‚Üí  private marcusCombat(deltaTime: number): void {
   722‚Üí    if (!this.marcus) return;
   723‚Üí
   724‚Üí    // Find enemy &gt;15m from player to target
   725‚Üí    const playerPos = this.camera.position.clone();
   726‚Üí    playerPos.y = 0;
   727‚Üí
   728‚Üí    let bestTarget: ActiveEnemy | null = null;
   729‚Üí    let bestDistance = Infinity;
   730‚Üí
   731‚Üí    for (const enemy of this.waveEnemies) {
   732‚Üí      if (enemy.state === &#x27;dead&#x27;) continue;
   733‚Üí
   734‚Üí      const enemyPos = enemy.mesh.position.clone();
   735‚Üí      enemyPos.y = 0;
   736‚Üí
   737‚Üí      const distToPlayer = Vector3.Distance(enemyPos, playerPos);
   738‚Üí      const distToMarcus = Vector3.Distance(enemyPos, this.marcus.position);
   739‚Üí
   740‚Üí      // Only target enemies &gt;15m from player that are in range
   741‚Üí      if (distToPlayer &gt; 15 &amp;&amp; distToMarcus &lt; this.marcus.range &amp;&amp; distToMarcus &lt; bestDistance) {
   742‚Üí        bestDistance = distToMarcus;
   743‚Üí        bestTarget = enemy;
   744‚Üí      }
   745‚Üí    }
   746‚Üí
   747‚Üí    if (bestTarget) {
   748‚Üí      // Face and fire at target
   749‚Üí      this.faceMarcusTowards(bestTarget.mesh.position);
   750‚Üí      this.marcusFire(bestTarget);
   751‚Üí    } else {
   752‚Üí      // No valid target, follow player
   753‚Üí      this.marcusFollowPlayer(deltaTime);
   754‚Üí    }
   755‚Üí  }
   756‚Üí
   757‚Üí  private marcusFire(target: ActiveEnemy): void {
   758‚Üí    if (!this.marcus) return;
   759‚Üí
   760‚Üí    const now = performance.now();
   761‚Üí    const fireInterval = 1000 / this.marcus.fireRate;
   762‚Üí
   763‚Üí    if (now - this.marcus.lastFireTime &lt; fireInterval) return;
   764‚Üí    this.marcus.lastFireTime = now;
   765‚Üí
   766‚Üí    // Create projectile from both arms
   767‚Üí    const arms = [this.marcus.leftArm, this.marcus.rightArm];
   768‚Üí
   769‚Üí    for (const arm of arms) {
   770‚Üí      const startPos = arm.absolutePosition.clone();
   771‚Üí      startPos.y -= 2;
   772‚Üí
   773‚Üí      const direction = target.mesh.position.subtract(startPos).normalize();
   774‚Üí      const velocity = direction.scale(60);
   775‚Üí
   776‚Üí      // Create projectile mesh
   777‚Üí      const projectile = MeshBuilder.CreateSphere(
   778‚Üí        &#x27;marcusProjectile&#x27;,
   779‚Üí        { diameter: 0.6 },
   780‚Üí        this.scene
   781‚Üí      );
   782‚Üí      projectile.position = startPos;
   783‚Üí
   784‚Üí      const projMat = new StandardMaterial(&#x27;marcusProjMat&#x27;, this.scene);
   785‚Üí      projMat.emissiveColor = Color3.FromHexString(tokens.colors.accent.brass);
   786‚Üí      projMat.disableLighting = true;
   787‚Üí      projectile.material = projMat;
   788‚Üí
   789‚Üí      // Arm recoil
   790‚Üí      const originalZ = arm.rotation.z;
   791‚Üí      arm.rotation.z += arm.position.x &lt; 0 ? 0.15 : -0.15;
   792‚Üí      setTimeout(() =&gt; {
   793‚Üí        if (this.marcus) {
   794‚Üí          arm.rotation.z = arm.position.x &lt; 0 ? 0.3 : -0.3;
   795‚Üí        }
   796‚Üí      }, 100);
   797‚Üí
   798‚Üí      // Create projectile entity
   799‚Üí      const projEntity = createEntity({
   800‚Üí        transform: {
   801‚Üí          position: startPos.clone(),
   802‚Üí          rotation: Vector3.Zero(),
   803‚Üí          scale: new Vector3(1, 1, 1),
   804‚Üí        },
   805‚Üí        velocity: {
   806‚Üí          linear: velocity,
   807‚Üí          angular: Vector3.Zero(),
   808‚Üí          maxSpeed: 60,
   809‚Üí        },
   810‚Üí        renderable: {
   811‚Üí          mesh: projectile,
   812‚Üí          visible: true,
   813‚Üí        },
   814‚Üí        tags: {
   815‚Üí          projectile: true,
   816‚Üí          ally: true,
   817‚Üí        },
   818‚Üí        lifetime: {
   819‚Üí          remaining: 3000,
   820‚Üí          onExpire: () =&gt; {
   821‚Üí            projectile.material?.dispose();
   822‚Üí            projectile.dispose();
   823‚Üí          },
   824‚Üí        },
   825‚Üí      });
   826‚Üí
   827‚Üí      // Check collision with target after short delay
   828‚Üí      setTimeout(() =&gt; {
   829‚Üí        if (target.state !== &#x27;dead&#x27;) {
   830‚Üí          const dist = Vector3.Distance(projectile.position, target.mesh.position);
   831‚Üí          if (dist &lt; target.mesh.scaling.x + 1) {
   832‚Üí            target.health -= this.marcus!.damage;
   833‚Üí            if (target.health &lt;= 0) {
   834‚Üí              this.killEnemy(target);
   835‚Üí            }
   836‚Üí          }
   837‚Üí        }
   838‚Üí        projectile.material?.dispose();
   839‚Üí        projectile.dispose();
   840‚Üí        removeEntity(projEntity);
   841‚Üí      }, 500);
   842‚Üí    }
   843‚Üí  }
   844‚Üí
   845‚Üí  // ============================================================================
   846‚Üí  // ENEMY MANAGEMENT
   847‚Üí  // ============================================================================
   848‚Üí
   849‚Üí  private spawnEnemy(type: EnemyType, position: Vector3): ActiveEnemy {
   850‚Üí    const config = ENEMY_CONFIGS[type];
   851‚Üí
   852‚Üí    // Create enemy mesh based on type
   853‚Üí    let mesh: Mesh;
   854‚Üí
   855‚Üí    switch (type) {
   856‚Üí      case &#x27;drone&#x27;:
   857‚Üí        mesh = MeshBuilder.CreateSphere(
   858‚Üí          `drone_${Date.now()}`,
   859‚Üí          { diameter: config.size },
   860‚Üí          this.scene
   861‚Üí        );
   862‚Üí        break;
   863‚Üí      case &#x27;grunt&#x27;:
   864‚Üí        mesh = MeshBuilder.CreateCapsule(
   865‚Üí          `grunt_${Date.now()}`,
   866‚Üí          { height: config.size, radius: config.size * 0.3 },
   867‚Üí          this.scene
   868‚Üí        );
   869‚Üí        break;
   870‚Üí      case &#x27;spitter&#x27;:
   871‚Üí        mesh = MeshBuilder.CreateSphere(
   872‚Üí          `spitter_${Date.now()}`,
   873‚Üí          { diameterX: config.size, diameterY: config.size * 0.7, diameterZ: config.size },
   874‚Üí          this.scene
   875‚Üí        );
   876‚Üí        break;
   877‚Üí      case &#x27;brute&#x27;:
   878‚Üí        mesh = MeshBuilder.CreateBox(
   879‚Üí          `brute_${Date.now()}`,
   880‚Üí          { width: config.size, height: config.size * 1.2, depth: config.size * 0.8 },
   881‚Üí          this.scene
   882‚Üí        );
   883‚Üí        break;
   884‚Üí      default:
   885‚Üí        mesh = MeshBuilder.CreateSphere(
   886‚Üí          `enemy_${Date.now()}`,
   887‚Üí          { diameter: config.size },
   888‚Üí          this.scene
   889‚Üí        );
   890‚Üí    }
   891‚Üí
   892‚Üí    const mat = new StandardMaterial(`enemy_mat_${Date.now()}`, this.scene);
   893‚Üí    mat.diffuseColor = Color3.FromHexString(config.color);
   894‚Üí    mat.specularColor = new Color3(0.2, 0.2, 0.2);
   895‚Üí
   896‚Üí    // Add glowing eyes for all enemy types
   897‚Üí    const glowMat = new StandardMaterial(`enemy_glow_${Date.now()}`, this.scene);
   898‚Üí    glowMat.emissiveColor = Color3.FromHexString(&#x27;#4AFF9F&#x27;);
   899‚Üí    glowMat.disableLighting = true;
   900‚Üí
   901‚Üí    // Add eyes
   902‚Üí    const leftEye = MeshBuilder.CreateSphere(&#x27;eye&#x27;, { diameter: config.size * 0.1 }, this.scene);
   903‚Üí    leftEye.material = glowMat;
   904‚Üí    leftEye.parent = mesh;
   905‚Üí    leftEye.position.set(-config.size * 0.15, config.size * 0.2, -config.size * 0.4);
   906‚Üí
   907‚Üí    const rightEye = MeshBuilder.CreateSphere(&#x27;eye&#x27;, { diameter: config.size * 0.1 }, this.scene);
   908‚Üí    rightEye.material = glowMat;
   909‚Üí    rightEye.parent = mesh;
   910‚Üí    rightEye.position.set(config.size * 0.15, config.size * 0.2, -config.size * 0.4);
   911‚Üí
   912‚Üí    mesh.material = mat;
   913‚Üí    mesh.position = position.clone();
   914‚Üí    mesh.position.y = config.size / 2;
   915‚Üí
   916‚Üí    // Spawn animation - scale up
   917‚Üí    mesh.scaling.setAll(0.1);
   918‚Üí    const spawnStart = performance.now();
   919‚Üí    const animateSpawn = () =&gt; {
   920‚Üí      const elapsed = performance.now() - spawnStart;
   921‚Üí      const progress = Math.min(elapsed / 500, 1);
   922‚Üí      mesh.scaling.setAll(0.1 + progress * 0.9);
   923‚Üí      if (progress &lt; 1) requestAnimationFrame(animateSpawn);
   924‚Üí    };
   925‚Üí    requestAnimationFrame(animateSpawn);
   926‚Üí
   927‚Üí    const entity = createEntity({
   928‚Üí      transform: {
   929‚Üí        position: position.clone(),
   930‚Üí        rotation: Vector3.Zero(),
   931‚Üí        scale: new Vector3(1, 1, 1),
   932‚Üí      },
   933‚Üí      health: {
   934‚Üí        current: config.health,
   935‚Üí        max: config.health,
   936‚Üí        regenRate: 0,
   937‚Üí      },
   938‚Üí      tags: {
   939‚Üí        enemy: true,
   940‚Üí      },
   941‚Üí    });
   942‚Üí
   943‚Üí    const enemy: ActiveEnemy = {
   944‚Üí      entity,
   945‚Üí      mesh,
   946‚Üí      type,
   947‚Üí      health: config.health,
   948‚Üí      maxHealth: config.health,
   949‚Üí      speed: config.speed,
   950‚Üí      damage: config.damage,
   951‚Üí      attackRange: config.attackRange,
   952‚Üí      lastAttackTime: 0,
   953‚Üí      targetPosition: this.camera.position.clone(),
   954‚Üí      state: &#x27;spawning&#x27;,
   955‚Üí    };
   956‚Üí
   957‚Üí    setTimeout(() =&gt; {
   958‚Üí      enemy.state = &#x27;moving&#x27;;
   959‚Üí    }, 500);
   960‚Üí
   961‚Üí    this.waveEnemies.push(enemy);
   962‚Üí    return enemy;
   963‚Üí  }
   964‚Üí
   965‚Üí  private updateEnemies(deltaTime: number): void {
   966‚Üí    const playerPos = this.camera.position.clone();
   967‚Üí
   968‚Üí    for (const enemy of this.waveEnemies) {
   969‚Üí      if (enemy.state === &#x27;dead&#x27;) continue;
   970‚Üí
   971‚Üí      // Update target position
   972‚Üí      enemy.targetPosition = playerPos.clone();
   973‚Üí
   974‚Üí      const toPlayer = enemy.targetPosition.subtract(enemy.mesh.position);
   975‚Üí      toPlayer.y = 0;
   976‚Üí      const distance = toPlayer.length();
   977‚Üí
   978‚Üí      // Face player
   979‚Üí      if (distance &gt; 0.1) {
   980‚Üí        const targetRotation = Math.atan2(toPlayer.x, toPlayer.z);
   981‚Üí        enemy.mesh.rotation.y = targetRotation;
   982‚Üí      }
   983‚Üí
   984‚Üí      // Move or attack
   985‚Üí      if (distance &gt; enemy.attackRange) {
   986‚Üí        // Move towards player
   987‚Üí        enemy.state = &#x27;moving&#x27;;
   988‚Üí        toPlayer.normalize();
   989‚Üí        enemy.mesh.position.addInPlace(toPlayer.scale(enemy.speed * deltaTime));
   990‚Üí      } else {
   991‚Üí        // Attack player
   992‚Üí        enemy.state = &#x27;attacking&#x27;;
   993‚Üí        const now = performance.now();
   994‚Üí        const attackInterval = enemy.type === &#x27;spitter&#x27; ? 2000 : 1000;
   995‚Üí
   996‚Üí        if (now - enemy.lastAttackTime &gt; attackInterval) {
   997‚Üí          enemy.lastAttackTime = now;
   998‚Üí
   999‚Üí          if (enemy.type === &#x27;spitter&#x27;) {
  1000‚Üí            // Ranged attack - spawn projectile
  1001‚Üí            this.spawnEnemyProjectile(enemy);
  1002‚Üí          } else {
  1003‚Üí            // Melee attack - direct damage
  1004‚Üí            this.playerHealth -= enemy.damage;
  1005‚Üí            this.callbacks.onHealthChange(this.playerHealth);
  1006‚Üí            this.callbacks.onDamage();
  1007‚Üí            this.triggerDamageShake(enemy.damage);
  1008‚Üí
  1009‚Üí            if (this.playerHealth &lt;= 0) {
  1010‚Üí              this.callbacks.onNotification(&#x27;CRITICAL DAMAGE - MISSION FAILED&#x27;, 3000);
  1011‚Üí            }
  1012‚Üí          }
  1013‚Üí        }
  1014‚Üí      }
  1015‚Üí
  1016‚Üí      // Update entity transform
  1017‚Üí      if (enemy.entity.transform) {
  1018‚Üí        enemy.entity.transform.position = enemy.mesh.position.clone();
  1019‚Üí      }
  1020‚Üí    }
  1021‚Üí  }
  1022‚Üí
  1023‚Üí  private spawnEnemyProjectile(enemy: ActiveEnemy): void {
  1024‚Üí    const startPos = enemy.mesh.position.clone();
  1025‚Üí    startPos.y += 0.5;
  1026‚Üí
  1027‚Üí    const direction = this.camera.position.subtract(startPos).normalize();
  1028‚Üí    const velocity = direction.scale(20);
  1029‚Üí
  1030‚Üí    const projectile = MeshBuilder.CreateSphere(&#x27;acidBolt&#x27;, { diameter: 0.4 }, this.scene);
  1031‚Üí    projectile.position = startPos;
  1032‚Üí
  1033‚Üí    const projMat = new StandardMaterial(&#x27;acidMat&#x27;, this.scene);
  1034‚Üí    projMat.emissiveColor = Color3.FromHexString(&#x27;#AAFF00&#x27;);
  1035‚Üí    projMat.disableLighting = true;
  1036‚Üí    projectile.material = projMat;
  1037‚Üí
  1038‚Üí    // Track projectile for collision
  1039‚Üí    const projEntity = createEntity({
  1040‚Üí      transform: {
  1041‚Üí        position: startPos.clone(),
  1042‚Üí        rotation: Vector3.Zero(),
  1043‚Üí        scale: new Vector3(1, 1, 1),
  1044‚Üí      },
  1045‚Üí      velocity: {
  1046‚Üí        linear: velocity,
  1047‚Üí        angular: Vector3.Zero(),
  1048‚Üí        maxSpeed: 20,
  1049‚Üí      },
  1050‚Üí      renderable: {
  1051‚Üí        mesh: projectile,
  1052‚Üí        visible: true,
  1053‚Üí      },
  1054‚Üí      tags: {
  1055‚Üí        projectile: true,
  1056‚Üí        enemy: true,
  1057‚Üí      },
  1058‚Üí      lifetime: {
  1059‚Üí        remaining: 3000,
  1060‚Üí        onExpire: () =&gt; {
  1061‚Üí          projectile.material?.dispose();
  1062‚Üí          projectile.dispose();
  1063‚Üí        },
  1064‚Üí      },
  1065‚Üí    });
  1066‚Üí
  1067‚Üí    // Check collision with player
  1068‚Üí    const checkCollision = () =&gt; {
  1069‚Üí      if (projectile.isDisposed()) return;
  1070‚Üí
  1071‚Üí      const dist = Vector3.Distance(projectile.position, this.camera.position);
  1072‚Üí      if (dist &lt; 1.5) {
  1073‚Üí        this.playerHealth -= enemy.damage;
  1074‚Üí        this.callbacks.onHealthChange(this.playerHealth);
  1075‚Üí        this.callbacks.onDamage();
  1076‚Üí        this.triggerDamageShake(enemy.damage);
  1077‚Üí        projectile.material?.dispose();
  1078‚Üí        projectile.dispose();
  1079‚Üí        removeEntity(projEntity);
  1080‚Üí        return;
  1081‚Üí      }
  1082‚Üí
  1083‚Üí      // Update projectile position
  1084‚Üí      projectile.position.addInPlace(velocity.scale(0.016));
  1085‚Üí
  1086‚Üí      if (!projectile.isDisposed()) {
  1087‚Üí        requestAnimationFrame(checkCollision);
  1088‚Üí      }
  1089‚Üí    };
  1090‚Üí    requestAnimationFrame(checkCollision);
  1091‚Üí  }
  1092‚Üí
  1093‚Üí  private killEnemy(enemy: ActiveEnemy): void {
  1094‚Üí    if (enemy.state === &#x27;dead&#x27;) return;
  1095‚Üí
  1096‚Üí    enemy.state = &#x27;dead&#x27;;
  1097‚Üí    this.totalKills++;
  1098‚Üí    this.callbacks.onKill();
  1099‚Üí
  1100‚Üí    // Death animation
  1101‚Üí    const startY = enemy.mesh.position.y;
  1102‚Üí    const startTime = performance.now();
  1103‚Üí
  1104‚Üí    const animateDeath = () =&gt; {
  1105‚Üí      const elapsed = performance.now() - startTime;
  1106‚Üí      const progress = Math.min(elapsed / 300, 1);
  1107‚Üí
  1108‚Üí      enemy.mesh.scaling.setAll(1 - progress);
  1109‚Üí      enemy.mesh.position.y = startY - progress * 0.5;
  1110‚Üí
  1111‚Üí      if (progress &lt; 1) {
  1112‚Üí        requestAnimationFrame(animateDeath);
  1113‚Üí      } else {
  1114‚Üí        enemy.mesh.dispose();
  1115‚Üí        removeEntity(enemy.entity);
  1116‚Üí      }
  1117‚Üí    };
  1118‚Üí    requestAnimationFrame(animateDeath);
  1119‚Üí  }
  1120‚Üí
  1121‚Üí  // ============================================================================
  1122‚Üí  // WAVE MANAGEMENT
  1123‚Üí  // ============================================================================
  1124‚Üí
  1125‚Üí  private startWave(waveIndex: number): void {
  1126‚Üí    if (waveIndex &gt;= WAVES.length) {
  1127‚Üí      this.allWavesComplete = true;
  1128‚Üí      return;
  1129‚Üí    }
  1130‚Üí
  1131‚Üí    const wave = WAVES[waveIndex];
  1132‚Üí    this.currentWave = waveIndex;
  1133‚Üí    this.waveComplete = false;
  1134‚Üí
  1135‚Üí    // Send dialogue
  1136‚Üí    this.callbacks.onCommsMessage({
  1137‚Üí      sender: wave.dialogueSender,
  1138‚Üí      callsign: &#x27;HAMMER&#x27;,
  1139‚Üí      portrait: &#x27;marcus&#x27;,
  1140‚Üí      text: wave.dialogue,
  1141‚Üí    });
  1142‚Üí
  1143‚Üí    this.callbacks.onNotification(`WAVE ${wave.id} INCOMING`, 2000);
  1144‚Üí    this.callbacks.onObjectiveUpdate(`WAVE ${wave.id}/${WAVES.length}`, &#x27;Eliminate all hostiles&#x27;);
  1145‚Üí
  1146‚Üí    // Set Marcus to combat mode
  1147‚Üí    if (this.marcus) {
  1148‚Üí      this.marcus.state = &#x27;combat&#x27;;
  1149‚Üí    }
  1150‚Üí
  1151‚Üí    // Spawn enemies
  1152‚Üí    let spawnIndex = 0;
  1153‚Üí    wave.enemies.forEach(({ type, count }) =&gt; {
  1154‚Üí      for (let i = 0; i &lt; count; i++) {
  1155‚Üí        const spawnPoint = wave.spawnPoints[spawnIndex % wave.spawnPoints.length];
  1156‚Üí        const offset = new Vector3((Math.random() - 0.5) * 10, 0, (Math.random() - 0.5) * 10);
  1157‚Üí        const position = spawnPoint.add(offset);
  1158‚Üí
  1159‚Üí        // Stagger spawns
  1160‚Üí        setTimeout(() =&gt; {
  1161‚Üí          this.spawnEnemy(type, position);
  1162‚Üí        }, spawnIndex * 200);
  1163‚Üí
  1164‚Üí        spawnIndex++;
  1165‚Üí      }
  1166‚Üí    });
  1167‚Üí  }
  1168‚Üí
  1169‚Üí  private checkWaveComplete(): boolean {
  1170‚Üí    const aliveEnemies = this.waveEnemies.filter((e) =&gt; e.state !== &#x27;dead&#x27;);
  1171‚Üí    return aliveEnemies.length === 0 &amp;&amp; !this.waveComplete;
  1172‚Üí  }
  1173‚Üí
  1174‚Üí  // ============================================================================
  1175‚Üí  // PHASE MANAGEMENT
  1176‚Üí  // ============================================================================
  1177‚Üí
  1178‚Üí  private startReunionPhase(): void {
  1179‚Üí    this.phase = &#x27;reunion&#x27;;
  1180‚Üí    this.phaseTime = 0;
  1181‚Üí
  1182‚Üí    // Unlock Reunited achievement - Marcus found!
  1183‚Üí    getAchievementManager().onMarcusFound();
  1184‚Üí
  1185‚Üí    this.callbacks.onCinematicStart?.();
  1186‚Üí    this.callbacks.onObjectiveUpdate(&#x27;REUNION&#x27;, &#x27;Link up with Marcus&#x27;);
  1187‚Üí
  1188‚Üí    // Initial dialogue sequence
  1189‚Üí    setTimeout(() =&gt; {
  1190‚Üí      this.callbacks.onCommsMessage({
  1191‚Üí        sender: &#x27;Marcus&#x27;,
  1192‚Üí        callsign: &#x27;HAMMER&#x27;,
  1193‚Üí        portrait: &#x27;marcus&#x27;,
  1194‚Üí        text: &#x27;James! You actually came.&#x27;,
  1195‚Üí      });
  1196‚Üí    }, 2000);
  1197‚Üí
  1198‚Üí    setTimeout(() =&gt; {
  1199‚Üí      this.callbacks.onCommsMessage({
  1200‚Üí        sender: &#x27;James&#x27;,
  1201‚Üí        callsign: &#x27;SPECTER&#x27;,
  1202‚Üí        portrait: &#x27;player&#x27;,
  1203‚Üí        text: &quot;I wasn&#x27;t going to leave you out here, little brother.&quot;,
  1204‚Üí      });
  1205‚Üí    }, 6000);
  1206‚Üí
  1207‚Üí    setTimeout(() =&gt; {
  1208‚Üí      this.callbacks.onCommsMessage({
  1209‚Üí        sender: &#x27;Marcus&#x27;,
  1210‚Üí        callsign: &#x27;HAMMER&#x27;,
  1211‚Üí        portrait: &#x27;marcus&#x27;,
  1212‚Üí        text: &quot;There&#x27;s something down there. A queen. She controls them all.&quot;,
  1213‚Üí      });
  1214‚Üí    }, 10000);
  1215‚Üí
  1216‚Üí    setTimeout(() =&gt; {
  1217‚Üí      this.callbacks.onCinematicEnd?.();
  1218‚Üí      this.startWaveCombatPhase();
  1219‚Üí    }, 14000);
  1220‚Üí  }
  1221‚Üí
  1222‚Üí  private startWaveCombatPhase(): void {
  1223‚Üí    this.phase = &#x27;wave_combat&#x27;;
  1224‚Üí    this.phaseTime = 0;
  1225‚Üí
  1226‚Üí    // Setup combat action buttons
  1227‚Üí    this.updateActionButtons(&#x27;combat&#x27;);
  1228‚Üí
  1229‚Üí    // Start first wave
  1230‚Üí    this.startWave(0);
  1231‚Üí  }
  1232‚Üí
  1233‚Üí  private startBreachBattlePhase(): void {
  1234‚Üí    this.phase = &#x27;breach_battle&#x27;;
  1235‚Üí    this.phaseTime = 0;
  1236‚Üí
  1237‚Üí    this.callbacks.onNotification(&#x27;THE BREACH - FINAL BATTLE&#x27;, 3000);
  1238‚Üí    this.callbacks.onObjectiveUpdate(&#x27;THE BREACH&#x27;, &#x27;Clear the hive entrance&#x27;);
  1239‚Üí
  1240‚Üí    this.callbacks.onCommsMessage({
  1241‚Üí      sender: &#x27;Marcus&#x27;,
  1242‚Üí      callsign: &#x27;HAMMER&#x27;,
  1243‚Üí      portrait: &#x27;marcus&#x27;,
  1244‚Üí      text: &quot;That&#x27;s the entrance to the hive. We need to clear it out!&quot;,
  1245‚Üí    });
  1246‚Üí
  1247‚Üí    // Final wave already completed - now player must enter breach
  1248‚Üí    setTimeout(() =&gt; {
  1249‚Üí      this.startTransitionPhase();
  1250‚Üí    }, 5000);
  1251‚Üí  }
  1252‚Üí
  1253‚Üí  private startTransitionPhase(): void {
  1254‚Üí    this.phase = &#x27;transition&#x27;;
  1255‚Üí    this.phaseTime = 0;
  1256‚Üí
  1257‚Üí    this.callbacks.onCinematicStart?.();
  1258‚Üí    this.callbacks.onObjectiveUpdate(&#x27;ENTER THE BREACH&#x27;, &#x27;Descend into the hive&#x27;);
  1259‚Üí
  1260‚Üí    // Marcus dialogue about not being able to follow
  1261‚Üí    this.callbacks.onCommsMessage({
  1262‚Üí      sender: &#x27;Marcus&#x27;,
  1263‚Üí      callsign: &#x27;HAMMER&#x27;,
  1264‚Üí      portrait: &#x27;marcus&#x27;,
  1265‚Üí      text: &quot;I can&#x27;t fit in there. You&#x27;ll have to go alone.&quot;,
  1266‚Üí    });
  1267‚Üí
  1268‚Üí    setTimeout(() =&gt; {
  1269‚Üí      this.callbacks.onCommsMessage({
  1270‚Üí        sender: &#x27;Marcus&#x27;,
  1271‚Üí        callsign: &#x27;HAMMER&#x27;,
  1272‚Üí        portrait: &#x27;marcus&#x27;,
  1273‚Üí        text: &quot;Find the queen. End this. I&#x27;ll hold the surface.&quot;,
  1274‚Üí      });
  1275‚Üí    }, 4000);
  1276‚Üí
  1277‚Üí    setTimeout(() =&gt; {
  1278‚Üí      this.callbacks.onCinematicEnd?.();
  1279‚Üí
  1280‚Üí      // Update objective to enter breach
  1281‚Üí      this.callbacks.onNotification(&#x27;APPROACH THE BREACH&#x27;, 2000);
  1282‚Üí    }, 8000);
  1283‚Üí  }
  1284‚Üí
  1285‚Üí  // ============================================================================
  1286‚Üí  // ACTION HANDLING
  1287‚Üí  // ============================================================================
  1288‚Üí
  1289‚Üí  private handleAction(actionId: string): void {
  1290‚Üí    switch (actionId) {
  1291‚Üí      case &#x27;grenade&#x27;:
  1292‚Üí        if (this.grenadeCooldown &lt;= 0) {
  1293‚Üí          this.throwGrenade();
  1294‚Üí          this.grenadeCooldown = 5000;
  1295‚Üí        }
  1296‚Üí        break;
  1297‚Üí
  1298‚Üí      case &#x27;melee&#x27;:
  1299‚Üí        this.meleeAttack();
  1300‚Üí        break;
  1301‚Üí
  1302‚Üí      case &#x27;call_marcus&#x27;:
  1303‚Üí        if (this.fireSuportCooldown &lt;= 0 &amp;&amp; this.marcus) {
  1304‚Üí          this.callFireSupport();
  1305‚Üí          this.fireSuportCooldown = 30000;
  1306‚Üí        }
  1307‚Üí        break;
  1308‚Üí    }
  1309‚Üí  }
  1310‚Üí
  1311‚Üí  private throwGrenade(): void {
  1312‚Üí    this.callbacks.onNotification(&#x27;GRENADE OUT&#x27;, 1000);
  1313‚Üí
  1314‚Üí    // Create grenade projectile
  1315‚Üí    const startPos = this.camera.position.clone();
  1316‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
  1317‚Üí    const throwVelocity = forward.scale(30).add(new Vector3(0, 10, 0));
  1318‚Üí
  1319‚Üí    const grenade = MeshBuilder.CreateSphere(&#x27;grenade&#x27;, { diameter: 0.3 }, this.scene);
  1320‚Üí    grenade.position = startPos.add(forward.scale(1));
  1321‚Üí
  1322‚Üí    const grenadeMat = new StandardMaterial(&#x27;grenadeMat&#x27;, this.scene);
  1323‚Üí    grenadeMat.diffuseColor = Color3.FromHexString(tokens.colors.primary.olive);
  1324‚Üí    grenade.material = grenadeMat;
  1325‚Üí
  1326‚Üí    // Animate grenade flight
  1327‚Üí    const velocity = throwVelocity.clone();
  1328‚Üí    const gravity = new Vector3(0, -40, 0);
  1329‚Üí    const startTime = performance.now();
  1330‚Üí
  1331‚Üí    const animateGrenade = () =&gt; {
  1332‚Üí      const dt = 0.016;
  1333‚Üí      velocity.addInPlace(gravity.scale(dt));
  1334‚Üí      grenade.position.addInPlace(velocity.scale(dt));
  1335‚Üí
  1336‚Üí      // Ground collision
  1337‚Üí      if (grenade.position.y &lt;= 0.3) {
  1338‚Üí        // Explode
  1339‚Üí        this.explodeGrenade(grenade.position.clone());
  1340‚Üí        grenade.dispose();
  1341‚Üí        return;
  1342‚Üí      }
  1343‚Üí
  1344‚Üí      // Timeout after 3 seconds
  1345‚Üí      if (performance.now() - startTime &gt; 3000) {
  1346‚Üí        this.explodeGrenade(grenade.position.clone());
  1347‚Üí        grenade.dispose();
  1348‚Üí        return;
  1349‚Üí      }
  1350‚Üí
  1351‚Üí      requestAnimationFrame(animateGrenade);
  1352‚Üí    };
  1353‚Üí    requestAnimationFrame(animateGrenade);
  1354‚Üí  }
  1355‚Üí
  1356‚Üí  private explodeGrenade(position: Vector3): void {
  1357‚Üí    // Explosion effect
  1358‚Üí    const explosion = MeshBuilder.CreateSphere(&#x27;explosion&#x27;, { diameter: 2 }, this.scene);
  1359‚Üí    explosion.position = position;
  1360‚Üí
  1361‚Üí    const explosionMat = new StandardMaterial(&#x27;explosionMat&#x27;, this.scene);
  1362‚Üí    explosionMat.emissiveColor = Color3.FromHexString(&#x27;#FF8800&#x27;);
  1363‚Üí    explosionMat.disableLighting = true;
  1364‚Üí    explosion.material = explosionMat;
  1365‚Üí
  1366‚Üí    // Damage enemies in radius
  1367‚Üí    const damageRadius = 10;
  1368‚Üí    const damage = 75;
  1369‚Üí
  1370‚Üí    for (const enemy of this.waveEnemies) {
  1371‚Üí      if (enemy.state === &#x27;dead&#x27;) continue;
  1372‚Üí
  1373‚Üí      const dist = Vector3.Distance(enemy.mesh.position, position);
  1374‚Üí      if (dist &lt; damageRadius) {
  1375‚Üí        const damageAmount = damage * (1 - dist / damageRadius);
  1376‚Üí        enemy.health -= damageAmount;
  1377‚Üí
  1378‚Üí        if (enemy.health &lt;= 0) {
  1379‚Üí          this.killEnemy(enemy);
  1380‚Üí        }
  1381‚Üí      }
  1382‚Üí    }
  1383‚Üí
  1384‚Üí    // Animate explosion
  1385‚Üí    const startTime = performance.now();
  1386‚Üí    const animateExplosion = () =&gt; {
  1387‚Üí      const elapsed = performance.now() - startTime;
  1388‚Üí      const progress = elapsed / 500;
  1389‚Üí
  1390‚Üí      if (progress &lt; 1) {
  1391‚Üí        explosion.scaling.setAll(1 + progress * 4);
  1392‚Üí        explosionMat.alpha = 1 - progress;
  1393‚Üí        requestAnimationFrame(animateExplosion);
  1394‚Üí      } else {
  1395‚Üí        explosion.dispose();
  1396‚Üí      }
  1397‚Üí    };
  1398‚Üí    requestAnimationFrame(animateExplosion);
  1399‚Üí  }
  1400‚Üí
  1401‚Üí  private meleeAttack(): void {
  1402‚Üí    this.callbacks.onNotification(&#x27;MELEE&#x27;, 500);
  1403‚Üí
  1404‚Üí    // Check for enemies in melee range
  1405‚Üí    const playerPos = this.camera.position.clone();
  1406‚Üí    const forward = this.camera.getDirection(Vector3.Forward());
  1407‚Üí    const meleeRange = 3;
  1408‚Üí    const meleeDamage = 50;
  1409‚Üí
  1410‚Üí    for (const enemy of this.waveEnemies) {
  1411‚Üí      if (enemy.state === &#x27;dead&#x27;) continue;
  1412‚Üí
  1413‚Üí      const toEnemy = enemy.mesh.position.subtract(playerPos);
  1414‚Üí      const dist = toEnemy.length();
  1415‚Üí      toEnemy.normalize();
  1416‚Üí
  1417‚Üí      const dot = Vector3.Dot(forward, toEnemy);
  1418‚Üí
  1419‚Üí      if (dist &lt; meleeRange &amp;&amp; dot &gt; 0.5) {
  1420‚Üí        enemy.health -= meleeDamage;
  1421‚Üí
  1422‚Üí        if (enemy.health &lt;= 0) {
  1423‚Üí          this.killEnemy(enemy);
  1424‚Üí        }
  1425‚Üí        break; // Only hit one enemy
  1426‚Üí      }
  1427‚Üí    }
  1428‚Üí  }
  1429‚Üí
  1430‚Üí  private callFireSupport(): void {
  1431‚Üí    if (!this.marcus) return;
  1432‚Üí
  1433‚Üí    this.callbacks.onNotification(&#x27;FIRE SUPPORT CALLED&#x27;, 2000);
  1434‚Üí
  1435‚Üí    this.callbacks.onCommsMessage({
  1436‚Üí      sender: &#x27;Marcus&#x27;,
  1437‚Üí      callsign: &#x27;HAMMER&#x27;,
  1438‚Üí      portrait: &#x27;marcus&#x27;,
  1439‚Üí      text: &#x27;Covering fire! Get down!&#x27;,
  1440‚Üí    });
  1441‚Üí
  1442‚Üí    // Marcus focuses fire on all visible enemies for 5 seconds
  1443‚Üí    const supportEndTime = performance.now() + 5000;
  1444‚Üí    const originalFireRate = this.marcus.fireRate;
  1445‚Üí    this.marcus.fireRate = 6; // Triple fire rate
  1446‚Üí
  1447‚Üí    const supportLoop = () =&gt; {
  1448‚Üí      if (performance.now() &lt; supportEndTime &amp;&amp; this.marcus) {
  1449‚Üí        // Fire at any enemy
  1450‚Üí        for (const enemy of this.waveEnemies) {
  1451‚Üí          if (enemy.state !== &#x27;dead&#x27;) {
  1452‚Üí            this.marcusFire(enemy);
  1453‚Üí            break;
  1454‚Üí          }
  1455‚Üí        }
  1456‚Üí        setTimeout(supportLoop, 150);
  1457‚Üí      } else if (this.marcus) {
  1458‚Üí        this.marcus.fireRate = originalFireRate;
  1459‚Üí      }
  1460‚Üí    };
  1461‚Üí    supportLoop();
  1462‚Üí  }
  1463‚Üí
  1464‚Üí  private updateActionButtons(mode: &#x27;combat&#x27; | &#x27;none&#x27;): void {
  1465‚Üí    let groups: ActionButtonGroup[] = [];
  1466‚Üí
  1467‚Üí    if (mode === &#x27;combat&#x27;) {
  1468‚Üí      groups = [
  1469‚Üí        {
  1470‚Üí          id: &#x27;combat&#x27;,
  1471‚Üí          position: &#x27;right&#x27;,
  1472‚Üí          buttons: [
  1473‚Üí            createAction(&#x27;grenade&#x27;, &#x27;GRENADE&#x27;, &#x27;KeyG&#x27;, {
  1474‚Üí              cooldown: 5000,
  1475‚Üí              cooldownRemaining: this.grenadeCooldown,
  1476‚Üí            }),
  1477‚Üí            createAction(&#x27;melee&#x27;, &#x27;MELEE&#x27;, &#x27;KeyV&#x27;, {}),
  1478‚Üí            createAction(&#x27;call_marcus&#x27;, &#x27;FIRE SUPPORT&#x27;, &#x27;KeyC&#x27;, {
  1479‚Üí              cooldown: 30000,
  1480‚Üí              cooldownRemaining: this.fireSuportCooldown,
  1481‚Üí              variant: &#x27;primary&#x27;,
  1482‚Üí            }),
  1483‚Üí          ],
  1484‚Üí        },
  1485‚Üí      ];
  1486‚Üí    }
  1487‚Üí
  1488‚Üí    this.callbacks.onActionGroupsChange(groups);
  1489‚Üí  }
  1490‚Üí
  1491‚Üí  // ============================================================================
  1492‚Üí  // UPDATE &amp; DISPOSE
  1493‚Üí  // ============================================================================
  1494‚Üí
  1495‚Üí  protected updateLevel(deltaTime: number): void {
  1496‚Üí    this.phaseTime += deltaTime;
  1497‚Üí
  1498‚Üí    // Update cooldowns
  1499‚Üí    if (this.grenadeCooldown &gt; 0) {
  1500‚Üí      this.grenadeCooldown = Math.max(0, this.grenadeCooldown - deltaTime * 1000);
  1501‚Üí    }
  1502‚Üí    if (this.fireSuportCooldown &gt; 0) {
  1503‚Üí      this.fireSuportCooldown = Math.max(0, this.fireSuportCooldown - deltaTime * 1000);
  1504‚Üí    }
  1505‚Üí
  1506‚Üí    // Update action buttons to show cooldowns
  1507‚Üí    if (this.phase === &#x27;wave_combat&#x27; || this.phase === &#x27;breach_battle&#x27;) {
  1508‚Üí      this.updateActionButtons(&#x27;combat&#x27;);
  1509‚Üí    }
  1510‚Üí
  1511‚Üí    // Update Marcus
  1512‚Üí    this.updateMarcus(deltaTime);
  1513‚Üí
  1514‚Üí    // Update enemies
  1515‚Üí    this.updateEnemies(deltaTime);
  1516‚Üí
  1517‚Üí    // Phase-specific updates
  1518‚Üí    switch (this.phase) {
  1519‚Üí      case &#x27;reunion&#x27;:
  1520‚Üí        // Handled by timers in startReunionPhase
  1521‚Üí        break;
  1522‚Üí
  1523‚Üí      case &#x27;wave_combat&#x27;:
  1524‚Üí        // Check wave completion
  1525‚Üí        if (this.checkWaveComplete()) {
  1526‚Üí          this.waveComplete = true;
  1527‚Üí
  1528‚Üí          if (this.currentWave &lt; WAVES.length - 1) {
  1529‚Üí            // Wave complete, start rest period
  1530‚Üí            this.callbacks.onNotification(`WAVE ${this.currentWave + 1} CLEARED`, 2000);
  1531‚Üí            this.waveRestTimer = WAVE_REST_DURATION;
  1532‚Üí
  1533‚Üí            // Wave completion dialogue
  1534‚Üí            const dialogues = [
  1535‚Üí              &#x27;Good shooting! Take a breather.&#x27;,
  1536‚Üí              &quot;More incoming! They don&#x27;t give up!&quot;,
  1537‚Üí              &#x27;Stay sharp, I hear more coming!&#x27;,
  1538‚Üí            ];
  1539‚Üí            this.callbacks.onCommsMessage({
  1540‚Üí              sender: &#x27;Marcus&#x27;,
  1541‚Üí              callsign: &#x27;HAMMER&#x27;,
  1542‚Üí              portrait: &#x27;marcus&#x27;,
  1543‚Üí              text: dialogues[this.currentWave] || &#x27;Here they come!&#x27;,
  1544‚Üí            });
  1545‚Üí          } else {
  1546‚Üí            // All waves complete
  1547‚Üí            this.allWavesComplete = true;
  1548‚Üí            this.callbacks.onNotification(&#x27;ALL WAVES CLEARED&#x27;, 3000);
  1549‚Üí            this.startBreachBattlePhase();
  1550‚Üí          }
  1551‚Üí        }
  1552‚Üí
  1553‚Üí        // Handle rest period between waves
  1554‚Üí        if (this.waveComplete &amp;&amp; !this.allWavesComplete) {
  1555‚Üí          this.waveRestTimer -= deltaTime * 1000;
  1556‚Üí
  1557‚Üí          if (this.waveRestTimer &lt;= 0) {
  1558‚Üí            this.startWave(this.currentWave + 1);
  1559‚Üí          } else {
  1560‚Üí            const secondsLeft = Math.ceil(this.waveRestTimer / 1000);
  1561‚Üí            if (secondsLeft % 10 === 0 || secondsLeft &lt;= 5) {
  1562‚Üí              this.callbacks.onObjectiveUpdate(
  1563‚Üí                `NEXT WAVE IN ${secondsLeft}s`,
  1564‚Üí                `Kills: ${this.totalKills}`
  1565‚Üí              );
  1566‚Üí            }
  1567‚Üí          }
  1568‚Üí        }
  1569‚Üí        break;
  1570‚Üí
  1571‚Üí      case &#x27;breach_battle&#x27;:
  1572‚Üí        // Handled by startBreachBattlePhase timer
  1573‚Üí        break;
  1574‚Üí
  1575‚Üí      case &#x27;transition&#x27;: {
  1576‚Üí        // Check if player enters breach
  1577‚Üí        const playerPos = this.camera.position.clone();
  1578‚Üí        playerPos.y = 0;
  1579‚Üí        const distToBreach = Vector3.Distance(playerPos, BREACH_POSITION);
  1580‚Üí
  1581‚Üí        if (distToBreach &lt; BREACH_DIAMETER / 2 - 10) {
  1582‚Üí          // Player entered breach - complete level
  1583‚Üí          this.completeLevel();
  1584‚Üí        }
  1585‚Üí        break;
  1586‚Üí      }
  1587‚Üí    }
  1588‚Üí
  1589‚Üí    // Animate breach glow
  1590‚Üí    if (this.breachGlow) {
  1591‚Üí      const time = performance.now() * 0.001;
  1592‚Üí      this.breachGlow.intensity = 1.5 + Math.sin(time * 2) * 0.5;
  1593‚Üí    }
  1594‚Üí  }
  1595‚Üí
  1596‚Üí  override canTransitionTo(levelId: LevelId): boolean {
  1597‚Üí    return levelId === &#x27;the_breach&#x27; &amp;&amp; this.phase === &#x27;transition&#x27;;
  1598‚Üí  }
  1599‚Üí
  1600‚Üí  protected disposeLevel(): void {
  1601‚Üí    // Unregister action handler
  1602‚Üí    this.callbacks.onActionHandlerRegister(null);
  1603‚Üí    this.callbacks.onActionGroupsChange([]);
  1604‚Üí
  1605‚Üí    // Dispose Marcus
  1606‚Üí    this.marcus?.rootNode.dispose();
  1607‚Üí
  1608‚Üí    // Dispose enemies
  1609‚Üí    this.waveEnemies.forEach((enemy) =&gt; {
  1610‚Üí      if (!enemy.mesh.isDisposed()) {
  1611‚Üí        enemy.mesh.dispose();
  1612‚Üí      }
  1613‚Üí      removeEntity(enemy.entity);
  1614‚Üí    });
  1615‚Üí    this.waveEnemies = [];
  1616‚Üí
  1617‚Üí    // Dispose environment
  1618‚Üí    this.terrain?.dispose();
  1619‚Üí    this.canyonWalls.forEach((w) =&gt; w.dispose());
  1620‚Üí    this.rockPillars.forEach((p) =&gt; p.dispose());
  1621‚Üí    this.breachMesh?.dispose();
  1622‚Üí    this.breachGlow?.dispose();
  1623‚Üí    this.skyDome?.dispose();
  1624‚Üí  }
  1625‚Üí}
  1626‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-49-839Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-49-839Z" class="timestamp-link"><time datetime="2026-01-30T06:44:49.839Z" data-timestamp="2026-01-30T06:44:49.839Z">2026-01-30T06:44:49.839Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01MH8asSGf9e2fXURJo5qaD2"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/extraction/ExtractionLevel.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-50-240Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-50-240Z" class="timestamp-link"><time datetime="2026-01-30T06:44:50.240Z" data-timestamp="2026-01-30T06:44:50.240Z">2026-01-30T06:44:50.240Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * ExtractionLevel - Escape Sequence and Final Holdout
     3‚Üí *
     4‚Üí * After killing the Queen, the player must escape the collapsing hive
     5‚Üí * and hold out at LZ Omega until the dropship arrives.
     6‚Üí *
     7‚Üí * FOUR DISTINCT PHASES:
     8‚Üí *
     9‚Üí * PHASE 1: ESCAPE (3-4 minutes)
    10‚Üí * - 3:00 countdown timer (visible)
    11‚Üí * - Collapsing tunnels behind player
    12‚Üí * - Falling debris (damage zones)
    13‚Üí * - Light at end = surface exit
    14‚Üí * - Chase mechanic - wall of collapse follows
    15‚Üí *
    16‚Üí * PHASE 2: SURFACE RUN (2-3 minutes)
    17‚Üí * - 500m to LZ Omega
    18‚Üí * - Marcus&#x27;s mech providing cover
    19‚Üí * - Chitin pouring from breach holes
    20‚Üí * - Run toward LZ beacon
    21‚Üí *
    22‚Üí * PHASE 3: HOLDOUT (3-5 minutes)
    23‚Üí * - 5:00 dropship ETA countdown
    24‚Üí * - Wave combat (5 waves)
    25‚Üí * - Marcus&#x27;s mech taking damage
    26‚Üí * - Wave 5: Overwhelming, dropship arrives mid-wave
    27‚Üí *
    28‚Üí * PHASE 4: VICTORY
    29‚Üí * - Dropship arrives
    30‚Üí * - Marcus&#x27;s mech collapses (out of power)
    31‚Üí * - Brothers board together
    32‚Üí * - Brief epilogue
    33‚Üí * - Credits option
    34‚Üí */
    35‚Üí
    36‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    37‚Üíimport { PointLight } from &#x27;@babylonjs/core/Lights/pointLight&#x27;;
    38‚Üíimport { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    39‚Üíimport { Color3, Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    40‚Üíimport { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    41‚Üíimport type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    42‚Üíimport { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    43‚Üíimport { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    44‚Üíimport { getAchievementManager } from &#x27;../../achievements&#x27;;
    45‚Üíimport { fireWeapon, getWeaponActions, startReload } from &#x27;../../context/useWeaponActions&#x27;;
    46‚Üíimport { particleManager } from &#x27;../../effects/ParticleManager&#x27;;
    47‚Üíimport { ALIEN_SPECIES, createAlienMesh } from &#x27;../../entities/aliens&#x27;;
    48‚Üíimport { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    49‚Üíimport { BaseLevel } from &#x27;../BaseLevel&#x27;;
    50‚Üíimport type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    51‚Üí
    52‚Üíimport &#x27;@babylonjs/core/Animations/animatable&#x27;;
    53‚Üíimport { Animation } from &#x27;@babylonjs/core/Animations/animation&#x27;;
    54‚Üíimport { CubicEase, EasingFunction } from &#x27;@babylonjs/core/Animations/easing&#x27;;
    55‚Üí
    56‚Üítype ExtractionPhase =
    57‚Üí  | &#x27;escape_start&#x27; // Initial orientation after Queen kill
    58‚Üí  | &#x27;escape_tunnel&#x27; // Running through collapsing tunnels
    59‚Üí  | &#x27;surface_run&#x27; // Running 500m to LZ Omega
    60‚Üí  | &#x27;holdout&#x27; // Wave-based defense
    61‚Üí  | &#x27;victory&#x27; // Dropship arrival and extraction
    62‚Üí  | &#x27;epilogue&#x27;; // Post-mission epilogue
    63‚Üí
    64‚Üíinterface Enemy {
    65‚Üí  mesh: TransformNode;
    66‚Üí  health: number;
    67‚Üí  maxHealth: number;
    68‚Üí  position: Vector3;
    69‚Üí  velocity: Vector3;
    70‚Üí  species: string;
    71‚Üí  isActive: boolean;
    72‚Üí}
    73‚Üí
    74‚Üíinterface DebrisChunk {
    75‚Üí  mesh: Mesh;
    76‚Üí  velocity: Vector3;
    77‚Üí  rotationSpeed: Vector3;
    78‚Üí  lifetime: number;
    79‚Üí}
    80‚Üí
    81‚Üíinterface WaveConfig {
    82‚Üí  drones: number;
    83‚Üí  grunts: number;
    84‚Üí  spitters: number;
    85‚Üí  brutes: number;
    86‚Üí  spawnDelay: number;
    87‚Üí}
    88‚Üí
    89‚Üíexport class ExtractionLevel extends BaseLevel {
    90‚Üí  // Phase management
    91‚Üí  private phase: ExtractionPhase = &#x27;escape_start&#x27;;
    92‚Üí  private phaseTime = 0;
    93‚Üí
    94‚Üí  // Timer systems
    95‚Üí  private escapeTimer = 180; // 3:00 countdown for escape
    96‚Üí  private dropshipETA = 300; // 5:00 countdown for holdout
    97‚Üí
    98‚Üí  // Collapse chase mechanics
    99‚Üí  private collapseDistance = 0; // How far the collapse wall has traveled
   100‚Üí  private playerEscapeProgress = 0; // Player&#x27;s progress through escape tunnel (0-1)
   101‚Üí  private readonly escapeTunnelLength = 300; // 300m tunnel
   102‚Üí
   103‚Üí  // Surface run
   104‚Üí  private distanceToLZ = 500; // 500m to LZ Omega
   105‚Üí  private readonly lzPosition = new Vector3(0, 0, -500);
   106‚Üí
   107‚Üí  // Marcus&#x27;s Mech
   108‚Üí  private mechIntegrity = 100;
   109‚Üí  private mechMesh: TransformNode | null = null;
   110‚Üí  private mechGunLight: PointLight | null = null;
   111‚Üí  private mechFireTimer = 0;
   112‚Üí  private readonly mechFireRate = 0.2; // Fires every 200ms
   113‚Üí
   114‚Üí  // Wave combat
   115‚Üí  private currentWave = 0;
   116‚Üí  private waveActive = false;
   117‚Üí  private waveEnemiesRemaining = 0;
   118‚Üí  private waveSpawnTimer = 0;
   119‚Üí  private enemiesToSpawn: { species: string; count: number }[] = [];
   120‚Üí  private enemies: Enemy[] = [];
   121‚Üí  private readonly maxEnemies = 30;
   122‚Üí
   123‚Üí  // Wave configurations
   124‚Üí  private readonly waveConfigs: WaveConfig[] = [
   125‚Üí    { drones: 10, grunts: 0, spitters: 0, brutes: 0, spawnDelay: 1.0 }, // Wave 1
   126‚Üí    { drones: 0, grunts: 8, spitters: 0, brutes: 0, spawnDelay: 1.5 }, // Wave 2
   127‚Üí    { drones: 4, grunts: 6, spitters: 2, brutes: 0, spawnDelay: 1.2 }, // Wave 3
   128‚Üí    { drones: 0, grunts: 6, spitters: 0, brutes: 1, spawnDelay: 1.0 }, // Wave 4
   129‚Üí    { drones: 8, grunts: 8, spitters: 4, brutes: 2, spawnDelay: 0.5 }, // Wave 5 - overwhelming
   130‚Üí  ];
   131‚Üí
   132‚Üí  // Environment - Escape Tunnel
   133‚Üí  private tunnelSegments: Mesh[] = [];
   134‚Üí  private tunnelLights: PointLight[] = [];
   135‚Üí  private collapseWall: Mesh | null = null;
   136‚Üí  private exitLight: PointLight | null = null;
   137‚Üí  private debris: DebrisChunk[] = [];
   138‚Üí
   139‚Üí  // Environment - Surface
   140‚Üí  private terrain: Mesh | null = null;
   141‚Üí  private skyDome: Mesh | null = null;
   142‚Üí  private lzPad: Mesh | null = null;
   143‚Üí  private lzBeacon: Mesh | null = null;
   144‚Üí  private breachHoles: Mesh[] = [];
   145‚Üí  private canyonWalls: Mesh[] = [];
   146‚Üí  private barrierWalls: Mesh[] = [];
   147‚Üí
   148‚Üí  // Environment - Dropship
   149‚Üí  private dropship: TransformNode | null = null;
   150‚Üí  private dropshipLight: PointLight | null = null;
   151‚Üí
   152‚Üí  // Player stats
   153‚Üí  private playerHealth = 100;
   154‚Üí  private kills = 0;
   155‚Üí
   156‚Üí  // Action button callback reference
   157‚Üí  private actionCallback: ((actionId: string) =&gt; void) | null = null;
   158‚Üí
   159‚Üí  // Cooldown tracking
   160‚Üí  private grenadeCooldown = 0;
   161‚Üí  private flareCooldown = 0;
   162‚Üí  private readonly grenadeCooldownTime = 5000;
   163‚Üí  private readonly flareCooldownTime = 60000;
   164‚Üí
   165‚Üí  constructor(
   166‚Üí    engine: Engine,
   167‚Üí    canvas: HTMLCanvasElement,
   168‚Üí    config: LevelConfig,
   169‚Üí    callbacks: LevelCallbacks
   170‚Üí  ) {
   171‚Üí    super(engine, canvas, config, callbacks);
   172‚Üí  }
   173‚Üí
   174‚Üí  protected getBackgroundColor(): Color4 {
   175‚Üí    switch (this.phase) {
   176‚Üí      case &#x27;escape_start&#x27;:
   177‚Üí      case &#x27;escape_tunnel&#x27;:
   178‚Üí        return new Color4(0.02, 0.01, 0.03, 1); // Dark hive colors
   179‚Üí      case &#x27;surface_run&#x27;:
   180‚Üí      case &#x27;holdout&#x27;:
   181‚Üí      case &#x27;victory&#x27;:
   182‚Üí        return new Color4(0.75, 0.5, 0.35, 1); // Sunset canyon
   183‚Üí      case &#x27;epilogue&#x27;:
   184‚Üí        return new Color4(0.1, 0.1, 0.15, 1); // Station interior
   185‚Üí      default:
   186‚Üí        return new Color4(0.02, 0.01, 0.03, 1);
   187‚Üí    }
   188‚Üí  }
   189‚Üí
   190‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   191‚Üí    // Start in escape tunnel
   192‚Üí    this.camera.position.set(0, 1.7, 0);
   193‚Üí    this.camera.rotation.set(0, 0, 0);
   194‚Üí    this.rotationX = 0;
   195‚Üí    this.rotationY = 0;
   196‚Üí
   197‚Üí    // Initialize particle manager for combat effects
   198‚Üí    particleManager.init(this.scene);
   199‚Üí
   200‚Üí    this.createEscapeTunnel();
   201‚Üí    this.createCollapseWall();
   202‚Üí    this.createSurfaceEnvironment();
   203‚Üí    this.createMarcusMech();
   204‚Üí    this.createDropship();
   205‚Üí    this.createLZ();
   206‚Üí
   207‚Üí    // Initially hide surface elements
   208‚Üí    this.setSurfaceVisible(false);
   209‚Üí
   210‚Üí    this.startEscape();
   211‚Üí  }
   212‚Üí
   213‚Üí  // ============================================================================
   214‚Üí  // ENVIRONMENT CREATION
   215‚Üí  // ============================================================================
   216‚Üí
   217‚Üí  private createEscapeTunnel(): void {
   218‚Üí    const segmentLength = 20;
   219‚Üí    const numSegments = 15;
   220‚Üí    const tunnelRadius = 4;
   221‚Üí
   222‚Üí    const tunnelMat = new StandardMaterial(&#x27;tunnelMat&#x27;, this.scene);
   223‚Üí    tunnelMat.diffuseColor = Color3.FromHexString(&#x27;#3A2A3A&#x27;);
   224‚Üí    tunnelMat.specularColor = new Color3(0.1, 0.1, 0.1);
   225‚Üí
   226‚Üí    const organicMat = new StandardMaterial(&#x27;organicMat&#x27;, this.scene);
   227‚Üí    organicMat.diffuseColor = Color3.FromHexString(&#x27;#5A3A5A&#x27;);
   228‚Üí    organicMat.emissiveColor = new Color3(0.1, 0.05, 0.1);
   229‚Üí
   230‚Üí    for (let i = 0; i &lt; numSegments; i++) {
   231‚Üí      // Main tunnel segment
   232‚Üí      const segment = MeshBuilder.CreateCylinder(
   233‚Üí        `tunnel_${i}`,
   234‚Üí        {
   235‚Üí          height: segmentLength,
   236‚Üí          diameter: tunnelRadius * 2,
   237‚Üí          tessellation: 12,
   238‚Üí          sideOrientation: 1, // Inside view
   239‚Üí        },
   240‚Üí        this.scene
   241‚Üí      );
   242‚Üí      segment.material = tunnelMat;
   243‚Üí      segment.position.z = -i * segmentLength - segmentLength / 2;
   244‚Üí      segment.rotation.x = Math.PI / 2;
   245‚Üí      this.tunnelSegments.push(segment);
   246‚Üí
   247‚Üí      // Add organic growths
   248‚Üí      for (let j = 0; j &lt; 4; j++) {
   249‚Üí        const growth = MeshBuilder.CreateSphere(
   250‚Üí          `growth_${i}_${j}`,
   251‚Üí          { diameter: 0.5 + Math.random() * 0.5 },
   252‚Üí          this.scene
   253‚Üí        );
   254‚Üí        growth.material = organicMat;
   255‚Üí        const angle = (j / 4) * Math.PI * 2 + Math.random() * 0.5;
   256‚Üí        growth.position.set(
   257‚Üí          Math.cos(angle) * (tunnelRadius - 0.5),
   258‚Üí          Math.sin(angle) * (tunnelRadius - 0.5),
   259‚Üí          -i * segmentLength - Math.random() * segmentLength
   260‚Üí        );
   261‚Üí        this.tunnelSegments.push(growth);
   262‚Üí      }
   263‚Üí
   264‚Üí      // Add bioluminescent lights
   265‚Üí      if (i % 2 === 0) {
   266‚Üí        const light = new PointLight(
   267‚Üí          `tunnelLight_${i}`,
   268‚Üí          new Vector3(0, tunnelRadius - 1, -i * segmentLength - segmentLength / 2),
   269‚Üí          this.scene
   270‚Üí        );
   271‚Üí        light.diffuse = new Color3(0.3, 0.6, 0.6);
   272‚Üí        light.intensity = 15;
   273‚Üí        light.range = 25;
   274‚Üí        this.tunnelLights.push(light);
   275‚Üí      }
   276‚Üí    }
   277‚Üí
   278‚Üí    // Exit light at end (represents surface)
   279‚Üí    this.exitLight = new PointLight(
   280‚Üí      &#x27;exitLight&#x27;,
   281‚Üí      new Vector3(0, 2, -this.escapeTunnelLength),
   282‚Üí      this.scene
   283‚Üí    );
   284‚Üí    this.exitLight.diffuse = new Color3(1, 0.8, 0.5);
   285‚Üí    this.exitLight.intensity = 50;
   286‚Üí    this.exitLight.range = 80;
   287‚Üí  }
   288‚Üí
   289‚Üí  private createCollapseWall(): void {
   290‚Üí    const collapseMat = new StandardMaterial(&#x27;collapseMat&#x27;, this.scene);
   291‚Üí    collapseMat.diffuseColor = new Color3(0.2, 0.1, 0.05);
   292‚Üí    collapseMat.emissiveColor = new Color3(0.3, 0.15, 0.05);
   293‚Üí
   294‚Üí    this.collapseWall = MeshBuilder.CreateSphere(
   295‚Üí      &#x27;collapseWall&#x27;,
   296‚Üí      { diameter: 20, segments: 8 },
   297‚Üí      this.scene
   298‚Üí    );
   299‚Üí    this.collapseWall.material = collapseMat;
   300‚Üí    this.collapseWall.position.z = 30; // Start behind player
   301‚Üí    this.collapseWall.scaling.set(1, 1, 3);
   302‚Üí
   303‚Üí    // Add dust particle effect plane
   304‚Üí    const dustMat = new StandardMaterial(&#x27;dustMat&#x27;, this.scene);
   305‚Üí    dustMat.diffuseColor = new Color3(0.5, 0.4, 0.3);
   306‚Üí    dustMat.alpha = 0.3;
   307‚Üí    dustMat.emissiveColor = new Color3(0.2, 0.15, 0.1);
   308‚Üí  }
   309‚Üí
   310‚Üí  private createSurfaceEnvironment(): void {
   311‚Üí    // Terrain
   312‚Üí    this.terrain = MeshBuilder.CreateGround(
   313‚Üí      &#x27;terrain&#x27;,
   314‚Üí      { width: 800, height: 1200, subdivisions: 64 },
   315‚Üí      this.scene
   316‚Üí    );
   317‚Üí    const terrainMat = new StandardMaterial(&#x27;terrainMat&#x27;, this.scene);
   318‚Üí    terrainMat.diffuseColor = Color3.FromHexString(&#x27;#8B5A2B&#x27;);
   319‚Üí    this.terrain.material = terrainMat;
   320‚Üí    this.terrain.position.z = -400;
   321‚Üí
   322‚Üí    // Sky dome
   323‚Üí    this.skyDome = MeshBuilder.CreateSphere(
   324‚Üí      &#x27;sky&#x27;,
   325‚Üí      { diameter: 5000, segments: 16, sideOrientation: 1 },
   326‚Üí      this.scene
   327‚Üí    );
   328‚Üí    const skyMat = new StandardMaterial(&#x27;skyMat&#x27;, this.scene);
   329‚Üí    skyMat.emissiveColor = new Color3(0.75, 0.5, 0.35);
   330‚Üí    skyMat.disableLighting = true;
   331‚Üí    this.skyDome.material = skyMat;
   332‚Üí
   333‚Üí    // Canyon walls
   334‚Üí    for (let i = 0; i &lt; 6; i++) {
   335‚Üí      const wall = MeshBuilder.CreateBox(
   336‚Üí        `canyonWall_${i}`,
   337‚Üí        { width: 30, height: 80, depth: 200 },
   338‚Üí        this.scene
   339‚Üí      );
   340‚Üí      const wallMat = new StandardMaterial(`wallMat_${i}`, this.scene);
   341‚Üí      wallMat.diffuseColor = Color3.FromHexString(&#x27;#6B4423&#x27;);
   342‚Üí      wall.material = wallMat;
   343‚Üí      wall.position.set((i % 2 === 0 ? -1 : 1) * (80 + Math.random() * 20), 40, -200 - i * 100);
   344‚Üí      this.canyonWalls.push(wall);
   345‚Üí    }
   346‚Üí
   347‚Üí    // Breach holes (where aliens pour out)
   348‚Üí    for (let i = 0; i &lt; 4; i++) {
   349‚Üí      const hole = MeshBuilder.CreateCylinder(
   350‚Üí        `breachHole_${i}`,
   351‚Üí        { height: 5, diameter: 8, tessellation: 8 },
   352‚Üí        this.scene
   353‚Üí      );
   354‚Üí      const holeMat = new StandardMaterial(`holeMat_${i}`, this.scene);
   355‚Üí      holeMat.diffuseColor = Color3.FromHexString(&#x27;#2A1A2A&#x27;);
   356‚Üí      holeMat.emissiveColor = new Color3(0.1, 0.05, 0.1);
   357‚Üí      hole.material = holeMat;
   358‚Üí      hole.position.set((i % 2 === 0 ? -1 : 1) * (30 + i * 10), -2, -100 - i * 80);
   359‚Üí      this.breachHoles.push(hole);
   360‚Üí    }
   361‚Üí
   362‚Üí    // Defensive barriers at LZ
   363‚Üí    for (let i = 0; i &lt; 8; i++) {
   364‚Üí      const barrier = MeshBuilder.CreateBox(
   365‚Üí        `barrier_${i}`,
   366‚Üí        { width: 4, height: 1.5, depth: 1 },
   367‚Üí        this.scene
   368‚Üí      );
   369‚Üí      const barrierMat = new StandardMaterial(`barrierMat_${i}`, this.scene);
   370‚Üí      barrierMat.diffuseColor = new Color3(0.4, 0.4, 0.35);
   371‚Üí      barrier.material = barrierMat;
   372‚Üí      const angle = (i / 8) * Math.PI * 2;
   373‚Üí      barrier.position.set(
   374‚Üí        Math.cos(angle) * 25 + this.lzPosition.x,
   375‚Üí        0.75,
   376‚Üí        Math.sin(angle) * 25 + this.lzPosition.z
   377‚Üí      );
   378‚Üí      barrier.rotation.y = angle + Math.PI / 2;
   379‚Üí      this.barrierWalls.push(barrier);
   380‚Üí    }
   381‚Üí  }
   382‚Üí
   383‚Üí  private createMarcusMech(): void {
   384‚Üí    // Create Marcus&#x27;s Titan mech
   385‚Üí    this.mechMesh = new TransformNode(&#x27;marcusMech&#x27;, this.scene);
   386‚Üí
   387‚Üí    const mechMat = new StandardMaterial(&#x27;mechMat&#x27;, this.scene);
   388‚Üí    mechMat.diffuseColor = Color3.FromHexString(&#x27;#4A4A32&#x27;);
   389‚Üí    mechMat.specularColor = new Color3(0.3, 0.3, 0.3);
   390‚Üí
   391‚Üí    const damagedMat = new StandardMaterial(&#x27;damagedMat&#x27;, this.scene);
   392‚Üí    damagedMat.diffuseColor = Color3.FromHexString(&#x27;#3A3A28&#x27;);
   393‚Üí    damagedMat.emissiveColor = new Color3(0.1, 0.05, 0);
   394‚Üí
   395‚Üí    // Main body
   396‚Üí    const body = MeshBuilder.CreateBox(&#x27;mechBody&#x27;, { width: 3, height: 4, depth: 2 }, this.scene);
   397‚Üí    body.material = mechMat;
   398‚Üí    body.position.y = 4;
   399‚Üí    body.parent = this.mechMesh;
   400‚Üí
   401‚Üí    // Torso
   402‚Üí    const torso = MeshBuilder.CreateBox(
   403‚Üí      &#x27;mechTorso&#x27;,
   404‚Üí      { width: 3.5, height: 2, depth: 2.5 },
   405‚Üí      this.scene
   406‚Üí    );
   407‚Üí    torso.material = mechMat;
   408‚Üí    torso.position.y = 6.5;
   409‚Üí    torso.parent = this.mechMesh;
   410‚Üí
   411‚Üí    // Head/Cockpit
   412‚Üí    const head = MeshBuilder.CreateBox(
   413‚Üí      &#x27;mechHead&#x27;,
   414‚Üí      { width: 1.5, height: 1, depth: 1.5 },
   415‚Üí      this.scene
   416‚Üí    );
   417‚Üí    head.material = mechMat;
   418‚Üí    head.position.y = 8;
   419‚Üí    head.parent = this.mechMesh;
   420‚Üí
   421‚Üí    // Cockpit visor (glowing)
   422‚Üí    const visorMat = new StandardMaterial(&#x27;visorMat&#x27;, this.scene);
   423‚Üí    visorMat.emissiveColor = new Color3(0.2, 0.8, 1);
   424‚Üí    visorMat.alpha = 0.8;
   425‚Üí    const visor = MeshBuilder.CreateBox(
   426‚Üí      &#x27;visor&#x27;,
   427‚Üí      { width: 1.2, height: 0.4, depth: 0.1 },
   428‚Üí      this.scene
   429‚Üí    );
   430‚Üí    visor.material = visorMat;
   431‚Üí    visor.position.set(0, 8.2, -0.7);
   432‚Üí    visor.parent = this.mechMesh;
   433‚Üí
   434‚Üí    // Arms with autocannons
   435‚Üí    for (let i = 0; i &lt; 2; i++) {
   436‚Üí      const side = i === 0 ? 1 : -1;
   437‚Üí
   438‚Üí      // Shoulder
   439‚Üí      const shoulder = MeshBuilder.CreateBox(
   440‚Üí        &#x27;shoulder&#x27;,
   441‚Üí        { width: 1.5, height: 1, depth: 1.5 },
   442‚Üí        this.scene
   443‚Üí      );
   444‚Üí      shoulder.material = mechMat;
   445‚Üí      shoulder.position.set(side * 2.5, 6.5, 0);
   446‚Üí      shoulder.parent = this.mechMesh;
   447‚Üí
   448‚Üí      // Arm
   449‚Üí      const arm = MeshBuilder.CreateCylinder(&#x27;arm&#x27;, { height: 2, diameter: 0.8 }, this.scene);
   450‚Üí      arm.material = mechMat;
   451‚Üí      arm.position.set(side * 2.5, 5, 0);
   452‚Üí      arm.parent = this.mechMesh;
   453‚Üí
   454‚Üí      // Autocannon
   455‚Üí      const cannon = MeshBuilder.CreateCylinder(&#x27;cannon&#x27;, { height: 3, diameter: 0.5 }, this.scene);
   456‚Üí      cannon.material = damagedMat;
   457‚Üí      cannon.position.set(side * 2.5, 4, -1);
   458‚Üí      cannon.rotation.x = Math.PI / 2;
   459‚Üí      cannon.parent = this.mechMesh;
   460‚Üí    }
   461‚Üí
   462‚Üí    // Legs
   463‚Üí    for (let i = 0; i &lt; 2; i++) {
   464‚Üí      const side = i === 0 ? 1 : -1;
   465‚Üí
   466‚Üí      const upperLeg = MeshBuilder.CreateBox(
   467‚Üí        &#x27;upperLeg&#x27;,
   468‚Üí        { width: 1, height: 2.5, depth: 1 },
   469‚Üí        this.scene
   470‚Üí      );
   471‚Üí      upperLeg.material = mechMat;
   472‚Üí      upperLeg.position.set(side * 1, 2, 0);
   473‚Üí      upperLeg.parent = this.mechMesh;
   474‚Üí
   475‚Üí      const lowerLeg = MeshBuilder.CreateBox(
   476‚Üí        &#x27;lowerLeg&#x27;,
   477‚Üí        { width: 0.8, height: 2.5, depth: 0.8 },
   478‚Üí        this.scene
   479‚Üí      );
   480‚Üí      lowerLeg.material = mechMat;
   481‚Üí      lowerLeg.position.set(side * 1, 0, 0);
   482‚Üí      lowerLeg.parent = this.mechMesh;
   483‚Üí
   484‚Üí      const foot = MeshBuilder.CreateBox(
   485‚Üí        &#x27;foot&#x27;,
   486‚Üí        { width: 1.2, height: 0.3, depth: 1.8 },
   487‚Üí        this.scene
   488‚Üí      );
   489‚Üí      foot.material = mechMat;
   490‚Üí      foot.position.set(side * 1, -1, 0.3);
   491‚Üí      foot.parent = this.mechMesh;
   492‚Üí    }
   493‚Üí
   494‚Üí    // Mech gun muzzle flash light
   495‚Üí    this.mechGunLight = new PointLight(&#x27;mechGunLight&#x27;, new Vector3(0, 5, -3), this.scene);
   496‚Üí    this.mechGunLight.diffuse = new Color3(1, 0.8, 0.3);
   497‚Üí    this.mechGunLight.intensity = 0;
   498‚Üí    this.mechGunLight.range = 30;
   499‚Üí    this.mechGunLight.parent = this.mechMesh;
   500‚Üí
   501‚Üí    // Position mech near LZ
   502‚Üí    this.mechMesh.position.set(15, 0, this.lzPosition.z + 20);
   503‚Üí    this.mechMesh.rotation.y = Math.PI * 0.8;
   504‚Üí    this.mechMesh.setEnabled(false);
   505‚Üí  }
   506‚Üí
   507‚Üí  private createDropship(): void {
   508‚Üí    this.dropship = new TransformNode(&#x27;dropship&#x27;, this.scene);
   509‚Üí
   510‚Üí    const shipMat = new StandardMaterial(&#x27;shipMat&#x27;, this.scene);
   511‚Üí    shipMat.diffuseColor = new Color3(0.4, 0.4, 0.45);
   512‚Üí    shipMat.specularColor = new Color3(0.3, 0.3, 0.3);
   513‚Üí
   514‚Üí    // Main fuselage
   515‚Üí    const fuselage = MeshBuilder.CreateBox(
   516‚Üí      &#x27;fuselage&#x27;,
   517‚Üí      { width: 6, height: 4, depth: 15 },
   518‚Üí      this.scene
   519‚Üí    );
   520‚Üí    fuselage.material = shipMat;
   521‚Üí    fuselage.parent = this.dropship;
   522‚Üí
   523‚Üí    // Cockpit
   524‚Üí    const cockpit = MeshBuilder.CreateSphere(
   525‚Üí      &#x27;cockpit&#x27;,
   526‚Üí      { diameterX: 4, diameterY: 2, diameterZ: 5, segments: 8 },
   527‚Üí      this.scene
   528‚Üí    );
   529‚Üí    cockpit.material = shipMat;
   530‚Üí    cockpit.position.z = -8;
   531‚Üí    cockpit.parent = this.dropship;
   532‚Üí
   533‚Üí    // Cockpit window
   534‚Üí    const windowMat = new StandardMaterial(&#x27;windowMat&#x27;, this.scene);
   535‚Üí    windowMat.emissiveColor = new Color3(0.3, 0.5, 1);
   536‚Üí    windowMat.alpha = 0.6;
   537‚Üí    const window = MeshBuilder.CreateDisc(&#x27;window&#x27;, { radius: 1.5 }, this.scene);
   538‚Üí    window.material = windowMat;
   539‚Üí    window.position.set(0, 0.3, -10);
   540‚Üí    window.rotation.x = Math.PI / 2 - 0.3;
   541‚Üí    window.parent = this.dropship;
   542‚Üí
   543‚Üí    // Wings
   544‚Üí    for (let i = 0; i &lt; 2; i++) {
   545‚Üí      const side = i === 0 ? 1 : -1;
   546‚Üí      const wing = MeshBuilder.CreateBox(&#x27;wing&#x27;, { width: 10, height: 0.5, depth: 6 }, this.scene);
   547‚Üí      wing.material = shipMat;
   548‚Üí      wing.position.set(side * 8, 0, 2);
   549‚Üí      wing.parent = this.dropship;
   550‚Üí
   551‚Üí      // Engine pod
   552‚Üí      const engine = MeshBuilder.CreateCylinder(&#x27;engine&#x27;, { height: 4, diameter: 2 }, this.scene);
   553‚Üí      engine.material = shipMat;
   554‚Üí      engine.position.set(side * 10, -1, 2);
   555‚Üí      engine.rotation.x = Math.PI / 2;
   556‚Üí      engine.parent = this.dropship;
   557‚Üí
   558‚Üí      // Engine glow
   559‚Üí      const engineGlowMat = new StandardMaterial(`engineGlow_${i}`, this.scene);
   560‚Üí      engineGlowMat.emissiveColor = new Color3(0.3, 0.6, 1);
   561‚Üí      const glow = MeshBuilder.CreateDisc(&#x27;engineGlow&#x27;, { radius: 1 }, this.scene);
   562‚Üí      glow.material = engineGlowMat;
   563‚Üí      glow.position.set(side * 10, -1, 4);
   564‚Üí      glow.rotation.x = Math.PI / 2;
   565‚Üí      glow.parent = this.dropship;
   566‚Üí    }
   567‚Üí
   568‚Üí    // Tail
   569‚Üí    const tail = MeshBuilder.CreateBox(&#x27;tail&#x27;, { width: 1, height: 4, depth: 4 }, this.scene);
   570‚Üí    tail.material = shipMat;
   571‚Üí    tail.position.set(0, 2, 6);
   572‚Üí    tail.parent = this.dropship;
   573‚Üí
   574‚Üí    // Dropship spotlight
   575‚Üí    this.dropshipLight = new PointLight(&#x27;dropshipLight&#x27;, new Vector3(0, -5, 0), this.scene);
   576‚Üí    this.dropshipLight.diffuse = new Color3(1, 0.95, 0.8);
   577‚Üí    this.dropshipLight.intensity = 100;
   578‚Üí    this.dropshipLight.range = 80;
   579‚Üí    this.dropshipLight.parent = this.dropship;
   580‚Üí
   581‚Üí    // Start dropship high and far away
   582‚Üí    this.dropship.position.set(0, 200, this.lzPosition.z - 300);
   583‚Üí    this.dropship.setEnabled(false);
   584‚Üí  }
   585‚Üí
   586‚Üí  private createLZ(): void {
   587‚Üí    // LZ Omega landing pad
   588‚Üí    this.lzPad = MeshBuilder.CreateCylinder(&#x27;lzPad&#x27;, { height: 0.3, diameter: 30 }, this.scene);
   589‚Üí    const padMat = new StandardMaterial(&#x27;padMat&#x27;, this.scene);
   590‚Üí    padMat.diffuseColor = new Color3(0.5, 0.5, 0.5);
   591‚Üí    this.lzPad.material = padMat;
   592‚Üí    this.lzPad.position.set(this.lzPosition.x, 0.15, this.lzPosition.z);
   593‚Üí
   594‚Üí    // LZ markings
   595‚Üí    const markingMat = new StandardMaterial(&#x27;markingMat&#x27;, this.scene);
   596‚Üí    markingMat.diffuseColor = new Color3(0.8, 0.8, 0);
   597‚Üí    markingMat.emissiveColor = new Color3(0.2, 0.2, 0);
   598‚Üí
   599‚Üí    for (let i = 0; i &lt; 4; i++) {
   600‚Üí      const marking = MeshBuilder.CreateBox(
   601‚Üí        `marking_${i}`,
   602‚Üí        { width: 8, height: 0.05, depth: 0.5 },
   603‚Üí        this.scene
   604‚Üí      );
   605‚Üí      marking.material = markingMat;
   606‚Üí      marking.position.set(this.lzPosition.x, 0.35, this.lzPosition.z);
   607‚Üí      marking.rotation.y = (i / 4) * Math.PI;
   608‚Üí    }
   609‚Üí
   610‚Üí    // Beacon
   611‚Üí    this.lzBeacon = MeshBuilder.CreateCylinder(&#x27;beacon&#x27;, { height: 40, diameter: 3 }, this.scene);
   612‚Üí    const beaconMat = new StandardMaterial(&#x27;beaconMat&#x27;, this.scene);
   613‚Üí    beaconMat.emissiveColor = new Color3(0.2, 1, 0.3);
   614‚Üí    beaconMat.alpha = 0.3;
   615‚Üí    this.lzBeacon.material = beaconMat;
   616‚Üí    this.lzBeacon.position.set(this.lzPosition.x, 20, this.lzPosition.z);
   617‚Üí  }
   618‚Üí
   619‚Üí  private setTunnelVisible(visible: boolean): void {
   620‚Üí    this.tunnelSegments.forEach((s) =&gt; (s.isVisible = visible));
   621‚Üí    this.tunnelLights.forEach((l) =&gt; l.setEnabled(visible));
   622‚Üí    if (this.collapseWall) this.collapseWall.isVisible = visible;
   623‚Üí    if (this.exitLight) this.exitLight.setEnabled(visible);
   624‚Üí  }
   625‚Üí
   626‚Üí  private setSurfaceVisible(visible: boolean): void {
   627‚Üí    if (this.terrain) this.terrain.isVisible = visible;
   628‚Üí    if (this.skyDome) this.skyDome.isVisible = visible;
   629‚Üí    if (this.lzPad) this.lzPad.isVisible = visible;
   630‚Üí    if (this.lzBeacon) this.lzBeacon.isVisible = visible;
   631‚Üí    this.breachHoles.forEach((h) =&gt; (h.isVisible = visible));
   632‚Üí    this.canyonWalls.forEach((w) =&gt; (w.isVisible = visible));
   633‚Üí    this.barrierWalls.forEach((b) =&gt; (b.isVisible = visible));
   634‚Üí    if (this.mechMesh) this.mechMesh.setEnabled(visible);
   635‚Üí  }
   636‚Üí
   637‚Üí  // ============================================================================
   638‚Üí  // PHASE MANAGEMENT
   639‚Üí  // ============================================================================
   640‚Üí
   641‚Üí  private startEscape(): void {
   642‚Üí    this.phase = &#x27;escape_start&#x27;;
   643‚Üí    this.escapeTimer = 180;
   644‚Üí    this.phaseTime = 0;
   645‚Üí    this.playerEscapeProgress = 0;
   646‚Üí    this.collapseDistance = -20;
   647‚Üí
   648‚Üí    this.callbacks.onCinematicStart?.();
   649‚Üí    this.callbacks.onNotification(&#x27;THE HIVE IS COLLAPSING&#x27;, 3000);
   650‚Üí
   651‚Üí    // Setup action handler
   652‚Üí    this.actionCallback = this.handleAction.bind(this);
   653‚Üí    this.callbacks.onActionHandlerRegister(this.actionCallback);
   654‚Üí
   655‚Üí    // Initial comms
   656‚Üí    setTimeout(() =&gt; {
   657‚Üí      this.callbacks.onCommsMessage({
   658‚Üí        sender: &#x27;Corporal Marcus Cole&#x27;,
   659‚Üí        callsign: &#x27;TITAN&#x27;,
   660‚Üí        portrait: &#x27;marcus&#x27;,
   661‚Üí        text: &quot;The whole place is coming down! RUN, brother! I&#x27;m holding position at LZ Omega!&quot;,
   662‚Üí      });
   663‚Üí    }, 1000);
   664‚Üí
   665‚Üí    // Transition to escape tunnel phase
   666‚Üí    setTimeout(() =&gt; {
   667‚Üí      this.transitionToPhase(&#x27;escape_tunnel&#x27;);
   668‚Üí    }, 3000);
   669‚Üí  }
   670‚Üí
   671‚Üí  private transitionToPhase(newPhase: ExtractionPhase): void {
   672‚Üí    this.phase = newPhase;
   673‚Üí    this.phaseTime = 0;
   674‚Üí
   675‚Üí    switch (newPhase) {
   676‚Üí      case &#x27;escape_tunnel&#x27;:
   677‚Üí        this.callbacks.onObjectiveUpdate(
   678‚Üí          &#x27;ESCAPE THE HIVE&#x27;,
   679‚Üí          &#x27;RUN! The collapse is right behind you!&#x27;
   680‚Üí        );
   681‚Üí        this.updateActionButtons(&#x27;escape&#x27;);
   682‚Üí        this.setBaseShake(1.5);
   683‚Üí        this.callbacks.onCombatStateChange(true);
   684‚Üí        break;
   685‚Üí
   686‚Üí      case &#x27;surface_run&#x27;:
   687‚Üí        this.callbacks.onNotification(&#x27;SURFACE REACHED&#x27;, 2000);
   688‚Üí        this.callbacks.onCinematicEnd?.();
   689‚Üí
   690‚Üí        // Hide tunnel, show surface
   691‚Üí        this.setTunnelVisible(false);
   692‚Üí        this.setSurfaceVisible(true);
   693‚Üí
   694‚Üí        // Reset camera for surface
   695‚Üí        this.camera.position.set(0, 1.7, 0);
   696‚Üí        this.camera.rotation.set(0, Math.PI, 0);
   697‚Üí        this.rotationX = 0;
   698‚Üí        this.rotationY = Math.PI;
   699‚Üí
   700‚Üí        this.scene.clearColor = new Color4(0.75, 0.5, 0.35, 1);
   701‚Üí        this.setBaseShake(0.5);
   702‚Üí
   703‚Üí        setTimeout(() =&gt; {
   704‚Üí          this.callbacks.onCommsMessage({
   705‚Üí            sender: &#x27;Corporal Marcus Cole&#x27;,
   706‚Üí            callsign: &#x27;TITAN&#x27;,
   707‚Üí            portrait: &#x27;marcus&#x27;,
   708‚Üí            text: &#x27;I see you! Run to my position! Hostiles everywhere!&#x27;,
   709‚Üí          });
   710‚Üí          this.callbacks.onObjectiveUpdate(
   711‚Üí            &#x27;REACH LZ OMEGA&#x27;,
   712‚Üí            `Distance: ${this.distanceToLZ.toFixed(0)}m`
   713‚Üí          );
   714‚Üí        }, 2000);
   715‚Üí        break;
   716‚Üí
   717‚Üí      case &#x27;holdout&#x27;:
   718‚Üí        this.callbacks.onNotification(&#x27;DEFEND THE LZ&#x27;, 3000);
   719‚Üí        this.dropshipETA = 300;
   720‚Üí        this.currentWave = 0;
   721‚Üí        this.setBaseShake(0);
   722‚Üí
   723‚Üí        // Position player at LZ
   724‚Üí        this.camera.position.set(this.lzPosition.x, 1.7, this.lzPosition.z + 15);
   725‚Üí
   726‚Üí        setTimeout(() =&gt; {
   727‚Üí          this.callbacks.onCommsMessage({
   728‚Üí            sender: &#x27;PROMETHEUS A.I.&#x27;,
   729‚Üí            callsign: &#x27;ATHENA&#x27;,
   730‚Üí            portrait: &#x27;ai&#x27;,
   731‚Üí            text: &#x27;Dropship SALVATION en route. ETA 5 minutes. Hold your position.&#x27;,
   732‚Üí          });
   733‚Üí        }, 1500);
   734‚Üí
   735‚Üí        setTimeout(() =&gt; {
   736‚Üí          this.startWave(1);
   737‚Üí        }, 5000);
   738‚Üí
   739‚Üí        this.updateActionButtons(&#x27;holdout&#x27;);
   740‚Üí        break;
   741‚Üí
   742‚Üí      case &#x27;victory&#x27;:
   743‚Üí        this.callbacks.onNotification(&#x27;DROPSHIP ARRIVING&#x27;, 3000);
   744‚Üí        this.callbacks.onCombatStateChange(false);
   745‚Üí        this.updateActionButtons(&#x27;none&#x27;);
   746‚Üí
   747‚Üí        // Start dropship descent animation
   748‚Üí        this.startDropshipArrival();
   749‚Üí        break;
   750‚Üí
   751‚Üí      case &#x27;epilogue&#x27;:
   752‚Üí        this.showEpilogue();
   753‚Üí        break;
   754‚Üí    }
   755‚Üí  }
   756‚Üí
   757‚Üí  private handleAction(actionId: string): void {
   758‚Üí    const now = performance.now();
   759‚Üí
   760‚Üí    switch (actionId) {
   761‚Üí      case &#x27;sprint&#x27;:
   762‚Üí        // Sprint is handled in processMovement
   763‚Üí        break;
   764‚Üí
   765‚Üí      case &#x27;grenade&#x27;:
   766‚Üí        if (this.grenadeCooldown &lt;= 0) {
   767‚Üí          this.throwGrenade();
   768‚Üí          this.grenadeCooldown = this.grenadeCooldownTime;
   769‚Üí        } else {
   770‚Üí          this.callbacks.onNotification(&#x27;GRENADE ON COOLDOWN&#x27;, 500);
   771‚Üí        }
   772‚Üí        break;
   773‚Üí
   774‚Üí      case &#x27;melee&#x27;:
   775‚Üí        this.performMelee();
   776‚Üí        break;
   777‚Üí
   778‚Üí      case &#x27;flare&#x27;:
   779‚Üí        if (this.flareCooldown &lt;= 0) {
   780‚Üí          this.fireSignalFlare();
   781‚Üí          this.flareCooldown = this.flareCooldownTime;
   782‚Üí        } else {
   783‚Üí          this.callbacks.onNotification(&#x27;FLARE ON COOLDOWN&#x27;, 500);
   784‚Üí        }
   785‚Üí        break;
   786‚Üí
   787‚Üí      case &#x27;reload&#x27;:
   788‚Üí        this.handleReload();
   789‚Üí        break;
   790‚Üí    }
   791‚Üí  }
   792‚Üí
   793‚Üí  /**
   794‚Üí   * Handle weapon reload action
   795‚Üí   */
   796‚Üí  private handleReload(): void {
   797‚Üí    const weaponActions = getWeaponActions();
   798‚Üí    if (!weaponActions) return;
   799‚Üí
   800‚Üí    const state = weaponActions.getState();
   801‚Üí    if (state.isReloading) {
   802‚Üí      this.callbacks.onNotification(&#x27;ALREADY RELOADING&#x27;, 500);
   803‚Üí      return;
   804‚Üí    }
   805‚Üí    if (state.currentAmmo &gt;= state.maxMagazineSize) {
   806‚Üí      this.callbacks.onNotification(&#x27;MAGAZINE FULL&#x27;, 500);
   807‚Üí      return;
   808‚Üí    }
   809‚Üí    if (state.reserveAmmo &lt;= 0) {
   810‚Üí      this.callbacks.onNotification(&#x27;NO RESERVE AMMO&#x27;, 500);
   811‚Üí      return;
   812‚Üí    }
   813‚Üí
   814‚Üí    startReload();
   815‚Üí    this.callbacks.onNotification(&#x27;RELOADING...&#x27;, 1800);
   816‚Üí  }
   817‚Üí
   818‚Üí  private throwGrenade(): void {
   819‚Üí    this.callbacks.onNotification(&#x27;GRENADE OUT&#x27;, 1000);
   820‚Üí
   821‚Üí    // Damage all enemies in radius
   822‚Üí    const grenadePos = this.camera.position.clone();
   823‚Üí    grenadePos.addInPlace(
   824‚Üí      new Vector3(Math.sin(this.rotationY), 0, Math.cos(this.rotationY)).scale(10)
   825‚Üí    );
   826‚Üí
   827‚Üí    // Emit explosion particle effect
   828‚Üí    particleManager.emitSmallExplosion(grenadePos, 1.5);
   829‚Üí
   830‚Üí    let killCount = 0;
   831‚Üí    for (const enemy of this.enemies) {
   832‚Üí      if (!enemy.isActive) continue;
   833‚Üí      const dist = Vector3.Distance(enemy.position, grenadePos);
   834‚Üí      if (dist &lt; 15) {
   835‚Üí        const damage = Math.max(10, 100 - dist * 5);
   836‚Üí        enemy.health -= damage;
   837‚Üí        if (enemy.health &lt;= 0) {
   838‚Üí          this.killEnemy(enemy);
   839‚Üí          killCount++;
   840‚Üí        }
   841‚Üí      }
   842‚Üí    }
   843‚Üí
   844‚Üí    if (killCount &gt; 0) {
   845‚Üí      this.callbacks.onNotification(`${killCount} KILLS`, 1500);
   846‚Üí    }
   847‚Üí
   848‚Üí    this.triggerShake(3);
   849‚Üí  }
   850‚Üí
   851‚Üí  private performMelee(): void {
   852‚Üí    // Check for enemies in melee range
   853‚Üí    const meleeRange = 3;
   854‚Üí    for (const enemy of this.enemies) {
   855‚Üí      if (!enemy.isActive) continue;
   856‚Üí      const dist = Vector3.Distance(enemy.position, this.camera.position);
   857‚Üí      if (dist &lt; meleeRange) {
   858‚Üí        enemy.health -= 50;
   859‚Üí        if (enemy.health &lt;= 0) {
   860‚Üí          this.killEnemy(enemy);
   861‚Üí        }
   862‚Üí        this.callbacks.onNotification(&#x27;MELEE HIT&#x27;, 500);
   863‚Üí        this.triggerShake(1);
   864‚Üí        return;
   865‚Üí      }
   866‚Üí    }
   867‚Üí    this.callbacks.onNotification(&#x27;MISS&#x27;, 300);
   868‚Üí  }
   869‚Üí
   870‚Üí  private fireSignalFlare(): void {
   871‚Üí    this.callbacks.onNotification(&#x27;SIGNAL FLARE DEPLOYED&#x27;, 2000);
   872‚Üí    this.callbacks.onCommsMessage({
   873‚Üí      sender: &#x27;PROMETHEUS A.I.&#x27;,
   874‚Üí      callsign: &#x27;ATHENA&#x27;,
   875‚Üí      portrait: &#x27;ai&#x27;,
   876‚Üí      text: &#x27;Signal received. Relaying position to SALVATION.&#x27;,
   877‚Üí    });
   878‚Üí
   879‚Üí    // Reduce dropship ETA
   880‚Üí    this.dropshipETA = Math.max(30, this.dropshipETA - 30);
   881‚Üí  }
   882‚Üí
   883‚Üí  private updateActionButtons(mode: &#x27;escape&#x27; | &#x27;holdout&#x27; | &#x27;none&#x27;): void {
   884‚Üí    let groups: ActionButtonGroup[] = [];
   885‚Üí
   886‚Üí    switch (mode) {
   887‚Üí      case &#x27;escape&#x27;:
   888‚Üí        groups = [
   889‚Üí          {
   890‚Üí            id: &#x27;escape&#x27;,
   891‚Üí            position: &#x27;bottom&#x27;,
   892‚Üí            buttons: [
   893‚Üí              createAction(&#x27;sprint&#x27;, &#x27;SPRINT&#x27;, &#x27;ShiftLeft&#x27;, {
   894‚Üí                variant: &#x27;danger&#x27;,
   895‚Üí                size: &#x27;large&#x27;,
   896‚Üí                highlighted: true,
   897‚Üí              }),
   898‚Üí            ],
   899‚Üí          },
   900‚Üí        ];
   901‚Üí        break;
   902‚Üí
   903‚Üí      case &#x27;holdout&#x27;:
   904‚Üí        groups = [
   905‚Üí          {
   906‚Üí            id: &#x27;combat&#x27;,
   907‚Üí            position: &#x27;right&#x27;,
   908‚Üí            buttons: [
   909‚Üí              createAction(&#x27;reload&#x27;, &#x27;RELOAD&#x27;, &#x27;KeyR&#x27;, {
   910‚Üí                variant: &#x27;secondary&#x27;,
   911‚Üí              }),
   912‚Üí              createAction(&#x27;grenade&#x27;, &#x27;GRENADE&#x27;, &#x27;KeyG&#x27;, {
   913‚Üí                variant: &#x27;danger&#x27;,
   914‚Üí                cooldown: this.grenadeCooldownTime,
   915‚Üí              }),
   916‚Üí              createAction(&#x27;melee&#x27;, &#x27;MELEE&#x27;, &#x27;KeyV&#x27;, {
   917‚Üí                variant: &#x27;primary&#x27;,
   918‚Üí              }),
   919‚Üí              createAction(&#x27;flare&#x27;, &#x27;SIGNAL FLARE&#x27;, &#x27;KeyF&#x27;, {
   920‚Üí                variant: &#x27;warning&#x27;,
   921‚Üí                cooldown: this.flareCooldownTime,
   922‚Üí              }),
   923‚Üí            ],
   924‚Üí          },
   925‚Üí        ];
   926‚Üí        break;
   927‚Üí    }
   928‚Üí
   929‚Üí    this.callbacks.onActionGroupsChange(groups);
   930‚Üí  }
   931‚Üí
   932‚Üí  // ============================================================================
   933‚Üí  // WAVE COMBAT
   934‚Üí  // ============================================================================
   935‚Üí
   936‚Üí  private startWave(waveNumber: number): void {
   937‚Üí    this.currentWave = waveNumber;
   938‚Üí    this.waveActive = true;
   939‚Üí    this.waveSpawnTimer = 0;
   940‚Üí
   941‚Üí    const config = this.waveConfigs[waveNumber - 1];
   942‚Üí    if (!config) {
   943‚Üí      // All waves complete
   944‚Üí      this.transitionToPhase(&#x27;victory&#x27;);
   945‚Üí      return;
   946‚Üí    }
   947‚Üí
   948‚Üí    // Prepare spawn queue
   949‚Üí    this.enemiesToSpawn = [];
   950‚Üí    if (config.drones &gt; 0) this.enemiesToSpawn.push({ species: &#x27;skitterer&#x27;, count: config.drones });
   951‚Üí    if (config.grunts &gt; 0) this.enemiesToSpawn.push({ species: &#x27;lurker&#x27;, count: config.grunts });
   952‚Üí    if (config.spitters &gt; 0)
   953‚Üí      this.enemiesToSpawn.push({ species: &#x27;spewer&#x27;, count: config.spitters });
   954‚Üí    if (config.brutes &gt; 0)
   955‚Üí      this.enemiesToSpawn.push({ species: &#x27;broodmother&#x27;, count: config.brutes });
   956‚Üí
   957‚Üí    this.waveEnemiesRemaining = config.drones + config.grunts + config.spitters + config.brutes;
   958‚Üí
   959‚Üí    this.callbacks.onNotification(`WAVE ${waveNumber}`, 2000);
   960‚Üí
   961‚Üí    // Marcus dialogue
   962‚Üí    if (waveNumber === 3) {
   963‚Üí      setTimeout(() =&gt; {
   964‚Üí        this.callbacks.onCommsMessage({
   965‚Üí          sender: &#x27;Corporal Marcus Cole&#x27;,
   966‚Üí          callsign: &#x27;TITAN&#x27;,
   967‚Üí          portrait: &#x27;marcus&#x27;,
   968‚Üí          text: &#x27;Titan systems failing! Shields are down!&#x27;,
   969‚Üí        });
   970‚Üí        this.mechIntegrity = 60;
   971‚Üí      }, 3000);
   972‚Üí    } else if (waveNumber === 4) {
   973‚Üí      setTimeout(() =&gt; {
   974‚Üí        this.callbacks.onCommsMessage({
   975‚Üí          sender: &#x27;Corporal Marcus Cole&#x27;,
   976‚Üí          callsign: &#x27;TITAN&#x27;,
   977‚Üí          portrait: &#x27;marcus&#x27;,
   978‚Üí          text: &quot;Autocannons overheating! I can&#x27;t keep this up much longer!&quot;,
   979‚Üí        });
   980‚Üí        this.mechIntegrity = 30;
   981‚Üí      }, 3000);
   982‚Üí    } else if (waveNumber === 5) {
   983‚Üí      setTimeout(() =&gt; {
   984‚Üí        this.callbacks.onCommsMessage({
   985‚Üí          sender: &#x27;Corporal Marcus Cole&#x27;,
   986‚Üí          callsign: &#x27;TITAN&#x27;,
   987‚Üí          portrait: &#x27;marcus&#x27;,
   988‚Üí          text: &quot;This is it, brother! Everything they&#x27;ve got! HOLD THE LINE!&quot;,
   989‚Üí        });
   990‚Üí      }, 2000);
   991‚Üí
   992‚Üí      // Trigger dropship arrival mid-wave
   993‚Üí      setTimeout(() =&gt; {
   994‚Üí        this.transitionToPhase(&#x27;victory&#x27;);
   995‚Üí      }, 45000); // 45 seconds into wave 5
   996‚Üí    }
   997‚Üí  }
   998‚Üí
   999‚Üí  private spawnEnemy(species: string): void {
  1000‚Üí    if (this.enemies.length &gt;= this.maxEnemies) return;
  1001‚Üí
  1002‚Üí    const speciesData = ALIEN_SPECIES[species];
  1003‚Üí    if (!speciesData) return;
  1004‚Üí
  1005‚Üí    // Spawn from random breach hole
  1006‚Üí    const holeIndex = Math.floor(Math.random() * this.breachHoles.length);
  1007‚Üí    const hole = this.breachHoles[holeIndex];
  1008‚Üí    const spawnPos = hole.position.clone();
  1009‚Üí    spawnPos.y = 0;
  1010‚Üí    spawnPos.x += (Math.random() - 0.5) * 10;
  1011‚Üí    spawnPos.z += (Math.random() - 0.5) * 10;
  1012‚Üí
  1013‚Üí    const mesh = createAlienMesh(this.scene, speciesData, Date.now() + this.enemies.length);
  1014‚Üí    mesh.position = spawnPos.clone();
  1015‚Üí
  1016‚Üí    const enemy: Enemy = {
  1017‚Üí      mesh,
  1018‚Üí      health: speciesData.baseHealth,
  1019‚Üí      maxHealth: speciesData.baseHealth,
  1020‚Üí      position: spawnPos,
  1021‚Üí      velocity: new Vector3(0, 0, 0),
  1022‚Üí      species,
  1023‚Üí      isActive: true,
  1024‚Üí    };
  1025‚Üí
  1026‚Üí    this.enemies.push(enemy);
  1027‚Üí  }
  1028‚Üí
  1029‚Üí  private updateEnemies(deltaTime: number): void {
  1030‚Üí    const playerPos = this.camera.position;
  1031‚Üí
  1032‚Üí    for (const enemy of this.enemies) {
  1033‚Üí      if (!enemy.isActive) continue;
  1034‚Üí
  1035‚Üí      // Move toward player
  1036‚Üí      const toPlayer = playerPos.subtract(enemy.position);
  1037‚Üí      toPlayer.y = 0;
  1038‚Üí      const dist = toPlayer.length();
  1039‚Üí
  1040‚Üí      if (dist &gt; 3) {
  1041‚Üí        toPlayer.normalize();
  1042‚Üí        const species = ALIEN_SPECIES[enemy.species];
  1043‚Üí        const speed = species ? species.moveSpeed : 5;
  1044‚Üí        enemy.velocity = toPlayer.scale(speed);
  1045‚Üí        enemy.position.addInPlace(enemy.velocity.scale(deltaTime));
  1046‚Üí        enemy.mesh.position = enemy.position.clone();
  1047‚Üí
  1048‚Üí        // Face player
  1049‚Üí        enemy.mesh.rotation.y = Math.atan2(toPlayer.x, toPlayer.z);
  1050‚Üí      } else {
  1051‚Üí        // Attack player
  1052‚Üí        this.onPlayerDamaged(5);
  1053‚Üí      }
  1054‚Üí    }
  1055‚Üí
  1056‚Üí    // Marcus mech attacks enemies
  1057‚Üí    if (this.mechMesh &amp;&amp; this.mechIntegrity &gt; 0 &amp;&amp; this.phase === &#x27;holdout&#x27;) {
  1058‚Üí      this.mechFireTimer -= deltaTime;
  1059‚Üí      if (this.mechFireTimer &lt;= 0) {
  1060‚Üí        this.mechFireTimer = this.mechFireRate;
  1061‚Üí        this.mechFireAtEnemy();
  1062‚Üí      }
  1063‚Üí    }
  1064‚Üí  }
  1065‚Üí
  1066‚Üí  private mechFireAtEnemy(): void {
  1067‚Üí    // Find closest enemy to mech
  1068‚Üí    let closestEnemy: Enemy | null = null;
  1069‚Üí    let closestDist = Infinity;
  1070‚Üí
  1071‚Üí    const mechPos = this.mechMesh!.position;
  1072‚Üí
  1073‚Üí    for (const enemy of this.enemies) {
  1074‚Üí      if (!enemy.isActive) continue;
  1075‚Üí      const dist = Vector3.Distance(enemy.position, mechPos);
  1076‚Üí      if (dist &lt; closestDist &amp;&amp; dist &lt; 100) {
  1077‚Üí        closestDist = dist;
  1078‚Üí        closestEnemy = enemy;
  1079‚Üí      }
  1080‚Üí    }
  1081‚Üí
  1082‚Üí    if (closestEnemy &amp;&amp; this.mechGunLight) {
  1083‚Üí      // Muzzle flash
  1084‚Üí      this.mechGunLight.intensity = 50;
  1085‚Üí      setTimeout(() =&gt; {
  1086‚Üí        if (this.mechGunLight) this.mechGunLight.intensity = 0;
  1087‚Üí      }, 50);
  1088‚Üí
  1089‚Üí      // Deal damage based on mech integrity
  1090‚Üí      const damage = 20 * (this.mechIntegrity / 100);
  1091‚Üí      closestEnemy.health -= damage;
  1092‚Üí
  1093‚Üí      if (closestEnemy.health &lt;= 0) {
  1094‚Üí        this.killEnemy(closestEnemy);
  1095‚Üí      }
  1096‚Üí    }
  1097‚Üí  }
  1098‚Üí
  1099‚Üí  private killEnemy(enemy: Enemy): void {
  1100‚Üí    // Emit alien death particle effect (green goo burst)
  1101‚Üí    particleManager.emitAlienDeath(enemy.position.clone(), 1.2);
  1102‚Üí
  1103‚Üí    enemy.isActive = false;
  1104‚Üí    enemy.mesh.setEnabled(false);
  1105‚Üí    this.kills++;
  1106‚Üí    this.waveEnemiesRemaining--;
  1107‚Üí    this.callbacks.onKill();
  1108‚Üí
  1109‚Üí    // Check if wave is complete
  1110‚Üí    if (this.waveActive &amp;&amp; this.waveEnemiesRemaining &lt;= 0 &amp;&amp; this.enemiesToSpawn.length === 0) {
  1111‚Üí      this.waveActive = false;
  1112‚Üí
  1113‚Üí      // Brief pause before next wave
  1114‚Üí      if (this.currentWave &lt; 5) {
  1115‚Üí        this.callbacks.onNotification(`WAVE ${this.currentWave} COMPLETE`, 2000);
  1116‚Üí        setTimeout(() =&gt; {
  1117‚Üí          this.startWave(this.currentWave + 1);
  1118‚Üí        }, 5000);
  1119‚Üí      }
  1120‚Üí    }
  1121‚Üí  }
  1122‚Üí
  1123‚Üí  private onPlayerDamaged(damage: number): void {
  1124‚Üí    this.playerHealth -= damage;
  1125‚Üí    this.callbacks.onHealthChange(this.playerHealth);
  1126‚Üí    this.callbacks.onDamage();
  1127‚Üí    this.triggerDamageShake(damage);
  1128‚Üí
  1129‚Üí    if (this.playerHealth &lt;= 0) {
  1130‚Üí      this.callbacks.onNotification(&#x27;KIA&#x27;, 3000);
  1131‚Üí      // Would trigger game over / restart
  1132‚Üí    }
  1133‚Üí  }
  1134‚Üí
  1135‚Üí  // ============================================================================
  1136‚Üí  // DROPSHIP AND VICTORY
  1137‚Üí  // ============================================================================
  1138‚Üí
  1139‚Üí  private startDropshipArrival(): void {
  1140‚Üí    if (!this.dropship) return;
  1141‚Üí
  1142‚Üí    this.dropship.setEnabled(true);
  1143‚Üí    this.callbacks.onNotification(&#x27;SALVATION INBOUND&#x27;, 3000);
  1144‚Üí
  1145‚Üí    // Animate dropship descent
  1146‚Üí    const startPos = new Vector3(0, 150, this.lzPosition.z - 200);
  1147‚Üí    const endPos = new Vector3(0, 8, this.lzPosition.z);
  1148‚Üí
  1149‚Üí    this.dropship.position = startPos;
  1150‚Üí
  1151‚Üí    const posAnim = new Animation(
  1152‚Üí      &#x27;dropshipDescent&#x27;,
  1153‚Üí      &#x27;position&#x27;,
  1154‚Üí      30,
  1155‚Üí      Animation.ANIMATIONTYPE_VECTOR3,
  1156‚Üí      Animation.ANIMATIONLOOPMODE_CONSTANT
  1157‚Üí    );
  1158‚Üí
  1159‚Üí    const easing = new CubicEase();
  1160‚Üí    easing.setEasingMode(EasingFunction.EASINGMODE_EASEOUT);
  1161‚Üí    posAnim.setEasingFunction(easing);
  1162‚Üí
  1163‚Üí    posAnim.setKeys([
  1164‚Üí      { frame: 0, value: startPos },
  1165‚Üí      { frame: 300, value: endPos }, // 10 seconds
  1166‚Üí    ]);
  1167‚Üí
  1168‚Üí    this.dropship.animations = [posAnim];
  1169‚Üí    this.scene.beginAnimation(this.dropship, 0, 300, false, 1, () =&gt; {
  1170‚Üí      this.onDropshipLanded();
  1171‚Üí    });
  1172‚Üí
  1173‚Üí    // Clear remaining enemies
  1174‚Üí    setTimeout(() =&gt; {
  1175‚Üí      this.callbacks.onCommsMessage({
  1176‚Üí        sender: &#x27;Dropship Pilot&#x27;,
  1177‚Üí        callsign: &#x27;SALVATION&#x27;,
  1178‚Üí        portrait: &#x27;ai&#x27;,
  1179‚Üí        text: &#x27;SALVATION on final approach! Clearing a path!&#x27;,
  1180‚Üí      });
  1181‚Üí
  1182‚Üí      // Scatter/kill remaining enemies
  1183‚Üí      for (const enemy of this.enemies) {
  1184‚Üí        if (enemy.isActive) {
  1185‚Üí          enemy.isActive = false;
  1186‚Üí          enemy.mesh.setEnabled(false);
  1187‚Üí        }
  1188‚Üí      }
  1189‚Üí    }, 3000);
  1190‚Üí  }
  1191‚Üí
  1192‚Üí  private onDropshipLanded(): void {
  1193‚Üí    this.callbacks.onNotification(&#x27;GET TO THE DROPSHIP&#x27;, 3000);
  1194‚Üí
  1195‚Üí    // Marcus&#x27;s mech collapses
  1196‚Üí    if (this.mechMesh) {
  1197‚Üí      this.mechIntegrity = 0;
  1198‚Üí      this.callbacks.onCommsMessage({
  1199‚Üí        sender: &#x27;Corporal Marcus Cole&#x27;,
  1200‚Üí        callsign: &#x27;TITAN&#x27;,
  1201‚Üí        portrait: &#x27;marcus&#x27;,
  1202‚Üí        text: &quot;Titan&#x27;s done... power cells are depleted. But we made it, brother.&quot;,
  1203‚Üí      });
  1204‚Üí
  1205‚Üí      // Animate mech falling
  1206‚Üí      const fallAnim = new Animation(
  1207‚Üí        &#x27;mechFall&#x27;,
  1208‚Üí        &#x27;rotation.x&#x27;,
  1209‚Üí        30,
  1210‚Üí        Animation.ANIMATIONTYPE_FLOAT,
  1211‚Üí        Animation.ANIMATIONLOOPMODE_CONSTANT
  1212‚Üí      );
  1213‚Üí      fallAnim.setKeys([
  1214‚Üí        { frame: 0, value: 0 },
  1215‚Üí        { frame: 60, value: Math.PI / 3 },
  1216‚Üí      ]);
  1217‚Üí      this.mechMesh.animations = [fallAnim];
  1218‚Üí      this.scene.beginAnimation(this.mechMesh, 0, 60, false);
  1219‚Üí    }
  1220‚Üí
  1221‚Üí    // After player reaches dropship
  1222‚Üí    setTimeout(() =&gt; {
  1223‚Üí      this.transitionToPhase(&#x27;epilogue&#x27;);
  1224‚Üí    }, 5000);
  1225‚Üí  }
  1226‚Üí
  1227‚Üí  private showEpilogue(): void {
  1228‚Üí    this.callbacks.onCombatStateChange(false);
  1229‚Üí
  1230‚Üí    // Unlock game completion achievement
  1231‚Üí    getAchievementManager().onGameComplete();
  1232‚Üí
  1233‚Üí    // Fade to black effect (using scene clear color)
  1234‚Üí    this.scene.clearColor = new Color4(0, 0, 0, 1);
  1235‚Üí
  1236‚Üí    // Hide everything
  1237‚Üí    this.setSurfaceVisible(false);
  1238‚Üí    if (this.dropship) this.dropship.setEnabled(false);
  1239‚Üí    if (this.mechMesh) this.mechMesh.setEnabled(false);
  1240‚Üí    this.enemies.forEach((e) =&gt; e.mesh.setEnabled(false));
  1241‚Üí
  1242‚Üí    this.callbacks.onNotification(&#x27;MISSION COMPLETE&#x27;, 5000);
  1243‚Üí
  1244‚Üí    setTimeout(() =&gt; {
  1245‚Üí      this.callbacks.onCommsMessage({
  1246‚Üí        sender: &#x27;Commander Elena Vasquez&#x27;,
  1247‚Üí        callsign: &#x27;PROMETHEUS ACTUAL&#x27;,
  1248‚Üí        portrait: &#x27;commander&#x27;,
  1249‚Üí        text: &quot;Sergeants Cole... both of you. Welcome home. The Queen is dead. Kepler&#x27;s Promise is secure.&quot;,
  1250‚Üí      });
  1251‚Üí    }, 3000);
  1252‚Üí
  1253‚Üí    setTimeout(() =&gt; {
  1254‚Üí      this.callbacks.onCommsMessage({
  1255‚Üí        sender: &#x27;PROMETHEUS A.I.&#x27;,
  1256‚Üí        callsign: &#x27;ATHENA&#x27;,
  1257‚Üí        portrait: &#x27;ai&#x27;,
  1258‚Üí        text: `Mission debrief: ${this.kills} hostiles eliminated. Brothers reunited. &quot;Find them. Bring them home.&quot; Objective complete.`,
  1259‚Üí      });
  1260‚Üí    }, 8000);
  1261‚Üí
  1262‚Üí    setTimeout(() =&gt; {
  1263‚Üí      this.callbacks.onObjectiveUpdate(&#x27;STELLAR DESCENT&#x27;, &#x27;CAMPAIGN COMPLETE&#x27;);
  1264‚Üí
  1265‚Üí      // Could trigger credits here
  1266‚Üí      this.state.completed = true;
  1267‚Üí    }, 13000);
  1268‚Üí  }
  1269‚Üí
  1270‚Üí  // ============================================================================
  1271‚Üí  // UPDATE LOOP
  1272‚Üí  // ============================================================================
  1273‚Üí
  1274‚Üí  protected override processMovement(deltaTime: number): void {
  1275‚Üí    if (!this.isPointerLocked()) return;
  1276‚Üí
  1277‚Üí    const baseSpeed = this.getMoveSpeed();
  1278‚Üí    // Use InputTracker for sprint action (configurable keybinding)
  1279‚Üí    const isSprinting = this.inputTracker.isActionActive(&#x27;sprint&#x27;);
  1280‚Üí    const moveSpeed = isSprinting ? baseSpeed * 1.8 : baseSpeed;
  1281‚Üí    const speed = moveSpeed * deltaTime;
  1282‚Üí
  1283‚Üí    // Calculate movement direction
  1284‚Üí    const forward = new Vector3(Math.sin(this.rotationY), 0, Math.cos(this.rotationY));
  1285‚Üí    const right = new Vector3(Math.cos(this.rotationY), 0, -Math.sin(this.rotationY));
  1286‚Üí
  1287‚Üí    let dx = 0;
  1288‚Üí    let dz = 0;
  1289‚Üí
  1290‚Üí    // Use InputTracker for movement actions (configurable keybindings)
  1291‚Üí    if (this.inputTracker.isActionActive(&#x27;moveForward&#x27;)) {
  1292‚Üí      dx += forward.x;
  1293‚Üí      dz += forward.z;
  1294‚Üí    }
  1295‚Üí    if (this.inputTracker.isActionActive(&#x27;moveBackward&#x27;)) {
  1296‚Üí      dx -= forward.x;
  1297‚Üí      dz -= forward.z;
  1298‚Üí    }
  1299‚Üí    if (this.inputTracker.isActionActive(&#x27;moveLeft&#x27;)) {
  1300‚Üí      dx -= right.x;
  1301‚Üí      dz -= right.z;
  1302‚Üí    }
  1303‚Üí    if (this.inputTracker.isActionActive(&#x27;moveRight&#x27;)) {
  1304‚Üí      dx += right.x;
  1305‚Üí      dz += right.z;
  1306‚Üí    }
  1307‚Üí
  1308‚Üí    // Normalize and apply
  1309‚Üí    if (dx !== 0 || dz !== 0) {
  1310‚Üí      const len = Math.sqrt(dx * dx + dz * dz);
  1311‚Üí      dx = (dx / len) * speed;
  1312‚Üí      dz = (dz / len) * speed;
  1313‚Üí
  1314‚Üí      this.camera.position.x += dx;
  1315‚Üí      this.camera.position.z += dz;
  1316‚Üí    }
  1317‚Üí
  1318‚Üí    // Phase-specific movement constraints
  1319‚Üí    if (this.phase === &#x27;escape_tunnel&#x27;) {
  1320‚Üí      // In escape tunnel, track progress
  1321‚Üí      this.playerEscapeProgress = Math.abs(this.camera.position.z) / this.escapeTunnelLength;
  1322‚Üí
  1323‚Üí      // Clamp to tunnel bounds
  1324‚Üí      const tunnelRadius = 3.5;
  1325‚Üí      const distFromCenter = Math.sqrt(
  1326‚Üí        this.camera.position.x ** 2 + (this.camera.position.y - 1.7) ** 2
  1327‚Üí      );
  1328‚Üí      if (distFromCenter &gt; tunnelRadius) {
  1329‚Üí        const scale = tunnelRadius / distFromCenter;
  1330‚Üí        this.camera.position.x *= scale;
  1331‚Üí      }
  1332‚Üí    }
  1333‚Üí  }
  1334‚Üí
  1335‚Üí  protected override getMoveSpeed(): number {
  1336‚Üí    return this.phase === &#x27;escape_tunnel&#x27; ? 8 : 5;
  1337‚Üí  }
  1338‚Üí
  1339‚Üí  protected override handleKeyDown(e: KeyboardEvent): void {
  1340‚Üí    super.handleKeyDown(e);
  1341‚Üí
  1342‚Üí    // Handle reload key during combat phases
  1343‚Üí    if (e.code === &#x27;KeyR&#x27; &amp;&amp; (this.phase === &#x27;holdout&#x27; || this.phase === &#x27;surface_run&#x27;)) {
  1344‚Üí      this.handleReload();
  1345‚Üí    }
  1346‚Üí  }
  1347‚Üí
  1348‚Üí  protected updateLevel(deltaTime: number): void {
  1349‚Üí    this.phaseTime += deltaTime;
  1350‚Üí
  1351‚Üí    // Update cooldowns
  1352‚Üí    this.grenadeCooldown = Math.max(0, this.grenadeCooldown - deltaTime * 1000);
  1353‚Üí    this.flareCooldown = Math.max(0, this.flareCooldown - deltaTime * 1000);
  1354‚Üí
  1355‚Üí    // Phase-specific updates
  1356‚Üí    switch (this.phase) {
  1357‚Üí      case &#x27;escape_tunnel&#x27;:
  1358‚Üí        this.updateEscapeTunnel(deltaTime);
  1359‚Üí        break;
  1360‚Üí
  1361‚Üí      case &#x27;surface_run&#x27;:
  1362‚Üí        this.updateSurfaceRun(deltaTime);
  1363‚Üí        break;
  1364‚Üí
  1365‚Üí      case &#x27;holdout&#x27;:
  1366‚Üí        this.updateHoldout(deltaTime);
  1367‚Üí        break;
  1368‚Üí
  1369‚Üí      case &#x27;victory&#x27;:
  1370‚Üí        // Dropship animation handled elsewhere
  1371‚Üí        break;
  1372‚Üí    }
  1373‚Üí  }
  1374‚Üí
  1375‚Üí  private updateEscapeTunnel(deltaTime: number): void {
  1376‚Üí    // Update escape timer
  1377‚Üí    this.escapeTimer -= deltaTime;
  1378‚Üí
  1379‚Üí    // Update collapse wall position (chasing player)
  1380‚Üí    const collapseSpeed = 12 + (180 - this.escapeTimer) * 0.05; // Speeds up over time
  1381‚Üí    this.collapseDistance += collapseSpeed * deltaTime;
  1382‚Üí
  1383‚Üí    if (this.collapseWall) {
  1384‚Üí      this.collapseWall.position.z = -this.collapseDistance;
  1385‚Üí    }
  1386‚Üí
  1387‚Üí    // Spawn debris
  1388‚Üí    if (Math.random() &lt; 0.3) {
  1389‚Üí      this.spawnDebris();
  1390‚Üí    }
  1391‚Üí
  1392‚Üí    // Update debris
  1393‚Üí    this.updateDebris(deltaTime);
  1394‚Üí
  1395‚Üí    // Check for collapse catching player
  1396‚Üí    const playerZ = Math.abs(this.camera.position.z);
  1397‚Üí    if (this.collapseDistance &gt; playerZ + 5) {
  1398‚Üí      this.onPlayerDamaged(25);
  1399‚Üí      this.callbacks.onNotification(&#x27;COLLAPSE DAMAGE&#x27;, 1000);
  1400‚Üí      this.collapseDistance = playerZ - 10; // Push back slightly
  1401‚Üí    }
  1402‚Üí
  1403‚Üí    // Check for escape completion
  1404‚Üí    if (this.playerEscapeProgress &gt;= 0.95) {
  1405‚Üí      this.transitionToPhase(&#x27;surface_run&#x27;);
  1406‚Üí    }
  1407‚Üí
  1408‚Üí    // Update HUD
  1409‚Üí    const timerColor = this.escapeTimer &lt; 30 ? &#x27;danger&#x27; : &#x27;normal&#x27;;
  1410‚Üí    this.callbacks.onObjectiveUpdate(
  1411‚Üí      &#x27;ESCAPE THE HIVE&#x27;,
  1412‚Üí      `TIME: ${Math.ceil(this.escapeTimer)}s | PROGRESS: ${Math.floor(this.playerEscapeProgress * 100)}%`
  1413‚Üí    );
  1414‚Üí  }
  1415‚Üí
  1416‚Üí  private spawnDebris(): void {
  1417‚Üí    const debris = MeshBuilder.CreatePolyhedron(
  1418‚Üí      `debris_${Date.now()}`,
  1419‚Üí      { type: Math.floor(Math.random() * 4), size: 0.3 + Math.random() * 0.5 },
  1420‚Üí      this.scene
  1421‚Üí    );
  1422‚Üí
  1423‚Üí    const debrisMat = new StandardMaterial(&#x27;debrisMat&#x27;, this.scene);
  1424‚Üí    debrisMat.diffuseColor = new Color3(0.3, 0.2, 0.25);
  1425‚Üí    debris.material = debrisMat;
  1426‚Üí
  1427‚Üí    // Spawn ahead of player
  1428‚Üí    debris.position.set(
  1429‚Üí      (Math.random() - 0.5) * 6,
  1430‚Üí      3 + Math.random() * 2,
  1431‚Üí      this.camera.position.z - 20 - Math.random() * 30
  1432‚Üí    );
  1433‚Üí
  1434‚Üí    this.debris.push({
  1435‚Üí      mesh: debris,
  1436‚Üí      velocity: new Vector3(
  1437‚Üí        (Math.random() - 0.5) * 2,
  1438‚Üí        -5 - Math.random() * 5,
  1439‚Üí        (Math.random() - 0.5) * 2
  1440‚Üí      ),
  1441‚Üí      rotationSpeed: new Vector3(Math.random() * 3, Math.random() * 3, Math.random() * 3),
  1442‚Üí      lifetime: 5,
  1443‚Üí    });
  1444‚Üí  }
  1445‚Üí
  1446‚Üí  private updateDebris(deltaTime: number): void {
  1447‚Üí    for (let i = this.debris.length - 1; i &gt;= 0; i--) {
  1448‚Üí      const d = this.debris[i];
  1449‚Üí      d.mesh.position.addInPlace(d.velocity.scale(deltaTime));
  1450‚Üí      d.mesh.rotation.addInPlace(d.rotationSpeed.scale(deltaTime));
  1451‚Üí      d.lifetime -= deltaTime;
  1452‚Üí
  1453‚Üí      // Check for collision with player
  1454‚Üí      const dist = Vector3.Distance(d.mesh.position, this.camera.position);
  1455‚Üí      if (dist &lt; 1.5 &amp;&amp; d.mesh.position.y &lt; 2) {
  1456‚Üí        this.onPlayerDamaged(10);
  1457‚Üí        this.callbacks.onNotification(&#x27;DEBRIS HIT&#x27;, 500);
  1458‚Üí        d.mesh.dispose();
  1459‚Üí        this.debris.splice(i, 1);
  1460‚Üí        continue;
  1461‚Üí      }
  1462‚Üí
  1463‚Üí      // Remove if expired or below ground
  1464‚Üí      if (d.lifetime &lt;= 0 || d.mesh.position.y &lt; -2) {
  1465‚Üí        d.mesh.dispose();
  1466‚Üí        this.debris.splice(i, 1);
  1467‚Üí      }
  1468‚Üí    }
  1469‚Üí  }
  1470‚Üí
  1471‚Üí  private updateSurfaceRun(deltaTime: number): void {
  1472‚Üí    // Calculate distance to LZ
  1473‚Üí    const playerPos2D = new Vector3(this.camera.position.x, 0, this.camera.position.z);
  1474‚Üí    const lzPos2D = new Vector3(this.lzPosition.x, 0, this.lzPosition.z);
  1475‚Üí    this.distanceToLZ = Vector3.Distance(playerPos2D, lzPos2D);
  1476‚Üí
  1477‚Üí    // Update HUD
  1478‚Üí    this.callbacks.onObjectiveUpdate(
  1479‚Üí      &#x27;REACH LZ OMEGA&#x27;,
  1480‚Üí      `Distance: ${this.distanceToLZ.toFixed(0)}m`
  1481‚Üí    );
  1482‚Üí
  1483‚Üí    // Spawn enemies during run
  1484‚Üí    if (Math.random() &lt; 0.02 &amp;&amp; this.enemies.length &lt; 10) {
  1485‚Üí      this.spawnEnemy(Math.random() &lt; 0.7 ? &#x27;skitterer&#x27; : &#x27;lurker&#x27;);
  1486‚Üí    }
  1487‚Üí
  1488‚Üí    // Update enemies
  1489‚Üí    this.updateEnemies(deltaTime);
  1490‚Üí
  1491‚Üí    // Check for reaching LZ
  1492‚Üí    if (this.distanceToLZ &lt; 30) {
  1493‚Üí      this.transitionToPhase(&#x27;holdout&#x27;);
  1494‚Üí    }
  1495‚Üí  }
  1496‚Üí
  1497‚Üí  private updateHoldout(deltaTime: number): void {
  1498‚Üí    // Update dropship ETA
  1499‚Üí    this.dropshipETA -= deltaTime;
  1500‚Üí
  1501‚Üí    // Wave spawning
  1502‚Üí    if (this.waveActive &amp;&amp; this.enemiesToSpawn.length &gt; 0) {
  1503‚Üí      const config = this.waveConfigs[this.currentWave - 1];
  1504‚Üí      this.waveSpawnTimer -= deltaTime;
  1505‚Üí
  1506‚Üí      if (this.waveSpawnTimer &lt;= 0) {
  1507‚Üí        this.waveSpawnTimer = config.spawnDelay;
  1508‚Üí
  1509‚Üí        // Spawn next enemy
  1510‚Üí        const spawnGroup = this.enemiesToSpawn[0];
  1511‚Üí        this.spawnEnemy(spawnGroup.species);
  1512‚Üí        spawnGroup.count--;
  1513‚Üí
  1514‚Üí        if (spawnGroup.count &lt;= 0) {
  1515‚Üí          this.enemiesToSpawn.shift();
  1516‚Üí        }
  1517‚Üí      }
  1518‚Üí    }
  1519‚Üí
  1520‚Üí    // Update enemies
  1521‚Üí    this.updateEnemies(deltaTime);
  1522‚Üí
  1523‚Üí    // Decrease mech integrity over time during combat
  1524‚Üí    if (this.waveActive &amp;&amp; this.mechIntegrity &gt; 0) {
  1525‚Üí      this.mechIntegrity -= deltaTime * 0.5;
  1526‚Üí    }
  1527‚Üí
  1528‚Üí    // Update HUD
  1529‚Üí    const timerStr = this.formatTime(this.dropshipETA);
  1530‚Üí    const timerColor = this.dropshipETA &lt; 30 ? &#x27;CRITICAL&#x27; : &#x27;&#x27;;
  1531‚Üí    this.callbacks.onObjectiveUpdate(
  1532‚Üí      `WAVE ${this.currentWave}/5 - HOLDOUT`,
  1533‚Üí      `DROPSHIP ETA: ${timerStr} | MECH: ${Math.floor(this.mechIntegrity)}% | KILLS: ${this.kills}`
  1534‚Üí    );
  1535‚Üí
  1536‚Üí    // Check for dropship arrival
  1537‚Üí    if (this.dropshipETA &lt;= 0 &amp;&amp; this.phase === &#x27;holdout&#x27;) {
  1538‚Üí      this.transitionToPhase(&#x27;victory&#x27;);
  1539‚Üí    }
  1540‚Üí  }
  1541‚Üí
  1542‚Üí  private formatTime(seconds: number): string {
  1543‚Üí    const mins = Math.floor(seconds / 60);
  1544‚Üí    const secs = Math.floor(seconds % 60);
  1545‚Üí    return `${mins}:${secs.toString().padStart(2, &#x27;0&#x27;)}`;
  1546‚Üí  }
  1547‚Üí
  1548‚Üí  // ============================================================================
  1549‚Üí  // LIFECYCLE
  1550‚Üí  // ============================================================================
  1551‚Üí
  1552‚Üí  override canTransitionTo(levelId: LevelId): boolean {
  1553‚Üí    return false; // Extraction is the final level
  1554‚Üí  }
  1555‚Üí
  1556‚Üí  protected disposeLevel(): void {
  1557‚Üí    // Unregister action handler
  1558‚Üí    this.callbacks.onActionHandlerRegister(null);
  1559‚Üí    this.callbacks.onActionGroupsChange([]);
  1560‚Üí
  1561‚Üí    // Dispose tunnel
  1562‚Üí    this.tunnelSegments.forEach((s) =&gt; s.dispose());
  1563‚Üí    this.tunnelLights.forEach((l) =&gt; l.dispose());
  1564‚Üí    this.collapseWall?.dispose();
  1565‚Üí    this.exitLight?.dispose();
  1566‚Üí    this.debris.forEach((d) =&gt; d.mesh.dispose());
  1567‚Üí
  1568‚Üí    // Dispose surface
  1569‚Üí    this.terrain?.dispose();
  1570‚Üí    this.skyDome?.dispose();
  1571‚Üí    this.lzPad?.dispose();
  1572‚Üí    this.lzBeacon?.dispose();
  1573‚Üí    this.breachHoles.forEach((h) =&gt; h.dispose());
  1574‚Üí    this.canyonWalls.forEach((w) =&gt; w.dispose());
  1575‚Üí    this.barrierWalls.forEach((b) =&gt; b.dispose());
  1576‚Üí
  1577‚Üí    // Dispose mech
  1578‚Üí    this.mechMesh?.dispose();
  1579‚Üí    this.mechGunLight?.dispose();
  1580‚Üí
  1581‚Üí    // Dispose dropship
  1582‚Üí    this.dropship?.dispose();
  1583‚Üí    this.dropshipLight?.dispose();
  1584‚Üí
  1585‚Üí    // Dispose enemies
  1586‚Üí    this.enemies.forEach((e) =&gt; e.mesh.dispose());
  1587‚Üí  }
  1588‚Üí}
  1589‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-50-320Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-50-320Z" class="timestamp-link"><time datetime="2026-01-30T06:44:50.320Z" data-timestamp="2026-01-30T06:44:50.320Z">2026-01-30T06:44:50.320Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01XdCKeMAypygLtogFTNTcmf"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/GameContext.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-50-323Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-50-323Z" class="timestamp-link"><time datetime="2026-01-30T06:44:50.323Z" data-timestamp="2026-01-30T06:44:50.323Z">2026-01-30T06:44:50.323Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport React, {
     2‚Üí  createContext,
     3‚Üí  type ReactNode,
     4‚Üí  useCallback,
     5‚Üí  useContext,
     6‚Üí  useEffect,
     7‚Üí  useRef,
     8‚Üí  useState,
     9‚Üí} from &#x27;react&#x27;;
    10‚Üíimport { getAchievementManager } from &#x27;../achievements&#x27;;
    11‚Üíimport { getAudioManager, type MusicTrack } from &#x27;../core/AudioManager&#x27;;
    12‚Üíimport type { TutorialPhase } from &#x27;../levels/anchor-station/tutorialSteps&#x27;;
    13‚Üíimport type { CommsMessage, TouchInput } from &#x27;../types&#x27;;
    14‚Üíimport type { ActionButtonGroup } from &#x27;../types/actions&#x27;;
    15‚Üí
    16‚Üí/**
    17‚Üí * HUD visibility state for progressive unlocking
    18‚Üí * Tutorial levels can enable elements one at a time
    19‚Üí */
    20‚Üíexport interface HUDVisibility {
    21‚Üí  healthBar: boolean;
    22‚Üí  crosshair: boolean;
    23‚Üí  killCounter: boolean;
    24‚Üí  missionText: boolean;
    25‚Üí  actionButtons: boolean;
    26‚Üí  commsDisplay: boolean;
    27‚Üí  notifications: boolean;
    28‚Üí  compass: boolean;
    29‚Üí}
    30‚Üí
    31‚Üí/**
    32‚Üí * Objective marker for guiding player attention
    33‚Üí */
    34‚Üíexport interface ObjectiveMarker {
    35‚Üí  type: &#x27;main&#x27; | &#x27;interact&#x27; | &#x27;optional&#x27; | &#x27;waypoint&#x27;;
    36‚Üí  visible: boolean;
    37‚Üí  label?: string;
    38‚Üí}
    39‚Üí
    40‚Üí/**
    41‚Üí * Compass navigation data from player/camera
    42‚Üí */
    43‚Üíexport interface CompassData {
    44‚Üí  /** Player heading in radians (0 = North, positive = clockwise) */
    45‚Üí  heading: number;
    46‚Üí  /** Direction to current objective in radians (optional) */
    47‚Üí  objectiveDirection?: number;
    48‚Üí  /** Distance to current objective in meters (optional) */
    49‚Üí  objectiveDistance?: number;
    50‚Üí}
    51‚Üí
    52‚Üí/**
    53‚Üí * Default HUD visibility - all elements visible (post-tutorial state)
    54‚Üí */
    55‚Üíexport const DEFAULT_HUD_VISIBILITY: HUDVisibility = {
    56‚Üí  healthBar: true,
    57‚Üí  crosshair: true,
    58‚Üí  killCounter: true,
    59‚Üí  missionText: true,
    60‚Üí  actionButtons: true,
    61‚Üí  commsDisplay: true,
    62‚Üí  notifications: true,
    63‚Üí  compass: true,
    64‚Üí};
    65‚Üí
    66‚Üí/**
    67‚Üí * Tutorial start HUD visibility - minimal UI
    68‚Üí */
    69‚Üíexport const TUTORIAL_START_HUD_VISIBILITY: HUDVisibility = {
    70‚Üí  healthBar: false,
    71‚Üí  crosshair: false,
    72‚Üí  killCounter: false,
    73‚Üí  missionText: false,
    74‚Üí  actionButtons: false,
    75‚Üí  commsDisplay: true, // Always available for narrative
    76‚Üí  notifications: true, // Always available for feedback
    77‚Üí  compass: false, // Unlocked later in tutorial
    78‚Üí};
    79‚Üí
    80‚Üíinterface GameContextType {
    81‚Üí  // Player state
    82‚Üí  playerHealth: number;
    83‚Üí  maxHealth: number;
    84‚Üí  setPlayerHealth: (health: number) =&gt; void;
    85‚Üí  isPlayerDead: boolean;
    86‚Üí  resetPlayerHealth: () =&gt; void;
    87‚Üí  onPlayerDeath: (() =&gt; void) | null;
    88‚Üí  setOnPlayerDeath: (callback: (() =&gt; void) | null) =&gt; void;
    89‚Üí
    90‚Üí  // Combat stats
    91‚Üí  kills: number;
    92‚Üí  addKill: () =&gt; void;
    93‚Üí
    94‚Üí  // Mission/Objective
    95‚Üí  missionText: string;
    96‚Üí  setMissionText: (text: string) =&gt; void;
    97‚Üí  objectiveTitle: string;
    98‚Üí  objectiveInstructions: string;
    99‚Üí  setObjective: (title: string, instructions: string) =&gt; void;
   100‚Üí  currentChapter: number;
   101‚Üí  setCurrentChapter: (chapter: number) =&gt; void;
   102‚Üí
   103‚Üí  // Touch input
   104‚Üí  touchInput: TouchInput | null;
   105‚Üí  setTouchInput: (input: TouchInput | null) =&gt; void;
   106‚Üí
   107‚Üí  // Notifications
   108‚Üí  showNotification: (text: string, duration?: number) =&gt; void;
   109‚Üí  notification: { text: string; id: number } | null;
   110‚Üí
   111‚Üí  // Comms display
   112‚Üí  showComms: (message: CommsMessage) =&gt; void;
   113‚Üí  hideComms: () =&gt; void;
   114‚Üí  currentComms: CommsMessage | null;
   115‚Üí  commsDismissedFlag: number; // Increments when comms dismissed
   116‚Üí
   117‚Üí  // Game events
   118‚Üí  onDamage: () =&gt; void;
   119‚Üí  damageFlash: boolean;
   120‚Üí
   121‚Üí  // Calibration mode (shooting range)
   122‚Üí  isCalibrating: boolean;
   123‚Üí  setIsCalibrating: (value: boolean) =&gt; void;
   124‚Üí
   125‚Üí  // Music/combat state
   126‚Üí  inCombat: boolean;
   127‚Üí  setInCombat: (value: boolean) =&gt; void;
   128‚Üí  playMusic: (track: MusicTrack) =&gt; void;
   129‚Üí
   130‚Üí  // Dynamic action buttons
   131‚Üí  actionGroups: ActionButtonGroup[];
   132‚Üí  setActionGroups: (groups: ActionButtonGroup[]) =&gt; void;
   133‚Üí  triggerAction: (actionId: string) =&gt; void;
   134‚Üí  onActionTriggered: ((actionId: string) =&gt; void) | null;
   135‚Üí  setOnActionTriggered: (handler: ((actionId: string) =&gt; void) | null) =&gt; void;
   136‚Üí
   137‚Üí  // HUD visibility (progressive unlocking)
   138‚Üí  hudVisibility: HUDVisibility;
   139‚Üí  setHUDVisibility: (visibility: Partial&lt;HUDVisibility&gt;) =&gt; void;
   140‚Üí  resetHUDVisibility: () =&gt; void;
   141‚Üí
   142‚Üí  // Objective marker
   143‚Üí  objectiveMarker: ObjectiveMarker | null;
   144‚Üí  setObjectiveMarker: (marker: ObjectiveMarker | null) =&gt; void;
   145‚Üí
   146‚Üí  // Compass navigation data
   147‚Üí  compassData: CompassData;
   148‚Üí  setCompassData: (data: CompassData) =&gt; void;
   149‚Üí
   150‚Üí  // Tutorial phase (for control hints)
   151‚Üí  tutorialPhase: TutorialPhase;
   152‚Üí  setTutorialPhase: (phase: TutorialPhase) =&gt; void;
   153‚Üí  isTutorialActive: boolean;
   154‚Üí  setIsTutorialActive: (active: boolean) =&gt; void;
   155‚Üí}
   156‚Üí
   157‚Üíconst GameContext = createContext&lt;GameContextType | null&gt;(null);
   158‚Üí
   159‚Üíexport function useGame() {
   160‚Üí  const context = useContext(GameContext);
   161‚Üí  if (!context) {
   162‚Üí    throw new Error(&#x27;useGame must be used within a GameProvider&#x27;);
   163‚Üí  }
   164‚Üí  return context;
   165‚Üí}
   166‚Üí
   167‚Üíinterface GameProviderProps {
   168‚Üí  children: ReactNode;
   169‚Üí}
   170‚Üí
   171‚Üíexport function GameProvider({ children }: GameProviderProps) {
   172‚Üí  const [playerHealth, setPlayerHealthRaw] = useState(100);
   173‚Üí  const [maxHealth] = useState(100);
   174‚Üí  const [isPlayerDead, setIsPlayerDead] = useState(false);
   175‚Üí  const [kills, setKills] = useState(0);
   176‚Üí  const playerDeathCallbackRef = useRef&lt;(() =&gt; void) | null&gt;(null);
   177‚Üí  const [missionText, setMissionText] = useState(&#x27;DROP ZONE ALPHA&#x27;);
   178‚Üí  const [objectiveTitle, setObjectiveTitle] = useState(&#x27;&#x27;);
   179‚Üí  const [objectiveInstructions, setObjectiveInstructions] = useState(&#x27;&#x27;);
   180‚Üí  const [currentChapter, setCurrentChapter] = useState(2);
   181‚Üí  const [touchInput, setTouchInput] = useState&lt;TouchInput | null&gt;(null);
   182‚Üí  const [notification, setNotification] = useState&lt;{ text: string; id: number } | null&gt;(null);
   183‚Üí  const [damageFlash, setDamageFlash] = useState(false);
   184‚Üí  const [currentComms, setCurrentComms] = useState&lt;CommsMessage | null&gt;(null);
   185‚Üí  const [commsDismissedFlag, setCommsDismissedFlag] = useState(0);
   186‚Üí  const [isCalibrating, setIsCalibrating] = useState(false);
   187‚Üí  const [inCombat, setInCombatState] = useState(false);
   188‚Üí  const [actionGroups, setActionGroups] = useState&lt;ActionButtonGroup[]&gt;([]);
   189‚Üí  const actionHandlerRef = useRef&lt;((actionId: string) =&gt; void) | null&gt;(null);
   190‚Üí  const [hudVisibility, setHUDVisibilityState] = useState&lt;HUDVisibility&gt;(DEFAULT_HUD_VISIBILITY);
   191‚Üí  const [objectiveMarker, setObjectiveMarker] = useState&lt;ObjectiveMarker | null&gt;(null);
   192‚Üí  const [compassData, setCompassData] = useState&lt;CompassData&gt;({ heading: 0 });
   193‚Üí  const [tutorialPhase, setTutorialPhase] = useState&lt;TutorialPhase&gt;(0);
   194‚Üí  const [isTutorialActive, setIsTutorialActive] = useState(false);
   195‚Üí
   196‚Üí  const notificationTimeoutRef = useRef&lt;NodeJS.Timeout | null&gt;(null);
   197‚Üí  const damageTimeoutRef = useRef&lt;NodeJS.Timeout | null&gt;(null);
   198‚Üí  const combatTimeoutRef = useRef&lt;NodeJS.Timeout | null&gt;(null);
   199‚Üí
   200‚Üí  // Clear timeouts on unmount
   201‚Üí  useEffect(() =&gt; {
   202‚Üí    return () =&gt; {
   203‚Üí      if (notificationTimeoutRef.current) clearTimeout(notificationTimeoutRef.current);
   204‚Üí      if (damageTimeoutRef.current) clearTimeout(damageTimeoutRef.current);
   205‚Üí      if (combatTimeoutRef.current) clearTimeout(combatTimeoutRef.current);
   206‚Üí    };
   207‚Üí  }, []);
   208‚Üí
   209‚Üí  // Play music function
   210‚Üí  const playMusic = useCallback((track: MusicTrack) =&gt; {
   211‚Üí    getAudioManager().playMusic(track, 2);
   212‚Üí  }, []);
   213‚Üí
   214‚Üí  // Combat state management with auto-decay
   215‚Üí  const setInCombat = useCallback(
   216‚Üí    (value: boolean) =&gt; {
   217‚Üí      setInCombatState(value);
   218‚Üí
   219‚Üí      if (value) {
   220‚Üí        // Start combat music
   221‚Üí        playMusic(&#x27;combat&#x27;);
   222‚Üí
   223‚Üí        // Clear any existing decay timeout
   224‚Üí        if (combatTimeoutRef.current) clearTimeout(combatTimeoutRef.current);
   225‚Üí
   226‚Üí        // Auto-decay combat after 8 seconds of no activity
   227‚Üí        combatTimeoutRef.current = setTimeout(() =&gt; {
   228‚Üí          setInCombatState(false);
   229‚Üí          // Return to exploration music
   230‚Üí          playMusic(&#x27;exploration&#x27;);
   231‚Üí        }, 8000);
   232‚Üí      }
   233‚Üí    },
   234‚Üí    [playMusic]
   235‚Üí  );
   236‚Üí
   237‚Üí  // Music based on chapter changes
   238‚Üí  useEffect(() =&gt; {
   239‚Üí    // Don&#x27;t override combat music
   240‚Üí    if (inCombat) return;
   241‚Üí
   242‚Üí    switch (currentChapter) {
   243‚Üí      case 1:
   244‚Üí        // Tutorial/Anchor Station - ambient
   245‚Üí        playMusic(&#x27;ambient&#x27;);
   246‚Üí        break;
   247‚Üí      case 2:
   248‚Üí        // Surface - exploration
   249‚Üí        playMusic(&#x27;exploration&#x27;);
   250‚Üí        break;
   251‚Üí      case 5:
   252‚Üí        // Boss fight
   253‚Üí        playMusic(&#x27;boss&#x27;);
   254‚Üí        break;
   255‚Üí      case 6:
   256‚Üí        // Victory/extraction
   257‚Üí        playMusic(&#x27;victory&#x27;);
   258‚Üí        break;
   259‚Üí      default:
   260‚Üí        playMusic(&#x27;exploration&#x27;);
   261‚Üí    }
   262‚Üí  }, [currentChapter, inCombat, playMusic]);
   263‚Üí
   264‚Üí  const addKill = useCallback(() =&gt; {
   265‚Üí    setKills((k) =&gt; k + 1);
   266‚Üí    // Track kill for achievement progress
   267‚Üí    getAchievementManager().onKill();
   268‚Üí  }, []);
   269‚Üí
   270‚Üí  // Clamped health setter that prevents negative health and detects death
   271‚Üí  const setPlayerHealth = useCallback(
   272‚Üí    (health: number) =&gt; {
   273‚Üí      // Don&#x27;t process health changes if player is already dead
   274‚Üí      if (isPlayerDead) return;
   275‚Üí
   276‚Üí      // Clamp health between 0 and maxHealth
   277‚Üí      const clampedHealth = Math.max(0, Math.min(maxHealth, health));
   278‚Üí      setPlayerHealthRaw(clampedHealth);
   279‚Üí
   280‚Üí      // Trigger death if health reaches 0
   281‚Üí      if (clampedHealth &lt;= 0 &amp;&amp; !isPlayerDead) {
   282‚Üí        setIsPlayerDead(true);
   283‚Üí        if (playerDeathCallbackRef.current) {
   284‚Üí          playerDeathCallbackRef.current();
   285‚Üí        }
   286‚Üí      }
   287‚Üí    },
   288‚Üí    [isPlayerDead, maxHealth]
   289‚Üí  );
   290‚Üí
   291‚Üí  // Reset player health and death state (for restart)
   292‚Üí  const resetPlayerHealth = useCallback(() =&gt; {
   293‚Üí    setPlayerHealthRaw(maxHealth);
   294‚Üí    setIsPlayerDead(false);
   295‚Üí  }, [maxHealth]);
   296‚Üí
   297‚Üí  // Set the death callback
   298‚Üí  const setOnPlayerDeath = useCallback((callback: (() =&gt; void) | null) =&gt; {
   299‚Üí    playerDeathCallbackRef.current = callback;
   300‚Üí  }, []);
   301‚Üí
   302‚Üí  const setObjective = useCallback((title: string, instructions: string) =&gt; {
   303‚Üí    setObjectiveTitle(title);
   304‚Üí    setObjectiveInstructions(instructions);
   305‚Üí  }, []);
   306‚Üí
   307‚Üí  const showNotification = useCallback((text: string, duration = 3000) =&gt; {
   308‚Üí    const id = Date.now();
   309‚Üí    setNotification({ text, id });
   310‚Üí
   311‚Üí    if (notificationTimeoutRef.current) clearTimeout(notificationTimeoutRef.current);
   312‚Üí
   313‚Üí    notificationTimeoutRef.current = setTimeout(() =&gt; {
   314‚Üí      setNotification((current) =&gt; (current?.id === id ? null : current));
   315‚Üí    }, duration);
   316‚Üí  }, []);
   317‚Üí
   318‚Üí  const showComms = useCallback((message: CommsMessage) =&gt; {
   319‚Üí    setCurrentComms(message);
   320‚Üí  }, []);
   321‚Üí
   322‚Üí  const hideComms = useCallback(() =&gt; {
   323‚Üí    setCurrentComms(null);
   324‚Üí    setCommsDismissedFlag((prev) =&gt; prev + 1);
   325‚Üí  }, []);
   326‚Üí
   327‚Üí  const onDamage = useCallback(() =&gt; {
   328‚Üí    setDamageFlash(true);
   329‚Üí
   330‚Üí    if (damageTimeoutRef.current) clearTimeout(damageTimeoutRef.current);
   331‚Üí
   332‚Üí    damageTimeoutRef.current = setTimeout(() =&gt; setDamageFlash(false), 300);
   333‚Üí  }, []);
   334‚Üí
   335‚Üí  const triggerAction = useCallback((actionId: string) =&gt; {
   336‚Üí    if (actionHandlerRef.current) {
   337‚Üí      actionHandlerRef.current(actionId);
   338‚Üí    }
   339‚Üí  }, []);
   340‚Üí
   341‚Üí  const setOnActionTriggered = useCallback((handler: ((actionId: string) =&gt; void) | null) =&gt; {
   342‚Üí    actionHandlerRef.current = handler;
   343‚Üí  }, []);
   344‚Üí
   345‚Üí  // HUD visibility management - allows partial updates
   346‚Üí  const setHUDVisibility = useCallback((visibility: Partial&lt;HUDVisibility&gt;) =&gt; {
   347‚Üí    setHUDVisibilityState((prev) =&gt; ({
   348‚Üí      ...prev,
   349‚Üí      ...visibility,
   350‚Üí    }));
   351‚Üí  }, []);
   352‚Üí
   353‚Üí  // Reset HUD to default (all visible) state
   354‚Üí  const resetHUDVisibility = useCallback(() =&gt; {
   355‚Üí    setHUDVisibilityState(DEFAULT_HUD_VISIBILITY);
   356‚Üí  }, []);
   357‚Üí
   358‚Üí  const value: GameContextType = {
   359‚Üí    playerHealth,
   360‚Üí    maxHealth,
   361‚Üí    setPlayerHealth,
   362‚Üí    isPlayerDead,
   363‚Üí    resetPlayerHealth,
   364‚Üí    onPlayerDeath: playerDeathCallbackRef.current,
   365‚Üí    setOnPlayerDeath,
   366‚Üí    kills,
   367‚Üí    addKill,
   368‚Üí    missionText,
   369‚Üí    setMissionText,
   370‚Üí    objectiveTitle,
   371‚Üí    objectiveInstructions,
   372‚Üí    setObjective,
   373‚Üí    currentChapter,
   374‚Üí    setCurrentChapter,
   375‚Üí    touchInput,
   376‚Üí    setTouchInput,
   377‚Üí    showNotification,
   378‚Üí    notification,
   379‚Üí    showComms,
   380‚Üí    hideComms,
   381‚Üí    currentComms,
   382‚Üí    commsDismissedFlag,
   383‚Üí    onDamage,
   384‚Üí    damageFlash,
   385‚Üí    isCalibrating,
   386‚Üí    setIsCalibrating,
   387‚Üí    inCombat,
   388‚Üí    setInCombat,
   389‚Üí    playMusic,
   390‚Üí    actionGroups,
   391‚Üí    setActionGroups,
   392‚Üí    triggerAction,
   393‚Üí    onActionTriggered: actionHandlerRef.current,
   394‚Üí    setOnActionTriggered,
   395‚Üí    hudVisibility,
   396‚Üí    setHUDVisibility,
   397‚Üí    resetHUDVisibility,
   398‚Üí    objectiveMarker,
   399‚Üí    setObjectiveMarker,
   400‚Üí    compassData,
   401‚Üí    setCompassData,
   402‚Üí    tutorialPhase,
   403‚Üí    setTutorialPhase,
   404‚Üí    isTutorialActive,
   405‚Üí    setIsTutorialActive,
   406‚Üí  };
   407‚Üí
   408‚Üí  return &lt;GameContext.Provider value={value}&gt;{children}&lt;/GameContext.Provider&gt;;
   409‚Üí}
   410‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-50-774Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-50-774Z" class="timestamp-link"><time datetime="2026-01-30T06:44:50.774Z" data-timestamp="2026-01-30T06:44:50.774Z">2026-01-30T06:44:50.774Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Y2RUSQbmKMfiGZdxCmRDEZ"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/context/KeybindingsContext.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-50-777Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-50-777Z" class="timestamp-link"><time datetime="2026-01-30T06:44:50.777Z" data-timestamp="2026-01-30T06:44:50.777Z">2026-01-30T06:44:50.777Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport React, {
     2‚Üí  createContext,
     3‚Üí  type ReactNode,
     4‚Üí  useCallback,
     5‚Üí  useContext,
     6‚Üí  useEffect,
     7‚Üí  useState,
     8‚Üí} from &#x27;react&#x27;;
     9‚Üí
    10‚Üí/**
    11‚Üí * Actions that can be bound to keys
    12‚Üí */
    13‚Üíexport type BindableAction =
    14‚Üí  | &#x27;moveForward&#x27;
    15‚Üí  | &#x27;moveBackward&#x27;
    16‚Üí  | &#x27;moveLeft&#x27;
    17‚Üí  | &#x27;moveRight&#x27;
    18‚Üí  | &#x27;jump&#x27;
    19‚Üí  | &#x27;crouch&#x27;
    20‚Üí  | &#x27;sprint&#x27;
    21‚Üí  | &#x27;fire&#x27;
    22‚Üí  | &#x27;reload&#x27;
    23‚Üí  | &#x27;interact&#x27;
    24‚Üí  | &#x27;pause&#x27;;
    25‚Üí
    26‚Üí/**
    27‚Üí * Map of action names to their display labels
    28‚Üí */
    29‚Üíexport const ACTION_LABELS: Record&lt;BindableAction, string&gt; = {
    30‚Üí  moveForward: &#x27;Move Forward&#x27;,
    31‚Üí  moveBackward: &#x27;Move Backward&#x27;,
    32‚Üí  moveLeft: &#x27;Move Left&#x27;,
    33‚Üí  moveRight: &#x27;Move Right&#x27;,
    34‚Üí  jump: &#x27;Jump&#x27;,
    35‚Üí  crouch: &#x27;Crouch&#x27;,
    36‚Üí  sprint: &#x27;Sprint&#x27;,
    37‚Üí  fire: &#x27;Fire&#x27;,
    38‚Üí  reload: &#x27;Reload&#x27;,
    39‚Üí  interact: &#x27;Interact&#x27;,
    40‚Üí  pause: &#x27;Pause&#x27;,
    41‚Üí};
    42‚Üí
    43‚Üí/**
    44‚Üí * Keyboard code to display name mapping
    45‚Üí */
    46‚Üíexport function getKeyDisplayName(code: string): string {
    47‚Üí  // Handle mouse buttons
    48‚Üí  if (code === &#x27;Mouse0&#x27;) return &#x27;Left Click&#x27;;
    49‚Üí  if (code === &#x27;Mouse1&#x27;) return &#x27;Right Click&#x27;;
    50‚Üí  if (code === &#x27;Mouse2&#x27;) return &#x27;Middle Click&#x27;;
    51‚Üí
    52‚Üí  // Handle special keys
    53‚Üí  const specialKeys: Record&lt;string, string&gt; = {
    54‚Üí    Space: &#x27;Space&#x27;,
    55‚Üí    ShiftLeft: &#x27;Left Shift&#x27;,
    56‚Üí    ShiftRight: &#x27;Right Shift&#x27;,
    57‚Üí    ControlLeft: &#x27;Left Ctrl&#x27;,
    58‚Üí    ControlRight: &#x27;Right Ctrl&#x27;,
    59‚Üí    AltLeft: &#x27;Left Alt&#x27;,
    60‚Üí    AltRight: &#x27;Right Alt&#x27;,
    61‚Üí    Tab: &#x27;Tab&#x27;,
    62‚Üí    CapsLock: &#x27;Caps Lock&#x27;,
    63‚Üí    Escape: &#x27;Esc&#x27;,
    64‚Üí    Enter: &#x27;Enter&#x27;,
    65‚Üí    Backspace: &#x27;Backspace&#x27;,
    66‚Üí    ArrowUp: &#x27;Up Arrow&#x27;,
    67‚Üí    ArrowDown: &#x27;Down Arrow&#x27;,
    68‚Üí    ArrowLeft: &#x27;Left Arrow&#x27;,
    69‚Üí    ArrowRight: &#x27;Right Arrow&#x27;,
    70‚Üí  };
    71‚Üí
    72‚Üí  if (specialKeys[code]) {
    73‚Üí    return specialKeys[code];
    74‚Üí  }
    75‚Üí
    76‚Üí  // Handle letter keys (KeyA -&gt; A)
    77‚Üí  if (code.startsWith(&#x27;Key&#x27;)) {
    78‚Üí    return code.slice(3);
    79‚Üí  }
    80‚Üí
    81‚Üí  // Handle digit keys (Digit1 -&gt; 1)
    82‚Üí  if (code.startsWith(&#x27;Digit&#x27;)) {
    83‚Üí    return code.slice(5);
    84‚Üí  }
    85‚Üí
    86‚Üí  // Handle numpad keys
    87‚Üí  if (code.startsWith(&#x27;Numpad&#x27;)) {
    88‚Üí    return `Num ${code.slice(6)}`;
    89‚Üí  }
    90‚Üí
    91‚Üí  // Fallback to the code itself
    92‚Üí  return code;
    93‚Üí}
    94‚Üí
    95‚Üí/**
    96‚Üí * Keybinding value - can be a single key or array of keys
    97‚Üí * Array allows primary key + alternatives (e.g., WASD + Arrow keys)
    98‚Üí */
    99‚Üíexport type KeybindingValue = string | string[];
   100‚Üí
   101‚Üí/**
   102‚Üí * Keybindings map - action to key code(s)
   103‚Üí */
   104‚Üíexport type Keybindings = Record&lt;BindableAction, KeybindingValue&gt;;
   105‚Üí
   106‚Üí/**
   107‚Üí * Helper to normalize keybinding value to array
   108‚Üí */
   109‚Üíexport function getKeysForAction(binding: KeybindingValue): string[] {
   110‚Üí  if (Array.isArray(binding)) {
   111‚Üí    return binding;
   112‚Üí  }
   113‚Üí  return binding ? [binding] : [];
   114‚Üí}
   115‚Üí
   116‚Üí/**
   117‚Üí * Helper to get primary (first) key for an action
   118‚Üí */
   119‚Üíexport function getPrimaryKey(binding: KeybindingValue): string {
   120‚Üí  if (Array.isArray(binding)) {
   121‚Üí    return binding[0] ?? &#x27;&#x27;;
   122‚Üí  }
   123‚Üí  return binding ?? &#x27;&#x27;;
   124‚Üí}
   125‚Üí
   126‚Üí/**
   127‚Üí * Default keybindings with WASD + Arrow key alternatives for movement
   128‚Üí */
   129‚Üíexport const DEFAULT_KEYBINDINGS: Keybindings = {
   130‚Üí  moveForward: [&#x27;KeyW&#x27;, &#x27;ArrowUp&#x27;],
   131‚Üí  moveBackward: [&#x27;KeyS&#x27;, &#x27;ArrowDown&#x27;],
   132‚Üí  moveLeft: [&#x27;KeyA&#x27;, &#x27;ArrowLeft&#x27;],
   133‚Üí  moveRight: [&#x27;KeyD&#x27;, &#x27;ArrowRight&#x27;],
   134‚Üí  jump: &#x27;Space&#x27;,
   135‚Üí  crouch: [&#x27;ControlLeft&#x27;, &#x27;KeyC&#x27;],
   136‚Üí  sprint: &#x27;ShiftLeft&#x27;,
   137‚Üí  fire: &#x27;Mouse0&#x27;,
   138‚Üí  reload: &#x27;KeyR&#x27;,
   139‚Üí  interact: &#x27;KeyE&#x27;,
   140‚Üí  pause: &#x27;Escape&#x27;,
   141‚Üí};
   142‚Üí
   143‚Üíconst STORAGE_KEY = &#x27;stellar-descent-keybindings&#x27;;
   144‚Üí
   145‚Üí/**
   146‚Üí * Load keybindings from localStorage
   147‚Üí */
   148‚Üífunction loadKeybindings(): Keybindings {
   149‚Üí  try {
   150‚Üí    const stored = localStorage.getItem(STORAGE_KEY);
   151‚Üí    if (stored) {
   152‚Üí      const parsed = JSON.parse(stored);
   153‚Üí      // Merge with defaults to handle new actions
   154‚Üí      return { ...DEFAULT_KEYBINDINGS, ...parsed };
   155‚Üí    }
   156‚Üí  } catch (e) {
   157‚Üí    console.warn(&#x27;Failed to load keybindings from localStorage:&#x27;, e);
   158‚Üí  }
   159‚Üí  return { ...DEFAULT_KEYBINDINGS };
   160‚Üí}
   161‚Üí
   162‚Üí/**
   163‚Üí * Save keybindings to localStorage
   164‚Üí */
   165‚Üífunction saveKeybindings(bindings: Keybindings): void {
   166‚Üí  try {
   167‚Üí    localStorage.setItem(STORAGE_KEY, JSON.stringify(bindings));
   168‚Üí  } catch (e) {
   169‚Üí    console.warn(&#x27;Failed to save keybindings to localStorage:&#x27;, e);
   170‚Üí  }
   171‚Üí}
   172‚Üí
   173‚Üíinterface KeybindingsContextType {
   174‚Üí  /** Current keybindings */
   175‚Üí  keybindings: Keybindings;
   176‚Üí
   177‚Üí  /** Check if a key code is bound to an action (checks all keys for that action) */
   178‚Üí  isKeyBound: (code: string, action: BindableAction) =&gt; boolean;
   179‚Üí
   180‚Üí  /** Get the primary key code for an action (for display purposes) */
   181‚Üí  getKeyForAction: (action: BindableAction) =&gt; string;
   182‚Üí
   183‚Üí  /** Get all key codes for an action */
   184‚Üí  getAllKeysForAction: (action: BindableAction) =&gt; string[];
   185‚Üí
   186‚Üí  /** Update a keybinding (replaces all keys for that action with single key) */
   187‚Üí  setKeybinding: (action: BindableAction, code: string) =&gt; void;
   188‚Üí
   189‚Üí  /** Add an alternative key for an action */
   190‚Üí  addAlternativeKey: (action: BindableAction, code: string) =&gt; void;
   191‚Üí
   192‚Üí  /** Reset all keybindings to defaults */
   193‚Üí  resetToDefaults: () =&gt; void;
   194‚Üí
   195‚Üí  /** Check if current bindings differ from defaults */
   196‚Üí  hasCustomBindings: boolean;
   197‚Üí}
   198‚Üí
   199‚Üíconst KeybindingsContext = createContext&lt;KeybindingsContextType | null&gt;(null);
   200‚Üí
   201‚Üí/**
   202‚Üí * Hook to access keybindings context
   203‚Üí */
   204‚Üíexport function useKeybindings() {
   205‚Üí  const context = useContext(KeybindingsContext);
   206‚Üí  if (!context) {
   207‚Üí    throw new Error(&#x27;useKeybindings must be used within a KeybindingsProvider&#x27;);
   208‚Üí  }
   209‚Üí  return context;
   210‚Üí}
   211‚Üí
   212‚Üíinterface KeybindingsProviderProps {
   213‚Üí  children: ReactNode;
   214‚Üí}
   215‚Üí
   216‚Üíexport function KeybindingsProvider({ children }: KeybindingsProviderProps) {
   217‚Üí  const [keybindings, setKeybindings] = useState&lt;Keybindings&gt;(loadKeybindings);
   218‚Üí
   219‚Üí  // Save to localStorage whenever bindings change
   220‚Üí  useEffect(() =&gt; {
   221‚Üí    saveKeybindings(keybindings);
   222‚Üí  }, [keybindings]);
   223‚Üí
   224‚Üí  const isKeyBound = useCallback(
   225‚Üí    (code: string, action: BindableAction): boolean =&gt; {
   226‚Üí      const binding = keybindings[action];
   227‚Üí      const keys = getKeysForAction(binding);
   228‚Üí      return keys.includes(code);
   229‚Üí    },
   230‚Üí    [keybindings]
   231‚Üí  );
   232‚Üí
   233‚Üí  const getKeyForAction = useCallback(
   234‚Üí    (action: BindableAction): string =&gt; {
   235‚Üí      return getPrimaryKey(keybindings[action]);
   236‚Üí    },
   237‚Üí    [keybindings]
   238‚Üí  );
   239‚Üí
   240‚Üí  const getAllKeysForAction = useCallback(
   241‚Üí    (action: BindableAction): string[] =&gt; {
   242‚Üí      return getKeysForAction(keybindings[action]);
   243‚Üí    },
   244‚Üí    [keybindings]
   245‚Üí  );
   246‚Üí
   247‚Üí  const setKeybinding = useCallback((action: BindableAction, code: string) =&gt; {
   248‚Üí    setKeybindings((prev) =&gt; {
   249‚Üí      // Remove the key from any other action it might be bound to
   250‚Üí      const newBindings = { ...prev };
   251‚Üí      for (const [otherAction, boundKeys] of Object.entries(newBindings)) {
   252‚Üí        if (otherAction !== action) {
   253‚Üí          const keys = getKeysForAction(boundKeys);
   254‚Üí          const filteredKeys = keys.filter((k) =&gt; k !== code);
   255‚Üí          if (filteredKeys.length !== keys.length) {
   256‚Üí            // Key was found and removed
   257‚Üí            newBindings[otherAction as BindableAction] =
   258‚Üí              filteredKeys.length === 1 ? filteredKeys[0] : filteredKeys;
   259‚Üí          }
   260‚Üí        }
   261‚Üí      }
   262‚Üí      newBindings[action] = code;
   263‚Üí      return newBindings;
   264‚Üí    });
   265‚Üí  }, []);
   266‚Üí
   267‚Üí  const addAlternativeKey = useCallback((action: BindableAction, code: string) =&gt; {
   268‚Üí    setKeybindings((prev) =&gt; {
   269‚Üí      // Remove the key from any other action
   270‚Üí      const newBindings = { ...prev };
   271‚Üí      for (const [otherAction, boundKeys] of Object.entries(newBindings)) {
   272‚Üí        if (otherAction !== action) {
   273‚Üí          const keys = getKeysForAction(boundKeys);
   274‚Üí          const filteredKeys = keys.filter((k) =&gt; k !== code);
   275‚Üí          if (filteredKeys.length !== keys.length) {
   276‚Üí            newBindings[otherAction as BindableAction] =
   277‚Üí              filteredKeys.length === 1 ? filteredKeys[0] : filteredKeys;
   278‚Üí          }
   279‚Üí        }
   280‚Üí      }
   281‚Üí      // Add to current action&#x27;s keys
   282‚Üí      const currentKeys = getKeysForAction(newBindings[action]);
   283‚Üí      if (!currentKeys.includes(code)) {
   284‚Üí        newBindings[action] = [...currentKeys, code];
   285‚Üí      }
   286‚Üí      return newBindings;
   287‚Üí    });
   288‚Üí  }, []);
   289‚Üí
   290‚Üí  const resetToDefaults = useCallback(() =&gt; {
   291‚Üí    setKeybindings({ ...DEFAULT_KEYBINDINGS });
   292‚Üí  }, []);
   293‚Üí
   294‚Üí  const hasCustomBindings = JSON.stringify(keybindings) !== JSON.stringify(DEFAULT_KEYBINDINGS);
   295‚Üí
   296‚Üí  const value: KeybindingsContextType = {
   297‚Üí    keybindings,
   298‚Üí    isKeyBound,
   299‚Üí    getKeyForAction,
   300‚Üí    getAllKeysForAction,
   301‚Üí    setKeybinding,
   302‚Üí    addAlternativeKey,
   303‚Üí    resetToDefaults,
   304‚Üí    hasCustomBindings,
   305‚Üí  };
   306‚Üí
   307‚Üí  return &lt;KeybindingsContext.Provider value={value}&gt;{children}&lt;/KeybindingsContext.Provider&gt;;
   308‚Üí}
   309‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-51-285Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-51-285Z" class="timestamp-link"><time datetime="2026-01-30T06:44:51.285Z" data-timestamp="2026-01-30T06:44:51.285Z">2026-01-30T06:44:51.285Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_0118VJSKY9UnoenF3i19ppoL"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/SettingsMenu.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-44-51-288Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-44-51-288Z" class="timestamp-link"><time datetime="2026-01-30T06:44:51.288Z" data-timestamp="2026-01-30T06:44:51.288Z">2026-01-30T06:44:51.288Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport React, { useCallback, useEffect, useState } from &#x27;react&#x27;;
     2‚Üíimport {
     3‚Üí  ACTION_LABELS,
     4‚Üí  type BindableAction,
     5‚Üí  DEFAULT_KEYBINDINGS,
     6‚Üí  getKeyDisplayName,
     7‚Üí  getPrimaryKey,
     8‚Üí  useKeybindings,
     9‚Üí} from &#x27;../../game/context/KeybindingsContext&#x27;;
    10‚Üíimport { getAudioManager } from &#x27;../../game/core/AudioManager&#x27;;
    11‚Üíimport styles from &#x27;./SettingsMenu.module.css&#x27;;
    12‚Üí
    13‚Üí/**
    14‚Üí * Local state for keybindings uses single keys per action.
    15‚Üí * The full Keybindings type supports arrays, but the settings UI
    16‚Üí * only allows configuring the primary key for simplicity.
    17‚Üí */
    18‚Üítype SingleKeyBindings = Record&lt;BindableAction, string&gt;;
    19‚Üí
    20‚Üíinterface SettingsMenuProps {
    21‚Üí  isOpen: boolean;
    22‚Üí  onClose: () =&gt; void;
    23‚Üí}
    24‚Üí
    25‚Üí/** Actions to display in the movement category */
    26‚Üíconst MOVEMENT_ACTIONS: BindableAction[] = [
    27‚Üí  &#x27;moveForward&#x27;,
    28‚Üí  &#x27;moveBackward&#x27;,
    29‚Üí  &#x27;moveLeft&#x27;,
    30‚Üí  &#x27;moveRight&#x27;,
    31‚Üí  &#x27;jump&#x27;,
    32‚Üí  &#x27;crouch&#x27;,
    33‚Üí  &#x27;sprint&#x27;,
    34‚Üí];
    35‚Üí
    36‚Üí/** Actions to display in the combat category */
    37‚Üíconst COMBAT_ACTIONS: BindableAction[] = [&#x27;fire&#x27;, &#x27;reload&#x27;];
    38‚Üí
    39‚Üí/** Actions to display in the misc category */
    40‚Üíconst MISC_ACTIONS: BindableAction[] = [&#x27;interact&#x27;, &#x27;pause&#x27;];
    41‚Üí
    42‚Üíexport function SettingsMenu({ isOpen, onClose }: SettingsMenuProps) {
    43‚Üí  const { keybindings, setKeybinding, resetToDefaults, hasCustomBindings } = useKeybindings();
    44‚Üí
    45‚Üí  // Track which action is currently being rebound
    46‚Üí  const [listeningFor, setListeningFor] = useState&lt;BindableAction | null&gt;(null);
    47‚Üí
    48‚Üí  /**
    49‚Üí   * Convert keybindings to single-key format for the settings UI.
    50‚Üí   * Only the primary key is shown/editable; alternatives like arrow keys
    51‚Üí   * are preserved as defaults but not customizable through this UI.
    52‚Üí   */
    53‚Üí  const keybindingsToSingleKey = useCallback((): SingleKeyBindings =&gt; {
    54‚Üí    const result = {} as SingleKeyBindings;
    55‚Üí    for (const action of Object.keys(keybindings) as BindableAction[]) {
    56‚Üí      result[action] = getPrimaryKey(keybindings[action]);
    57‚Üí    }
    58‚Üí    return result;
    59‚Üí  }, [keybindings]);
    60‚Üí
    61‚Üí  // Track pending changes before save (single key per action)
    62‚Üí  const [pendingBindings, setPendingBindings] = useState&lt;SingleKeyBindings&gt;(keybindingsToSingleKey);
    63‚Üí
    64‚Üí  // Reset pending bindings when menu opens
    65‚Üí  useEffect(() =&gt; {
    66‚Üí    if (isOpen) {
    67‚Üí      setPendingBindings(keybindingsToSingleKey());
    68‚Üí    }
    69‚Üí  }, [isOpen, keybindingsToSingleKey]);
    70‚Üí
    71‚Üí  const playClickSound = useCallback(() =&gt; {
    72‚Üí    getAudioManager().play(&#x27;ui_click&#x27;, { volume: 0.3 });
    73‚Üí  }, []);
    74‚Üí
    75‚Üí  const handleKeyButtonClick = useCallback(
    76‚Üí    (action: BindableAction) =&gt; {
    77‚Üí      playClickSound();
    78‚Üí      setListeningFor(action);
    79‚Üí    },
    80‚Üí    [playClickSound]
    81‚Üí  );
    82‚Üí
    83‚Üí  const handleCancelListening = useCallback(() =&gt; {
    84‚Üí    playClickSound();
    85‚Üí    setListeningFor(null);
    86‚Üí  }, [playClickSound]);
    87‚Üí
    88‚Üí  // Listen for key/mouse input when rebinding
    89‚Üí  useEffect(() =&gt; {
    90‚Üí    if (!listeningFor) return;
    91‚Üí
    92‚Üí    const handleKeyDown = (e: KeyboardEvent) =&gt; {
    93‚Üí      e.preventDefault();
    94‚Üí      e.stopPropagation();
    95‚Üí
    96‚Üí      // Allow Escape to cancel
    97‚Üí      if (e.code === &#x27;Escape&#x27;) {
    98‚Üí        setListeningFor(null);
    99‚Üí        return;
   100‚Üí      }
   101‚Üí
   102‚Üí      // Set the new binding
   103‚Üí      setPendingBindings((prev) =&gt; {
   104‚Üí        const newBindings = { ...prev };
   105‚Üí        // Remove from any other action
   106‚Üí        for (const action of Object.keys(newBindings) as BindableAction[]) {
   107‚Üí          if (newBindings[action] === e.code) {
   108‚Üí            newBindings[action] = &#x27;&#x27;;
   109‚Üí          }
   110‚Üí        }
   111‚Üí        newBindings[listeningFor] = e.code;
   112‚Üí        return newBindings;
   113‚Üí      });
   114‚Üí
   115‚Üí      playClickSound();
   116‚Üí      setListeningFor(null);
   117‚Üí    };
   118‚Üí
   119‚Üí    const handleMouseDown = (e: MouseEvent) =&gt; {
   120‚Üí      e.preventDefault();
   121‚Üí      e.stopPropagation();
   122‚Üí
   123‚Üí      const mouseCode = `Mouse${e.button}`;
   124‚Üí
   125‚Üí      setPendingBindings((prev) =&gt; {
   126‚Üí        const newBindings = { ...prev };
   127‚Üí        // Remove from any other action
   128‚Üí        for (const action of Object.keys(newBindings) as BindableAction[]) {
   129‚Üí          if (newBindings[action] === mouseCode) {
   130‚Üí            newBindings[action] = &#x27;&#x27;;
   131‚Üí          }
   132‚Üí        }
   133‚Üí        newBindings[listeningFor] = mouseCode;
   134‚Üí        return newBindings;
   135‚Üí      });
   136‚Üí
   137‚Üí      playClickSound();
   138‚Üí      setListeningFor(null);
   139‚Üí    };
   140‚Üí
   141‚Üí    window.addEventListener(&#x27;keydown&#x27;, handleKeyDown, true);
   142‚Üí    window.addEventListener(&#x27;mousedown&#x27;, handleMouseDown, true);
   143‚Üí
   144‚Üí    return () =&gt; {
   145‚Üí      window.removeEventListener(&#x27;keydown&#x27;, handleKeyDown, true);
   146‚Üí      window.removeEventListener(&#x27;mousedown&#x27;, handleMouseDown, true);
   147‚Üí    };
   148‚Üí  }, [listeningFor, playClickSound]);
   149‚Üí
   150‚Üí  const handleSave = useCallback(() =&gt; {
   151‚Üí    playClickSound();
   152‚Üí    // Apply all pending bindings
   153‚Üí    for (const [action, code] of Object.entries(pendingBindings)) {
   154‚Üí      setKeybinding(action as BindableAction, code);
   155‚Üí    }
   156‚Üí    onClose();
   157‚Üí  }, [pendingBindings, setKeybinding, onClose, playClickSound]);
   158‚Üí
   159‚Üí  const handleCancel = useCallback(() =&gt; {
   160‚Üí    playClickSound();
   161‚Üí    // Discard pending changes
   162‚Üí    setPendingBindings(keybindingsToSingleKey());
   163‚Üí    onClose();
   164‚Üí  }, [keybindingsToSingleKey, onClose, playClickSound]);
   165‚Üí
   166‚Üí  const handleResetDefaults = useCallback(() =&gt; {
   167‚Üí    playClickSound();
   168‚Üí    // Convert default keybindings to single-key format
   169‚Üí    const defaultSingleKey = {} as SingleKeyBindings;
   170‚Üí    for (const action of Object.keys(DEFAULT_KEYBINDINGS) as BindableAction[]) {
   171‚Üí      defaultSingleKey[action] = getPrimaryKey(DEFAULT_KEYBINDINGS[action]);
   172‚Üí    }
   173‚Üí    setPendingBindings(defaultSingleKey);
   174‚Üí  }, [playClickSound]);
   175‚Üí
   176‚Üí  // Check if pending bindings differ from saved
   177‚Üí  const hasUnsavedChanges =
   178‚Üí    JSON.stringify(pendingBindings) !== JSON.stringify(keybindingsToSingleKey());
   179‚Üí
   180‚Üí  if (!isOpen) return null;
   181‚Üí
   182‚Üí  const renderKeybindingRow = (action: BindableAction) =&gt; {
   183‚Üí    const currentKey = pendingBindings[action];
   184‚Üí    const isUnbound = !currentKey;
   185‚Üí    const isListening = listeningFor === action;
   186‚Üí
   187‚Üí    return (
   188‚Üí      &lt;div key={action} className={styles.keybindingRow}&gt;
   189‚Üí        &lt;span className={styles.actionLabel}&gt;{ACTION_LABELS[action]}&lt;/span&gt;
   190‚Üí        &lt;button
   191‚Üí          type=&quot;button&quot;
   192‚Üí          className={`${styles.keyButton} ${isListening ? styles.listening : &#x27;&#x27;} ${isUnbound ? styles.unbound : &#x27;&#x27;}`}
   193‚Üí          onClick={() =&gt; handleKeyButtonClick(action)}
   194‚Üí          aria-label={`Rebind ${ACTION_LABELS[action]}`}
   195‚Üí        &gt;
   196‚Üí          {isListening ? &#x27;PRESS KEY...&#x27; : isUnbound ? &#x27;UNBOUND&#x27; : getKeyDisplayName(currentKey)}
   197‚Üí        &lt;/button&gt;
   198‚Üí      &lt;/div&gt;
   199‚Üí    );
   200‚Üí  };
   201‚Üí
   202‚Üí  return (
   203‚Üí    &lt;&gt;
   204‚Üí      {/* Main settings panel */}
   205‚Üí      &lt;div
   206‚Üí        className={styles.overlay}
   207‚Üí        onClick={handleCancel}
   208‚Üí        onKeyDown={(e) =&gt; e.key === &#x27;Escape&#x27; &amp;&amp; !listeningFor &amp;&amp; handleCancel()}
   209‚Üí        role=&quot;presentation&quot;
   210‚Üí      &gt;
   211‚Üí        &lt;div
   212‚Üí          className={styles.container}
   213‚Üí          onClick={(e) =&gt; e.stopPropagation()}
   214‚Üí          onKeyDown={(e) =&gt; e.stopPropagation()}
   215‚Üí          role=&quot;dialog&quot;
   216‚Üí          aria-modal=&quot;true&quot;
   217‚Üí          aria-labelledby=&quot;settings-title&quot;
   218‚Üí        &gt;
   219‚Üí          {/* Corner decorations */}
   220‚Üí          &lt;div className={styles.cornerTL} /&gt;
   221‚Üí          &lt;div className={styles.cornerTR} /&gt;
   222‚Üí          &lt;div className={styles.cornerBL} /&gt;
   223‚Üí          &lt;div className={styles.cornerBR} /&gt;
   224‚Üí
   225‚Üí          {/* Header */}
   226‚Üí          &lt;div className={styles.header}&gt;
   227‚Üí            &lt;h2 id=&quot;settings-title&quot; className={styles.title}&gt;
   228‚Üí              SETTINGS
   229‚Üí            &lt;/h2&gt;
   230‚Üí            &lt;button
   231‚Üí              type=&quot;button&quot;
   232‚Üí              className={styles.closeButton}
   233‚Üí              onClick={handleCancel}
   234‚Üí              aria-label=&quot;Close settings&quot;
   235‚Üí            &gt;
   236‚Üí              X
   237‚Üí            &lt;/button&gt;
   238‚Üí          &lt;/div&gt;
   239‚Üí
   240‚Üí          {/* Content */}
   241‚Üí          &lt;div className={styles.content}&gt;
   242‚Üí            {/* Movement controls */}
   243‚Üí            &lt;div className={styles.section}&gt;
   244‚Üí              &lt;h3 className={styles.sectionTitle}&gt;Movement&lt;/h3&gt;
   245‚Üí              &lt;div className={styles.keybindingList}&gt;
   246‚Üí                {MOVEMENT_ACTIONS.map(renderKeybindingRow)}
   247‚Üí              &lt;/div&gt;
   248‚Üí            &lt;/div&gt;
   249‚Üí
   250‚Üí            {/* Combat controls */}
   251‚Üí            &lt;div className={styles.section}&gt;
   252‚Üí              &lt;h3 className={styles.sectionTitle}&gt;Combat&lt;/h3&gt;
   253‚Üí              &lt;div className={styles.keybindingList}&gt;{COMBAT_ACTIONS.map(renderKeybindingRow)}&lt;/div&gt;
   254‚Üí            &lt;/div&gt;
   255‚Üí
   256‚Üí            {/* Miscellaneous */}
   257‚Üí            &lt;div className={styles.section}&gt;
   258‚Üí              &lt;h3 className={styles.sectionTitle}&gt;General&lt;/h3&gt;
   259‚Üí              &lt;div className={styles.keybindingList}&gt;{MISC_ACTIONS.map(renderKeybindingRow)}&lt;/div&gt;
   260‚Üí            &lt;/div&gt;
   261‚Üí
   262‚Üí            {/* Note */}
   263‚Üí            &lt;div className={styles.note}&gt;
   264‚Üí              &lt;p className={styles.noteText}&gt;
   265‚Üí                Click a binding and press any key or mouse button to rebind. Press ESC to cancel.
   266‚Üí                Mouse look is controlled by mouse movement when pointer is locked.
   267‚Üí              &lt;/p&gt;
   268‚Üí            &lt;/div&gt;
   269‚Üí          &lt;/div&gt;
   270‚Üí
   271‚Üí          {/* Footer */}
   272‚Üí          &lt;div className={styles.footer}&gt;
   273‚Üí            &lt;button
   274‚Üí              type=&quot;button&quot;
   275‚Üí              className={`${styles.button} ${styles.danger}`}
   276‚Üí              onClick={handleResetDefaults}
   277‚Üí              disabled={(() =&gt; {
   278‚Üí                const defaultSingleKey = {} as SingleKeyBindings;
   279‚Üí                for (const action of Object.keys(DEFAULT_KEYBINDINGS) as BindableAction[]) {
   280‚Üí                  defaultSingleKey[action] = getPrimaryKey(DEFAULT_KEYBINDINGS[action]);
   281‚Üí                }
   282‚Üí                return JSON.stringify(pendingBindings) === JSON.stringify(defaultSingleKey);
   283‚Üí              })()}
   284‚Üí            &gt;
   285‚Üí              Reset Defaults
   286‚Üí            &lt;/button&gt;
   287‚Üí            &lt;button type=&quot;button&quot; className={styles.button} onClick={handleCancel}&gt;
   288‚Üí              Cancel
   289‚Üí            &lt;/button&gt;
   290‚Üí            &lt;button
   291‚Üí              type=&quot;button&quot;
   292‚Üí              className={`${styles.button} ${styles.primary}`}
   293‚Üí              onClick={handleSave}
   294‚Üí            &gt;
   295‚Üí              {hasUnsavedChanges ? &#x27;Save Changes&#x27; : &#x27;Done&#x27;}
   296‚Üí            &lt;/button&gt;
   297‚Üí          &lt;/div&gt;
   298‚Üí        &lt;/div&gt;
   299‚Üí      &lt;/div&gt;
   300‚Üí
   301‚Üí      {/* Listening overlay */}
   302‚Üí      {listeningFor &amp;&amp; (
   303‚Üí        &lt;div
   304‚Üí          className={styles.listeningOverlay}
   305‚Üí          onClick={handleCancelListening}
   306‚Üí          role=&quot;presentation&quot;
   307‚Üí        &gt;
   308‚Üí          &lt;div className={styles.listeningModal}&gt;
   309‚Üí            &lt;p className={styles.listeningText}&gt;PRESS A KEY OR MOUSE BUTTON&lt;/p&gt;
   310‚Üí            &lt;p className={styles.listeningHint}&gt;
   311‚Üí              Binding: {ACTION_LABELS[listeningFor]} | Press ESC to cancel
   312‚Üí            &lt;/p&gt;
   313‚Üí          &lt;/div&gt;
   314‚Üí        &lt;/div&gt;
   315‚Üí      )}
   316‚Üí    &lt;/&gt;
   317‚Üí  );
   318‚Üí}
   319‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-58-640Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-58-640Z" class="timestamp-link"><time datetime="2026-01-30T06:44:58.640Z" data-timestamp="2026-01-30T06:44:58.640Z">2026-01-30T06:44:58.640Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>This is a comprehensive codebase. Let me continue exploring to find gaps and then update the memory bank. I should look at more UI components and check for incomplete implementations.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-44-58-847Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-44-58-847Z" class="timestamp-link"><time datetime="2026-01-30T06:44:58.847Z" data-timestamp="2026-01-30T06:44:58.847Z">2026-01-30T06:44:58.847Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Let me continue exploring to find any gaps in the implementations.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-45-00-294Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-45-00-294Z" class="timestamp-link"><time datetime="2026-01-30T06:45:00.294Z" data-timestamp="2026-01-30T06:45:00.294Z">2026-01-30T06:45:00.294Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Q5CUJPSF1FLJsgBW3AHbba"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/LandscapeEnforcer.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-45-00-298Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-45-00-298Z" class="timestamp-link"><time datetime="2026-01-30T06:45:00.298Z" data-timestamp="2026-01-30T06:45:00.298Z">2026-01-30T06:45:00.298Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport React, { useCallback, useEffect, useState } from &#x27;react&#x27;;
     2‚Üíimport { getScreenInfo, shouldEnforceLandscape } from &#x27;../../game/utils/responsive&#x27;;
     3‚Üíimport styles from &#x27;./LandscapeEnforcer.module.css&#x27;;
     4‚Üí
     5‚Üí/**
     6‚Üí * SVG icon of a phone rotating from portrait to landscape
     7‚Üí */
     8‚Üífunction RotatePhoneIcon() {
     9‚Üí  return (
    10‚Üí    &lt;svg
    11‚Üí      className={styles.phoneIcon}
    12‚Üí      viewBox=&quot;0 0 100 100&quot;
    13‚Üí      fill=&quot;none&quot;
    14‚Üí      xmlns=&quot;http://www.w3.org/2000/svg&quot;
    15‚Üí      aria-hidden=&quot;true&quot;
    16‚Üí    &gt;
    17‚Üí      {/* Phone body */}
    18‚Üí      &lt;rect
    19‚Üí        x=&quot;30&quot;
    20‚Üí        y=&quot;15&quot;
    21‚Üí        width=&quot;40&quot;
    22‚Üí        height=&quot;70&quot;
    23‚Üí        rx=&quot;4&quot;
    24‚Üí        stroke=&quot;#b5a642&quot;
    25‚Üí        strokeWidth=&quot;2&quot;
    26‚Üí        fill=&quot;rgba(74, 93, 35, 0.2)&quot;
    27‚Üí      /&gt;
    28‚Üí      {/* Screen */}
    29‚Üí      &lt;rect x=&quot;34&quot; y=&quot;22&quot; width=&quot;32&quot; height=&quot;52&quot; rx=&quot;1&quot; fill=&quot;rgba(181, 166, 66, 0.15)&quot; /&gt;
    30‚Üí      {/* Home button/notch indicator */}
    31‚Üí      &lt;circle cx=&quot;50&quot; cy=&quot;80&quot; r=&quot;3&quot; fill=&quot;#4a5d23&quot; /&gt;
    32‚Üí      {/* Rotation arrow */}
    33‚Üí      &lt;path
    34‚Üí        d=&quot;M75 50 C85 50 90 45 90 35 L90 30 M90 35 L85 40 M90 35 L95 40&quot;
    35‚Üí        stroke=&quot;#5c7a2e&quot;
    36‚Üí        strokeWidth=&quot;2&quot;
    37‚Üí        strokeLinecap=&quot;round&quot;
    38‚Üí        strokeLinejoin=&quot;round&quot;
    39‚Üí        fill=&quot;none&quot;
    40‚Üí      /&gt;
    41‚Üí    &lt;/svg&gt;
    42‚Üí  );
    43‚Üí}
    44‚Üí
    45‚Üíinterface LandscapeEnforcerProps {
    46‚Üí  /** Custom title text */
    47‚Üí  title?: string;
    48‚Üí  /** Custom message text */
    49‚Üí  message?: string;
    50‚Üí}
    51‚Üí
    52‚Üí/**
    53‚Üí * LandscapeEnforcer component
    54‚Üí *
    55‚Üí * Displays a fullscreen overlay on mobile devices when in portrait orientation,
    56‚Üí * prompting the user to rotate their device to landscape mode.
    57‚Üí *
    58‚Üí * This component only enforces landscape on phones (&lt; 768px).
    59‚Üí * Tablets, foldables, and desktops are allowed to use any orientation.
    60‚Üí */
    61‚Üíexport function LandscapeEnforcer({
    62‚Üí  title = &#x27;ROTATE DEVICE&#x27;,
    63‚Üí  message = &#x27;This experience requires landscape orientation for optimal gameplay.&#x27;,
    64‚Üí}: LandscapeEnforcerProps) {
    65‚Üí  const [shouldShow, setShouldShow] = useState(false);
    66‚Üí  const [isVisible, setIsVisible] = useState(false);
    67‚Üí
    68‚Üí  const checkOrientation = useCallback(() =&gt; {
    69‚Üí    const needsLandscape = shouldEnforceLandscape();
    70‚Üí    setShouldShow(needsLandscape);
    71‚Üí
    72‚Üí    // Slight delay for smooth transition
    73‚Üí    if (needsLandscape) {
    74‚Üí      setIsVisible(true);
    75‚Üí    } else {
    76‚Üí      // Allow fade-out animation before hiding
    77‚Üí      setTimeout(() =&gt; setIsVisible(false), 300);
    78‚Üí    }
    79‚Üí  }, []);
    80‚Üí
    81‚Üí  useEffect(() =&gt; {
    82‚Üí    // Initial check
    83‚Üí    checkOrientation();
    84‚Üí
    85‚Üí    // Listen for orientation changes
    86‚Üí    window.addEventListener(&#x27;resize&#x27;, checkOrientation);
    87‚Üí    window.addEventListener(&#x27;orientationchange&#x27;, checkOrientation);
    88‚Üí
    89‚Üí    // Also check on screen.orientation API if available
    90‚Üí    if (screen.orientation) {
    91‚Üí      screen.orientation.addEventListener(&#x27;change&#x27;, checkOrientation);
    92‚Üí    }
    93‚Üí
    94‚Üí    return () =&gt; {
    95‚Üí      window.removeEventListener(&#x27;resize&#x27;, checkOrientation);
    96‚Üí      window.removeEventListener(&#x27;orientationchange&#x27;, checkOrientation);
    97‚Üí      if (screen.orientation) {
    98‚Üí        screen.orientation.removeEventListener(&#x27;change&#x27;, checkOrientation);
    99‚Üí      }
   100‚Üí    };
   101‚Üí  }, [checkOrientation]);
   102‚Üí
   103‚Üí  // Don&#x27;t render anything if not needed
   104‚Üí  if (!isVisible) {
   105‚Üí    return null;
   106‚Üí  }
   107‚Üí
   108‚Üí  const screenInfo = getScreenInfo();
   109‚Üí
   110‚Üí  return (
   111‚Üí    &lt;div
   112‚Üí      className={`${styles.overlay} ${!shouldShow ? styles.overlayHidden : &#x27;&#x27;}`}
   113‚Üí      role=&quot;alertdialog&quot;
   114‚Üí      aria-modal=&quot;true&quot;
   115‚Üí      aria-labelledby=&quot;landscape-enforcer-title&quot;
   116‚Üí      aria-describedby=&quot;landscape-enforcer-message&quot;
   117‚Üí    &gt;
   118‚Üí      {/* Decorative elements */}
   119‚Üí      &lt;div className={styles.scanline} /&gt;
   120‚Üí      &lt;div className={styles.border} /&gt;
   121‚Üí      &lt;div className={styles.cornerTL} /&gt;
   122‚Üí      &lt;div className={styles.cornerTR} /&gt;
   123‚Üí      &lt;div className={styles.cornerBL} /&gt;
   124‚Üí      &lt;div className={styles.cornerBR} /&gt;
   125‚Üí
   126‚Üí      &lt;div className={styles.content}&gt;
   127‚Üí        &lt;div className={styles.iconContainer}&gt;
   128‚Üí          &lt;div className={styles.iconGlow} /&gt;
   129‚Üí          &lt;RotatePhoneIcon /&gt;
   130‚Üí        &lt;/div&gt;
   131‚Üí
   132‚Üí        &lt;h2 id=&quot;landscape-enforcer-title&quot; className={styles.title}&gt;
   133‚Üí          {title}
   134‚Üí        &lt;/h2&gt;
   135‚Üí
   136‚Üí        &lt;p id=&quot;landscape-enforcer-message&quot; className={styles.message}&gt;
   137‚Üí          {message}
   138‚Üí          &lt;br /&gt;
   139‚Üí          &lt;span className={styles.highlight}&gt;Rotate your device to continue.&lt;/span&gt;
   140‚Üí        &lt;/p&gt;
   141‚Üí      &lt;/div&gt;
   142‚Üí    &lt;/div&gt;
   143‚Üí  );
   144‚Üí}
   145‚Üí
   146‚Üíexport default LandscapeEnforcer;
   147‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-45-01-101Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-45-01-101Z" class="timestamp-link"><time datetime="2026-01-30T06:45:01.101Z" data-timestamp="2026-01-30T06:45:01.101Z">2026-01-30T06:45:01.101Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01AkX4Gawu5XN7CbyHonR1Mq"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/DeathScreen.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-45-01-104Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-45-01-104Z" class="timestamp-link"><time datetime="2026-01-30T06:45:01.104Z" data-timestamp="2026-01-30T06:45:01.104Z">2026-01-30T06:45:01.104Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport { useCallback, useEffect, useRef, useState } from &#x27;react&#x27;;
     2‚Üíimport { useGame } from &#x27;../../game/context/GameContext&#x27;;
     3‚Üíimport { getAudioManager } from &#x27;../../game/core/AudioManager&#x27;;
     4‚Üíimport styles from &#x27;./DeathScreen.module.css&#x27;;
     5‚Üí
     6‚Üíinterface DeathScreenProps {
     7‚Üí  /** Callback when restart mission button is clicked */
     8‚Üí  onRestartMission: () =&gt; void;
     9‚Üí  /** Callback when main menu button is clicked */
    10‚Üí  onMainMenu: () =&gt; void;
    11‚Üí  /** Optional death reason/cause text */
    12‚Üí  deathReason?: string;
    13‚Üí  /** Current mission name for display */
    14‚Üí  missionName?: string;
    15‚Üí}
    16‚Üí
    17‚Üí/**
    18‚Üí * DeathScreen - Game Over screen with military terminal styling
    19‚Üí *
    20‚Üí * Displays when player health reaches zero. Features:
    21‚Üí * - Glitch effect on &quot;MISSION FAILED&quot; title
    22‚Üí * - Death reason/cause text
    23‚Üí * - Stats display (kills, etc.)
    24‚Üí * - Restart mission and main menu buttons
    25‚Üí * - Blood vignette and scan line effects
    26‚Üí */
    27‚Üíexport function DeathScreen({
    28‚Üí  onRestartMission,
    29‚Üí  onMainMenu,
    30‚Üí  deathReason = &#x27;SPECTER DOWN - KIA&#x27;,
    31‚Üí  missionName = &#x27;CURRENT MISSION&#x27;,
    32‚Üí}: DeathScreenProps) {
    33‚Üí  const { kills } = useGame();
    34‚Üí  const [hasPlayedSound, setHasPlayedSound] = useState(false);
    35‚Üí  const restartButtonRef = useRef&lt;HTMLButtonElement&gt;(null);
    36‚Üí
    37‚Üí  // Play death sound on mount and focus restart button
    38‚Üí  useEffect(() =&gt; {
    39‚Üí    if (!hasPlayedSound) {
    40‚Üí      // Play a somber/failure sound
    41‚Üí      getAudioManager().playMusic(&#x27;menu&#x27;, 2); // Fade to menu music
    42‚Üí      setHasPlayedSound(true);
    43‚Üí    }
    44‚Üí    // Focus restart button for accessibility
    45‚Üí    restartButtonRef.current?.focus();
    46‚Üí  }, [hasPlayedSound]);
    47‚Üí
    48‚Üí  const playClickSound = useCallback(() =&gt; {
    49‚Üí    getAudioManager().play(&#x27;ui_click&#x27;, { volume: 0.3 });
    50‚Üí  }, []);
    51‚Üí
    52‚Üí  const handleRestartMission = useCallback(() =&gt; {
    53‚Üí    playClickSound();
    54‚Üí    onRestartMission();
    55‚Üí  }, [onRestartMission, playClickSound]);
    56‚Üí
    57‚Üí  const handleMainMenu = useCallback(() =&gt; {
    58‚Üí    playClickSound();
    59‚Üí    onMainMenu();
    60‚Üí  }, [onMainMenu, playClickSound]);
    61‚Üí
    62‚Üí  return (
    63‚Üí    &lt;div className={styles.overlay} role=&quot;dialog&quot; aria-labelledby=&quot;death-title&quot; aria-modal=&quot;true&quot;&gt;
    64‚Üí      {/* Scan line effect */}
    65‚Üí      &lt;div className={styles.scanLines} aria-hidden=&quot;true&quot; /&gt;
    66‚Üí
    67‚Üí      {/* Blood vignette */}
    68‚Üí      &lt;div className={styles.vignette} aria-hidden=&quot;true&quot; /&gt;
    69‚Üí
    70‚Üí      &lt;div className={styles.container}&gt;
    71‚Üí        {/* Corner brackets */}
    72‚Üí        &lt;div className={styles.cornerTL} aria-hidden=&quot;true&quot; /&gt;
    73‚Üí        &lt;div className={styles.cornerTR} aria-hidden=&quot;true&quot; /&gt;
    74‚Üí        &lt;div className={styles.cornerBL} aria-hidden=&quot;true&quot; /&gt;
    75‚Üí        &lt;div className={styles.cornerBR} aria-hidden=&quot;true&quot; /&gt;
    76‚Üí
    77‚Üí        {/* KIA Marker */}
    78‚Üí        &lt;div className={styles.kiaMarker} aria-hidden=&quot;true&quot;&gt;
    79‚Üí          &lt;div className={styles.kiaMarkerInner}&gt;KIA&lt;/div&gt;
    80‚Üí        &lt;/div&gt;
    81‚Üí
    82‚Üí        {/* Title with glitch effect */}
    83‚Üí        &lt;h1 id=&quot;death-title&quot; className={styles.title}&gt;
    84‚Üí          MISSION FAILED
    85‚Üí        &lt;/h1&gt;
    86‚Üí
    87‚Üí        {/* Death reason */}
    88‚Üí        &lt;p className={styles.deathReason}&gt;{deathReason}&lt;/p&gt;
    89‚Üí
    90‚Üí        {/* Divider */}
    91‚Üí        &lt;div className={styles.divider} aria-hidden=&quot;true&quot;&gt;
    92‚Üí          &lt;span className={styles.dividerText}&gt;COMBAT LOG&lt;/span&gt;
    93‚Üí        &lt;/div&gt;
    94‚Üí
    95‚Üí        {/* Stats display */}
    96‚Üí        &lt;div className={styles.statsContainer}&gt;
    97‚Üí          &lt;div className={styles.statItem}&gt;
    98‚Üí            &lt;span className={styles.statLabel}&gt;HOSTILES ELIMINATED&lt;/span&gt;
    99‚Üí            &lt;span className={styles.statValue}&gt;{kills}&lt;/span&gt;
   100‚Üí          &lt;/div&gt;
   101‚Üí          &lt;div className={styles.statItem}&gt;
   102‚Üí            &lt;span className={styles.statLabel}&gt;MISSION STATUS&lt;/span&gt;
   103‚Üí            &lt;span className={styles.statValue}&gt;FAILED&lt;/span&gt;
   104‚Üí          &lt;/div&gt;
   105‚Üí        &lt;/div&gt;
   106‚Üí
   107‚Üí        {/* Buttons */}
   108‚Üí        &lt;div className={styles.buttonGroup}&gt;
   109‚Üí          &lt;button
   110‚Üí            ref={restartButtonRef}
   111‚Üí            type=&quot;button&quot;
   112‚Üí            className={`${styles.button} ${styles.primaryButton}`}
   113‚Üí            onClick={handleRestartMission}
   114‚Üí          &gt;
   115‚Üí            &lt;span className={styles.buttonIcon} aria-hidden=&quot;true&quot;&gt;
   116‚Üí              ‚Üª
   117‚Üí            &lt;/span&gt;
   118‚Üí            RESTART MISSION
   119‚Üí          &lt;/button&gt;
   120‚Üí
   121‚Üí          &lt;button type=&quot;button&quot; className={styles.button} onClick={handleMainMenu}&gt;
   122‚Üí            &lt;span className={styles.buttonIcon} aria-hidden=&quot;true&quot;&gt;
   123‚Üí              ‚óÄ
   124‚Üí            &lt;/span&gt;
   125‚Üí            MAIN MENU
   126‚Üí          &lt;/button&gt;
   127‚Üí        &lt;/div&gt;
   128‚Üí
   129‚Üí        {/* Footer info */}
   130‚Üí        &lt;div className={styles.footer}&gt;
   131‚Üí          &lt;span&gt;{missionName}&lt;/span&gt;
   132‚Üí          &lt;span className={styles.footerCenter}&gt;7TH DROP MARINES&lt;/span&gt;
   133‚Üí          &lt;span&gt;CASUALTY REPORT&lt;/span&gt;
   134‚Üí        &lt;/div&gt;
   135‚Üí      &lt;/div&gt;
   136‚Üí    &lt;/div&gt;
   137‚Üí  );
   138‚Üí}
   139‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-45-01-118Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-45-01-118Z" class="timestamp-link"><time datetime="2026-01-30T06:45:01.118Z" data-timestamp="2026-01-30T06:45:01.118Z">2026-01-30T06:45:01.118Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Hp6CBh5pRfUhU3ap9aSNFA"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/App.tsx&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-45-01-120Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-45-01-120Z" class="timestamp-link"><time datetime="2026-01-30T06:45:01.120Z" data-timestamp="2026-01-30T06:45:01.120Z">2026-01-30T06:45:01.120Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üíimport { useCallback, useEffect, useState } from &#x27;react&#x27;;
     2‚Üíimport { GameCanvas } from &#x27;./components/GameCanvas&#x27;;
     3‚Üíimport { AchievementPopup } from &#x27;./components/ui/AchievementPopup&#x27;;
     4‚Üíimport { CommsDisplay } from &#x27;./components/ui/CommsDisplay&#x27;;
     5‚Üíimport { ControlHints } from &#x27;./components/ui/ControlHints&#x27;;
     6‚Üíimport { DeathScreen } from &#x27;./components/ui/DeathScreen&#x27;;
     7‚Üíimport { HUD } from &#x27;./components/ui/HUD&#x27;;
     8‚Üíimport { LandscapeEnforcer } from &#x27;./components/ui/LandscapeEnforcer&#x27;;
     9‚Üíimport { LoadingModal, type LoadingState } from &#x27;./components/ui/LoadingModal&#x27;;
    10‚Üíimport { MainMenu } from &#x27;./components/ui/MainMenu&#x27;;
    11‚Üíimport { MobileTutorial } from &#x27;./components/ui/MobileTutorial&#x27;;
    12‚Üíimport { TouchControls } from &#x27;./components/ui/TouchControls&#x27;;
    13‚Üíimport { initAchievements } from &#x27;./game/achievements&#x27;;
    14‚Üíimport { GameProvider, useGame } from &#x27;./game/context/GameContext&#x27;;
    15‚Üíimport { KeybindingsProvider } from &#x27;./game/context/KeybindingsContext&#x27;;
    16‚Üíimport { WeaponProvider } from &#x27;./game/context/WeaponContext&#x27;;
    17‚Üíimport { CAMPAIGN_LEVELS, type LevelId } from &#x27;./game/levels/types&#x27;;
    18‚Üíimport { saveSystem } from &#x27;./game/persistence&#x27;;
    19‚Üí
    20‚Üí/**
    21‚Üí * Detect touch capability - works on ALL touch devices including foldables
    22‚Üí * Uses multiple detection methods for maximum compatibility:
    23‚Üí * - &#x27;ontouchstart&#x27; in window: Standard touch event support
    24‚Üí * - navigator.maxTouchPoints &gt; 0: Modern API, works even before touch events fire
    25‚Üí * - matchMedia(&#x27;(pointer: coarse)&#x27;): CSS media query for touch-primary devices
    26‚Üí */
    27‚Üífunction detectTouchCapability(): boolean {
    28‚Üí  // Primary detection: touch event support or touch points
    29‚Üí  const hasTouch = &#x27;ontouchstart&#x27; in window || navigator.maxTouchPoints &gt; 0;
    30‚Üí
    31‚Üí  // Secondary detection: CSS media query for coarse pointer (touch)
    32‚Üí  const hasCoarsePointer = window.matchMedia?.(&#x27;(pointer: coarse)&#x27;)?.matches ?? false;
    33‚Üí
    34‚Üí  // Tertiary detection: any-pointer coarse (device has at least one touch input)
    35‚Üí  const hasAnyCoarsePointer = window.matchMedia?.(&#x27;(any-pointer: coarse)&#x27;)?.matches ?? false;
    36‚Üí
    37‚Üí  return hasTouch || hasCoarsePointer || hasAnyCoarsePointer;
    38‚Üí}
    39‚Üí
    40‚Üí// Initialize achievement system
    41‚ÜíinitAchievements();
    42‚Üí
    43‚Üí// Game states - proper flow from menu through tutorial to combat
    44‚Üítype GameState =
    45‚Üí  | &#x27;menu&#x27; // Main menu
    46‚Üí  | &#x27;loading&#x27; // Asset loading
    47‚Üí  | &#x27;tutorial&#x27; // Anchor Station tutorial
    48‚Üí  | &#x27;dropping&#x27; // HALO drop sequence
    49‚Üí  | &#x27;playing&#x27; // Surface combat
    50‚Üí  | &#x27;paused&#x27;
    51‚Üí  | &#x27;gameover&#x27;;
    52‚Üí
    53‚Üí// Valid level IDs for URL-based selection (dev/testing)
    54‚Üíconst VALID_LEVELS: LevelId[] = [
    55‚Üí  &#x27;anchor_station&#x27;,
    56‚Üí  &#x27;landfall&#x27;,
    57‚Üí  &#x27;fob_delta&#x27;,
    58‚Üí  &#x27;brothers_in_arms&#x27;,
    59‚Üí  &#x27;the_breach&#x27;,
    60‚Üí  &#x27;extraction&#x27;,
    61‚Üí];
    62‚Üí
    63‚Üí/**
    64‚Üí * Parse URL parameters for dev/testing level selection
    65‚Üí * Usage: ?level=fob_delta
    66‚Üí */
    67‚Üífunction getStartLevelFromURL(): LevelId | null {
    68‚Üí  const params = new URLSearchParams(window.location.search);
    69‚Üí  const levelParam = params.get(&#x27;level&#x27;);
    70‚Üí  if (levelParam &amp;&amp; VALID_LEVELS.includes(levelParam as LevelId)) {
    71‚Üí    return levelParam as LevelId;
    72‚Üí  }
    73‚Üí  return null;
    74‚Üí}
    75‚Üí
    76‚Üífunction GameUI() {
    77‚Üí  const [gameState, setGameState] = useState&lt;GameState&gt;(&#x27;menu&#x27;);
    78‚Üí  const [skipTutorial, setSkipTutorial] = useState(false);
    79‚Üí  const [startLevelId, setStartLevelId] = useState&lt;LevelId | null&gt;(null);
    80‚Üí  const [currentLevelId, setCurrentLevelId] = useState&lt;LevelId&gt;(&#x27;anchor_station&#x27;);
    81‚Üí  const [restartKey, setRestartKey] = useState(0); // Used to force remount of GameCanvas
    82‚Üí  const [loadingState, setLoadingState] = useState&lt;LoadingState&gt;({
    83‚Üí    stage: &#x27;INITIALIZING&#x27;,
    84‚Üí    progress: 0,
    85‚Üí  });
    86‚Üí  const [showMobileTutorial, setShowMobileTutorial] = useState(false);
    87‚Üí
    88‚Üí  // Check URL for dev/testing level selection
    89‚Üí  useEffect(() =&gt; {
    90‚Üí    const urlLevel = getStartLevelFromURL();
    91‚Üí    if (urlLevel) {
    92‚Üí      console.log(`[Dev] Starting level from URL: ${urlLevel}`);
    93‚Üí      setStartLevelId(urlLevel);
    94‚Üí      // Auto-start loading for the specified level
    95‚Üí      if (urlLevel === &#x27;anchor_station&#x27;) {
    96‚Üí        setSkipTutorial(false);
    97‚Üí      } else if (urlLevel === &#x27;landfall&#x27;) {
    98‚Üí        setSkipTutorial(true);
    99‚Üí      } else {
   100‚Üí        // For levels 3-6, we need different handling
   101‚Üí        setSkipTutorial(true);
   102‚Üí      }
   103‚Üí      setGameState(&#x27;loading&#x27;);
   104‚Üí    }
   105‚Üí  }, []);
   106‚Üí
   107‚Üí  const {
   108‚Üí    playerHealth,
   109‚Üí    maxHealth,
   110‚Üí    kills,
   111‚Üí    missionText,
   112‚Üí    objectiveTitle,
   113‚Üí    objectiveInstructions,
   114‚Üí    setTouchInput,
   115‚Üí    currentComms,
   116‚Üí    hideComms,
   117‚Üí    isCalibrating,
   118‚Üí    isPlayerDead,
   119‚Üí    resetPlayerHealth,
   120‚Üí    setOnPlayerDeath,
   121‚Üí    tutorialPhase,
   122‚Üí    isTutorialActive,
   123‚Üí  } = useGame();
   124‚Üí
   125‚Üí  // Robust touch detection - uses multiple methods for foldables/tablets
   126‚Üí  // This is a separate state from screenInfo to ensure touch controls appear
   127‚Üí  // on ALL touch devices regardless of screen size classification
   128‚Üí  const [isTouchDevice, setIsTouchDevice] = useState(() =&gt; detectTouchCapability());
   129‚Üí
   130‚Üí  // Update touch detection on resize/orientation change
   131‚Üí  useEffect(() =&gt; {
   132‚Üí    const updateTouchDetection = () =&gt; {
   133‚Üí      setIsTouchDevice(detectTouchCapability());
   134‚Üí    };
   135‚Üí
   136‚Üí    // Listen for resize and orientation changes (foldable state changes)
   137‚Üí    window.addEventListener(&#x27;resize&#x27;, updateTouchDetection);
   138‚Üí    window.addEventListener(&#x27;orientationchange&#x27;, updateTouchDetection);
   139‚Üí
   140‚Üí    // Also detect touch on first touch event (fallback for some browsers)
   141‚Üí    const handleFirstTouch = () =&gt; {
   142‚Üí      setIsTouchDevice(true);
   143‚Üí      window.removeEventListener(&#x27;touchstart&#x27;, handleFirstTouch);
   144‚Üí    };
   145‚Üí    window.addEventListener(&#x27;touchstart&#x27;, handleFirstTouch, { once: true, passive: true });
   146‚Üí
   147‚Üí    return () =&gt; {
   148‚Üí      window.removeEventListener(&#x27;resize&#x27;, updateTouchDetection);
   149‚Üí      window.removeEventListener(&#x27;orientationchange&#x27;, updateTouchDetection);
   150‚Üí      window.removeEventListener(&#x27;touchstart&#x27;, handleFirstTouch);
   151‚Üí    };
   152‚Üí  }, []);
   153‚Üí
   154‚Üí  // Start with tutorial (new game)
   155‚Üí  const handleStartGame = useCallback(() =&gt; {
   156‚Üí    setSkipTutorial(false);
   157‚Üí    setStartLevelId(null);
   158‚Üí    setCurrentLevelId(&#x27;anchor_station&#x27;);
   159‚Üí    setGameState(&#x27;loading&#x27;);
   160‚Üí  }, []);
   161‚Üí
   162‚Üí  // Continue from saved game
   163‚Üí  const handleContinue = useCallback(() =&gt; {
   164‚Üí    const save = saveSystem.getCurrentSave();
   165‚Üí    if (save) {
   166‚Üí      const levelId = save.currentLevel;
   167‚Üí      setStartLevelId(levelId);
   168‚Üí      setCurrentLevelId(levelId);
   169‚Üí      setSkipTutorial(save.tutorialCompleted);
   170‚Üí      setRestartKey((k) =&gt; k + 1);
   171‚Üí      setGameState(&#x27;loading&#x27;);
   172‚Üí    }
   173‚Üí  }, []);
   174‚Üí
   175‚Üí  // Skip tutorial - go straight to HALO drop
   176‚Üí  const handleSkipTutorial = useCallback(() =&gt; {
   177‚Üí    setSkipTutorial(true);
   178‚Üí    setStartLevelId(&#x27;landfall&#x27;);
   179‚Üí    setCurrentLevelId(&#x27;landfall&#x27;);
   180‚Üí    setGameState(&#x27;loading&#x27;);
   181‚Üí  }, []);
   182‚Üí
   183‚Üí  const handleLoadComplete = useCallback(() =&gt; {
   184‚Üí    // If a specific level was requested via URL, use appropriate state
   185‚Üí    if (startLevelId) {
   186‚Üí      switch (startLevelId) {
   187‚Üí        case &#x27;anchor_station&#x27;:
   188‚Üí          setGameState(&#x27;tutorial&#x27;);
   189‚Üí          // Show mobile tutorial on touch devices at start of Anchor Station
   190‚Üí          if (isTouchDevice) {
   191‚Üí            setShowMobileTutorial(true);
   192‚Üí          }
   193‚Üí          break;
   194‚Üí        case &#x27;landfall&#x27;:
   195‚Üí          setGameState(&#x27;dropping&#x27;);
   196‚Üí          break;
   197‚Üí        case &#x27;fob_delta&#x27;:
   198‚Üí        case &#x27;brothers_in_arms&#x27;:
   199‚Üí        case &#x27;the_breach&#x27;:
   200‚Üí        case &#x27;extraction&#x27;:
   201‚Üí          // These levels go straight to playing state
   202‚Üí          setGameState(&#x27;playing&#x27;);
   203‚Üí          break;
   204‚Üí        default:
   205‚Üí          setGameState(&#x27;tutorial&#x27;);
   206‚Üí      }
   207‚Üí      return;
   208‚Üí    }
   209‚Üí
   210‚Üí    if (skipTutorial) {
   211‚Üí      // Skip straight to HALO drop
   212‚Üí      setGameState(&#x27;dropping&#x27;);
   213‚Üí    } else {
   214‚Üí      // Start tutorial on Anchor Station
   215‚Üí      setGameState(&#x27;tutorial&#x27;);
   216‚Üí      // Show mobile tutorial on touch devices at start of Anchor Station
   217‚Üí      if (isTouchDevice) {
   218‚Üí        setShowMobileTutorial(true);
   219‚Üí      }
   220‚Üí    }
   221‚Üí  }, [skipTutorial, startLevelId, isTouchDevice]);
   222‚Üí
   223‚Üí  // Handle mobile tutorial completion
   224‚Üí  const handleMobileTutorialComplete = useCallback(() =&gt; {
   225‚Üí    setShowMobileTutorial(false);
   226‚Üí  }, []);
   227‚Üí
   228‚Üí  const handleTutorialComplete = useCallback(() =&gt; {
   229‚Üí    // Transition from tutorial to HALO drop
   230‚Üí    setGameState(&#x27;dropping&#x27;);
   231‚Üí  }, []);
   232‚Üí
   233‚Üí  const handleDropComplete = useCallback(() =&gt; {
   234‚Üí    // HALO drop finished, now playing on surface
   235‚Üí    setGameState(&#x27;playing&#x27;);
   236‚Üí  }, []);
   237‚Üí
   238‚Üí  // Return to main menu (resets everything)
   239‚Üí  const handleMainMenu = useCallback(() =&gt; {
   240‚Üí    resetPlayerHealth();
   241‚Üí    setRestartKey((k) =&gt; k + 1); // Force GameCanvas remount
   242‚Üí    setStartLevelId(null);
   243‚Üí    setCurrentLevelId(&#x27;anchor_station&#x27;);
   244‚Üí    setGameState(&#x27;menu&#x27;);
   245‚Üí  }, [resetPlayerHealth]);
   246‚Üí
   247‚Üí  // Restart current mission (reloads current level)
   248‚Üí  const handleRestartMission = useCallback(() =&gt; {
   249‚Üí    resetPlayerHealth();
   250‚Üí    setRestartKey((k) =&gt; k + 1); // Force GameCanvas remount
   251‚Üí    // Preserve current level for restart
   252‚Üí    setStartLevelId(currentLevelId);
   253‚Üí    setGameState(&#x27;loading&#x27;);
   254‚Üí  }, [resetPlayerHealth, currentLevelId]);
   255‚Üí
   256‚Üí  // Track current level when it changes and update save system
   257‚Üí  const handleLevelChange = useCallback((levelId: LevelId) =&gt; {
   258‚Üí    setCurrentLevelId(levelId);
   259‚Üí    saveSystem.setCurrentLevel(levelId);
   260‚Üí  }, []);
   261‚Üí
   262‚Üí  // Handle level selection from level select screen
   263‚Üí  const handleSelectLevel = useCallback((levelId: LevelId) =&gt; {
   264‚Üí    setStartLevelId(levelId);
   265‚Üí    setCurrentLevelId(levelId);
   266‚Üí    setSkipTutorial(levelId !== &#x27;anchor_station&#x27;);
   267‚Üí    setRestartKey((k) =&gt; k + 1);
   268‚Üí    setGameState(&#x27;loading&#x27;);
   269‚Üí  }, []);
   270‚Üí
   271‚Üí  const handleCommsDismiss = useCallback(() =&gt; {
   272‚Üí    hideComms();
   273‚Üí  }, [hideComms]);
   274‚Üí
   275‚Üí  // Set up player death callback to trigger game over
   276‚Üí  useEffect(() =&gt; {
   277‚Üí    setOnPlayerDeath(() =&gt; {
   278‚Üí      setGameState(&#x27;gameover&#x27;);
   279‚Üí    });
   280‚Üí    return () =&gt; setOnPlayerDeath(null);
   281‚Üí  }, [setOnPlayerDeath]);
   282‚Üí
   283‚Üí  // Watch for player death state change as backup trigger
   284‚Üí  useEffect(() =&gt; {
   285‚Üí    if (isPlayerDead &amp;&amp; gameState !== &#x27;gameover&#x27; &amp;&amp; gameState !== &#x27;menu&#x27;) {
   286‚Üí      setGameState(&#x27;gameover&#x27;);
   287‚Üí    }
   288‚Üí  }, [isPlayerDead, gameState]);
   289‚Üí
   290‚Üí  // Determine what HUD to show based on state
   291‚Üí  const showCombatHUD = gameState === &#x27;playing&#x27; || gameState === &#x27;dropping&#x27;;
   292‚Üí  const showTutorialHUD = gameState === &#x27;tutorial&#x27;;
   293‚Üí
   294‚Üí  return (
   295‚Üí    &lt;div className=&quot;game-container&quot;&gt;
   296‚Üí      {/* 3D Canvas - renders based on current state */}
   297‚Üí      &lt;GameCanvas
   298‚Üí        key={restartKey}
   299‚Üí        gameState={gameState}
   300‚Üí        startLevelId={startLevelId}
   301‚Üí        onTutorialComplete={handleTutorialComplete}
   302‚Üí        onDropComplete={handleDropComplete}
   303‚Üí        onLoadingProgress={setLoadingState}
   304‚Üí        onLevelChange={handleLevelChange}
   305‚Üí      /&gt;
   306‚Üí
   307‚Üí      {/* Main Menu */}
   308‚Üí      {gameState === &#x27;menu&#x27; &amp;&amp; (
   309‚Üí        &lt;MainMenu
   310‚Üí          onStart={handleStartGame}
   311‚Üí          onContinue={handleContinue}
   312‚Üí          onSkipTutorial={handleSkipTutorial}
   313‚Üí          onSelectLevel={handleSelectLevel}
   314‚Üí        /&gt;
   315‚Üí      )}
   316‚Üí
   317‚Üí      {/* Loading Modal */}
   318‚Üí      {gameState === &#x27;loading&#x27; &amp;&amp; (
   319‚Üí        &lt;LoadingModal
   320‚Üí          isOpen={true}
   321‚Üí          loadingState={loadingState}
   322‚Üí          onLoadComplete={handleLoadComplete}
   323‚Üí        /&gt;
   324‚Üí      )}
   325‚Üí
   326‚Üí      {/* Comms Display - shows during tutorial and gameplay */}
   327‚Üí      {currentComms &amp;&amp; (gameState === &#x27;tutorial&#x27; || gameState === &#x27;playing&#x27;) &amp;&amp; (
   328‚Üí        &lt;CommsDisplay isOpen={true} onClose={handleCommsDismiss} message={currentComms} /&gt;
   329‚Üí      )}
   330‚Üí
   331‚Üí      {/* Tutorial HUD - objective display */}
   332‚Üí      {showTutorialHUD &amp;&amp; (
   333‚Üí        &lt;div className=&quot;tutorial-hud&quot;&gt;
   334‚Üí          {objectiveTitle &amp;&amp; (
   335‚Üí            &lt;div className=&quot;objective-display&quot;&gt;
   336‚Üí              &lt;div className=&quot;objective-title&quot;&gt;{objectiveTitle}&lt;/div&gt;
   337‚Üí              {objectiveInstructions &amp;&amp; (
   338‚Üí                &lt;div className=&quot;objective-instructions&quot;&gt;{objectiveInstructions}&lt;/div&gt;
   339‚Üí              )}
   340‚Üí            &lt;/div&gt;
   341‚Üí          )}
   342‚Üí          {/* Crosshair for shooting range calibration */}
   343‚Üí          {isCalibrating &amp;&amp; (
   344‚Üí            &lt;div className=&quot;calibration-crosshair&quot;&gt;
   345‚Üí              &lt;div className=&quot;crosshair-dot&quot; /&gt;
   346‚Üí              &lt;div className=&quot;crosshair-line top&quot; /&gt;
   347‚Üí              &lt;div className=&quot;crosshair-line bottom&quot; /&gt;
   348‚Üí              &lt;div className=&quot;crosshair-line left&quot; /&gt;
   349‚Üí              &lt;div className=&quot;crosshair-line right&quot; /&gt;
   350‚Üí            &lt;/div&gt;
   351‚Üí          )}
   352‚Üí        &lt;/div&gt;
   353‚Üí      )}
   354‚Üí
   355‚Üí      {/* Mobile Tutorial - shows touch control instructions at start of tutorial on touch devices */}
   356‚Üí      {showTutorialHUD &amp;&amp; showMobileTutorial &amp;&amp; (
   357‚Üí        &lt;MobileTutorial onComplete={handleMobileTutorialComplete} /&gt;
   358‚Üí      )}
   359‚Üí
   360‚Üí      {/* Touch Controls for tutorial - show after mobile tutorial is dismissed */}
   361‚Üí      {showTutorialHUD &amp;&amp; isTouchDevice &amp;&amp; !showMobileTutorial &amp;&amp; (
   362‚Üí        &lt;TouchControls onInput={setTouchInput} /&gt;
   363‚Üí      )}
   364‚Üí
   365‚Üí      {/* Desktop Control Hints - shows key bindings during tutorial on desktop */}
   366‚Üí      {showTutorialHUD &amp;&amp; !isTouchDevice &amp;&amp; (
   367‚Üí        &lt;ControlHints tutorialPhase={tutorialPhase} isActive={isTutorialActive} /&gt;
   368‚Üí      )}
   369‚Üí
   370‚Üí      {/* Combat HUD */}
   371‚Üí      {showCombatHUD &amp;&amp; (
   372‚Üí        &lt;&gt;
   373‚Üí          &lt;HUD
   374‚Üí            health={playerHealth}
   375‚Üí            maxHealth={maxHealth}
   376‚Üí            kills={kills}
   377‚Üí            missionText={missionText}
   378‚Üí          /&gt;
   379‚Üí          {isTouchDevice &amp;&amp; &lt;TouchControls onInput={setTouchInput} /&gt;}
   380‚Üí        &lt;/&gt;
   381‚Üí      )}
   382‚Üí
   383‚Üí      {/* Game Over / Death Screen */}
   384‚Üí      {gameState === &#x27;gameover&#x27; &amp;&amp; (
   385‚Üí        &lt;DeathScreen
   386‚Üí          onRestartMission={handleRestartMission}
   387‚Üí          onMainMenu={handleMainMenu}
   388‚Üí          deathReason=&quot;SPECTER DOWN - KIA&quot;
   389‚Üí          missionName={CAMPAIGN_LEVELS[currentLevelId]?.missionName ?? &#x27;CURRENT MISSION&#x27;}
   390‚Üí        /&gt;
   391‚Üí      )}
   392‚Üí
   393‚Üí      {/* Landscape Enforcer - shows on mobile in portrait mode */}
   394‚Üí      &lt;LandscapeEnforcer
   395‚Üí        title=&quot;ROTATE DEVICE&quot;
   396‚Üí        message=&quot;STELLAR DESCENT requires landscape orientation for tactical operations.&quot;
   397‚Üí      /&gt;
   398‚Üí
   399‚Üí      {/* Achievement Popup - shows when achievements are unlocked */}
   400‚Üí      &lt;AchievementPopup /&gt;
   401‚Üí    &lt;/div&gt;
   402‚Üí  );
   403‚Üí}
   404‚Üí
   405‚Üíexport function App() {
   406‚Üí  return (
   407‚Üí    &lt;KeybindingsProvider&gt;
   408‚Üí      &lt;GameProvider&gt;
   409‚Üí        &lt;WeaponProvider&gt;
   410‚Üí          &lt;GameUI /&gt;
   411‚Üí        &lt;/WeaponProvider&gt;
   412‚Üí      &lt;/GameProvider&gt;
   413‚Üí    &lt;/KeybindingsProvider&gt;
   414‚Üí  );
   415‚Üí}
   416‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-45-02-316Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-45-02-316Z" class="timestamp-link"><time datetime="2026-01-30T06:45:02.316Z" data-timestamp="2026-01-30T06:45:02.316Z">2026-01-30T06:45:02.316Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_014Um1d65jfnqz9vpRaUCWNg"><div class="tool-header"><span class="tool-icon">‚öô</span> Grep</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;TODO|FIXME|HACK|XXX|BUG&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src&#34;,
  &#34;output_mode&#34;: &#34;content&#34;,
  &#34;-n&#34;: true
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div><details class="continuation"><summary>Session continuation summary</summary>
<div class="message user" id="msg-2026-01-30T06-46-09-777Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T06-46-09-777Z" class="timestamp-link"><time datetime="2026-01-30T06:46:09.777Z" data-timestamp="2026-01-30T06:46:09.777Z">2026-01-30T06:46:09.777Z</time></a></div><div class="message-content">
<div class="user-content"><p>This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation.</p>
<p>Analysis:
Let me analyze this conversation chronologically:</p>
<ol>
<li><strong>Session Start</strong>: This session continued from a previous session that ran out of context. The previous session summary indicates extensive work was done:</li>
<li>FOBDeltaLevel enemy AI implementation</li>
<li>Netlify deployment setup with "stellar-descent" subdomain</li>
<li>Node 22 LTS migration with .nvmrc</li>
<li>9+ parallel subagents for bulk tasks</li>
<li>Critical fixes: HALO drop FOV, health going to -180000, mobile landscape enforcement</li>
<li>
<p>GitHub secret setup for NETLIFY_AUTH_TOKEN</p>
</li>
<li>
<p><strong>User's Current Request</strong>: The user explicitly asked me to:</p>
</li>
<li>FIRST update the memory-bank since it hasn't been updated in a while</li>
<li>Do a thorough codebase review to find incomplete subagent implementations or gaps</li>
<li>
<p>Document those findings</p>
</li>
<li>
<p><strong>My Actions</strong>:</p>
</li>
<li>Found memory bank at <code>docs/memory-bank/</code> with 6 files</li>
<li>Read all memory bank files - found them significantly outdated (still showing Phase 3: Tutorial &amp; Story)</li>
<li>Read all level files to understand current implementation state</li>
<li>Read context files (GameContext.tsx, KeybindingsContext.tsx)</li>
<li>Read UI components (SettingsMenu.tsx, LandscapeEnforcer.tsx, DeathScreen.tsx, App.tsx)</li>
<li>
<p>Searched for TODO/FIXME/HACK/XXX/BUG comments</p>
</li>
<li>
<p><strong>Key Findings from Codebase Review</strong>:</p>
</li>
<li>Memory bank is significantly outdated</li>
<li>6 fully implemented levels exist (anchor-station, landfall, fob-delta, brothers-in-arms, the-breach, extraction)</li>
<li>KeybindingsContext exists but levels still have some hardcoded keys</li>
<li>5 TODOs found in codebase</li>
<li>Full CI/CD pipeline exists with Netlify deployment</li>
<li>
<p>Node 22 LTS, .nvmrc, updated workflows</p>
</li>
<li>
<p><strong>Work Status</strong>: I was in the middle of gathering information for the codebase review and memory bank update when the summary was requested. I have NOT yet:</p>
</li>
<li>Updated the memory bank files</li>
<li>Created a formal documentation of gaps</li>
</ol>
<p>Summary:
1. Primary Request and Intent:
   The user returned after a context overflow and asked me to:
   1. <strong>Update the memory-bank</strong> - explicitly stating "you haven't updated in AWHILE"
   2. <strong>Do a thorough codebase review</strong> to find incomplete subagent implementations or gaps
   3. <strong>Document those gaps</strong> in the memory bank</p>
<p>The user emphasized needing this due to "a BUNCH of work was done but you won't be aware of it" from the previous session overflow.</p>
<ol>
<li>Key Technical Concepts:</li>
<li>Babylon.js 3D game engine with TypeScript</li>
<li>React Context for state management (GameContext, KeybindingsContext, WeaponContext)</li>
<li>ECS (Entity Component System) architecture with Miniplex</li>
<li>Multi-level game structure (6 levels: anchor_station, landfall, fob_delta, brothers_in_arms, the_breach, extraction)</li>
<li>GLB model loading via AssetManager</li>
<li>Netlify MCP tools for deployment</li>
<li>GitHub Actions CI/CD with pnpm and Node 22 LTS</li>
<li>Mobile-first responsive design with landscape enforcement</li>
<li>FOV management for different gameplay phases</li>
<li>Health clamping and death state management</li>
<li>
<p>Configurable keybindings with localStorage persistence</p>
</li>
<li>
<p>Files and Code Sections:</p>
</li>
<li>
<p><strong>docs/memory-bank/*.md</strong> (all 6 files) - OUTDATED</p>
<ul>
<li>Still shows "Phase 3: Tutorial &amp; Story" as current phase</li>
<li>Doesn't reflect Node 22 migration, Netlify deployment, multi-level system, keybindings, etc.</li>
</ul>
</li>
<li>
<p><strong>src/game/levels/landfall/LandfallLevel.ts</strong> (1714 lines)</p>
<ul>
<li>HALO drop with FOV system: <code>FREEFALL_FOV = 1.75</code>, <code>POWERED_DESCENT_FOV = 1.4</code>, <code>SURFACE_FOV = 1.2</code></li>
<li>Terrain constraints to prevent falling through ground</li>
<li>Distant alien vehicle threats during descent</li>
<li>Anchor Station visible above player during drop</li>
</ul>
</li>
<li>
<p><strong>src/game/levels/fob-delta/FOBDeltaLevel.ts</strong> (2133 lines)</p>
<ul>
<li>Full enemy AI with chase/attack/death: <code>updateEnemies()</code>, <code>onEnemyAttack()</code>, <code>onEnemyKilled()</code></li>
<li>GLB model loading for enemies via AssetManager</li>
<li>Combat system with melee (<code>MELEE_DAMAGE = 50</code>) and ranged (<code>PRIMARY_FIRE_DAMAGE = 25</code>)</li>
<li>Horror atmosphere with flickering lights</li>
</ul>
</li>
<li>
<p><strong>src/game/levels/the-breach/TheBreachLevel.ts</strong> (1163 lines)</p>
<ul>
<li>Queen boss fight with 3 phases</li>
<li>Hive environment with bioluminescent lighting</li>
<li>Enemy spawning from submodules (enemies.ts, queen.ts, hazards.ts, environment.ts)</li>
</ul>
</li>
<li>
<p><strong>src/game/levels/brothers-in-arms/BrothersInArmsLevel.ts</strong> (1625 lines)</p>
<ul>
<li>Marcus AI ally (8m tall Titan mech)</li>
<li>Wave-based combat (4 waves)</li>
<li>Open canyon arena (200mx150m)</li>
</ul>
</li>
<li>
<p><strong>src/game/levels/extraction/ExtractionLevel.ts</strong> (1588 lines)</p>
<ul>
<li>Escape sequence from collapsing hive</li>
<li>5-wave holdout defense</li>
<li>Dropship arrival victory sequence</li>
</ul>
</li>
<li>
<p><strong>src/game/context/GameContext.tsx</strong> (410 lines)</p>
<ul>
<li>Health clamping and death detection:
 <code>typescript
 const setPlayerHealth = useCallback((health: number) =&gt; {
   if (isPlayerDead) return;
   const clampedHealth = Math.max(0, Math.min(maxHealth, health));
   setPlayerHealthRaw(clampedHealth);
   if (clampedHealth &lt;= 0 &amp;&amp; !isPlayerDead) {
     setIsPlayerDead(true);
     if (playerDeathCallbackRef.current) playerDeathCallbackRef.current();
   }
 }, [isPlayerDead, maxHealth]);</code></li>
</ul>
</li>
<li>
<p><strong>src/game/context/KeybindingsContext.tsx</strong> (309 lines)</p>
<ul>
<li>Configurable keybindings with localStorage persistence</li>
<li>Default keybindings support arrays for alternatives (WASD + Arrow keys)</li>
</ul>
</li>
<li>
<p><strong>src/components/ui/SettingsMenu.tsx</strong> (319 lines)</p>
<ul>
<li>Full keybinding rebind UI with save/cancel workflow</li>
</ul>
</li>
<li>
<p><strong>src/components/ui/LandscapeEnforcer.tsx</strong> (147 lines)</p>
<ul>
<li>Forces landscape on mobile phones (&lt;768px)</li>
</ul>
</li>
<li>
<p><strong>src/components/ui/DeathScreen.tsx</strong> (139 lines)</p>
<ul>
<li>Game over screen with restart/main menu buttons</li>
</ul>
</li>
<li>
<p><strong>src/App.tsx</strong> (416 lines)</p>
<ul>
<li>Integrates KeybindingsProvider, GameProvider, WeaponProvider</li>
<li>URL-based level selection for dev testing (?level=fob_delta)</li>
<li>Save system integration</li>
</ul>
</li>
<li>
<p><strong>TODOs Found</strong> (from grep search):</p>
<ul>
<li><code>src/game/ecs/ChunkManager.ts:425</code> - Load actual mesh from modelPath</li>
<li><code>src/game/levels/factories.ts:49</code> - Implement CanyonLevel</li>
<li><code>src/game/levels/anchor-station/environment.ts:1994</code> - Implement platforming room</li>
<li><code>src/components/ui/TouchControls.tsx:317</code> - Implement weapon switching</li>
</ul>
</li>
<li>
<p>Errors and fixes:</p>
</li>
<li>No errors encountered in this session (still in investigation phase)</li>
<li>
<p>Previous session (from summary) fixed:</p>
<ul>
<li>TypeScript error: <code>isDisposed</code> doesn't exist on StandardMaterial ‚Üí Fixed with try/catch</li>
<li>TypeScript error: <code>fireRate</code> doesn't exist on ENEMY_STATS ‚Üí Added fireRate property</li>
<li>Netlify deploy failed with build error ‚Üí Fixed by deploying dist directly</li>
</ul>
</li>
<li>
<p>Problem Solving:</p>
</li>
<li>Currently investigating codebase to find gaps and incomplete implementations</li>
<li>Found memory bank significantly outdated - needs comprehensive update</li>
<li>Identified 5 TODO items in codebase</li>
<li>
<p>Found keybindings context exists but not fully wired to all levels</p>
</li>
<li>
<p>All user messages:</p>
</li>
<li>
<p>"I had to go BACK up in our conversation because it exceeeded maximum length and I couldn't compact. So a BUNCH of work was done but you won't be aware of it. Bcause of that I want you to FIRST make sure our memory-bank is up to date, you haven't updated in AWHIILE, and then I want you to do a thorough codebase review to determine any incomplete subagent implementations or other gaps, which you should ALSO document"</p>
</li>
<li>
<p>Pending Tasks:</p>
</li>
<li><strong>Update memory-bank files</strong> with current project state (explicitly requested)</li>
<li><strong>Document gaps</strong> found in codebase review (explicitly requested)</li>
<li>From TODOs found:<ul>
<li>ChunkManager mesh loading</li>
<li>CanyonLevel implementation</li>
<li>Platforming room completion</li>
<li>Weapon switching UI</li>
</ul>
</li>
<li>
<p>From previous session context:</p>
<ul>
<li>Wire keybindings context to actual game levels</li>
<li>E2E Playwright tests per level</li>
<li>Ammo/reload system polish</li>
</ul>
</li>
<li>
<p>Current Work:
   I was in the process of doing a thorough codebase review by:</p>
</li>
<li>Reading all memory bank files (found outdated)</li>
<li>Reading all level implementation files</li>
<li>Reading context/state management files</li>
<li>Reading key UI components</li>
<li>Searching for TODO/FIXME markers</li>
</ol>
<p>I had just completed the information gathering phase but have NOT yet:
   - Updated any memory bank files
   - Created formal documentation of gaps</p>
<ol>
<li>Optional Next Step:
   Based on the user's explicit request: "FIRST make sure our memory-bank is up to date... and then I want you to do a thorough codebase review... which you should ALSO document"</li>
</ol>
<p>The next step is to <strong>update the memory bank files</strong> with current project state, including:
   - Update Phase from 3 to 4+ (multi-level campaign implemented)
   - Document Node 22 LTS, Netlify deployment, CI/CD pipeline
   - Document all 6 levels and their completion status
   - Document new systems (KeybindingsContext, WeaponContext, death/restart flow)
   - Document identified gaps and TODOs</p>
<p>If you need specific details from before compaction (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/jbogaty/.claude/projects/-Users-jbogaty-src-arcade-cabinet-stellar-descent/db476c62-7724-495b-b561-0f5f591e9e86.jsonl
Please continue the conversation from where we left it off without asking the user any further questions. Continue with the last task that you were asked to work on.</p></div></div></div></details>
<div class="message assistant" id="msg-2026-01-30T06-46-14-520Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-14-520Z" class="timestamp-link"><time datetime="2026-01-30T06:46:14.520Z" data-timestamp="2026-01-30T06:46:14.520Z">2026-01-30T06:46:14.520Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Looking at the summary, I was asked to:
1. Update the memory-bank files (they're outdated)
2. Do a thorough codebase review to find incomplete implementations or gaps
3. Document those gaps</p>
<p>I had completed the information gathering phase but hadn't yet updated the memory bank files. Let me continue by updating those files now.</p>
<p>First, let me read the current memory bank files to understand their structure, then update them with the current project state.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-15-047Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-15-047Z" class="timestamp-link"><time datetime="2026-01-30T06:46:15.047Z" data-timestamp="2026-01-30T06:46:15.047Z">2026-01-30T06:46:15.047Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>I'll continue by updating the memory-bank files with the current project state and documenting the gaps found. Let me first read the current memory bank files to understand their structure.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-15-782Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-15-782Z" class="timestamp-link"><time datetime="2026-01-30T06:46:15.782Z" data-timestamp="2026-01-30T06:46:15.782Z">2026-01-30T06:46:15.782Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_011HQePMfwRAux2wGKjEeqpD"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-15-788Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-15-788Z" class="timestamp-link"><time datetime="2026-01-30T06:46:15.788Z" data-timestamp="2026-01-30T06:46:15.788Z">2026-01-30T06:46:15.788Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Active Context
     2‚Üí
     3‚Üí## Current Development Phase
     4‚Üí**Phase 3: Tutorial &amp; Story** (In Progress)
     5‚Üí
     6‚Üí## Recent Work (Session 4 - Jan 30, 2026)
     7‚Üí- **Testing Infrastructure**: Added Vitest (unit) and Playwright (E2E) testing.
     8‚Üí- **Shooting Range Mini-Game**: Implemented weapons calibration sequence in the tutorial.
     9‚Üí- **Tutorial Polish**: Expanded tutorial flow with equipment interaction, hangar depressurization, and launch sequence.
    10‚Üí- **Loading Screen**: Fixed fake loading to use real asset loading progress.
    11‚Üí
    12‚Üí## Immediate Priorities
    13‚Üí1. **First-person view**: Add gloved hands holding weapon models.
    14‚Üí2. **HALO drop polish**: Visualize the planet during descent; lock camera looking down.
    15‚Üí3. **Weapon System**: Implement functional weapon switching (Rifle, Pistol, Grenade).
    16‚Üí4. **View Bobbing**: Add head bob while walking for immersion.
    17‚Üí5. **Sound Effects**: Add audio for suit equip, depressurization, doors, and launch.
    18‚Üí6. **E2E Tests**: Expand coverage for full playthroughs.
    19‚Üí
    20‚Üí## Active Decisions
    21‚Üí- **Modular Levels**: Levels are self-contained packages (e.g., `src/game/levels/anchor-station/`) to avoid monolithic files.
    22‚Üí- **Ref-Based Updates**: The render loop uses `useRef` values to avoid stale closures in React state.
    23‚Üí- **Touch Controls**: Redesigned to &quot;DOOM-style&quot; - left joystick move, screen drag look, right side buttons.
    24‚Üí- **No Anime.js for Babylon**: Strictly enforced. Use manual `requestAnimationFrame` loops.
    25‚Üí
    26‚Üí## Known Issues
    27‚Üí- **Camera Sync**: Needs verification when syncing player turning with camera.
    28‚Üí- **Touch Testing**: Needs validation on real physical devices.
    29‚Üí- **Drop Sequence**: Transition needs visual polish.
    30‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-16-213Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-16-213Z" class="timestamp-link"><time datetime="2026-01-30T06:46:16.213Z" data-timestamp="2026-01-30T06:46:16.213Z">2026-01-30T06:46:16.213Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01GNQServDB4LspECoLb17VD"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-16-216Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-16-216Z" class="timestamp-link"><time datetime="2026-01-30T06:46:16.216Z" data-timestamp="2026-01-30T06:46:16.216Z">2026-01-30T06:46:16.216Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Progress
     2‚Üí
     3‚Üí## Project Timeline
     4‚Üí
     5‚Üí| Phase | Status | Description |
     6‚Üí|-------|--------|-------------|
     7‚Üí| **Phase 1: Foundation** | ‚úÖ Complete | Project setup, core systems (ECS, World Gen). |
     8‚Üí| **Phase 2: Core Gameplay** | ‚úÖ Complete | Combat loop, AI behaviors, procedural world. |
     9‚Üí| **Phase 3: Tutorial &amp; Story** | üîÑ In Progress | Anchor Station level, dialogue system, shooting range. |
    10‚Üí| **Phase 4: Content** | ‚è≥ Planned | Full mission set, enemies, bosses. |
    11‚Üí| **Phase 5: Polish** | ‚è≥ Planned | Audio, effects, optimization. |
    12‚Üí| **Phase 6: Release** | ‚è≥ Planned | Testing, deployment. |
    13‚Üí
    14‚Üí## Current Status (Phase 3)
    15‚Üí- **Completed**:
    16‚Üí    - Anchor Station environment.
    17‚Üí    - Tutorial flow (Movement -&gt; Equipment -&gt; Launch).
    18‚Üí    - Dialogue system (CommsDisplay).
    19‚Üí    - Shooting Range mini-game.
    20‚Üí    - Touch controls redesign (DOOM-style).
    21‚Üí    - Testing infrastructure (Vitest/Playwright).
    22‚Üí- **In Progress**:
    23‚Üí    - First-person hands/weapon visualization.
    24‚Üí    - HALO drop visual polish.
    25‚Üí    - Weapon switching system.
    26‚Üí
    27‚Üí## Known Issues
    28‚Üí- Touch controls need physical device validation.
    29‚Üí- Camera sync with player turning needs verification.
    30‚Üí- Drop sequence transition is functional but needs visual polish.
    31‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-16-668Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-16-668Z" class="timestamp-link"><time datetime="2026-01-30T06:46:16.668Z" data-timestamp="2026-01-30T06:46:16.668Z">2026-01-30T06:46:16.668Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01R7Vsa63fCdg64nui2DZ9NJ"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-16-670Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-16-670Z" class="timestamp-link"><time datetime="2026-01-30T06:46:16.670Z" data-timestamp="2026-01-30T06:46:16.670Z">2026-01-30T06:46:16.670Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Project Brief
     2‚Üí
     3‚Üí**STELLAR DESCENT: PROXIMA BREACH** is a mobile-first, 3D arcade shooter built with BabylonJS. The game features procedural world generation, persistent state via SQLite, and a mission-based story campaign.
     4‚Üí
     5‚Üí## Core Philosophy
     6‚Üí1. **Mobile-first**: All UI and controls must work on phones first, then scale up.
     7‚Üí2. **Military aesthetic**: Olive, khaki, brass colors. NO cyberpunk (no neon, no purple/blue gradients).
     8‚Üí3. **Harsh lighting**: Bright alien sun, high contrast, HDR visuals.
     9‚Üí4. **Persistent world**: Areas remember their state when revisited.
    10‚Üí5. **Story-driven**: Clear narrative with characters players care about.
    11‚Üí
    12‚Üí## Critical Development Rules
    13‚Üí- **NO FALLBACKS**: Code should fail fast and explicitly. Do not write try/catch that silently falls back.
    14‚Üí- **Fail Fast**: If WebGPU fails, show the error. Do not fallback to WebGL1.
    15‚Üí- **No anime.js for Babylon Objects**: Use `requestAnimationFrame` loops for mesh/material animations.
    16‚Üí
    17‚Üí## Key Technical Decisions
    18‚Üí- **Engine**: BabylonJS 8.x (WebGL2 only).
    19‚Üí- **Physics**: Havok.
    20‚Üí- **ECS**: Miniplex.
    21‚Üí- **AI**: Yuka.
    22‚Üí- **Persistence**: SQL.js (SQLite in browser).
    23‚Üí- **Styling**: CSS Modules with Design Tokens.
    24‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-17-162Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-17-162Z" class="timestamp-link"><time datetime="2026-01-30T06:46:17.162Z" data-timestamp="2026-01-30T06:46:17.162Z">2026-01-30T06:46:17.162Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Bb5q1KWTGsQuTHtXNQYeXR"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-17-164Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-17-164Z" class="timestamp-link"><time datetime="2026-01-30T06:46:17.164Z" data-timestamp="2026-01-30T06:46:17.164Z">2026-01-30T06:46:17.164Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# System Patterns
     2‚Üí
     3‚Üí## System Overview
     4‚ÜíThe application follows a strict hierarchical flow:
     5‚Üí`App.tsx` -&gt; `GameManager.ts` -&gt; Systems (Player, ChunkManager, ECS, AI).
     6‚Üí
     7‚Üí## Core Architecture
     8‚Üí
     9‚Üí### Entry Point
    10‚Üí- **App.tsx**: Initializes the BabylonJS Engine (WebGL2) and Havok Physics.
    11‚Üí- **GameCanvas.tsx**: React component hosting the canvas and HUD.
    12‚Üí
    13‚Üí### Game Manager
    14‚Üí- **GameManager.ts**: The central orchestrator. Manages game state (Menu, Playing, Paused), scene setup, and system coordination.
    15‚Üí
    16‚Üí### Entity Component System (ECS)
    17‚Üí- **Library**: Miniplex.
    18‚Üí- **Usage**: All game objects (Player, Enemies, Projectiles) are entities composed of data components (Transform, Health, Velocity, AI).
    19‚Üí- **Queries**: Systems query the ECS world for specific component combinations (e.g., `world.with(&#x27;ai&#x27;, &#x27;transform&#x27;)`).
    20‚Üí
    21‚Üí### AI System
    22‚Üí- **Library**: Yuka.
    23‚Üí- **Pattern**: Finite State Machine (FSM).
    24‚Üí- **States**: Idle, Patrol, Chase, Attack, Flee, Support.
    25‚Üí- **Behaviors**: Steering behaviors (Wander, Seek, Pursuit, Flee).
    26‚Üí
    27‚Üí### World Generation
    28‚Üí- **Chunk System**: World is divided into 100x100 unit chunks.
    29‚Üí- **Procedural**: Content generated deterministically based on coordinates and a seed.
    30‚Üí- **Persistence**: `SQL.js` stores the state of each chunk (entities, visited status) in a local SQLite database.
    31‚Üí
    32‚Üí### Modular Levels
    33‚Üí- **Structure**: Each level (e.g., `anchor-station`) is a self-contained module.
    34‚Üí- **Files**: `index.ts` (entry), `environment.ts` (meshes), `TutorialManager.ts` (logic), `materials.ts` (assets).
    35‚Üí
    36‚Üí## Data Flow
    37‚Üí1. **Input**: Touch/Keyboard -&gt; `GameManager` -&gt; `Player`.
    38‚Üí2. **Simulation**: `GameManager` loop -&gt; `AISystem` / `CombatSystem` -&gt; `ECS World` updates.
    39‚Üí3. **Rendering**: BabylonJS Engine renders the scene based on `ECS` transforms.
    40‚Üí4. **Persistence**: `ChunkManager` saves/loads from `WorldDatabase` on chunk boundaries.
    41‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-17-666Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-17-666Z" class="timestamp-link"><time datetime="2026-01-30T06:46:17.666Z" data-timestamp="2026-01-30T06:46:17.666Z">2026-01-30T06:46:17.666Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01AqM2yMJ5ZPEbDZX1t3GKo7"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-17-668Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-17-668Z" class="timestamp-link"><time datetime="2026-01-30T06:46:17.668Z" data-timestamp="2026-01-30T06:46:17.668Z">2026-01-30T06:46:17.668Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Technical Context
     2‚Üí
     3‚Üí## Technologies
     4‚Üí- **Language**: TypeScript.
     5‚Üí- **Runtime**: Browser (Vite).
     6‚Üí- **Rendering**: BabylonJS 8.x (WebGL2).
     7‚Üí- **Physics**: Havok Physics.
     8‚Üí- **ECS**: Miniplex.
     9‚Üí- **AI**: Yuka.
    10‚Üí- **Persistence**: SQL.js (SQLite).
    11‚Üí- **Animation**: Anime.js (DOM only), Manual RAF (Babylon objects).
    12‚Üí- **UI**: React 19, CSS Modules.
    13‚Üí
    14‚Üí## Development Setup
    15‚Üí- **Build Tool**: Vite.
    16‚Üí- **Package Manager**: pnpm.
    17‚Üí- **Linting**: Biome.
    18‚Üí- **Testing**:
    19‚Üí    - **Unit**: Vitest + Happy-DOM.
    20‚Üí    - **E2E**: Playwright.
    21‚Üí
    22‚Üí## Constraints
    23‚Üí- **Mobile Performance**: Optimized for mobile devices. Limit draw calls, shadow map resolution, and complex physics.
    24‚Üí- **No WebGPU**: Explicit decision to stick to WebGL2 for stability and &quot;fail fast&quot; debugging.
    25‚Üí- **Asset Management**: No external models yet (using primitives). Textures from BabylonJS assets library.
    26‚Üí
    27‚Üí## Dependencies
    28‚Üí- `@babylonjs/core`, `@babylonjs/gui`, `@babylonjs/havok`: Core engine.
    29‚Üí- `miniplex`: ECS.
    30‚Üí- `yuka`: AI.
    31‚Üí- `sql.js`: Database.
    32‚Üí- `react`, `react-dom`: UI.
    33‚Üí- `vitest`, `playwright`: Testing.
    34‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-18-123Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-18-123Z" class="timestamp-link"><time datetime="2026-01-30T06:46:18.123Z" data-timestamp="2026-01-30T06:46:18.123Z">2026-01-30T06:46:18.123Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01RrFZHU1RJL7sBshQuhP24J"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-18-125Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-18-125Z" class="timestamp-link"><time datetime="2026-01-30T06:46:18.125Z" data-timestamp="2026-01-30T06:46:18.125Z">2026-01-30T06:46:18.125Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Product Context
     2‚Üí
     3‚Üí## The Narrative
     4‚ÜíThe year is 3147 CE. Humanity has spread to Proxima Centauri b (&quot;Kepler&#x27;s Promise&quot;). The Terran Expansion Authority (TEA) oversees colonization.
     5‚ÜíThe player controls **Sergeant James Cole (Callsign: SPECTER)**, a &quot;Hell Jumper&quot; marine.
     6‚Üí**The Mission**: Find his brother, **Corporal Marcus Cole (Callsign: HAMMER)**, who went missing with Recon Team Vanguard at FOB Delta.
     7‚Üí
     8‚Üí## The Enemy
     9‚Üí**Strain-X / &quot;Chitin&quot;**: An insectoid hive species living deep underground. They were awakened by mining operations.
    10‚Üí- **Characteristics**: Insectoid, hive mind, bioluminescent, subterranean.
    11‚Üí- **Variants**: Drones, Grunts, Brutes, Spitters, and the Queen.
    12‚Üí
    13‚Üí## User Experience Goals
    14‚Üí- **Grounded &amp; Human**: A military story about brotherhood, not a generic sci-fi shooter.
    15‚Üí- **Visceral Combat**: Heavy weapons, tactical movement, intense firefights.
    16‚Üí- **Exploration**: Procedurally generated world that feels alive and dangerous.
    17‚Üí- **Persistence**: Changes to the world (destroyed buildings, dead enemies) are saved.
    18‚Üí
    19‚Üí## Design Guidelines
    20‚Üí- **Visuals**: Modern military equipment, worn and battle-tested. High contrast lighting.
    21‚Üí- **UI**: Utilitarian, functional, &quot;heads-up display&quot; style.
    22‚Üí- **Controls**: Optimized for touch (virtual joysticks, screen drag for look).
    23‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-25-562Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-25-562Z" class="timestamp-link"><time datetime="2026-01-30T06:46:25.562Z" data-timestamp="2026-01-30T06:46:25.562Z">2026-01-30T06:46:25.562Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a full understanding of the current memory bank state. It's significantly outdated - still showing Phase 3 as in progress when we're actually much further along. Let me update all files to reflect the current state:</p>
<ol>
<li><strong>activeContext.md</strong> - needs to show Phase 5+ work, all 6 levels, CI/CD, Netlify deployment</li>
<li><strong>progress.md</strong> - needs to show Phase 4 complete, Phase 5 in progress</li>
<li><strong>projectbrief.md</strong> - can stay mostly the same but may need minor updates</li>
<li><strong>systemPatterns.md</strong> - needs to add new patterns (KeybindingsContext, WeaponContext, LevelManager)</li>
<li><strong>techContext.md</strong> - needs Node 22 LTS, Tone.js music, CI/CD pipeline, Netlify</li>
<li><strong>productContext.md</strong> - can mostly stay the same</li>
</ol>
<p>Let me also check what's in the levels/types.ts to get the full campaign structure.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-26-350Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-26-350Z" class="timestamp-link"><time datetime="2026-01-30T06:46:26.350Z" data-timestamp="2026-01-30T06:46:26.350Z">2026-01-30T06:46:26.350Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Now I have a clear picture of the outdated memory bank. Let me check the level types to get the full campaign structure for accurate documentation.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-26-938Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-26-938Z" class="timestamp-link"><time datetime="2026-01-30T06:46:26.938Z" data-timestamp="2026-01-30T06:46:26.938Z">2026-01-30T06:46:26.938Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01D2Y7WNhDB97R46dcViYKTw"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-26-941Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-26-941Z" class="timestamp-link"><time datetime="2026-01-30T06:46:26.941Z" data-timestamp="2026-01-30T06:46:26.941Z">2026-01-30T06:46:26.941Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí/**
     2‚Üí * Level System Types - Designed Campaign
     3‚Üí *
     4‚Üí * STELLAR DESCENT Campaign Structure (matching LORE.md):
     5‚Üí *
     6‚Üí * ACT 1: THE DROP
     7‚Üí *   1. Anchor Station Prometheus - Tutorial/Briefing (Prologue + Chapter 1)
     8‚Üí *   2. Landfall - HALO drop, first surface combat (Chapter 2)
     9‚Üí *
    10‚Üí * ACT 2: THE SEARCH
    11‚Üí *   3. FOB Delta - Abandoned base, horror/investigation (Chapter 3)
    12‚Üí *   4. Brothers in Arms - Reunite with Marcus, mech combat (Chapter 4)
    13‚Üí *
    14‚Üí * ACT 3: THE TRUTH
    15‚Üí *   5. The Breach - Underground hive, Queen boss fight (Chapter 5)
    16‚Üí *   6. Extraction - Escape and holdout at LZ Omega (Chapter 6)
    17‚Üí */
    18‚Üí
    19‚Üíimport type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    20‚Üíimport type { Scene } from &#x27;@babylonjs/core/scene&#x27;;
    21‚Üíimport type { CommsMessage } from &#x27;../types&#x27;;
    22‚Üíimport type { ActionButtonGroup } from &#x27;../types/actions&#x27;;
    23‚Üí
    24‚Üí// Level environment types
    25‚Üíexport type LevelType =
    26‚Üí  | &#x27;station&#x27; // Interior station (Anchor Station)
    27‚Üí  | &#x27;drop&#x27; // HALO drop sequence
    28‚Üí  | &#x27;canyon&#x27; // Exterior canyon/surface
    29‚Üí  | &#x27;base&#x27; // Abandoned FOB interior
    30‚Üí  | &#x27;brothers&#x27; // Open canyon with mech ally combat
    31‚Üí  | &#x27;hive&#x27; // Underground alien tunnels + Queen boss
    32‚Üí  | &#x27;extraction&#x27;; // Surface escape and holdout
    33‚Üí
    34‚Üí// Campaign level IDs - linear progression (matches LORE.md chapters)
    35‚Üíexport type LevelId =
    36‚Üí  | &#x27;anchor_station&#x27; // Prologue + Chapter 1: Tutorial/Briefing
    37‚Üí  | &#x27;landfall&#x27; // Chapter 2: HALO drop + first surface combat
    38‚Üí  | &#x27;fob_delta&#x27; // Chapter 3: Abandoned base investigation
    39‚Üí  | &#x27;brothers_in_arms&#x27; // Chapter 4: Reunite with Marcus, mech combat
    40‚Üí  | &#x27;the_breach&#x27; // Chapter 5: Underground hive, Queen boss
    41‚Üí  | &#x27;extraction&#x27;; // Chapter 6: Escape and holdout at LZ Omega
    42‚Üí
    43‚Üí// Callbacks from level to game system
    44‚Üíexport interface LevelCallbacks {
    45‚Üí  onCommsMessage: (message: CommsMessage) =&gt; void;
    46‚Üí  onObjectiveUpdate: (title: string, instructions: string) =&gt; void;
    47‚Üí  onChapterChange: (chapter: number) =&gt; void;
    48‚Üí  onHealthChange: (health: number) =&gt; void;
    49‚Üí  onKill: () =&gt; void;
    50‚Üí  onDamage: () =&gt; void;
    51‚Üí  onNotification: (text: string, duration?: number) =&gt; void;
    52‚Üí  onLevelComplete: (nextLevelId: LevelId | null) =&gt; void;
    53‚Üí  onCombatStateChange: (inCombat: boolean) =&gt; void;
    54‚Üí  onCinematicStart?: () =&gt; void;
    55‚Üí  onCinematicEnd?: () =&gt; void;
    56‚Üí  // Action button system
    57‚Üí  onActionGroupsChange: (groups: ActionButtonGroup[]) =&gt; void;
    58‚Üí  onActionHandlerRegister: (handler: ((actionId: string) =&gt; void) | null) =&gt; void;
    59‚Üí}
    60‚Üí
    61‚Üí// Level configuration
    62‚Üíexport interface LevelConfig {
    63‚Üí  id: LevelId;
    64‚Üí  type: LevelType;
    65‚Üí  nextLevelId: LevelId | null;
    66‚Üí  previousLevelId: LevelId | null;
    67‚Üí
    68‚Üí  // Display info
    69‚Üí  chapter: number;
    70‚Üí  actName: string;
    71‚Üí  missionName: string;
    72‚Üí  missionSubtitle?: string;
    73‚Üí
    74‚Üí  // Spawn configuration
    75‚Üí  playerSpawnPosition?: { x: number; y: number; z: number };
    76‚Üí  playerSpawnRotation?: number;
    77‚Üí
    78‚Üí  // Level-specific settings
    79‚Üí  ambientTrack?: string;
    80‚Üí  combatTrack?: string;
    81‚Üí  hasCinematicIntro?: boolean;
    82‚Üí}
    83‚Üí
    84‚Üí// State that can be persisted for a level
    85‚Üíexport interface LevelState {
    86‚Üí  id: LevelId;
    87‚Üí  visited: boolean;
    88‚Üí  completed: boolean;
    89‚Üí  playerPosition?: { x: number; y: number; z: number };
    90‚Üí  playerRotation?: number;
    91‚Üí  // Collectibles found, enemies killed, etc.
    92‚Üí  stats?: {
    93‚Üí    kills: number;
    94‚Üí    secretsFound: number;
    95‚Üí    timeSpent: number;
    96‚Üí  };
    97‚Üí  // Story flags
    98‚Üí  flags?: Record&lt;string, boolean&gt;;
    99‚Üí}
   100‚Üí
   101‚Üí// The unified Level interface
   102‚Üíexport interface ILevel {
   103‚Üí  readonly id: LevelId;
   104‚Üí  readonly type: LevelType;
   105‚Üí  readonly config: LevelConfig;
   106‚Üí
   107‚Üí  // Lifecycle
   108‚Üí  initialize(): Promise&lt;void&gt;;
   109‚Üí  update(deltaTime: number): void;
   110‚Üí  dispose(): void;
   111‚Üí
   112‚Üí  // Scene access
   113‚Üí  getScene(): Scene;
   114‚Üí
   115‚Üí  // State management
   116‚Üí  getState(): LevelState;
   117‚Üí  setState(state: Partial&lt;LevelState&gt;): void;
   118‚Üí
   119‚Üí  // Player control
   120‚Üí  lockPointer(): void;
   121‚Üí  unlockPointer(): void;
   122‚Üí  isPointerLocked(): boolean;
   123‚Üí
   124‚Üí  // Navigation
   125‚Üí  canTransitionTo(levelId: LevelId): boolean;
   126‚Üí  prepareTransition(targetLevelId: LevelId): Promise&lt;void&gt;;
   127‚Üí}
   128‚Üí
   129‚Üí// Factory function signature
   130‚Üíexport type LevelFactory = (
   131‚Üí  engine: Engine,
   132‚Üí  canvas: HTMLCanvasElement,
   133‚Üí  config: LevelConfig,
   134‚Üí  callbacks: LevelCallbacks
   135‚Üí) =&gt; ILevel;
   136‚Üí
   137‚Üí// Registry of level factories by type
   138‚Üíexport interface LevelFactoryRegistry {
   139‚Üí  station: LevelFactory;
   140‚Üí  drop: LevelFactory;
   141‚Üí  canyon: LevelFactory;
   142‚Üí  base: LevelFactory;
   143‚Üí  brothers: LevelFactory;
   144‚Üí  hive: LevelFactory;
   145‚Üí  extraction: LevelFactory;
   146‚Üí}
   147‚Üí
   148‚Üí// ============================================================================
   149‚Üí// CAMPAIGN LEVEL CONFIGURATIONS
   150‚Üí// ============================================================================
   151‚Üí
   152‚Üíexport const CAMPAIGN_LEVELS: Record&lt;LevelId, LevelConfig&gt; = {
   153‚Üí  // -------------------------------------------------------------------------
   154‚Üí  // ACT 1: THE DROP
   155‚Üí  // -------------------------------------------------------------------------
   156‚Üí  anchor_station: {
   157‚Üí    id: &#x27;anchor_station&#x27;,
   158‚Üí    type: &#x27;station&#x27;,
   159‚Üí    nextLevelId: &#x27;landfall&#x27;,
   160‚Üí    previousLevelId: null,
   161‚Üí    chapter: 1,
   162‚Üí    actName: &#x27;ACT 1: THE DROP&#x27;,
   163‚Üí    missionName: &#x27;ANCHOR STATION PROMETHEUS&#x27;,
   164‚Üí    missionSubtitle: &#x27;Prep Bay 7&#x27;,
   165‚Üí    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   166‚Üí    playerSpawnRotation: Math.PI,
   167‚Üí    ambientTrack: &#x27;station_ambient&#x27;,
   168‚Üí    hasCinematicIntro: false,
   169‚Üí  },
   170‚Üí
   171‚Üí  landfall: {
   172‚Üí    id: &#x27;landfall&#x27;,
   173‚Üí    type: &#x27;drop&#x27;, // Starts as drop, transitions to canyon
   174‚Üí    nextLevelId: &#x27;fob_delta&#x27;,
   175‚Üí    previousLevelId: &#x27;anchor_station&#x27;,
   176‚Üí    chapter: 2,
   177‚Üí    actName: &#x27;ACT 1: THE DROP&#x27;,
   178‚Üí    missionName: &#x27;LANDFALL&#x27;,
   179‚Üí    missionSubtitle: &quot;Kepler&#x27;s Promise - Northern Canyon&quot;,
   180‚Üí    playerSpawnPosition: { x: 0, y: 500, z: 0 }, // High altitude for drop
   181‚Üí    hasCinematicIntro: true,
   182‚Üí    ambientTrack: &#x27;canyon_wind&#x27;,
   183‚Üí    combatTrack: &#x27;combat_surface&#x27;,
   184‚Üí  },
   185‚Üí
   186‚Üí  // -------------------------------------------------------------------------
   187‚Üí  // ACT 2: THE SEARCH
   188‚Üí  // -------------------------------------------------------------------------
   189‚Üí  fob_delta: {
   190‚Üí    id: &#x27;fob_delta&#x27;,
   191‚Üí    type: &#x27;base&#x27;,
   192‚Üí    nextLevelId: &#x27;brothers_in_arms&#x27;,
   193‚Üí    previousLevelId: &#x27;landfall&#x27;,
   194‚Üí    chapter: 3,
   195‚Üí    actName: &#x27;ACT 2: THE SEARCH&#x27;,
   196‚Üí    missionName: &#x27;FOB DELTA&#x27;,
   197‚Üí    missionSubtitle: &#x27;Forward Operating Base - Abandoned&#x27;,
   198‚Üí    playerSpawnPosition: { x: 0, y: 1.7, z: -5 },
   199‚Üí    hasCinematicIntro: true,
   200‚Üí    ambientTrack: &#x27;horror_ambient&#x27;,
   201‚Üí    combatTrack: &#x27;combat_interior&#x27;,
   202‚Üí  },
   203‚Üí
   204‚Üí  brothers_in_arms: {
   205‚Üí    id: &#x27;brothers_in_arms&#x27;,
   206‚Üí    type: &#x27;brothers&#x27;,
   207‚Üí    nextLevelId: &#x27;the_breach&#x27;,
   208‚Üí    previousLevelId: &#x27;fob_delta&#x27;,
   209‚Üí    chapter: 4,
   210‚Üí    actName: &#x27;ACT 2: THE SEARCH&#x27;,
   211‚Üí    missionName: &#x27;BROTHERS IN ARMS&#x27;,
   212‚Üí    missionSubtitle: &#x27;Reunion with Corporal Marcus Cole&#x27;,
   213‚Üí    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   214‚Üí    hasCinematicIntro: true,
   215‚Üí    ambientTrack: &#x27;canyon_wind&#x27;,
   216‚Üí    combatTrack: &#x27;combat_mech&#x27;,
   217‚Üí  },
   218‚Üí
   219‚Üí  // -------------------------------------------------------------------------
   220‚Üí  // ACT 3: THE TRUTH
   221‚Üí  // -------------------------------------------------------------------------
   222‚Üí  the_breach: {
   223‚Üí    id: &#x27;the_breach&#x27;,
   224‚Üí    type: &#x27;hive&#x27;,
   225‚Üí    nextLevelId: &#x27;extraction&#x27;,
   226‚Üí    previousLevelId: &#x27;brothers_in_arms&#x27;,
   227‚Üí    chapter: 5,
   228‚Üí    actName: &#x27;ACT 3: THE TRUTH&#x27;,
   229‚Üí    missionName: &#x27;INTO THE BREACH&#x27;,
   230‚Üí    missionSubtitle: &quot;Subterranean Hive - Queen&#x27;s Lair&quot;,
   231‚Üí    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   232‚Üí    hasCinematicIntro: true,
   233‚Üí    ambientTrack: &#x27;hive_ambient&#x27;,
   234‚Üí    combatTrack: &#x27;boss_combat&#x27;,
   235‚Üí  },
   236‚Üí
   237‚Üí  extraction: {
   238‚Üí    id: &#x27;extraction&#x27;,
   239‚Üí    type: &#x27;extraction&#x27;,
   240‚Üí    nextLevelId: null, // End of campaign
   241‚Üí    previousLevelId: &#x27;the_breach&#x27;,
   242‚Üí    chapter: 6,
   243‚Üí    actName: &#x27;ACT 3: THE TRUTH&#x27;,
   244‚Üí    missionName: &#x27;EXTRACTION&#x27;,
   245‚Üí    missionSubtitle: &#x27;LZ Omega - Hold Until Evac&#x27;,
   246‚Üí    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   247‚Üí    hasCinematicIntro: true,
   248‚Üí    ambientTrack: &#x27;extraction_ambient&#x27;,
   249‚Üí    combatTrack: &#x27;combat_finale&#x27;,
   250‚Üí  },
   251‚Üí};
   252‚Üí
   253‚Üí// ============================================================================
   254‚Üí// LINKED LIST TRAVERSAL UTILITIES
   255‚Üí// ============================================================================
   256‚Üí
   257‚Üí/**
   258‚Üí * Get the first level in the campaign (head of linked list)
   259‚Üí */
   260‚Üíexport function getFirstLevel(): LevelConfig {
   261‚Üí  return CAMPAIGN_LEVELS.anchor_station;
   262‚Üí}
   263‚Üí
   264‚Üí/**
   265‚Üí * Get the next level from a given level (linked list traversal)
   266‚Üí */
   267‚Üíexport function getNextLevel(levelId: LevelId): LevelConfig | null {
   268‚Üí  const current = CAMPAIGN_LEVELS[levelId];
   269‚Üí  if (!current.nextLevelId) return null;
   270‚Üí  return CAMPAIGN_LEVELS[current.nextLevelId];
   271‚Üí}
   272‚Üí
   273‚Üí/**
   274‚Üí * Get the previous level from a given level (linked list traversal)
   275‚Üí */
   276‚Üíexport function getPreviousLevel(levelId: LevelId): LevelConfig | null {
   277‚Üí  const current = CAMPAIGN_LEVELS[levelId];
   278‚Üí  if (!current.previousLevelId) return null;
   279‚Üí  return CAMPAIGN_LEVELS[current.previousLevelId];
   280‚Üí}
   281‚Üí
   282‚Üí/**
   283‚Üí * Count total levels by traversing the linked list
   284‚Üí */
   285‚Üíexport function getTotalLevels(): number {
   286‚Üí  let count = 0;
   287‚Üí  let current: LevelConfig | null = getFirstLevel();
   288‚Üí  while (current) {
   289‚Üí    count++;
   290‚Üí    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   291‚Üí  }
   292‚Üí  return count;
   293‚Üí}
   294‚Üí
   295‚Üí/**
   296‚Üí * Get level index by traversing from head (0-indexed)
   297‚Üí */
   298‚Üíexport function getLevelIndex(levelId: LevelId): number {
   299‚Üí  let index = 0;
   300‚Üí  let current: LevelConfig | null = getFirstLevel();
   301‚Üí  while (current) {
   302‚Üí    if (current.id === levelId) return index;
   303‚Üí    index++;
   304‚Üí    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   305‚Üí  }
   306‚Üí  return -1; // Not found
   307‚Üí}
   308‚Üí
   309‚Üí/**
   310‚Üí * Iterate through all levels (generator)
   311‚Üí */
   312‚Üíexport function* iterateLevels(): Generator&lt;LevelConfig&gt; {
   313‚Üí  let current: LevelConfig | null = getFirstLevel();
   314‚Üí  while (current) {
   315‚Üí    yield current;
   316‚Üí    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   317‚Üí  }
   318‚Üí}
   319‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-27-315Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-27-315Z" class="timestamp-link"><time datetime="2026-01-30T06:46:27.315Z" data-timestamp="2026-01-30T06:46:27.315Z">2026-01-30T06:46:27.315Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Rn6VbipchPdB4rWPRADe92"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/package.json&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-27-318Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-27-318Z" class="timestamp-link"><time datetime="2026-01-30T06:46:27.318Z" data-timestamp="2026-01-30T06:46:27.318Z">2026-01-30T06:46:27.318Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí{
     2‚Üí  &quot;name&quot;: &quot;orbital-drop&quot;,
     3‚Üí  &quot;author&quot;: &quot;21st.dev&quot;,
     4‚Üí  &quot;private&quot;: true,
     5‚Üí  &quot;version&quot;: &quot;1.0.0&quot;,
     6‚Üí  &quot;type&quot;: &quot;module&quot;,
     7‚Üí  &quot;packageManager&quot;: &quot;pnpm@10.28.0&quot;,
     8‚Üí  &quot;engines&quot;: {
     9‚Üí    &quot;node&quot;: &quot;&gt;=22&quot;,
    10‚Üí    &quot;pnpm&quot;: &quot;&gt;=10&quot;
    11‚Üí  },
    12‚Üí  &quot;scripts&quot;: {
    13‚Üí    &quot;dev&quot;: &quot;vite&quot;,
    14‚Üí    &quot;build&quot;: &quot;tsc &amp;&amp; vite build&quot;,
    15‚Üí    &quot;preview&quot;: &quot;vite preview&quot;,
    16‚Üí    &quot;lint&quot;: &quot;biome check --write .&quot;,
    17‚Üí    &quot;format&quot;: &quot;biome format --write .&quot;,
    18‚Üí    &quot;test&quot;: &quot;vitest&quot;,
    19‚Üí    &quot;test:ui&quot;: &quot;vitest --ui&quot;,
    20‚Üí    &quot;test:run&quot;: &quot;vitest run&quot;,
    21‚Üí    &quot;test:coverage&quot;: &quot;vitest run --coverage&quot;,
    22‚Üí    &quot;test:e2e&quot;: &quot;playwright test&quot;,
    23‚Üí    &quot;test:e2e:ui&quot;: &quot;playwright test --ui&quot;,
    24‚Üí    &quot;test:all&quot;: &quot;vitest run &amp;&amp; playwright test&quot;
    25‚Üí  },
    26‚Üí  &quot;devDependencies&quot;: {
    27‚Üí    &quot;@biomejs/biome&quot;: &quot;^2.3.13&quot;,
    28‚Üí    &quot;@playwright/test&quot;: &quot;^1.58.0&quot;,
    29‚Üí    &quot;@testing-library/dom&quot;: &quot;^10.4.1&quot;,
    30‚Üí    &quot;@testing-library/react&quot;: &quot;^16.3.2&quot;,
    31‚Üí    &quot;@types/node&quot;: &quot;^25.1.0&quot;,
    32‚Üí    &quot;@types/react&quot;: &quot;^19.2.10&quot;,
    33‚Üí    &quot;@types/react-dom&quot;: &quot;^19.2.3&quot;,
    34‚Üí    &quot;@types/sql.js&quot;: &quot;^1.4.9&quot;,
    35‚Üí    &quot;@vitejs/plugin-react&quot;: &quot;^5.1.2&quot;,
    36‚Üí    &quot;@vitest/ui&quot;: &quot;^4.0.18&quot;,
    37‚Üí    &quot;happy-dom&quot;: &quot;^20.4.0&quot;,
    38‚Üí    &quot;jsdom&quot;: &quot;^27.4.0&quot;,
    39‚Üí    &quot;typescript&quot;: &quot;^5.9.3&quot;,
    40‚Üí    &quot;vite&quot;: &quot;^7.3.1&quot;,
    41‚Üí    &quot;vite-plugin-compression&quot;: &quot;^0.5.1&quot;,
    42‚Üí    &quot;vite-plugin-glsl&quot;: &quot;^1.5.5&quot;,
    43‚Üí    &quot;vite-plugin-html&quot;: &quot;^3.2.2&quot;,
    44‚Üí    &quot;vite-plugin-pwa&quot;: &quot;^1.2.0&quot;,
    45‚Üí    &quot;vitest&quot;: &quot;^4.0.18&quot;
    46‚Üí  },
    47‚Üí  &quot;dependencies&quot;: {
    48‚Üí    &quot;@babylonjs/core&quot;: &quot;^8.48.2&quot;,
    49‚Üí    &quot;@babylonjs/gui&quot;: &quot;^8.48.2&quot;,
    50‚Üí    &quot;@babylonjs/havok&quot;: &quot;^1.3.11&quot;,
    51‚Üí    &quot;@babylonjs/inspector&quot;: &quot;^8.48.2&quot;,
    52‚Üí    &quot;@babylonjs/loaders&quot;: &quot;^8.48.2&quot;,
    53‚Üí    &quot;@babylonjs/materials&quot;: &quot;^8.48.2&quot;,
    54‚Üí    &quot;@babylonjs/post-processes&quot;: &quot;^8.48.2&quot;,
    55‚Üí    &quot;animejs&quot;: &quot;^4.3.5&quot;,
    56‚Üí    &quot;miniplex&quot;: &quot;^2.0.0&quot;,
    57‚Üí    &quot;react&quot;: &quot;^19.2.4&quot;,
    58‚Üí    &quot;react-dom&quot;: &quot;^19.2.4&quot;,
    59‚Üí    &quot;sql.js&quot;: &quot;^1.13.0&quot;,
    60‚Üí    &quot;tone&quot;: &quot;^15.1.22&quot;,
    61‚Üí    &quot;yuka&quot;: &quot;^0.7.8&quot;
    62‚Üí  }
    63‚Üí}
    64‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-32-909Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-32-909Z" class="timestamp-link"><time datetime="2026-01-30T06:46:32.909Z" data-timestamp="2026-01-30T06:46:32.909Z">2026-01-30T06:46:32.909Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a complete picture. Let me update all the memory bank files with the current state. I'll update them all to reflect:</p>
<ol>
<li>Phase 4 (Content) is complete - all 6 levels implemented</li>
<li>Phase 5 (Polish) is in progress</li>
<li>All the new systems (KeybindingsContext, WeaponContext, Level System, CI/CD)</li>
<li>Node 22 LTS, Tone.js, Netlify deployment</li>
<li>Document the gaps and TODOs found</li>
</ol>
<p>Let me create comprehensive updates to all 6 files.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-33-583Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-33-583Z" class="timestamp-link"><time datetime="2026-01-30T06:46:33.583Z" data-timestamp="2026-01-30T06:46:33.583Z">2026-01-30T06:46:33.583Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Now I have the full picture. Let me update all 6 memory bank files with the current state of the project.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-46-55-856Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-46-55-856Z" class="timestamp-link"><time datetime="2026-01-30T06:46:55.856Z" data-timestamp="2026-01-30T06:46:55.856Z">2026-01-30T06:46:55.856Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01G62zXEh4nz354jQpygqo1Y">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">activeContext.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Active Context

## Current Development Phase
**Phase 5: Polish &amp; CI/CD** (In Progress)

## Recent Work (Session 5+ - Jan 30, 2026)

### Major Accomplishments
- **Full 6-Level Campaign**: All levels implemented (anchor_station, landfall, fob_delta, brothers_in_arms, the_breach, extraction)
- **Node 22 LTS Migration**: Updated from Node 18 to Node 22 with `.nvmrc` for version pinning
- **Netlify Deployment**: CI/CD pipeline with automatic deploys to `stellar-descent.netlify.app`
- **GitHub Actions Workflows**: Unified `ci.yml` for lint, test, build, deploy
- **Keybindings System**: Full `KeybindingsContext` with settings UI for rebinding controls
- **Tone.js Music System**: Dynamic music with combat/exploration/boss tracks by Clement Panchout
- **Death/Restart Flow**: Proper game over screen with restart mission and main menu options
- **Health Clamping Fix**: Fixed bug where health could go to -180000 (now properly clamped 0-100)
- **HALO Drop FOV System**: Dynamic FOV during freefall (1.75), powered descent (1.4), surface (1.2)
- **Mobile Landscape Enforcement**: Forces landscape on phones &lt;768px
- **Save System**: `saveSystem.ts` with localStorage persistence for level progress

### Testing Infrastructure
- **Vitest**: Unit testing with happy-dom
- **Playwright**: E2E testing with per-level test files
- **Coverage**: `npm run test:coverage`

## Immediate Priorities
1. **Wire Keybindings to Levels**: KeybindingsContext exists but some levels have hardcoded keys
2. **Weapon Switching UI**: Touch control weapon switch button (TODO in TouchControls.tsx:317)
3. **Ammo/Reload System**: Polish and integrate with HUD
4. **E2E Test Coverage**: Expand Playwright tests for all 6 levels
5. **Chunk Manager Mesh Loading**: TODO at ChunkManager.ts:425

## Active Decisions
- **Modular Levels**: Each level is a self-contained class implementing `ILevel` interface
- **Level Linked List**: Campaign uses `nextLevelId`/`previousLevelId` for progression
- **Ref-Based Updates**: Render loops use `useRef` to avoid stale React closures
- **Touch Controls**: DOOM-style - left joystick move, screen drag look, right side buttons
- **No Anime.js for Babylon**: Manual RAF loops for 3D animations
- **KeybindingsContext**: Centralized key management with localStorage persistence

## Known Issues
- **Touch Testing**: Needs validation on real physical devices (foldables, tablets)
- **Platforming Room**: TODO in anchor-station/environment.ts:1994
- **CanyonLevel Factory**: TODO in factories.ts:49 (currently using placeholder)

## Identified Gaps (From Codebase Review)

### TODOs Found
1. `src/game/ecs/ChunkManager.ts:425` - Load actual mesh from modelPath
2. `src/game/levels/factories.ts:49` - Implement CanyonLevel
3. `src/game/levels/anchor-station/environment.ts:1994` - Implement platforming room
4. `src/components/ui/TouchControls.tsx:317` - Implement weapon switching

### Incomplete Integrations
- Keybindings context not fully wired to all level input handlers
- Weapon system has WeaponContext but limited UI integration
- Compass navigation data exists in GameContext but minimal HUD usage
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-46-55-861Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-46-55-861Z" class="timestamp-link"><time datetime="2026-01-30T06:46:55.861Z" data-timestamp="2026-01-30T06:46:55.861Z">2026-01-30T06:46:55.861Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# Active Context
     2‚Üí
     3‚Üí## Current Development Phase
     4‚Üí**Phase 5: Polish &amp; CI/CD** (In Progress)
     5‚Üí
     6‚Üí## Recent Work (Session 5+ - Jan 30, 2026)
     7‚Üí
     8‚Üí### Major Accomplishments
     9‚Üí- **Full 6-Level Campaign**: All levels implemented (anchor_station, landfall, fob_delta, brothers_in_arms, the_breach, extraction)
    10‚Üí- **Node 22 LTS Migration**: Updated from Node 18 to Node 22 with `.nvmrc` for version pinning
    11‚Üí- **Netlify Deployment**: CI/CD pipeline with automatic deploys to `stellar-descent.netlify.app`
    12‚Üí- **GitHub Actions Workflows**: Unified `ci.yml` for lint, test, build, deploy
    13‚Üí- **Keybindings System**: Full `KeybindingsContext` with settings UI for rebinding controls
    14‚Üí- **Tone.js Music System**: Dynamic music with combat/exploration/boss tracks by Clement Panchout
    15‚Üí- **Death/Restart Flow**: Proper game over screen with restart mission and main menu options
    16‚Üí- **Health Clamping Fix**: Fixed bug where health could go to -180000 (now properly clamped 0-100)
    17‚Üí- **HALO Drop FOV System**: Dynamic FOV during freefall (1.75), powered descent (1.4), surface (1.2)
    18‚Üí- **Mobile Landscape Enforcement**: Forces landscape on phones &lt;768px
    19‚Üí- **Save System**: `saveSystem.ts` with localStorage persistence for level progress
    20‚Üí
    21‚Üí### Testing Infrastructure
    22‚Üí- **Vitest**: Unit testing with happy-dom
    23‚Üí- **Playwright**: E2E testing with per-level test files
    24‚Üí- **Coverage**: `npm run test:coverage`
    25‚Üí
    26‚Üí## Immediate Priorities
    27‚Üí1. **Wire Keybindings to Levels**: KeybindingsContext exists but some levels have hardcoded keys
    28‚Üí2. **Weapon Switching UI**: Touch control weapon switch button (TODO in TouchControls.tsx:317)
    29‚Üí3. **Ammo/Reload System**: Polish and integrate with HUD
    30‚Üí4. **E2E Test Coverage**: Expand Playwright tests for all 6 levels
    31‚Üí5. **Chunk Manager Mesh Loading**: TODO at ChunkManager.ts:425
    32‚Üí
    33‚Üí## Active Decisions
    34‚Üí- **Modular Levels**: Each level is a self-contained class implementing `ILevel` interface
    35‚Üí- **Level Linked List**: Campaign uses `nextLevelId`/`previousLevelId` for progression
    36‚Üí- **Ref-Based Updates**: Render loops use `useRef` to avoid stale React closures
    37‚Üí- **Touch Controls**: DOOM-style - left joystick move, screen drag look, right side buttons
    38‚Üí- **No Anime.js for Babylon**: Manual RAF loops for 3D animations
    39‚Üí- **KeybindingsContext**: Centralized key management with localStorage persistence
    40‚Üí
    41‚Üí## Known Issues
    42‚Üí- **Touch Testing**: Needs validation on real physical devices (foldables, tablets)
    43‚Üí- **Platforming Room**: TODO in anchor-station/environment.ts:1994
    44‚Üí- **CanyonLevel Factory**: TODO in factories.ts:49 (currently using placeholder)
    45‚Üí
    46‚Üí## Identified Gaps (From Codebase Review)
    47‚Üí
    48‚Üí### TODOs Found
    49‚Üí1. `src/game/ecs/ChunkManager.ts:425` - Load actual mesh from modelPath
    50‚Üí2. `src/game/levels/factories.ts:49` - Implement CanyonLevel
    51‚Üí3. `src/game/levels/anchor-station/environment.ts:1994` - Implement platforming room
    52‚Üí4. `src/components/ui/TouchControls.tsx:317` - Implement weapon switching
    53‚Üí
    54‚Üí### Incomplete Integrations
    55‚Üí- Keybindings context not fully wired to all level input handlers
    56‚Üí- Weapon system has WeaponContext but limited UI integration
    57‚Üí- Compass navigation data exists in GameContext but minimal HUD usage
    58‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-47-09-568Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-47-09-568Z" class="timestamp-link"><time datetime="2026-01-30T06:47:09.568Z" data-timestamp="2026-01-30T06:47:09.568Z">2026-01-30T06:47:09.568Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_016tTrbSu88yQaCYmfYK2D7A">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">progress.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Progress

## Project Timeline

| Phase | Status | Description |
|-------|--------|-------------|
| **Phase 1: Foundation** | ‚úÖ Complete | Project setup, core systems (ECS, World Gen). |
| **Phase 2: Core Gameplay** | ‚úÖ Complete | Combat loop, AI behaviors, procedural world. |
| **Phase 3: Tutorial &amp; Story** | ‚úÖ Complete | Anchor Station level, dialogue system, shooting range. |
| **Phase 4: Content** | ‚úÖ Complete | Full 6-level campaign, enemies, bosses, Marcus ally. |
| **Phase 5: Polish** | üîÑ In Progress | Audio, CI/CD, deployment, settings UI. |
| **Phase 6: Release** | ‚è≥ Planned | Final testing, production deployment. |

## Current Status (Phase 5)

### Completed
- **6-Level Campaign** (all implemented):
  - Level 1: Anchor Station Prometheus (Tutorial/Briefing)
  - Level 2: Landfall (HALO drop + surface combat)
  - Level 3: FOB Delta (Horror/Investigation, enemy AI)
  - Level 4: Brothers in Arms (Marcus mech ally, wave combat)
  - Level 5: The Breach (Underground hive, Queen boss fight)
  - Level 6: Extraction (Escape + holdout at LZ Omega)
- **Tone.js Music System**: Combat, exploration, boss, ambient tracks
- **Keybindings System**: Full settings UI with rebinding support
- **Death/Restart Flow**: Game over screen, restart mission, main menu
- **Save System**: localStorage persistence for level progress
- **CI/CD Pipeline**: GitHub Actions + Netlify deployment
- **Node 22 LTS**: Migration complete with `.nvmrc`
- **Testing Infrastructure**: Vitest (unit) + Playwright (E2E)
- **Mobile Landscape Enforcement**: Forces rotation on phones
- **HALO Drop FOV System**: Dynamic FOV during descent phases
- **Health Clamping**: Fixed overflow bug (was -180000, now 0-100)

### In Progress
- Wire keybindings context to all level input handlers
- Weapon switching UI for touch controls
- E2E test expansion for all levels
- Ammo/reload system polish

## Campaign Level Status

| Level | Implementation | Tests | Polish |
|-------|---------------|-------|--------|
| Anchor Station | ‚úÖ Complete | ‚úÖ E2E | üîÑ Platforming room TODO |
| Landfall | ‚úÖ Complete | ‚úÖ E2E | ‚úÖ FOV system |
| FOB Delta | ‚úÖ Complete | üîÑ Basic | üîÑ Enemy AI tuning |
| Brothers in Arms | ‚úÖ Complete | üîÑ Basic | üîÑ Marcus AI polish |
| The Breach | ‚úÖ Complete | üîÑ Basic | üîÑ Queen phase tuning |
| Extraction | ‚úÖ Complete | üîÑ Basic | üîÑ Wave balance |

## Known Issues
- Touch controls need physical device validation
- Some levels still have hardcoded key checks (need keybindings context)
- CanyonLevel factory placeholder (factories.ts:49)
- ChunkManager mesh loading TODO (ChunkManager.ts:425)

## Deployment
- **URL**: https://stellar-descent.netlify.app
- **CI/CD**: GitHub Actions on push to main
- **Secrets**: NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID configured
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-47-09-571Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-47-09-571Z" class="timestamp-link"><time datetime="2026-01-30T06:47:09.571Z" data-timestamp="2026-01-30T06:47:09.571Z">2026-01-30T06:47:09.571Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# Progress
     2‚Üí
     3‚Üí## Project Timeline
     4‚Üí
     5‚Üí| Phase | Status | Description |
     6‚Üí|-------|--------|-------------|
     7‚Üí| **Phase 1: Foundation** | ‚úÖ Complete | Project setup, core systems (ECS, World Gen). |
     8‚Üí| **Phase 2: Core Gameplay** | ‚úÖ Complete | Combat loop, AI behaviors, procedural world. |
     9‚Üí| **Phase 3: Tutorial &amp; Story** | ‚úÖ Complete | Anchor Station level, dialogue system, shooting range. |
    10‚Üí| **Phase 4: Content** | ‚úÖ Complete | Full 6-level campaign, enemies, bosses, Marcus ally. |
    11‚Üí| **Phase 5: Polish** | üîÑ In Progress | Audio, CI/CD, deployment, settings UI. |
    12‚Üí| **Phase 6: Release** | ‚è≥ Planned | Final testing, production deployment. |
    13‚Üí
    14‚Üí## Current Status (Phase 5)
    15‚Üí
    16‚Üí### Completed
    17‚Üí- **6-Level Campaign** (all implemented):
    18‚Üí  - Level 1: Anchor Station Prometheus (Tutorial/Briefing)
    19‚Üí  - Level 2: Landfall (HALO drop + surface combat)
    20‚Üí  - Level 3: FOB Delta (Horror/Investigation, enemy AI)
    21‚Üí  - Level 4: Brothers in Arms (Marcus mech ally, wave combat)
    22‚Üí  - Level 5: The Breach (Underground hive, Queen boss fight)
    23‚Üí  - Level 6: Extraction (Escape + holdout at LZ Omega)
    24‚Üí- **Tone.js Music System**: Combat, exploration, boss, ambient tracks
    25‚Üí- **Keybindings System**: Full settings UI with rebinding support
    26‚Üí- **Death/Restart Flow**: Game over screen, restart mission, main menu
    27‚Üí- **Save System**: localStorage persistence for level progress
    28‚Üí- **CI/CD Pipeline**: GitHub Actions + Netlify deployment
    29‚Üí- **Node 22 LTS**: Migration complete with `.nvmrc`
    30‚Üí- **Testing Infrastructure**: Vitest (unit) + Playwright (E2E)
    31‚Üí- **Mobile Landscape Enforcement**: Forces rotation on phones
    32‚Üí- **HALO Drop FOV System**: Dynamic FOV during descent phases
    33‚Üí- **Health Clamping**: Fixed overflow bug (was -180000, now 0-100)
    34‚Üí
    35‚Üí### In Progress
    36‚Üí- Wire keybindings context to all level input handlers
    37‚Üí- Weapon switching UI for touch controls
    38‚Üí- E2E test expansion for all levels
    39‚Üí- Ammo/reload system polish
    40‚Üí
    41‚Üí## Campaign Level Status
    42‚Üí
    43‚Üí| Level | Implementation | Tests | Polish |
    44‚Üí|-------|---------------|-------|--------|
    45‚Üí| Anchor Station | ‚úÖ Complete | ‚úÖ E2E | üîÑ Platforming room TODO |
    46‚Üí| Landfall | ‚úÖ Complete | ‚úÖ E2E | ‚úÖ FOV system |
    47‚Üí| FOB Delta | ‚úÖ Complete | üîÑ Basic | üîÑ Enemy AI tuning |
    48‚Üí| Brothers in Arms | ‚úÖ Complete | üîÑ Basic | üîÑ Marcus AI polish |
    49‚Üí| The Breach | ‚úÖ Complete | üîÑ Basic | üîÑ Queen phase tuning |
    50‚Üí| Extraction | ‚úÖ Complete | üîÑ Basic | üîÑ Wave balance |
    51‚Üí
    52‚Üí## Known Issues
    53‚Üí- Touch controls need physical device validation
    54‚Üí- Some levels still have hardcoded key checks (need keybindings context)
    55‚Üí- CanyonLevel factory placeholder (factories.ts:49)
    56‚Üí- ChunkManager mesh loading TODO (ChunkManager.ts:425)
    57‚Üí
    58‚Üí## Deployment
    59‚Üí- **URL**: https://stellar-descent.netlify.app
    60‚Üí- **CI/CD**: GitHub Actions on push to main
    61‚Üí- **Secrets**: NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID configured
    62‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-47-26-486Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-47-26-486Z" class="timestamp-link"><time datetime="2026-01-30T06:47:26.486Z" data-timestamp="2026-01-30T06:47:26.486Z">2026-01-30T06:47:26.486Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01VEseHXToPcGg5qdiTnezE1">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">techContext.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Technical Context

## Technologies
- **Language**: TypeScript 5.9+
- **Runtime**: Browser (Vite 7.x)
- **Node.js**: 22 LTS (pinned via `.nvmrc`)
- **Rendering**: BabylonJS 8.48+ (WebGL2)
- **Physics**: Havok Physics 1.3+
- **ECS**: Miniplex 2.0
- **AI**: Yuka 0.7+
- **Persistence**: SQL.js (SQLite in browser)
- **Audio**: Tone.js 15.x (music), Web Audio API (SFX)
- **Animation**: Anime.js 4.x (DOM only), Manual RAF (Babylon objects)
- **UI**: React 19, CSS Modules

## Development Setup
- **Build Tool**: Vite 7.x
- **Package Manager**: pnpm 10.x
- **Linting**: Biome 2.x
- **Testing**:
  - **Unit**: Vitest 4.x + Happy-DOM
  - **E2E**: Playwright 1.58+
  - **Coverage**: `vitest --coverage`

## CI/CD Pipeline
- **GitHub Actions**: `.github/workflows/ci.yml`
  - Lint check
  - Unit tests
  - Build
  - Netlify deploy (production on main)
- **Deployment**: Netlify
  - Site: `stellar-descent.netlify.app`
  - Secrets: `NETLIFY_AUTH_TOKEN`, `NETLIFY_SITE_ID`

## Key Scripts
```bash
pnpm dev          # Development server
pnpm build        # Production build
pnpm test         # Unit tests (watch)
pnpm test:run     # Unit tests (CI)
pnpm test:e2e     # E2E tests
pnpm test:all     # All tests
pnpm lint         # Biome lint + format
```

## Constraints
- **Mobile Performance**: Optimized for mobile. Limited draw calls, shadow map resolution.
- **No WebGPU**: WebGL2 only for stability and &#34;fail fast&#34; debugging.
- **GLB Models**: Using `AssetManager` for PSX-style GLB model loading.
- **Texture Atlas**: Shared textures via `public/textures/` directory.

## Dependencies

### Core
- `@babylonjs/core`, `@babylonjs/gui`, `@babylonjs/havok`: 3D Engine + Physics
- `@babylonjs/loaders`, `@babylonjs/materials`: Asset loading
- `miniplex`: Entity Component System
- `yuka`: AI behaviors and state machines
- `sql.js`: SQLite database in browser
- `tone`: Music playback system

### UI
- `react`, `react-dom`: UI framework (v19)
- `animejs`: DOM animations only

### Dev
- `vite`, `@vitejs/plugin-react`: Build tooling
- `typescript`: Type checking
- `@biomejs/biome`: Linting/formatting
- `vitest`, `happy-dom`: Unit testing
- `@playwright/test`: E2E testing
- `vite-plugin-pwa`: PWA support
- `vite-plugin-compression`: Build optimization

## Architecture Notes

### State Management
- **GameContext**: Player health, kills, missions, HUD visibility
- **KeybindingsContext**: Configurable controls with localStorage
- **WeaponContext**: Weapon state and switching

### Level System
- **ILevel Interface**: Standard lifecycle (initialize, update, dispose)
- **LevelConfig**: Metadata (chapter, act, spawn positions)
- **LevelCallbacks**: Communication back to game system
- **Linked List**: Levels connect via `nextLevelId`/`previousLevelId`

### Asset Management
- **AssetManager**: Centralized GLB/texture loading
- **PSXModelLoader**: Retro-style model processing
- **AudioManager**: SFX playback with pooling
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-47-26-493Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-47-26-493Z" class="timestamp-link"><time datetime="2026-01-30T06:47:26.493Z" data-timestamp="2026-01-30T06:47:26.493Z">2026-01-30T06:47:26.493Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# Technical Context
     2‚Üí
     3‚Üí## Technologies
     4‚Üí- **Language**: TypeScript 5.9+
     5‚Üí- **Runtime**: Browser (Vite 7.x)
     6‚Üí- **Node.js**: 22 LTS (pinned via `.nvmrc`)
     7‚Üí- **Rendering**: BabylonJS 8.48+ (WebGL2)
     8‚Üí- **Physics**: Havok Physics 1.3+
     9‚Üí- **ECS**: Miniplex 2.0
    10‚Üí- **AI**: Yuka 0.7+
    11‚Üí- **Persistence**: SQL.js (SQLite in browser)
    12‚Üí- **Audio**: Tone.js 15.x (music), Web Audio API (SFX)
    13‚Üí- **Animation**: Anime.js 4.x (DOM only), Manual RAF (Babylon objects)
    14‚Üí- **UI**: React 19, CSS Modules
    15‚Üí
    16‚Üí## Development Setup
    17‚Üí- **Build Tool**: Vite 7.x
    18‚Üí- **Package Manager**: pnpm 10.x
    19‚Üí- **Linting**: Biome 2.x
    20‚Üí- **Testing**:
    21‚Üí  - **Unit**: Vitest 4.x + Happy-DOM
    22‚Üí  - **E2E**: Playwright 1.58+
    23‚Üí  - **Coverage**: `vitest --coverage`
    24‚Üí
    25‚Üí## CI/CD Pipeline
    26‚Üí- **GitHub Actions**: `.github/workflows/ci.yml`
    27‚Üí  - Lint check
    28‚Üí  - Unit tests
    29‚Üí  - Build
    30‚Üí  - Netlify deploy (production on main)
    31‚Üí- **Deployment**: Netlify
    32‚Üí  - Site: `stellar-descent.netlify.app`
    33‚Üí  - Secrets: `NETLIFY_AUTH_TOKEN`, `NETLIFY_SITE_ID`
    34‚Üí
    35‚Üí## Key Scripts
    36‚Üí```bash
    37‚Üípnpm dev          # Development server
    38‚Üípnpm build        # Production build
    39‚Üípnpm test         # Unit tests (watch)
    40‚Üípnpm test:run     # Unit tests (CI)
    41‚Üípnpm test:e2e     # E2E tests
    42‚Üípnpm test:all     # All tests
    43‚Üípnpm lint         # Biome lint + format
    44‚Üí```
    45‚Üí
    46‚Üí## Constraints
    47‚Üí- **Mobile Performance**: Optimized for mobile. Limited draw calls, shadow map resolution.
    48‚Üí- **No WebGPU**: WebGL2 only for stability and &quot;fail fast&quot; debugging.
    49‚Üí- **GLB Models**: Using `AssetManager` for PSX-style GLB model loading.
    50‚Üí- **Texture Atlas**: Shared textures via `public/textures/` directory.
    51‚Üí
    52‚Üí## Dependencies
    53‚Üí
    54‚Üí### Core
    55‚Üí- `@babylonjs/core`, `@babylonjs/gui`, `@babylonjs/havok`: 3D Engine + Physics
    56‚Üí- `@babylonjs/loaders`, `@babylonjs/materials`: Asset loading
    57‚Üí- `miniplex`: Entity Component System
    58‚Üí- `yuka`: AI behaviors and state machines
    59‚Üí- `sql.js`: SQLite database in browser
    60‚Üí- `tone`: Music playback system
    61‚Üí
    62‚Üí### UI
    63‚Üí- `react`, `react-dom`: UI framework (v19)
    64‚Üí- `animejs`: DOM animations only
    65‚Üí
    66‚Üí### Dev
    67‚Üí- `vite`, `@vitejs/plugin-react`: Build tooling
    68‚Üí- `typescript`: Type checking
    69‚Üí- `@biomejs/biome`: Linting/formatting
    70‚Üí- `vitest`, `happy-dom`: Unit testing
    71‚Üí- `@playwright/test`: E2E testing
    72‚Üí- `vite-plugin-pwa`: PWA support
    73‚Üí- `vite-plugin-compression`: Build optimization
    74‚Üí
    75‚Üí## Architecture Notes
    76‚Üí
    77‚Üí### State Management
    78‚Üí- **GameContext**: Player health, kills, missions, HUD visibility
    79‚Üí- **KeybindingsContext**: Configurable controls with localStorage
    80‚Üí- **WeaponContext**: Weapon state and switching
    81‚Üí
    82‚Üí### Level System
    83‚Üí- **ILevel Interface**: Standard lifecycle (initialize, update, dispose)
    84‚Üí- **LevelConfig**: Metadata (chapter, act, spawn positions)
    85‚Üí- **LevelCallbacks**: Communication back to game system
    86‚Üí- **Linked List**: Levels connect via `nextLevelId`/`previousLevelId`
    87‚Üí
    88‚Üí### Asset Management
    89‚Üí- **AssetManager**: Centralized GLB/texture loading
    90‚Üí- **PSXModelLoader**: Retro-style model processing
    91‚Üí- **AudioManager**: SFX playback with pooling
    92‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-47-47-800Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-47-47-800Z" class="timestamp-link"><time datetime="2026-01-30T06:47:47.800Z" data-timestamp="2026-01-30T06:47:47.800Z">2026-01-30T06:47:47.800Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01UjNv9wBBQZeC39DMMRpXRz">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">systemPatterns.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># System Patterns

## System Overview
The application follows a strict hierarchical flow:
`App.tsx` -&gt; `GameCanvas.tsx` -&gt; `Level` (ILevel implementations) -&gt; Systems

## Core Architecture

### Entry Point
- **App.tsx**: Provider hierarchy: `KeybindingsProvider` -&gt; `GameProvider` -&gt; `WeaponProvider` -&gt; `GameUI`
- **GameCanvas.tsx**: React component hosting BabylonJS canvas and coordinating levels

### Context Providers
```
KeybindingsProvider (controls config)
  ‚îî‚îÄ GameProvider (game state)
      ‚îî‚îÄ WeaponProvider (weapon state)
          ‚îî‚îÄ GameUI (main component)
```

### Level System
- **ILevel Interface**: All levels implement standard lifecycle:
  - `initialize()`: Setup scene, assets, entities
  - `update(deltaTime)`: Frame update logic
  - `dispose()`: Cleanup resources
- **LevelConfig**: Metadata per level (chapter, act, spawn, music tracks)
- **LevelCallbacks**: Events from level to game (onCommsMessage, onKill, etc.)
- **Campaign Structure**: Linked list via `nextLevelId`/`previousLevelId`

### Entity Component System (ECS)
- **Library**: Miniplex
- **Usage**: All game objects are entities with data components
- **Queries**: `world.with(&#39;ai&#39;, &#39;transform&#39;)` for system processing
- **Components**: Transform, Health, Velocity, AI, Weapon, etc.

### AI System
- **Library**: Yuka
- **Pattern**: Finite State Machine (FSM)
- **States**: Idle, Patrol, Chase, Attack, Flee, Support
- **Behaviors**: Wander, Seek, Pursuit, Flee, Arrive

### World Generation
- **Chunk System**: 100x100 unit chunks
- **Procedural**: Deterministic generation from coordinates + seed
- **Persistence**: SQL.js stores chunk state locally

## Data Flow

### Input Flow
1. Keyboard/Touch -&gt; `KeybindingsContext` (mapping)
2. Mapped actions -&gt; Level&#39;s input handler
3. Handler -&gt; Player entity updates

### Game Loop
1. `requestAnimationFrame` -&gt; Level&#39;s `update(deltaTime)`
2. Level updates: AI, Physics, Combat, Spawning
3. BabylonJS renders scene

### State Communication
- **Level -&gt; Game**: Via `LevelCallbacks` (onKill, onDamage, onCommsMessage)
- **Game -&gt; UI**: Via `GameContext` (health, kills, objectives)
- **UI -&gt; Level**: Via touch input / action triggers

## Key Patterns

### Ref-Based Updates
```typescript
// Avoid stale closures in RAF loops
const playerHealthRef = useRef(playerHealth);
useEffect(() =&gt; { playerHealthRef.current = playerHealth; }, [playerHealth]);
```

### Level Lifecycle
```typescript
// Level initialization pattern
async initialize() {
  await this.setupScene();
  await this.loadAssets();
  this.setupPlayer();
  this.setupEnemies();
  this.startGameLoop();
}
```

### Action Button System
- Levels can register dynamic action buttons via `onActionGroupsChange`
- Handlers registered via `onActionHandlerRegister`
- UI triggers actions via `triggerAction(actionId)`

### HUD Visibility
- Progressive unlocking during tutorial
- `setHUDVisibility({ healthBar: true, crosshair: true })`
- Default is all visible, tutorial starts minimal

## File Organization

### Level Structure
```
src/game/levels/{level-name}/
‚îú‚îÄ‚îÄ index.ts              # Exports
‚îú‚îÄ‚îÄ {LevelName}Level.ts   # Main level class
‚îú‚îÄ‚îÄ environment.ts        # Mesh/scene setup
‚îú‚îÄ‚îÄ enemies.ts           # Enemy spawning/AI
‚îú‚îÄ‚îÄ materials.ts         # Textures/materials
‚îî‚îÄ‚îÄ {LevelName}Level.module.css  # Styles
```

### Context Structure
```
src/game/context/
‚îú‚îÄ‚îÄ GameContext.tsx       # Main game state
‚îú‚îÄ‚îÄ KeybindingsContext.tsx # Control bindings
‚îî‚îÄ‚îÄ WeaponContext.tsx     # Weapon state
```

### Component Structure
```
src/components/
‚îú‚îÄ‚îÄ GameCanvas.tsx        # Main 3D canvas
‚îî‚îÄ‚îÄ ui/
    ‚îú‚îÄ‚îÄ HUD.tsx           # In-game overlay
    ‚îú‚îÄ‚îÄ MainMenu.tsx      # Title screen
    ‚îú‚îÄ‚îÄ SettingsMenu.tsx  # Keybindings UI
    ‚îú‚îÄ‚îÄ DeathScreen.tsx   # Game over
    ‚îú‚îÄ‚îÄ TouchControls.tsx # Mobile input
    ‚îî‚îÄ‚îÄ CommsDisplay.tsx  # Dialogue system
```
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-47-47-806Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-47-47-806Z" class="timestamp-link"><time datetime="2026-01-30T06:47:47.806Z" data-timestamp="2026-01-30T06:47:47.806Z">2026-01-30T06:47:47.806Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# System Patterns
     2‚Üí
     3‚Üí## System Overview
     4‚ÜíThe application follows a strict hierarchical flow:
     5‚Üí`App.tsx` -&gt; `GameCanvas.tsx` -&gt; `Level` (ILevel implementations) -&gt; Systems
     6‚Üí
     7‚Üí## Core Architecture
     8‚Üí
     9‚Üí### Entry Point
    10‚Üí- **App.tsx**: Provider hierarchy: `KeybindingsProvider` -&gt; `GameProvider` -&gt; `WeaponProvider` -&gt; `GameUI`
    11‚Üí- **GameCanvas.tsx**: React component hosting BabylonJS canvas and coordinating levels
    12‚Üí
    13‚Üí### Context Providers
    14‚Üí```
    15‚ÜíKeybindingsProvider (controls config)
    16‚Üí  ‚îî‚îÄ GameProvider (game state)
    17‚Üí      ‚îî‚îÄ WeaponProvider (weapon state)
    18‚Üí          ‚îî‚îÄ GameUI (main component)
    19‚Üí```
    20‚Üí
    21‚Üí### Level System
    22‚Üí- **ILevel Interface**: All levels implement standard lifecycle:
    23‚Üí  - `initialize()`: Setup scene, assets, entities
    24‚Üí  - `update(deltaTime)`: Frame update logic
    25‚Üí  - `dispose()`: Cleanup resources
    26‚Üí- **LevelConfig**: Metadata per level (chapter, act, spawn, music tracks)
    27‚Üí- **LevelCallbacks**: Events from level to game (onCommsMessage, onKill, etc.)
    28‚Üí- **Campaign Structure**: Linked list via `nextLevelId`/`previousLevelId`
    29‚Üí
    30‚Üí### Entity Component System (ECS)
    31‚Üí- **Library**: Miniplex
    32‚Üí- **Usage**: All game objects are entities with data components
    33‚Üí- **Queries**: `world.with(&#x27;ai&#x27;, &#x27;transform&#x27;)` for system processing
    34‚Üí- **Components**: Transform, Health, Velocity, AI, Weapon, etc.
    35‚Üí
    36‚Üí### AI System
    37‚Üí- **Library**: Yuka
    38‚Üí- **Pattern**: Finite State Machine (FSM)
    39‚Üí- **States**: Idle, Patrol, Chase, Attack, Flee, Support
    40‚Üí- **Behaviors**: Wander, Seek, Pursuit, Flee, Arrive
    41‚Üí
    42‚Üí### World Generation
    43‚Üí- **Chunk System**: 100x100 unit chunks
    44‚Üí- **Procedural**: Deterministic generation from coordinates + seed
    45‚Üí- **Persistence**: SQL.js stores chunk state locally
    46‚Üí
    47‚Üí## Data Flow
    48‚Üí
    49‚Üí### Input Flow
    50‚Üí1. Keyboard/Touch -&gt; `KeybindingsContext` (mapping)
    51‚Üí2. Mapped actions -&gt; Level&#x27;s input handler
    52‚Üí3. Handler -&gt; Player entity updates
    53‚Üí
    54‚Üí### Game Loop
    55‚Üí1. `requestAnimationFrame` -&gt; Level&#x27;s `update(deltaTime)`
    56‚Üí2. Level updates: AI, Physics, Combat, Spawning
    57‚Üí3. BabylonJS renders scene
    58‚Üí
    59‚Üí### State Communication
    60‚Üí- **Level -&gt; Game**: Via `LevelCallbacks` (onKill, onDamage, onCommsMessage)
    61‚Üí- **Game -&gt; UI**: Via `GameContext` (health, kills, objectives)
    62‚Üí- **UI -&gt; Level**: Via touch input / action triggers
    63‚Üí
    64‚Üí## Key Patterns
    65‚Üí
    66‚Üí### Ref-Based Updates
    67‚Üí```typescript
    68‚Üí// Avoid stale closures in RAF loops
    69‚Üíconst playerHealthRef = useRef(playerHealth);
    70‚ÜíuseEffect(() =&gt; { playerHealthRef.current = playerHealth; }, [playerHealth]);
    71‚Üí```
    72‚Üí
    73‚Üí### Level Lifecycle
    74‚Üí```typescript
    75‚Üí// Level initialization pattern
    76‚Üíasync initialize() {
    77‚Üí  await this.setupScene();
    78‚Üí  await this.loadAssets();
    79‚Üí  this.setupPlayer();
    80‚Üí  this.setupEnemies();
    81‚Üí  this.startGameLoop();
    82‚Üí}
    83‚Üí```
    84‚Üí
    85‚Üí### Action Button System
    86‚Üí- Levels can register dynamic action buttons via `onActionGroupsChange`
    87‚Üí- Handlers registered via `onActionHandlerRegister`
    88‚Üí- UI triggers actions via `triggerAction(actionId)`
    89‚Üí
    90‚Üí### HUD Visibility
    91‚Üí- Progressive unlocking during tutorial
    92‚Üí- `setHUDVisibility({ healthBar: true, crosshair: true })`
    93‚Üí- Default is all visible, tutorial starts minimal
    94‚Üí
    95‚Üí## File Organization
    96‚Üí
    97‚Üí### Level Structure
    98‚Üí```
    99‚Üísrc/game/levels/{level-name}/
   100‚Üí‚îú‚îÄ‚îÄ index.ts              # Exports
   101‚Üí‚îú‚îÄ‚îÄ {LevelName}Level.ts   # Main level class
   102‚Üí‚îú‚îÄ‚îÄ environment.ts        # Mesh/scene setup
   103‚Üí‚îú‚îÄ‚îÄ enemies.ts           # Enemy spawning/AI
   104‚Üí‚îú‚îÄ‚îÄ materials.ts         # Textures/materials
   105‚Üí‚îî‚îÄ‚îÄ {LevelName}Level.module.css  # Styles
   106‚Üí```
   107‚Üí
   108‚Üí### Context Structure
   109‚Üí```
   110‚Üísrc/game/context/
   111‚Üí‚îú‚îÄ‚îÄ GameContext.tsx       # Main game state
   112‚Üí‚îú‚îÄ‚îÄ KeybindingsContext.tsx # Control bindings
   113‚Üí‚îî‚îÄ‚îÄ WeaponContext.tsx     # Weapon state
   114‚Üí```
   115‚Üí
   116‚Üí### Component Structure
   117‚Üí```
   118‚Üísrc/components/
   119‚Üí‚îú‚îÄ‚îÄ GameCanvas.tsx        # Main 3D canvas
   120‚Üí‚îî‚îÄ‚îÄ ui/
   121‚Üí    ‚îú‚îÄ‚îÄ HUD.tsx           # In-game overlay
   122‚Üí    ‚îú‚îÄ‚îÄ MainMenu.tsx      # Title screen
   123‚Üí    ‚îú‚îÄ‚îÄ SettingsMenu.tsx  # Keybindings UI
   124‚Üí    ‚îú‚îÄ‚îÄ DeathScreen.tsx   # Game over
   125‚Üí    ‚îú‚îÄ‚îÄ TouchControls.tsx # Mobile input
   126‚Üí    ‚îî‚îÄ‚îÄ CommsDisplay.tsx  # Dialogue system
   127‚Üí```
   128‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-48-03-423Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-48-03-423Z" class="timestamp-link"><time datetime="2026-01-30T06:48:03.423Z" data-timestamp="2026-01-30T06:48:03.423Z">2026-01-30T06:48:03.423Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01Erv3XkbY1SMxkFAXJVWEUQ">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">productContext.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Product Context

## The Narrative
The year is 3147 CE. Humanity has spread to Proxima Centauri b (&#34;Kepler&#39;s Promise&#34;). The Terran Expansion Authority (TEA) oversees colonization.

The player controls **Sergeant James Cole (Callsign: SPECTER)**, a &#34;Hell Jumper&#34; marine.

**The Mission**: Find his brother, **Corporal Marcus Cole (Callsign: HAMMER)**, who went missing with Recon Team Vanguard at FOB Delta.

## Campaign Structure

### ACT 1: THE DROP
1. **Anchor Station Prometheus** (Tutorial) - Prep Bay 7 briefing, equipment, shooting range
2. **Landfall** - HALO drop to planet surface, first contact with Chitin

### ACT 2: THE SEARCH
3. **FOB Delta** - Investigate abandoned forward operating base, horror atmosphere
4. **Brothers in Arms** - Reunite with Marcus in his Titan mech, wave-based combat

### ACT 3: THE TRUTH
5. **Into the Breach** - Descend into Chitin hive, face the Queen
6. **Extraction** - Escape collapsing hive, holdout at LZ Omega until evac

## The Enemy
**Strain-X / &#34;Chitin&#34;**: An insectoid hive species living deep underground, awakened by mining operations.

### Enemy Variants
- **Drones**: Fast, weak scouts
- **Grunts**: Standard melee attackers
- **Brutes**: Heavy, slow, high damage
- **Spitters**: Ranged acid attacks
- **Queen**: Boss enemy, multiple phases

## Characters

### James Cole (SPECTER)
- Player character
- Hell Jumper sergeant
- Tactical, determined

### Marcus Cole (HAMMER)
- James&#39;s brother
- Pilots a Titan-class mech
- Allied NPC in Level 4+

### AI Command (MOTHER)
- Ship AI providing mission updates
- Comms dialogue throughout game

## User Experience Goals
- **Grounded &amp; Human**: Military story about brotherhood
- **Visceral Combat**: Heavy weapons, tactical movement
- **Exploration**: Procedurally generated areas
- **Persistence**: World state saved locally
- **Mobile-First**: Works on phones in landscape mode

## Design Guidelines
- **Visuals**: Military equipment, worn/battle-tested, high contrast
- **Colors**: Olive, khaki, brass - NO cyberpunk (no neon/purple/blue)
- **UI**: Utilitarian, functional, HUD-style
- **Controls**: Optimized for touch (DOOM-style joysticks)
- **Audio**: Dynamic music system (combat/exploration/boss tracks)
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-48-03-428Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-48-03-428Z" class="timestamp-link"><time datetime="2026-01-30T06:48:03.428Z" data-timestamp="2026-01-30T06:48:03.428Z">2026-01-30T06:48:03.428Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# Product Context
     2‚Üí
     3‚Üí## The Narrative
     4‚ÜíThe year is 3147 CE. Humanity has spread to Proxima Centauri b (&quot;Kepler&#x27;s Promise&quot;). The Terran Expansion Authority (TEA) oversees colonization.
     5‚Üí
     6‚ÜíThe player controls **Sergeant James Cole (Callsign: SPECTER)**, a &quot;Hell Jumper&quot; marine.
     7‚Üí
     8‚Üí**The Mission**: Find his brother, **Corporal Marcus Cole (Callsign: HAMMER)**, who went missing with Recon Team Vanguard at FOB Delta.
     9‚Üí
    10‚Üí## Campaign Structure
    11‚Üí
    12‚Üí### ACT 1: THE DROP
    13‚Üí1. **Anchor Station Prometheus** (Tutorial) - Prep Bay 7 briefing, equipment, shooting range
    14‚Üí2. **Landfall** - HALO drop to planet surface, first contact with Chitin
    15‚Üí
    16‚Üí### ACT 2: THE SEARCH
    17‚Üí3. **FOB Delta** - Investigate abandoned forward operating base, horror atmosphere
    18‚Üí4. **Brothers in Arms** - Reunite with Marcus in his Titan mech, wave-based combat
    19‚Üí
    20‚Üí### ACT 3: THE TRUTH
    21‚Üí5. **Into the Breach** - Descend into Chitin hive, face the Queen
    22‚Üí6. **Extraction** - Escape collapsing hive, holdout at LZ Omega until evac
    23‚Üí
    24‚Üí## The Enemy
    25‚Üí**Strain-X / &quot;Chitin&quot;**: An insectoid hive species living deep underground, awakened by mining operations.
    26‚Üí
    27‚Üí### Enemy Variants
    28‚Üí- **Drones**: Fast, weak scouts
    29‚Üí- **Grunts**: Standard melee attackers
    30‚Üí- **Brutes**: Heavy, slow, high damage
    31‚Üí- **Spitters**: Ranged acid attacks
    32‚Üí- **Queen**: Boss enemy, multiple phases
    33‚Üí
    34‚Üí## Characters
    35‚Üí
    36‚Üí### James Cole (SPECTER)
    37‚Üí- Player character
    38‚Üí- Hell Jumper sergeant
    39‚Üí- Tactical, determined
    40‚Üí
    41‚Üí### Marcus Cole (HAMMER)
    42‚Üí- James&#x27;s brother
    43‚Üí- Pilots a Titan-class mech
    44‚Üí- Allied NPC in Level 4+
    45‚Üí
    46‚Üí### AI Command (MOTHER)
    47‚Üí- Ship AI providing mission updates
    48‚Üí- Comms dialogue throughout game
    49‚Üí
    50‚Üí## User Experience Goals
    51‚Üí- **Grounded &amp; Human**: Military story about brotherhood
    52‚Üí- **Visceral Combat**: Heavy weapons, tactical movement
    53‚Üí- **Exploration**: Procedurally generated areas
    54‚Üí- **Persistence**: World state saved locally
    55‚Üí- **Mobile-First**: Works on phones in landscape mode
    56‚Üí
    57‚Üí## Design Guidelines
    58‚Üí- **Visuals**: Military equipment, worn/battle-tested, high contrast
    59‚Üí- **Colors**: Olive, khaki, brass - NO cyberpunk (no neon/purple/blue)
    60‚Üí- **UI**: Utilitarian, functional, HUD-style
    61‚Üí- **Controls**: Optimized for touch (DOOM-style joysticks)
    62‚Üí- **Audio**: Dynamic music system (combat/exploration/boss tracks)
    63‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-48-17-213Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-48-17-213Z" class="timestamp-link"><time datetime="2026-01-30T06:48:17.213Z" data-timestamp="2026-01-30T06:48:17.213Z">2026-01-30T06:48:17.213Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01NMHLqSRwV7V8zmQzJWgYvS">
<div class="file-tool-header write-header"><span class="file-tool-icon">üìù</span> Write <span class="file-tool-path">projectbrief.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Project Brief

**STELLAR DESCENT: PROXIMA BREACH** is a mobile-first, 3D arcade shooter built with BabylonJS. The game features a 6-level story campaign, dynamic enemy AI, and a persistent world state.

## Core Philosophy
1. **Mobile-first**: All UI and controls must work on phones first, then scale up.
2. **Military aesthetic**: Olive, khaki, brass colors. NO cyberpunk (no neon, no purple/blue gradients).
3. **Harsh lighting**: Bright alien sun, high contrast, HDR visuals.
4. **Persistent world**: Areas remember their state when revisited.
5. **Story-driven**: Clear narrative about brotherhood and survival.

## Critical Development Rules
- **NO FALLBACKS**: Code should fail fast and explicitly.
- **Fail Fast**: If WebGPU fails, show the error. Do not fallback to WebGL1.
- **No anime.js for Babylon Objects**: Use `requestAnimationFrame` loops for mesh/material animations.
- **Test Coverage**: Unit tests (Vitest) and E2E tests (Playwright) required.
- **CI/CD**: All changes go through GitHub Actions, deploy to Netlify.

## Key Technical Decisions
- **Engine**: BabylonJS 8.x (WebGL2 only)
- **Physics**: Havok
- **ECS**: Miniplex
- **AI**: Yuka
- **Persistence**: SQL.js (SQLite in browser)
- **Audio**: Tone.js (music), Web Audio API (SFX)
- **Styling**: CSS Modules with Design Tokens
- **Node.js**: 22 LTS (pinned in `.nvmrc`)
- **Package Manager**: pnpm 10.x

## Campaign Overview
6 levels across 3 acts:
1. Anchor Station (Tutorial)
2. Landfall (HALO Drop)
3. FOB Delta (Horror/Investigation)
4. Brothers in Arms (Mech Ally Combat)
5. The Breach (Boss Fight)
6. Extraction (Escape Sequence)

## Deployment
- **URL**: https://stellar-descent.netlify.app
- **CI/CD**: GitHub Actions -&gt; Netlify
- **Branch**: `main` for production deploys

## Repository Structure
```
stellar-descent/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/     # React UI components
‚îÇ   ‚îú‚îÄ‚îÄ game/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/    # GameContext, KeybindingsContext, WeaponContext
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/       # AudioManager, AssetManager, PSXModelLoader
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecs/        # ECS components and systems
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels/     # Campaign levels (6 total)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ systems/    # Combat, AI, Player systems
‚îÇ   ‚îî‚îÄ‚îÄ App.tsx
‚îú‚îÄ‚îÄ e2e/                # Playwright E2E tests
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îú‚îÄ‚îÄ models/         # GLB model files
‚îÇ   ‚îî‚îÄ‚îÄ textures/       # Texture atlas
‚îú‚îÄ‚îÄ docs/
‚îÇ   ‚îî‚îÄ‚îÄ memory-bank/    # AI context files
‚îî‚îÄ‚îÄ .github/workflows/  # CI/CD configuration
```
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-48-17-217Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-48-17-217Z" class="timestamp-link"><time datetime="2026-01-30T06:48:17.217Z" data-timestamp="2026-01-30T06:48:17.217Z">2026-01-30T06:48:17.217Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1‚Üí# Project Brief
     2‚Üí
     3‚Üí**STELLAR DESCENT: PROXIMA BREACH** is a mobile-first, 3D arcade shooter built with BabylonJS. The game features a 6-level story campaign, dynamic enemy AI, and a persistent world state.
     4‚Üí
     5‚Üí## Core Philosophy
     6‚Üí1. **Mobile-first**: All UI and controls must work on phones first, then scale up.
     7‚Üí2. **Military aesthetic**: Olive, khaki, brass colors. NO cyberpunk (no neon, no purple/blue gradients).
     8‚Üí3. **Harsh lighting**: Bright alien sun, high contrast, HDR visuals.
     9‚Üí4. **Persistent world**: Areas remember their state when revisited.
    10‚Üí5. **Story-driven**: Clear narrative about brotherhood and survival.
    11‚Üí
    12‚Üí## Critical Development Rules
    13‚Üí- **NO FALLBACKS**: Code should fail fast and explicitly.
    14‚Üí- **Fail Fast**: If WebGPU fails, show the error. Do not fallback to WebGL1.
    15‚Üí- **No anime.js for Babylon Objects**: Use `requestAnimationFrame` loops for mesh/material animations.
    16‚Üí- **Test Coverage**: Unit tests (Vitest) and E2E tests (Playwright) required.
    17‚Üí- **CI/CD**: All changes go through GitHub Actions, deploy to Netlify.
    18‚Üí
    19‚Üí## Key Technical Decisions
    20‚Üí- **Engine**: BabylonJS 8.x (WebGL2 only)
    21‚Üí- **Physics**: Havok
    22‚Üí- **ECS**: Miniplex
    23‚Üí- **AI**: Yuka
    24‚Üí- **Persistence**: SQL.js (SQLite in browser)
    25‚Üí- **Audio**: Tone.js (music), Web Audio API (SFX)
    26‚Üí- **Styling**: CSS Modules with Design Tokens
    27‚Üí- **Node.js**: 22 LTS (pinned in `.nvmrc`)
    28‚Üí- **Package Manager**: pnpm 10.x
    29‚Üí
    30‚Üí## Campaign Overview
    31‚Üí6 levels across 3 acts:
    32‚Üí1. Anchor Station (Tutorial)
    33‚Üí2. Landfall (HALO Drop)
    34‚Üí3. FOB Delta (Horror/Investigation)
    35‚Üí4. Brothers in Arms (Mech Ally Combat)
    36‚Üí5. The Breach (Boss Fight)
    37‚Üí6. Extraction (Escape Sequence)
    38‚Üí
    39‚Üí## Deployment
    40‚Üí- **URL**: https://stellar-descent.netlify.app
    41‚Üí- **CI/CD**: GitHub Actions -&gt; Netlify
    42‚Üí- **Branch**: `main` for production deploys
    43‚Üí
    44‚Üí## Repository Structure
    45‚Üí```
    46‚Üístellar-descent/
    47‚Üí‚îú‚îÄ‚îÄ src/
    48‚Üí‚îÇ   ‚îú‚îÄ‚îÄ components/     # React UI components
    49‚Üí‚îÇ   ‚îú‚îÄ‚îÄ game/
    50‚Üí‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ context/    # GameContext, KeybindingsContext, WeaponContext
    51‚Üí‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ core/       # AudioManager, AssetManager, PSXModelLoader
    52‚Üí‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ ecs/        # ECS components and systems
    53‚Üí‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ levels/     # Campaign levels (6 total)
    54‚Üí‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ systems/    # Combat, AI, Player systems
    55‚Üí‚îÇ   ‚îî‚îÄ‚îÄ App.tsx
    56‚Üí‚îú‚îÄ‚îÄ e2e/                # Playwright E2E tests
    57‚Üí‚îú‚îÄ‚îÄ public/
    58‚Üí‚îÇ   ‚îú‚îÄ‚îÄ models/         # GLB model files
    59‚Üí‚îÇ   ‚îî‚îÄ‚îÄ textures/       # Texture atlas
    60‚Üí‚îú‚îÄ‚îÄ docs/
    61‚Üí‚îÇ   ‚îî‚îÄ‚îÄ memory-bank/    # AI context files
    62‚Üí‚îî‚îÄ‚îÄ .github/workflows/  # CI/CD configuration
    63‚Üí```
    64‚Üí</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-48-21-911Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-48-21-911Z" class="timestamp-link"><time datetime="2026-01-30T06:48:21.911Z" data-timestamp="2026-01-30T06:48:21.911Z">2026-01-30T06:48:21.911Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>All 6 memory bank files have been updated. Now I should provide a summary to the user of what was done and the gaps that were identified. The user asked for a thorough codebase review to find incomplete implementations or gaps, which I've documented in the activeContext.md file.</p>
<p>Let me summarize the key findings for the user.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-48-31-813Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-48-31-813Z" class="timestamp-link"><time datetime="2026-01-30T06:48:31.813Z" data-timestamp="2026-01-30T06:48:31.813Z">2026-01-30T06:48:31.813Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Memory bank has been updated. All 6 files now reflect the current project state. Here's a summary of the codebase review findings:</p>
<h2>Memory Bank Update Complete</h2>
<p>Updated from Phase 3 (Tutorial) to Phase 5 (Polish &amp; CI/CD), documenting:
- Full 6-level campaign implementation
- Node 22 LTS migration, Netlify deployment, CI/CD pipeline
- Keybindings system, Tone.js music, death/restart flow
- Health clamping fix, HALO drop FOV, landscape enforcement</p>
<h2>Identified Gaps &amp; TODOs</h2>
<h3>Code TODOs Found (4)</h3>
<table>
<thead>
<tr>
<th>Location</th>
<th>Issue</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ChunkManager.ts:425</code></td>
<td>Load actual mesh from modelPath</td>
</tr>
<tr>
<td><code>factories.ts:49</code></td>
<td>Implement CanyonLevel factory</td>
</tr>
<tr>
<td><code>environment.ts:1994</code></td>
<td>Implement platforming room (Anchor Station)</td>
</tr>
<tr>
<td><code>TouchControls.tsx:317</code></td>
<td>Implement weapon switching button</td>
</tr>
</tbody>
</table>
<h3>Incomplete Integrations</h3>
<ol>
<li><strong>Keybindings Context</strong>: Exists with full settings UI but some levels still have hardcoded key checks instead of using the context</li>
<li><strong>WeaponContext</strong>: Provider exists but limited integration with HUD and touch controls</li>
<li><strong>Compass Data</strong>: <code>compassData</code> in GameContext is populated but minimal HUD usage</li>
</ol>
<h3>Test Coverage Gaps</h3>
<table>
<thead>
<tr>
<th>Level</th>
<th>E2E Status</th>
</tr>
</thead>
<tbody>
<tr>
<td>Anchor Station</td>
<td>‚úÖ Full</td>
</tr>
<tr>
<td>Landfall</td>
<td>‚úÖ Full</td>
</tr>
<tr>
<td>FOB Delta</td>
<td>üîÑ Basic</td>
</tr>
<tr>
<td>Brothers in Arms</td>
<td>üîÑ Basic</td>
</tr>
<tr>
<td>The Breach</td>
<td>üîÑ Basic</td>
</tr>
<tr>
<td>Extraction</td>
<td>üîÑ Basic</td>
</tr>
</tbody>
</table>
<h3>Polish Needed</h3>
<ul>
<li>Enemy AI tuning (FOB Delta, The Breach)</li>
<li>Marcus ally AI behavior (Brothers in Arms)</li>
<li>Queen phase timing (The Breach)</li>
<li>Wave balance (Extraction)</li>
</ul>
<p>The activeContext.md now contains all gaps in the "Identified Gaps" section for future reference.</p></div></div></div>
<div class="message user" id="msg-2026-01-30T06-50-26-168Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T06-50-26-168Z" class="timestamp-link"><time datetime="2026-01-30T06:50:26.168Z" data-timestamp="2026-01-30T06:50:26.168Z">2026-01-30T06:50:26.168Z</time></a></div><div class="message-content">
<div class="user-content"><p>Let's fix all of that witgh subagents, make sure our tech context and sys patterns are all iup to date, also do a pass through DOCS/, and then oh! Also check out ~/assets/full bot.blend. We'd probably have to texture it OuRSELVES with ~/assets/AmbientCG but that's not a big deal. Some metals, coat of paint. We've got
  ourselves Marcus in a mech!. Also check out ~/assets/ for TWO RARs RIFLE PACK.rar and FEMALE MARINE....rar It's got a long name, list the dir and you'll find them. One has
  female marines in a casual pose set others with rifles ready. ALSO check out ~/assets/assets spaceship I suspect those would be WICKED for our space base. Maybe we could even
  set the ENTIRE scenes using them. ALSO check out the Echos from the Deep PDF in ~/assets AND ~/assets/EchosFromTheDeep</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-32-132Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-32-132Z" class="timestamp-link"><time datetime="2026-01-30T06:50:32.132Z" data-timestamp="2026-01-30T06:50:32.132Z">2026-01-30T06:50:32.132Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>The user wants me to:
1. Fix all the identified gaps using subagents
2. Update tech context and system patterns (already done, but should verify)
3. Do a pass through DOCS/
4. Check out ~/assets/full bot.blend - a mech model for Marcus
5. Check out ~/assets/ for two RAR files - rifle pack and female marines
6. Check out ~/assets/assets spaceship for space base assets
7. Check out the Echos from the Deep PDF in ~/assets
8. Check out ~/assets/EchosFromTheDeep</p>
<p>This is a lot of parallel work. Let me launch multiple agents to handle these tasks concurrently:</p>
<ol>
<li>One agent to fix the TODOs (ChunkManager, factories, environment, TouchControls)</li>
<li>One agent to wire keybindings context to levels</li>
<li>One agent to review DOCS/</li>
<li>One agent to explore ~/assets/ and catalog what's there</li>
</ol>
<p>Let me start by exploring the assets directory and launching the fix agents.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-32-815Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-32-815Z" class="timestamp-link"><time datetime="2026-01-30T06:50:32.815Z" data-timestamp="2026-01-30T06:50:32.815Z">2026-01-30T06:50:32.815Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Let me launch multiple agents in parallel to handle all of this work efficiently.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-33-468Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-33-468Z" class="timestamp-link"><time datetime="2026-01-30T06:50:33.468Z" data-timestamp="2026-01-30T06:50:33.468Z">2026-01-30T06:50:33.468Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01QNEhNnCvyPnqaDBW3PMy31">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List assets directory contents</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-33-558Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-33-558Z" class="timestamp-link"><time datetime="2026-01-30T06:50:33.558Z" data-timestamp="2026-01-30T06:50:33.558Z">2026-01-30T06:50:33.558Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 1337416
drwxr-xr-x  53 jbogaty staff      1696 Jan 30 00:37 .
drwxr-x--- 236 jbogaty staff      7552 Jan 30 00:38 ..
-rw-r--r--   1 jbogaty staff  12642998 Nov 12 14:06 .asset-index-cache.json
-rw-r--r--   1 jbogaty staff     10244 Jan 30 00:37 .DS_Store
-rw-r--r--   1 jbogaty staff   7089741 Jan 29 22:51 3DAlienMonsterCharacter.unitypackage
drwxr-xr-x  13 jbogaty staff       416 Jan 29 22:52 alienfemale-blender
-rw-r--r--   1 jbogaty staff  25362338 Jan 29 22:52 alienfemale-blender.zip
drwxr-xr-x  12 jbogaty staff       384 Jan 29 22:55 AlienMale-Blender
-rw-r--r--   1 jbogaty staff  24856464 Jan 29 22:55 AlienMale-Blender.zip
drwxr-xr-x   6 jbogaty staff       192 Jan 29 22:57 AlienPackVol1
drwxr-xr-x   3 jbogaty staff        96 Jan 29 23:07 AlienPackVol1_exported
drwxr-xr-x   7 jbogaty staff       224 Jan 29 23:10 AlienPackVol1_glb
-rw-r--r--   1 jbogaty staff  18174640 Jan 29 22:57 AlienPackVol1.7z
drwx------   5 jbogaty staff       160 Nov 12 17:46 AmbientCG
-rw-r--r--   1 jbogaty staff  16259476 Nov 12 14:06 asset-inventory-manifest.json
drwx------  16 jbogaty staff       512 Jan 30 00:36 assets spaceship
-rw-r--r--   1 jbogaty staff 120215808 Jan 30 00:36 assets spaceship.zip
drwxrwxr-x   5 jbogaty staff       160 Jan 22  2024 EchosFromTheDeep
-rw-r--r--   1 jbogaty staff  54889292 Jan 30 00:37 EchosFromTheDeep.zip
drwx------   9 jbogaty staff       288 Jan 28 23:08 Fantasy Props MegaKit[Standard]
drwx------   4 jbogaty staff       128 Jan 29 22:57 fbx_extracted
-rw-r--r--   1 jbogaty staff   5605192 Jan 29 22:51 fbx.rar
-rw-r--r--   1 jbogaty staff 184021854 Jan 30 00:35 FEMALE MARINE- CASUAL PACK.rar
drwxr-xr-x   6 jbogaty staff       192 Jan 27 13:53 Fluid_Kit
-rw-r--r--   1 jbogaty staff   1497124 Jan 30 00:32 full bot.blend
drwxr-xr-x  19 jbogaty staff       608 Jan 29 23:14 game_ready_glb
drwxr-xr-x  22 jbogaty staff       704 Jan 28 03:11 incoming
drwxrwxr-x  11 jbogaty staff       352 Oct 27 10:54 KayKit_Adventurers_1.0_EXTRA
drwxrwxrwx  12 jbogaty staff       384 Jan 28 23:23 KayKit_Adventurers_2.0_FREE
drwxrwxr-x  10 jbogaty staff       320 Jan 28 23:07 KayKit_DungeonRemastered_1.1_FREE
drwxrwxr-x  15 jbogaty staff       480 Apr 26  2024 KayKit_Medieval_Hexagon_Pack_1.0_EXTRA
drwxrwxrwx  12 jbogaty staff       384 Oct 22 07:59 KayKit_Skeletons_1.1_FREE
drwx------  15 jbogaty staff       480 Oct 27 10:55 Kenney
drwx------  17 jbogaty staff       544 Jan 24 00:21 Low poly Western Objects
drwx------   6 jbogaty staff       192 Jan 29 22:54 lowpoly_alien_buildings_nonunity
-rw-r--r--   1 jbogaty staff 135345168 Jan 29 22:54 lowpoly_alien_buildings_nonunity.zip
drwxr-xr-x   6 jbogaty staff       192 Nov 12 14:06 manifests
drwxrwxr-x   8 jbogaty staff       256 Jan 21  2025 Medieval Village MegaKit[Standard]
drwx------   5 jbogaty staff       160 Jan 28 23:21 mushroom_hunting__zappypixel
drwxr-xr-x  22 jbogaty staff       704 Jan 29 20:53 Music
drwxrwxr-x   9 jbogaty staff       288 Nov 27  2019 phantom
-rw-r--r--   1 jbogaty staff  12284655 Jan 29 22:50 phantom.zip
-rw-r--r--   1 jbogaty staff   5867108 Jan 30 00:37 ProductionDocument_EchosFromTheDeep.pdf
drwx------  16 jbogaty staff       512 Jan 29 22:50 PSX Mega Pack II v1.8
-rw-r--r--   1 jbogaty staff 652891598 Jan 29 21:07 PSX Mega Pack II v1.8.zip
drwx------  13 jbogaty staff       416 Oct 27 10:23 Quaternius
-rw-r--r--   1 jbogaty staff  63400379 Jan 30 00:34 RIFLE PACK.rar
drwxr-xr-x  11 jbogaty staff       352 Jan 29 21:07 spacestations_source
-rw-r--r--   1 jbogaty staff    153451 Jan 28 23:34 splash.jpg
drwx------  12 jbogaty staff       384 Jan 28 23:08 Stylized Nature MegaKit[Standard]
-rw-r--r--   1 jbogaty staff    153451 Jan 28 23:12 unnamed.jpg
drwxrwxr-x  10 jbogaty staff       320 Nov 16  2019 wraith
-rw-r--r--   1 jbogaty staff  13124459 Jan 29 22:50 wraith.zip</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-34-158Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-34-158Z" class="timestamp-link"><time datetime="2026-01-30T06:50:34.158Z" data-timestamp="2026-01-30T06:50:34.158Z">2026-01-30T06:50:34.158Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_012QpQsjqkAaoDVZNtpPxPte"><div class="tool-header"><span class="tool-icon">‚öô</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;docs/**/*.md&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-34-949Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-34-949Z" class="timestamp-link"><time datetime="2026-01-30T06:50:34.949Z" data-timestamp="2026-01-30T06:50:34.949Z">2026-01-30T06:50:34.949Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01AqNHPY8HUK4yAuigfQ4zrN">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List EchosFromTheDeep directory</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/EchosFromTheDeep/ 2&gt;/dev/null || echo &#34;Directory not found&#34;</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-35-357Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-35-357Z" class="timestamp-link"><time datetime="2026-01-30T06:50:35.357Z" data-timestamp="2026-01-30T06:50:35.357Z">2026-01-30T06:50:35.357Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/ARCHITECTURE.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DESIGN.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DEVLOG.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LORE.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/MEMORY.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/TESTING.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/PSX-ASSETS.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LEVELS.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/activeContext.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/progress.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/techContext.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/systemPatterns.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/productContext.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/memory-bank/projectbrief.md</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-35-049Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-35-049Z" class="timestamp-link"><time datetime="2026-01-30T06:50:35.049Z" data-timestamp="2026-01-30T06:50:35.049Z">2026-01-30T06:50:35.049Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 4
drwxrwxr-x  5 jbogaty staff  160 Jan 22  2024 .
drwxr-xr-x 53 jbogaty staff 1696 Jan 30 00:37 ..
drwxrwxr-x  6 jbogaty staff  192 Jan 22  2024 Config
drwxrwxr-x 11 jbogaty staff  352 Jan 22  2024 Content
-rw-rw-r--  1 jbogaty staff  227 Jan 22  2024 EchosFromTheDeep.uproject</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-36-173Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-36-173Z" class="timestamp-link"><time datetime="2026-01-30T06:50:36.173Z" data-timestamp="2026-01-30T06:50:36.173Z">2026-01-30T06:50:36.173Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01Gxy1JMEjJZF8xRe9R6CAYJ">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">Find spaceship assets</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/&#34;assets spaceship&#34;/ 2&gt;/dev/null || ls -la ~/assets/assets\ spaceship/ 2&gt;/dev/null || ls ~/assets/ | grep -i spaceship</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-36-250Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-36-250Z" class="timestamp-link"><time datetime="2026-01-30T06:50:36.250Z" data-timestamp="2026-01-30T06:50:36.250Z">2026-01-30T06:50:36.250Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>assets spaceship
assets spaceship.zip</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-42-403Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-42-403Z" class="timestamp-link"><time datetime="2026-01-30T06:50:42.403Z" data-timestamp="2026-01-30T06:50:42.403Z">2026-01-30T06:50:42.403Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>I found:
1. <code>full bot.blend</code> - 1.5MB Blender file (mech for Marcus)
2. <code>FEMALE MARINE- CASUAL PACK.rar</code> - 184MB
3. <code>RIFLE PACK.rar</code> - 63MB
4. <code>assets spaceship/</code> directory exists
5. <code>EchosFromTheDeep/</code> - Unreal project with Content folder
6. <code>ProductionDocument_EchosFromTheDeep.pdf</code> - 5.8MB
7. <code>AmbientCG/</code> folder for textures</p>
<p>Let me explore more of these and launch parallel agents to:
1. Fix the TODOs in the codebase
2. Review the docs
3. Catalog the assets</p>
<p>Let me read more about these assets and launch multiple agents.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-43-035Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-43-035Z" class="timestamp-link"><time datetime="2026-01-30T06:50:43.035Z" data-timestamp="2026-01-30T06:50:43.035Z">2026-01-30T06:50:43.035Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Excellent finds! Let me explore more and launch parallel agents for the fixes and asset analysis.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-43-743Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-43-743Z" class="timestamp-link"><time datetime="2026-01-30T06:50:43.743Z" data-timestamp="2026-01-30T06:50:43.743Z">2026-01-30T06:50:43.743Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01B9vU8LoEHuK5X83NyCynfn">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List spaceship assets contents</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/&#34;assets spaceship&#34;/</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-43-830Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-43-830Z" class="timestamp-link"><time datetime="2026-01-30T06:50:43.830Z" data-timestamp="2026-01-30T06:50:43.830Z">2026-01-30T06:50:43.830Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 243380
drwx------ 16 jbogaty staff      512 Jan 30 00:36 .
drwxr-xr-x 53 jbogaty staff     1696 Jan 30 00:37 ..
-rw-rw-r--  1 jbogaty staff    80108 Sep 24  2022 barrel.fbx
-rw-rw-r--  1 jbogaty staff    71628 Sep 24  2022 door.fbx
-rw-rw-r--  1 jbogaty staff  3674908 Sep 24  2022 hallway 1.fbx
-rw-rw-r--  1 jbogaty staff  2915340 Sep 24  2022 hallway 2.fbx
-rw-rw-r--  1 jbogaty staff  3236284 Sep 24  2022 hallway 3.fbx
-rw-rw-r--  1 jbogaty staff  3272348 Sep 24  2022 hallway 4.fbx
-rw-rw-r--  1 jbogaty staff  9858067 Sep 24  2022 render1.png
-rw-rw-r--  1 jbogaty staff  9502692 Sep 24  2022 render2.png
-rw-rw-r--  1 jbogaty staff  7652250 Sep 24  2022 render3.png
-rw-rw-r--  1 jbogaty staff  8226963 Sep 24  2022 render4.png
-rw-rw-r--  1 jbogaty staff  8671849 Sep 24  2022 render5.png
-rw-rw-r--  1 jbogaty staff 97439158 Sep 24  2022 spaceship asset pack.blend
-rw-rw-r--  1 jbogaty staff 94597118 Sep 24  2022 spaceship asset pack.blend1
drwxrwxr-x  4 jbogaty staff      128 Sep 24  2022 textures</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-44-256Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-44-256Z" class="timestamp-link"><time datetime="2026-01-30T06:50:44.256Z" data-timestamp="2026-01-30T06:50:44.256Z">2026-01-30T06:50:44.256Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01FcvYiqeNJfBiHpudobg3ze">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List Echos content directory</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/EchosFromTheDeep/Content/</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-44-333Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-44-333Z" class="timestamp-link"><time datetime="2026-01-30T06:50:44.333Z" data-timestamp="2026-01-30T06:50:44.333Z">2026-01-30T06:50:44.333Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 684
drwxrwxr-x  3 jbogaty staff     96 Jan 22  2024 _GENERATED
drwxrwxr-x 11 jbogaty staff    352 Jan 22  2024 .
drwxrwxr-x  5 jbogaty staff    160 Jan 22  2024 ..
drwxrwxr-x  3 jbogaty staff     96 Jan 22  2024 BPS
drwxrwxr-x  2 jbogaty staff     64 Jan 22  2024 Collections
drwxrwxr-x  3 jbogaty staff     96 Jan 22  2024 Developers
-rw-rw-r--  1 jbogaty staff 686216 Jan 22  2024 Final.umap
-rw-rw-r--  1 jbogaty staff  10310 Jan 22  2024 LUT.uasset
drwxrwxr-x 19 jbogaty staff    608 Jan 22  2024 Materials
drwxrwxr-x 16 jbogaty staff    512 Jan 22  2024 Models
drwxrwxr-x 10 jbogaty staff    320 Jan 22  2024 Textures</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-45-022Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-45-022Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.022Z" data-timestamp="2026-01-30T06:50:45.022Z">2026-01-30T06:50:45.022Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01CKsih5L4aw1KBvggExPHJu">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List AmbientCG textures</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la ~/assets/AmbientCG/</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-45-118Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-45-118Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.118Z" data-timestamp="2026-01-30T06:50:45.118Z">2026-01-30T06:50:45.118Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 18508
drwx------  5 jbogaty staff      160 Nov 12 17:46 .
drwxr-xr-x 53 jbogaty staff     1696 Jan 30 00:37 ..
-rw-r--r--  1 jbogaty staff     8196 Nov 14 06:14 .DS_Store
-rw-r--r--  1 jbogaty staff 18825216 Nov 12 17:46 .sync_f5ec1c64da2c.db
dr-xr-xr-x 11 jbogaty staff      352 Nov 12 14:48 Assets</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-45-262Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-45-262Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.262Z" data-timestamp="2026-01-30T06:50:45.262Z">2026-01-30T06:50:45.262Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01S1NFeoqf3PfZr5dvFm6kWR"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/ARCHITECTURE.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-45-266Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-45-266Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.266Z" data-timestamp="2026-01-30T06:50:45.266Z">2026-01-30T06:50:45.266Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Technical Architecture
     2‚Üí
     3‚ÜíThis document describes the technical architecture of STELLAR DESCENT: PROXIMA BREACH, including system design, data flow, and implementation details.
     4‚Üí
     5‚Üí## System Overview
     6‚Üí
     7‚Üí```text
     8‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
     9‚Üí‚îÇ                         App.ts (Entry)                         ‚îÇ
    10‚Üí‚îÇ  - Engine initialization (WebGPU/WebGL2)                       ‚îÇ
    11‚Üí‚îÇ  - Physics setup (Havok)                                       ‚îÇ
    12‚Üí‚îÇ  - Game loop                                                   ‚îÇ
    13‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    14‚Üí                                ‚îÇ
    15‚Üí                                ‚ñº
    16‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    17‚Üí‚îÇ                      GameManager.ts                             ‚îÇ
    18‚Üí‚îÇ  - State management (menu, playing, paused)                    ‚îÇ
    19‚Üí‚îÇ  - System coordination                                          ‚îÇ
    20‚Üí‚îÇ  - Scene setup                                                  ‚îÇ
    21‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    22‚Üí                                ‚îÇ
    23‚Üí        ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    24‚Üí        ‚ñº                       ‚ñº                       ‚ñº
    25‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    26‚Üí‚îÇ    Player     ‚îÇ     ‚îÇ   ChunkManager  ‚îÇ     ‚îÇ   UI Systems    ‚îÇ
    27‚Üí‚îÇ  - Controls   ‚îÇ     ‚îÇ  - Generation   ‚îÇ     ‚îÇ  - HUD          ‚îÇ
    28‚Üí‚îÇ  - Camera     ‚îÇ     ‚îÇ  - Loading      ‚îÇ     ‚îÇ  - Menu         ‚îÇ
    29‚Üí‚îÇ  - Shooting   ‚îÇ     ‚îÇ  - Persistence  ‚îÇ     ‚îÇ  - Touch        ‚îÇ
    30‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    31‚Üí        ‚îÇ                       ‚îÇ
    32‚Üí        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    33‚Üí                    ‚ñº
    34‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    35‚Üí‚îÇ                    Entity Component System                      ‚îÇ
    36‚Üí‚îÇ  - Miniplex World                                              ‚îÇ
    37‚Üí‚îÇ  - Entity queries                                              ‚îÇ
    38‚Üí‚îÇ  - Component storage                                           ‚îÇ
    39‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    40‚Üí        ‚îÇ                       ‚îÇ
    41‚Üí        ‚ñº                       ‚ñº
    42‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    43‚Üí‚îÇ   AISystem    ‚îÇ     ‚îÇ  CombatSystem   ‚îÇ
    44‚Üí‚îÇ  - Yuka       ‚îÇ     ‚îÇ  - Projectiles  ‚îÇ
    45‚Üí‚îÇ  - Behaviors  ‚îÇ     ‚îÇ  - Damage       ‚îÇ
    46‚Üí‚îÇ  - States     ‚îÇ     ‚îÇ  - Deaths       ‚îÇ
    47‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    48‚Üí                    ‚îÇ
    49‚Üí                    ‚ñº
    50‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    51‚Üí‚îÇ                     WorldDatabase (SQL.js)                      ‚îÇ
    52‚Üí‚îÇ  - Chunk persistence                                           ‚îÇ
    53‚Üí‚îÇ  - Entity states                                               ‚îÇ
    54‚Üí‚îÇ  - Player stats                                                ‚îÇ
    55‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    56‚Üí```
    57‚Üí
    58‚Üí## Core Technologies
    59‚Üí
    60‚Üí### Rendering: BabylonJS 8.x
    61‚Üí
    62‚Üí**Engine Selection**
    63‚Üí```typescript
    64‚Üí// WebGL2 only - no fallbacks, fail fast
    65‚Üíconst engine = new Engine(canvas, true, {
    66‚Üí  preserveDrawingBuffer: true,
    67‚Üí  stencil: true,
    68‚Üí});
    69‚Üí```
    70‚Üí
    71‚Üí**Why No WebGPU?**
    72‚ÜíWebGPU support is still inconsistent. Silent fallbacks hide real errors and make debugging harder. We use WebGL2 which works everywhere.
    73‚Üí
    74‚Üí**Post-Processing Pipeline**
    75‚Üí```typescript
    76‚Üíconst pipeline = new DefaultRenderingPipeline();
    77‚Üípipeline.imageProcessing.contrast = 1.5;      // High contrast
    78‚Üípipeline.imageProcessing.exposure = 1.15;     // Bright
    79‚Üípipeline.imageProcessing.toneMappingType = 1; // ACES
    80‚Üípipeline.bloomEnabled = true;                  // Bloom for HDR
    81‚Üípipeline.bloomThreshold = 0.75;
    82‚Üípipeline.chromaticAberrationEnabled = true;   // Visor effect
    83‚Üí```
    84‚Üí
    85‚Üí### Physics: Havok
    86‚Üí
    87‚Üí```typescript
    88‚Üíconst hk = await HavokPhysics();
    89‚Üíconst plugin = new HavokPlugin(true, hk);
    90‚Üíscene.enablePhysics(new Vector3(0, -9.81, 0), plugin);
    91‚Üí```
    92‚Üí
    93‚ÜíPhysics bodies are created for:
    94‚Üí- Ground plane (static)
    95‚Üí- Rock formations (static)
    96‚Üí- Buildings (static)
    97‚Üí- Player (kinematic - controlled by code)
    98‚Üí
    99‚Üí### AI: Yuka
   100‚Üí
   101‚Üí**Steering Behaviors Used**
   102‚Üí- `WanderBehavior` - Patrol state
   103‚Üí- `SeekBehavior` - Chase state
   104‚Üí- `PursuitBehavior` - Attack state
   105‚Üí- `FleeBehavior` - Low health retreat
   106‚Üí- `ArriveBehavior` - Ally positioning
   107‚Üí
   108‚Üí**State Machine**
   109‚Üí```text
   110‚Üí          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   111‚Üí          ‚îÇ  IDLE   ‚îÇ
   112‚Üí          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   113‚Üí               ‚îÇ player in alertRadius
   114‚Üí               ‚ñº
   115‚Üí          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   116‚Üí          ‚îÇ PATROL  ‚îÇ‚óÑ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   117‚Üí          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îÇ
   118‚Üí               ‚îÇ player in alertRadius‚îÇ
   119‚Üí               ‚ñº                      ‚îÇ
   120‚Üí          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
   121‚Üí          ‚îÇ  CHASE  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   122‚Üí          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò player escaped  ‚îÇ
   123‚Üí               ‚îÇ player in attackRadius
   124‚Üí               ‚ñº                      ‚îÇ
   125‚Üí          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
   126‚Üí          ‚îÇ ATTACK  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   127‚Üí          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îò player escaped  ‚îÇ
   128‚Üí               ‚îÇ health &lt; 20%         ‚îÇ
   129‚Üí               ‚ñº                      ‚îÇ
   130‚Üí          ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê                 ‚îÇ
   131‚Üí          ‚îÇ  FLEE   ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   132‚Üí          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò health recovered
   133‚Üí```
   134‚Üí
   135‚Üí## Entity Component System
   136‚Üí
   137‚Üí### World Definition
   138‚Üí
   139‚Üí```typescript
   140‚Üíimport { World } from &#x27;miniplex&#x27;;
   141‚Üí
   142‚Üíinterface Entity {
   143‚Üí  id: string;
   144‚Üí  transform?: Transform;
   145‚Üí  health?: Health;
   146‚Üí  velocity?: Velocity;
   147‚Üí  combat?: Combat;
   148‚Üí  ai?: AIComponent;
   149‚Üí  renderable?: Renderable;
   150‚Üí  tags?: Tags;
   151‚Üí  chunkInfo?: ChunkInfo;
   152‚Üí  lifetime?: LifeTime;
   153‚Üí}
   154‚Üí
   155‚Üíconst world = new World&lt;Entity&gt;();
   156‚Üí```
   157‚Üí
   158‚Üí### Component Types
   159‚Üí
   160‚Üí**Transform**
   161‚Üí```typescript
   162‚Üíinterface Transform {
   163‚Üí  position: Vector3;
   164‚Üí  rotation: Vector3;
   165‚Üí  scale: Vector3;
   166‚Üí}
   167‚Üí```
   168‚Üí
   169‚Üí**Health**
   170‚Üí```typescript
   171‚Üíinterface Health {
   172‚Üí  current: number;
   173‚Üí  max: number;
   174‚Üí  regenRate: number;
   175‚Üí}
   176‚Üí```
   177‚Üí
   178‚Üí**Combat**
   179‚Üí```typescript
   180‚Üíinterface Combat {
   181‚Üí  damage: number;
   182‚Üí  range: number;
   183‚Üí  fireRate: number;
   184‚Üí  lastFire: number;
   185‚Üí  projectileSpeed: number;
   186‚Üí}
   187‚Üí```
   188‚Üí
   189‚Üí**AI**
   190‚Üí```typescript
   191‚Üíinterface AIComponent {
   192‚Üí  vehicle: Vehicle;        // Yuka vehicle
   193‚Üí  behaviors: SteeringBehavior[];
   194‚Üí  state: &#x27;idle&#x27; | &#x27;patrol&#x27; | &#x27;chase&#x27; | &#x27;attack&#x27; | &#x27;flee&#x27; | &#x27;support&#x27;;
   195‚Üí  target: Entity | null;
   196‚Üí  alertRadius: number;
   197‚Üí  attackRadius: number;
   198‚Üí}
   199‚Üí```
   200‚Üí
   201‚Üí### Queries
   202‚Üí
   203‚Üí```typescript
   204‚Üíconst queries = {
   205‚Üí  players: world.with(&#x27;tags&#x27;, &#x27;transform&#x27;, &#x27;health&#x27;, &#x27;velocity&#x27;, &#x27;combat&#x27;),
   206‚Üí  enemies: world.with(&#x27;tags&#x27;, &#x27;transform&#x27;, &#x27;health&#x27;, &#x27;ai&#x27;, &#x27;renderable&#x27;),
   207‚Üí  allies: world.with(&#x27;tags&#x27;, &#x27;transform&#x27;, &#x27;health&#x27;, &#x27;ai&#x27;, &#x27;renderable&#x27;),
   208‚Üí  projectiles: world.with(&#x27;tags&#x27;, &#x27;transform&#x27;, &#x27;velocity&#x27;, &#x27;lifetime&#x27;),
   209‚Üí  renderables: world.with(&#x27;transform&#x27;, &#x27;renderable&#x27;),
   210‚Üí  withHealth: world.with(&#x27;health&#x27;),
   211‚Üí  withAI: world.with(&#x27;ai&#x27;, &#x27;transform&#x27;),
   212‚Üí};
   213‚Üí```
   214‚Üí
   215‚Üí## Procedural World Generation
   216‚Üí
   217‚Üí### Chunk System
   218‚Üí
   219‚Üí**Constants**
   220‚Üí```typescript
   221‚Üíconst CHUNK_SIZE = 100;    // World units
   222‚Üíconst LOAD_RADIUS = 3;     // Chunks around player to load
   223‚Üíconst UNLOAD_RADIUS = 5;   // Chunks beyond this are unloaded
   224‚Üí```
   225‚Üí
   226‚Üí**Chunk Key**
   227‚Üí```typescript
   228‚Üífunction getChunkKey(x: number, z: number): string {
   229‚Üí  return `${x},${z}`;
   230‚Üí}
   231‚Üí
   232‚Üífunction getChunkCoords(worldX: number, worldZ: number) {
   233‚Üí  return {
   234‚Üí    x: Math.floor(worldX / CHUNK_SIZE),
   235‚Üí    z: Math.floor(worldZ / CHUNK_SIZE)
   236‚Üí  };
   237‚Üí}
   238‚Üí```
   239‚Üí
   240‚Üí### Seeded Generation
   241‚Üí
   242‚Üí```typescript
   243‚Üífunction generateChunkSeed(chunkX: number, chunkZ: number): number {
   244‚Üí  return baseSeed + chunkX * 73856093 + chunkZ * 19349663;
   245‚Üí}
   246‚Üí
   247‚Üífunction seededRandom(seed: number): () =&gt; number {
   248‚Üí  return () =&gt; {
   249‚Üí    seed = (seed * 1103515245 + 12345) &amp; 0x7fffffff;
   250‚Üí    return seed / 0x7fffffff;
   251‚Üí  };
   252‚Üí}
   253‚Üí```
   254‚Üí
   255‚ÜíThis ensures:
   256‚Üí- Same chunk coordinates always generate same content
   257‚Üí- Chunks can be unloaded and regenerated identically
   258‚Üí- Different baseSeed creates different worlds
   259‚Üí
   260‚Üí### Generation Pipeline
   261‚Üí
   262‚Üí```
   263‚Üí1. Calculate chunk seed
   264‚Üí2. Create seeded random generator
   265‚Üí3. Generate building positions &amp; types
   266‚Üí4. Generate obstacle positions &amp; types
   267‚Üí5. Generate enemy spawn points
   268‚Üí6. Store in database
   269‚Üí7. Create meshes
   270‚Üí8. Create entities
   271‚Üí```
   272‚Üí
   273‚Üí## Persistence Layer
   274‚Üí
   275‚Üí### Database Schema
   276‚Üí
   277‚Üí```sql
   278‚ÜíCREATE TABLE chunks (
   279‚Üí  chunk_x INTEGER,
   280‚Üí  chunk_z INTEGER,
   281‚Üí  seed INTEGER,
   282‚Üí  buildings TEXT,    -- JSON
   283‚Üí  obstacles TEXT,    -- JSON
   284‚Üí  enemies TEXT,      -- JSON
   285‚Üí  visited INTEGER,
   286‚Üí  created_at INTEGER,
   287‚Üí  PRIMARY KEY (chunk_x, chunk_z)
   288‚Üí);
   289‚Üí
   290‚ÜíCREATE TABLE entities (
   291‚Üí  id TEXT PRIMARY KEY,
   292‚Üí  type TEXT,
   293‚Üí  x REAL, y REAL, z REAL,
   294‚Üí  health REAL,
   295‚Üí  data TEXT,         -- JSON for extra data
   296‚Üí  chunk_x INTEGER,
   297‚Üí  chunk_z INTEGER
   298‚Üí);
   299‚Üí
   300‚ÜíCREATE TABLE player_stats (
   301‚Üí  id INTEGER PRIMARY KEY DEFAULT 1,
   302‚Üí  kills INTEGER DEFAULT 0,
   303‚Üí  distance_traveled REAL DEFAULT 0,
   304‚Üí  bosses_defeated INTEGER DEFAULT 0,
   305‚Üí  mechs_called INTEGER DEFAULT 0,
   306‚Üí  last_x REAL, last_y REAL, last_z REAL
   307‚Üí);
   308‚Üí```
   309‚Üí
   310‚Üí### Data Flow
   311‚Üí
   312‚Üí**Chunk Loading**
   313‚Üí```
   314‚Üí1. Check if chunk exists in database
   315‚Üí2. If yes: Load stored data, create entities
   316‚Üí3. If no: Generate new chunk, store in database
   317‚Üí```
   318‚Üí
   319‚Üí**Chunk Unloading**
   320‚Üí```
   321‚Üí1. Save entity states to database
   322‚Üí2. Dispose meshes
   323‚Üí3. Remove entities from ECS world
   324‚Üí4. Keep chunk record (seed preserved)
   325‚Üí```
   326‚Üí
   327‚Üí**Player Stats**
   328‚Üí```
   329‚Üí- Updated every frame with position
   330‚Üí- Updated on kills, boss defeats
   331‚Üí- Used to restore game state on reload
   332‚Üí```
   333‚Üí
   334‚Üí## Input System
   335‚Üí
   336‚Üí### Desktop Controls
   337‚Üí
   338‚Üí```typescript
   339‚Üí// Keyboard state
   340‚Üíconst keysPressed = new Set&lt;string&gt;();
   341‚Üí
   342‚Üíwindow.addEventListener(&#x27;keydown&#x27;, (e) =&gt; {
   343‚Üí  keysPressed.add(e.code);
   344‚Üí});
   345‚Üí
   346‚Üíwindow.addEventListener(&#x27;keyup&#x27;, (e) =&gt; {
   347‚Üí  keysPressed.delete(e.code);
   348‚Üí});
   349‚Üí
   350‚Üí// Mouse for aiming
   351‚Üícamera.attachControl(canvas, true);
   352‚Üí```
   353‚Üí
   354‚Üí### Touch Controls
   355‚Üí
   356‚Üí**Virtual Joysticks**
   357‚Üí```
   358‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   359‚Üí‚îÇ    Base Circle      ‚îÇ
   360‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
   361‚Üí‚îÇ  ‚îÇ   Thumb     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ Track touch position
   362‚Üí‚îÇ  ‚îÇ   Circle    ‚îÇ    ‚îÇ    relative to center
   363‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
   364‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   365‚Üí```
   366‚Üí
   367‚Üí**Input Normalization**
   368‚Üí```typescript
   369‚Üíinterface TouchInput {
   370‚Üí  movement: Vector2;    // -1 to 1 for each axis
   371‚Üí  look: Vector2;        // Delta for camera rotation
   372‚Üí  isFiring: boolean;
   373‚Üí  isSprinting: boolean;
   374‚Üí}
   375‚Üí```
   376‚Üí
   377‚Üí**Player Integration**
   378‚Üí```typescript
   379‚Üí// GameManager passes touch input
   380‚Üíif (this.touchControls &amp;&amp; this.isTouchDevice) {
   381‚Üí  this.player.setTouchInput(this.touchControls.getInput());
   382‚Üí}
   383‚Üí
   384‚Üí// Player uses whichever input is active
   385‚Üíif (usingTouch &amp;&amp; this.touchInput) {
   386‚Üí  // Use joystick values
   387‚Üí} else {
   388‚Üí  // Use keyboard/mouse
   389‚Üí}
   390‚Üí```
   391‚Üí
   392‚Üí## Performance Considerations
   393‚Üí
   394‚Üí### Mobile Optimization
   395‚Üí
   396‚Üí**Simplified Graphics Mode**
   397‚Üí```typescript
   398‚Üífunction shouldUseSimplifiedGraphics(): boolean {
   399‚Üí  if (deviceType === &#x27;mobile&#x27; &amp;&amp; pixelRatio &gt; 2) return true;
   400‚Üí  if (navigator.deviceMemory &lt; 4) return true;
   401‚Üí  return false;
   402‚Üí}
   403‚Üí```
   404‚Üí
   405‚ÜíWhen enabled:
   406‚Üí- Fewer rock formations (25 vs 50)
   407‚Üí- Reduced shadow map resolution
   408‚Üí- Lower post-processing quality
   409‚Üí
   410‚Üí**Memory Management**
   411‚Üí- Chunk unloading at distance
   412‚Üí- Entity disposal when dead
   413‚Üí- Texture sharing between similar objects
   414‚Üí
   415‚Üí### Render Optimization
   416‚Üí
   417‚Üí- Frustum culling (automatic in BabylonJS)
   418‚Üí- Level of detail (not yet implemented)
   419‚Üí- Instancing for repeated objects (planned)
   420‚Üí
   421‚Üí## File Structure Rationale
   422‚Üí
   423‚Üí```
   424‚Üísrc/game/
   425‚Üí‚îú‚îÄ‚îÄ core/           # Fundamental systems
   426‚Üí‚îÇ   ‚îú‚îÄ‚îÄ ecs.ts      # Entity Component System
   427‚Üí‚îÇ   ‚îú‚îÄ‚îÄ gameManager.ts  # Main orchestrator
   428‚Üí‚îÇ   ‚îî‚îÄ‚îÄ lore.ts     # Story data (separate for easy editing)
   429‚Üí‚îú‚îÄ‚îÄ db/             # Persistence
   430‚Üí‚îÇ   ‚îî‚îÄ‚îÄ worldDatabase.ts
   431‚Üí‚îú‚îÄ‚îÄ entities/       # Game objects with behavior
   432‚Üí‚îÇ   ‚îú‚îÄ‚îÄ mech.ts     # Ally mechs
   433‚Üí‚îÇ   ‚îî‚îÄ‚îÄ player.ts   # Player controller
   434‚Üí‚îú‚îÄ‚îÄ systems/        # Process entities each frame
   435‚Üí‚îÇ   ‚îú‚îÄ‚îÄ aiSystem.ts
   436‚Üí‚îÇ   ‚îî‚îÄ‚îÄ combatSystem.ts
   437‚Üí‚îú‚îÄ‚îÄ ui/             # User interface
   438‚Üí‚îÇ   ‚îú‚îÄ‚îÄ hud.ts
   439‚Üí‚îÇ   ‚îú‚îÄ‚îÄ introSequence.ts
   440‚Üí‚îÇ   ‚îú‚îÄ‚îÄ mainMenu.ts
   441‚Üí‚îÇ   ‚îî‚îÄ‚îÄ touchControls.ts
   442‚Üí‚îú‚îÄ‚îÄ utils/          # Shared utilities
   443‚Üí‚îÇ   ‚îú‚îÄ‚îÄ designTokens.ts
   444‚Üí‚îÇ   ‚îî‚îÄ‚îÄ responsive.ts
   445‚Üí‚îî‚îÄ‚îÄ world/          # World generation
   446‚Üí    ‚îú‚îÄ‚îÄ chunkManager.ts
   447‚Üí    ‚îî‚îÄ‚îÄ terrainGenerator.ts
   448‚Üí```
   449‚Üí
   450‚Üí## Future Architecture Considerations
   451‚Üí
   452‚Üí### Planned Additions
   453‚Üí
   454‚Üí1. **Sound System**
   455‚Üí   - Web Audio API
   456‚Üí   - Spatial audio for 3D
   457‚Üí   - Music manager for tracks
   458‚Üí
   459‚Üí2. **Save/Load System**
   460‚Üí   - Full game state serialization
   461‚Üí   - IndexedDB for larger saves
   462‚Üí   - Cloud sync consideration
   463‚Üí
   464‚Üí3. **Multiplayer** (far future)
   465‚Üí   - WebRTC for peer-to-peer
   466‚Üí   - Authoritative server option
   467‚Üí   - State synchronization
   468‚Üí
   469‚Üí### Scalability
   470‚Üí
   471‚ÜíCurrent architecture supports:
   472‚Üí- 100+ simultaneous entities
   473‚Üí- Infinite world (chunk-based)
   474‚Üí- 10+ enemy types
   475‚Üí- Multiple mission chapters
   476‚Üí
   477‚ÜíFor larger scale:
   478‚Üí- Consider spatial partitioning
   479‚Üí- Entity pooling for projectiles
   480‚Üí- Web Workers for AI
   481‚Üí
   482‚Üí---
   483‚Üí
   484‚Üí*&quot;Architecture is frozen music. But this is a shooter, so maybe more like frozen gunfire.&quot;*
   485‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-45-755Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-45-755Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.755Z" data-timestamp="2026-01-30T06:50:45.755Z">2026-01-30T06:50:45.755Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_0124WYe4QatvzEnb3bDRnprB"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DESIGN.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-45-757Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-45-757Z" class="timestamp-link"><time datetime="2026-01-30T06:50:45.757Z" data-timestamp="2026-01-30T06:50:45.757Z">2026-01-30T06:50:45.757Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# Design System &amp; UI/UX Guidelines
     2‚Üí
     3‚ÜíThis document defines the visual design system, UI patterns, and user experience guidelines for STELLAR DESCENT: PROXIMA BREACH.
     4‚Üí
     5‚Üí## Design Philosophy
     6‚Üí
     7‚Üí### Core Principles
     8‚Üí
     9‚Üí1. **Military Tactical Aesthetic**
    10‚Üí   - Think modern military equipment, not sci-fi fantasy
    11‚Üí   - Utilitarian, functional design
    12‚Üí   - Stencil typography, angular shapes
    13‚Üí   - Worn, battle-tested appearance
    14‚Üí
    15‚Üí2. **Harsh Alien Environment**
    16‚Üí   - Proxima Centauri is a red dwarf star
    17‚Üí   - Intense, contrasty lighting
    18‚Üí   - Dust, rock, and sparse vegetation
    19‚Üí   - No lush environments or soft lighting
    20‚Üí
    21‚Üí3. **Mobile-First Responsive**
    22‚Üí   - Design for 375px width first
    23‚Üí   - Scale up to tablets and desktop
    24‚Üí   - Touch targets minimum 44px
    25‚Üí   - Thumb-reachable controls
    26‚Üí
    27‚Üí## Color System
    28‚Üí
    29‚Üí### Primary Palette (Military)
    30‚Üí
    31‚Üí
    32‚Üí### Forbidden Colors
    33‚Üí
    34‚ÜíDo NOT use:
    35‚Üí- Neon colors (#00FFFF, #FF00FF, etc.)
    36‚Üí- Pure blues (#0000FF)
    37‚Üí- Cyberpunk purples (#9400D3)
    38‚Üí- Gradients with blue/purple
    39‚Üí
    40‚Üí## Typography
    41‚Üí
    42‚Üí### Font Stack
    43‚Üí
    44‚Üí```css
    45‚ÜíPrimary:  &#x27;Rajdhani&#x27;, sans-serif      /* UI text */
    46‚ÜíMono:     &#x27;Share Tech Mono&#x27;, monospace /* Data/numbers */
    47‚ÜíDisplay:  &#x27;Black Ops One&#x27;, cursive     /* Titles */
    48‚Üí```
    49‚Üí
    50‚Üí### Size Scale (Mobile Base)
    51‚Üí
    52‚Üí```
    53‚ÜíXS:      12px  - Captions, labels
    54‚ÜíSM:      14px  - Secondary text
    55‚ÜíMD:      16px  - Body text
    56‚ÜíLG:      20px  - Subheadings
    57‚ÜíXL:      24px  - Section titles
    58‚ÜíXXL:     32px  - Page titles
    59‚ÜíDisplay: 48px  - Hero titles
    60‚Üí```
    61‚Üí
    62‚Üí### Desktop Multiplier: 1.15x
    63‚Üí
    64‚Üí## Spacing System
    65‚Üí
    66‚Üí### Base Scale
    67‚Üí
    68‚Üí```
    69‚ÜíXS:  4px   - Tight spacing
    70‚ÜíSM:  8px   - Compact elements
    71‚ÜíMD:  16px  - Standard spacing
    72‚ÜíLG:  24px  - Generous spacing
    73‚ÜíXL:  32px  - Section separation
    74‚ÜíXXL: 48px  - Major sections
    75‚Üí```
    76‚Üí
    77‚Üí### Mobile Multiplier: 0.75x
    78‚Üí
    79‚Üí## Components
    80‚Üí
    81‚Üí### Buttons
    82‚Üí
    83‚Üí## Primary Button
    84‚Üí```
    85‚ÜíBackground: tokens.colors.primary.oliveDark
    86‚ÜíText:       tokens.colors.ui.text
    87‚ÜíBorder:     2px solid tokens.colors.primary.olive
    88‚ÜíHeight:     50px (desktop), 48px (mobile)
    89‚ÜíFont:       Courier New, monospace, 16px
    90‚Üí```
    91‚Üí
    92‚Üí## Hover State
    93‚Üí```
    94‚ÜíBackground: tokens.colors.primary.olive
    95‚ÜíText:       tokens.colors.accent.brass
    96‚ÜíTransform:  scale(1.02)
    97‚Üí```
    98‚Üí
    99‚Üí## Disabled State
   100‚Üí```
   101‚ÜíBackground: tokens.colors.ui.surface
   102‚ÜíText:       tokens.colors.ui.textMuted
   103‚ÜíOpacity:    1 (don&#x27;t use opacity for disabled)
   104‚Üí```
   105‚Üí
   106‚Üí### Health Bar
   107‚Üí
   108‚Üí```
   109‚ÜíContainer:
   110‚Üí  Width:      250px (desktop), 180px (mobile)
   111‚Üí  Height:     24px (desktop), 20px (mobile)
   112‚Üí  Background: tokens.colors.ui.background + &#x27;CC&#x27;
   113‚Üí  Border:     2px solid tokens.colors.primary.olive
   114‚Üí
   115‚ÜíFill:
   116‚Üí  &gt;50%:  tokens.colors.ui.health
   117‚Üí  25-50%: tokens.colors.ui.warning
   118‚Üí  &lt;25%:  tokens.colors.ui.danger
   119‚Üí```
   120‚Üí
   121‚Üí### Notifications
   122‚Üí
   123‚Üí```
   124‚ÜíWidth:      320px (desktop), 260px (mobile)
   125‚ÜíHeight:     50px (desktop), 40px (mobile)
   126‚ÜíBackground: tokens.colors.primary.olive + &#x27;EE&#x27;
   127‚ÜíBorder:     2px solid tokens.colors.accent.brass
   128‚ÜíAnimation:  Fade in from top, hold, fade out down
   129‚Üí```
   130‚Üí
   131‚Üí### Crosshair
   132‚Üí
   133‚Üí```
   134‚ÜíCenter Dot:
   135‚Üí  Size:   4px (desktop), 6px (mobile)
   136‚Üí  Color:  tokens.colors.accent.amber
   137‚Üí
   138‚ÜíLines:
   139‚Üí  Length: 12px (desktop), 16px (mobile)
   140‚Üí  Width:  2px (desktop), 3px (mobile)
   141‚Üí  Color:  tokens.colors.ui.text + &#x27;88&#x27;
   142‚Üí  Gap:    8px (desktop), 10px (mobile)
   143‚Üí```
   144‚Üí
   145‚Üí## Touch Controls Layout
   146‚Üí
   147‚Üí### Portrait Mode (Not Recommended)
   148‚Üí
   149‚Üí```
   150‚Üí+---------------------------+
   151‚Üí|     [WAVE/MISSION]        |
   152‚Üí|                           |
   153‚Üí|                           |
   154‚Üí|    SUGGEST LANDSCAPE      |
   155‚Üí|                           |
   156‚Üí|                           |
   157‚Üí+---------------------------+
   158‚Üí```
   159‚Üí
   160‚Üí### Landscape Mode (Primary)
   161‚Üí
   162‚Üí```
   163‚Üí+-----------------------------------------------+
   164‚Üí|  [HEALTH]              [MISSION]      [KILLS] |
   165‚Üí|                                               |
   166‚Üí|                    +                          |
   167‚Üí|                                               |
   168‚Üí|                                               |
   169‚Üí|  [SPRINT]                          [FIRE]     |
   170‚Üí|     O                                  O      |
   171‚Üí|   (MOVE)                            (LOOK)    |
   172‚Üí+-----------------------------------------------+
   173‚Üí```
   174‚Üí
   175‚Üí### Joystick Sizing
   176‚Üí
   177‚Üí```
   178‚ÜíMobile:
   179‚Üí  Base:  min(120px, 22% of min dimension)
   180‚Üí  Thumb: 45% of base
   181‚Üí
   182‚ÜíTablet:
   183‚Üí  Base:  min(140px, 18% of min dimension)
   184‚Üí  Thumb: 45% of base
   185‚Üí
   186‚ÜíDesktop (if touch):
   187‚Üí  Base:  min(160px, 15% of min dimension)
   188‚Üí  Thumb: 45% of base
   189‚Üí```
   190‚Üí
   191‚Üí### Safe Areas
   192‚Üí
   193‚ÜíAlways respect:
   194‚Üí- `env(safe-area-inset-top)` - Notch/Dynamic Island
   195‚Üí- `env(safe-area-inset-bottom)` - Home indicator
   196‚Üí- `env(safe-area-inset-left/right)` - Landscape notch
   197‚Üí
   198‚Üí## Motion &amp; Animation
   199‚Üí
   200‚Üí### Principles
   201‚Üí
   202‚Üí1. **Purposeful** - Every animation serves a function
   203‚Üí2. **Fast** - Keep under 300ms for UI, 500ms for emphasis
   204‚Üí3. **Respect Preferences** - Honor `prefers-reduced-motion`
   205‚Üí
   206‚Üí### Standard Timings
   207‚Üí
   208‚Üí```
   209‚ÜíInstant:   0ms    - State changes
   210‚ÜíFast:      100ms  - Hover effects
   211‚ÜíNormal:    200ms  - Transitions
   212‚ÜíEmphasis:  300ms  - Important changes
   213‚ÜíDramatic:  500ms  - Major events
   214‚Üí```
   215‚Üí
   216‚Üí### Easing Functions
   217‚Üí
   218‚Üí```
   219‚ÜíeaseOutQuad    - Standard exit
   220‚ÜíeaseInQuad     - Standard entrance
   221‚ÜíeaseOutElastic - Bounce effects (damage shake)
   222‚Üílinear         - Continuous animations
   223‚Üí```
   224‚Üí
   225‚Üí### Animation Examples
   226‚Üí
   227‚Üí## Button Hover
   228‚Üí```javascript
   229‚Üíanime({
   230‚Üí  targets: button,
   231‚Üí  scaleX: 1.02,
   232‚Üí  scaleY: 1.02,
   233‚Üí  duration: 100,
   234‚Üí  easing: &#x27;easeOutQuad&#x27;
   235‚Üí});
   236‚Üí```
   237‚Üí
   238‚Üí## Damage Flash
   239‚Üí```javascript
   240‚Üíanime({
   241‚Üí  targets: damageOverlay,
   242‚Üí  alpha: [0.4, 0],
   243‚Üí  duration: 300,
   244‚Üí  easing: &#x27;easeOutQuad&#x27;
   245‚Üí});
   246‚Üí```
   247‚Üí
   248‚Üí## Notification Entry
   249‚Üí```javascript
   250‚Üíanime({
   251‚Üí  targets: notification,
   252‚Üí  alpha: [0, 1],
   253‚Üí  top: [&#x27;-100px&#x27;, &#x27;-80px&#x27;],
   254‚Üí  duration: 300,
   255‚Üí  easing: &#x27;easeOutQuad&#x27;
   256‚Üí});
   257‚Üí```
   258‚Üí
   259‚Üí## Iconography
   260‚Üí
   261‚Üí### Current Icons
   262‚Üí
   263‚ÜíUsing Unicode symbols for simplicity:
   264‚Üí- Star: `‚òÖ` - Insignia/rank
   265‚Üí- Crosshair: Built from rectangles
   266‚Üí
   267‚Üí### Future Considerations
   268‚Üí
   269‚ÜíWhen adding icons:
   270‚Üí- SVG format only
   271‚Üí- Single color (use currentColor)
   272‚Üí- Minimum 24x24 touch target
   273‚Üí- Military/tactical style
   274‚Üí
   275‚Üí## Accessibility
   276‚Üí
   277‚Üí### Color Contrast
   278‚Üí
   279‚Üí- Text on dark: minimum 4.5:1 ratio
   280‚Üí- Large text: minimum 3:1 ratio
   281‚Üí- Interactive elements: clear focus states
   282‚Üí
   283‚Üí### Touch Targets
   284‚Üí
   285‚Üí- Minimum 44x44px for all interactive elements
   286‚Üí- 8px minimum spacing between targets
   287‚Üí
   288‚Üí### Motion
   289‚Üí
   290‚Üí```css
   291‚Üí@media (prefers-reduced-motion: reduce) {
   292‚Üí  * {
   293‚Üí    animation-duration: 0.01ms !important;
   294‚Üí    transition-duration: 0.01ms !important;
   295‚Üí  }
   296‚Üí}
   297‚Üí```
   298‚Üí
   299‚Üí### Screen Readers
   300‚Üí
   301‚Üí- All buttons have text labels
   302‚Üí- Health displayed as &quot;X of Y&quot;
   303‚Üí- Mission status announced
   304‚Üí
   305‚Üí## Platform Considerations
   306‚Üí
   307‚Üí### iOS Safari
   308‚Üí
   309‚Üí- `viewport-fit=cover` for notch
   310‚Üí- `-webkit-touch-callout: none` to prevent menus
   311‚Üí- `touch-action: manipulation` to prevent zoom
   312‚Üí
   313‚Üí### Android Chrome
   314‚Üí
   315‚Üí- Theme color meta tag: `#1C1C1C`
   316‚Üí- Fullscreen API supported
   317‚Üí- Wake lock API supported
   318‚Üí
   319‚Üí### Foldables
   320‚Üí
   321‚Üí- Test in both folded and unfolded states
   322‚Üí- Support `horizontal-viewport-segments` media query
   323‚Üí- Avoid placing critical UI near fold
   324‚Üí
   325‚Üí## Design Token Usage
   326‚Üí
   327‚ÜíAlways import from designTokens.ts:
   328‚Üí
   329‚Üí```typescript
   330‚Üíimport { tokens } from &#x27;../utils/designTokens&#x27;;
   331‚Üí
   332‚Üí// Colors
   333‚Üímaterial.diffuseColor = Color3.FromHexString(tokens.colors.primary.olive);
   334‚Üíbutton.background = tokens.colors.ui.background;
   335‚Üí
   336‚Üí// Spacing
   337‚Üícontainer.left = `${tokens.spacing.md}px`;
   338‚Üí
   339‚Üí// Border radius
   340‚Üíbutton.cornerRadius = tokens.effects.borderRadius.sm;
   341‚Üí```
   342‚Üí
   343‚ÜíNever hardcode values. If a value isn&#x27;t in tokens, add it first.
   344‚Üí
   345‚Üí---
   346‚Üí
   347‚Üí*&quot;Form follows function. Every element serves the mission.&quot;*
   348‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T06-50-46-099Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T06-50-46-099Z" class="timestamp-link"><time datetime="2026-01-30T06:50:46.099Z" data-timestamp="2026-01-30T06:50:46.099Z">2026-01-30T06:50:46.099Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01HPpokdpCKJjvd48QRPUZtZ"><div class="tool-header"><span class="tool-icon">‚öô</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LEVELS.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T06-50-46-289Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T06-50-46-289Z" class="timestamp-link"><time datetime="2026-01-30T06:50:46.289Z" data-timestamp="2026-01-30T06:50:46.289Z">2026-01-30T06:50:46.289Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1‚Üí# STELLAR DESCENT: Level System Architecture
     2‚Üí
     3‚ÜíThis document defines the complete level system architecture, mapping the story chapters from LORE.md to playable game levels, and establishing the technical contracts for level implementation.
     4‚Üí
     5‚Üí---
     6‚Üí
     7‚Üí## Table of Contents
     8‚Üí
     9‚Üí1. [Design Philosophy](#design-philosophy)
    10‚Üí2. [Campaign Structure](#campaign-structure)
    11‚Üí3. [Level Architecture](#level-architecture)
    12‚Üí4. [HUD System](#hud-system)
    13‚Üí5. [Dynamic Action Buttons](#dynamic-action-buttons)
    14‚Üí6. [Quest &amp; Marker System](#quest--marker-system)
    15‚Üí7. [Input &amp; Keybindings](#input--keybindings)
    16‚Üí8. [Level Implementation Guide](#level-implementation-guide)
    17‚Üí9. [Level Specifications](#level-specifications)
    18‚Üí
    19‚Üí---
    20‚Üí
    21‚Üí## Design Philosophy
    22‚Üí
    23‚Üí### Core Principles
    24‚Üí
    25‚Üí**1. Scene Isolation (Like HALO)**
    26‚ÜíEach level is a completely self-contained experience:
    27‚Üí- Own Babylon.js Scene instance
    28‚Üí- Own lighting, skybox, and atmosphere
    29‚Üí- Own asset loading and disposal
    30‚Üí- Clean transitions between levels
    31‚Üí- NO merged scenes or shared geometry
    32‚Üí
    33‚Üí**2. Linked List Navigation**
    34‚ÜíLevels form a doubly-linked list, not an array:
    35‚Üí```
    36‚Üíanchor_station &lt;-&gt; landfall &lt;-&gt; fob_delta &lt;-&gt; brothers_in_arms &lt;-&gt; the_breach &lt;-&gt; extraction
    37‚Üí      ‚Üë                                                                              ‚Üì
    38‚Üí   (start)                                                                        (end)
    39‚Üí```
    40‚ÜíEach level knows only its `nextLevelId` and `previousLevelId`.
    41‚Üí
    42‚Üí**3. Universal HUD Overlay**
    43‚ÜíThe HUD is a React component that floats ABOVE all levels:
    44‚Üí- Health bar (always visible during gameplay)
    45‚Üí- Mission text (context-sensitive)
    46‚Üí- Kill counter (when applicable)
    47‚Üí- Crosshair (FPS mode only)
    48‚Üí- Dynamic action buttons (level-controlled)
    49‚Üí- Comms display (narrative delivery)
    50‚Üí- Notifications (events/achievements)
    51‚Üí
    52‚Üí**4. Progressive Unlocking**
    53‚ÜíTutorial (Anchor Station) progressively unlocks HUD elements:
    54‚Üí- Movement first ‚Üí health bar appears
    55‚Üí- Look around ‚Üí crosshair appears
    56‚Üí- Weapon training ‚Üí ammo counter appears
    57‚Üí- Action tutorial ‚Üí action buttons explained
    58‚Üí- Full HUD unlocked by level end
    59‚Üí
    60‚Üí---
    61‚Üí
    62‚Üí## Campaign Structure
    63‚Üí
    64‚Üí### Mapping Lore Chapters to Levels
    65‚Üí
    66‚Üí| Lore Chapter | Level ID | Level Type | Environment |
    67‚Üí|:-------------|:---------|:-----------|:------------|
    68‚Üí| Prologue + Chapter 1 | `anchor_station` | station | Space station interior |
    69‚Üí| Chapter 2 (partial) | `landfall` | drop ‚Üí canyon | HALO drop ‚Üí planet surface |
    70‚Üí| Chapter 3 | `fob_delta` | base | Abandoned military outpost |
    71‚Üí| Chapter 4 | `brothers_in_arms` | canyon | Open world, mech combat |
    72‚Üí| Chapter 5 | `the_breach` | hive | Underground alien tunnels |
    73‚Üí| Chapter 6 + Epilogue | `extraction` | extraction | Surface holdout ‚Üí victory |
    74‚Üí
    75‚Üí### Level Flow
    76‚Üí
    77‚Üí```
    78‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    79‚Üí‚îÇ                           STELLAR DESCENT CAMPAIGN                          ‚îÇ
    80‚Üí‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
    81‚Üí‚îÇ                                                                             ‚îÇ
    82‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
    83‚Üí‚îÇ  ‚îÇ  ANCHOR STATION  ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ     LANDFALL     ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∂‚îÇ    FOB DELTA     ‚îÇ   ‚îÇ
    84‚Üí‚îÇ  ‚îÇ    (Tutorial)    ‚îÇ     ‚îÇ   (HALO Drop)    ‚îÇ     ‚îÇ   (Horror/Inv)   ‚îÇ   ‚îÇ
    85‚Üí‚îÇ  ‚îÇ   Chapter 1      ‚îÇ     ‚îÇ    Chapter 2     ‚îÇ     ‚îÇ    Chapter 3     ‚îÇ   ‚îÇ
    86‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
    87‚Üí‚îÇ                                                              ‚îÇ              ‚îÇ
    88‚Üí‚îÇ                                                              ‚ñº              ‚îÇ
    89‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
    90‚Üí‚îÇ  ‚îÇ    EXTRACTION    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ    THE BREACH    ‚îÇ‚óÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÇ BROTHERS IN ARMS ‚îÇ   ‚îÇ
    91‚Üí‚îÇ  ‚îÇ  (Final Stand)   ‚îÇ     ‚îÇ (Hive/Boss Fight)‚îÇ     ‚îÇ  (Mech Combat)   ‚îÇ   ‚îÇ
    92‚Üí‚îÇ  ‚îÇ    Chapter 6     ‚îÇ     ‚îÇ    Chapter 5     ‚îÇ     ‚îÇ    Chapter 4     ‚îÇ   ‚îÇ
    93‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
    94‚Üí‚îÇ                                                                             ‚îÇ
    95‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
    96‚Üí```
    97‚Üí
    98‚Üí---
    99‚Üí
   100‚Üí## Level Architecture
   101‚Üí
   102‚Üí### Technical Structure
   103‚Üí
   104‚Üí```typescript
   105‚Üí// Each level implements ILevel interface
   106‚Üíinterface ILevel {
   107‚Üí  readonly id: LevelId;
   108‚Üí  readonly type: LevelType;
   109‚Üí  readonly config: LevelConfig;
   110‚Üí
   111‚Üí  // Lifecycle
   112‚Üí  initialize(): Promise&lt;void&gt;;
   113‚Üí  update(deltaTime: number): void;
   114‚Üí  dispose(): void;
   115‚Üí
   116‚Üí  // Scene access (isolated per level)
   117‚Üí  getScene(): Scene;
   118‚Üí
   119‚Üí  // State management
   120‚Üí  getState(): LevelState;
   121‚Üí  setState(state: Partial&lt;LevelState&gt;): void;
   122‚Üí
   123‚Üí  // Input
   124‚Üí  lockPointer(): void;
   125‚Üí  unlockPointer(): void;
   126‚Üí  isPointerLocked(): boolean;
   127‚Üí
   128‚Üí  // Navigation
   129‚Üí  canTransitionTo(levelId: LevelId): boolean;
   130‚Üí  prepareTransition(targetLevelId: LevelId): Promise&lt;void&gt;;
   131‚Üí}
   132‚Üí```
   133‚Üí
   134‚Üí### Level Types
   135‚Üí
   136‚Üí| Type | Description | Camera | Combat | Example |
   137‚Üí|:-----|:------------|:-------|:-------|:--------|
   138‚Üí| `station` | Interior space station | FPS | Limited/Tutorial | Anchor Station |
   139‚Üí| `drop` | HALO descent sequence | Special (down‚Üíforward) | Dodge/Avoid | Landfall (phase 1) |
   140‚Üí| `canyon` | Exterior planet surface | FPS | Full | Landfall (phase 2), Brothers |
   141‚Üí| `base` | Abandoned outpost interior | FPS | Ambush | FOB Delta |
   142‚Üí| `hive` | Underground alien tunnels | FPS | Heavy | The Breach |
   143‚Üí| `extraction` | Holdout/escape | FPS | Wave-based | Extraction |
   144‚Üí
   145‚Üí### Scene Isolation Rules
   146‚Üí
   147‚Üí1. **Each level creates its own `new Scene(engine)`**
   148‚Üí2. **Levels dispose their scene on cleanup**
   149‚Üí3. **No global meshes shared between levels**
   150‚Üí4. **Assets loaded per-level (with caching at engine level)**
   151‚Üí5. **Skybox/environment completely level-specific**
   152‚Üí6. **Lighting designed for each level&#x27;s atmosphere**
   153‚Üí
   154‚Üí---
   155‚Üí
   156‚Üí## HUD System
   157‚Üí
   158‚Üí### HUD Component Hierarchy
   159‚Üí
   160‚Üí```
   161‚Üí‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
   162‚Üí‚îÇ                         HUD OVERLAY                         ‚îÇ
   163‚Üí‚îÇ                    (React, always on top)                   ‚îÇ
   164‚Üí‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
   165‚Üí‚îÇ                                                             ‚îÇ
   166‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
   167‚Üí‚îÇ  ‚îÇ   Health Bar    ‚îÇ              ‚îÇ    Mission Text      ‚îÇ ‚îÇ
   168‚Üí‚îÇ  ‚îÇ  (bottom-left)  ‚îÇ              ‚îÇ    (top-center)      ‚îÇ ‚îÇ
   169‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
   170‚Üí‚îÇ                                                             ‚îÇ
   171‚Üí‚îÇ                     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê       ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
   172‚Üí‚îÇ                     ‚îÇ  Crosshair ‚îÇ       ‚îÇ Kill Counter ‚îÇ  ‚îÇ
   173‚Üí‚îÇ                     ‚îÇ  (center)  ‚îÇ       ‚îÇ (top-right)  ‚îÇ  ‚îÇ
   174‚Üí‚îÇ                     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò       ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
   175‚Üí‚îÇ                                                             ‚îÇ
   176‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
   177‚Üí‚îÇ  ‚îÇ Action Buttons  ‚îÇ              ‚îÇ   Action Buttons     ‚îÇ ‚îÇ
   178‚Üí‚îÇ  ‚îÇ (left panel)    ‚îÇ              ‚îÇ   (right panel)      ‚îÇ ‚îÇ
   179‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
   180‚Üí‚îÇ                                                             ‚îÇ
   181‚Üí‚îÇ              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
   182‚Üí‚îÇ              ‚îÇ     Action Buttons          ‚îÇ               ‚îÇ
   183‚Üí‚îÇ              ‚îÇ     (bottom panel)          ‚îÇ               ‚îÇ
   184‚Üí‚îÇ              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
   185‚Üí‚îÇ                                                             ‚îÇ
   186‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
   187‚Üí‚îÇ  ‚îÇ                   Comms Display                       ‚îÇ  ‚îÇ
   188‚Üí‚îÇ  ‚îÇ                 (bottom, modal)                       ‚îÇ  ‚îÇ
   189‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
   190‚Üí‚îÇ                                                             ‚îÇ
   191‚Üí‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ
   192‚Üí‚îÇ  ‚îÇ                   Notifications                       ‚îÇ  ‚îÇ
   193‚Üí‚îÇ  ‚îÇ                  (center, toast)                      ‚îÇ  ‚îÇ
   194‚Üí‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ
   195‚Üí‚îÇ                                                             ‚îÇ
   196‚Üí‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
   197‚Üí```
   198‚Üí
   199‚Üí### HUD Visibility States
   200‚Üí
   201‚Üí```typescript
   202‚Üíinterface HUDVisibility {
   203‚Üí  healthBar: boolean;      // Unlocked: movement tutorial
   204‚Üí  crosshair: boolean;      // Unlocked: look tutorial
   205‚Üí  killCounter: boolean;    // Unlocked: first kill
   206‚Üí  missionText: boolean;    // Unlocked: first objective
   207‚Üí  actionButtons: boolean;  // Unlocked: action tutorial
   208‚Üí  commsDisplay: boolean;   // Always available (narrative)
   209‚Üí  notifications: boolean;  // Always available
   210‚Üí}
   211‚Üí```
   212‚Üí
   213‚Üí### Tutorial Unlock Sequence
   214‚Üí
   215‚Üí1. **Start**: Only notifications visible
   216‚Üí2. **Movement Tutorial**: Health bar fades in
   217‚Üí3. **Look Tutorial**: Crosshair appears
   218‚Üí4. **Weapon Tutorial**: Ammo counter (future)
   219‚Üí5. **Action Tutorial**: Action buttons explained
   220‚Üí6. **Shooting Range**: Kill counter appears
   221‚Üí7. **Mission Start**: Full HUD unlocked
   222‚Üí
   223‚Üí---
   224‚Üí
   225‚Üí## Dynamic Action Buttons
   226‚Üí
   227‚Üí### Architecture
   228‚Üí
   229‚ÜíLevels control which action buttons appear via callbacks:
   230‚Üí
   231‚Üí```typescript
   232‚Üí// Level calls this to update HUD action buttons
   233‚Üícallbacks.onActionGroupsChange(groups: ActionButtonGroup[]);
   234‚Üí
   235‚Üí// Level registers handler for button presses
   236‚Üícallbacks.onActionHandlerRegister(handler: (actionId: string) =&gt; void);
   237‚Üí```
   238‚Üí
   239‚Üí### ActionButtonGroup Structure
   240‚Üí
   241‚Üí```typescript
   242‚Üíinterface ActionButtonGroup {
   243‚Üí  id: string;
   244‚Üí  label?: string;                    // Group header (optional)
   245‚Üí  position: &#x27;left&#x27; | &#x27;right&#x27; | &#x27;bottom&#x27;;
   246‚Üí  buttons: ActionButton[];
   247‚Üí}
   248‚Üí
   249‚Üíinterface ActionButton {
   250‚Üí  id: string;                        // Unique action identifier
   251‚Üí  label: string;                     // Display text
   252‚Üí  key: string;                       // Keyboard binding (e.g., &#x27;Space&#x27;, &#x27;KeyE&#x27;)
   253‚Üí  keyDisplay: string;                // What to show user (e.g., &#x27;SPACE&#x27;, &#x27;E&#x27;)
   254‚Üí  enabled: boolean;                  // Can be triggered?
   255‚Üí  visible: boolean;                  // Is it shown?
   256‚Üí  highlighted?: boolean;             // Pulsing attention effect
   257‚Üí  cooldown?: number;                 // Total cooldown time (ms)
   258‚Üí  cooldownRemaining?: number;        // Current remaining (ms)
   259‚Üí  progress?: number;                 // 0-1 for progress bar
   260‚Üí  progressColor?: string;            // Color of progress bar
   261‚Üí  variant?: &#x27;primary&#x27; | &#x27;secondary&#x27; | &#x27;danger&#x27; | &#x27;warning&#x27;;
   262‚Üí  size?: &#x27;small&#x27; | &#x27;medium&#x27; | &#x27;large&#x27;;
   263‚Üí  icon?: string;                     // Emoji or icon character
   264‚Üí}
   265‚Üí```
   266‚Üí
   267‚Üí### Level-Specific Action Sets
   268‚Üí
   269‚Üí#### Anchor Station (Tutorial)
   270‚Üí```typescript
   271‚Üí// Phase 1: Movement only - no buttons
   272‚Üí[]
   273‚Üí
   274‚Üí// Phase 2: Suit equip
   275‚Üí[{
   276‚Üí  id: &#x27;suit&#x27;,
   277‚Üí  position: &#x27;right&#x27;,
   278‚Üí  buttons: [
   279‚Üí    { id: &#x27;equip_suit&#x27;, label: &#x27;EQUIP SUIT&#x27;, key: &#x27;KeyE&#x27;, highlighted: true }
   280‚Üí  ]
   281‚Üí}]
   282‚Üí
   283‚Üí// Phase 3: Shooting range
   284‚Üí[{
   285‚Üí  id: &#x27;weapons&#x27;,
   286‚Üí  position: &#x27;right&#x27;,
   287‚Üí  buttons: [
   288‚Üí    { id: &#x27;fire&#x27;, label: &#x27;FIRE&#x27;, key: &#x27;Mouse0&#x27; },
   289‚Üí    { id: &#x27;reload&#x27;, label: &#x27;RELOAD&#x27;, key: &#x27;KeyR&#x27; }
   290‚Üí  ]
   291‚Üí}]
   292‚Üí
   293‚Üí// Phase 4: Ready for drop
   294‚Üí[{
   295‚Üí  id: &#x27;mission&#x27;,
   296‚Üí  position: &#x27;bottom&#x27;,
   297‚Üí  buttons: [
   298‚Üí    { id: &#x27;begin_drop&#x27;, label: &#x27;BEGIN ORBITAL DROP&#x27;, key: &#x27;Space&#x27;, variant: &#x27;danger&#x27;, size: &#x27;large&#x27; }
   299‚Üí  ]
   300‚Üí}]
   301‚Üí```
   302‚Üí
   303‚Üí#### Landfall (HALO Drop)
   304‚Üí```typescript
   305‚Üí// Phase 1: Freefall - no buttons (WASD dodge)
   306‚Üí[]
   307‚Üí
   308‚Üí// Phase 2: Post-debris, awaiting jets
   309‚Üí[{
   310‚Üí  id: &#x27;jets&#x27;,
   311‚Üí  position: &#x27;right&#x27;,
   312‚Üí  buttons: [
   313‚Üí    { id: &#x27;ignite_jets&#x27;, label: &#x27;IGNITE JETS&#x27;, key: &#x27;Space&#x27;, variant: &#x27;danger&#x27;, highlighted: true }
   314‚Üí  ]
   315‚Üí}]
   316‚Üí
   317‚Üí// Phase 3: Powered descent
   318‚Üí[{
   319‚Üí  id: &#x27;thrusters&#x27;,
   320‚Üí  position: &#x27;right&#x27;,
   321‚Üí  buttons: [
   322‚Üí    { id: &#x27;boost&#x27;, label: &#x27;BOOST&#x27;, key: &#x27;Space&#x27;, variant: &#x27;primary&#x27; },
   323‚Üí    { id: &#x27;stabilize&#x27;, label: &#x27;STABILIZE&#x27;, key: &#x27;KeyQ&#x27;, variant: &#x27;secondary&#x27; },
   324‚Üí    { id: &#x27;brake&#x27;, label: &#x27;BRAKE&#x27;, key: &#x27;KeyE&#x27;, variant: &#x27;warning&#x27; }
   325‚Üí  ]
   326‚Üí}]
   327‚Üí
   328‚Üí// Phase 4: Surface combat
   329‚Üí[{
   330‚Üí  id: &#x27;combat&#x27;,
   331‚Üí  position: &#x27;right&#x27;,
   332‚Üí  buttons: [
   333‚Üí    { id: &#x27;grenade&#x27;, label: &#x27;GRENADE&#x27;, key: &#x27;KeyG&#x27;, cooldown: 5000 },
   334‚Üí    { id: &#x27;melee&#x27;, label: &#x27;MELEE&#x27;, key: &#x27;KeyV&#x27; }
   335‚Üí  ]
   336‚Üí}]
   337‚Üí```
   338‚Üí
   339‚Üí---
   340‚Üí
   341‚Üí## Quest &amp; Marker System
   342‚Üí
   343‚Üí### Marker Types
   344‚Üí
   345‚Üí| Marker | Icon | Color | Usage |
   346‚Üí|:-------|:-----|:------|:------|
   347‚Üí| Main Objective | `!` | Gold | Primary mission goals |
   348‚Üí| Optional | `?` | Blue | Side objectives |
   349‚Üí| Interact | `[E]` | White | Interactable objects |
   350‚Üí| Enemy | `‚ñ≤` | Red | Hostile targets (optional) |
   351‚Üí| Ally | `‚ô¶` | Green | Friendly NPCs |
   352‚Üí| Waypoint | `‚óÜ` | Yellow | Navigation points |
   353‚Üí
   354‚Üí### Marker Implementation
   355‚Üí
   356‚Üí```typescript
   357‚Üíinterface QuestMarker {
   358‚Üí  id: string;
   359‚Üí  type: &#x27;main&#x27; | &#x27;optional&#x27; | &#x27;interact&#x27; | &#x27;enemy&#x27; | &#x27;ally&#x27; | &#x27;waypoint&#x27;;
   360‚Üí  position: Vector3;
   361‚Üí  visible: boolean;
   362‚Üí  distanceVisible: number;    // Max distance to show (meters)
   363‚Üí  showDistance: boolean;      // Show &quot;42m&quot; below marker
   364‚Üí  pulseEffect: boolean;       // Attention-grabbing pulse
   365‚Üí  label?: string;             // Optional text label
   366‚Üí  attachedTo?: Entity;        // Follow an entity
   367‚Üí}
   368‚Üí```
   369‚Üí
   370‚Üí### Visibility Rules
   371‚Üí
   372‚Üí1. **Distance Culling**: Markers fade at `distanceVisible`
   373‚Üí2. **Occlusion**: Markers show through walls (gameplay clarity &gt; realism)
   374‚Üí3. **Screen Edge**: Off-screen markers show as edge indicators
   375‚Üí4. **Priority**: Main &gt; Optional &gt; Interact for overlapping markers
   376‚Üí
   377‚Üí---
   378‚Üí
   379‚Üí## Input &amp; Keybindings
   380‚Üí
   381‚Üí### Default Keyboard Bindings
   382‚Üí
   383‚Üí| Action | Primary | Secondary | Description |
   384‚Üí|:-------|:--------|:----------|:------------|
   385‚Üí| Move Forward | W | ‚Üë | Move forward |
   386‚Üí| Move Back | S | ‚Üì | Move backward |
   387‚Üí| Strafe Left | A | ‚Üê | Move left |
   388‚Üí| Strafe Right | D | ‚Üí | Move right |
   389‚Üí| Look | Mouse | - | Aim/look around |
   390‚Üí| Fire | Left Click | - | Primary weapon fire |
   391‚Üí| Aim/Zoom | Right Click | - | Aim down sights |
   392‚Üí| Reload | R | - | Reload weapon |
   393‚Üí| Interact | E | - | Use/interact |
   394‚Üí| Jump | Space | - | Jump |
   395‚Üí| Crouch | Ctrl | C | Crouch/duck |
   396‚Üí| Sprint | Shift | - | Run faster |
   397‚Üí| Grenade | G | - | Throw grenade |
   398‚Üí| Melee | V | - | Melee attack |
   399‚Üí| Menu/Pause | Escape | - | Pause game |
   400‚Üí
   401‚Üí### Keybinding System
   402‚Üí
   403‚Üí```typescript
   404‚Üíinterface KeybindingConfig {
   405‚Üí  action: string;
   406‚Üí  primary: string;      // Key code (e.g., &#x27;KeyW&#x27;, &#x27;ArrowUp&#x27;)
   407‚Üí  secondary?: string;   // Alternative binding
   408‚Üí  category: &#x27;movement&#x27; | &#x27;combat&#x27; | &#x27;interaction&#x27; | &#x27;ui&#x27;;
   409‚Üí}
   410‚Üí
   411‚Üí// Settings stored in localStorage
   412‚Üíinterface UserSettings {
   413‚Üí  keybindings: KeybindingConfig[];
   414‚Üí  mouseSensitivity: number;
   415‚Üí  invertY: boolean;
   416‚Üí  // ...
   417‚Üí}
   418‚Üí```
   419‚Üí
   420‚Üí### Settings Menu Requirements
   421‚Üí
   422‚Üí**Desktop/Laptop Only** (keyboard detected):
   423‚Üí- Full keybinding customization
   424‚Üí- Mouse sensitivity slider
   425‚Üí- Invert Y-axis toggle
   426‚Üí- Key conflict detection
   427‚Üí
   428‚Üí**Touch-Only Devices**:
   429‚Üí- NO keybinding section (irrelevant)
   430‚Üí- Touch sensitivity settings
   431‚Üí- Control layout options
   432‚Üí
   433‚Üí**Detection Logic**:
   434‚Üí```typescript
   435‚Üíconst hasKeyboard = () =&gt; {
   436‚Üí  // Check for physical keyboard
   437‚Üí  return !(&#x27;ontouchstart&#x27; in window) ||
   438‚Üí         window.matchMedia(&#x27;(pointer: fine)&#x27;).matches;
   439‚Üí};
   440‚Üí```
   441‚Üí
   442‚Üí---
   443‚Üí
   444‚Üí## Level Implementation Guide
   445‚Üí
   446‚Üí### Creating a New Level
   447‚Üí
   448‚Üí1. **Create level directory**: `src/game/levels/{level-name}/`
   449‚Üí
   450‚Üí2. **Extend BaseLevel**:
   451‚Üí```typescript
   452‚Üíexport class MyLevel extends BaseLevel {
   453‚Üí  protected getBackgroundColor(): Color4 {
   454‚Üí    return new Color4(/* level-specific color */);
   455‚Üí  }
   456‚Üí
   457‚Üí  protected async createEnvironment(): Promise&lt;void&gt; {
   458‚Üí    // Create all meshes, lights, etc.
   459‚Üí  }
   460‚Üí
   461‚Üí  protected updateLevel(deltaTime: number): void {
   462‚Üí    // Update game logic each frame
   463‚Üí  }
   464‚Üí
   465‚Üí  protected disposeLevel(): void {
   466‚Üí    // Clean up level-specific resources
   467‚Üí  }
   468‚Üí}
   469‚Üí```
   470‚Üí
   471‚Üí3. **Register factory** in `factories.ts`
   472‚Üí
   473‚Üí4. **Add to CAMPAIGN_LEVELS** in `types.ts`
   474‚Üí
   475‚Üí### Level Checklist
   476‚Üí
   477‚Üí- [ ] Extends BaseLevel properly
   478‚Üí- [ ] Own Scene created (via super())
   479‚Üí- [ ] Level-specific lighting setup
   480‚Üí- [ ] Skybox/background appropriate
   481‚Üí- [ ] Action buttons configured per phase
   482‚Üí- [ ] Quest markers for objectives
   483‚Üí- [ ] Comms messages for narrative
   484‚Üí- [ ] State saved on exit
   485‚Üí- [ ] Clean dispose() implementation
   486‚Üí- [ ] Transition conditions defined
   487‚Üí
   488‚Üí---
   489‚Üí
   490‚Üí## Level Specifications
   491‚Üí
   492‚Üí### Level 1: Anchor Station (`anchor_station`)
   493‚Üí
   494‚Üí**Lore Reference**: Prologue + Chapter 1
   495‚Üí**Type**: `station`
   496‚Üí**Duration**: 5-10 minutes
   497‚Üí
   498‚Üí**Setting**:
   499‚Üí- Interior of ANCHOR STATION PROMETHEUS
   500‚Üí- Clean, industrial military aesthetic
   501‚Üí- Artificial gravity, artificial lighting
   502‚Üí- Large windows showing planet below
   503‚Üí
   504‚Üí**Rooms/Areas**:
   505‚Üí1. **Briefing Room** - Starting point, Commander Vasquez hologram
   506‚Üí2. **Corridor A** - Main walkway with crew activity
   507‚Üí3. **Equipment Bay** - Suit locker, weapon rack
   508‚Üí4. **Shooting Range** - Target practice area
   509‚Üí5. **Hangar Bay** - Drop pods visible, final destination
   510‚Üí
   511‚Üí**Key Objectives**:
   512‚Üí1. Attend briefing (story delivery)
   513‚Üí2. Navigate to Equipment Bay (movement tutorial)
   514‚Üí3. Equip ODST suit (interaction tutorial)
   515‚Üí4. Complete weapon familiarization (combat tutorial)
   516‚Üí5. Proceed to Hangar Bay (navigation)
   517‚Üí6. Board drop pod (level complete)
   518‚Üí
   519‚Üí**Progressive Unlocks**:
   520‚Üí- Phase 1: Movement only (WASD/arrows)
   521‚Üí- Phase 2: Look controls (mouse/touch)
   522‚Üí- Phase 3: Interaction (E key)
   523‚Üí- Phase 4: Combat basics (shooting range)
   524‚Üí- Phase 5: Full HUD, ready for drop
   525‚Üí
   526‚Üí**Assets Required**:
   527‚Üí- Station interior geometry (modular corridors, rooms)
   528‚Üí- PSX-style textures (metal panels, grating, displays)
   529‚Üí- NPCs (static or minimal animation)
   530‚Üí- Weapon models (M7 rifle)
   531‚Üí- Suit model on rack
   532‚Üí- Drop pod interior/exterior
   533‚Üí
   534‚Üí---
   535‚Üí
   536‚Üí### Level 2: Landfall (`landfall`)
   537‚Üí
   538‚Üí**Lore Reference**: Chapter 2
   539‚Üí**Type**: `drop` ‚Üí `canyon`
   540‚Üí**Duration**: 8-12 minutes
   541‚Üí
   542‚Üí**Setting**:
   543‚Üí- Phase 1: Space, looking down at planet
   544‚Üí- Phase 2: Asteroid/debris field (upper atmosphere)
   545‚Üí- Phase 3: Powered descent through atmosphere
   546‚Üí- Phase 4: Canyon surface, first combat
   547‚Üí
   548‚Üí**Phases**:
   549‚Üí
   550‚Üí#### Phase 1: Freefall Start (0-30 seconds)
   551‚Üí- Camera: Looking DOWN at planet
   552‚Üí- Arms extended (skydiver pose)
   553‚Üí- Planet growing larger below
   554‚Üí- Visor HUD elements visible
   555‚Üí- No action buttons yet
   556‚Üí
   557‚Üí#### Phase 2: Debris Belt (30-90 seconds)
   558‚Üí- Asteroids rushing UP past player
   559‚Üí- WASD to dodge (body position)
   560‚Üí- Impacts damage suit integrity
   561‚Üí- Tension building
   562‚Üí
   563‚Üí#### Phase 3: Powered Descent (90-150 seconds)
   564‚Üí- &quot;IGNITE JETS&quot; action button
   565‚Üí- Camera transitions to forward view
   566‚Üí- Fuel/velocity/position management
   567‚Üí- LZ beacon visible
   568‚Üí- Multiple landing outcomes
   569‚Üí
   570‚Üí#### Phase 4: Surface (remaining)
   571‚Üí- Canyon environment
   572‚Üí- First Chitin encounters
   573‚Üí- Combat tutorial in action
   574‚Üí- Navigate toward FOB Delta marker
   575‚Üí
   576‚Üí**Landing Outcomes**:
   577‚Üí| Outcome | Condition | Result |
   578‚Üí|:--------|:----------|:-------|
   579‚Üí| Perfect | On pad, low velocity | Clean start, bonus |
   580‚Üí| Near Miss | Close to pad | Fight to LZ |
   581‚Üí| Rough | Far from pad, moderate velocity | Damage, heavy combat |
   582‚Üí| Crash | High velocity | Major damage, near death |
   583‚Üí| Slingshot | Too far off course | Death, restart |
   584‚Üí
   585‚Üí**Assets Required**:
   586‚Üí- Planet sphere (growing during descent)
   587‚Üí- Asteroid meshes (varied sizes)
   588‚Üí- Arm/glove models (skydiver pose)
   589‚Üí- Thruster handle models
   590‚Üí- Canyon terrain
   591‚Üí- LZ pad geometry
   592‚Üí- Chitin enemy models (Drones, Grunts)
   593‚Üí
   594‚Üí---
   595‚Üí
   596‚Üí### Level 3: FOB Delta (`fob_delta`)
   597‚Üí
   598‚Üí**Lore Reference**: Chapter 3
   599‚Üí**Type**: `base`
   600‚Üí**Duration**: 10-15 minutes
   601‚Üí
   602‚Üí**Setting**:
   603‚Üí- Abandoned military outpost
   604‚Üí- Power flickering/offline
   605‚Üí- Signs of battle (blood, damage, debris)
   606‚Üí- Dark, claustrophobic
   607‚Üí- Horror atmosphere
   608‚Üí
   609‚Üí**Areas**:
   610‚Üí1. **Perimeter** - Breached barriers, entry point
   611‚Üí2. **Courtyard** - Central open area, overturned vehicles
   612‚Üí3. **Barracks** - Bunks, personal effects, bodies
   613‚Üí4. **Command Center** - Terminals, mission logs
   614‚Üí5. **Vehicle Bay** - Marcus&#x27;s mech signature detected
   615‚Üí6. **Underground Access** - Exit to The Breach
   616‚Üí
   617‚Üí**Key Objectives**:
   618‚Üí1. Breach perimeter
   619‚Üí2. Secure courtyard
   620‚Üí3. Access command logs (discover what happened)
   621‚Üí4. Locate Marcus&#x27;s signal
   622‚Üí5. Survive ambush (first indoor combat)
   623‚Üí6. Find underground tunnel entrance
   624‚Üí
   625‚Üí**Atmosphere Elements**:
   626‚Üí- Flickering lights
   627‚Üí- Environmental storytelling
   628‚Üí- Jump scares (carefully placed)
   629‚Üí- Motion tracker mechanic introduction
   630‚Üí- Increasing dread
   631‚Üí
   632‚Üí**Assets Required**:
   633‚Üí- Modular base structures
   634‚Üí- Military prefab buildings
   635‚Üí- Computer terminals
   636‚Üí- Mech (Marcus&#x27;s Titan visible)
   637‚Üí- Barricades, debris
   638‚Üí- Blood effects, damage decals
   639‚Üí- Chitin corpses (battle aftermath)
   640‚Üí
   641‚Üí---
   642‚Üí
   643‚Üí### Level 4: Brothers in Arms (`brothers_in_arms`)
   644‚Üí
   645‚Üí**Lore Reference**: Chapter 4
   646‚Üí**Type**: `canyon`
   647‚Üí**Duration**: 12-18 minutes
   648‚Üí
   649‚Üí**Setting**:
   650‚Üí- Open canyon environment
   651‚Üí- Large combat arena
   652‚Üí- Marcus&#x27;s mech active (AI ally)
   653‚Üí- Waves of Chitin
   654‚Üí
   655‚Üí**Key Moments**:
   656‚Üí1. Reunion with Marcus (emotional beat)
   657‚Üí2. Fight together (mech provides support fire)
   658‚Üí3. Search for hive entrance
   659‚Üí4. Major battle at The Breach entrance
   660‚Üí
   661‚Üí**Marcus AI**:
   662‚Üí- Provides covering fire
   663‚Üí- Calls out threats
   664‚Üí- Story dialogue during combat lulls
   665‚Üí- Cannot enter tunnels (mech too large)
   666‚Üí
   667‚Üí**Unique Mechanics**:
   668‚Üí- Mech ally (large-scale support)
   669‚Üí- Wave-based combat
   670‚Üí- Environmental hazards
   671‚Üí- The Breach revealed
   672‚Üí
   673‚Üí**Assets Required**:
   674‚Üí- Expanded canyon terrain
   675‚Üí- The Breach (massive sinkhole)
   676‚Üí- Titan mech (animated, firing)
   677‚Üí- Large enemy counts
   678‚Üí- Bioluminescent growths (near Breach)
   679‚Üí
   680‚Üí---
   681‚Üí
   682‚Üí### Level 5: The Breach (`the_breach`)
   683‚Üí
   684‚Üí**Lore Reference**: Chapter 5
   685‚Üí**Type**: `hive`
   686‚Üí**Duration**: 15-20 minutes
   687‚Üí
   688‚Üí**Setting**:
   689‚Üí- Underground alien tunnels
   690‚Üí- Organic architecture
   691‚Üí- Bioluminescent lighting
   692‚Üí- **Procedurally generated maze** (seeded for consistency)
   693‚Üí- Boss arena at bottom
   694‚Üí
   695‚Üí#### Procedural Maze Generation
   696‚Üí
   697‚ÜíThe Breach uses `seedrandom` to generate a consistent maze from the level seed:
   698‚Üí
   699‚Üí```typescript
   700‚Üí// Maze generation algorithm (recursive backtracking)
   701‚Üíinterface MazeCell {
   702‚Üí  x: number;
   703‚Üí  z: number;
   704‚Üí  walls: { north: boolean; south: boolean; east: boolean; west: boolean };
   705‚Üí  visited: boolean;
   706‚Üí  type: &#x27;path&#x27; | &#x27;boulder&#x27; | &#x27;acid&#x27; | &#x27;egg_cluster&#x27; | &#x27;chamber&#x27;;
   707‚Üí}
   708‚Üí
   709‚Üí// Generate maze from seed (same seed = same maze)
   710‚Üífunction generateHiveMaze(seed: string, width: number, height: number): MazeCell[][] {
   711‚Üí  const rng = seedrandom(seed);
   712‚Üí  const maze: MazeCell[][] = createGrid(width, height);
   713‚Üí
   714‚Üí  // Recursive backtracking for base maze
   715‚Üí  carve(maze, 0, 0, rng);
   716‚Üí
   717‚Üí  // Add special cells
   718‚Üí  placeBoulders(maze, rng, 0.15);      // 15% chance of boulder obstacles
   719‚Üí  placeAcidPools(maze, rng, 0.08);     // 8% chance of acid hazard
   720‚Üí  placeEggClusters(maze, rng, 0.10);   // 10% chance of egg clusters
   721‚Üí  placeChambers(maze, rng, 3);         // 3 larger chamber rooms
   722‚Üí
   723‚Üí  return maze;
   724‚Üí}
   725‚Üí```
   726‚Üí
   727‚Üí#### 3D Mesh Generation
   728‚Üí
   729‚ÜíMaze cells convert to 3D geometry using merged cubes for performance:
   730‚Üí
   731‚Üí```typescript
   732‚Üí// Convert 2D maze to 3D meshes (like QR code tutorial)
   733‚Üífunction buildMazeMeshes(scene: Scene, maze: MazeCell[][], cellSize: number): Mesh {
   734‚Üí  const wallMeshes: Mesh[] = [];
   735‚Üí
   736‚Üí  for (const row of maze) {
   737‚Üí    for (const cell of row) {
   738‚Üí      // Create wall cubes for each active wall
   739‚Üí      if (cell.walls.north) {
   740‚Üí        wallMeshes.push(createOrganicWall(scene, cell.x, cell.z, &#x27;north&#x27;, cellSize));
   741‚Üí      }
   742‚Üí      // ... other walls
   743‚Üí    }
   744‚Üí  }
   745‚Üí
   746‚Üí  // CRITICAL: Merge all walls for performance (30fps ‚Üí 60fps)
   747‚Üí  return Mesh.MergeMeshes(wallMeshes, true, true, undefined, false, true);
   748‚Üí}
   749‚Üí```
   750‚Üí
   751‚Üí#### Drill &amp; Explosives Mechanics
   752‚Üí
   753‚ÜíSome maze sections have **boulder blockages** requiring special tools:
   754‚Üí
   755‚Üí```typescript
   756‚Üí// Obstacle types and solutions
   757‚Üíinterface Obstacle {
   758‚Üí  type: &#x27;boulder&#x27; | &#x27;cave_in&#x27; | &#x27;organic_barrier&#x27;;
   759‚Üí  durability: number;      // Health points
   760‚Üí  requiredTool: &#x27;drill&#x27; | &#x27;explosives&#x27; | &#x27;acid_grenade&#x27;;
   761‚Üí  clearTime?: number;      // Seconds for drill
   762‚Üí}
   763‚Üí
   764‚Üí// Action buttons for obstacle removal
   765‚Üí[{
   766‚Üí  id: &#x27;tools&#x27;,
   767‚Üí  label: &#x27;BREACH TOOLS&#x27;,
   768‚Üí  position: &#x27;right&#x27;,
   769‚Üí  buttons: [
   770‚Üí    { id: &#x27;drill&#x27;, label: &#x27;DRILL&#x27;, key: &#x27;KeyT&#x27;, cooldown: 2000, icon: &#x27;üîß&#x27;,
   771‚Üí      progress: drillProgress, progressColor: &#x27;#FFD700&#x27; },
   772‚Üí    { id: &#x27;explosives&#x27;, label: &#x27;C4&#x27;, key: &#x27;KeyC&#x27;, cooldown: 10000, icon: &#x27;üí•&#x27;,
   773‚Üí      variant: &#x27;danger&#x27;, enabled: explosivesCount &gt; 0 }
   774‚Üí  ]
   775‚Üí}]
   776‚Üí```
   777‚Üí
   778‚Üí**Obstacle Types**:
   779‚Üí| Type | Solution | Time/Cost | Effect |
   780‚Üí|:-----|:---------|:----------|:-------|
   781‚Üí| Boulder | Drill | 3 seconds | Silent, attracts no enemies |
   782‚Üí| Cave-in | Explosives | Instant | Loud, alerts enemies in 30m radius |
   783‚Üí| Organic Barrier | Acid Grenade | Instant | Medium noise, may spawn drones |
   784‚Üí
   785‚Üí#### Marcus AI Signaling System
   786‚Üí
   787‚ÜíMarcus stays on the surface with his mech but provides tactical support via radio and signaling:
   788‚Üí
   789‚Üí```typescript
   790‚Üí// Right-side HUD for mech commands
   791‚Üí[{
   792‚Üí  id: &#x27;mech_commands&#x27;,
   793‚Üí  label: &#x27;TITAN LINK&#x27;,
   794‚Üí  position: &#x27;right&#x27;,
   795‚Üí  buttons: [
   796‚Üí    { id: &#x27;signal_recon&#x27;, label: &#x27;RECON&#x27;, key: &#x27;Digit1&#x27;, icon: &#x27;üì°&#x27;,
   797‚Üí      description: &#x27;Marcus scans for hostiles nearby&#x27; },
   798‚Üí    { id: &#x27;signal_distract&#x27;, label: &#x27;DISTRACT&#x27;, key: &#x27;Digit2&#x27;, icon: &#x27;üîä&#x27;,
   799‚Üí      cooldown: 30000, description: &#x27;Mech fires to draw enemies&#x27; },
   800‚Üí    { id: &#x27;signal_rally&#x27;, label: &#x27;RALLY&#x27;, key: &#x27;Digit3&#x27;, icon: &#x27;üéØ&#x27;,
   801‚Üí      description: &#x27;Mark waypoint for extraction&#x27; }
   802‚Üí  ]
   803‚Üí}]
   804‚Üí```
   805‚Üí
   806‚Üí**Signal Mechanics**:
   807‚Üí- **RECON**: Marcus&#x27;s sensors ping nearby hostiles (mini-map update)
   808‚Üí- **DISTRACT**: Mech fires above ground, enemies run toward sound
   809‚Üí- **RALLY**: Marcus marks optimal extraction route
   810‚Üí
   811‚Üí#### Platforming Puzzles
   812‚Üí
   813‚ÜíThe hive includes vertical sections with platforming:
   814‚Üí
   815‚Üí```typescript
   816‚Üí// Platforming obstacle types
   817‚Üítype PlatformingObstacle =
   818‚Üí  | &#x27;acid_gap&#x27;       // Jump across acid pool
   819‚Üí  | &#x27;collapsed_floor&#x27;// Navigate around hole
   820‚Üí  | &#x27;organic_bridge&#x27; // Unstable, time-limited crossing
   821‚Üí  | &#x27;egg_chamber&#x27;    // Stealth or fight choice
   822‚Üí  | &#x27;vertical_shaft&#x27; // Climb/drop with ledges
   823‚Üí```
   824‚Üí
   825‚Üí**Areas**:
   826‚Üí1. **Tunnel Entrance** - Transition from surface, first drill tutorial
   827‚Üí2. **Upper Hive** - Scout area, drones, platforming introduction
   828‚Üí3. **Mid Hive** - Maze section with boulders and cave-ins
   829‚Üí4. **Lower Hive** - Vertical descent, egg chambers
   830‚Üí5. **Queen&#x27;s Chamber** - Boss arena (hand-crafted, not procedural)
   831‚Üí
   832‚Üí**Queen Boss Fight**:
   833‚Üí- **Health**: 5000 HP
   834‚Üí- **Phases**: 3 distinct phases
   835‚Üí- **Mechanics**:
   836‚Üí  - Phase 1: Ranged attacks, spawns drones
   837‚Üí  - Phase 2: Melee attacks, spawns grunts
   838‚Üí  - Phase 3: Enraged, all attacks faster
   839‚Üí- **Victory**: Triggers hive collapse
   840‚Üí
   841‚Üí**Environmental Hazards**:
   842‚Üí- Acid pools (damage over time)
   843‚Üí- Collapsing tunnels (timed escape)
   844‚Üí- Egg clusters (spawn drones if disturbed)
   845‚Üí- Pheromone clouds (obscure vision, slow movement)
   846‚Üí- Bioluminescent spores (mark player for enemies)
   847‚Üí
   848‚Üí**Assets Required**:
   849‚Üí- Organic tunnel meshes (modular for procedural assembly)
   850‚Üí- Boulder/cave-in meshes
   851‚Üí- Bioluminescent materials
   852‚Üí- Queen model (massive, animated)
   853‚Üí- Egg cluster models
   854‚Üí- All enemy variants
   855‚Üí- Drill tool effect (particles, sound)
   856‚Üí- Explosion effect for C4
   857‚Üí
   858‚Üí---
   859‚Üí
   860‚Üí### Level 6: Extraction (`extraction`)
   861‚Üí
   862‚Üí**Lore Reference**: Chapter 6 + Epilogue
   863‚Üí**Type**: `extraction`
   864‚Üí**Duration**: 8-12 minutes
   865‚Üí
   866‚Üí**Setting**:
   867‚Üí- Race back to surface
   868‚Üí- Collapsing hive behind
   869‚Üí- Surface holdout at LZ Omega
   870‚Üí- Dropship arrival (victory)
   871‚Üí
   872‚Üí**Phases**:
   873‚Üí
   874‚Üí#### Phase 1: Escape (3-4 minutes)
   875‚Üí- Timer pressure
   876‚Üí- Collapsing tunnels
   877‚Üí- Enemies chasing
   878‚Üí- Marcus provides guidance via radio
   879‚Üí
   880‚Üí#### Phase 2: Surface Run (2-3 minutes)
   881‚Üí- Open canyon, running
   882‚Üí- Chitin pouring from multiple holes
   883‚Üí- Marcus&#x27;s mech providing cover
   884‚Üí
   885‚Üí#### Phase 3: Holdout (3-5 minutes)
   886‚Üí- Wave-based defense
   887‚Üí- Dropship ETA countdown
   888‚Üí- Marcus&#x27;s mech failing
   889‚Üí- Final desperate stand
   890‚Üí
   891‚Üí#### Phase 4: Victory
   892‚Üí- Dropship arrives
   893‚Üí- Extraction complete
   894‚Üí- Epilogue scene
   895‚Üí- Credits option
   896‚Üí
   897‚Üí**Unique Mechanics**:
   898‚Üí- Timer pressure (collapse)
   899‚Üí- Escort/defend Marcus
   900‚Üí- Final wave intensity
   901‚Üí- Cinematic victory
   902‚Üí
   903‚Üí**Assets Required**:
   904‚Üí- Collapsing tunnel effects
   905‚Üí- Dropship model
   906‚Üí- Victory scene assets
   907‚Üí- Epilogue environment (station interior)
   908‚Üí
   909‚Üí---
   910‚Üí
   911‚Üí## Asset Requirements Summary
   912‚Üí
   913‚Üí### PSX-Style Requirements
   914‚Üí
   915‚ÜíAll assets should follow PSX aesthetic:
   916‚Üí- Low polygon counts (500-2000 per model)
   917‚Üí- Pixelated textures (64x64 to 256x256)
   918‚Üí- Vertex snapping effect (optional)
   919‚Üí- Limited color palettes
   920‚Üí- No smooth shading (flat or Gouraud)
   921‚Üí
   922‚Üí### Priority Asset List
   923‚Üí
   924‚Üí1. **Player Equipment**
   925‚Üí   - Marine armor (first person arms)
   926‚Üí   - M7 rifle model
   927‚Üí   - Sidearm model
   928‚Üí
   929‚Üí2. **Environments**
   930‚Üí   - Station corridor modules
   931‚Üí   - Canyon terrain
   932‚Üí   - Base prefab buildings
   933‚Üí   - Hive tunnel segments
   934‚Üí
   935‚Üí3. **Characters**
   936‚Üí   - Marine NPCs (static)
   937‚Üí   - Marcus&#x27;s mech (Titan)
   938‚Üí   - Commander Vasquez (hologram)
   939‚Üí
   940‚Üí4. **Enemies**
   941‚Üí   - Drone (small, fast)
   942‚Üí   - Grunt (medium, standard)
   943‚Üí   - Brute (large, slow)
   944‚Üí   - Spitter (ranged)
   945‚Üí   - Queen (boss)
   946‚Üí
   947‚Üí5. **Props**
   948‚Üí   - Crates, barrels
   949‚Üí   - Computer terminals
   950‚Üí   - Drop pod
   951‚Üí   - Weapon racks
   952‚Üí   - Mech parts
   953‚Üí
   954‚Üí---
   955‚Üí
   956‚Üí## Integration Notes
   957‚Üí
   958‚Üí### GameContext Integration
   959‚Üí
   960‚ÜíLevels communicate with the HUD via GameContext:
   961‚Üí
   962‚Üí```typescript
   963‚Üí// From level to HUD
   964‚Üícallbacks.onActionGroupsChange(groups);     // Update action buttons
   965‚Üícallbacks.onActionHandlerRegister(handler); // Register button handler
   966‚Üícallbacks.onObjectiveUpdate(title, text);   // Update mission display
   967‚Üícallbacks.onCommsMessage(message);          // Show narrative
   968‚Üícallbacks.onNotification(text, duration);   // Toast notification
   969‚Üícallbacks.onHealthChange(health);           // Update health bar
   970‚Üícallbacks.onCombatStateChange(inCombat);    // Combat music trigger
   971‚Üí```
   972‚Üí
   973‚Üí### Level Transition Flow
   974‚Üí
   975‚Üí```
   976‚ÜíLevel A completes
   977‚Üí    ‚Üì
   978‚Üícallbacks.onLevelComplete(nextLevelId)
   979‚Üí    ‚Üì
   980‚ÜíLevelManager.transitionTo(nextLevelId)
   981‚Üí    ‚Üì
   982‚ÜíLevel A.prepareTransition() - fade out, save state
   983‚Üí    ‚Üì
   984‚ÜíLevel A.dispose() - cleanup
   985‚Üí    ‚Üì
   986‚ÜíLevel B = factory.create(config)
   987‚Üí    ‚Üì
   988‚ÜíLevel B.initialize() - load assets, create scene
   989‚Üí    ‚Üì
   990‚ÜíLevel B active
   991‚Üí```
   992‚Üí
   993‚Üí---
   994‚Üí
   995‚Üí*&quot;Find them. Bring them home. Or avenge them.&quot;*
   996‚Üí‚Äî Commander Elena Vasquez
   997‚Üí

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message user" id="msg-2026-01-30T06-50-56-178Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T06-50-56-178Z" class="timestamp-link"><time datetime="2026-01-30T06:50:56.178Z" data-timestamp="2026-01-30T06:50:56.178Z">2026-01-30T06:50:56.178Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>[Request interrupted by user]</p></div></div></div>
        

<div class="pagination">
<a href="index.html" class="index-link">Index</a>
<a href="page-011.html">&larr; Prev</a>
<a href="page-001.html">1</a>
<a href="page-002.html">2</a>
<a href="page-003.html">3</a>
<a href="page-004.html">4</a>
<a href="page-005.html">5</a>
<a href="page-006.html">6</a>
<a href="page-007.html">7</a>
<a href="page-008.html">8</a>
<a href="page-009.html">9</a>
<a href="page-010.html">10</a>
<a href="page-011.html">11</a>
<span class="current">12</span>
<a href="page-013.html">13</a>
<a href="page-014.html">14</a>
<a href="page-015.html">15</a>
<a href="page-016.html">16</a>
<a href="page-017.html">17</a>
<a href="page-018.html">18</a>
<a href="page-019.html">19</a>
<a href="page-020.html">20</a>
<a href="page-021.html">21</a>
<a href="page-022.html">22</a>
<a href="page-023.html">23</a>
<a href="page-024.html">24</a>
<a href="page-025.html">25</a>
<a href="page-026.html">26</a>
<a href="page-027.html">27</a>
<a href="page-028.html">28</a>
<a href="page-029.html">29</a>
<a href="page-030.html">30</a>
<a href="page-031.html">31</a>
<a href="page-032.html">32</a>
<a href="page-033.html">33</a>
<a href="page-034.html">34</a>
<a href="page-035.html">35</a>
<a href="page-036.html">36</a>
<a href="page-037.html">37</a>
<a href="page-013.html">Next &rarr;</a>
</div>

    </div>
    <script>
document.querySelectorAll('time[data-timestamp]').forEach(function(el) {
    const timestamp = el.getAttribute('data-timestamp');
    const date = new Date(timestamp);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const timeStr = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    if (isToday) { el.textContent = timeStr; }
    else { el.textContent = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + timeStr; }
});
document.querySelectorAll('pre.json').forEach(function(el) {
    let text = el.textContent;
    text = text.replace(/"([^"]+)":/g, '<span style="color: #ce93d8">"$1"</span>:');
    text = text.replace(/: "([^"]*)"/g, ': <span style="color: #81d4fa">"$1"</span>');
    text = text.replace(/: (\d+)/g, ': <span style="color: #ffcc80">$1</span>');
    text = text.replace(/: (true|false|null)/g, ': <span style="color: #f48fb1">$1</span>');
    el.innerHTML = text;
});
document.querySelectorAll('.truncatable').forEach(function(wrapper) {
    const content = wrapper.querySelector('.truncatable-content');
    const btn = wrapper.querySelector('.expand-btn');
    if (content.scrollHeight > 250) {
        wrapper.classList.add('truncated');
        btn.addEventListener('click', function() {
            if (wrapper.classList.contains('truncated')) { wrapper.classList.remove('truncated'); wrapper.classList.add('expanded'); btn.textContent = 'Show less'; }
            else { wrapper.classList.remove('expanded'); wrapper.classList.add('truncated'); btn.textContent = 'Show more'; }
        });
    }
});
</script>
</body>
</html>