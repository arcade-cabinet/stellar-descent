<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Code transcript - page 37</title>
    <style>
:root { --bg-color: #f5f5f5; --card-bg: #ffffff; --user-bg: #e3f2fd; --user-border: #1976d2; --assistant-bg: #f5f5f5; --assistant-border: #9e9e9e; --thinking-bg: #fff8e1; --thinking-border: #ffc107; --thinking-text: #666; --tool-bg: #f3e5f5; --tool-border: #9c27b0; --tool-result-bg: #e8f5e9; --tool-error-bg: #ffebee; --text-color: #212121; --text-muted: #757575; --code-bg: #263238; --code-text: #aed581; }
* { box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-color); color: var(--text-color); margin: 0; padding: 16px; line-height: 1.6; }
.container { max-width: 800px; margin: 0 auto; }
h1 { font-size: 1.5rem; margin-bottom: 24px; padding-bottom: 8px; border-bottom: 2px solid var(--user-border); }
.header-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; border-bottom: 2px solid var(--user-border); padding-bottom: 8px; margin-bottom: 24px; }
.header-row h1 { border-bottom: none; padding-bottom: 0; margin-bottom: 0; flex: 1; min-width: 200px; }
.message { margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.message.user { background: var(--user-bg); border-left: 4px solid var(--user-border); }
.message.assistant { background: var(--card-bg); border-left: 4px solid var(--assistant-border); }
.message.tool-reply { background: #fff8e1; border-left: 4px solid #ff9800; }
.tool-reply .role-label { color: #e65100; }
.tool-reply .tool-result { background: transparent; padding: 0; margin: 0; }
.tool-reply .tool-result .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff8e1); }
.message-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(0,0,0,0.03); font-size: 0.85rem; }
.role-label { font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.user .role-label { color: var(--user-border); }
time { color: var(--text-muted); font-size: 0.8rem; }
.timestamp-link { color: inherit; text-decoration: none; }
.timestamp-link:hover { text-decoration: underline; }
.message:target { animation: highlight 2s ease-out; }
@keyframes highlight { 0% { background-color: rgba(25, 118, 210, 0.2); } 100% { background-color: transparent; } }
.message-content { padding: 16px; }
.message-content p { margin: 0 0 12px 0; }
.message-content p:last-child { margin-bottom: 0; }
.thinking { background: var(--thinking-bg); border: 1px solid var(--thinking-border); border-radius: 8px; padding: 12px; margin: 12px 0; font-size: 0.9rem; color: var(--thinking-text); }
.thinking-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #f57c00; margin-bottom: 8px; }
.thinking p { margin: 8px 0; }
.assistant-text { margin: 8px 0; }
.tool-use { background: var(--tool-bg); border: 1px solid var(--tool-border); border-radius: 8px; padding: 12px; margin: 12px 0; }
.tool-header { font-weight: 600; color: var(--tool-border); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
.tool-icon { font-size: 1.1rem; }
.tool-description { font-size: 0.9rem; color: var(--text-muted); margin-bottom: 8px; font-style: italic; }
.tool-result { background: var(--tool-result-bg); border-radius: 8px; padding: 12px; margin: 12px 0; }
.tool-result.tool-error { background: var(--tool-error-bg); }
.file-tool { border-radius: 8px; padding: 12px; margin: 12px 0; }
.write-tool { background: linear-gradient(135deg, #e3f2fd 0%, #e8f5e9 100%); border: 1px solid #4caf50; }
.edit-tool { background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%); border: 1px solid #ff9800; }
.file-tool-header { font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
.write-header { color: #2e7d32; }
.edit-header { color: #e65100; }
.file-tool-icon { font-size: 1rem; }
.file-tool-path { font-family: monospace; background: rgba(0,0,0,0.08); padding: 2px 8px; border-radius: 4px; }
.file-tool-fullpath { font-family: monospace; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; word-break: break-all; }
.file-content { margin: 0; }
.edit-section { display: flex; margin: 4px 0; border-radius: 4px; overflow: hidden; }
.edit-label { padding: 8px 12px; font-weight: bold; font-family: monospace; display: flex; align-items: flex-start; }
.edit-old { background: #fce4ec; }
.edit-old .edit-label { color: #b71c1c; background: #f8bbd9; }
.edit-old .edit-content { color: #880e4f; }
.edit-new { background: #e8f5e9; }
.edit-new .edit-label { color: #1b5e20; background: #a5d6a7; }
.edit-new .edit-content { color: #1b5e20; }
.edit-content { margin: 0; flex: 1; background: transparent; font-size: 0.85rem; }
.edit-replace-all { font-size: 0.75rem; font-weight: normal; color: var(--text-muted); }
.write-tool .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #e6f4ea); }
.edit-tool .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff0e5); }
.todo-list { background: linear-gradient(135deg, #e8f5e9 0%, #f1f8e9 100%); border: 1px solid #81c784; border-radius: 8px; padding: 12px; margin: 12px 0; }
.todo-header { font-weight: 600; color: #2e7d32; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; font-size: 0.95rem; }
.todo-items { list-style: none; margin: 0; padding: 0; }
.todo-item { display: flex; align-items: flex-start; gap: 10px; padding: 6px 0; border-bottom: 1px solid rgba(0,0,0,0.06); font-size: 0.9rem; }
.todo-item:last-child { border-bottom: none; }
.todo-icon { flex-shrink: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-weight: bold; border-radius: 50%; }
.todo-completed .todo-icon { color: #2e7d32; background: rgba(46, 125, 50, 0.15); }
.todo-completed .todo-content { color: #558b2f; text-decoration: line-through; }
.todo-in-progress .todo-icon { color: #f57c00; background: rgba(245, 124, 0, 0.15); }
.todo-in-progress .todo-content { color: #e65100; font-weight: 500; }
.todo-pending .todo-icon { color: #757575; background: rgba(0,0,0,0.05); }
.todo-pending .todo-content { color: #616161; }
pre { background: var(--code-bg); color: var(--code-text); padding: 12px; border-radius: 6px; overflow-x: auto; font-size: 0.85rem; line-height: 1.5; margin: 8px 0; white-space: pre-wrap; word-wrap: break-word; }
pre.json { color: #e0e0e0; }
code { background: rgba(0,0,0,0.08); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
pre code { background: none; padding: 0; }
.user-content { margin: 0; }
.truncatable { position: relative; }
.truncatable.truncated .truncatable-content { max-height: 200px; overflow: hidden; }
.truncatable.truncated::after { content: ''; position: absolute; bottom: 32px; left: 0; right: 0; height: 60px; background: linear-gradient(to bottom, transparent, var(--card-bg)); pointer-events: none; }
.message.user .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--user-bg)); }
.message.tool-reply .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, #fff8e1); }
.tool-use .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--tool-bg)); }
.tool-result .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--tool-result-bg)); }
.expand-btn { display: none; width: 100%; padding: 8px 16px; margin-top: 4px; background: rgba(0,0,0,0.05); border: 1px solid rgba(0,0,0,0.1); border-radius: 6px; cursor: pointer; font-size: 0.85rem; color: var(--text-muted); }
.expand-btn:hover { background: rgba(0,0,0,0.1); }
.truncatable.truncated .expand-btn, .truncatable.expanded .expand-btn { display: block; }
.pagination { display: flex; justify-content: center; gap: 8px; margin: 24px 0; flex-wrap: wrap; }
.pagination a, .pagination span { padding: 5px 10px; border-radius: 6px; text-decoration: none; font-size: 0.85rem; }
.pagination a { background: var(--card-bg); color: var(--user-border); border: 1px solid var(--user-border); }
.pagination a:hover { background: var(--user-bg); }
.pagination .current { background: var(--user-border); color: white; }
.pagination .disabled { color: var(--text-muted); border: 1px solid #ddd; }
.pagination .index-link { background: var(--user-border); color: white; }
details.continuation { margin-bottom: 16px; }
details.continuation summary { cursor: pointer; padding: 12px 16px; background: var(--user-bg); border-left: 4px solid var(--user-border); border-radius: 12px; font-weight: 500; color: var(--text-muted); }
details.continuation summary:hover { background: rgba(25, 118, 210, 0.15); }
details.continuation[open] summary { border-radius: 12px 12px 0 0; margin-bottom: 0; }
.index-item { margin-bottom: 16px; border-radius: 12px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); background: var(--user-bg); border-left: 4px solid var(--user-border); }
.index-item a { display: block; text-decoration: none; color: inherit; }
.index-item a:hover { background: rgba(25, 118, 210, 0.1); }
.index-item-header { display: flex; justify-content: space-between; align-items: center; padding: 8px 16px; background: rgba(0,0,0,0.03); font-size: 0.85rem; }
.index-item-number { font-weight: 600; color: var(--user-border); }
.index-item-content { padding: 16px; }
.index-item-stats { padding: 8px 16px 12px 32px; font-size: 0.85rem; color: var(--text-muted); border-top: 1px solid rgba(0,0,0,0.06); }
.index-item-commit { margin-top: 6px; padding: 4px 8px; background: #fff3e0; border-radius: 4px; font-size: 0.85rem; color: #e65100; }
.index-item-commit code { background: rgba(0,0,0,0.08); padding: 1px 4px; border-radius: 3px; font-size: 0.8rem; margin-right: 6px; }
.commit-card { margin: 8px 0; padding: 10px 14px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 6px; }
.commit-card a { text-decoration: none; color: #5d4037; display: block; }
.commit-card a:hover { color: #e65100; }
.commit-card-hash { font-family: monospace; color: #e65100; font-weight: 600; margin-right: 8px; }
.index-commit { margin-bottom: 12px; padding: 10px 16px; background: #fff3e0; border-left: 4px solid #ff9800; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
.index-commit a { display: block; text-decoration: none; color: inherit; }
.index-commit a:hover { background: rgba(255, 152, 0, 0.1); margin: -10px -16px; padding: 10px 16px; border-radius: 8px; }
.index-commit-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; margin-bottom: 4px; }
.index-commit-hash { font-family: monospace; color: #e65100; font-weight: 600; }
.index-commit-msg { color: #5d4037; }
.index-item-long-text { margin-top: 8px; padding: 12px; background: var(--card-bg); border-radius: 8px; border-left: 3px solid var(--assistant-border); }
.index-item-long-text .truncatable.truncated::after { background: linear-gradient(to bottom, transparent, var(--card-bg)); }
.index-item-long-text-content { color: var(--text-color); }
#search-box { display: none; align-items: center; gap: 8px; }
#search-box input { padding: 6px 12px; border: 1px solid var(--assistant-border); border-radius: 6px; font-size: 16px; width: 180px; }
#search-box button, #modal-search-btn, #modal-close-btn { background: var(--user-border); color: white; border: none; border-radius: 6px; padding: 6px 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
#search-box button:hover, #modal-search-btn:hover { background: #1565c0; }
#modal-close-btn { background: var(--text-muted); margin-left: 8px; }
#modal-close-btn:hover { background: #616161; }
#search-modal[open] { border: none; border-radius: 12px; box-shadow: 0 4px 24px rgba(0,0,0,0.2); padding: 0; width: 90vw; max-width: 900px; height: 80vh; max-height: 80vh; display: flex; flex-direction: column; }
#search-modal::backdrop { background: rgba(0,0,0,0.5); }
.search-modal-header { display: flex; align-items: center; gap: 8px; padding: 16px; border-bottom: 1px solid var(--assistant-border); background: var(--bg-color); border-radius: 12px 12px 0 0; }
.search-modal-header input { flex: 1; padding: 8px 12px; border: 1px solid var(--assistant-border); border-radius: 6px; font-size: 16px; }
#search-status { padding: 8px 16px; font-size: 0.85rem; color: var(--text-muted); border-bottom: 1px solid rgba(0,0,0,0.06); }
#search-results { flex: 1; overflow-y: auto; padding: 16px; }
.search-result { margin-bottom: 16px; border-radius: 8px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
.search-result a { display: block; text-decoration: none; color: inherit; }
.search-result a:hover { background: rgba(25, 118, 210, 0.05); }
.search-result-page { padding: 6px 12px; background: rgba(0,0,0,0.03); font-size: 0.8rem; color: var(--text-muted); border-bottom: 1px solid rgba(0,0,0,0.06); }
.search-result-content { padding: 12px; }
.search-result mark { background: #fff59d; padding: 1px 2px; border-radius: 2px; }
@media (max-width: 600px) { body { padding: 8px; } .message, .index-item { border-radius: 8px; } .message-content, .index-item-content { padding: 12px; } pre { font-size: 0.8rem; padding: 8px; } #search-box input { width: 120px; } #search-modal[open] { width: 95vw; height: 90vh; } }
</style>
</head>
<body>
    <div class="container">
        <h1><a href="index.html" style="color: inherit; text-decoration: none;">Claude Code transcript</a> - page 37/37</h1>
        

<div class="pagination">
<a href="index.html" class="index-link">Index</a>
<a href="page-036.html">&larr; Prev</a>
<a href="page-001.html">1</a>
<a href="page-002.html">2</a>
<a href="page-003.html">3</a>
<a href="page-004.html">4</a>
<a href="page-005.html">5</a>
<a href="page-006.html">6</a>
<a href="page-007.html">7</a>
<a href="page-008.html">8</a>
<a href="page-009.html">9</a>
<a href="page-010.html">10</a>
<a href="page-011.html">11</a>
<a href="page-012.html">12</a>
<a href="page-013.html">13</a>
<a href="page-014.html">14</a>
<a href="page-015.html">15</a>
<a href="page-016.html">16</a>
<a href="page-017.html">17</a>
<a href="page-018.html">18</a>
<a href="page-019.html">19</a>
<a href="page-020.html">20</a>
<a href="page-021.html">21</a>
<a href="page-022.html">22</a>
<a href="page-023.html">23</a>
<a href="page-024.html">24</a>
<a href="page-025.html">25</a>
<a href="page-026.html">26</a>
<a href="page-027.html">27</a>
<a href="page-028.html">28</a>
<a href="page-029.html">29</a>
<a href="page-030.html">30</a>
<a href="page-031.html">31</a>
<a href="page-032.html">32</a>
<a href="page-033.html">33</a>
<a href="page-034.html">34</a>
<a href="page-035.html">35</a>
<a href="page-036.html">36</a>
<span class="current">37</span>
<span class="disabled">Next &rarr;</span>
</div>

        
<div class="message user" id="msg-2026-01-30T17-26-12-709Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T17-26-12-709Z" class="timestamp-link"><time datetime="2026-01-30T17:26:12.709Z" data-timestamp="2026-01-30T17:26:12.709Z">2026-01-30T17:26:12.709Z</time></a></div><div class="message-content">
<div class="user-content"><p>What if the main quest chain WAS what actually wired all the levels together? How do most games like this do it? Does that FEEL clean? What feels clean? I'm thinking what if we setup the main quest chain genuinely AS the spine of the game and it was what coordinated everything, when to unlock what, etc.... Also do not leave ANY errors or warnings unresolved, like for example WHY aren'ty we properly fixing the canyon level. NOTHING should be generic, all levels should be meticulously you-crafted, scenes painted carefully to set mood and atmosphere</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-26-15-590Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-26-15-590Z" class="timestamp-link"><time datetime="2026-01-30T17:26:15.590Z" data-timestamp="2026-01-30T17:26:15.590Z">2026-01-30T17:26:15.590Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>(no content)</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-02-525Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-02-525Z" class="timestamp-link"><time datetime="2026-01-30T17:27:02.525Z" data-timestamp="2026-01-30T17:27:02.525Z">2026-01-30T17:27:02.525Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>The user is asking a really interesting design question about how to structure the game's progression system. Let me think about this carefully.</p>
<p>The user's key points:
1. The main quest chain should BE the spine that wires levels together - not factories/managers as separate infrastructure
2. Games like this use the quest/mission system as the actual coordination mechanism
3. They want the canyon level factory fixed too (no generic stubs)
4. ALL levels should be meticulously crafted, not generic
5. No errors or warnings should remain</p>
<p>This is a significant architectural question. Let me think about how games actually do this:</p>
<p><strong>How games typically work:</strong>
- In Halo, the campaign IS the level sequence. Each mission is a self-contained level with its own environment, enemies, scripted events. The campaign structure (mission select screen, level transitions) is the spine.</p>
<ul>
<li>In DOOM and Call of Duty, the progression system similarly uses the campaign/mission structure as the actual coordination mechanism - each level is uniquely designed and the mission sequence drives everything forward.</li>
</ul>
<p>The user is essentially saying: instead of having a LevelManager + factories as separate infrastructure that coordinates levels, the <strong>quest chain itself</strong> should be what drives everything. The quest says "go here, do this" and that's what triggers level loads, unlocks, etc. This means building a CampaignManager or QuestChain that defines the full campaign as a sequence of missions, where each quest/mission knows what level to load and what conditions need to be met.</p>
<p>For the "meticulously crafted" part - I need to go through every level and ensure the factory creates a properly configured, unique experience rather than generic stubs. The canyon level factory is throwing an error because there's no generic "CanyonLevel" class - Canyon Run uses the vehicle type instead, so the unused canyon type in the LevelType union should either be removed or repurposed. I'm realizing the current architecture conflates environment types with level types, and I need to think through how these should actually map to the quest chain structure. I'm planning out the quest chain architecture with a Campaign system that tracks missions, objectives, and progression state, then designing the CampaignMission interface to hold level references, completion conditions, and narrative elements that drive when levels load and how the game progresses. I'm realizing the user wants me to flatten the abstraction layer—instead of having a generic campaign system that loads levels from a template, each mission should be explicitly defined with its own narrative context and level transitions hardcoded, making every campaign feel intentional rather than procedurally generated. The real issue is that the campaign structure should actively drive the entire flow rather than just sit as static data—I need a <code>CampaignDirector</code> that owns mission definitions, tracks progress, handles transitions between levels, and manages the narrative context, while also ensuring all the level factories are fully implemented without stubs or errors. The canyon type issue needs resolving—either aliasing it, removing it since Canyon Run uses vehicle type, or creating a proper CanyonLevel class—and then I need to systematically craft each level's environment to be atmospheric and intentional rather than generic, which is substantial enough that I should present the architectural approach to the user first.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-02-600Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-02-600Z" class="timestamp-link"><time datetime="2026-01-30T17:27:02.600Z" data-timestamp="2026-01-30T17:27:02.600Z">2026-01-30T17:27:02.600Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01CkMaMtcTwAAjeHPP1oYhLh"><div class="tool-header"><span class="tool-icon">⚙</span> EnterPlanMode</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-27-02-602Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-27-02-602Z" class="timestamp-link"><time datetime="2026-01-30T17:27:02.602Z" data-timestamp="2026-01-30T17:27:02.602Z">2026-01-30T17:27:02.602Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Entered plan mode. You should now focus on exploring the codebase and designing an implementation approach.

In plan mode, you should:
1. Thoroughly explore the codebase to understand existing patterns
2. Identify similar features and architectural approaches
3. Consider multiple approaches and their trade-offs
4. Use AskUserQuestion if you need to clarify the approach
5. Design a concrete implementation strategy
6. When ready, use ExitPlanMode to present your plan for approval

Remember: DO NOT write or edit any files yet. This is a read-only exploration and planning phase.</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-07-571Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-07-571Z" class="timestamp-link"><time datetime="2026-01-30T17:27:07.571Z" data-timestamp="2026-01-30T17:27:07.571Z">2026-01-30T17:27:07.571Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>This is a significant architectural redesign. Let me explore the codebase thoroughly to understand the current patterns, then design the campaign director approach.</p>
<p>Let me launch explore agents to understand:
1. The current campaign/level flow and how levels coordinate
2. How the existing quest/mission/objective systems work (if any)
3. What each level's environment setup looks like (to understand "meticulously crafted")</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-08-200Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-08-200Z" class="timestamp-link"><time datetime="2026-01-30T17:27:08.200Z" data-timestamp="2026-01-30T17:27:08.200Z">2026-01-30T17:27:08.200Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>This is a significant architectural question. Let me explore how the current systems work and design a campaign director approach.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-17-131Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-17-131Z" class="timestamp-link"><time datetime="2026-01-30T17:27:17.131Z" data-timestamp="2026-01-30T17:27:17.131Z">2026-01-30T17:27:17.131Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01LjPmGg2vmnPCBSJhhZj278"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Explore campaign flow and coordination</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;prompt&#34;: &#34;Explore the Stellar Descent codebase to understand the full campaign flow and level coordination. I need to understand:\n\n1. **Current level lifecycle**: How does a level get created, initialized, played through, and completed? Trace from App.tsx through GameCanvas.tsx through the level classes. What happens when a level calls `onLevelComplete`? How does the game transition between levels?\n\n2. **GameManager vs ILevel architecture**: GameCanvas.tsx has two parallel systems - `tutorialLevelRef` (ILevel architecture) and `gameManagerRef` (GameManager). What does GameManager do that ILevel doesn&#39;t? Read `src/game/core/GameManager.ts` fully. Can GameManager be replaced by ILevel-based levels?\n\n3. **Existing objective/mission systems**: Are there any objective tracking, mission state, or quest systems already built? Search for files related to objectives, missions, quests, campaigns. Check TutorialManager, any mission briefing data files, CommsMessage structures.\n\n4. **Level completion flow**: How does each level signal completion? Search for `onLevelComplete` calls in all level classes. What triggers completion in each level?\n\n5. **Save/persistence system**: Read `src/game/persistence/` directory. How does the save system currently track campaign progress? What does `saveSystem.completeLevel()` do?\n\nBe thorough - read full files where needed. I need the complete picture of how campaign flow works today.&#34;,
  &#34;subagent_type&#34;: &#34;Explore&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-26-321Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-26-321Z" class="timestamp-link"><time datetime="2026-01-30T17:27:26.321Z" data-timestamp="2026-01-30T17:27:26.321Z">2026-01-30T17:27:26.321Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Fzsn7S59xA5gqu7SwXJvCw"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Explore level environments and atmosphere</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;prompt&#34;: &#34;Explore the Stellar Descent codebase to understand how each level creates its unique environment and atmosphere. I need to understand what makes each level distinct:\n\n1. **Read each level&#39;s main class** (first 100 lines + environment setup methods):\n   - `src/game/levels/anchor-station/AnchorStationLevel.ts`\n   - `src/game/levels/landfall/LandfallLevel.ts`\n   - `src/game/levels/canyon-run/CanyonRunLevel.ts`\n   - `src/game/levels/fob-delta/FOBDeltaLevel.ts`\n   - `src/game/levels/brothers-in-arms/BrothersInArmsLevel.ts`\n   - `src/game/levels/southern-ice/SouthernIceLevel.ts`\n   - `src/game/levels/the-breach/TheBreachLevel.ts`\n   - `src/game/levels/hive-assault/HiveAssaultLevel.ts`\n   - `src/game/levels/extraction/ExtractionLevel.ts`\n   - `src/game/levels/final-escape/FinalEscapeLevel.ts`\n\n2. **Read the environment setup files**: Each level directory has an `environment.ts` - read each one to understand terrain, lighting, skybox, atmosphere setup.\n\n3. **BaseLevel and SurfaceLevel**: Read `src/game/levels/BaseLevel.ts` and `src/game/levels/SurfaceLevel.ts` to understand the inheritance hierarchy and what base functionality is shared.\n\n4. **LevelType &#39;canyon&#39;**: The `canyon` LevelType exists in types.ts but no campaign level uses it (Canyon Run uses `vehicle`). Is the canyon type used anywhere? Should it be removed?\n\n5. **What&#39;s generic vs unique**: For each level, note what&#39;s genuinely unique (custom terrain, lighting, enemies, scripted events) vs what&#39;s inherited/generic from BaseLevel/SurfaceLevel.\n\nReport on each level&#39;s atmosphere: lighting colors, terrain type, skybox, weather, enemies, and any scripted sequences.&#34;,
  &#34;subagent_type&#34;: &#34;Explore&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-27-36-107Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-27-36-107Z" class="timestamp-link"><time datetime="2026-01-30T17:27:36.107Z" data-timestamp="2026-01-30T17:27:36.107Z">2026-01-30T17:27:36.107Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01W4tUq84VsCPpxaHuFspNFg"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Explore biome warnings and dead code</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;prompt&#34;: &#34;Explore the Stellar Descent codebase to catalog ALL warnings, dead code, and unresolved issues:\n\n1. **Run biome check** (read-only): Check `biome.json` to see which rules are downgraded to warnings. List ALL the warning-producing rules and understand why they were downgraded. Are any of these actually fixable?\n\n2. **Dead/unused code audit**:\n   - `src/game/levels/mining-depths/` - Is this used anywhere? Is it referenced by any import?\n   - `src/game/vehicles/PhantomDropship.ts`, `WraithTank.ts`, `VehicleBase.ts`, `VehicleHUD.tsx` - Used anywhere?\n   - `src/game/levels/SurfaceLevel.ts` and `src/game/levels/StationLevel.ts` - Are these still needed? What extends them?\n   - `src/game/levels/AnchorStationLevelV2.ts` - What is this? Used anywhere?\n   - `src/game/audio/ReyesDialogue.ts` - Imported anywhere?\n\n3. **Collectible systems**: \n   - `src/game/collectibles/` - Read SkullSystem.ts, audioLogs.ts. Are these imported by any level?\n   - Achievement system: `src/game/achievements/` - What achievements exist and which are tracked?\n\n4. **Unused imports in levels**: Search for `getAchievementManager` imports that are never called. Search for any other unused imports in level files.\n\n5. **TypeScript unused exports**: Check if the `canyon` LevelType and `canyonLevelFactory` are used by anything.\n\nReport a complete inventory of dead code, unused imports, and unresolved warnings.&#34;,
  &#34;subagent_type&#34;: &#34;Explore&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-28-26-297Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-28-26-297Z" class="timestamp-link"><time datetime="2026-01-30T17:28:26.297Z" data-timestamp="2026-01-30T17:28:26.297Z">2026-01-30T17:28:26.297Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Perfect. I now have a comprehensive understanding of the codebase. Let me compile my findings into a detailed report:

## Comprehensive Analysis: Stellar Descent Campaign Flow &amp; Level Coordination

I&#x27;ve thoroughly explored the Stellar Descent codebase. Here&#x27;s the complete picture of how campaign flow works today:

---

### 1. **CURRENT LEVEL LIFECYCLE**

The level lifecycle follows this flow:

```
App.tsx (game state machine)
  ├─ &#x27;loading&#x27; state: assets load
  ├─ &#x27;tutorial&#x27;/&#x27;playing&#x27;/&#x27;dropping&#x27;: GameCanvas mounts level
  └─ Level emits onLevelComplete callback → &#x27;levelComplete&#x27; state
```

**Flow in GameCanvas.tsx:**

1. **Initialization (useEffect line 308-516)**: Babylon engine created, scene setup, camera configured
2. **State transition (useEffect line 564-758)**: Based on `gameState`, GameCanvas creates either:
   - `tutorialLevelRef` (ILevel-compliant) for tutorial/custom levels via factory
   - `gameManagerRef` (GameManager class) for open-world drop sequences
3. **Update loop (line 463-493)**: Each frame, calls `update(deltaTime)` on active level/manager
4. **Render (line 481, 488, 491)**: Renders either level&#x27;s scene or shared scene
5. **Level completion**: Level calls `callbacks.onLevelComplete(nextLevelId)` → GameCanvas triggers `onLevelComplete()` prop → App.tsx sets state to &#x27;levelComplete&#x27;

**In App.tsx (line 322-339):**
```typescript
handleLevelComplete = () =&gt; {
  saveSystem.completeLevel(currentLevelId);  // Mark level complete
  setGameState(&#x27;levelComplete&#x27;);             // Show completion screen
}
```

**Transition to next level (line 342-361):**
```typescript
handleContinueToNextLevel = () =&gt; {
  const nextLevelId = CAMPAIGN_LEVELS[currentLevelId].nextLevelId;
  if (nextLevelId) {
    setCurrentLevelId(nextLevelId);
    setGameState(&#x27;briefing&#x27;);                // Show mission briefing
  } else {
    setGameState(&#x27;credits&#x27;);                 // Final level → credits
  }
}
```

---

### 2. **GAMEMANGER VS ILEVEL ARCHITECTURE**

**Two parallel systems coexist:**

**ILevel-based (src/game/levels/BaseLevel.ts):**
- Abstract base class with `initialize()`, `update(deltaTime)`, `dispose()`, `getScene()`
- **Used for:** Tutorial (Anchor Station), custom campaign levels (FOB Delta, Extraction, etc.)
- **Factory pattern:** `defaultLevelFactories` map level type to factory functions
- **Each level creates its own Scene** and manages rendering internally (line 481: `tutorialLevelRef.current.getScene().render()`)
- Implements full ILevel interface: callbacks, state management, pointer lock, touch input

**GameManager class (src/game/core/GameManager.ts):**
- **Completely different:** NOT an ILevel. Manages ECS world, player, AI, combat
- **Used for:** Open-world surface gameplay (Landfall drop + ground combat)
- **Limitations:** 
  - Doesn&#x27;t create its own Scene (shares GameCanvas&#x27;s scene)
  - No ILevel compliance (no getScene(), initialize promise, etc.)
  - Tightly coupled to ECS architecture
  - Can&#x27;t be swapped in/out like factory-created levels

**Why the split?**
- **ILevel:** Better for scripted, structured levels (stations, linear campaigns)
- **GameManager:** Built for chunk-based world generation and procedural spawning

**Can GameManager be replaced by ILevel?** 
- **Not directly.** GameManager is architectural; would need a `LandfallLevel extends BaseLevel` that wraps/manages the GameManager internally, or refactor GameManager to be ILevel-compliant.

---

### 3. **EXISTING OBJECTIVE/MISSION SYSTEMS**

**Mission briefing system:** (MissionBriefing.tsx)
- Centralized briefing data from lore: `MISSION_BRIEFINGS` (mission1-mission10)
- Generates `MissionBriefingData` interface with:
  - `commanderBriefing`: narrative text from lore
  - `objectives`: string array of mission goals
  - `enemyIntel`: array of enemy types with threat levels and weaknesses
  - `suggestedLoadout`: equipment recommendations
  - `threatLevel`: escalation indicator

**Tutorial objective system:** (TutorialManager.ts + tutorialSteps.ts)
- Progressive tutorial with phases (0-4):
  - Phase 0: Briefing only
  - Phase 1: Movement enabled
  - Phase 2: Look + interaction
  - Phase 3: Weapon firing
  - Phase 4: Drop pod ready
- `setObjective(title, instructions)` callback from GameContext (line 275 in GameCanvas)

**Level-specific objectives:**
- BaseLevel: `callbacks.onObjectiveUpdate(title, instructions)`
- Each level can call this to update mission display
- No persistent objective tracking system yet (not in GameSave)

**CommsMessage system:** (src/game/types.ts)
- UI Component receives `CommsMessage[]` from game context
- Levels trigger: `callbacks.onCommsMessage(msg)` → shows in CommsDisplay
- No conversation tree or branching dialogue

---

### 4. **LEVEL COMPLETION FLOW**

**How each level signals completion:**

**BaseLevel.ts (line 336+ in abstract base):**
```typescript
completeLevel(nextLevelId: LevelId | null = null) {
  getAchievementManager().onLevelComplete(this.id, this.playerDiedInLevel);
  this.callbacks.onLevelComplete(this.config.nextLevelId);
}
```

**Concrete implementations:**

1. **AnchorStationLevel** (Tutorial): TutorialManager completes phase 4 → calls `completeLevel()`
2. **LandfallLevel**: When landing completes (any outcome except crash) → calls `completeLevel()`
3. **ExtractionLevel** (line 320-380): 
   - Wave 7 defeat + escape → enters &quot;victory&quot; phase
   - Dropship reaches player → calls `completeLevel()`
   - **Special:** Also calls achievement: `getAchievementManager().onLevelComplete(this.id, false)`

**OnLevelComplete call sites (10 locations found):**
- App.tsx: `saveSystem.completeLevel(currentLevelId)` + state transition
- BaseLevel.ts: Core implementation
- ExtractionLevel.ts: Dropship victory
- AchievementManager.test.ts: Test coverage

---

### 5. **SAVE/PERSISTENCE SYSTEM**

**SaveSystem.ts structure:**

**GameSave interface** (src/game/persistence/GameSave.ts):
```typescript
{
  id: string;
  currentLevel: LevelId;
  levelsCompleted: LevelId[];        // ← Progress tracking
  levelsVisited: LevelId[];
  currentChapter: number;
  playerHealth: number;
  playerPosition: { x, y, z };
  playerRotation: number;
  totalKills: number;
  totalDistance: number;
  playTime: number;
  tutorialCompleted: boolean;
  difficulty: DifficultyLevel;
  levelFlags: Record&lt;LevelId, Record&lt;string, boolean&gt;&gt;;
  inventory: Record&lt;string, number&gt;;
  objectives: Record&lt;string, boolean&gt;;  // ← Objective tracking (unused currently)
  version: 2;  // Migration support
}
```

**Key save methods:**

- `completeLevel(levelId)` (line 257-266): 
  ```typescript
  completeLevel(levelId: LevelId): void {
    if (!this.currentSave.levelsCompleted.includes(levelId)) {
      this.currentSave.levelsCompleted.push(levelId);
    }
    this.autoSave();  // ← Auto-saves on completion
  }
  ```

- `setCurrentLevel(levelId)` (line 244-252): Updates current level, adds to visited
- `autoSave()` (line 209-217): Called on level completion, persists to IndexedDB
- `persistSave()` (line 456-465): Writes to worldDb (chunk-based storage) + IndexedDB
- `newGame()` (line 100-125): Creates fresh save with default values
- `loadGame()` (line 130-163): Loads from IndexedDB with version migration

**Persistence mechanism:**
- Uses `worldDb.setChunkData()` to store save as JSON string in worldDatabase
- `persistToIndexedDB()` flushes to IndexedDB for offline PWA support
- Single save slot system (PRIMARY_SAVE_ID = &#x27;primary&#x27;)

---

### 6. **CAMPAIGN PROGRESSION STRUCTURE**

**Linked list architecture** (types.ts line 197-478):

```
anchor_station → landfall → canyon_run → fob_delta → brothers_in_arms
    ↓            ↓            ↓            ↓            ↓
  Ch. 1        Ch. 2        Ch. 3        Ch. 4        Ch. 5
  
→ southern_ice → the_breach → hive_assault → extraction → final_escape
    Ch. 6        Ch. 7        Ch. 8          Ch. 9        Ch. 10
```

Each LevelConfig has:
- `nextLevelId` / `previousLevelId` (linked list pointers)
- `chapter` number (1-10)
- `actName` (ACT 1-4)
- `missionName` + `missionSubtitle`
- `type` (level type for factory system)

**Traversal utilities:**
- `getNextLevel(levelId)`: Get next level config
- `getFirstLevel()`: Head of linked list
- `getTotalLevels()`: Count by traversing (returns 10)
- `getLevelIndex(levelId)`: Get 0-indexed position
- `iterateLevels()`: Generator for iteration

---

### 7. **KEY ARCHITECTURAL OBSERVATIONS**

**Strengths:**
1. **Clean separation:** App.tsx manages flow state, GameCanvas manages rendering
2. **Factory pattern:** Flexible level instantiation by type
3. **Callback-based:** Levels emit events back to React context (non-invasive)
4. **Save system:** Tracks campaign progress per level, supports migration

**Gaps/Limitations:**
1. **No mission state machine:** Levels don&#x27;t have internal state about objectives/flags
2. **No quest system:** `objectives` dict in GameSave is empty (never populated)
3. **GameManager not ILevel:** Two incompatible systems for different level types
4. **No cinematic sequencing:** Hard-coded phases per level, not a reusable system
5. **No dialogue tree:** CommsMessages are flat, one-way
6. **No encounter/wave system:** Each level reimplements (ExtractionLevel has 7 waves, etc.)
7. **No streaming/checkpoint system:** Levels restart from beginning if player dies

---

### 8. **STATE FLOW DIAGRAM**

```
                      START
                        ↓
                  ┌─────────────┐
                  │ title screen│
                  └──────┬──────┘
                         ↓
                  ┌─────────────┐
                  │  main menu  │
                  └──────┬──────┘
                         ↓
        ┌────────────────┴────────────────┐
        ↓                                 ↓
   [New Game]                      [Continue]
        ↓                                 ↓
   set currentLevelId          load from saveSystem
        ↓                                 ↓
   ┌─────────────┐               ┌─────────────┐
   │  briefing   │◄──────────────►│  briefing   │
   └──────┬──────┘               └──────┬──────┘
          ↓                             ↓
   ┌─────────────┐               [same path]
   │ intro/load  │
   └──────┬──────┘
          ↓
   ┌─────────────────┐
   │ loading screen  │
   └──────┬──────────┘
          ↓
      ╔═══════════════════════════════════════════╗
      ║  [ANCHOR_STATION: tutorial state]         ║
      ║  Create tutorialLevelRef (ILevel)         ║
      ║  Render: tutorialLevelRef.getScene()      ║
      ╚═══════════════════════════════════════════╝
          ↓ (TutorialManager completes phase 4)
      ┌──────────┐
      │ dropping │
      └──────┬───┘
             ↓
      ╔═══════════════════════════════════════════╗
      ║  [LANDFALL: drop state]                   ║
      ║  Create gameManagerRef (NOT ILevel)       ║
      ║  Render: scene (shared Babylon scene)     ║
      ║  Player descends, manages fuel, lands     ║
      ╚═══════════════════════════════════════════╝
             ↓ (Landing complete)
      ┌──────────┐
      │ playing  │  [CANYON_RUN/FOB_DELTA/etc]
      │ [all     │  Create levelRef (ILevel via factory)
      │  other   │  Custom level gameplay
      │  levels] │  Render: levelRef.getScene()
      └──────┬───┘
             ↓ (Level emits onLevelComplete)
      ┌──────────────────┐
      │ levelComplete    │
      │ (stats screen)   │
      └──────┬───────────┘
             ↓
     ┌───────┴───────┐
     ↓               ↓
  [Retry]      [Continue]
     ↓               ↓
   reload          nextLevelId?
                     ├─ YES: loop back to briefing
                     └─ NO: show credits
```

---

### 9. **CODE EXAMPLES: KEY INTEGRATION POINTS**

**App.tsx: Level completion handling (322-361)**
```typescript
const handleLevelComplete = useCallback(() =&gt; {
  const timeElapsed = (Date.now() - levelStartTimeRef.current) / 1000;
  const stats: LevelStats = { timeElapsed, kills, ... };
  setCompletionStats(stats);
  saveSystem.completeLevel(currentLevelId);  // ← Mark complete in save
  setGameState(&#x27;levelComplete&#x27;);             // ← Show UI
}, [kills, currentLevelId]);

const handleContinueToNextLevel = useCallback(() =&gt; {
  const nextLevelId = CAMPAIGN_LEVELS[currentLevelId]?.nextLevelId;
  if (nextLevelId) {
    setCurrentLevelId(nextLevelId);
    setGameState(&#x27;briefing&#x27;);                // ← Show mission briefing
  } else {
    setGameState(&#x27;credits&#x27;);                 // ← End of campaign
  }
}, [currentLevelId]);
```

**GameCanvas.tsx: Level factory instantiation (631-647)**
```typescript
const levelConfig = CAMPAIGN_LEVELS.anchor_station;
const factory = defaultLevelFactories[levelConfig.type];
tutorialLevelRef.current = factory(engine, canvas, levelConfig, levelCallbacks);
tutorialLevelRef.current.initialize().then(() =&gt; {
  // Level ready
}).catch((e) =&gt; {
  console.error(&#x27;Level init failed:&#x27;, e);
});
```

**BaseLevel.ts: Core completion (abstract)**
```typescript
protected completeLevel(nextLevelId: LevelId | null = null): void {
  getAchievementManager().onLevelComplete(this.id, this.playerDiedInLevel);
  this.callbacks.onLevelComplete(this.config.nextLevelId);  // ← Emit callback
}
```

**SaveSystem.ts: Persistence (257-266)**
```typescript
completeLevel(levelId: LevelId): void {
  if (!this.currentSave.levelsCompleted.includes(levelId)) {
    this.currentSave.levelsCompleted.push(levelId);
  }
  this.autoSave();  // ← Auto-persist to IndexedDB
}
```

---

### Summary Table

| Aspect | Current Implementation |
|--------|------------------------|
| **Level lifecycle** | Factory-based ILevel or GameManager (two systems) |
| **Campaign structure** | Linked list of 10 levels (anchor_station → final_escape) |
| **State management** | React state machine in App.tsx (9 game states) |
| **Persistence** | SaveSystem with GameSave interface, IndexedDB backend |
| **Save tracking** | `levelsCompleted[]` + `currentLevel` |
| **Completion signal** | `callbacks.onLevelComplete(nextLevelId)` → App → completion screen |
| **Next level transition** | Via `CAMPAIGN_LEVELS[id].nextLevelId` linked list |
| **Objective tracking** | CommsMessages + MissionBriefing, NO persistent state |
| **Mission briefing** | Static data per chapter from lore system |
| **Auto-save** | On level completion via `saveSystem.completeLevel()` |

This is a solid architecture with clear separation of concerns, but it trades flexibility for coupling—each level type (tutorial vs GameManager vs factory ILevels) works differently, making it hard to add new level types or cross-level systems (like persistent quests or dialogue trees).</pre><pre>agentId: a4400b5 (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-28-32-795Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-28-32-795Z" class="timestamp-link"><time datetime="2026-01-30T17:28:32.795Z" data-timestamp="2026-01-30T17:28:32.795Z">2026-01-30T17:28:32.795Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Perfect! Now I have enough information. Let me create a comprehensive report of my findings:

## COMPREHENSIVE AUDIT: WARNINGS, DEAD CODE, AND UNRESOLVED ISSUES

### 1. BIOME LINTER CONFIGURATION - WARNING-LEVEL RULES

**File:** `/Users/jbogaty/src/arcade-cabinet/stellar-descent/biome.json`

The following rules are downgraded from error to warning level:

#### Correctness Warnings:
- `useExhaustiveDependencies` (React hooks) - Likely necessary due to intentional circular dependencies or external state
- `useHookAtTopLevel` (React hook placement) - Some valid overrides likely exist
- `noUnknownMediaFeatureName` (CSS) - Custom media features or vendor prefixes in CSS modules

#### Suspicious Warnings:
- `useIterableCallbackReturn` - Possible missing return statements in iterator callbacks
- `noAssignInExpressions` - Assignment inside conditional expressions (often legitimate in game loops)
- `noArrayIndexKey` (React lists) - Using array index as key in lists (anti-pattern but sometimes unavoidable)
- `noCommentText` - Text-based comments instead of semantic ones

#### Accessibility Warnings:
- `useAriaPropsSupportedByRole` - ARIA attribute misuse
- `useSemanticElements` - Missing semantic HTML
- `noLabelWithoutControl` - Form labels not associated with controls
- `noStaticElementInteractions` - Interactive event handlers on static elements
- `noSvgWithoutTitle` - SVG images without title/description
- `useKeyWithClickEvents` - Click handlers without keyboard equivalents
- `useButtonType` - Button elements missing type attribute
- `noAutofocus` - Auto-focus attributes that harm UX

**Assessment:** Most of these are legitimately downgraded. The accessibility warnings suggest the project is primarily a game (not a traditional web app), where some accessibility rules don&#x27;t apply.

---

### 2. DEAD CODE AUDIT

#### 2.1 **Unused Level Files**

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/`**
- **Files:** `MiningDepthsLevel.ts`, `environment.ts`
- **Status:** DEAD CODE
- **Evidence:** 
  - No imports found in any level index or factory
  - Not referenced in `CAMPAIGN_LEVELS` in `types.ts`
  - Type `LevelId` does not include &#x27;mining_depths&#x27;
  - Type `LevelType` does not include &#x27;mining&#x27; type
  - Factory registry in `factories.ts` has no mining depth factory
- **Scope:** ~2,000+ LOC of unused level implementation with complete enemy AI, boss fight, audio logs, and hazard systems

#### 2.2 **Unused Base Classes**

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/SurfaceLevel.ts`**
- **Status:** POTENTIALLY UNUSED (abstract base)
- **Evidence:** 
  - Grep found it referenced in `southern-ice/SouthernIceLevel.ts`, `hive-assault/HiveAssaultLevel.ts`, `canyon-run/CanyonRunLevel.ts`, `landfall/LandfallLevel.ts`
  - **Verdict:** USED - Multiple concrete levels extend it
  
**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/StationLevel.ts`**
- **Status:** POTENTIALLY UNUSED (abstract base)
- **Evidence:**
  - Only `AnchorStationLevel` imports it
  - Grep found: `src/game/levels/anchor-station/index.ts` and `src/game/levels/index.ts` reference it
  - **Verdict:** USED - Referenced in exports and one concrete level

#### 2.3 **Unreferenced AnchorStationLevelV2**

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/AnchorStationLevelV2.ts`**
- **Status:** DEAD CODE (no grep results)
- **Evidence:**
  - No imports found anywhere in the codebase
  - Not referenced in factory, main level index, or App
  - V1 (`AnchorStationLevel.ts`) is actively used
  - **Verdict:** V2 is abandoned/unreferenced copy-paste code

#### 2.4 **Vehicle System Dead Code**

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/`**
- **Files:** `PhantomDropship.ts`, `WraithTank.ts`, `VehicleBase.ts`, `VehicleHUD.tsx`
- **Status:** EXPORTED BUT LIKELY UNUSED
- **Evidence:**
  - All files are properly exported in `index.ts`
  - Grep searches found NO imports of these files from any level
  - No references to `PhantomDropship`, `WraithTank`, or `VehicleHUD` in level files
  - `VehicleBase.ts` is ~550 LOC of unused abstraction
  - **Verdict:** DEAD CODE - Vehicle system is fully implemented but not integrated into any level

#### 2.5 **Audio System Files**

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/audio/ReyesDialogue.ts`**
- **Status:** IMPLEMENTED BUT LIKELY UNUSED IN GAME LOOP
- **Evidence:**
  - 822 LOC complete dialogue management system
  - Grep found 8 files referencing `getAchievementManager().onSecretFound()` pattern
  - ReyesDialogue file itself is NEVER imported anywhere
  - No grep matches for `ReyesDialogueManager` or `getReyesDialogueManager`
  - **Verdict:** DEAD CODE - Dialogue system created but never instantiated

---

### 3. COLLECTIBLE SYSTEMS AUDIT

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/collectibles/`**

Files found:
- `SkullSystem.ts`, `SkullPickup.ts`
- `AudioLogSystem.ts` 
- `SecretAreaSystem.ts`
- Persistence files: `skullPersistence.ts`, `audioLogPersistence.ts`, `secretPersistence.ts`
- Data files: `audioLogs.ts`, `secrets.ts`

**Status:** MIXED USAGE
- `getAchievementManager().onSecretFound()` calls found in 8 files (real integration)
- All systems have test files and persistence
- **Verdict:** USED - Systems are integrated, but may have unused functions within them

---

### 4. ACHIEVEMENT SYSTEM AUDIT

**`/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/achievements/`**

- **AchievementManager.ts:** 100+ achievement definitions (first_steps, queen_slayer, etc.)
- **Status:** IMPLEMENTED BUT PARTIALLY UNUSED
- **Evidence:**
  - 8 files call `getAchievementManager().onSecretFound()`
  - Only `onSecretFound()` is actively called in code
  - Other achievement tracking methods (onKill, onObjectiveComplete, etc.) NOT FOUND in grep results
  - **Verdict:** PARTIALLY DEAD - Only secret achievement tracking is active; 36+ achievement types defined but not triggered

---

### 5. UNUSED IMPORTS IN LEVELS

**getAchievementManager Imports:**
- Found in: 8 level files
- Only method called: `.onSecretFound()`
- Unused methods in all those files:
  - `onKill()` 
  - `onObjectiveComplete()`
  - `onDamageEvent()`
  - All other stat-tracking methods

**Example from MiningDepthsLevel.ts (line 34, 890):**
```typescript
import { getAchievementManager } from &#x27;../../achievements&#x27;;
// ... later at line 890 only:
getAchievementManager().onSecretFound();
```

---

### 6. UNUSED TYPESCRIPT EXPORTS

**Canyon Level Type:**
- **Type defined:** `LevelType` includes `&#x27;canyon&#x27;` (line 34 of types.ts)
- **Type defined:** `LevelId` does NOT include any canyon level
- **Factory defined:** `canyonLevelFactory` in factories.ts (lines 55-62)
- **Status:** INTENTIONALLY UNIMPLEMENTED
- **Factory code:**
```typescript
export const canyonLevelFactory: LevelFactory = (
  _engine: Engine,
  _canvas: HTMLCanvasElement,
  _config: LevelConfig,
  _callbacks: LevelCallbacks
): ILevel =&gt; {
  throw new Error(&#x27;Canyon level type is not yet implemented. Awaiting CanyonLevel class.&#x27;);
};
```
- **Verdict:** Type exists but throws on instantiation. Used by `canyon_run` LevelId but mapped to `vehicleLevelFactory` instead.

---

### 7. SUMMARY TABLE

| Item | Type | Size | Status | Impact |
|------|------|------|--------|--------|
| MiningDepthsLevel + environment | Level | 2,000+ LOC | DEAD | High - full level system |
| AnchorStationLevelV2 | Level | ~1,500 LOC | DEAD | Medium - duplicate |
| Vehicle System (all 4 files) | Feature | ~1,200 LOC | DEAD | High - integrated abstraction |
| ReyesDialogueManager | Feature | 822 LOC | DEAD | Medium - complete system |
| Achievement System (partial) | Feature | ~500 LOC tracked | DEAD | Low-Medium - only secrets used |
| Unused Achievement Methods | Code | 20+ methods | DEAD | Low - defined but never called |
| Canyon LevelType | Type System | Minimal | STUB | Low - throws on load |

---

### 8. RECOMMENDATIONS FOR CLEANUP

1. **Remove mining-depths/** - Completely unused level directory
2. **Remove AnchorStationLevelV2.ts** - Duplicate of V1
3. **Remove/Archive Vehicle System** - Or integrate into one level if planned
4. **Remove ReyesDialogueManager** - Or integrate into at least one level
5. **Audit Achievement System** - Only keep `onSecretFound()` or implement full tracking
6. **Remove canyon LevelType** - Conflicts with canyon_run using vehicle factory

This audit reveals that approximately **5,000-6,000 LOC of complete, well-structured code exists but is never executed in the game loop**.</pre><pre>agentId: abe810b (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-28-59-453Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-28-59-453Z" class="timestamp-link"><time datetime="2026-01-30T17:28:59.453Z" data-timestamp="2026-01-30T17:28:59.453Z">2026-01-30T17:28:59.453Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Now let me compile a comprehensive report with all the information I&#x27;ve gathered. Let me create a summary document:

Based on my comprehensive exploration of the Stellar Descent codebase, here&#x27;s a detailed analysis of each level&#x27;s environment and atmosphere:

---

## STELLAR DESCENT LEVEL ENVIRONMENTS &amp; ATMOSPHERE ANALYSIS

### **INHERITANCE HIERARCHY**

```
BaseLevel (abstract)
├── StationLevel (abstract) - Interior space stations
│   └── AnchorStationLevel (Chapter 1)
└── SurfaceLevel (abstract) - Outdoor planetary surfaces
    ├── LandfallLevel (Chapter 2)
    ├── CanyonRunLevel (Chapter 3)
    ├── SouthernIceLevel (Chapter 6)
    ├── BrothersInArmsLevel (Chapter 5)
    ├── ExtractionLevel (Chapter 9)
    ├── FinalEscapeLevel (Chapter 10)
    ├── HiveAssaultLevel (Chapter 8)
    └── FOBDeltaLevel (Chapter 4) - Extends BaseLevel directly (abandoned base)
```

**BaseLevel provides:**
- Scene creation, camera management, pointer lock
- ECS world integration
- Post-processing effects (film grain, vignette, color grading, combat feedback)
- Weather system integration
- Atmospheric effects (god rays, emergency lights, spore clouds)
- Camera shake system
- Environmental audio system with spatial sound, zones, and occlusion
- Achievement tracking

---

## LEVEL BREAKDOWN

### **1. ANCHOR STATION PROMETHEUS** (Chapter 1)
**Type:** `station` | **Base Class:** StationLevel

**Unique Characteristics:**
- Modular GLB-based construction (snap-together corridor segments)
- Room layout: Briefing Room → Corridor A → Equipment Bay / Shooting Range / Hangar Bay
- **Lighting:** Interior point lights + emergency red lights (flickering optional)
- **Skybox:** Space view with distant reddish-brown planet through windows
- **Atmosphere:** Dark, sterile station interior (clear color: 0.01, 0.01, 0.02)
- **Movement Speed:** 4 m/s (slower for careful station navigation)

**Key Features:**
- Progressive HUD unlock system (5 phases)
- Tutorial system with interactive objectives
- Interaction mechanics (suit locker, weapon rack)
- Shooting range with targets
- Environmental audio: machinery hum, air vents, electrical panels

**Generic vs Unique:**
- Generic: Basic lighting, post-processing
- **Unique:** Modular GLB station construction, tutorial progression, interaction system

---

### **2. LANDFALL** (Chapter 2)
**Type:** `drop` → transitions to surface | **Base Class:** BaseLevel

**Unique Characteristics:**
- **TWO DISTINCT PHASES:**
  1. **FREEFALL** - Camera looking DOWN at planet, arms extended, dodge asteroids
  2. **POWERED DESCENT** - Hands gripping thrusters, balance fuel/velocity, target LZ

- **Visuals:**
  - Planet mesh with atmosphere layer (coming up)
  - Starfield background
  - Asteroid debris field (rock/ice/metal types)
  - Distant threats (Wraith/Phantom vehicles moving across sky)
  - Landing zone pad on surface with beacon
  - Dynamic camera FOV (1.75 → 1.4 → 1.2 radians)

- **Lighting:** Soft, directional light from planet + starfield (low ambient for space)
- **Atmosphere:** Orange-red dusty (0.6, 0.35, 0.2) during landing phase
- **Movement Speed:** 8 m/s (outdoor base)

**Landing Outcomes:**
- Perfect (on pad): Smooth transition
- Near miss: Fight through hostiles to reach LZ
- Rough: Injury, reduced health
- Crash/Slingshot: Game over mechanics

**Generic vs Unique:**
- Generic: Camera management, basic physics
- **Unique:** Multi-phase drop sequence, asteroid dodging, fuel management, landing outcome system

---

### **3. CANYON RUN** (Chapter 3)
**Type:** `vehicle` | **Base Class:** SurfaceLevel

**Unique Characteristics:**
- **Vehicle Chase Sequence** - Warthog-style hover vehicle
- **Canyon Layout:** 3000m long, 50m wide floor, 80m tall walls, 60 wall segments

- **THREE PHASES:**
  1. Canyon Approach - Learn controls, navigate obstacles, rockslide event at Z=-800
  2. Bridge Crossing - Main bridge collapses as player drives across, boost to clear gap
  3. Final Stretch - Full enemy pursuit, falling rocks, narrow gaps, extraction point

- **Visuals:**
  - Procedural canyon terrain with height variation
  - Canyon walls (left/right) with irregular surfaces
  - Rock formations and boulders (obstacles)
  - Dust cloud particle emitters
  - Alien vegetation clusters
  - Wrecked vehicle props
  - Objective waypoint markers with beacons
  - Volumetric sun shafts through canyon gaps

- **Lighting:** Directional sun light + point lights scattered in canyon
- **Atmosphere:** Dusty, sandy (medium intensity)
- **Weather:** Dusty wind (matches config)

- **Enemy Vehicles:** Wraith hover tanks (plasma mortars, pursuit)

**Generic vs Unique:**
- Generic: Terrain, lighting, movement
- **Unique:** Vehicle controller, bridge collapse mechanic, rockslide system, enemy Wraith AI, pursuit mechanics

---

### **4. FOB DELTA** (Chapter 4)
**Type:** `base` | **Base Class:** BaseLevel (not SurfaceLevel)

**Unique Characteristics:**
- **Abandoned Military Base** with horror/investigation theme
- **Six Areas:** Perimeter → Courtyard → Barracks → Command Center → Vehicle Bay → Underground Access

- **Phase Progression:**
  1. Approach - Breached barriers
  2. Courtyard - Overturned vehicles, environmental storytelling
  3. Investigation - Searching bunks, personal effects, bodies
  4. Ambush - Enemy surge in vehicle bay
  5. Discovery - Underground hatch to The Breach
  6. Exit - Ready for next level

- **Visuals:**
  - Procedural base structures (metal, concrete)
  - Broken furniture, bodies (horror elements)
  - Overturned vehicles, scattered equipment
  - Flickering interior lights (horror atmosphere)
  - Emergency red lighting flashing

- **Lighting:** 
  - Low ambient (0.2 intensity hemisphere light)
  - Flickering point lights throughout
  - Emergency red lights (1.0, 0.2, 0.1)
  - Atmosphere: Dark, abandoned, dread-inducing

- **Flashlight System:** Player-controlled light
- **Area Zones:** Trigger zones for phase progression
- **Enemies:** Lurker ambush (tall stalker types, scout class)

**Generic vs Unique:**
- Generic: Basic lighting, post-processing
- **Unique:** Flickering light system, area zone triggers, ambush mechanics, motion tracker, horror atmosphere, terminal interaction, environmental storytelling

---

### **5. BROTHERS IN ARMS** (Chapter 5)
**Type:** `brothers` | **Base Class:** BaseLevel

**Unique Characteristics:**
- **Reunion with Marcus Cole** - Emotional cinematic cutscene
- **Wave-Based Combat** - 4 waves of increasing difficulty
- **The Breach** - 100m diameter sinkhole entrance (final battle location)
- **Marcus AI Ally** - 8m tall Titan mech, combat support, coordinated attacks

- **Arena:** 200m × 150m open canyon with sinkhole pit
- **Visual Setup:**
  - Orange-red sunset lighting (1.0, 0.6, 0.3) for dramatic effect
  - Warm day atmosphere (0.6, 0.35, 0.2)
  - Sinkhole visual: deep pit with glowing bioluminescent entrance below
  - Marcus mech: Large silhouette, integrated lighting

- **Lighting:** Directional sun at sunset angle, warm glow
- **Atmosphere:** Dramatic confrontation, alliance formation

- **Enemy Types:** Chitin drones, grunts, spitters, brutes in waves
- **Combat Mechanics:**
  - Marcus targeting
  - Coordinated fire support
  - Wave spacing for tactical breathing room
  - Marcus health tracking

**Generic vs Unique:**
- Generic: Enemy spawning, combat loops, lighting
- **Unique:** Marcus mech AI, coordinated combat system, reunion cinematics, banter system, wave-based progression, emotional narrative beats

---

### **6. SOUTHERN ICE** (Chapter 6)
**Type:** `ice` | **Base Class:** SurfaceLevel

**Unique Characteristics:**
- **Frozen Wasteland** with procedural snow/ice environment
- **THREE REGIONS:**
  1. **ICE FIELDS** - Blizzard navigation, temperature mechanic (exposure timer), heat sources
  2. **FROZEN LAKE** - Thin ice mechanic (cracking/fall-through zones), dormant alien nests awakening
  3. **ICE CAVERNS** - Shelter from blizzard, frozen nests, boss-like encounter before The Breach

- **Visuals:**
  - Procedural ice/snow terrain with subdivisions (64+ segments)
  - Blizzard particle system (snow, wind, ice particles - variable intensity)
  - Aurora borealis (animated emissive sky elements)
  - Frozen structures (abandoned research outpost)
  - Ice sheet material (reflective, semi-transparent 0.7, 0.82, 0.95)
  - Frozen waterfalls
  - Icicle formations

- **Lighting:** 
  - Cool blue directional light (adjusted for arctic)
  - Aurora glow layer effects
  - Ambient hemisphere: cool tones
  - Atmosphere: Pale, icy (0.3, 0.3, 0.4) night tones to (0.7, 0.45, 0.3) day

- **Weather:** Blizzard with extreme intensity (4 = extreme)
- **Temperature System:**
  - 5 heat source zones with temperature offsets
  - Player must stay near heaters or risk hypothermia
  - Visual temperature indicator
  - Comms feedback on temperature status

- **Enemies:** 
  - Ice Chitin (white/blue, ice shard attacks, frost aura, resistances)
  - Dormant cocoons that awaken
  - **Boss:** Ice Chitin variant at cave end

- **Marcus AI:** Cold-resistant mech, overwatch support

**Generic vs Unique:**
- Generic: Enemy spawning, terrain, lighting
- **Unique:** Temperature/exposure mechanic, blizzard particle system, aurora borealis animation, thin ice physics, dormant cocoon awakening system, Ice Chitin species variant, Marcus cold-resistant mech interaction

---

### **7. THE BREACH** (Chapter 7)
**Type:** `hive` | **Base Class:** BaseLevel

**Unique Characteristics:**
- **Underground Hive Tunnels** with Queen boss fight
- **FOUR DEPTH ZONES:**
  1. **UPPER HIVE** (0-50m) - Linear tunnels, drones
  2. **MID HIVE** (50-100m) - Branching tunnels, grunts/spitters, acid pools
  3. **LOWER HIVE** (100-150m) - Large chambers, egg clusters, all enemy types
  4. **QUEEN&#x27;S CHAMBER** - 200m cavern, 3-phase boss fight

- **Visuals:**
  - Organic tunnel environment (procedural generation)
  - Bioluminescent lighting (green/cyan glow)
  - Egg clusters (biomass formations)
  - Acid pools (environmental hazards)
  - Pheromone clouds (visual/gameplay hazard)
  - Captured alien vehicles (Wraith, Phantom) as environmental objects
  - Hive structures (birther, brain, claw, crystals, stomach, terraformer)

- **Lighting:**
  - Glow layer (intensity 0.8) for bioluminescence
  - Point lights colored green/cyan
  - Emissive materials for organic surfaces
  - Darkness in unexplored passages
  - Atmosphere: Organic, alien, unsettling (dim colors)

- **Environmental Hazards:**
  - Acid pools (damage zones)
  - Egg cluster triggers (spawn enemies)
  - Pheromone clouds (reduce visibility, enemy awareness)

- **Enemy Progression:** Progressive density increase through zones
- **Boss Mechanics:**
  - Queen has 3 phases with increasing aggression
  - Weak point mechanic (brief windows of increased damage)
  - Queen spawns additional enemies during fight
  - Bioluminescent weak point highlights

**Generic vs Unique:**
- Generic: Enemy spawning, health tracking
- **Unique:** Procedural tunnel generation, bioluminescent environment, glow layer effects, acid pool system, egg cluster triggers, pheromone clouds, Queen AI with 3-phase progression, weak point mechanic, captured vehicle props, hive structure placements

---

### **8. HIVE ASSAULT** (Chapter 8)
**Type:** `combined_arms` | **Base Class:** SurfaceLevel

**Unique Characteristics:**
- **Combined Arms Assault** on main hive entrance
- **FOUR PHASES:**
  1. **STAGING AREA** - Briefing, gear up, interact with marines, board vehicle
  2. **OPEN FIELD ASSAULT** (5-7 min) - Drive toward hive, destroy 4 AA turrets, ground swarms, flying Chitin, marine ambush
  3. **BREACH POINT** (5-7 min) - Dismount, infantry combat, armored Chitin defense, marine covering fire
  4. **ENTRY PUSH** (3-5 min) - Close quarters, establish beachhead inside hive

- **Visuals:**
  - Hive entrance structure (large organic gateway)
  - AA turret fortifications (4 total)
  - Staging area with military equipment
  - Destroyed vehicles (environmental objects)
  - Marine squad visible units
  - Breach point fortifications
  - Hive entrance corridor (transition)

- **Lighting:** 
  - Directional surface light (warm daytime)
  - Red emergency lights around AA turrets
  - Bioluminescent hive entrance glow
  - Atmosphere: Military tension, organic horror juxtaposition

- **Enemy Types:**
  - Ground Chitin (basic assault)
  - Flying Chitin (aerial strafing)
  - Armored Chitin (turret-class defense)

- **Allied Units:**
  - Marine Squads (AI-controlled, covering fire)
  - Marcus Mech (assault support alongside player)

- **Vehicle Combat:**
  - Player vehicle turret
  - Vehicle destruction mechanics
  - AA turret destruction objectives

**Generic vs Unique:**
- Generic: Enemy spawning, lighting
- **Unique:** Marine squad AI system, vehicle combat mechanics, AA turret destruction objectives, coordinated assault progression, marine squad manager, wounded marine mechanic, staged area-to-hive transition

---

### **9. EXTRACTION** (Chapter 9)
**Type:** `extraction` | **Base Class:** BaseLevel

**Unique Characteristics:**
- **Escape Sequence + Holdout at LZ Omega**
- **FIVE PHASES:**
  1. **ESCAPE** (3-4 min) - Collapsing tunnels, falling debris, light at end
  2. **SURFACE RUN** (2-3 min) - 500m to LZ, Marcus cover, Chitin pouring from breach
  3. **HOLDOUT** (5-7 min) - 7 waves at LZ with 7min dropship ETA countdown
  4. **HIVE COLLAPSE** (45-90 sec) - Ground cracking, hive eruptions, debris everywhere
  5. **VICTORY** - Dropship boarding, Marcus collapse, epilogue

- **Wave Progression:**
  - Wave 1: Skitterer Swarm (fast scouts)
  - Wave 2: Lurker Assault (heavy)
  - Wave 3: Acid Rain (spitter focus)
  - Wave 4: Combined Arms (mixed)
  - Wave 5: Heavy Assault (broodmother intro)
  - Wave 6: Screaming Death (husk swarm)
  - Wave 7: Final Assault (everything)

- **Visuals - Escape Phase:**
  - Procedural collapsing tunnel
  - Falling debris chunks (physics)
  - Glowing cracks in tunnel walls
  - Light source at tunnel exit (goal)

- **Visuals - Surface Run:**
  - Open surface with breach hole
  - Alien Chitin emerging
  - Marcus mech visible in distance/alongside
  - LZ marker (beacon light)

- **Visuals - Holdout:**
  - LZ landing zone (circular pad)
  - Dropship arrival sequence (final phase)
  - Beacon light for extraction point

- **Visuals - Hive Collapse:**
  - Ground cracking animation
  - Hive eruptions (upward bursts of organic matter)
  - Falling debris/terrain
  - Glowing magma/lava fissures
  - Progressive camera shake intensity

- **Lighting:**
  - Surface/outdoor daytime + sandstorm effects
  - Emergency red lights
  - Glow effects for hive eruptions
  - Atmosphere: Desperate, chaotic, time-pressured

- **Supply Drops:** Between holdout waves
- **Marcus Mech:** Takes progressive damage, eventually collapses
- **Timer System:** Visible countdown for each phase

**Generic vs Unique:**
- Generic: Enemy spawning, HUD
- **Unique:** Escape collapse mechanic, 7-wave holdout system, dropship arrival sequence, hive collapse effects, debris physics, supply drop system, Marcus damage tracking, timer urgency system, epilogue sequence

---

### **10. FINAL ESCAPE** (Chapter 10)
**Type:** `finale` | **Base Class:** SurfaceLevel

**Unique Characteristics:**
- **Warthog Run Style Vehicle Finale** - Timed escape
- **FOUR SECTIONS:** (240 second / 4 min timer)
  1. **HIVE EXIT** (0-300m) - Drive through collapsing tunnels, falling debris
  2. **SURFACE RUN** (300-700m) - Crumbling terrain, opening chasms, explosions, lava
  3. **CANYON SPRINT** (700-1000m) - Narrow canyon, falling rocks from walls, collapse behind
  4. **LAUNCH PAD** (1000-1200m) - Reach shuttle, dramatic cinematic, planet destruction from orbit

- **Visuals - Hive Exit:**
  - Organic tunnel walls cracking
  - Falling organic debris
  - Bioluminescent glow fading
  - Light source (surface exit ahead)

- **Visuals - Surface Run:**
  - Terrain crumbling/fracturing
  - Ground chasms opening
  - Distant explosions (screen shake)
  - Magma/lava emerging from fissures
  - Marcus mech running alongside in distance

- **Visuals - Canyon Sprint:**
  - Narrow canyon walls
  - Falling rocks (obstacles)
  - Canyon walls collapsing behind player
  - Intensifying destruction particles

- **Visuals - Launch Pad:**
  - Military shuttle on pad (visual goal)
  - Cinematic camera during boarding
  - Orbit view showing planet destruction
  - Mushroom cloud/cataclysm sequence

- **Lighting:**
  - Firestorm atmosphere (extreme intensity)
  - Red emergency lighting
  - Orange/red lava glow
  - Atmosphere: Apocalyptic, desperate escape

- **Obstacles:**
  - Terrain hazards (chasms, falling debris)
  - Dynamic ground cracking
  - Vehicle collision damage
  - Debris chunks in path

- **Timer Mechanic:**
  - 4 minute countdown (240 seconds)
  - Failure: Dramatic explosion game over
  - Victory: Shuttle launch cutscene

- **Allies:**
  - Marcus Mech providing radio guidance

**Generic vs Unique:**
- Generic: Vehicle movement, terrain
- **Unique:** Timed escape mechanic, collapsing terrain system, crashing ground effects, planet destruction cinematic, victory/failure sequences, timer urgency, Marcus radio guidance, shuttle boarding sequence

---

## LEVEL TYPE ANALYSIS: &quot;CANYON&quot; Type Usage

**Finding:** The `canyon` LevelType is defined in `types.ts` (line 34) but **IS NOT USED BY ANY CAMPAIGN LEVEL.**

```typescript
export type LevelType =
  | &#x27;station&#x27; | &#x27;drop&#x27; | &#x27;canyon&#x27; // &lt;-- UNUSED
  | &#x27;base&#x27; | &#x27;brothers&#x27; | &#x27;hive&#x27; | &#x27;extraction&#x27;
  | &#x27;vehicle&#x27; | &#x27;ice&#x27; | &#x27;combined_arms&#x27; | &#x27;finale&#x27;
```

**Campaign levels actually use:**
- `station` (Anchor Station)
- `drop` (Landfall - note: comment says &quot;transitions to canyon&quot; but type stays `drop`)
- `vehicle` (Canyon Run - uses vehicle type, NOT canyon type)
- `base` (FOB Delta)
- `brothers` (Brothers in Arms)
- `hive` (The Breach)
- `extraction` (Extraction)
- `combined_arms` (Hive Assault)
- `ice` (Southern Ice)
- `finale` (Final Escape)

**Recommendation:** The unused `canyon` LevelType should be removed unless there&#x27;s a planned standalone canyon exploration level separate from Canyon Run. Currently, Canyon Run uses `vehicle` type for its Warthog chase mechanics, which is appropriate.

---

## GENERIC VS UNIQUE FEATURES SUMMARY

**Inherited from BaseLevel (all levels):**
- Camera management with smooth lerp interpolation
- Pointer lock mechanism
- Scene disposal and lifecycle
- ECS entity tracking
- Post-processing effects pipeline
- Weather system integration
- Atmospheric effects (god rays, emergency lights)
- Camera shake system with intensity multipliers
- Environmental audio system (spatial sounds, zones, occlusion)
- Achievement tracking
- Touch input support
- Combat state management
- Visual settings synchronization

**Inherited from StationLevel:**
- Interior-specific lighting (point lights instead of sun)
- Space view (skybox + distant planet)
- Slower movement speed (4 m/s)
- Station light helper methods

**Inherited from SurfaceLevel:**
- Time-of-day cycle system
- Sky dome rendering
- Sun visual positioning
- Dynamic lighting based on time
- Combat state tracking
- Faster movement speed (8 m/s)
- Enemy management

**Unique to Each Level:**
- Custom environment builders (procedural or GLB-based)
- Custom phase systems and state machines
- Unique enemy types and combat mechanics
- Specialized AI systems (Marcus mech, marine squads, bosses)
- Custom UI/HUD overlays
- Unique particle effects
- Custom hazard systems
- Cinematics and dialogue sequences
- Specialized mechanics (temperature, vehicle driving, hive collapse, etc.)

---

## ATMOSPHERE SUMMARY TABLE

| Level | Lighting | Skybox | Temp | Weather | Mood |
|-------|----------|--------|------|---------|------|
| **Anchor Station** | Cool point lights, emergency red | Space + planet | Cool/Sterile | None | Professional, tense |
| **Landfall** | Starfield + directional from planet | Space above, planet below | Warm descent | Dust | Epic freefall, dramatic |
| **Canyon Run** | Warm directional, volumetric shafts | Dusty sky dome | Warm | Dusty, sandstorm | Chaotic chase, action |
| **FOB Delta** | Low ambient, flickering red/white | Dim exterior | Cool | None | Horror, dread, abandoned |
| **Brothers in Arms** | Sunset warm orange | Golden sky | Warm | Dust storm | Emotional reunion, battle |
| **Southern Ice** | Cool blue, aurora glow | Aurora dome | Freezing | Blizzard extreme | Isolation, survival |
| **The Breach** | Bioluminescent green/cyan | None (underground) | Dark/warm | None | Alien, organic, unsettling |
| **Hive Assault** | Daylight + red emergency lights | Sky with hive glow | Warm | Sandstorm | Military tension, horror |
| **Extraction** | Variable (day→night), red emergency | Sky (phase dependent) | Hot/escape urgency | Sandstorm/firestorm | Desperate, time-pressured |
| **Final Escape** | Firestorm orange/red glow | Apocalyptic | Firestorm | Firestorm | Apocalyptic, finale |

This comprehensive breakdown shows how each level creates a distinct atmospheric experience while leveraging shared infrastructure from the base classes.</pre><pre>agentId: a60e453 (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-29-02-429Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-29-02-429Z" class="timestamp-link"><time datetime="2026-01-30T17:29:02.429Z" data-timestamp="2026-01-30T17:29:02.429Z">2026-01-30T17:29:02.429Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>(no content)</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-22-637Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-22-637Z" class="timestamp-link"><time datetime="2026-01-30T17:30:22.637Z" data-timestamp="2026-01-30T17:30:22.637Z">2026-01-30T17:30:22.637Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Excellent - I now have a comprehensive understanding of the codebase. Let me synthesize all three exploration results and design the architecture.</p>
<p>Key findings:</p>
<ol>
<li>
<p><strong>Campaign Flow Today</strong>: App.tsx manages a React state machine (title → menu → briefing → intro → loading → tutorial/dropping/playing → levelComplete → credits). GameCanvas has TWO parallel rendering systems: <code>tutorialLevelRef</code> (ILevel) and <code>gameManagerRef</code> (GameManager). The LevelManager class exists but is never used.</p>
</li>
<li>
<p><strong>Level Environments</strong>: Each level is genuinely unique with custom environments, enemies, phases, and mechanics. The base classes (BaseLevel, SurfaceLevel, StationLevel) provide solid shared infrastructure. Every level has a distinct atmosphere.</p>
</li>
<li>
<p><strong>Dead Code</strong>: MiningDepthsLevel, AnchorStationLevelV2, Vehicle system, ReyesDialogue, the canyon LevelType, and most of the Achievement system are all unused. The main quest chain could become the organizing principle that wires all levels together, similar to how Halo's campaign IS the mission list.</p>
</li>
</ol>
<p>I'm designing a CampaignDirector that serves as the game's spine—it owns the mission definitions, tracks campaign state, coordinates level transitions, and manages objectives and unlocking, eliminating the need for generic stubs and ensuring every level is purposefully crafted. I'm realizing the levels are actually well-crafted individually—the real problems are the three broken factories, the unused canyon type, and GameCanvas having conflicting dual systems that need consolidation.</p>
<p>The user's vision requires the campaign itself to be the structural spine, so I'm designing a CampaignDirector pattern that manages the mission chain, tracks progression state, and coordinates level creation and transitions in one unified system rather than scattered across App.tsx. I see the real issue now—the campaign data structure exists but the coordination logic is fragmented across multiple files, so I need to create a CampaignDirector that centralizes mission progression, level transitions, and state management, while simplifying GameCanvas to just render what the director instructs. I should also remove the unused canyon factory type since Canyon Run actually uses the vehicle type instead. I need to refocus on the core requirements: building CampaignDirector as the central orchestrator for quest progression, eliminating all errors and warnings, and ensuring every level is properly implemented rather than generic. The canyon level needs to be either fully realized or removed, and I should prioritize this architectural work over the full five-phase plan. I need to be careful about what to actually delete since the user didn't explicitly ask for removals—they want the quest chain architecture and all issues fixed. So I'll focus on the core work: building CampaignDirector as the backbone, removing the unused canyon type and factory, unifying GameCanvas, eliminating warnings and errors, and connecting the disconnected systems. The canyon issue specifically needs proper resolution rather than just leaving it broken. GameManager handles more than just the Landfall sequence—it manages the entire ECS world, player controller, AI, combat, and chunk-based terrain that persists across gameplay. LandfallLevel is self-contained and only handles the drop sequence, so I need to figure out what happens after the descent: does the world state transition to a persistent GameManager instance, or should individual level classes manage their own ECS systems?</p>
<p>Since all 10 levels already have ILevel implementations, I can eliminate the dual system entirely by having LandfallLevel manage both the HALO drop and the surface landing, with the CampaignDirector simply telling GameCanvas which level to load via the factory system. This means a single <code>activeLevelRef</code> replaces both <code>gameManagerRef</code> and the level switching logic.</p>
<p>Now I'm thinking through the CampaignDirector design to coordinate level transitions and determine how state flows between the tutorial, the drop sequence, and ongoing gameplay. The CampaignDirector class manages the ordered sequence of ten missions, tracks which ones are completed, and provides methods to retrieve the current or next mission and handle progression when a mission is finished. The hook exposes the campaign state and actions needed by the UI, making the component logic straightforward since the CampaignDirector handles all progression. I need to document the specific file changes and address the Capacitor gap—it's configured but not integrated into the web build pipeline, which should be fixed for consistent deployment across platforms.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-22-844Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-22-844Z" class="timestamp-link"><time datetime="2026-01-30T17:30:22.844Z" data-timestamp="2026-01-30T17:30:22.844Z">2026-01-30T17:30:22.844Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Now I have a complete picture. Let me read a few more critical files before writing the plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-23-910Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-23-910Z" class="timestamp-link"><time datetime="2026-01-30T17:30:23.910Z" data-timestamp="2026-01-30T17:30:23.910Z">2026-01-30T17:30:23.910Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01LvEwUWbZEx9Bt4opNkWfSB"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/core/GameManager.ts&#34;,
  &#34;limit&#34;: 80
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-23-913Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-23-913Z" class="timestamp-link"><time datetime="2026-01-30T17:30:23.913Z" data-timestamp="2026-01-30T17:30:23.913Z">2026-01-30T17:30:23.913Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→import type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
     2→import { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
     3→import type { Scene } from &#x27;@babylonjs/core/scene&#x27;;
     4→import { Player } from &#x27;../entities/player&#x27;;
     5→import { AISystem } from &#x27;../systems/aiSystem&#x27;;
     6→import { CombatSystem } from &#x27;../systems/combatSystem&#x27;;
     7→import type { TouchInput } from &#x27;../types&#x27;;
     8→import { ChunkManager } from &#x27;../world/chunkManager&#x27;;
     9→import { LODManager, type LODMetrics } from &#x27;./LODManager&#x27;;
    10→
    11→export interface CompassData {
    12→  heading: number;
    13→  objectiveDirection?: number;
    14→  objectiveDistance?: number;
    15→}
    16→
    17→export interface GameCallbacks {
    18→  onHealthChange: (health: number) =&gt; void;
    19→  onKill: () =&gt; void;
    20→  onDamage: () =&gt; void;
    21→  onNotification: (text: string, duration?: number) =&gt; void;
    22→  onCompassUpdate?: (data: CompassData) =&gt; void;
    23→  onHitMarker?: (damage: number, isCritical: boolean) =&gt; void;
    24→  onDirectionalDamage?: (angle: number, damage: number) =&gt; void;
    25→}
    26→
    27→export class GameManager {
    28→  private scene: Scene;
    29→  private engine: Engine;
    30→  private canvas: HTMLCanvasElement;
    31→
    32→  private player: Player | null = null;
    33→  private chunkManager: ChunkManager | null = null;
    34→  private combatSystem: CombatSystem | null = null;
    35→  private aiSystem: AISystem | null = null;
    36→
    37→  private callbacks: GameCallbacks;
    38→  private isRunning = false;
    39→  private lastTime = 0;
    40→  private dropNotificationShown = false;
    41→
    42→  constructor(scene: Scene, engine: Engine, canvas: HTMLCanvasElement, callbacks: GameCallbacks) {
    43→    this.scene = scene;
    44→    this.engine = engine;
    45→    this.canvas = canvas;
    46→    this.callbacks = callbacks;
    47→  }
    48→
    49→  initialize(): void {
    50→    // Remove the default camera that was created during scene setup
    51→    if (this.scene.activeCamera) {
    52→      this.scene.activeCamera.dispose();
    53→    }
    54→
    55→    // Create player
    56→    this.player = new Player(this.scene, this.canvas, this.engine);
    57→
    58→    // Set player camera as the active camera
    59→    this.scene.activeCamera = this.player.camera;
    60→
    61→    // Initialize LOD Manager with scene and player camera
    62→    LODManager.init(this.scene, this.player.camera);
    63→
    64→    // Create game systems
    65→    this.chunkManager = new ChunkManager(this.scene);
    66→    this.combatSystem = new CombatSystem(this.scene);
    67→    this.aiSystem = new AISystem();
    68→
    69→    // Connect systems
    70→    this.combatSystem.setPlayer(this.player.entity);
    71→    this.aiSystem.setPlayer(this.player.entity);
    72→
    73→    // Set up callbacks
    74→    this.combatSystem.onKill(() =&gt; {
    75→      this.callbacks.onKill();
    76→    });
    77→
    78→    this.combatSystem.onPlayerDamage((amount) =&gt; {
    79→      this.callbacks.onDamage();
    80→      // We could use &#x27;amount&#x27; for damage numbers here

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-24-662Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-24-662Z" class="timestamp-link"><time datetime="2026-01-30T17:30:24.662Z" data-timestamp="2026-01-30T17:30:24.662Z">2026-01-30T17:30:24.662Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_013L36cbfWk6kjQz5vbZHP7T"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-24-665Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-24-665Z" class="timestamp-link"><time datetime="2026-01-30T17:30:24.665Z" data-timestamp="2026-01-30T17:30:24.665Z">2026-01-30T17:30:24.665Z</time></a></div><div class="message-content"><div class="tool-result tool-error"><div class="truncatable"><div class="truncatable-content"><pre>EISDIR: illegal operation on a directory, read</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-25-276Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-25-276Z" class="timestamp-link"><time datetime="2026-01-30T17:30:25.276Z" data-timestamp="2026-01-30T17:30:25.276Z">2026-01-30T17:30:25.276Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01F2uzYd9nm9fRif5Ng4CZfT"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/persistence/**/*.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-25-277Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-25-277Z" class="timestamp-link"><time datetime="2026-01-30T17:30:25.277Z" data-timestamp="2026-01-30T17:30:25.277Z">2026-01-30T17:30:25.277Z</time></a></div><div class="message-content"><div class="tool-result tool-error"><div class="truncatable"><div class="truncatable-content"><pre>&lt;tool_use_error&gt;Sibling tool call errored&lt;/tool_use_error&gt;</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-28-593Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-28-593Z" class="timestamp-link"><time datetime="2026-01-30T17:30:28.593Z" data-timestamp="2026-01-30T17:30:28.593Z">2026-01-30T17:30:28.593Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01959V1sT1yKmMTwTJTnVQkM"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/persistence/**/*.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-29-317Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-29-317Z" class="timestamp-link"><time datetime="2026-01-30T17:30:29.317Z" data-timestamp="2026-01-30T17:30:29.317Z">2026-01-30T17:30:29.317Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01XHQR1Ffw2PkDw7m59Dxga3"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/core/GameManager.ts&#34;,
  &#34;offset&#34;: 80,
  &#34;limit&#34;: 80
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-29-319Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-29-319Z" class="timestamp-link"><time datetime="2026-01-30T17:30:29.319Z" data-timestamp="2026-01-30T17:30:29.319Z">2026-01-30T17:30:29.319Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>    80→      // We could use &#x27;amount&#x27; for damage numbers here
    81→      if (this.player?.entity.health) {
    82→        this.callbacks.onHealthChange(this.player.entity.health.current);
    83→      }
    84→    });
    85→
    86→    // Wire up hit marker callback for dealing damage
    87→    this.combatSystem.onHitMarker((damage, isCritical) =&gt; {
    88→      this.callbacks.onHitMarker?.(damage, isCritical);
    89→    });
    90→
    91→    // Wire up directional damage callback for taking damage
    92→    this.combatSystem.onDirectionalDamage((angle, damage) =&gt; {
    93→      this.callbacks.onDirectionalDamage?.(angle, damage);
    94→    });
    95→
    96→    // Load initial chunks around spawn
    97→    this.chunkManager.update(Vector3.Zero());
    98→
    99→    this.isRunning = true;
   100→    this.lastTime = performance.now();
   101→    this.dropNotificationShown = false;
   102→
   103→    this.callbacks.onNotification(&#x27;ORBITAL DROP INITIATED&#x27;, 3000);
   104→  }
   105→
   106→  setTouchInput(input: TouchInput | null): void {
   107→    if (this.player) {
   108→      this.player.setTouchInput(input);
   109→    }
   110→  }
   111→
   112→  update(): void {
   113→    if (!this.isRunning || !this.player) return;
   114→
   115→    const now = performance.now();
   116→    const deltaTime = (now - this.lastTime) / 1000;
   117→    this.lastTime = now;
   118→
   119→    // Cap delta time to prevent huge jumps
   120→    const cappedDelta = Math.min(deltaTime, 0.1);
   121→
   122→    // Update player
   123→    this.player.update(cappedDelta);
   124→
   125→    // Show notification when drop completes
   126→    if (this.player.isDropComplete &amp;&amp; !this.dropNotificationShown) {
   127→      this.dropNotificationShown = true;
   128→      this.callbacks.onNotification(&#x27;TOUCHDOWN - WEAPONS HOT&#x27;, 3000);
   129→    }
   130→
   131→    // Update chunk loading based on player position
   132→    if (this.chunkManager) {
   133→      this.chunkManager.update(this.player.getPosition());
   134→    }
   135→
   136→    // Update AI system
   137→    if (this.aiSystem) {
   138→      this.aiSystem.update(cappedDelta);
   139→    }
   140→
   141→    // Update combat system
   142→    if (this.combatSystem) {
   143→      this.combatSystem.update(cappedDelta);
   144→    }
   145→
   146→    // Update LOD system (throttled internally)
   147→    LODManager.update();
   148→
   149→    // Update health in UI
   150→    if (this.player.entity.health) {
   151→      this.callbacks.onHealthChange(this.player.entity.health.current);
   152→    }
   153→
   154→    // Update compass data
   155→    if (this.callbacks.onCompassUpdate) {
   156→      const heading = this.player.getHeading();
   157→      this.callbacks.onCompassUpdate({ heading });
   158→    }
   159→  }

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-29-793Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-29-793Z" class="timestamp-link"><time datetime="2026-01-30T17:30:29.793Z" data-timestamp="2026-01-30T17:30:29.793Z">2026-01-30T17:30:29.793Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/GameSave.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/SaveSystem.test.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/SaveSystem.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/index.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-33-214Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-33-214Z" class="timestamp-link"><time datetime="2026-01-30T17:30:33.214Z" data-timestamp="2026-01-30T17:30:33.214Z">2026-01-30T17:30:33.214Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Tm1B89EXtEDYYQe2f4vefH"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/SaveSystem.ts&#34;,
  &#34;limit&#34;: 100
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-33-216Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-33-216Z" class="timestamp-link"><time datetime="2026-01-30T17:30:33.216Z" data-timestamp="2026-01-30T17:30:33.216Z">2026-01-30T17:30:33.216Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * SaveSystem - Manages game save/load operations
     3→ *
     4→ * Provides a centralized save system that:
     5→ * - Saves and loads game progress to/from IndexedDB via worldDb
     6→ * - Supports auto-save on level completion
     7→ * - Supports manual save/load
     8→ * - Manages the current active save slot
     9→ */
    10→
    11→import { getAchievementManager } from &#x27;../achievements&#x27;;
    12→import {
    13→  type DifficultyLevel,
    14→  loadDifficultySetting,
    15→  migrateDifficulty,
    16→  saveDifficultySetting,
    17→} from &#x27;../core/DifficultySettings&#x27;;
    18→import { worldDb } from &#x27;../db/worldDatabase&#x27;;
    19→import type { LevelId } from &#x27;../levels/types&#x27;;
    20→import {
    21→  createNewSave,
    22→  extractSaveMetadata,
    23→  type GameSave,
    24→  type GameSaveMetadata,
    25→  SAVE_FORMAT_VERSION,
    26→} from &#x27;./GameSave&#x27;;
    27→
    28→/**
    29→ * Events emitted by the SaveSystem
    30→ */
    31→export type SaveSystemEvent =
    32→  | { type: &#x27;save_created&#x27;; save: GameSaveMetadata }
    33→  | { type: &#x27;save_loaded&#x27;; save: GameSave }
    34→  | { type: &#x27;save_deleted&#x27;; saveId: string }
    35→  | { type: &#x27;auto_saved&#x27;; save: GameSaveMetadata }
    36→  | { type: &#x27;error&#x27;; message: string };
    37→
    38→type SaveSystemListener = (event: SaveSystemEvent) =&gt; void;
    39→
    40→/**
    41→ * Primary save slot ID (single-slot save system)
    42→ */
    43→const PRIMARY_SAVE_ID = &#x27;primary&#x27;;
    44→
    45→class SaveSystem {
    46→  private currentSave: GameSave | null = null;
    47→  private sessionStartTime: number = Date.now();
    48→  private listeners: Set&lt;SaveSystemListener&gt; = new Set();
    49→  private autoSaveEnabled = true;
    50→
    51→  /**
    52→   * Initialize the save system
    53→   * Should be called on app startup after worldDb.init()
    54→   */
    55→  async initialize(): Promise&lt;void&gt; {
    56→    await worldDb.init();
    57→  }
    58→
    59→  /**
    60→   * Add an event listener
    61→   */
    62→  addListener(listener: SaveSystemListener): () =&gt; void {
    63→    this.listeners.add(listener);
    64→    return () =&gt; this.listeners.delete(listener);
    65→  }
    66→
    67→  private emit(event: SaveSystemEvent): void {
    68→    for (const listener of this.listeners) {
    69→      try {
    70→        listener(event);
    71→      } catch (e) {
    72→        console.error(&#x27;SaveSystem listener error:&#x27;, e);
    73→      }
    74→    }
    75→  }
    76→
    77→  /**
    78→   * Check if a save exists
    79→   */
    80→  hasSave(): boolean {
    81→    try {
    82→      const saveData = worldDb.getChunkData(`save_${PRIMARY_SAVE_ID}`);
    83→      return saveData !== null;
    84→    } catch {
    85→      return false;
    86→    }
    87→  }
    88→
    89→  /**
    90→   * Get the current active save (in-memory)
    91→   */
    92→  getCurrentSave(): GameSave | null {
    93→    return this.currentSave;
    94→  }
    95→
    96→  /**
    97→   * Create a new game (clears any existing save)
    98→   * @param difficulty - The difficulty level for the new game (defaults to current setting)
    99→   */
   100→  async newGame(difficulty?: DifficultyLevel): Promise&lt;GameSave&gt; {

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-33-667Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-33-667Z" class="timestamp-link"><time datetime="2026-01-30T17:30:33.667Z" data-timestamp="2026-01-30T17:30:33.667Z">2026-01-30T17:30:33.667Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01EJabiPaXptNg6E7GSLioEA"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/GameSave.ts&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-33-669Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-33-669Z" class="timestamp-link"><time datetime="2026-01-30T17:30:33.669Z" data-timestamp="2026-01-30T17:30:33.669Z">2026-01-30T17:30:33.669Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * GameSave - Save data interface for game state persistence
     3→ *
     4→ * This module defines the structure of a game save, which captures
     5→ * the player&#x27;s campaign progress including:
     6→ * - Current level and completed levels
     7→ * - Player health and stats
     8→ * - Inventory items
     9→ * - Objective progress
    10→ * - Difficulty settings
    11→ */
    12→
    13→import type { DifficultyLevel } from &#x27;../core/DifficultySettings&#x27;;
    14→import type { LevelId } from &#x27;../levels/types&#x27;;
    15→
    16→/**
    17→ * Represents a single saved game slot
    18→ */
    19→export interface GameSave {
    20→  /** Unique identifier for this save (UUID) */
    21→  id: string;
    22→
    23→  /** Timestamp when save was created (Unix ms) */
    24→  timestamp: number;
    25→
    26→  /** Human-readable save name (auto-generated or user-provided) */
    27→  name: string;
    28→
    29→  /** Current level the player is on */
    30→  currentLevel: LevelId;
    31→
    32→  /** Player&#x27;s current health (0-100) */
    33→  playerHealth: number;
    34→
    35→  /** Maximum player health */
    36→  maxPlayerHealth: number;
    37→
    38→  /** Levels that have been completed (in order) */
    39→  levelsCompleted: LevelId[];
    40→
    41→  /** Levels that have been visited (started but not necessarily completed) */
    42→  levelsVisited: LevelId[];
    43→
    44→  /** Total kills across the campaign */
    45→  totalKills: number;
    46→
    47→  /** Total distance traveled (for stats) */
    48→  totalDistance: number;
    49→
    50→  /** Total time played in milliseconds */
    51→  playTime: number;
    52→
    53→  /** Current chapter (1-6) */
    54→  currentChapter: number;
    55→
    56→  /** Player position within current level */
    57→  playerPosition: {
    58→    x: number;
    59→    y: number;
    60→    z: number;
    61→  };
    62→
    63→  /** Player rotation (Y-axis) within current level */
    64→  playerRotation: number;
    65→
    66→  /** Inventory items (item ID to quantity) */
    67→  inventory: Record&lt;string, number&gt;;
    68→
    69→  /** Quest/objective flags (quest ID to completion status) */
    70→  objectives: Record&lt;string, boolean&gt;;
    71→
    72→  /** Tutorial completion status */
    73→  tutorialCompleted: boolean;
    74→
    75→  /** Current tutorial step (if in tutorial) */
    76→  tutorialStep: number;
    77→
    78→  /** Additional level-specific flags */
    79→  levelFlags: Record&lt;LevelId, Record&lt;string, boolean&gt;&gt;;
    80→
    81→  /** Difficulty level for this save */
    82→  difficulty: DifficultyLevel;
    83→
    84→  /** Version of the save format (for migration) */
    85→  version: number;
    86→}
    87→
    88→/**
    89→ * Metadata for save slot display (list view)
    90→ */
    91→export interface GameSaveMetadata {
    92→  id: string;
    93→  timestamp: number;
    94→  name: string;
    95→  currentLevel: LevelId;
    96→  currentChapter: number;
    97→  playTime: number;
    98→  levelsCompleted: number;
    99→  difficulty: DifficultyLevel;
   100→}
   101→
   102→/**
   103→ * Current save format version
   104→ * Increment when breaking changes are made to GameSave interface
   105→ * v2: Added difficulty field
   106→ */
   107→export const SAVE_FORMAT_VERSION = 2;
   108→
   109→/**
   110→ * Create a new empty save with default values
   111→ */
   112→export function createNewSave(id: string, difficulty: DifficultyLevel = &#x27;normal&#x27;): GameSave {
   113→  return {
   114→    id,
   115→    timestamp: Date.now(),
   116→    name: generateSaveName(),
   117→    currentLevel: &#x27;anchor_station&#x27;,
   118→    playerHealth: 100,
   119→    maxPlayerHealth: 100,
   120→    levelsCompleted: [],
   121→    levelsVisited: [],
   122→    totalKills: 0,
   123→    totalDistance: 0,
   124→    playTime: 0,
   125→    currentChapter: 1,
   126→    playerPosition: { x: 0, y: 1.7, z: 0 },
   127→    playerRotation: Math.PI,
   128→    inventory: {},
   129→    objectives: {},
   130→    tutorialCompleted: false,
   131→    tutorialStep: 0,
   132→    levelFlags: {
   133→      anchor_station: {},
   134→      landfall: {},
   135→      canyon_run: {},
   136→      fob_delta: {},
   137→      brothers_in_arms: {},
   138→      southern_ice: {},
   139→      the_breach: {},
   140→      hive_assault: {},
   141→      extraction: {},
   142→      final_escape: {},
   143→    },
   144→    difficulty,
   145→    version: SAVE_FORMAT_VERSION,
   146→  };
   147→}
   148→
   149→/**
   150→ * Generate a default save name based on current date/time
   151→ */
   152→function generateSaveName(): string {
   153→  const now = new Date();
   154→  const month = String(now.getMonth() + 1).padStart(2, &#x27;0&#x27;);
   155→  const day = String(now.getDate()).padStart(2, &#x27;0&#x27;);
   156→  const hours = String(now.getHours()).padStart(2, &#x27;0&#x27;);
   157→  const minutes = String(now.getMinutes()).padStart(2, &#x27;0&#x27;);
   158→  return `Save ${month}/${day} ${hours}:${minutes}`;
   159→}
   160→
   161→/**
   162→ * Generate a unique save ID
   163→ */
   164→export function generateSaveId(): string {
   165→  // Simple UUID v4 implementation
   166→  return &#x27;xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx&#x27;.replace(/[xy]/g, (c) =&gt; {
   167→    const r = (Math.random() * 16) | 0;
   168→    const v = c === &#x27;x&#x27; ? r : (r &amp; 0x3) | 0x8;
   169→    return v.toString(16);
   170→  });
   171→}
   172→
   173→/**
   174→ * Extract metadata from a full save for list display
   175→ */
   176→export function extractSaveMetadata(save: GameSave): GameSaveMetadata {
   177→  return {
   178→    id: save.id,
   179→    timestamp: save.timestamp,
   180→    name: save.name,
   181→    currentLevel: save.currentLevel,
   182→    currentChapter: save.currentChapter,
   183→    playTime: save.playTime,
   184→    levelsCompleted: save.levelsCompleted.length,
   185→    difficulty: save.difficulty ?? &#x27;normal&#x27;,
   186→  };
   187→}
   188→
   189→/**
   190→ * Format play time as human-readable string (e.g., &quot;2h 15m&quot;)
   191→ */
   192→export function formatPlayTime(ms: number): string {
   193→  const totalSeconds = Math.floor(ms / 1000);
   194→  const hours = Math.floor(totalSeconds / 3600);
   195→  const minutes = Math.floor((totalSeconds % 3600) / 60);
   196→
   197→  if (hours &gt; 0) {
   198→    return `${hours}h ${minutes}m`;
   199→  }
   200→  return `${minutes}m`;
   201→}
   202→
   203→/**
   204→ * Get display name for a level ID
   205→ */
   206→export function getLevelDisplayName(levelId: LevelId): string {
   207→  const names: Record&lt;LevelId, string&gt; = {
   208→    anchor_station: &#x27;Anchor Station&#x27;,
   209→    landfall: &#x27;Landfall&#x27;,
   210→    canyon_run: &#x27;Canyon Run&#x27;,
   211→    fob_delta: &#x27;FOB Delta&#x27;,
   212→    brothers_in_arms: &#x27;Brothers in Arms&#x27;,
   213→    southern_ice: &#x27;Southern Ice&#x27;,
   214→    the_breach: &#x27;The Breach&#x27;,
   215→    hive_assault: &#x27;Hive Assault&#x27;,
   216→    extraction: &#x27;Extraction&#x27;,
   217→    final_escape: &#x27;Final Escape&#x27;,
   218→  };
   219→  return names[levelId] || levelId;
   220→}
   221→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-37-242Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-37-242Z" class="timestamp-link"><time datetime="2026-01-30T17:30:37.242Z" data-timestamp="2026-01-30T17:30:37.242Z">2026-01-30T17:30:37.242Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have all the context I need. Let me also look at the MissionBriefing component to understand the briefing data.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-38-009Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-38-009Z" class="timestamp-link"><time datetime="2026-01-30T17:30:38.009Z" data-timestamp="2026-01-30T17:30:38.009Z">2026-01-30T17:30:38.009Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Let me check the mission briefing data to understand what narrative content already exists.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-39-218Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-39-218Z" class="timestamp-link"><time datetime="2026-01-30T17:30:39.218Z" data-timestamp="2026-01-30T17:30:39.218Z">2026-01-30T17:30:39.218Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_011tnqpCQbM3SutN29Ly64A3"><div class="tool-header"><span class="tool-icon">⚙</span> Grep</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;MISSION_BRIEFINGS|getMissionBriefing&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src&#34;,
  &#34;output_mode&#34;: &#34;files_with_matches&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-40-424Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-40-424Z" class="timestamp-link"><time datetime="2026-01-30T17:30:40.424Z" data-timestamp="2026-01-30T17:30:40.424Z">2026-01-30T17:30:40.424Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Found 2 files
src/game/core/lore.ts
src/components/ui/MissionBriefing.tsx</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-43-966Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-43-966Z" class="timestamp-link"><time datetime="2026-01-30T17:30:43.966Z" data-timestamp="2026-01-30T17:30:43.966Z">2026-01-30T17:30:43.966Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01JenjRjUdUg9i7jwaupYR1m"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/MissionBriefing.tsx&#34;,
  &#34;limit&#34;: 120
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-30-43-968Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-30-43-968Z" class="timestamp-link"><time datetime="2026-01-30T17:30:43.968Z" data-timestamp="2026-01-30T17:30:43.968Z">2026-01-30T17:30:43.968Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→import { useCallback, useEffect, useState } from &#x27;react&#x27;;
     2→import { getAudioManager } from &#x27;../../game/core/AudioManager&#x27;;
     3→import { LORE, MISSION_BRIEFINGS } from &#x27;../../game/core/lore&#x27;;
     4→import { CAMPAIGN_LEVELS, type LevelConfig, type LevelId } from &#x27;../../game/levels/types&#x27;;
     5→import { getScreenInfo } from &#x27;../../game/utils/responsive&#x27;;
     6→import styles from &#x27;./MissionBriefing.module.css&#x27;;
     7→
     8→/**
     9→ * Enemy intel entry for briefing
    10→ */
    11→export interface EnemyIntelEntry {
    12→  type: string;
    13→  threat: &#x27;LOW&#x27; | &#x27;MEDIUM&#x27; | &#x27;HIGH&#x27; | &#x27;EXTREME&#x27;;
    14→  description: string;
    15→  weakness?: string;
    16→}
    17→
    18→/**
    19→ * Mission briefing data structure
    20→ */
    21→export interface MissionBriefingData {
    22→  missionName: string;
    23→  missionSubtitle?: string;
    24→  actName: string;
    25→  chapter: number;
    26→  commanderBriefing: string;
    27→  environmentDescription: string;
    28→  objectives: string[];
    29→  suggestedLoadout: LoadoutItem[];
    30→  environmentType: &#x27;station&#x27; | &#x27;surface&#x27; | &#x27;underground&#x27; | &#x27;orbital&#x27;;
    31→  threatLevel: &#x27;minimal&#x27; | &#x27;moderate&#x27; | &#x27;high&#x27; | &#x27;extreme&#x27;;
    32→  enemyIntel: EnemyIntelEntry[];
    33→}
    34→
    35→/**
    36→ * Loadout item for suggested equipment
    37→ */
    38→export interface LoadoutItem {
    39→  id: string;
    40→  name: string;
    41→  description: string;
    42→  icon: string;
    43→  equipped: boolean;
    44→}
    45→
    46→/**
    47→ * Props for MissionBriefing component
    48→ */
    49→interface MissionBriefingProps {
    50→  isOpen: boolean;
    51→  levelId: LevelId;
    52→  onBeginMission: () =&gt; void;
    53→  onCancel: () =&gt; void;
    54→}
    55→
    56→/**
    57→ * Generate mission briefing data from level config and lore
    58→ */
    59→function generateBriefingData(levelId: LevelId): MissionBriefingData {
    60→  const config: LevelConfig = CAMPAIGN_LEVELS[levelId];
    61→
    62→  // Get mission briefing from lore based on chapter
    63→  const missionKey = `mission${config.chapter}` as keyof typeof MISSION_BRIEFINGS;
    64→  const briefing = MISSION_BRIEFINGS[missionKey] || MISSION_BRIEFINGS.mission1;
    65→
    66→  // Map level type to environment type
    67→  const envTypeMap: Record&lt;string, MissionBriefingData[&#x27;environmentType&#x27;]&gt; = {
    68→    station: &#x27;station&#x27;,
    69→    drop: &#x27;orbital&#x27;,
    70→    canyon: &#x27;surface&#x27;,
    71→    base: &#x27;station&#x27;,
    72→    brothers: &#x27;surface&#x27;,
    73→    hive: &#x27;underground&#x27;,
    74→    extraction: &#x27;surface&#x27;,
    75→    vehicle: &#x27;surface&#x27;,
    76→    ice: &#x27;surface&#x27;,
    77→    combined_arms: &#x27;underground&#x27;,
    78→    finale: &#x27;surface&#x27;,
    79→  };
    80→
    81→  // Map level to threat level
    82→  const threatMap: Record&lt;LevelId, MissionBriefingData[&#x27;threatLevel&#x27;]&gt; = {
    83→    anchor_station: &#x27;minimal&#x27;,
    84→    landfall: &#x27;moderate&#x27;,
    85→    canyon_run: &#x27;moderate&#x27;,
    86→    fob_delta: &#x27;moderate&#x27;,
    87→    brothers_in_arms: &#x27;high&#x27;,
    88→    southern_ice: &#x27;high&#x27;,
    89→    the_breach: &#x27;extreme&#x27;,
    90→    hive_assault: &#x27;extreme&#x27;,
    91→    extraction: &#x27;high&#x27;,
    92→    final_escape: &#x27;extreme&#x27;,
    93→  };
    94→
    95→  // Enemy intel per level - detailed hostile information
    96→  const enemyIntelMap: Record&lt;LevelId, EnemyIntelEntry[]&gt; = {
    97→    anchor_station: [], // Tutorial - no hostiles
    98→    landfall: [
    99→      {
   100→        type: &#x27;CHITIN DRONE&#x27;,
   101→        threat: &#x27;LOW&#x27;,
   102→        description: &#x27;Fast-moving scouts. Weak carapace armor. Attack in swarms of 3-5.&#x27;,
   103→        weakness: &#x27;Headshots deal 2x damage. Easily staggered.&#x27;,
   104→      },
   105→      {
   106→        type: &#x27;CHITIN SOLDIER&#x27;,
   107→        threat: &#x27;MEDIUM&#x27;,
   108→        description: &#x27;Primary combat unit. Reinforced exoskeleton. Melee attacks.&#x27;,
   109→        weakness: &#x27;Exposed joints on legs. Slow to turn.&#x27;,
   110→      },
   111→    ],
   112→    canyon_run: [
   113→      {
   114→        type: &#x27;CHITIN FLYER&#x27;,
   115→        threat: &#x27;MEDIUM&#x27;,
   116→        description: &#x27;Aerial pursuit units. Attack from above during vehicle transit.&#x27;,
   117→        weakness: &#x27;Fragile wings. Turret fire effective. Avoid stopping.&#x27;,
   118→      },
   119→      {
   120→        type: &#x27;CHITIN BURROWER&#x27;,

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-47-832Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-47-832Z" class="timestamp-link"><time datetime="2026-01-30T17:30:47.832Z" data-timestamp="2026-01-30T17:30:47.832Z">2026-01-30T17:30:47.832Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>I now have a comprehensive understanding. Let me now launch a Plan agent to design the CampaignDirector architecture.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-30-48-250Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-30-48-250Z" class="timestamp-link"><time datetime="2026-01-30T17:30:48.250Z" data-timestamp="2026-01-30T17:30:48.250Z">2026-01-30T17:30:48.250Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>I have all the context I need. Let me design the architecture.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-31-18-647Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-31-18-647Z" class="timestamp-link"><time datetime="2026-01-30T17:31:18.647Z" data-timestamp="2026-01-30T17:31:18.647Z">2026-01-30T17:31:18.647Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_017JdPTw1ZR1G4MYeW2Rv48U"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Design CampaignDirector architecture</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;prompt&#34;: &#34;Design the CampaignDirector architecture for Stellar Descent, a BabylonJS/React FPS game with a 10-level campaign.\n\n## CONTEXT\n\nThe user wants the main quest chain to BE the spine of the game - the single coordinator that wires all levels together, manages progression, unlocks, and transitions. Currently, campaign coordination is scattered across:\n- `App.tsx` (694 lines) - React state machine with 12 game states, level transition logic spread across ~15 callbacks\n- `GameCanvas.tsx` (758 lines) - Two parallel rendering systems: `tutorialLevelRef` (ILevel factory) and `gameManagerRef` (GameManager class that is NOT ILevel-compliant)\n- `CAMPAIGN_LEVELS` in `types.ts` - Passive linked list data (10 level configs)\n- `SaveSystem.ts` - Save persistence with `levelsCompleted[]` and `currentLevel`\n- `MissionBriefing.tsx` - Generates briefing data from `LORE.MISSION_BRIEFINGS`\n\n## CURRENT ARCHITECTURE PROBLEMS\n\n1. **Dual rendering system**: GameCanvas has `tutorialLevelRef` (ILevel) AND `gameManagerRef` (GameManager, NOT ILevel). GameManager manages Player, ChunkManager, CombatSystem, AISystem for open-world surface gameplay. All 10 level classes already exist as ILevel implementations (BaseLevel → SurfaceLevel/StationLevel → concrete levels), but GameManager is still used for the Landfall drop sequence.\n\n2. **Scattered campaign logic**: App.tsx has `handleStartGame`, `handleSkipTutorial`, `handleContinue`, `handleLevelComplete`, `handleContinueToNextLevel`, `handleSelectLevel`, `handleBeginMission`, `handleRestartMission`, etc. These are individual callbacks that implement campaign flow piecemeal.\n\n3. **No mission objectives**: `GameSave.objectives` (Record&lt;string, boolean&gt;) is defined but never populated. No runtime objective tracking.\n\n4. **Dead code**: `canyon` LevelType/factory (unused), `canyonLevelFactory` (throws), MiningDepthsLevel (72KB orphan), AnchorStationLevelV2 (unused), Vehicle classes (PhantomDropship/WraithTank - never instantiated), ReyesDialogue (never imported).\n\n## THE DESIGN GOAL\n\n**CampaignDirector as Game Spine:**\n- Single class that owns campaign state, progression, and level coordination\n- Replaces scattered App.tsx callbacks with a unified API\n- All 10 levels loaded exclusively through ILevel factory system\n- GameManager removed (LandfallLevel already handles HALO drop as ILevel)\n- Clean mission definitions with objectives and narrative context\n- Integrates with existing SaveSystem for persistence\n- React hook `useCampaign()` for UI integration\n\n## EXISTING SYSTEMS TO LEVERAGE\n\n1. **ILevel interface** (types.ts): `initialize()`, `update(deltaTime)`, `dispose()`, `getScene()`, `getState()`, `setState()`, `lockPointer()`, `unlockPointer()`, `setTouchInput()`, `canTransitionTo()`, `prepareTransition()`\n2. **LevelCallbacks**: `onCommsMessage`, `onObjectiveUpdate`, `onLevelComplete(nextLevelId)`, `onHealthChange`, `onKill`, `onDamage`, `onNotification`, `onCombatStateChange`, etc.\n3. **defaultLevelFactories** (factories.ts): All 10 level types have working factories\n4. **CAMPAIGN_LEVELS** (types.ts): 10 LevelConfig entries with chapter, act, mission names, spawn positions, weather\n5. **SaveSystem**: `newGame()`, `completeLevel()`, `setCurrentLevel()`, auto-save\n6. **MissionBriefing**: `MISSION_BRIEFINGS` with briefing text, objectives, enemy intel per chapter\n7. **LevelManager** class exists but is unused - could be leveraged\n\n## CONSTRAINTS\n\n- React 19 with function components and hooks\n- BabylonJS 8.x for 3D rendering (each ILevel creates its own Scene)\n- TypeScript strict mode\n- Biome linter (no errors allowed)\n- ~798 existing unit tests must continue passing\n- Mobile-first (touch controls, performance manager)\n\n## DELIVERABLES\n\nDesign a concrete implementation plan covering:\n\n1. **CampaignDirector class** - API, state management, level lifecycle coordination\n2. **Mission definitions** - How to define the 10 missions with objectives and narrative\n3. **GameCanvas unification** - Single rendering path (remove GameManager dual system)\n4. **App.tsx simplification** - How CampaignDirector simplifies the React state machine\n5. **React hook** (`useCampaign`) - Interface between director and React UI\n6. **Dead code removal** - What to delete and why\n7. **Disconnected system wiring** - How to connect achievements, collectibles, dialogue\n\nFocus on CLEAN architecture. The campaign IS the game. Every design decision should flow from this principle.&#34;,
  &#34;subagent_type&#34;: &#34;Plan&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-35-26-822Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-35-26-822Z" class="timestamp-link"><time datetime="2026-01-30T17:35:26.822Z" data-timestamp="2026-01-30T17:35:26.822Z">2026-01-30T17:35:26.822Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Now I have a comprehensive understanding of the full codebase. Here is the complete CampaignDirector architecture design.

---

# CampaignDirector Architecture for Stellar Descent

## Diagnosis: What Is Wrong Today

After reading every file in the critical path, I can enumerate precisely what needs to change and why.

**App.tsx (702 lines)** functions as a de facto campaign state machine, but the campaign logic is implemented as 15 individual `useCallback` hooks (`handleStartGame`, `handleSkipTutorial`, `handleContinue`, `handleLevelComplete`, `handleContinueToNextLevel`, `handleSelectLevel`, `handleBeginMission`, `handleRestartMission`, `handleRetryLevel`, `handleMainMenu`, `handleTutorialComplete`, `handleDropComplete`, `handleLoadComplete`, `handlePause`, `handleResume`) that all mutate the same `useState` atoms independently. There is no single place that defines what transitions are legal. Any callback can set `gameState` to anything.

**GameCanvas.tsx (763 lines)** has two rendering paths: `tutorialLevelRef` (ILevel, factory-created) and `gameManagerRef` (GameManager class, non-ILevel). The `gameManagerRef` path is used only for the `dropping` state transition (lines 650-678), creating a `GameManager` that manages Player, ChunkManager, CombatSystem, AISystem on the shared scene. But `LandfallLevel` already exists as a full ILevel implementation (BaseLevel subclass) that handles the HALO drop sequence internally. The GameManager path is redundant.

**LevelManager.ts** exists but is entirely unused. It has the right design: `startLevel()`, `transitionTo()`, `transitionToNext()`, `dispose()`. But it is never imported by GameCanvas or App.

**SaveSystem** has `objectives: Record&lt;string, boolean&gt;` defined in GameSave but never populated. `setObjective()` method exists but is never called by any level.

**Achievements** are well-architected (38 achievements, progress tracking) but half the trigger methods (`onCanyonRunComplete`, `onSouthernIceComplete`, `onHiveAssaultComplete`, `onExtractionComplete`, `onFinalEscapeComplete`) are never called from any level. They exist in AchievementManager but there is no orchestrator calling them at the right moments.

---

## Architecture Overview

The CampaignDirector sits between the React UI layer and the BabylonJS level system. It is a plain TypeScript class (not React-specific) that owns all campaign state and exposes it through a React hook.

```
React UI Layer
    |
    v
useCampaign() hook  &lt;-- React bridge
    |
    v
CampaignDirector    &lt;-- Pure TypeScript, owns campaign state machine
    |
    +-- LevelManager (already exists, will be activated)
    |       |
    |       +-- ILevel instances (created by factories)
    |
    +-- SaveSystem (singleton, already exists)
    |
    +-- AchievementManager (singleton, already exists)
    |
    +-- MissionDefinitions (static data, new)
```

---

## 1. CampaignDirector Class

### File: `src/game/campaign/CampaignDirector.ts`

The CampaignDirector is a finite state machine with well-defined transitions. It replaces the 15 scattered callbacks in App.tsx with a single command-based API.

#### Campaign States (replaces GameState)

The current `GameState` type in GameCanvas.tsx is:
```typescript
&#x27;title&#x27; | &#x27;menu&#x27; | &#x27;briefing&#x27; | &#x27;intro&#x27; | &#x27;loading&#x27; | &#x27;tutorial&#x27; | &#x27;dropping&#x27; | &#x27;playing&#x27; | &#x27;paused&#x27; | &#x27;gameover&#x27; | &#x27;levelComplete&#x27; | &#x27;credits&#x27;
```

The CampaignDirector will define these same states but enforce legal transitions:

```typescript
// src/game/campaign/CampaignDirector.ts

export type CampaignPhase =
  | &#x27;idle&#x27;          // Not started, at menu
  | &#x27;briefing&#x27;      // Showing mission briefing
  | &#x27;intro&#x27;         // Cinematic intro
  | &#x27;loading&#x27;       // Loading level assets
  | &#x27;playing&#x27;       // Active gameplay (all level types)
  | &#x27;paused&#x27;        // Gameplay paused
  | &#x27;gameover&#x27;      // Player died
  | &#x27;levelComplete&#x27; // Level finished, showing stats
  | &#x27;credits&#x27;;      // End credits

// Note: &#x27;tutorial&#x27; and &#x27;dropping&#x27; are NOT separate campaign phases.
// They are gameplay states WITHIN a level (&#x27;playing&#x27; phase).
// AnchorStation is &quot;playing&quot; with tutorial mechanics.
// Landfall is &quot;playing&quot; with drop mechanics.
// The level itself manages its internal phases.
```

This is a key insight: the current architecture treats `tutorial` and `dropping` as top-level game states, but they are really just different levels playing. AnchorStation IS the tutorial. Landfall IS the drop. Both are ILevel implementations. When you are playing either of them, you are in the `playing` phase.

#### State Machine Transitions

```
idle --&gt; briefing (startMission / continueSave / selectLevel)
briefing --&gt; intro (beginMission)
briefing --&gt; idle (cancel)
intro --&gt; loading (introComplete)
loading --&gt; playing (loadComplete)
playing --&gt; paused (pause)
paused --&gt; playing (resume)
playing --&gt; gameover (playerDeath)
playing --&gt; levelComplete (levelComplete)
gameover --&gt; loading (restartMission)
gameover --&gt; idle (returnToMenu)
levelComplete --&gt; briefing (nextLevel, if not final)
levelComplete --&gt; credits (nextLevel, if final)
levelComplete --&gt; loading (retryLevel)
levelComplete --&gt; idle (returnToMenu)
credits --&gt; idle (creditsComplete)
```

#### CampaignDirector API

```typescript
export interface CampaignState {
  phase: CampaignPhase;
  currentLevelId: LevelId | null;
  currentMission: MissionDefinition | null;
  
  // Computed from save
  levelsCompleted: LevelId[];
  levelsUnlocked: LevelId[];
  currentChapter: number;
  currentAct: string;
  
  // Stats for current level
  levelStartTime: number;
  kills: number;
  
  // Loading progress
  loadingProgress: { stage: string; progress: number };
  
  // Completion stats (populated when phase === &#x27;levelComplete&#x27;)
  completionStats: LevelStats | null;
  
  // Pre-pause state for resume
  prePausePhase: CampaignPhase | null;
}

export interface CampaignDirectorConfig {
  engine: Engine;
  canvas: HTMLCanvasElement;
  levelFactories: LevelFactoryRegistry;
  callbacks: CampaignCallbacks;
}

// Callbacks from CampaignDirector to React UI
export interface CampaignCallbacks {
  onPhaseChange: (phase: CampaignPhase, prevPhase: CampaignPhase) =&gt; void;
  onStateChange: (state: CampaignState) =&gt; void;
  
  // Forwarded from LevelCallbacks
  onCommsMessage: (message: CommsMessage) =&gt; void;
  onObjectiveUpdate: (title: string, instructions: string) =&gt; void;
  onHealthChange: (health: number) =&gt; void;
  onKill: () =&gt; void;
  onDamage: () =&gt; void;
  onNotification: (text: string, duration?: number) =&gt; void;
  onCombatStateChange: (inCombat: boolean) =&gt; void;
  onActionGroupsChange: (groups: ActionButtonGroup[]) =&gt; void;
  onActionHandlerRegister: (handler: ((actionId: string) =&gt; void) | null) =&gt; void;
  onHitMarker: (damage: number, isCritical: boolean) =&gt; void;
  onDirectionalDamage: (angle: number, damage: number) =&gt; void;
}

export class CampaignDirector {
  private state: CampaignState;
  private config: CampaignDirectorConfig;
  private levelManager: LevelManager;
  private isPaused: boolean = false;
  
  constructor(config: CampaignDirectorConfig);
  
  // === COMMANDS (replace App.tsx callbacks) ===
  
  /** New game - start from anchor_station */
  startNewGame(difficulty?: DifficultyLevel): void;
  
  /** Continue from save */
  continueSave(): void;
  
  /** Select specific level (unlocked) */
  selectLevel(levelId: LevelId): void;
  
  /** Begin mission from briefing screen */
  beginMission(): void;
  
  /** Cancel briefing, return to menu */
  cancelBriefing(): void;
  
  /** Intro cinematic completed */
  introComplete(): void;
  
  /** Loading completed - start gameplay */
  loadComplete(): void;
  
  /** Level signals completion */
  levelComplete(): void;
  
  /** Continue to next level from completion screen */
  continueToNextLevel(): void;
  
  /** Retry current level */
  retryLevel(): void;
  
  /** Player died */
  playerDeath(): void;
  
  /** Restart after death */
  restartMission(): void;
  
  /** Return to main menu (from any state) */
  returnToMenu(): void;
  
  /** Pause gameplay */
  pause(): void;
  
  /** Resume gameplay */
  resume(): void;
  
  /** Credits finished */
  creditsComplete(): void;
  
  // === QUERY ===
  
  getState(): Readonly&lt;CampaignState&gt;;
  getCurrentLevel(): ILevel | null;
  hasSave(): boolean;
  getMissionDefinition(levelId: LevelId): MissionDefinition;
  isLevelUnlocked(levelId: LevelId): boolean;
  
  // === LIFECYCLE ===
  
  /** Called every frame from the render loop */
  update(deltaTime: number): void;
  
  /** Called on touch input change */
  setTouchInput(input: TouchInputState | null): void;
  
  /** Cleanup */
  dispose(): void;
}
```

#### Internal Level Lifecycle

When CampaignDirector transitions to `loading`, it instructs LevelManager to create the level. The critical change is that **all 10 levels go through the same path**: factory lookup, ILevel creation, `initialize()`, then `update()` in the render loop.

The LevelCallbacks that CampaignDirector builds for LevelManager will wrap the callbacks, adding orchestration logic:

```typescript
private buildLevelCallbacks(): LevelCallbacks {
  return {
    onLevelComplete: (nextLevelId: LevelId | null) =&gt; {
      // 1. Record completion stats
      // 2. Call saveSystem.completeLevel()
      // 3. Trigger achievement (per-level achievements like onCanyonRunComplete)
      // 4. Transition to &#x27;levelComplete&#x27; phase
      this.handleLevelComplete(nextLevelId);
    },
    onHealthChange: (health: number) =&gt; {
      // Forward to React AND update save
      this.config.callbacks.onHealthChange(health);
      saveSystem.updateHealth(health);
    },
    onKill: () =&gt; {
      // Forward to React, update save stats, trigger achievements
      this.state.kills++;
      this.config.callbacks.onKill();
      saveSystem.addKill();
    },
    // ... all other callbacks forwarded with orchestration
  };
}
```

The key difference from today: the CampaignDirector intercepts `onLevelComplete` from ILevel and routes it through the campaign state machine. Today, `onLevelComplete` goes from ILevel callback -&gt; GameCanvas -&gt; App.tsx callback `handleLevelComplete`, which then manually sets React state. With CampaignDirector, it goes ILevel -&gt; LevelManager -&gt; CampaignDirector -&gt; React (via `onPhaseChange`).

#### Achievement Wiring

CampaignDirector will call the correct achievement triggers at level completion:

```typescript
private triggerLevelAchievements(levelId: LevelId): void {
  const am = getAchievementManager();
  switch (levelId) {
    case &#x27;anchor_station&#x27;:
      am.onTutorialComplete();
      break;
    case &#x27;landfall&#x27;:
      am.onHaloDropComplete();
      am.onFirstCombatWin();
      break;
    case &#x27;canyon_run&#x27;:
      am.onCanyonRunComplete();
      break;
    case &#x27;fob_delta&#x27;:
      // survivor achievement handled by am.onLevelComplete()
      break;
    case &#x27;brothers_in_arms&#x27;:
      am.onBrothersInArmsComplete(/* marcusWentDown from level state */);
      break;
    case &#x27;southern_ice&#x27;:
      am.onSouthernIceComplete();
      break;
    case &#x27;the_breach&#x27;:
      am.onQueenDefeated();
      break;
    case &#x27;hive_assault&#x27;:
      am.onHiveAssaultComplete();
      break;
    case &#x27;extraction&#x27;:
      am.onExtractionComplete();
      break;
    case &#x27;final_escape&#x27;:
      am.onFinalEscapeComplete(/* crashed from level state */);
      am.onGameComplete();
      break;
  }
  // Generic completion (damage tracking, speed achievements, etc.)
  am.onLevelComplete(levelId, this.playerDiedInLevel);
}
```

This wires up all 10 of the disconnected achievement methods that currently exist but are never called.

---

## 2. Mission Definitions

### File: `src/game/campaign/MissionDefinitions.ts`

Mission definitions extend the existing `LevelConfig` with runtime objective data. Currently, `CAMPAIGN_LEVELS` in `types.ts` has static config (chapter, act, spawn position). Mission definitions add the gameplay contract:

```typescript
export interface MissionObjective {
  id: string;
  title: string;
  description: string;
  type: &#x27;primary&#x27; | &#x27;secondary&#x27; | &#x27;bonus&#x27;;
  completed: boolean;
  // For progress objectives
  current?: number;
  target?: number;
}

export interface MissionDefinition {
  levelId: LevelId;
  config: LevelConfig;  // from CAMPAIGN_LEVELS
  
  // Runtime objectives (populated from static data, tracked at runtime)
  objectives: MissionObjective[];
  
  // Narrative context
  briefingText: string;       // from MISSION_BRIEFINGS
  environmentInfo: string;    // from MissionBriefing.generateBriefingData
  
  // Completion criteria
  completionObjectiveIds: string[];  // which objectives must be complete
  
  // Par time for speed achievements
  parTime: number | null;  // from LEVEL_PAR_TIMES
}
```

The 10 mission definitions would be defined as a static constant. Example for Landfall:

```typescript
export const MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt; = {
  landfall: {
    levelId: &#x27;landfall&#x27;,
    config: CAMPAIGN_LEVELS.landfall,
    objectives: [
      { id: &#x27;land_safely&#x27;, title: &#x27;Survive orbital insertion&#x27;, type: &#x27;primary&#x27;, completed: false },
      { id: &#x27;establish_bearings&#x27;, title: &#x27;Establish bearings on surface&#x27;, type: &#x27;primary&#x27;, completed: false },
      { id: &#x27;first_combat&#x27;, title: &#x27;Eliminate hostile contacts&#x27;, type: &#x27;primary&#x27;, completed: false },
      { id: &#x27;perfect_landing&#x27;, title: &#x27;Achieve perfect landing on LZ pad&#x27;, type: &#x27;bonus&#x27;, completed: false },
    ],
    completionObjectiveIds: [&#x27;land_safely&#x27;, &#x27;establish_bearings&#x27;, &#x27;first_combat&#x27;],
    parTime: LEVEL_PAR_TIMES.landfall ?? null,
    briefingText: MISSION_BRIEFINGS.mission2.text,
    environmentInfo: &#x27;...&#x27;,
  },
  // ... 9 more
};
```

This populates the currently empty `GameSave.objectives` field. When CampaignDirector receives `onObjectiveUpdate` from a level, it can match against MissionDefinition objectives and call `saveSystem.setObjective()`.

---

## 3. GameCanvas Unification - Single Rendering Path

### Problem

GameCanvas currently has:
- Line 259: `gameManagerRef = useRef&lt;GameManager | null&gt;(null)`
- Line 260: `tutorialLevelRef = useRef&lt;ILevel | null&gt;(null)`
- Lines 475-492: Two branches in the render loop
- Lines 650-678: GameManager creation for the `dropping` state

### Solution

Remove `gameManagerRef` entirely. All levels use `tutorialLevelRef` (rename to `activeLevelRef`). LandfallLevel already handles the HALO drop as an ILevel implementation.

The unified GameCanvas becomes dramatically simpler:

```typescript
// Renamed refs
const activeLevelRef = useRef&lt;ILevel | null&gt;(null);
const campaignRef = useRef&lt;CampaignDirector | null&gt;(null);

// Single render loop branch:
engine.runRenderLoop(() =&gt; {
  perfManager.update();
  const deltaTime = engine.getDeltaTime() / 1000;
  
  if (activeLevelRef.current) {
    if (!isPausedRef.current) {
      activeLevelRef.current.update(deltaTime);
    }
    activeLevelRef.current.getScene().render();
  } else {
    // Menu scene
    scene.render();
  }
});
```

The state transition handling in the `useEffect` (lines 565-758) shrinks from 193 lines to roughly 40 lines because the CampaignDirector handles level creation/disposal internally through LevelManager. GameCanvas only needs to:

1. Create CampaignDirector on mount
2. Expose `activeLevelRef` for the render loop
3. Listen to `onPhaseChange` to update the level ref

The callback wiring (lines 591-629 and 699-715, which are duplicated) is defined once inside CampaignDirector.

### What Gets Removed from GameCanvas

- `gameManagerRef` and all GameManager imports
- Dual touch input forwarding (lines 293-298)
- Duplicated LevelCallbacks construction (done twice: lines 591-629 and 699-715)
- State-transition switch statement (lines 575-736)
- All GameManager-related BabylonJS setup (planet, rocks, shaders that were for the old menu scene rendered through GameManager&#x27;s shared scene)

### What Stays

- Canvas element and Engine initialization
- Menu scene (planet, skybox, rocks - rendered when no level is active)
- Performance manager initialization
- Audio manager initialization
- Resize handling

---

## 4. App.tsx Simplification

### Current State (15 callbacks, 702 lines)

All the callbacks in App.tsx are replaced by CampaignDirector commands. The GameUI component shrinks from ~600 lines to ~200 lines.

### New Pattern

```typescript
function GameUI() {
  // CampaignDirector state via hook
  const { state, actions, hasSave } = useCampaign();
  
  // Existing context hooks (unchanged)
  const { playerHealth, maxHealth, kills, ... } = useGame();
  const { isKeyBound } = useKeybindings();
  
  // PWA hooks (unchanged)
  const { isOffline, needsUpdate, ... } = usePWA();
  useSavePersistence();
  
  // Touch detection (unchanged)
  const [isTouchDevice, setIsTouchDevice] = useState(() =&gt; detectTouchCapability());
  
  // Pause key handler (simplified)
  useEffect(() =&gt; {
    const handleKeyDown = (e: KeyboardEvent) =&gt; {
      if (isKeyBound(e.code, &#x27;pause&#x27;) &amp;&amp; state.phase === &#x27;playing&#x27;) {
        e.preventDefault();
        actions.pause();
      }
    };
    window.addEventListener(&#x27;keydown&#x27;, handleKeyDown);
    return () =&gt; window.removeEventListener(&#x27;keydown&#x27;, handleKeyDown);
  }, [state.phase, isKeyBound, actions]);
  
  // Player death -&gt; campaign
  useEffect(() =&gt; {
    if (isPlayerDead &amp;&amp; state.phase === &#x27;playing&#x27;) {
      actions.playerDeath();
    }
  }, [isPlayerDead, state.phase, actions]);
  
  // Render based on phase
  return (
    &lt;div className=&quot;game-container&quot;&gt;
      &lt;GameCanvas campaignDirector={campaignRef} /&gt;
      
      {state.phase === &#x27;idle&#x27; &amp;&amp; (
        &lt;MainMenu
          onStart={() =&gt; actions.startNewGame()}
          onContinue={() =&gt; actions.continueSave()}
          onSkipTutorial={() =&gt; actions.selectLevel(&#x27;landfall&#x27;)}
          onSelectLevel={(id) =&gt; actions.selectLevel(id)}
        /&gt;
      )}
      
      {state.phase === &#x27;briefing&#x27; &amp;&amp; state.currentLevelId &amp;&amp; (
        &lt;MissionBriefing
          isOpen={true}
          levelId={state.currentLevelId}
          onBeginMission={() =&gt; actions.beginMission()}
          onCancel={() =&gt; actions.cancelBriefing()}
        /&gt;
      )}
      
      {/* ... remaining UI components follow same pattern */}
    &lt;/div&gt;
  );
}
```

### What Gets Removed from App.tsx

- 15 `useCallback` hooks for campaign state transitions
- `gameState` useState and all manual state transitions
- `skipTutorial` state (CampaignDirector knows which level to load)
- `startLevelId` state (CampaignDirector owns this)
- `briefingLevelId` state (derived from CampaignDirector state)
- `completionStats` state (owned by CampaignDirector)
- `levelStartTimeRef` (tracked by CampaignDirector)
- `restartKey` state (CampaignDirector handles remounting)
- URL parameter parsing (moved to CampaignDirector constructor)
- Title sequence session tracking (stays, but simplified)

### What Stays

- Provider wrapper (`SettingsProvider`, `GameProvider`, etc.)
- Touch detection logic
- PWA hooks
- UI component rendering (with simplified props)
- Escape key handler (simplified to call `actions.pause()`)

---

## 5. React Hook: `useCampaign()`

### File: `src/game/campaign/useCampaign.ts`

```typescript
export interface UseCampaignReturn {
  state: Readonly&lt;CampaignState&gt;;
  actions: CampaignActions;
  hasSave: boolean;
  
  // Convenience computed values for UI
  currentMissionName: string;
  currentActName: string;
  isPlaying: boolean;
  isPaused: boolean;
  isFinalLevel: boolean;
}

export interface CampaignActions {
  startNewGame: (difficulty?: DifficultyLevel) =&gt; void;
  continueSave: () =&gt; void;
  selectLevel: (levelId: LevelId) =&gt; void;
  beginMission: () =&gt; void;
  cancelBriefing: () =&gt; void;
  introComplete: () =&gt; void;
  loadComplete: () =&gt; void;
  continueToNextLevel: () =&gt; void;
  retryLevel: () =&gt; void;
  playerDeath: () =&gt; void;
  restartMission: () =&gt; void;
  returnToMenu: () =&gt; void;
  pause: () =&gt; void;
  resume: () =&gt; void;
  creditsComplete: () =&gt; void;
}
```

The hook creates the CampaignDirector on first render (when engine and canvas are available), subscribes to state changes, and returns reactive state.

```typescript
export function useCampaign(engine: Engine | null, canvas: HTMLCanvasElement | null): UseCampaignReturn {
  const [state, setState] = useState&lt;CampaignState&gt;(initialState);
  const directorRef = useRef&lt;CampaignDirector | null&gt;(null);
  const gameContext = useGame();
  
  // Initialize director when engine/canvas ready
  useEffect(() =&gt; {
    if (!engine || !canvas) return;
    
    const director = new CampaignDirector({
      engine,
      canvas,
      levelFactories: defaultLevelFactories,
      callbacks: {
        onPhaseChange: (phase, prev) =&gt; {
          setState(director.getState());
        },
        onStateChange: (newState) =&gt; {
          setState(newState);
        },
        // Bridge to GameContext
        onCommsMessage: gameContext.showComms,
        onObjectiveUpdate: gameContext.setObjective,
        onHealthChange: gameContext.setPlayerHealth,
        onKill: gameContext.addKill,
        onDamage: gameContext.onDamage,
        onNotification: gameContext.showNotification,
        onCombatStateChange: gameContext.setInCombat,
        onActionGroupsChange: gameContext.setActionGroups,
        onActionHandlerRegister: gameContext.setOnActionTriggered,
        onHitMarker: gameContext.addHitMarker,
        onDirectionalDamage: gameContext.addDamageIndicator,
      },
    });
    
    directorRef.current = director;
    
    return () =&gt; {
      director.dispose();
      directorRef.current = null;
    };
  }, [engine, canvas]);
  
  // Stable action references
  const actions = useMemo&lt;CampaignActions&gt;(() =&gt; ({
    startNewGame: (d) =&gt; directorRef.current?.startNewGame(d),
    continueSave: () =&gt; directorRef.current?.continueSave(),
    selectLevel: (id) =&gt; directorRef.current?.selectLevel(id),
    // ... all other actions
  }), []);
  
  return {
    state,
    actions,
    hasSave: directorRef.current?.hasSave() ?? false,
    currentMissionName: state.currentMission?.config.missionName ?? &#x27;&#x27;,
    currentActName: state.currentMission?.config.actName ?? &#x27;&#x27;,
    isPlaying: state.phase === &#x27;playing&#x27;,
    isPaused: state.phase === &#x27;paused&#x27;,
    isFinalLevel: state.currentLevelId === &#x27;final_escape&#x27;,
  };
}
```

---

## 6. Dead Code Removal

Based on my exploration, here is what should be deleted and why:

| File/Directory | Reason | Verified |
|---|---|---|
| `src/game/core/GameManager.ts` (204 lines) | Replaced by LevelManager + ILevel system. LandfallLevel already handles HALO drop as ILevel. GameManager creates Player/ChunkManager/CombatSystem/AISystem on a shared scene, but each ILevel creates its own scene with these systems internally. | No external imports except GameCanvas.tsx |
| `src/game/levels/mining-depths/MiningDepthsLevel.ts` | Orphaned level. Not referenced in `CAMPAIGN_LEVELS`, not in factories, not imported anywhere. | grep found only self-reference |
| `src/game/vehicles/PhantomDropship.ts` | Never imported outside vehicles/index.ts. No level or system uses it. | grep: only VehicleHUD.tsx imports from vehicles |
| `src/game/vehicles/WraithTank.ts` | Same as PhantomDropship | Same verification |
| `src/game/vehicles/VehicleBase.ts` | Base class only used by the unused vehicles above | Same verification |
| `src/game/vehicles/VehicleHUD.tsx` | HUD for unused vehicle system | Same verification |
| `src/game/vehicles/index.ts` | Barrel export for unused vehicles | Same verification |
| `src/game/audio/ReyesDialogue.ts` | Never imported. grep found only self-reference. | Confirmed |
| `canyonLevelFactory` in factories.ts (lines 55-62) | Throws `Error(&#x27;Canyon level type is not yet implemented&#x27;)`. Canyon type is in `LevelType` but `canyon_run` uses type `&#x27;vehicle&#x27;`, not `&#x27;canyon&#x27;`. The `canyon` LevelType can be removed from the union as well. | CanyonRunLevel uses vehicleLevelFactory |
| `src/game/levels/anchor-station/AnchorStationLevelV2.ts` | Listed in git status as untracked. Not on disk (checked). May have been deleted already but git sees a phantom. | `ls` returned file not found |

### Safe to remove because nothing imports them:
- `src/game/vehicles/` (entire directory)
- `src/game/audio/ReyesDialogue.ts`
- `src/game/levels/mining-depths/` (entire directory)
- GameManager.ts (after GameCanvas migration)

### Requires code change:
- `canyonLevelFactory` and `&#x27;canyon&#x27;` LevelType: Remove from factories.ts and types.ts
- GameManager import in GameCanvas.tsx: Remove after migration

---

## 7. Disconnected System Wiring

### Problem: Objectives Never Populated

`GameSave.objectives` is `Record&lt;string, boolean&gt;` and always empty. The `SaveSystem.setObjective()` method exists but is never called.

**Fix:** CampaignDirector intercepts `onObjectiveUpdate` from levels and maps it to MissionDefinition objectives. When a level calls `callbacks.onObjectiveUpdate(&#x27;Survive landing&#x27;, &#x27;&#x27;)`, CampaignDirector matches it against `MissionDefinition.objectives[0]` and calls `saveSystem.setObjective(&#x27;land_safely&#x27;, true)`.

### Problem: Achievement Triggers Disconnected

7 achievement trigger methods exist in AchievementManager but are never called:
- `onCanyonRunComplete()`
- `onSouthernIceComplete()`
- `onHiveAssaultComplete()`
- `onExtractionComplete()`
- `onFinalEscapeComplete(crashed)`
- `onBrothersInArmsComplete(marcusDown)`
- `onMarcusFound()`

**Fix:** CampaignDirector calls these in `triggerLevelAchievements()` when a level completes. For achievements that depend on level-internal state (like `marcusWentDown`), the level stores this in its `LevelState.flags` which CampaignDirector reads before triggering.

### Problem: Save System Not Wired to Level Events

Kills, distance, health, position, chapter changes are tracked by `SaveSystem` methods that exist but are not consistently called.

**Fix:** CampaignDirector&#x27;s LevelCallbacks wrapper calls `saveSystem.addKill()` on every `onKill`, `saveSystem.updateHealth()` on every `onHealthChange`, etc. The CampaignDirector becomes the single point where all game events flow through, ensuring nothing is missed.

### Problem: Collectibles Have No Infrastructure

The achievement system has `onSecretFound()`, `onAudioLogFound()`, `onAllCollectiblesFound()` but there is no collectible data model.

**Fix:** Add to LevelCallbacks:

```typescript
// New callbacks for collectible/narrative tracking
onCollectibleFound?: (type: &#x27;secret&#x27; | &#x27;audio_log&#x27; | &#x27;data_pad&#x27;, id: string) =&gt; void;
onAreaDiscovered?: (areaId: string) =&gt; void;
```

CampaignDirector routes these to AchievementManager&#x27;s existing methods.

### Problem: Dialogue System Exists But Unused

`MarcusVoice.ts`, `PlayerVoice.ts`, `VoiceSynthesizer.ts` exist in `src/game/audio/`. These are presumably for in-game dialogue.

**Fix:** CampaignDirector can trigger level-specific dialogue by calling into the audio system at phase transitions. For example, when entering Brothers in Arms, trigger Marcus&#x27;s voice lines. This wiring happens in CampaignDirector&#x27;s `onPhaseChange` handler.

---

## Implementation Sequence

The implementation should proceed in this order to maintain the 798 passing tests at every step:

### Phase 1: Foundation (no behavior change)
1. Create `src/game/campaign/` directory
2. Create `MissionDefinitions.ts` with the 10 mission definitions (static data, no side effects)
3. Create `CampaignDirector.ts` class with state machine (tested in isolation)
4. Create `useCampaign.ts` hook

### Phase 2: Activate LevelManager (minor behavior change)
5. Update `LevelManager.ts` to remove the `require()` call (line 203) and use proper imports
6. Wire CampaignDirector to use LevelManager for level creation/disposal

### Phase 3: Unify GameCanvas (significant refactor)
7. Remove `gameManagerRef` from GameCanvas
8. Rename `tutorialLevelRef` to `activeLevelRef`
9. Remove the GameManager code path for `dropping` state
10. Have CampaignDirector manage level lifecycle instead of GameCanvas state effects
11. Remove duplicated LevelCallbacks construction

### Phase 4: Simplify App.tsx (large refactor)
12. Replace 15 callbacks with `useCampaign()` hook
13. Remove `gameState` useState, replace with `state.phase`
14. Remove `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey` state
15. Simplify UI rendering to use campaign state

### Phase 5: Wire Disconnected Systems
16. Add objective tracking in CampaignDirector
17. Wire all achievement triggers
18. Add collectible callbacks to LevelCallbacks

### Phase 6: Dead Code Removal
19. Delete `src/game/core/GameManager.ts`
20. Delete `src/game/vehicles/` directory
21. Delete `src/game/audio/ReyesDialogue.ts`
22. Delete `src/game/levels/mining-depths/` directory
23. Remove `canyon` LevelType and `canyonLevelFactory`

### Phase 7: Validation
24. Run all 798 tests
25. Manual smoke test: menu -&gt; briefing -&gt; loading -&gt; tutorial -&gt; drop -&gt; playing -&gt; death -&gt; restart -&gt; complete -&gt; next level
26. Verify e2e tests pass

---

## File Structure After Changes

```
src/game/campaign/
  CampaignDirector.ts       # Core state machine (~300 lines)
  CampaignDirector.test.ts  # Unit tests for state transitions
  MissionDefinitions.ts     # Static mission data (~200 lines)
  useCampaign.ts            # React hook (~120 lines)
  index.ts                  # Barrel exports
```

### Critical Files for Implementation

- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/campaign/CampaignDirector.ts` - Core class to create: state machine, level lifecycle, achievement wiring, save integration
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx` - Major refactor: remove GameManager dual system, single ILevel rendering path, delegate level lifecycle to CampaignDirector
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/App.tsx` - Major simplification: replace 15 callbacks with useCampaign() hook, phase-based rendering
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/LevelManager.ts` - Activate existing unused class, fix require() import, integrate with CampaignDirector
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts` - Remove `canyon` LevelType, add collectible callback types to LevelCallbacks</pre><pre>agentId: a7f2ef6 (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-35-32-294Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-35-32-294Z" class="timestamp-link"><time datetime="2026-01-30T17:35:32.294Z" data-timestamp="2026-01-30T17:35:32.294Z">2026-01-30T17:35:32.294Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Excellent - the Plan agent produced a comprehensive design. Let me now synthesize this into the final plan file, incorporating all three exploration results and the architecture design. Let me write the plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-35-32-857Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-35-32-857Z" class="timestamp-link"><time datetime="2026-01-30T17:35:32.857Z" data-timestamp="2026-01-30T17:35:32.857Z">2026-01-30T17:35:32.857Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Excellent. I have a complete architecture design. Let me write the final plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-36-18-224Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-36-18-224Z" class="timestamp-link"><time datetime="2026-01-30T17:36:18.224Z" data-timestamp="2026-01-30T17:36:18.224Z">2026-01-30T17:36:18.224Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01NLgmPa3NdGu6czZ8NsdYY2">
<div class="file-tool-header write-header"><span class="file-tool-icon">📝</span> Write <span class="file-tool-path">quiet-meandering-cookie.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Plan: CampaignDirector as Game Spine

## Summary

Replace scattered campaign logic with a `CampaignDirector` class that IS the spine of the game. Every level transition, unlock, save, and achievement flows through this single coordinator. Unify GameCanvas to one rendering path (all ILevel, no GameManager). Remove all dead code and fix all warnings.

## Core Insight

`tutorial` and `dropping` are NOT separate game phases - they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel respectively. Both levels implement ILevel. The CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.

## Architecture

```
React UI (App.tsx)
    |
useCampaign() hook
    |
CampaignDirector  &lt;-- SPINE: owns state machine, progression, level lifecycle
    |
    +-- LevelManager (existing class, currently unused - activate it)
    |       |
    |       +-- ILevel instances (all 10 levels via defaultLevelFactories)
    |
    +-- SaveSystem (existing singleton)
    +-- AchievementManager (existing singleton)
    +-- MissionDefinitions (new static data)
```

## Campaign Phases (replaces GameState)

```
idle --&gt; briefing --&gt; intro --&gt; loading --&gt; playing --&gt; levelComplete --&gt; briefing (next)
                                              |                              |
                                              +--&gt; paused                    +--&gt; credits (final)
                                              +--&gt; gameover --&gt; loading (retry)
```

Key change: `tutorial` and `dropping` are removed as top-level phases. AnchorStation IS the tutorial. Landfall IS the drop. When playing either, you&#39;re in the `playing` phase.

---

## New Files

### 1. `src/game/campaign/CampaignDirector.ts` (~300 lines)

State machine with command API:
- `startNewGame()`, `continueSave()`, `selectLevel(id)`
- `beginMission()`, `introComplete()`, `loadComplete()`
- `pause()`, `resume()`, `playerDeath()`, `restartMission()`
- `levelComplete()`, `continueToNextLevel()`, `retryLevel()`
- `returnToMenu()`, `creditsComplete()`
- `update(deltaTime)`, `setTouchInput()`, `dispose()`

Internally uses `LevelManager` (existing class) for level creation/disposal. Builds `LevelCallbacks` that intercept events, wire achievements, and forward to React.

Achievement wiring: `triggerLevelAchievements(levelId)` calls the correct `AchievementManager` methods per level (7 currently disconnected methods).

### 2. `src/game/campaign/MissionDefinitions.ts` (~250 lines)

Static `MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt;` with:
- Per-level objectives (primary, secondary, bonus)
- Narrative context (from existing `MISSION_BRIEFINGS`)
- Completion criteria
- Par times for speed achievements

### 3. `src/game/campaign/types.ts` (~60 lines)

`CampaignPhase`, `CampaignState`, `CampaignCallbacks`, `MissionDefinition`, `MissionObjective`

### 4. `src/game/campaign/useCampaign.ts` (~120 lines)

React hook creating/managing CampaignDirector. Bridges to `useGame()` context. Returns `{ state, actions, hasSave }`.

### 5. `src/game/campaign/index.ts`

Barrel exports.

---

## Modified Files

### `src/components/GameCanvas.tsx` - Major simplification

**Remove:**
- `gameManagerRef` and all `GameManager` imports
- Dual rendering paths (tutorialLevelRef vs gameManagerRef)
- Duplicated LevelCallbacks construction (currently built twice: lines 591-629 and 699-715)
- State transition switch statement (lines 575-736)
- Planet/rock/shader setup stays (menu scene background)

**Replace with:**
- Single `activeLevelRef` for render loop
- CampaignDirector controls level lifecycle
- Render loop: `activeLevelRef?.update() + getScene().render()` OR menu `scene.render()`
- GameCanvas receives the director ref from App.tsx, or the hook exposes the active level

### `src/App.tsx` - Major simplification (~700 -&gt; ~300 lines)

**Remove:**
- 15 `useCallback` hooks for campaign state transitions
- `gameState`, `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey`, `levelStartTimeRef` state
- URL parameter parsing (moves to CampaignDirector)

**Replace with:**
- `useCampaign()` hook providing `state` and `actions`
- Phase-based UI rendering: `state.phase === &#39;briefing&#39;` instead of `gameState === &#39;briefing&#39;`
- Actions passed directly: `onStart={() =&gt; actions.startNewGame()}`

### `src/game/levels/LevelManager.ts` - Activate + fix

- Fix `require()` call on line 203 (use proper import)
- Wire into CampaignDirector

### `src/game/levels/types.ts` - Remove dead type

- Remove `&#39;canyon&#39;` from `LevelType` union (unused, Canyon Run uses `&#39;vehicle&#39;`)
- Add optional collectible callbacks to `LevelCallbacks`

### `src/game/levels/factories.ts` - Remove dead factory

- Remove `canyonLevelFactory` (throws, unused)
- Remove `canyon` from `defaultLevelFactories` and `LevelFactoryRegistry`

### `src/game/levels/index.ts` - Update exports

- Remove canyon-related exports

---

## Deleted Files

| Path | Reason |
|------|--------|
| `src/game/core/GameManager.ts` | Replaced by ILevel system. LandfallLevel handles HALO drop. |
| `src/game/levels/mining-depths/` (directory) | 72KB orphaned level. Not in campaign, not imported anywhere. |
| `src/game/levels/anchor-station/AnchorStationLevelV2.ts` | Unused duplicate of V1. |
| `src/game/vehicles/` (directory) | PhantomDropship, WraithTank, VehicleBase, VehicleHUD - never instantiated by any level. |
| `src/game/audio/ReyesDialogue.ts` | 822 LOC never imported anywhere. |

---

## Implementation Order

Each phase keeps tests passing:

### Phase 1: Create campaign foundation (additive, no breaking changes)
1. Create `src/game/campaign/types.ts`
2. Create `src/game/campaign/MissionDefinitions.ts`
3. Create `src/game/campaign/CampaignDirector.ts`
4. Create `src/game/campaign/useCampaign.ts`
5. Create `src/game/campaign/index.ts`
6. Add unit test for CampaignDirector state transitions

### Phase 2: Fix LevelManager
7. Fix `require()` in `LevelManager.ts` line 203 (use static import)
8. Wire CampaignDirector to use LevelManager

### Phase 3: Remove dead LevelType
9. Remove `&#39;canyon&#39;` from `LevelType` in types.ts
10. Remove `canyonLevelFactory` from factories.ts
11. Remove `&#39;canyon&#39;` from `LevelFactoryRegistry` interface
12. Update `MissionBriefing.tsx` envTypeMap (remove canyon entry)

### Phase 4: Unify GameCanvas
13. Remove `gameManagerRef` and GameManager import
14. Rename `tutorialLevelRef` to `activeLevelRef`
15. Remove GameManager creation in `dropping` state
16. Remove duplicated LevelCallbacks (CampaignDirector builds them once)
17. Simplify render loop to single ILevel branch
18. Wire CampaignDirector to control `activeLevelRef`

### Phase 5: Simplify App.tsx
19. Replace 15 callbacks with `useCampaign()` hook
20. Replace `gameState` with `campaign.state.phase`
21. Remove redundant state atoms
22. Simplify UI component rendering

### Phase 6: Wire disconnected systems
23. Wire all 7 disconnected achievement triggers in CampaignDirector
24. Populate `GameSave.objectives` from level events
25. Add collectible callbacks to LevelCallbacks

### Phase 7: Delete dead code
26. Delete GameManager.ts, mining-depths/, AnchorStationLevelV2.ts, vehicles/, ReyesDialogue.ts

### Phase 8: Validate
27. `tsc --noEmit` - 0 errors
28. `vitest run` - all tests pass
29. `biome check` - 0 errors
30. `vite build` - succeeds

---

## Verification

1. **TypeScript**: `npx tsc --noEmit` - 0 errors
2. **Unit tests**: `npx vitest run` - all pass (add CampaignDirector tests)
3. **Biome**: `npx biome check .` - 0 errors
4. **Build**: `npx vite build` - succeeds with PWA
5. **Manual smoke test**: Menu -&gt; New Game -&gt; Briefing -&gt; Intro -&gt; Loading -&gt; Tutorial (Anchor Station) -&gt; HALO Drop (Landfall) -&gt; Playing -&gt; Death -&gt; Restart -&gt; Level Complete -&gt; Next Level -&gt; ... -&gt; Credits
6. **URL param test**: `?level=fob_delta` loads FOB Delta directly
7. **Continue test**: Save auto-persists, Continue loads correct level
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T17-36-18-231Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T17-36-18-231Z" class="timestamp-link"><time datetime="2026-01-30T17:36:18.231Z" data-timestamp="2026-01-30T17:36:18.231Z">2026-01-30T17:36:18.231Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>File created successfully at: /Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T17-36-21-638Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T17-36-21-638Z" class="timestamp-link"><time datetime="2026-01-30T17:36:21.638Z" data-timestamp="2026-01-30T17:36:21.638Z">2026-01-30T17:36:21.638Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01VbrrdLKbgjpKZvkwWPqkdF"><div class="tool-header"><span class="tool-icon">⚙</span> ExitPlanMode</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;plan&#34;: &#34;# Plan: CampaignDirector as Game Spine\n\n## Summary\n\nReplace scattered campaign logic with a `CampaignDirector` class that IS the spine of the game. Every level transition, unlock, save, and achievement flows through this single coordinator. Unify GameCanvas to one rendering path (all ILevel, no GameManager). Remove all dead code and fix all warnings.\n\n## Core Insight\n\n`tutorial` and `dropping` are NOT separate game phases - they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel respectively. Both levels implement ILevel. The CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.\n\n## Architecture\n\n```\nReact UI (App.tsx)\n    |\nuseCampaign() hook\n    |\nCampaignDirector  &lt;-- SPINE: owns state machine, progression, level lifecycle\n    |\n    +-- LevelManager (existing class, currently unused - activate it)\n    |       |\n    |       +-- ILevel instances (all 10 levels via defaultLevelFactories)\n    |\n    +-- SaveSystem (existing singleton)\n    +-- AchievementManager (existing singleton)\n    +-- MissionDefinitions (new static data)\n```\n\n## Campaign Phases (replaces GameState)\n\n```\nidle --&gt; briefing --&gt; intro --&gt; loading --&gt; playing --&gt; levelComplete --&gt; briefing (next)\n                                              |                              |\n                                              +--&gt; paused                    +--&gt; credits (final)\n                                              +--&gt; gameover --&gt; loading (retry)\n```\n\nKey change: `tutorial` and `dropping` are removed as top-level phases. AnchorStation IS the tutorial. Landfall IS the drop. When playing either, you&#39;re in the `playing` phase.\n\n---\n\n## New Files\n\n### 1. `src/game/campaign/CampaignDirector.ts` (~300 lines)\n\nState machine with command API:\n- `startNewGame()`, `continueSave()`, `selectLevel(id)`\n- `beginMission()`, `introComplete()`, `loadComplete()`\n- `pause()`, `resume()`, `playerDeath()`, `restartMission()`\n- `levelComplete()`, `continueToNextLevel()`, `retryLevel()`\n- `returnToMenu()`, `creditsComplete()`\n- `update(deltaTime)`, `setTouchInput()`, `dispose()`\n\nInternally uses `LevelManager` (existing class) for level creation/disposal. Builds `LevelCallbacks` that intercept events, wire achievements, and forward to React.\n\nAchievement wiring: `triggerLevelAchievements(levelId)` calls the correct `AchievementManager` methods per level (7 currently disconnected methods).\n\n### 2. `src/game/campaign/MissionDefinitions.ts` (~250 lines)\n\nStatic `MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt;` with:\n- Per-level objectives (primary, secondary, bonus)\n- Narrative context (from existing `MISSION_BRIEFINGS`)\n- Completion criteria\n- Par times for speed achievements\n\n### 3. `src/game/campaign/types.ts` (~60 lines)\n\n`CampaignPhase`, `CampaignState`, `CampaignCallbacks`, `MissionDefinition`, `MissionObjective`\n\n### 4. `src/game/campaign/useCampaign.ts` (~120 lines)\n\nReact hook creating/managing CampaignDirector. Bridges to `useGame()` context. Returns `{ state, actions, hasSave }`.\n\n### 5. `src/game/campaign/index.ts`\n\nBarrel exports.\n\n---\n\n## Modified Files\n\n### `src/components/GameCanvas.tsx` - Major simplification\n\n**Remove:**\n- `gameManagerRef` and all `GameManager` imports\n- Dual rendering paths (tutorialLevelRef vs gameManagerRef)\n- Duplicated LevelCallbacks construction (currently built twice: lines 591-629 and 699-715)\n- State transition switch statement (lines 575-736)\n- Planet/rock/shader setup stays (menu scene background)\n\n**Replace with:**\n- Single `activeLevelRef` for render loop\n- CampaignDirector controls level lifecycle\n- Render loop: `activeLevelRef?.update() + getScene().render()` OR menu `scene.render()`\n- GameCanvas receives the director ref from App.tsx, or the hook exposes the active level\n\n### `src/App.tsx` - Major simplification (~700 -&gt; ~300 lines)\n\n**Remove:**\n- 15 `useCallback` hooks for campaign state transitions\n- `gameState`, `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey`, `levelStartTimeRef` state\n- URL parameter parsing (moves to CampaignDirector)\n\n**Replace with:**\n- `useCampaign()` hook providing `state` and `actions`\n- Phase-based UI rendering: `state.phase === &#39;briefing&#39;` instead of `gameState === &#39;briefing&#39;`\n- Actions passed directly: `onStart={() =&gt; actions.startNewGame()}`\n\n### `src/game/levels/LevelManager.ts` - Activate + fix\n\n- Fix `require()` call on line 203 (use proper import)\n- Wire into CampaignDirector\n\n### `src/game/levels/types.ts` - Remove dead type\n\n- Remove `&#39;canyon&#39;` from `LevelType` union (unused, Canyon Run uses `&#39;vehicle&#39;`)\n- Add optional collectible callbacks to `LevelCallbacks`\n\n### `src/game/levels/factories.ts` - Remove dead factory\n\n- Remove `canyonLevelFactory` (throws, unused)\n- Remove `canyon` from `defaultLevelFactories` and `LevelFactoryRegistry`\n\n### `src/game/levels/index.ts` - Update exports\n\n- Remove canyon-related exports\n\n---\n\n## Deleted Files\n\n| Path | Reason |\n|------|--------|\n| `src/game/core/GameManager.ts` | Replaced by ILevel system. LandfallLevel handles HALO drop. |\n| `src/game/levels/mining-depths/` (directory) | 72KB orphaned level. Not in campaign, not imported anywhere. |\n| `src/game/levels/anchor-station/AnchorStationLevelV2.ts` | Unused duplicate of V1. |\n| `src/game/vehicles/` (directory) | PhantomDropship, WraithTank, VehicleBase, VehicleHUD - never instantiated by any level. |\n| `src/game/audio/ReyesDialogue.ts` | 822 LOC never imported anywhere. |\n\n---\n\n## Implementation Order\n\nEach phase keeps tests passing:\n\n### Phase 1: Create campaign foundation (additive, no breaking changes)\n1. Create `src/game/campaign/types.ts`\n2. Create `src/game/campaign/MissionDefinitions.ts`\n3. Create `src/game/campaign/CampaignDirector.ts`\n4. Create `src/game/campaign/useCampaign.ts`\n5. Create `src/game/campaign/index.ts`\n6. Add unit test for CampaignDirector state transitions\n\n### Phase 2: Fix LevelManager\n7. Fix `require()` in `LevelManager.ts` line 203 (use static import)\n8. Wire CampaignDirector to use LevelManager\n\n### Phase 3: Remove dead LevelType\n9. Remove `&#39;canyon&#39;` from `LevelType` in types.ts\n10. Remove `canyonLevelFactory` from factories.ts\n11. Remove `&#39;canyon&#39;` from `LevelFactoryRegistry` interface\n12. Update `MissionBriefing.tsx` envTypeMap (remove canyon entry)\n\n### Phase 4: Unify GameCanvas\n13. Remove `gameManagerRef` and GameManager import\n14. Rename `tutorialLevelRef` to `activeLevelRef`\n15. Remove GameManager creation in `dropping` state\n16. Remove duplicated LevelCallbacks (CampaignDirector builds them once)\n17. Simplify render loop to single ILevel branch\n18. Wire CampaignDirector to control `activeLevelRef`\n\n### Phase 5: Simplify App.tsx\n19. Replace 15 callbacks with `useCampaign()` hook\n20. Replace `gameState` with `campaign.state.phase`\n21. Remove redundant state atoms\n22. Simplify UI component rendering\n\n### Phase 6: Wire disconnected systems\n23. Wire all 7 disconnected achievement triggers in CampaignDirector\n24. Populate `GameSave.objectives` from level events\n25. Add collectible callbacks to LevelCallbacks\n\n### Phase 7: Delete dead code\n26. Delete GameManager.ts, mining-depths/, AnchorStationLevelV2.ts, vehicles/, ReyesDialogue.ts\n\n### Phase 8: Validate\n27. `tsc --noEmit` - 0 errors\n28. `vitest run` - all tests pass\n29. `biome check` - 0 errors\n30. `vite build` - succeeds\n\n---\n\n## Verification\n\n1. **TypeScript**: `npx tsc --noEmit` - 0 errors\n2. **Unit tests**: `npx vitest run` - all pass (add CampaignDirector tests)\n3. **Biome**: `npx biome check .` - 0 errors\n4. **Build**: `npx vite build` - succeeds with PWA\n5. **Manual smoke test**: Menu -&gt; New Game -&gt; Briefing -&gt; Intro -&gt; Loading -&gt; Tutorial (Anchor Station) -&gt; HALO Drop (Landfall) -&gt; Playing -&gt; Death -&gt; Restart -&gt; Level Complete -&gt; Next Level -&gt; ... -&gt; Credits\n6. **URL param test**: `?level=fob_delta` loads FOB Delta directly\n7. **Continue test**: Save auto-persists, Continue loads correct level\n&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-48-44-276Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-48-44-276Z" class="timestamp-link"><time datetime="2026-01-30T18:48:44.276Z" data-timestamp="2026-01-30T18:48:44.276Z">2026-01-30T18:48:44.276Z</time></a></div><div class="message-content"><div class="tool-result tool-error"><div class="truncatable"><div class="truncatable-content"><pre>The user doesn&#x27;t want to proceed with this tool use. The tool use was rejected (eg. if it was a file edit, the new_string was NOT written to the file). To tell you how to proceed, the user said:
IT makes no sense not to break things. It makes MORE sense to include refactoring the tests properly. Also make sure that documentation updates are included AND make sure you&#x27;re not removing content for no reason. It&#x27;s a ten level campaign, make sure that we are actually USING everything designed like the canyyon / unwired mining level, REVIEW the docs and existing overall vision documents before making decisions on what to remove or what to EXPAND. Also make SURE every level is using MODELS to set its scene, has appropriate audio, make SURE that the LANDING of the game has its pacing reviewe for that mission briefing, and also I want you to review incoming-ui, I&#x27;ve put two splash MP4s in there, one is 9:16, one is 16:9, and thne I put a BUTTONS.md and JSON for 9 slice UI buttons we can use for the main menu. Here&#x27;s my thought, wee setup a PROPER Capacitor splash screen for web/mobile etc with the videos depending on portrait/landscape responsively scaled, and then we move the introductory briefing UX and first of all CONDENSE it, it takes way too long to type out, but it gets triggered ONCE after New Game and then saved in state, that they seen it, so they don&#x27;t get it again, and then it should START in a barracks room in the space base by models for barracks beds, etc.... Look through the PBX models, we should have tons of stuff wecan use, but let me know oof any gaps in assets. We want to STOP procedurally generating walls, et.... Our goal for the space base is everything snapped together with those GLB base models, all the planet side stuff babylonjs dynamic terrain with ambientCG, and proper skyscapes. Underground we have plemty of alien tech models and stuff etc....  Let&#x27; REALLY dive into the ATMOSPHERE of eveyr level</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-49-01-139Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-49-01-139Z" class="timestamp-link"><time datetime="2026-01-30T18:49:01.139Z" data-timestamp="2026-01-30T18:49:01.139Z">2026-01-30T18:49:01.139Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>The user has given me a lot of detailed feedback. Let me break it down:</p>
<ol>
<li>
<p><strong>Don't remove content for no reason</strong> - Instead of deleting mining-depths, canyon type, vehicles, ReyesDialogue, etc., we should WIRE THEM IN. Review the docs and vision to understand what each level needs.</p>
</li>
<li>
<p><strong>Use everything designed</strong> - Canyon level should be wired, mining level should be wired, vehicles should be used.</p>
</li>
<li>
<p><strong>Every level should use MODELS</strong> - Not procedural walls. GLB models for space base (snap-together), PSX-style models for levels.</p>
</li>
<li>
<p><strong>Appropriate audio</strong> for each level.</p>
</li>
<li>
<p>I need to tighten up the mission briefing pacing and condense it. The incoming-ui directory has splash videos in both portrait and landscape formats plus UI button definitions that I should use for the main menu and responsive splash screens. The introductory briefing should trigger once after New Game, persist in state so players don't see it repeatedly, and start in a barracks room with proper models rather than placeholder geometry.</p>
</li>
<li>
<p>I have access to PSX models that should cover most needs, though I'll need to identify any gaps. Instead of procedurally generating walls, I'll use snap-together GLB models for better control and visual consistency. The planet surface will use BabylonJS dynamic terrain with proper ambient textures and skyscapes, while underground areas will feature alien tech models to establish atmosphere.</p>
</li>
<li>
<p>This scope is significantly larger than my original plan, so I should explore the incoming-ui directory, review what PSX models are available, and check the existing documentation before finalizing the approach.</p>
</li>
<li>
<p>I need to examine the textures directory alongside the models to understand what visual assets I'm working with.</p>
</li>
</ol></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-49-01-208Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-49-01-208Z" class="timestamp-link"><time datetime="2026-01-30T18:49:01.208Z" data-timestamp="2026-01-30T18:49:01.208Z">2026-01-30T18:49:01.208Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Let me explore the new assets and docs before revising the plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-49-08-899Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-49-08-899Z" class="timestamp-link"><time datetime="2026-01-30T18:49:08.899Z" data-timestamp="2026-01-30T18:49:08.899Z">2026-01-30T18:49:08.899Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01FvSRG2xk1QLzY5xP13LcQN"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Explore incoming-ui assets and docs</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;prompt&#34;: &#34;Explore the Stellar Descent codebase to understand available assets, vision documents, and the new incoming-ui directory. I need a thorough inventory.\n\n1. **incoming-ui/ directory**: List ALL files. Read BUTTONS.md fully. Read any JSON files. Note the MP4 filenames and sizes.\n\n2. **public/models/ directory**: List ALL model files (GLB, GLTF, OBJ, FBX). Categorize them: space station models, terrain/environment, alien/hive, vehicles, weapons, characters, props. Note file sizes.\n\n3. **public/textures/ directory**: List ALL texture files. What texture sets are available? Any ambientCG textures?\n\n4. **docs/ directory**: Read ALL markdown files in docs/ - especially DESIGN.md, ARCHITECTURE.md, LORE.md, LEVELS.md, PSX-ASSETS.md. These are the vision documents that define what each level should look like.\n\n5. **PSX model loader**: Read `src/game/core/PSXModelLoader.ts` to understand how models are loaded and used.\n\n6. **AssetManager**: Read `src/game/core/AssetManager.ts` to understand the asset pipeline.\n\n7. **Level environment files**: For EACH level directory, read the `environment.ts` file to understand what models/textures each level currently uses and what&#39;s procedurally generated vs model-based.\n\nBe very thorough. I need a complete inventory of:\n- What models exist\n- What each level currently uses\n- What&#39;s procedurally generated that should use models instead\n- What gaps exist in the asset library\n- What the vision docs say each level should look like&#34;,
  &#34;subagent_type&#34;: &#34;Explore&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-50-37-125Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-50-37-125Z" class="timestamp-link"><time datetime="2026-01-30T18:50:37.125Z" data-timestamp="2026-01-30T18:50:37.125Z">2026-01-30T18:50:37.125Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Perfect! I now have a comprehensive understanding of the codebase. Let me compile the thorough inventory you requested.

---

## STELLAR DESCENT: COMPLETE ASSET &amp; ARCHITECTURE INVENTORY

### 1. INCOMING-UI DIRECTORY

**Location**: `/incoming-ui/`

**Files**:
- `BUTTONS.md` - UI button specification (9-slice military olive buttons, RGBA PNG, 512×192)
- `buttons.json` - Metadata for 4 button states (normal, hover, pressed, disabled) with CSS 9-slice configuration
- `splash-16-9.mp4` - Splash screen video (12MB, landscape orientation)
- `splash-9-16.mp4` - Splash screen video (12MB, portrait orientation)

**Button Assets**:
- `btn_military_olive_normal.png`
- `btn_military_olive_hover.png`
- `btn_military_olive_pressed.png`
- `btn_military_olive_disabled.png`

**Status**: Ready for integration into UI system

---

### 2. PUBLIC/MODELS DIRECTORY

**Total Models**: 47 GLB files (~190MB total)

#### A. ENEMIES/CHITIN (8 models - 17.9MB)
All enemy variant models from UE pack conversion:
- `alienfemale.glb` (3.2MB) - Humanoid variant
- `alienmale.glb` (2.2MB) - Humanoid variant
- `alienmonster.glb` (5.7MB) - Large creature
- `flyingalien.glb` (1.4MB) - Flying drone variant
- `scout.glb` (1.6MB) - Maps to &quot;lurker&quot; gameplay
- `soldier.glb` (1.6MB) - Maps to &quot;spewer&quot; gameplay
- `spider.glb` (1.5MB) - Maps to &quot;skitterer&quot; gameplay
- `tentakel.glb` (1.5MB) - Maps to &quot;broodmother&quot; boss

**Usage in Game**:
- Spider → Skitterer (fast swarmers)
- Scout → Lurker (tall stalkers)
- Soldier → Spewer (armored ranged)
- Tentakel → Broodmother (boss, Queen)
- Others mapped via SPECIES_TO_ASSET in AssetManager

#### B. ENVIRONMENT/HIVE (7 models - 20.9MB)
Organic building structures for The Breach level:
- `building_birther.glb` (4.2MB) - Egg production structure
- `building_brain.glb` (1.1MB) - Hive control center
- `building_claw.glb` (5.3MB) - Combat structure
- `building_crystals.glb` (405KB) - Crystalline formations
- `building_stomach.glb` (5.5MB) - Organic chamber
- `building_terraformer.glb` (2.2MB) - Environmental structure
- `building_undercrystal.glb` (1.6MB) - Underground formation

#### C. ENVIRONMENT/STATION (15 models - 39MB)
PSX-style modular station architecture for Anchor Station:

**Structural Elements**:
- `beam_hc_horizonatal_1.glb` (471KB) - Support beams
- `beam_hc_vertical_1.glb` (484KB) - Vertical beams
- `corridor_corner.glb` (4.3MB) - Corner corridors
- `corridor_junction.glb` (3.9MB) - Multi-path junctions
- `corridor_main.glb` (7.4MB) - Primary corridors
- `corridor_wide.glb` (4.3MB) - Wider passages
- `doorway_hr_1.glb` (1.6MB) - Standard doorways
- `doorway_hr_1_wide.glb` (1.7MB) - Wide doorways
- `floor_ceiling_hr_1.glb` (543KB) - Floor/ceiling module
- `floor_ceiling_hr_3.glb` (999KB) - Variant module
- `floor_ceiling_rtx_1.glb` (1.7MB) - RTX variant
- `pipe_cx_1.glb` (1.2MB) - Pipe segment 1
- `pipe_cx_2.glb` (1.3MB) - Pipe segment 2
- `station_barrel.glb` (113KB) - Prop barrel
- `station_door.glb` (143KB) - Door prop

#### D. PROPS/INDUSTRIAL (13 models - 6.3MB)
Small props and environmental details:
- `cardboard_box_1.glb` (116KB)
- `door_hr_12.glb` (65KB)
- `door_hr_13.glb` (61KB)
- `door_hr_6.glb` (71KB)
- `electrical_equipment_1.glb` (245KB)
- `lamp_mx_1_a_on.glb` (845KB) - Lit lamp
- `lamp_mx_2_on.glb` (510KB) - Lit lamp
- `lamp_mx_3_on.glb` (512KB) - Lit lamp
- `machinery_mx_1.glb` (452KB)
- `metal_barrel_hr_1.glb` (409KB)
- `metal_barrel_hr_2.glb` (391KB)
- `pipes_hr_1.glb` (84KB)
- `shelf_mx_1.glb` (603KB)

#### E. VEHICLES (4 models - 23.6MB)
Combat vehicles and dropships:

**TEA Military**:
- `marcus_mech.glb` (576KB) - M-47 &quot;Titan&quot; mech (Marcus&#x27;s vehicle)
- `phantom.glb` (11MB) - Dropship for extraction

**Chitin**:
- `wraith.glb` (12MB) - Enemy hover tank

---

### 3. PUBLIC/TEXTURES DIRECTORY

**Total Textures**: 6 PSX-style PNG files (~2.4MB)

All textures use PSX aesthetic (limited color palettes, 64-256px resolution):
- `concrete_hr_1.png` (559KB)
- `door_hr_6.png` (68KB)
- `machinery_mx_1.png` (197KB)
- `metal_barrel_hr_1.png` (392KB)
- `metal_hr_1.png` (507KB)
- `wall_hr_1.png` (429KB)

**Status**: Minimal coverage. Many materials created procedurally in code.

---

### 4. DOCUMENTATION/VISION DOCUMENTS

#### A. DESIGN.md - UI/UX Guidelines
- **Color Palette**: Military olive/tan theme, no neon, no cyberpunk purples
- **Typography**: Rajdhani (UI), Share Tech Mono (data), Black Ops One (titles)
- **Button States**: Primary/hover/disabled/active with scale transforms
- **Health Bar**: 180-250px width, 20-24px height, color-coded (green/yellow/red)
- **Crosshair**: 4-6px center dot, 12-16px lines, 8-10px gap
- **Touch Controls**: Joysticks 22-18% of screen, 44px minimum touch targets

#### B. LEVELS.md - Complete Campaign Architecture
**6 Story Levels** (not all implemented):

1. **Anchor Station** (`anchor_station`)
   - Type: Station interior (tutorial)
   - Rooms: Briefing, Corridor A, Equipment Bay, Shooting Range, Hangar Bay
   - 5-10 minutes duration
   - Progressive HUD unlocks (health → crosshair → kill counter)

2. **Landfall** (`landfall`)
   - Type: Drop → Canyon
   - Phases: Freefall, debris dodge, powered descent, surface combat
   - 8-12 minutes duration
   - Landing outcomes affect starting position

3. **FOB Delta** (`fob_delta`)
   - Type: Base (horror survival)
   - Horror atmosphere, flickering lights, ambush mechanic
   - 10-15 minutes duration

4. **Brothers in Arms** (`brothers_in_arms`)
   - Type: Canyon (mech combat)
   - Marcus&#x27;s AI ally (M-47 Titan mech)
   - Wave-based combat, reunion scene
   - 12-18 minutes duration

5. **The Breach** (`the_breach`)
   - Type: Hive (boss fight)
   - **Procedurally generated maze** (seedrandom for consistency)
   - Boss arena (hand-crafted), Queen boss fight (3 phases, 5000 HP)
   - Drill/explosives mechanics for obstacle removal
   - 15-20 minutes duration

6. **Extraction** (`extraction`)
   - Type: Holdout + escape
   - Wave-based defense (7 escalating waves)
   - Vehicle escape sequence
   - 8-12 minutes duration

#### C. PSX-ASSETS.md - Asset Specification
Comprehensive asset templates for all environments:

**Unit System**: 1 unit = 1 meter
**Standard Dimensions**:
- Door height: 2.2m
- Corridor width: 3-4m
- Standard room height: 3-4m
- Human eye height: 1.7m

**Modular Architecture**:
- Floor modules: 4×4m standard
- Wall modules: 4m×3m standard
- Ceiling modules: 4×4m
- Door frame: 2.4m wide × 2.2m tall

**Color Palettes**:
- Station: Panel gray (#3A3A4A), Floor dark (#2A2A2A), Accent blue (#4A5A7A)
- Planet surface: Rock tan (#9B7B5A), Brown (#6B4A2A), Red (#8B4A3A)
- Hive: Chitin dark (#3A2A3A), Chitin purple (#5A3A5A), Bio glow (#4AC8C8)

#### D. LORE.md - Complete Campaign Narrative
**10-level story** (6 major levels detailed):

- **Characters**: James Cole (SPECTER), Marcus Cole (HAMMER), Commander Vasquez, ATHENA AI
- **Enemy**: The Chitin - insectoid hive species, controlled by queen
- **Themes**: Survival, soldier bonds, sacrifice, duty
- **Arc**: Drop → Search → Assault → Escape
- **15 discoverable audio logs** provide backstory and environmental context

---

### 5. PSXModelLoader.ts - Model System

**Catalog Structure**:
```typescript
PSX_MODELS = {
  structures: { floorCeiling1, wallDouble, doorway, beams, pipes... },
  doors: { door6, door12, door13 },
  lights: { lamp1, lamp2, lamp3 },
  props: { barrel1, shelf, box, machinery... }
}
```

**Key Features**:
- Model cache for efficient instancing
- Clone-based approach (not true instancing due to visibility needs)
- LOD support for environment/prop categories
- Transform options: position, rotation, scale, parent
- Corridor builder function for modular assembly

**Instancing Pattern**:
1. Load master → hide master
2. Clone for each instance
3. Apply transforms
4. Optional LOD application

---

### 6. AssetManager.ts - Asset Pipeline

**Pipeline-Backed Loading**:
- `preloadLevel(levelId)` - Load all assets for a level using manifest
- `prefetchNextLevel(currentLevelId)` - Background load next level
- Memory budgeting: 512MB default
- Priority bands: required → preload → deferred

**Legacy API** (backward compatible):
- `loadAsset(category, assetName)` - Load single asset
- `createInstance(category, assetName)` - Create instance
- `loadAlienModel(speciesId)` - Load enemy by species

**Asset Manifest** (partial):
```typescript
aliens: { spider, scout, soldier, tentakel, flyingalien... }
vehicles: { wraith, phantom, marcus_mech }
structures: { birther, brain, claw, crystals, stomach... }
```

**Species Mapping**:
- skitterer → spider.glb
- lurker → scout.glb
- spewer → soldier.glb
- husk → alienmale.glb
- broodmother → tentakel.glb

---

### 7. LEVEL ENVIRONMENT FILES

#### A. Anchor Station (`anchor-station/environment.ts`)

**Rooms Created**:
1. Briefing Room (20×15×4m) - Windows, hologram table
2. Corridor A (4×30×3m) - Guide line, lights, pipes
3. Platforming Room (12×16×5m) - Jump tutorial, platforms
4. Equipment Bay (15×12×4m) - Suit locker, weapon rack
5. Shooting Range (25×10×4m) - 5 holographic targets
6. Hangar Bay (40×30×12m) - Drop pod, bay doors, extraction
7. Curved Corridors (ring-station design connecting rooms)
8. Scenic Rooms (observation deck, mess hall, recreation area)

**What&#x27;s Procedurally Generated**:
- Simple geometric rooms (boxes, cylinders)
- Targeting system for shooting range
- Hologram effects
- Door animations
- Light animations

**What Uses Models**:
- ✗ Currently NONE - entire station is procedural geometry

**Vision vs. Reality GAP**:
- PSX-ASSETS.md describes modular station pieces (corridor, wall, floor modules)
- Implementation uses primitive geometry (MeshBuilder.CreateBox/CreateCylinder)
- **Missing**: GLB models for station corridors and structures

#### B. Canyon Run (`canyon-run/environment.ts`)

**Environment**:
- Terrain floor: Subdivided ground with sine-wave height variations
- Canyon walls: 60 segments per side, randomly varied
- Boulders: 45 scattered obstacles
- Bridges: 2 bridges (1 collapsible at Z=-1500)
- Wrecks: 8 overturned vehicles
- Vegetation: 30 clusters at base of walls
- Dust emitters: 15 position markers
- Objective markers: 6 waypoints with beacons
- Extraction zone: Landing pad marking

**What&#x27;s Procedurally Generated**:
- Terrain height variations (sine functions)
- Canyon walls (random width, height, position)
- All boulders, vegetation, wrecks
- All lighting (sun + 10 point lights)

**What Uses Models**:
- ✗ NONE - all pure procedural

**Vision vs. Reality GAP**:
- LEVELS.md describes &quot;canyon terrain modules&quot; and &quot;rock formations&quot;
- Implementation is entirely procedural
- **Missing**: Rock formation GLB models, terrain patches

#### C. The Breach (`the-breach/environment.ts`)

**Environment**:
- Tunnel segments: Procedural cylinders with organic growths
- Chambers: Spherical caverns with bioluminescent patches
- Biolights: Fungal growth lights with flicker animation
- Hive structures: Uses AssetManager to load 7 GLB models
- Captured vehicles: Places Wraith/Phantom models with organic growth

**What&#x27;s Using Models**:
- ✓ Hive structures (birther, brain, claw, crystals, stomach, terraformer, undercrystal)
- ✓ Captured vehicles (wraith, phantom)

**What&#x27;s Procedurally Generated**:
- Tunnel segments (cylinders + random growths)
- Chambers (spheres + disc patches)
- Biolights (spheres + point lights)
- Organic growth on vehicles (spheres + tendrils)
- Materials and lighting effects

**Status**: Partially implemented with models

---

### 8. WHAT&#x27;S CURRENTLY WORKING

**Models in Active Use**:
1. Hive structures (The Breach level)
2. Captured vehicles (The Breach level)
3. Enemy models (loaded via AssetManager, used by ECS system)

**Pipeline Infrastructure**:
- AssetManager singleton with manifest-driven loading
- AssetPipeline with priority bands and memory budgeting
- LODManager for distance-based quality
- Level-specific asset manifests defined

---

### 9. MAJOR GAPS &amp; MISSING ASSETS

#### A. Station Architecture (Anchor Station)
**Missing**: GLB models for modular corridor/wall/floor pieces

**PSX-ASSETS.md specifies**:
- Floor modules (standard, solid, detail)
- Wall modules (standard, window, display, piped, door)
- Ceiling modules (standard, light)
- Door modules (single, double, airlock)
- Props (crates, terminals, lockers, weapon rack, furniture)

**Current Reality**:
- Entire station procedurally generated with primitive geometry
- **This will need ~15-20 GLB models to match design**

#### B. Canyon Environment (Landfall, Brothers in Arms, Extraction)
**Missing**: Rock formation, terrain module models

**PSX-ASSETS.md specifies**:
- Rock pillars (small, large)
- Rock boulders (varied)
- Rock outcrops (layered)
- Terrain modules (flat, slope, cliff)

**Current Reality**:
- All procedural sine-wave terrain and random boulders
- **This will need ~8-12 GLB models for defined formations**

#### C. FOB Delta Base
**Missing**: All base structures

**PSX-ASSETS.md specifies**:
- Prefab structures (small, medium, large, hangar)
- Military props (sandbags, barriers, comm tower, generator)
- Interior elements (bunks, terminals, lockers)
- Damage decals (blood, scorches, holes)

**Current Reality**:
- **No FOB Delta implementation yet** (level exists but minimal content)
- **This will need ~15-20 GLB models**

#### D. Additional Missing Models
- Player arms/weapons (first-person view)
- NPCs (static marines, Commander Vasquez)
- Weapon models (M7 rifle, sidearm)
- Mech cockpit interior view
- Environmental hazards (acid pools, etc.)

---

### 10. ASSET PIPELINE STATUS

**Implemented**:
- ✓ AssetManager singleton
- ✓ Model caching system
- ✓ LOD Manager
- ✓ AssetPipeline with priority bands
- ✓ Memory budgeting (512MB)
- ✓ Level manifests structure
- ✓ PSXModelLoader helper functions

**Partially Implemented**:
- The Breach level (uses some models)
- Enemy system (models loaded, not heavily used)

**Not Implemented**:
- Anchor Station: Uses zero models
- Landfall/Canyon: Uses zero models
- FOB Delta: No level implementation
- Extraction: No level implementation

---

### 11. TEXTURES &amp; MATERIALS STATUS

**Available Textures** (6 files, ~2.4MB):
- PSX concrete, metal, machinery, door, wall, barrel

**Materials Created Procedurally**:
- Station materials (100+ variations in environment.ts)
- Canyon materials (9+ custom StandardMaterial definitions)
- Hive materials (8+ bioluminescent materials)
- Creature materials (default colors for enemies)

**Status**: Minimal texture coverage but robust procedural material system in place

---

## SUMMARY: VISION VS. IMPLEMENTATION

| System | Vision (DESIGN/LEVELS/PSX-ASSETS) | Current Implementation |
|--------|-----------------------------------|------------------------|
| **Anchor Station** | Modular GLB corridors, walls, doors, props | 100% procedural geometry |
| **Landfall Canyon** | Terrain modules, rock formations | 100% procedural terrain |
| **FOB Delta** | Base structures, interiors, damage | Not implemented |
| **Brothers in Arms** | Canyon + mech ally | Partial (mech not visibly integrated) |
| **The Breach** | Hive structures + procedural maze | 40% (structures loaded, maze procedural) |
| **Extraction** | Wave defense + escape | Not implemented |
| **Enemy Models** | 8 variants (sprite sheet) | ✓ Loaded (spider, scout, soldier, etc.) |
| **Vehicle Models** | 3 types (Titan, Wraith, Phantom) | ✓ Loaded (used in Breach level) |
| **Textures** | Full PSX color sets | 6 files (~2.4MB) |
| **UI** | Military olive 9-slice buttons, splash videos | ✓ Assets ready (buttons.json, MP4s) |

---

## NEXT PRIORITY ACTIONS

1. **Create missing station models** (~15 GLB files) for Anchor Station
2. **Create rock/terrain models** (~8 GLB files) for canyon levels  
3. **Implement FOB Delta level** with base structure models
4. **Complete procedural maze generation** for The Breach (seeded randomness)
5. **Integrate enemy and vehicle models** into actual gameplay (currently loaded but minimal use)

---

This inventory shows a well-architected **asset pipeline system** with robust infrastructure, but **significant implementation gaps** between vision documents and actual content. The codebase is ready to accept models—it just needs them created.</pre><pre>agentId: aad46fd (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-51-11-195Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-51-11-195Z" class="timestamp-link"><time datetime="2026-01-30T18:51:11.195Z" data-timestamp="2026-01-30T18:51:11.195Z">2026-01-30T18:51:11.195Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Excellent! Now I have a comprehensive understanding. Let me revise my plan based on the user's feedback:</p>
<p>Key changes from user feedback:
1. DON'T remove mining depths, canyon, vehicles, ReyesDialogue - WIRE THEM IN
2. Review docs and vision before removing anything - EXPAND the campaign to include everything
3. Use the incoming-ui splash videos for Capacitor splash screen
4. Use the 9-slice buttons for main menu
5. Condense the intro briefing - too slow typing
6. Briefing triggers once, saved in state
7. Start in barracks room with models (not procedural)</p>
<ol>
<li>Replace procedural generation with PSX models throughout, add dynamic terrain for planet levels using ambientCG textures and proper skyscapes, and use alien tech models for underground sections</li>
<li>Deepen the atmospheric design of each level, fix the test suite properly, and update documentation</li>
<li>I have a solid asset foundation to work with: station corridors and rooms, industrial props, hive structures, enemy models, vehicles, PSX textures, and the incoming UI splash videos for the Capacitor screen plus button assets</li>
</ol>
<p>Now I need to restructure this into a phased approach: establish CampaignDirector as the backbone for 12 levels, build out the splash screen with video playback and 9-slice buttons for the menu, overhaul each level's atmosphere with proper models and audio, wire Mining Depths and Canyon into the campaign flow, connect all the loose systems like achievements and dialogue, then finalize documentation.</p>
<p>Looking at the campaign structure, I see Mining Depths should slot into Act 4 since Acts 1-3 are already defined, and the Canyon type needs to be integrated into the existing level progression rather than left unused. I need to integrate Mining Depths into the campaign structure and decide whether to expand to 11 levels or replace an existing one, then refocus on the user's actual priorities: reviewing the incoming UI, setting up the Capacitor splash screen with videos, condensing the intro briefing, and starting gameplay in the barracks with character models.</p>
<p>The scope is massive—I'm looking at PSX models for visual gaps, removing procedural walls, implementing dynamic terrain, proper skyscapes, and underground alien tech—so I need to organize this into phases and document the critical asset gaps: missing barracks and bed models, no first-person weapons, no NPC models, only 6 textures total, no skybox or sky dome assets, and no terrain patches for canyon and surface areas.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-51-11-271Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-51-11-271Z" class="timestamp-link"><time datetime="2026-01-30T18:51:11.271Z" data-timestamp="2026-01-30T18:51:11.271Z">2026-01-30T18:51:11.271Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>The user's feedback completely reframes the scope. Let me revise the plan based on their detailed vision.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-51-11-998Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-51-11-998Z" class="timestamp-link"><time datetime="2026-01-30T18:51:11.998Z" data-timestamp="2026-01-30T18:51:11.998Z">2026-01-30T18:51:11.998Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_017rr8qedZ8WBv1qMxKwYqJD"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/incoming-ui/BUTTONS.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-51-12-003Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-51-12-003Z" class="timestamp-link"><time datetime="2026-01-30T18:51:12.003Z" data-timestamp="2026-01-30T18:51:12.003Z">2026-01-30T18:51:12.003Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# STELLAR DESCENT – Military 9‑Slice Buttons
     2→
     3→RGBA PNG, mobile‑first, utilitarian military UI buttons.
     4→
     5→Asset size: 512×192
     6→Insets: L/R 96px, T/B 64px
     7→
     8→Use with CSS border-image (9‑slice).

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-51-12-865Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-51-12-865Z" class="timestamp-link"><time datetime="2026-01-30T18:51:12.865Z" data-timestamp="2026-01-30T18:51:12.865Z">2026-01-30T18:51:12.865Z</time></a></div><div class="message-content">
<div class="tool-use bash-tool" data-tool-id="toolu_01GaBQsKniUta8FL5u3ZRXfH">
<div class="tool-header"><span class="tool-icon">$</span> Bash</div>
<div class="tool-description">List incoming-ui directory</div><div class="truncatable"><div class="truncatable-content"><pre class="bash-command">ls -la /Users/jbogaty/src/arcade-cabinet/stellar-descent/incoming-ui/</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-51-12-939Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-51-12-939Z" class="timestamp-link"><time datetime="2026-01-30T18:51:12.939Z" data-timestamp="2026-01-30T18:51:12.939Z">2026-01-30T18:51:12.939Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>total 23072
drwx------  8 jbogaty staff      256 Jan 30 12:19 .
drwxr-xr-x 45 jbogaty staff     1440 Jan 30 12:39 ..
-rw-r--r--  1 jbogaty staff     6148 Jan 30 11:57 .DS_Store
drwxr-xr-x  3 jbogaty staff       96 Jan 30 11:56 assets
-rw-r--r--  1 jbogaty staff     1746 Jan 30  2026 buttons.json
-rw-r--r--  1 jbogaty staff      197 Jan 30  2026 BUTTONS.md
-rw-r--r--  1 jbogaty staff 11709980 Jan 30 11:55 splash-16-9.mp4
-rw-r--r--  1 jbogaty staff 11897913 Jan 30 11:52 splash-9-16.mp4</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-51-13-462Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-51-13-462Z" class="timestamp-link"><time datetime="2026-01-30T18:51:13.462Z" data-timestamp="2026-01-30T18:51:13.462Z">2026-01-30T18:51:13.462Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01Y2Gj1iQnZK6nGgfJLwXtCj"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/incoming-ui/buttons.json&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div><details class="continuation"><summary>Session continuation summary</summary>
<div class="message user" id="msg-2026-01-30T18-54-01-428Z"><div class="message-header"><span class="role-label">User</span><a href="#msg-2026-01-30T18-54-01-428Z" class="timestamp-link"><time datetime="2026-01-30T18:54:01.428Z" data-timestamp="2026-01-30T18:54:01.428Z">2026-01-30T18:54:01.428Z</time></a></div><div class="message-content">
<div class="user-content"><p>This session is being continued from a previous conversation that ran out of context. The summary below covers the earlier portion of the conversation.</p>
<p>Analysis:
Let me chronologically analyze the entire conversation to build a comprehensive summary.</p>
<p><strong>Session Start Context:</strong>
This is a continuation of multiple previous sessions working on "Stellar Descent" - a BabylonJS/React FPS game. The previous session summary describes extensive work including:
- Fixing Biome lint errors
- Handling destructive Jules bot commits
- Merging PR #1
- Creating a new branch for gaps/polish</p>
<p><strong>Message 1 - User</strong>: "Please continue the conversation from where we left it off without asking the user any further questions. Continue with the last task that you were asked to work on."</p>
<p><strong>My Actions - Gap Analysis and Factory Fixes:</strong>
1. Checked current branch: <code>feature/capacitor-gaps-polish</code>
2. Retrieved gap analysis results from background agent <code>a1e0be3</code>
3. Read critical files: factories.ts, types.ts, index.ts, App.tsx, southern-ice/index.ts
4. Read GameCanvas.tsx, LevelManager.ts
5. Verified class export names in SouthernIceLevel, HiveAssaultLevel, FinalEscapeLevel
6. Read useLevelManager.ts</p>
<p><strong>Key findings from gap analysis:</strong>
- 3 level factories throw "not yet implemented" errors (chapters 6, 8, 10)
- southern-ice/index.ts exports empty <code>{}</code>
- hive-assault/ and final-escape/ missing index.ts files
- VALID_LEVELS in App.tsx missing 4 levels
- GameCanvas hardcodes <code>new AnchorStationLevel()</code> instead of using factory system
- <code>_handleLevelComplete</code> in App.tsx has underscore prefix (unused)
- <code>canyon</code> LevelType exists but unused (Canyon Run uses <code>vehicle</code> type)</p>
<p><strong>Created 6 tasks and implemented fixes:</strong></p>
<p>Task 147: Fixed factories.ts - Added imports for SouthernIceLevel, HiveAssaultLevel, FinalEscapeLevel. Replaced throw stubs with actual instantiation. Updated createLevelFactories to use defaultLevelFactories.</p>
<p>Task 148: Fixed index exports - Updated southern-ice/index.ts to export SouthernIceLevel. Created hive-assault/index.ts and final-escape/index.ts.</p>
<p>Task 149: Fixed App.tsx - Added all 10 levels to VALID_LEVELS. Added switch cases for canyon_run, southern_ice, hive_assault, final_escape in handleLoadComplete.</p>
<p>Task 150: Wired GameCanvas to factory system - Replaced <code>import { AnchorStationLevel }</code> with <code>import { defaultLevelFactories }</code>. Added onLevelComplete to GameCanvasProps. Replaced hardcoded <code>new AnchorStationLevel()</code> with factory-based creation. Added factory-based level creation for direct-to-playing transitions.</p>
<p>Task 151: Wired level completion - Renamed <code>_handleLevelComplete</code> to <code>handleLevelComplete</code>. Passed as <code>onLevelComplete</code> prop to GameCanvas.</p>
<p>Task 152: Verified - 0 TS errors, 798/798 tests pass, 0 biome errors, build succeeds.</p>
<p>Committed as <code>8c87410</code> and pushed. Created PR #3.</p>
<p><strong>Message 2 - User</strong>: "What if the main quest chain WAS what actually wired all the levels together? How do most games like this do it? Does that FEEL clean? What feels clean? I'm thinking what if we setup the main quest chain genuinely AS the spine of the game and it was what coordinated everything, when to unlock what, etc.... Also do not leave ANY errors or warnings unresolved, like for example WHY aren't we properly fixing the canyon level. NOTHING should be generic, all levels should be meticulously you-crafted, scenes painted carefully to set mood and atmosphere"</p>
<p><strong>My Actions - Entered Plan Mode:</strong>
1. Launched 3 parallel Explore agents:
   - Campaign flow and coordination (agent a4400b5)
   - Level environments and atmosphere (agent a60e453)
   - Biome warnings and dead code (agent abe810b)</p>
<ol>
<li>
<p>Read additional files: GameManager.ts, SaveSystem.ts, GameSave.ts, MissionBriefing.tsx</p>
</li>
<li>
<p>Launched Plan agent (a7f2ef6) for CampaignDirector architecture design</p>
</li>
<li>
<p>Wrote plan file at <code>/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</code></p>
</li>
<li>
<p>Called ExitPlanMode</p>
</li>
</ol>
<p><strong>Message 3 - User REJECTED the plan with extensive feedback:</strong>
"IT makes no sense not to break things. It makes MORE sense to include refactoring the tests properly. Also make sure that documentation updates are included AND make sure you're not removing content for no reason. It's a ten level campaign, make sure that we are actually USING everything designed like the canyon / unwired mining level, REVIEW the docs and existing overall vision documents before making decisions on what to remove or what to EXPAND. Also make SURE every level is using MODELS to set its scene, has appropriate audio, make SURE that the LANDING of the game has its pacing reviewed for that mission briefing, and also I want you to review incoming-ui, I've put two splash MP4s in there, one is 9:16, one is 16:9, and then I put a BUTTONS.md and JSON for 9 slice UI buttons we can use for the main menu. Here's my thought, we setup a PROPER Capacitor splash screen for web/mobile etc with the videos depending on portrait/landscape responsively scaled, and then we move the introductory briefing UX and first of all CONDENSE it, it takes way too long to type out, but it gets triggered ONCE after New Game and then saved in state, that they seen it, so they don't get it again, and then it should START in a barracks room in the space base by models for barracks beds, etc.... Look through the PSX models, we should have tons of stuff we can use, but let me know of any gaps in assets. We want to STOP procedurally generating walls, etc.... Our goal for the space base is everything snapped together with those GLB base models, all the planet side stuff babylonjs dynamic terrain with ambientCG, and proper skyscapes. Underground we have plenty of alien tech models and stuff etc.... Let's REALLY dive into the ATMOSPHERE of every level"</p>
<p><strong>My Actions - Deeper Exploration:</strong>
Launched Explore agent (aad46fd) for incoming-ui assets, models, textures, docs, PSXModelLoader, AssetManager, and level environment files.</p>
<p>Read incoming-ui files:
- BUTTONS.md: Military 9-slice buttons, 512×192 RGBA PNG, insets L/R 96px T/B 64px
- buttons.json: 4 states (normal, hover, pressed, disabled) with CSS border-image config
- splash-16-9.mp4: 12MB landscape video
- splash-9-16.mp4: 12MB portrait video
- assets/ subdirectory exists</p>
<p><strong>Agent findings - Asset inventory:</strong>
- 47 GLB models (~190MB): 8 enemies, 7 hive structures, 15 station models, 13 industrial props, 4 vehicles
- 6 PSX textures (~2.4MB)
- Station models include corridors, doorways, floor/ceiling pieces, beams, pipes, barrels
- NO barracks/bed models specifically
- Anchor Station currently uses ZERO models (100% procedural geometry)
- Canyon levels use ZERO models (100% procedural)
- Only The Breach uses hive structure models
- Mining Depths is fully implemented but not in campaign
- Vehicle system (PhantomDropship, WraithTank) is fully implemented but never instantiated</p>
<p><strong>Current state: Plan mode still active, plan file needs revision based on user feedback.</strong></p>
<p>Key user directives I need to capture:
1. DON'T remove content - WIRE IT ALL IN (mining depths, canyon, vehicles, ReyesDialogue)
2. Use models everywhere - stop procedural walls
3. Splash screen with videos (portrait/landscape responsive)
4. 9-slice buttons for main menu
5. Condense intro briefing (too slow), trigger once, save state
6. Start in barracks room with models
7. BabylonJS dynamic terrain with ambientCG for planet side
8. Proper skyscapes
9. Underground: alien tech models
10. Report asset gaps
11. Tests CAN break - refactor properly
12. Include documentation updates
13. Review pacing of landing/briefing
14. Every level meticulously crafted with atmosphere</p>
<p>Summary:
1. Primary Request and Intent:
   The user is building "Stellar Descent: Proxima Breach" - a BabylonJS 8.x/React 19 FPS game with a 10+ level campaign. The session started as a continuation from previous work on branch <code>feature/capacitor-gaps-polish</code>. The user's evolving requests are:</p>
<p><strong>Initial</strong>: Continue from where left off - fix implementation gaps in the factory system and level wiring.</p>
<p><strong>Evolved (Message 2)</strong>: Redesign the game's architecture so the <strong>main quest chain IS the spine</strong> of the game - a <code>CampaignDirector</code> that coordinates everything: level loading, unlocking, transitions, saves, achievements. No generic stubs allowed. All levels meticulously crafted.</p>
<p><strong>Final/Current (Message 3 - plan rejection)</strong>: Massively expanded scope:
   - <strong>DON'T remove content</strong> - wire EVERYTHING in (mining depths, canyon type, vehicles, ReyesDialogue)
   - <strong>Use GLB models everywhere</strong> - stop procedurally generating walls. Space base = snap-together GLB models. Planet side = BabylonJS dynamic terrain with ambientCG textures + proper skyscapes. Underground = alien tech models.
   - <strong>Splash screen</strong>: Use the two MP4 videos from <code>incoming-ui/</code> (9:16 portrait, 16:9 landscape) for a proper Capacitor splash screen, responsively scaled
   - <strong>9-slice buttons</strong>: Use the military olive button PNGs + JSON config for main menu
   - <strong>Condense intro briefing</strong>: Currently types too slowly. Trigger ONCE after New Game, save in state so it doesn't repeat. Start in barracks room with model-based beds/furniture
   - <strong>Review PSX model inventory</strong> and report asset gaps
   - <strong>Tests CAN break</strong> - refactor them properly
   - <strong>Documentation updates</strong> must be included
   - <strong>Review pacing</strong> of landing and mission briefing UX
   - <strong>Dive deep into ATMOSPHERE</strong> of every level</p>
<ol>
<li>Key Technical Concepts:</li>
<li><strong>BabylonJS 8.x</strong> with WebGL2, React 19, TypeScript 5.9</li>
<li><strong>Miniplex 2.x</strong> ECS (Entity Component System)</li>
<li><strong>ILevel interface</strong>: <code>initialize()</code>, <code>update(deltaTime)</code>, <code>dispose()</code>, <code>getScene()</code>, <code>getState()</code>, <code>setState()</code>, <code>setTouchInput()</code></li>
<li><strong>LevelFactory pattern</strong>: <code>defaultLevelFactories</code> maps <code>LevelType</code> → factory function → <code>ILevel</code></li>
<li><strong>LevelManager class</strong> (exists but UNUSED) - orchestrates level transitions and lifecycle</li>
<li><strong>CampaignDirector</strong> (proposed) - single coordinator for campaign progression, replaces scattered App.tsx callbacks</li>
<li><strong>Dual rendering system</strong> (current problem): <code>tutorialLevelRef</code> (ILevel) vs <code>gameManagerRef</code> (GameManager, NOT ILevel-compatible)</li>
<li><strong>GameManager</strong> manages Player, ChunkManager, CombatSystem, AISystem on shared scene</li>
<li><strong>PSXModelLoader</strong>: Model catalog with cache, clone-based instancing, LOD support</li>
<li><strong>AssetManager</strong>: Pipeline-based loading with priority bands, memory budgeting (512MB), level manifests</li>
<li><strong>SaveSystem</strong>: IndexedDB persistence via worldDb, <code>GameSave</code> interface with <code>levelsCompleted[]</code>, <code>objectives: Record&lt;string, boolean&gt;</code> (currently empty)</li>
<li><strong>9-slice CSS buttons</strong>: <code>border-image-slice</code> with 512×192 PNG assets, 4 states</li>
<li><strong>Capacitor 8.x</strong>: Configured for iOS/Android but web builds use Vite PWA via Netlify</li>
<li><strong>Campaign linked list</strong>: <code>CAMPAIGN_LEVELS</code> maps <code>LevelId</code> → <code>LevelConfig</code> with <code>nextLevelId</code>/<code>previousLevelId</code></li>
<li>
<p><strong>Level type hierarchy</strong>: <code>BaseLevel</code> → <code>StationLevel</code> (interiors) / <code>SurfaceLevel</code> (outdoors) → concrete levels</p>
</li>
<li>
<p>Files and Code Sections:</p>
</li>
<li>
<p><strong><code>src/game/levels/factories.ts</code></strong> (critical - factory wiring)</p>
<ul>
<li>Fixed: Added imports for SouthernIceLevel, HiveAssaultLevel, FinalEscapeLevel</li>
<li>Fixed: Replaced 3 throw stubs with actual instantiation</li>
<li>Fixed: Updated <code>createLevelFactories</code> to return full <code>LevelFactoryRegistry</code> using <code>defaultLevelFactories</code></li>
<li>Still has: <code>canyonLevelFactory</code> that throws (user says DON'T remove - wire it in)
 <code>typescript
 import { FinalEscapeLevel } from './final-escape/FinalEscapeLevel';
 import { HiveAssaultLevel } from './hive-assault/HiveAssaultLevel';
 import { SouthernIceLevel } from './southern-ice/SouthernIceLevel';
 // ... 
 export const iceLevelFactory: LevelFactory = (engine, canvas, config, callbacks): ILevel =&gt; {
   return new SouthernIceLevel(engine, canvas, config, callbacks);
 };
 export const combinedArmsLevelFactory: LevelFactory = (engine, canvas, config, callbacks): ILevel =&gt; {
   return new HiveAssaultLevel(engine, canvas, config, callbacks);
 };
 export const finaleLevelFactory: LevelFactory = (engine, canvas, config, callbacks): ILevel =&gt; {
   return new FinalEscapeLevel(engine, canvas, config, callbacks);
 };</code></li>
</ul>
</li>
<li>
<p><strong><code>src/components/GameCanvas.tsx</code></strong> (critical - rendering/level lifecycle)</p>
<ul>
<li>Replaced <code>import { AnchorStationLevel }</code> with <code>import { defaultLevelFactories }</code></li>
<li>Added <code>onLevelComplete?: () =&gt; void</code> to <code>GameCanvasProps</code></li>
<li>Replaced hardcoded <code>new AnchorStationLevel()</code> with factory-based creation</li>
<li>Added factory-based level creation for direct-to-playing transitions (lines 681-726)</li>
<li>Added <code>startLevelId</code> and <code>onLevelComplete</code> to dependency array</li>
<li>Still has dual system: <code>tutorialLevelRef</code> (ILevel) + <code>gameManagerRef</code> (GameManager)
 ```typescript
 // Factory-based tutorial level creation
 const levelConfig = CAMPAIGN_LEVELS.anchor_station;
 const factory = defaultLevelFactories[levelConfig.type];
 tutorialLevelRef.current = factory(engine, canvas, levelConfig, levelCallbacks);</li>
</ul>
<p>// Factory-based level creation for non-tutorial levels
 if (levelId &amp;&amp; levelId !== 'anchor_station' &amp;&amp; levelId !== 'landfall') {
   const levelConfig = CAMPAIGN_LEVELS[levelId];
   const factory = defaultLevelFactories[levelConfig.type];
   tutorialLevelRef.current = factory(engine, canvas, levelConfig, levelCallbacks);
 }
 ```</p>
</li>
<li>
<p><strong><code>src/App.tsx</code></strong> (critical - game state machine)</p>
<ul>
<li>Fixed <code>VALID_LEVELS</code> to include all 10 campaign levels</li>
<li>Added switch cases for canyon_run, southern_ice, hive_assault, final_escape</li>
<li>Renamed <code>_handleLevelComplete</code> to <code>handleLevelComplete</code> (removed unused prefix)</li>
<li>Passed <code>onLevelComplete={handleLevelComplete}</code> to GameCanvas
 <code>typescript
 const VALID_LEVELS: LevelId[] = [
   'anchor_station', 'landfall', 'canyon_run', 'fob_delta', 'brothers_in_arms',
   'southern_ice', 'the_breach', 'hive_assault', 'extraction', 'final_escape',
 ];</code></li>
</ul>
</li>
<li>
<p><strong><code>src/game/levels/southern-ice/index.ts</code></strong> - Fixed from empty <code>export {}</code> to proper export
     <code>typescript
     export { SouthernIceLevel } from './SouthernIceLevel';</code></p>
</li>
<li>
<p><strong><code>src/game/levels/hive-assault/index.ts</code></strong> - Created new file
     <code>typescript
     export { HiveAssaultLevel } from './HiveAssaultLevel';</code></p>
</li>
<li>
<p><strong><code>src/game/levels/final-escape/index.ts</code></strong> - Created new file
     <code>typescript
     export { FinalEscapeLevel } from './FinalEscapeLevel';</code></p>
</li>
<li>
<p><strong><code>src/game/levels/types.ts</code></strong> - Read for campaign structure. 478 lines defining LevelType, LevelId, LevelCallbacks, LevelConfig, ILevel, LevelFactory, CAMPAIGN_LEVELS (10 levels with linked list navigation), utility functions.</p>
</li>
<li>
<p><strong><code>src/game/levels/LevelManager.ts</code></strong> - Read fully. EXISTS but UNUSED. Has <code>startLevel()</code>, <code>transitionTo()</code>, <code>transitionToNext()</code>, <code>dispose()</code>. Line 203 uses <code>require()</code> which needs fixing to proper import.</p>
</li>
<li>
<p><strong><code>src/game/levels/useLevelManager.ts</code></strong> - Read fully. React hook wrapping LevelManager. Also UNUSED.</p>
</li>
<li>
<p><strong><code>src/game/core/GameManager.ts</code></strong> - Read first 160 lines. NOT ILevel-compatible. Creates Player, ChunkManager, CombatSystem, AISystem on shared scene. User says DON'T remove.</p>
</li>
<li>
<p><strong><code>src/game/persistence/GameSave.ts</code></strong> - Full read. Defines <code>GameSave</code> interface with <code>objectives: Record&lt;string, boolean&gt;</code> (never populated), <code>levelsCompleted: LevelId[]</code>, <code>levelFlags</code>. <code>createNewSave()</code> initializes all 10 levels in <code>levelFlags</code>.</p>
</li>
<li>
<p><strong><code>src/game/persistence/SaveSystem.ts</code></strong> - Read first 100 lines. Single save slot, IndexedDB persistence, auto-save on level completion.</p>
</li>
<li>
<p><strong><code>src/components/ui/MissionBriefing.tsx</code></strong> - Read first 120 lines. Generates briefing from <code>MISSION_BRIEFINGS</code> lore + enemy intel + threat levels per level.</p>
</li>
<li>
<p><strong><code>src/game/levels/index.ts</code></strong> - Barrel exports for level system.</p>
</li>
<li>
<p><strong><code>biome.json</code></strong> - Verified intact: CSS modules enabled, 14 rules downgraded to warnings (a11y, suspicious, correctness).</p>
</li>
<li>
<p><strong><code>incoming-ui/BUTTONS.md</code></strong> - Military 9-slice buttons spec: RGBA PNG, 512×192, insets L/R 96px T/B 64px</p>
</li>
<li>
<p><strong><code>incoming-ui/buttons.json</code></strong> - 4 button states (normal/hover/pressed/disabled) with CSS border-image config:
     <code>json
     {"borderImageSlice": "64 96 64 96 fill", "borderImageWidth": "32px", "borderImageRepeat": "stretch"}</code></p>
</li>
<li>
<p><strong><code>incoming-ui/</code></strong> directory contents: splash-16-9.mp4 (12MB), splash-9-16.mp4 (12MB), assets/ subdirectory, BUTTONS.md, buttons.json</p>
</li>
<li>
<p><strong>CI/CD files verified intact</strong>: <code>.github/workflows/ci.yml</code> (LFS checkout, pnpm, lint/test/build), <code>.github/workflows/cd.yml</code> (Netlify deploy), <code>netlify.toml</code> (SPA routing, cache headers), <code>vite/plugin.ts</code> (default fallback for VITE_APP_TITLE)</p>
</li>
<li>
<p>Errors and Fixes:</p>
</li>
<li><strong>3 broken factory stubs</strong>: factories.ts threw "not yet implemented" errors for SouthernIceLevel, HiveAssaultLevel, FinalEscapeLevel. Fixed by importing the classes and instantiating them.</li>
<li><strong>Empty barrel export</strong>: southern-ice/index.ts exported <code>{}</code>. Fixed to export <code>SouthernIceLevel</code>.</li>
<li><strong>Missing index files</strong>: hive-assault/ and final-escape/ had no index.ts. Created both.</li>
<li><strong>Incomplete VALID_LEVELS</strong>: Only 6 of 10 levels listed. Added canyon_run, southern_ice, hive_assault, final_escape.</li>
<li><strong>Missing switch cases</strong>: handleLoadComplete didn't handle new level IDs. Added cases for all new levels.</li>
<li><strong>Unused level completion callback</strong>: <code>_handleLevelComplete</code> had underscore prefix indicating unused. Renamed and wired to GameCanvas.</li>
<li><strong>Hardcoded AnchorStationLevel</strong>: GameCanvas imported and directly instantiated AnchorStationLevel. Replaced with factory-based creation via <code>defaultLevelFactories</code>.</li>
<li>
<p><strong>User rejected initial plan</strong>: Plan proposed removing dead code (mining depths, vehicles, ReyesDialogue, canyon type). User said DON'T remove - WIRE EVERYTHING IN. Plan needs complete revision.</p>
</li>
<li>
<p>Problem Solving:</p>
</li>
<li><strong>Factory system wiring</strong>: All 10 campaign levels now properly connected through <code>defaultLevelFactories</code>. Campaign chapters 6, 8, 10 no longer crash.</li>
<li><strong>Level completion flow</strong>: <code>handleLevelComplete</code> wired from App.tsx through GameCanvas to ILevel callbacks, enabling stats screen and progression.</li>
<li><strong>Factory-based level loading</strong>: GameCanvas now creates levels dynamically via factory lookup instead of hardcoded imports. Supports URL param <code>?level=&lt;id&gt;</code> for any of the 10 levels.</li>
<li><strong>PR #3 created and pushed</strong>: https://github.com/arcade-cabinet/stellar-descent/pull/3</li>
<li>
<p><strong>Architecture redesign in progress</strong>: CampaignDirector design started but plan was rejected for scope expansion.</p>
</li>
<li>
<p>All User Messages:</p>
</li>
<li>"Please continue the conversation from where we left it off without asking the user any further questions. Continue with the last task that you were asked to work on."</li>
<li>"What if the main quest chain WAS what actually wired all the levels together? How do most games like this do it? Does that FEEL clean? What feels clean? I'm thinking what if we setup the main quest chain genuinely AS the spine of the game and it was what coordinated everything, when to unlock what, etc.... Also do not leave ANY errors or warnings unresolved, like for example WHY aren't we properly fixing the canyon level. NOTHING should be generic, all levels should be meticulously you-crafted, scenes painted carefully to set mood and atmosphere"</li>
<li>
<p>(Plan rejection) "IT makes no sense not to break things. It makes MORE sense to include refactoring the tests properly. Also make sure that documentation updates are included AND make sure you're not removing content for no reason. It's a ten level campaign, make sure that we are actually USING everything designed like the canyon / unwired mining level, REVIEW the docs and existing overall vision documents before making decisions on what to remove or what to EXPAND. Also make SURE every level is using MODELS to set its scene, has appropriate audio, make SURE that the LANDING of the game has its pacing reviewed for that mission briefing, and also I want you to review incoming-ui, I've put two splash MP4s in there, one is 9:16, one is 16:9, and then I put a BUTTONS.md and JSON for 9 slice UI buttons we can use for the main menu. Here's my thought, we setup a PROPER Capacitor splash screen for web/mobile etc with the videos depending on portrait/landscape responsively scaled, and then we move the introductory briefing UX and first of all CONDENSE it, it takes way too long to type out, but it gets triggered ONCE after New Game and then saved in state, that they seen it, so they don't get it again, and then it should START in a barracks room in the space base by models for barracks beds, etc.... Look through the PSX models, we should have tons of stuff we can use, but let me know of any gaps in assets. We want to STOP procedurally generating walls, etc.... Our goal for the space base is everything snapped together with those GLB base models, all the planet side stuff babylonjs dynamic terrain with ambientCG, and proper skyscapes. Underground we have plenty of alien tech models and stuff etc.... Let's REALLY dive into the ATMOSPHERE of every level"</p>
</li>
<li>
<p>Pending Tasks:</p>
</li>
<li><strong>Revise plan file</strong> at <code>/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</code> based on user's rejection feedback (currently in plan mode)</li>
<li><strong>CampaignDirector architecture</strong> - Create as game spine, coordinating all levels, saves, achievements, objectives</li>
<li><strong>Wire mining depths</strong> into campaign (currently orphaned 72KB level)</li>
<li><strong>Wire canyon LevelType</strong> properly (currently throws error)</li>
<li><strong>Wire vehicles</strong> (PhantomDropship, WraithTank) into appropriate levels</li>
<li><strong>Wire ReyesDialogue</strong> into appropriate levels</li>
<li><strong>Splash screen</strong> with incoming-ui videos (responsive portrait/landscape)</li>
<li><strong>9-slice military buttons</strong> for main menu using buttons.json config</li>
<li><strong>Condense intro briefing</strong> - faster, triggered once, saved in state</li>
<li><strong>Barracks starting room</strong> with GLB models for beds/furniture</li>
<li><strong>Replace procedural geometry</strong> with GLB models for space base</li>
<li><strong>Dynamic terrain</strong> with ambientCG textures for planet-side levels</li>
<li><strong>Proper skyscapes</strong> for outdoor levels</li>
<li><strong>Underground levels</strong> use alien tech models</li>
<li><strong>Review and report asset gaps</strong> in PSX model inventory</li>
<li><strong>Wire achievements</strong> (7+ disconnected trigger methods)</li>
<li><strong>Wire collectibles</strong> (skulls, audio logs - never instantiated)</li>
<li><strong>Populate GameSave.objectives</strong> (currently always empty)</li>
<li><strong>Refactor tests</strong> as needed (user said breaking is OK)</li>
<li><strong>Documentation updates</strong> throughout</li>
<li><strong>GameCanvas unification</strong> - remove dual rendering system (tutorialLevelRef + gameManagerRef)</li>
<li>
<p><strong>Atmosphere deep-dive</strong> for every level</p>
</li>
<li>
<p>Current Work:
   I am in <strong>plan mode</strong> (active). The plan file at <code>/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</code> was written with an initial CampaignDirector architecture, but the user rejected it via the ExitPlanMode rejection mechanism with extensive feedback about expanding scope rather than removing content. I had just launched an Explore agent (aad46fd) to inventory all assets, read the incoming-ui directory (splash videos, 9-slice buttons), catalog all 47 GLB models, review docs/DESIGN.md, docs/LEVELS.md, docs/PSX-ASSETS.md, and understand each level's environment.ts. That agent completed and I then read the incoming-ui files directly (BUTTONS.md, buttons.json, directory listing). The plan file needs to be <strong>completely revised</strong> to incorporate:</p>
</li>
<li>Don't remove anything - wire everything in</li>
<li>Splash screen with videos</li>
<li>9-slice buttons for menu</li>
<li>Model-based environments (not procedural)</li>
<li>Mining depths integrated into campaign</li>
<li>Asset gap report</li>
<li>Full atmosphere deep-dive per level</li>
</ol>
<p><strong>Asset inventory findings</strong> (from agent aad46fd):
   - 47 GLB models: 15 station (corridors, doorways, floors), 13 props (barrels, boxes, machinery, lamps, shelves), 7 hive (birther, brain, claw, crystals, stomach, terraformer, undercrystal), 8 enemies, 4 vehicles
   - Anchor Station uses ZERO models (100% procedural)
   - Canyon levels use ZERO models (100% procedural)
   - Only The Breach uses hive structure models
   - Missing: barracks beds/furniture, weapon first-person models, NPC models, skybox textures, terrain patches, rock formation models
   - Available textures: only 6 PSX-style PNGs (concrete, door, machinery, metal barrel, metal, wall)</p>
<ol>
<li>Optional Next Step:
   Revise the plan file at <code>/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</code> to incorporate ALL of the user's rejection feedback. The revised plan must:</li>
<li>Wire mining depths and canyon type INTO the campaign (don't remove)</li>
<li>Wire all disconnected systems (vehicles, ReyesDialogue, achievements, collectibles)</li>
<li>Include splash screen implementation with incoming-ui videos</li>
<li>Include 9-slice button implementation for main menu</li>
<li>Include condensed intro briefing that triggers once</li>
<li>Include model-based level environments replacing procedural geometry</li>
<li>Include asset gap report identifying what models are missing</li>
<li>Include documentation updates</li>
<li>Include test refactoring (breaking OK)</li>
<li>Then call ExitPlanMode for approval</li>
</ol>
<p>The user's exact words: "make sure that we are actually USING everything designed like the canyon / unwired mining level" and "We want to STOP procedurally generating walls, etc.... Our goal for the space base is everything snapped together with those GLB base models" and "Let's REALLY dive into the ATMOSPHERE of every level"</p>
<p>If you need specific details from before compaction (like exact code snippets, error messages, or content you generated), read the full transcript at: /Users/jbogaty/.claude/projects/-Users-jbogaty-src-arcade-cabinet-stellar-descent/db476c62-7724-495b-b561-0f5f591e9e86.jsonl
Please continue the conversation from where we left it off without asking the user any further questions. Continue with the last task that you were asked to work on.</p></div></div></div></details>
<div class="message assistant" id="msg-2026-01-30T18-54-04-978Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-04-978Z" class="timestamp-link"><time datetime="2026-01-30T18:54:04.978Z" data-timestamp="2026-01-30T18:54:04.978Z">2026-01-30T18:54:04.978Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>(no content)</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-09-479Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-09-479Z" class="timestamp-link"><time datetime="2026-01-30T18:54:09.479Z" data-timestamp="2026-01-30T18:54:09.479Z">2026-01-30T18:54:09.479Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>The user wants me to continue from where we left off. Based on the summary, I'm in <strong>plan mode</strong> and need to revise the plan file at <code>/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</code> to incorporate all of the user's rejection feedback. Let me first gather some more context about what exists, then write the revised plan.</p>
<p>Let me first check what's in the current state of things - the docs, the model inventory, and the existing levels to properly revise the plan. I need to understand:</p>
<ol>
<li>The mining-depths level that needs to be wired in</li>
<li>The full campaign structure </li>
<li>
<p>The existing docs/DESIGN.md and docs/LEVELS.md</p>
</li>
<li>
<p>The current model inventory more precisely</p>
</li>
</ol>
<p>I'll read through the key files to get the full picture before revising the plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-09-646Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-09-646Z" class="timestamp-link"><time datetime="2026-01-30T18:54:09.646Z" data-timestamp="2026-01-30T18:54:09.646Z">2026-01-30T18:54:09.646Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>I'm in plan mode and need to revise the plan based on the user's rejection feedback. Let me gather the remaining context I need to write a comprehensive revised plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-10-360Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-10-360Z" class="timestamp-link"><time datetime="2026-01-30T18:54:10.360Z" data-timestamp="2026-01-30T18:54:10.360Z">2026-01-30T18:54:10.360Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01AaL6hwSpActdBfKtTZHaK2"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LEVELS.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-10-544Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-10-544Z" class="timestamp-link"><time datetime="2026-01-30T18:54:10.544Z" data-timestamp="2026-01-30T18:54:10.544Z">2026-01-30T18:54:10.544Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# STELLAR DESCENT: Level System Architecture
     2→
     3→This document defines the complete level system architecture, mapping the story chapters from LORE.md to playable game levels, and establishing the technical contracts for level implementation.
     4→
     5→---
     6→
     7→## Table of Contents
     8→
     9→1. [Design Philosophy](#design-philosophy)
    10→2. [Campaign Structure](#campaign-structure)
    11→3. [Level Architecture](#level-architecture)
    12→4. [HUD System](#hud-system)
    13→5. [Dynamic Action Buttons](#dynamic-action-buttons)
    14→6. [Quest &amp; Marker System](#quest--marker-system)
    15→7. [Input &amp; Keybindings](#input--keybindings)
    16→8. [Level Implementation Guide](#level-implementation-guide)
    17→9. [Level Specifications](#level-specifications)
    18→
    19→---
    20→
    21→## Design Philosophy
    22→
    23→### Core Principles
    24→
    25→**1. Scene Isolation (Like HALO)**
    26→Each level is a completely self-contained experience:
    27→- Own Babylon.js Scene instance
    28→- Own lighting, skybox, and atmosphere
    29→- Own asset loading and disposal
    30→- Clean transitions between levels
    31→- NO merged scenes or shared geometry
    32→
    33→**2. Linked List Navigation**
    34→Levels form a doubly-linked list, not an array:
    35→```
    36→anchor_station &lt;-&gt; landfall &lt;-&gt; fob_delta &lt;-&gt; brothers_in_arms &lt;-&gt; the_breach &lt;-&gt; extraction
    37→      ↑                                                                              ↓
    38→   (start)                                                                        (end)
    39→```
    40→Each level knows only its `nextLevelId` and `previousLevelId`.
    41→
    42→**3. Universal HUD Overlay**
    43→The HUD is a React component that floats ABOVE all levels:
    44→- Health bar (always visible during gameplay)
    45→- Mission text (context-sensitive)
    46→- Kill counter (when applicable)
    47→- Crosshair (FPS mode only)
    48→- Dynamic action buttons (level-controlled)
    49→- Comms display (narrative delivery)
    50→- Notifications (events/achievements)
    51→
    52→**4. Progressive Unlocking**
    53→Tutorial (Anchor Station) progressively unlocks HUD elements:
    54→- Movement first → health bar appears
    55→- Look around → crosshair appears
    56→- Weapon training → ammo counter appears
    57→- Action tutorial → action buttons explained
    58→- Full HUD unlocked by level end
    59→
    60→---
    61→
    62→## Campaign Structure
    63→
    64→### Mapping Lore Chapters to Levels
    65→
    66→| Lore Chapter | Level ID | Level Type | Environment |
    67→|:-------------|:---------|:-----------|:------------|
    68→| Prologue + Chapter 1 | `anchor_station` | station | Space station interior |
    69→| Chapter 2 (partial) | `landfall` | drop → canyon | HALO drop → planet surface |
    70→| Chapter 3 | `fob_delta` | base | Abandoned military outpost |
    71→| Chapter 4 | `brothers_in_arms` | canyon | Open world, mech combat |
    72→| Chapter 5 | `the_breach` | hive | Underground alien tunnels |
    73→| Chapter 6 + Epilogue | `extraction` | extraction | Surface holdout → victory |
    74→
    75→### Level Flow
    76→
    77→```
    78→┌─────────────────────────────────────────────────────────────────────────────┐
    79→│                           STELLAR DESCENT CAMPAIGN                          │
    80→├─────────────────────────────────────────────────────────────────────────────┤
    81→│                                                                             │
    82→│  ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐   │
    83→│  │  ANCHOR STATION  │────▶│     LANDFALL     │────▶│    FOB DELTA     │   │
    84→│  │    (Tutorial)    │     │   (HALO Drop)    │     │   (Horror/Inv)   │   │
    85→│  │   Chapter 1      │     │    Chapter 2     │     │    Chapter 3     │   │
    86→│  └──────────────────┘     └──────────────────┘     └──────────────────┘   │
    87→│                                                              │              │
    88→│                                                              ▼              │
    89→│  ┌──────────────────┐     ┌──────────────────┐     ┌──────────────────┐   │
    90→│  │    EXTRACTION    │◀────│    THE BREACH    │◀────│ BROTHERS IN ARMS │   │
    91→│  │  (Final Stand)   │     │ (Hive/Boss Fight)│     │  (Mech Combat)   │   │
    92→│  │    Chapter 6     │     │    Chapter 5     │     │    Chapter 4     │   │
    93→│  └──────────────────┘     └──────────────────┘     └──────────────────┘   │
    94→│                                                                             │
    95→└─────────────────────────────────────────────────────────────────────────────┘
    96→```
    97→
    98→---
    99→
   100→## Level Architecture
   101→
   102→### Technical Structure
   103→
   104→```typescript
   105→// Each level implements ILevel interface
   106→interface ILevel {
   107→  readonly id: LevelId;
   108→  readonly type: LevelType;
   109→  readonly config: LevelConfig;
   110→
   111→  // Lifecycle
   112→  initialize(): Promise&lt;void&gt;;
   113→  update(deltaTime: number): void;
   114→  dispose(): void;
   115→
   116→  // Scene access (isolated per level)
   117→  getScene(): Scene;
   118→
   119→  // State management
   120→  getState(): LevelState;
   121→  setState(state: Partial&lt;LevelState&gt;): void;
   122→
   123→  // Input
   124→  lockPointer(): void;
   125→  unlockPointer(): void;
   126→  isPointerLocked(): boolean;
   127→
   128→  // Navigation
   129→  canTransitionTo(levelId: LevelId): boolean;
   130→  prepareTransition(targetLevelId: LevelId): Promise&lt;void&gt;;
   131→}
   132→```
   133→
   134→### Level Types
   135→
   136→| Type | Description | Camera | Combat | Example |
   137→|:-----|:------------|:-------|:-------|:--------|
   138→| `station` | Interior space station | FPS | Limited/Tutorial | Anchor Station |
   139→| `drop` | HALO descent sequence | Special (down→forward) | Dodge/Avoid | Landfall (phase 1) |
   140→| `canyon` | Exterior planet surface | FPS | Full | Landfall (phase 2), Brothers |
   141→| `base` | Abandoned outpost interior | FPS | Ambush | FOB Delta |
   142→| `hive` | Underground alien tunnels | FPS | Heavy | The Breach |
   143→| `extraction` | Holdout/escape | FPS | Wave-based | Extraction |
   144→
   145→### Scene Isolation Rules
   146→
   147→1. **Each level creates its own `new Scene(engine)`**
   148→2. **Levels dispose their scene on cleanup**
   149→3. **No global meshes shared between levels**
   150→4. **Assets loaded per-level (with caching at engine level)**
   151→5. **Skybox/environment completely level-specific**
   152→6. **Lighting designed for each level&#x27;s atmosphere**
   153→
   154→---
   155→
   156→## HUD System
   157→
   158→### HUD Component Hierarchy
   159→
   160→```
   161→┌─────────────────────────────────────────────────────────────┐
   162→│                         HUD OVERLAY                         │
   163→│                    (React, always on top)                   │
   164→├─────────────────────────────────────────────────────────────┤
   165→│                                                             │
   166→│  ┌─────────────────┐              ┌──────────────────────┐ │
   167→│  │   Health Bar    │              │    Mission Text      │ │
   168→│  │  (bottom-left)  │              │    (top-center)      │ │
   169→│  └─────────────────┘              └──────────────────────┘ │
   170→│                                                             │
   171→│                     ┌────────────┐       ┌──────────────┐  │
   172→│                     │  Crosshair │       │ Kill Counter │  │
   173→│                     │  (center)  │       │ (top-right)  │  │
   174→│                     └────────────┘       └──────────────┘  │
   175→│                                                             │
   176→│  ┌─────────────────┐              ┌──────────────────────┐ │
   177→│  │ Action Buttons  │              │   Action Buttons     │ │
   178→│  │ (left panel)    │              │   (right panel)      │ │
   179→│  └─────────────────┘              └──────────────────────┘ │
   180→│                                                             │
   181→│              ┌─────────────────────────────┐               │
   182→│              │     Action Buttons          │               │
   183→│              │     (bottom panel)          │               │
   184→│              └─────────────────────────────┘               │
   185→│                                                             │
   186→│  ┌──────────────────────────────────────────────────────┐  │
   187→│  │                   Comms Display                       │  │
   188→│  │                 (bottom, modal)                       │  │
   189→│  └──────────────────────────────────────────────────────┘  │
   190→│                                                             │
   191→│  ┌──────────────────────────────────────────────────────┐  │
   192→│  │                   Notifications                       │  │
   193→│  │                  (center, toast)                      │  │
   194→│  └──────────────────────────────────────────────────────┘  │
   195→│                                                             │
   196→└─────────────────────────────────────────────────────────────┘
   197→```
   198→
   199→### HUD Visibility States
   200→
   201→```typescript
   202→interface HUDVisibility {
   203→  healthBar: boolean;      // Unlocked: movement tutorial
   204→  crosshair: boolean;      // Unlocked: look tutorial
   205→  killCounter: boolean;    // Unlocked: first kill
   206→  missionText: boolean;    // Unlocked: first objective
   207→  actionButtons: boolean;  // Unlocked: action tutorial
   208→  commsDisplay: boolean;   // Always available (narrative)
   209→  notifications: boolean;  // Always available
   210→}
   211→```
   212→
   213→### Tutorial Unlock Sequence
   214→
   215→1. **Start**: Only notifications visible
   216→2. **Movement Tutorial**: Health bar fades in
   217→3. **Look Tutorial**: Crosshair appears
   218→4. **Weapon Tutorial**: Ammo counter (future)
   219→5. **Action Tutorial**: Action buttons explained
   220→6. **Shooting Range**: Kill counter appears
   221→7. **Mission Start**: Full HUD unlocked
   222→
   223→---
   224→
   225→## Dynamic Action Buttons
   226→
   227→### Architecture
   228→
   229→Levels control which action buttons appear via callbacks:
   230→
   231→```typescript
   232→// Level calls this to update HUD action buttons
   233→callbacks.onActionGroupsChange(groups: ActionButtonGroup[]);
   234→
   235→// Level registers handler for button presses
   236→callbacks.onActionHandlerRegister(handler: (actionId: string) =&gt; void);
   237→```
   238→
   239→### ActionButtonGroup Structure
   240→
   241→```typescript
   242→interface ActionButtonGroup {
   243→  id: string;
   244→  label?: string;                    // Group header (optional)
   245→  position: &#x27;left&#x27; | &#x27;right&#x27; | &#x27;bottom&#x27;;
   246→  buttons: ActionButton[];
   247→}
   248→
   249→interface ActionButton {
   250→  id: string;                        // Unique action identifier
   251→  label: string;                     // Display text
   252→  key: string;                       // Keyboard binding (e.g., &#x27;Space&#x27;, &#x27;KeyE&#x27;)
   253→  keyDisplay: string;                // What to show user (e.g., &#x27;SPACE&#x27;, &#x27;E&#x27;)
   254→  enabled: boolean;                  // Can be triggered?
   255→  visible: boolean;                  // Is it shown?
   256→  highlighted?: boolean;             // Pulsing attention effect
   257→  cooldown?: number;                 // Total cooldown time (ms)
   258→  cooldownRemaining?: number;        // Current remaining (ms)
   259→  progress?: number;                 // 0-1 for progress bar
   260→  progressColor?: string;            // Color of progress bar
   261→  variant?: &#x27;primary&#x27; | &#x27;secondary&#x27; | &#x27;danger&#x27; | &#x27;warning&#x27;;
   262→  size?: &#x27;small&#x27; | &#x27;medium&#x27; | &#x27;large&#x27;;
   263→  icon?: string;                     // Emoji or icon character
   264→}
   265→```
   266→
   267→### Level-Specific Action Sets
   268→
   269→#### Anchor Station (Tutorial)
   270→```typescript
   271→// Phase 1: Movement only - no buttons
   272→[]
   273→
   274→// Phase 2: Suit equip
   275→[{
   276→  id: &#x27;suit&#x27;,
   277→  position: &#x27;right&#x27;,
   278→  buttons: [
   279→    { id: &#x27;equip_suit&#x27;, label: &#x27;EQUIP SUIT&#x27;, key: &#x27;KeyE&#x27;, highlighted: true }
   280→  ]
   281→}]
   282→
   283→// Phase 3: Shooting range
   284→[{
   285→  id: &#x27;weapons&#x27;,
   286→  position: &#x27;right&#x27;,
   287→  buttons: [
   288→    { id: &#x27;fire&#x27;, label: &#x27;FIRE&#x27;, key: &#x27;Mouse0&#x27; },
   289→    { id: &#x27;reload&#x27;, label: &#x27;RELOAD&#x27;, key: &#x27;KeyR&#x27; }
   290→  ]
   291→}]
   292→
   293→// Phase 4: Ready for drop
   294→[{
   295→  id: &#x27;mission&#x27;,
   296→  position: &#x27;bottom&#x27;,
   297→  buttons: [
   298→    { id: &#x27;begin_drop&#x27;, label: &#x27;BEGIN ORBITAL DROP&#x27;, key: &#x27;Space&#x27;, variant: &#x27;danger&#x27;, size: &#x27;large&#x27; }
   299→  ]
   300→}]
   301→```
   302→
   303→#### Landfall (HALO Drop)
   304→```typescript
   305→// Phase 1: Freefall - no buttons (WASD dodge)
   306→[]
   307→
   308→// Phase 2: Post-debris, awaiting jets
   309→[{
   310→  id: &#x27;jets&#x27;,
   311→  position: &#x27;right&#x27;,
   312→  buttons: [
   313→    { id: &#x27;ignite_jets&#x27;, label: &#x27;IGNITE JETS&#x27;, key: &#x27;Space&#x27;, variant: &#x27;danger&#x27;, highlighted: true }
   314→  ]
   315→}]
   316→
   317→// Phase 3: Powered descent
   318→[{
   319→  id: &#x27;thrusters&#x27;,
   320→  position: &#x27;right&#x27;,
   321→  buttons: [
   322→    { id: &#x27;boost&#x27;, label: &#x27;BOOST&#x27;, key: &#x27;Space&#x27;, variant: &#x27;primary&#x27; },
   323→    { id: &#x27;stabilize&#x27;, label: &#x27;STABILIZE&#x27;, key: &#x27;KeyQ&#x27;, variant: &#x27;secondary&#x27; },
   324→    { id: &#x27;brake&#x27;, label: &#x27;BRAKE&#x27;, key: &#x27;KeyE&#x27;, variant: &#x27;warning&#x27; }
   325→  ]
   326→}]
   327→
   328→// Phase 4: Surface combat
   329→[{
   330→  id: &#x27;combat&#x27;,
   331→  position: &#x27;right&#x27;,
   332→  buttons: [
   333→    { id: &#x27;grenade&#x27;, label: &#x27;GRENADE&#x27;, key: &#x27;KeyG&#x27;, cooldown: 5000 },
   334→    { id: &#x27;melee&#x27;, label: &#x27;MELEE&#x27;, key: &#x27;KeyV&#x27; }
   335→  ]
   336→}]
   337→```
   338→
   339→---
   340→
   341→## Quest &amp; Marker System
   342→
   343→### Marker Types
   344→
   345→| Marker | Icon | Color | Usage |
   346→|:-------|:-----|:------|:------|
   347→| Main Objective | `!` | Gold | Primary mission goals |
   348→| Optional | `?` | Blue | Side objectives |
   349→| Interact | `[E]` | White | Interactable objects |
   350→| Enemy | `▲` | Red | Hostile targets (optional) |
   351→| Ally | `♦` | Green | Friendly NPCs |
   352→| Waypoint | `◆` | Yellow | Navigation points |
   353→
   354→### Marker Implementation
   355→
   356→```typescript
   357→interface QuestMarker {
   358→  id: string;
   359→  type: &#x27;main&#x27; | &#x27;optional&#x27; | &#x27;interact&#x27; | &#x27;enemy&#x27; | &#x27;ally&#x27; | &#x27;waypoint&#x27;;
   360→  position: Vector3;
   361→  visible: boolean;
   362→  distanceVisible: number;    // Max distance to show (meters)
   363→  showDistance: boolean;      // Show &quot;42m&quot; below marker
   364→  pulseEffect: boolean;       // Attention-grabbing pulse
   365→  label?: string;             // Optional text label
   366→  attachedTo?: Entity;        // Follow an entity
   367→}
   368→```
   369→
   370→### Visibility Rules
   371→
   372→1. **Distance Culling**: Markers fade at `distanceVisible`
   373→2. **Occlusion**: Markers show through walls (gameplay clarity &gt; realism)
   374→3. **Screen Edge**: Off-screen markers show as edge indicators
   375→4. **Priority**: Main &gt; Optional &gt; Interact for overlapping markers
   376→
   377→---
   378→
   379→## Input &amp; Keybindings
   380→
   381→### Default Keyboard Bindings
   382→
   383→| Action | Primary | Secondary | Description |
   384→|:-------|:--------|:----------|:------------|
   385→| Move Forward | W | ↑ | Move forward |
   386→| Move Back | S | ↓ | Move backward |
   387→| Strafe Left | A | ← | Move left |
   388→| Strafe Right | D | → | Move right |
   389→| Look | Mouse | - | Aim/look around |
   390→| Fire | Left Click | - | Primary weapon fire |
   391→| Aim/Zoom | Right Click | - | Aim down sights |
   392→| Reload | R | - | Reload weapon |
   393→| Interact | E | - | Use/interact |
   394→| Jump | Space | - | Jump |
   395→| Crouch | Ctrl | C | Crouch/duck |
   396→| Sprint | Shift | - | Run faster |
   397→| Grenade | G | - | Throw grenade |
   398→| Melee | V | - | Melee attack |
   399→| Menu/Pause | Escape | - | Pause game |
   400→
   401→### Keybinding System
   402→
   403→```typescript
   404→interface KeybindingConfig {
   405→  action: string;
   406→  primary: string;      // Key code (e.g., &#x27;KeyW&#x27;, &#x27;ArrowUp&#x27;)
   407→  secondary?: string;   // Alternative binding
   408→  category: &#x27;movement&#x27; | &#x27;combat&#x27; | &#x27;interaction&#x27; | &#x27;ui&#x27;;
   409→}
   410→
   411→// Settings stored in localStorage
   412→interface UserSettings {
   413→  keybindings: KeybindingConfig[];
   414→  mouseSensitivity: number;
   415→  invertY: boolean;
   416→  // ...
   417→}
   418→```
   419→
   420→### Settings Menu Requirements
   421→
   422→**Desktop/Laptop Only** (keyboard detected):
   423→- Full keybinding customization
   424→- Mouse sensitivity slider
   425→- Invert Y-axis toggle
   426→- Key conflict detection
   427→
   428→**Touch-Only Devices**:
   429→- NO keybinding section (irrelevant)
   430→- Touch sensitivity settings
   431→- Control layout options
   432→
   433→**Detection Logic**:
   434→```typescript
   435→const hasKeyboard = () =&gt; {
   436→  // Check for physical keyboard
   437→  return !(&#x27;ontouchstart&#x27; in window) ||
   438→         window.matchMedia(&#x27;(pointer: fine)&#x27;).matches;
   439→};
   440→```
   441→
   442→---
   443→
   444→## Level Implementation Guide
   445→
   446→### Creating a New Level
   447→
   448→1. **Create level directory**: `src/game/levels/{level-name}/`
   449→
   450→2. **Extend BaseLevel**:
   451→```typescript
   452→export class MyLevel extends BaseLevel {
   453→  protected getBackgroundColor(): Color4 {
   454→    return new Color4(/* level-specific color */);
   455→  }
   456→
   457→  protected async createEnvironment(): Promise&lt;void&gt; {
   458→    // Create all meshes, lights, etc.
   459→  }
   460→
   461→  protected updateLevel(deltaTime: number): void {
   462→    // Update game logic each frame
   463→  }
   464→
   465→  protected disposeLevel(): void {
   466→    // Clean up level-specific resources
   467→  }
   468→}
   469→```
   470→
   471→3. **Register factory** in `factories.ts`
   472→
   473→4. **Add to CAMPAIGN_LEVELS** in `types.ts`
   474→
   475→### Level Checklist
   476→
   477→- [ ] Extends BaseLevel properly
   478→- [ ] Own Scene created (via super())
   479→- [ ] Level-specific lighting setup
   480→- [ ] Skybox/background appropriate
   481→- [ ] Action buttons configured per phase
   482→- [ ] Quest markers for objectives
   483→- [ ] Comms messages for narrative
   484→- [ ] State saved on exit
   485→- [ ] Clean dispose() implementation
   486→- [ ] Transition conditions defined
   487→
   488→---
   489→
   490→## Level Specifications
   491→
   492→### Level 1: Anchor Station (`anchor_station`)
   493→
   494→**Lore Reference**: Prologue + Chapter 1
   495→**Type**: `station`
   496→**Duration**: 5-10 minutes
   497→
   498→**Setting**:
   499→- Interior of ANCHOR STATION PROMETHEUS
   500→- Clean, industrial military aesthetic
   501→- Artificial gravity, artificial lighting
   502→- Large windows showing planet below
   503→
   504→**Rooms/Areas**:
   505→1. **Briefing Room** - Starting point, Commander Vasquez hologram
   506→2. **Corridor A** - Main walkway with crew activity
   507→3. **Equipment Bay** - Suit locker, weapon rack
   508→4. **Shooting Range** - Target practice area
   509→5. **Hangar Bay** - Drop pods visible, final destination
   510→
   511→**Key Objectives**:
   512→1. Attend briefing (story delivery)
   513→2. Navigate to Equipment Bay (movement tutorial)
   514→3. Equip ODST suit (interaction tutorial)
   515→4. Complete weapon familiarization (combat tutorial)
   516→5. Proceed to Hangar Bay (navigation)
   517→6. Board drop pod (level complete)
   518→
   519→**Progressive Unlocks**:
   520→- Phase 1: Movement only (WASD/arrows)
   521→- Phase 2: Look controls (mouse/touch)
   522→- Phase 3: Interaction (E key)
   523→- Phase 4: Combat basics (shooting range)
   524→- Phase 5: Full HUD, ready for drop
   525→
   526→**Assets Required**:
   527→- Station interior geometry (modular corridors, rooms)
   528→- PSX-style textures (metal panels, grating, displays)
   529→- NPCs (static or minimal animation)
   530→- Weapon models (M7 rifle)
   531→- Suit model on rack
   532→- Drop pod interior/exterior
   533→
   534→---
   535→
   536→### Level 2: Landfall (`landfall`)
   537→
   538→**Lore Reference**: Chapter 2
   539→**Type**: `drop` → `canyon`
   540→**Duration**: 8-12 minutes
   541→
   542→**Setting**:
   543→- Phase 1: Space, looking down at planet
   544→- Phase 2: Asteroid/debris field (upper atmosphere)
   545→- Phase 3: Powered descent through atmosphere
   546→- Phase 4: Canyon surface, first combat
   547→
   548→**Phases**:
   549→
   550→#### Phase 1: Freefall Start (0-30 seconds)
   551→- Camera: Looking DOWN at planet
   552→- Arms extended (skydiver pose)
   553→- Planet growing larger below
   554→- Visor HUD elements visible
   555→- No action buttons yet
   556→
   557→#### Phase 2: Debris Belt (30-90 seconds)
   558→- Asteroids rushing UP past player
   559→- WASD to dodge (body position)
   560→- Impacts damage suit integrity
   561→- Tension building
   562→
   563→#### Phase 3: Powered Descent (90-150 seconds)
   564→- &quot;IGNITE JETS&quot; action button
   565→- Camera transitions to forward view
   566→- Fuel/velocity/position management
   567→- LZ beacon visible
   568→- Multiple landing outcomes
   569→
   570→#### Phase 4: Surface (remaining)
   571→- Canyon environment
   572→- First Chitin encounters
   573→- Combat tutorial in action
   574→- Navigate toward FOB Delta marker
   575→
   576→**Landing Outcomes**:
   577→| Outcome | Condition | Result |
   578→|:--------|:----------|:-------|
   579→| Perfect | On pad, low velocity | Clean start, bonus |
   580→| Near Miss | Close to pad | Fight to LZ |
   581→| Rough | Far from pad, moderate velocity | Damage, heavy combat |
   582→| Crash | High velocity | Major damage, near death |
   583→| Slingshot | Too far off course | Death, restart |
   584→
   585→**Assets Required**:
   586→- Planet sphere (growing during descent)
   587→- Asteroid meshes (varied sizes)
   588→- Arm/glove models (skydiver pose)
   589→- Thruster handle models
   590→- Canyon terrain
   591→- LZ pad geometry
   592→- Chitin enemy models (Drones, Grunts)
   593→
   594→---
   595→
   596→### Level 3: FOB Delta (`fob_delta`)
   597→
   598→**Lore Reference**: Chapter 3
   599→**Type**: `base`
   600→**Duration**: 10-15 minutes
   601→
   602→**Setting**:
   603→- Abandoned military outpost
   604→- Power flickering/offline
   605→- Signs of battle (blood, damage, debris)
   606→- Dark, claustrophobic
   607→- Horror atmosphere
   608→
   609→**Areas**:
   610→1. **Perimeter** - Breached barriers, entry point
   611→2. **Courtyard** - Central open area, overturned vehicles
   612→3. **Barracks** - Bunks, personal effects, bodies
   613→4. **Command Center** - Terminals, mission logs
   614→5. **Vehicle Bay** - Marcus&#x27;s mech signature detected
   615→6. **Underground Access** - Exit to The Breach
   616→
   617→**Key Objectives**:
   618→1. Breach perimeter
   619→2. Secure courtyard
   620→3. Access command logs (discover what happened)
   621→4. Locate Marcus&#x27;s signal
   622→5. Survive ambush (first indoor combat)
   623→6. Find underground tunnel entrance
   624→
   625→**Atmosphere Elements**:
   626→- Flickering lights
   627→- Environmental storytelling
   628→- Jump scares (carefully placed)
   629→- Motion tracker mechanic introduction
   630→- Increasing dread
   631→
   632→**Assets Required**:
   633→- Modular base structures
   634→- Military prefab buildings
   635→- Computer terminals
   636→- Mech (Marcus&#x27;s Titan visible)
   637→- Barricades, debris
   638→- Blood effects, damage decals
   639→- Chitin corpses (battle aftermath)
   640→
   641→---
   642→
   643→### Level 4: Brothers in Arms (`brothers_in_arms`)
   644→
   645→**Lore Reference**: Chapter 4
   646→**Type**: `canyon`
   647→**Duration**: 12-18 minutes
   648→
   649→**Setting**:
   650→- Open canyon environment
   651→- Large combat arena
   652→- Marcus&#x27;s mech active (AI ally)
   653→- Waves of Chitin
   654→
   655→**Key Moments**:
   656→1. Reunion with Marcus (emotional beat)
   657→2. Fight together (mech provides support fire)
   658→3. Search for hive entrance
   659→4. Major battle at The Breach entrance
   660→
   661→**Marcus AI**:
   662→- Provides covering fire
   663→- Calls out threats
   664→- Story dialogue during combat lulls
   665→- Cannot enter tunnels (mech too large)
   666→
   667→**Unique Mechanics**:
   668→- Mech ally (large-scale support)
   669→- Wave-based combat
   670→- Environmental hazards
   671→- The Breach revealed
   672→
   673→**Assets Required**:
   674→- Expanded canyon terrain
   675→- The Breach (massive sinkhole)
   676→- Titan mech (animated, firing)
   677→- Large enemy counts
   678→- Bioluminescent growths (near Breach)
   679→
   680→---
   681→
   682→### Level 5: The Breach (`the_breach`)
   683→
   684→**Lore Reference**: Chapter 5
   685→**Type**: `hive`
   686→**Duration**: 15-20 minutes
   687→
   688→**Setting**:
   689→- Underground alien tunnels
   690→- Organic architecture
   691→- Bioluminescent lighting
   692→- **Procedurally generated maze** (seeded for consistency)
   693→- Boss arena at bottom
   694→
   695→#### Procedural Maze Generation
   696→
   697→The Breach uses `seedrandom` to generate a consistent maze from the level seed:
   698→
   699→```typescript
   700→// Maze generation algorithm (recursive backtracking)
   701→interface MazeCell {
   702→  x: number;
   703→  z: number;
   704→  walls: { north: boolean; south: boolean; east: boolean; west: boolean };
   705→  visited: boolean;
   706→  type: &#x27;path&#x27; | &#x27;boulder&#x27; | &#x27;acid&#x27; | &#x27;egg_cluster&#x27; | &#x27;chamber&#x27;;
   707→}
   708→
   709→// Generate maze from seed (same seed = same maze)
   710→function generateHiveMaze(seed: string, width: number, height: number): MazeCell[][] {
   711→  const rng = seedrandom(seed);
   712→  const maze: MazeCell[][] = createGrid(width, height);
   713→
   714→  // Recursive backtracking for base maze
   715→  carve(maze, 0, 0, rng);
   716→
   717→  // Add special cells
   718→  placeBoulders(maze, rng, 0.15);      // 15% chance of boulder obstacles
   719→  placeAcidPools(maze, rng, 0.08);     // 8% chance of acid hazard
   720→  placeEggClusters(maze, rng, 0.10);   // 10% chance of egg clusters
   721→  placeChambers(maze, rng, 3);         // 3 larger chamber rooms
   722→
   723→  return maze;
   724→}
   725→```
   726→
   727→#### 3D Mesh Generation
   728→
   729→Maze cells convert to 3D geometry using merged cubes for performance:
   730→
   731→```typescript
   732→// Convert 2D maze to 3D meshes (like QR code tutorial)
   733→function buildMazeMeshes(scene: Scene, maze: MazeCell[][], cellSize: number): Mesh {
   734→  const wallMeshes: Mesh[] = [];
   735→
   736→  for (const row of maze) {
   737→    for (const cell of row) {
   738→      // Create wall cubes for each active wall
   739→      if (cell.walls.north) {
   740→        wallMeshes.push(createOrganicWall(scene, cell.x, cell.z, &#x27;north&#x27;, cellSize));
   741→      }
   742→      // ... other walls
   743→    }
   744→  }
   745→
   746→  // CRITICAL: Merge all walls for performance (30fps → 60fps)
   747→  return Mesh.MergeMeshes(wallMeshes, true, true, undefined, false, true);
   748→}
   749→```
   750→
   751→#### Drill &amp; Explosives Mechanics
   752→
   753→Some maze sections have **boulder blockages** requiring special tools:
   754→
   755→```typescript
   756→// Obstacle types and solutions
   757→interface Obstacle {
   758→  type: &#x27;boulder&#x27; | &#x27;cave_in&#x27; | &#x27;organic_barrier&#x27;;
   759→  durability: number;      // Health points
   760→  requiredTool: &#x27;drill&#x27; | &#x27;explosives&#x27; | &#x27;acid_grenade&#x27;;
   761→  clearTime?: number;      // Seconds for drill
   762→}
   763→
   764→// Action buttons for obstacle removal
   765→[{
   766→  id: &#x27;tools&#x27;,
   767→  label: &#x27;BREACH TOOLS&#x27;,
   768→  position: &#x27;right&#x27;,
   769→  buttons: [
   770→    { id: &#x27;drill&#x27;, label: &#x27;DRILL&#x27;, key: &#x27;KeyT&#x27;, cooldown: 2000, icon: &#x27;🔧&#x27;,
   771→      progress: drillProgress, progressColor: &#x27;#FFD700&#x27; },
   772→    { id: &#x27;explosives&#x27;, label: &#x27;C4&#x27;, key: &#x27;KeyC&#x27;, cooldown: 10000, icon: &#x27;💥&#x27;,
   773→      variant: &#x27;danger&#x27;, enabled: explosivesCount &gt; 0 }
   774→  ]
   775→}]
   776→```
   777→
   778→**Obstacle Types**:
   779→| Type | Solution | Time/Cost | Effect |
   780→|:-----|:---------|:----------|:-------|
   781→| Boulder | Drill | 3 seconds | Silent, attracts no enemies |
   782→| Cave-in | Explosives | Instant | Loud, alerts enemies in 30m radius |
   783→| Organic Barrier | Acid Grenade | Instant | Medium noise, may spawn drones |
   784→
   785→#### Marcus AI Signaling System
   786→
   787→Marcus stays on the surface with his mech but provides tactical support via radio and signaling:
   788→
   789→```typescript
   790→// Right-side HUD for mech commands
   791→[{
   792→  id: &#x27;mech_commands&#x27;,
   793→  label: &#x27;TITAN LINK&#x27;,
   794→  position: &#x27;right&#x27;,
   795→  buttons: [
   796→    { id: &#x27;signal_recon&#x27;, label: &#x27;RECON&#x27;, key: &#x27;Digit1&#x27;, icon: &#x27;📡&#x27;,
   797→      description: &#x27;Marcus scans for hostiles nearby&#x27; },
   798→    { id: &#x27;signal_distract&#x27;, label: &#x27;DISTRACT&#x27;, key: &#x27;Digit2&#x27;, icon: &#x27;🔊&#x27;,
   799→      cooldown: 30000, description: &#x27;Mech fires to draw enemies&#x27; },
   800→    { id: &#x27;signal_rally&#x27;, label: &#x27;RALLY&#x27;, key: &#x27;Digit3&#x27;, icon: &#x27;🎯&#x27;,
   801→      description: &#x27;Mark waypoint for extraction&#x27; }
   802→  ]
   803→}]
   804→```
   805→
   806→**Signal Mechanics**:
   807→- **RECON**: Marcus&#x27;s sensors ping nearby hostiles (mini-map update)
   808→- **DISTRACT**: Mech fires above ground, enemies run toward sound
   809→- **RALLY**: Marcus marks optimal extraction route
   810→
   811→#### Platforming Puzzles
   812→
   813→The hive includes vertical sections with platforming:
   814→
   815→```typescript
   816→// Platforming obstacle types
   817→type PlatformingObstacle =
   818→  | &#x27;acid_gap&#x27;       // Jump across acid pool
   819→  | &#x27;collapsed_floor&#x27;// Navigate around hole
   820→  | &#x27;organic_bridge&#x27; // Unstable, time-limited crossing
   821→  | &#x27;egg_chamber&#x27;    // Stealth or fight choice
   822→  | &#x27;vertical_shaft&#x27; // Climb/drop with ledges
   823→```
   824→
   825→**Areas**:
   826→1. **Tunnel Entrance** - Transition from surface, first drill tutorial
   827→2. **Upper Hive** - Scout area, drones, platforming introduction
   828→3. **Mid Hive** - Maze section with boulders and cave-ins
   829→4. **Lower Hive** - Vertical descent, egg chambers
   830→5. **Queen&#x27;s Chamber** - Boss arena (hand-crafted, not procedural)
   831→
   832→**Queen Boss Fight**:
   833→- **Health**: 5000 HP
   834→- **Phases**: 3 distinct phases
   835→- **Mechanics**:
   836→  - Phase 1: Ranged attacks, spawns drones
   837→  - Phase 2: Melee attacks, spawns grunts
   838→  - Phase 3: Enraged, all attacks faster
   839→- **Victory**: Triggers hive collapse
   840→
   841→**Environmental Hazards**:
   842→- Acid pools (damage over time)
   843→- Collapsing tunnels (timed escape)
   844→- Egg clusters (spawn drones if disturbed)
   845→- Pheromone clouds (obscure vision, slow movement)
   846→- Bioluminescent spores (mark player for enemies)
   847→
   848→**Assets Required**:
   849→- Organic tunnel meshes (modular for procedural assembly)
   850→- Boulder/cave-in meshes
   851→- Bioluminescent materials
   852→- Queen model (massive, animated)
   853→- Egg cluster models
   854→- All enemy variants
   855→- Drill tool effect (particles, sound)
   856→- Explosion effect for C4
   857→
   858→---
   859→
   860→### Level 6: Extraction (`extraction`)
   861→
   862→**Lore Reference**: Chapter 6 + Epilogue
   863→**Type**: `extraction`
   864→**Duration**: 8-12 minutes
   865→
   866→**Setting**:
   867→- Race back to surface
   868→- Collapsing hive behind
   869→- Surface holdout at LZ Omega
   870→- Dropship arrival (victory)
   871→
   872→**Phases**:
   873→
   874→#### Phase 1: Escape (3-4 minutes)
   875→- Timer pressure
   876→- Collapsing tunnels
   877→- Enemies chasing
   878→- Marcus provides guidance via radio
   879→
   880→#### Phase 2: Surface Run (2-3 minutes)
   881→- Open canyon, running
   882→- Chitin pouring from multiple holes
   883→- Marcus&#x27;s mech providing cover
   884→
   885→#### Phase 3: Holdout (3-5 minutes)
   886→- Wave-based defense
   887→- Dropship ETA countdown
   888→- Marcus&#x27;s mech failing
   889→- Final desperate stand
   890→
   891→#### Phase 4: Victory
   892→- Dropship arrives
   893→- Extraction complete
   894→- Epilogue scene
   895→- Credits option
   896→
   897→**Unique Mechanics**:
   898→- Timer pressure (collapse)
   899→- Escort/defend Marcus
   900→- Final wave intensity
   901→- Cinematic victory
   902→
   903→**Assets Required**:
   904→- Collapsing tunnel effects
   905→- Dropship model
   906→- Victory scene assets
   907→- Epilogue environment (station interior)
   908→
   909→---
   910→
   911→## Asset Requirements Summary
   912→
   913→### PSX-Style Requirements
   914→
   915→All assets should follow PSX aesthetic:
   916→- Low polygon counts (500-2000 per model)
   917→- Pixelated textures (64x64 to 256x256)
   918→- Vertex snapping effect (optional)
   919→- Limited color palettes
   920→- No smooth shading (flat or Gouraud)
   921→
   922→### Priority Asset List
   923→
   924→1. **Player Equipment**
   925→   - Marine armor (first person arms)
   926→   - M7 rifle model
   927→   - Sidearm model
   928→
   929→2. **Environments**
   930→   - Station corridor modules
   931→   - Canyon terrain
   932→   - Base prefab buildings
   933→   - Hive tunnel segments
   934→
   935→3. **Characters**
   936→   - Marine NPCs (static)
   937→   - Marcus&#x27;s mech (Titan)
   938→   - Commander Vasquez (hologram)
   939→
   940→4. **Enemies**
   941→   - Drone (small, fast)
   942→   - Grunt (medium, standard)
   943→   - Brute (large, slow)
   944→   - Spitter (ranged)
   945→   - Queen (boss)
   946→
   947→5. **Props**
   948→   - Crates, barrels
   949→   - Computer terminals
   950→   - Drop pod
   951→   - Weapon racks
   952→   - Mech parts
   953→
   954→---
   955→
   956→## Integration Notes
   957→
   958→### GameContext Integration
   959→
   960→Levels communicate with the HUD via GameContext:
   961→
   962→```typescript
   963→// From level to HUD
   964→callbacks.onActionGroupsChange(groups);     // Update action buttons
   965→callbacks.onActionHandlerRegister(handler); // Register button handler
   966→callbacks.onObjectiveUpdate(title, text);   // Update mission display
   967→callbacks.onCommsMessage(message);          // Show narrative
   968→callbacks.onNotification(text, duration);   // Toast notification
   969→callbacks.onHealthChange(health);           // Update health bar
   970→callbacks.onCombatStateChange(inCombat);    // Combat music trigger
   971→```
   972→
   973→### Level Transition Flow
   974→
   975→```
   976→Level A completes
   977→    ↓
   978→callbacks.onLevelComplete(nextLevelId)
   979→    ↓
   980→LevelManager.transitionTo(nextLevelId)
   981→    ↓
   982→Level A.prepareTransition() - fade out, save state
   983→    ↓
   984→Level A.dispose() - cleanup
   985→    ↓
   986→Level B = factory.create(config)
   987→    ↓
   988→Level B.initialize() - load assets, create scene
   989→    ↓
   990→Level B active
   991→```
   992→
   993→---
   994→
   995→*&quot;Find them. Bring them home. Or avenge them.&quot;*
   996→— Commander Elena Vasquez
   997→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-10-898Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-10-898Z" class="timestamp-link"><time datetime="2026-01-30T18:54:10.898Z" data-timestamp="2026-01-30T18:54:10.898Z">2026-01-30T18:54:10.898Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01NNJKfLwY2RsrCGHVoV3pv5"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/PSX-ASSETS.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-10-901Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-10-901Z" class="timestamp-link"><time datetime="2026-01-30T18:54:10.901Z" data-timestamp="2026-01-30T18:54:10.901Z">2026-01-30T18:54:10.901Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# STELLAR DESCENT: PSX Asset Specifications
     2→
     3→This document defines the modular asset system for creating PSX-style environments across all levels. All level builders must reference this document for consistency.
     4→
     5→---
     6→
     7→## Table of Contents
     8→
     9→1. [PSX Aesthetic Rules](#psx-aesthetic-rules)
    10→2. [Unit System](#unit-system)
    11→3. [Modular Architecture Pieces](#modular-architecture-pieces)
    12→4. [Props &amp; Objects](#props--objects)
    13→5. [Characters &amp; Enemies](#characters--enemies)
    14→6. [Materials &amp; Textures](#materials--textures)
    15→7. [Lighting Guidelines](#lighting-guidelines)
    16→8. [Assembly Examples](#assembly-examples)
    17→
    18→---
    19→
    20→## PSX Aesthetic Rules
    21→
    22→### Core Principles
    23→
    24→1. **Low Polygon Count**
    25→   - Characters: 200-500 vertices
    26→   - Props: 50-200 vertices
    27→   - Architecture: 100-500 vertices per module
    28→   - Large structures: Build from modules, not single meshes
    29→
    30→2. **Texture Resolution**
    31→   - Small props: 32x32 or 64x64
    32→   - Standard objects: 64x64 or 128x128
    33→   - Large surfaces: 128x128 or 256x256
    34→   - NO textures larger than 256x256
    35→
    36→3. **Visual Effects**
    37→   - Flat or Gouraud shading (no smooth normals)
    38→   - Vertex snapping (optional, for authentic wobble)
    39→   - Affine texture mapping (optional)
    40→   - Limited color palette per texture (16-64 colors)
    41→
    42→4. **Forbidden Elements**
    43→   - High-poly models
    44→   - Normal maps
    45→   - PBR materials
    46→   - Smooth curved surfaces (use faceted approximations)
    47→   - Particle systems with thousands of particles
    48→
    49→---
    50→
    51→## Unit System
    52→
    53→All measurements are in METERS. One unit = one meter.
    54→
    55→### Human Scale Reference
    56→```
    57→┌─────────────────────────────────────────┐
    58→│                                         │
    59→│    Standard Marine: 1.8m tall           │
    60→│    Eye height: 1.7m                     │
    61→│    Shoulder width: 0.5m                 │
    62→│                                         │
    63→│    ┌───┐                                │
    64→│    │ ☻ │ ← Head (0.3m)                  │
    65→│    ├───┤                                │
    66→│    │   │ ← Torso (0.6m)                 │
    67→│    │   │                                │
    68→│    ├───┤                                │
    69→│    │   │ ← Legs (0.9m)                  │
    70→│    │   │                                │
    71→│    └───┘                                │
    72→│                                         │
    73→└─────────────────────────────────────────┘
    74→```
    75→
    76→### Standard Dimensions
    77→
    78→| Element | Size |
    79→|:--------|:-----|
    80→| Door height | 2.2m |
    81→| Door width | 1.2m (single), 2.4m (double) |
    82→| Corridor width | 3-4m |
    83→| Corridor height | 3m |
    84→| Standard room height | 3-4m |
    85→| Large room height | 5-10m |
    86→| Hangar height | 10-15m |
    87→| Step height | 0.2m |
    88→| Railing height | 1.0m |
    89→
    90→---
    91→
    92→## Modular Architecture Pieces
    93→
    94→### Station Interior Modules (Anchor Station)
    95→
    96→#### FLOOR MODULES
    97→```
    98→FLOOR_STANDARD (4m x 4m x 0.2m)
    99→├── Material: Metal grating
   100→├── Vertices: ~24
   101→├── Texture: floor_grating.png (128x128)
   102→└── Color: Dark gray (#2A2A2A)
   103→
   104→FLOOR_SOLID (4m x 4m x 0.2m)
   105→├── Material: Solid metal plate
   106→├── Vertices: ~8
   107→├── Texture: floor_metal.png (128x128)
   108→└── Color: Medium gray (#404040)
   109→
   110→FLOOR_DETAIL (4m x 4m x 0.2m)
   111→├── Material: Patterned metal (warning stripes, etc.)
   112→├── Vertices: ~24
   113→├── Texture: floor_hazard.png (128x128)
   114→└── Color: Yellow/black stripes
   115→```
   116→
   117→#### WALL MODULES
   118→```
   119→WALL_STANDARD (4m x 3m x 0.3m)
   120→├── Material: Paneled metal
   121→├── Vertices: ~32
   122→├── Texture: wall_panel.png (128x128)
   123→├── Features: Recessed panel lines
   124→└── Color: Gray-blue (#3A3A4A)
   125→
   126→WALL_WINDOW (4m x 3m x 0.3m)
   127→├── Material: Metal frame + viewport
   128→├── Vertices: ~48
   129→├── Texture: wall_panel.png + window transparency
   130→├── Features: Large viewport section
   131→└── Color: Frame gray, window dark blue
   132→
   133→WALL_DISPLAY (4m x 3m x 0.3m)
   134→├── Material: Metal with screen area
   135→├── Vertices: ~40
   136→├── Texture: wall_panel.png + display area
   137→├── Features: Built-in display screen
   138→└── Color: Gray frame, green/blue screen
   139→
   140→WALL_PIPED (4m x 3m x 0.5m)
   141→├── Material: Metal with exposed pipes
   142→├── Vertices: ~80
   143→├── Texture: wall_industrial.png (128x128)
   144→├── Features: Pipes, valves, gauges
   145→└── Color: Gray, copper pipes
   146→
   147→WALL_DOOR (4m x 3m x 0.3m)
   148→├── Material: Metal with door frame
   149→├── Vertices: ~60
   150→├── Texture: wall_panel.png
   151→├── Features: Door frame, door (separate mesh)
   152→└── Color: Gray frame, dark door
   153→```
   154→
   155→#### CEILING MODULES
   156→```
   157→CEILING_STANDARD (4m x 4m x 0.2m)
   158→├── Material: Metal panels
   159→├── Vertices: ~16
   160→├── Texture: ceiling_panel.png (128x128)
   161→└── Color: Dark gray (#252525)
   162→
   163→CEILING_LIGHT (4m x 4m x 0.3m)
   164→├── Material: Metal with light fixture
   165→├── Vertices: ~32
   166→├── Texture: ceiling_panel.png
   167→├── Features: Recessed light strip
   168→└── Emissive: White/yellow glow
   169→```
   170→
   171→#### DOOR MODULES
   172→```
   173→DOOR_SINGLE (1.2m x 2.2m x 0.1m)
   174→├── Material: Heavy metal
   175→├── Vertices: ~24
   176→├── Texture: door_metal.png (64x64)
   177→├── States: Open, closed, locked
   178→└── Color: Dark gray with accent stripe
   179→
   180→DOOR_DOUBLE (2.4m x 2.2m x 0.1m)
   181→├── Material: Heavy metal
   182→├── Vertices: ~48
   183→├── Texture: door_metal.png (64x64)
   184→├── States: Open, closed, locked
   185→└── Color: Dark gray, sliding panels
   186→
   187→DOOR_AIRLOCK (3m x 2.5m x 0.5m)
   188→├── Material: Reinforced metal
   189→├── Vertices: ~80
   190→├── Texture: door_airlock.png (128x128)
   191→├── Features: Warning stripes, lights
   192→└── Color: Yellow/black hazard
   193→```
   194→
   195→### Surface/Canyon Modules (Landfall, Brothers)
   196→
   197→#### TERRAIN MODULES
   198→```
   199→TERRAIN_FLAT (10m x 10m)
   200→├── Material: Rocky desert
   201→├── Vertices: ~100 (subdivided)
   202→├── Texture: terrain_rock.png (256x256)
   203→└── Color: Rust brown (#8B5A2B)
   204→
   205→TERRAIN_SLOPE (10m x 10m, 30° incline)
   206→├── Material: Rocky desert
   207→├── Vertices: ~100
   208→├── Texture: terrain_rock.png
   209→└── Color: Rust brown
   210→
   211→TERRAIN_CLIFF (10m x 15m)
   212→├── Material: Layered rock face
   213→├── Vertices: ~200
   214→├── Texture: cliff_face.png (256x256)
   215→└── Color: Dark brown (#6B4423)
   216→```
   217→
   218→#### ROCK FORMATIONS
   219→```
   220→ROCK_PILLAR_SMALL (2m diameter, 5m tall)
   221→├── Material: Desert rock
   222→├── Vertices: ~60
   223→├── Shape: Tapered cylinder, irregular
   224→└── Color: Tan/brown
   225→
   226→ROCK_PILLAR_LARGE (4m diameter, 15m tall)
   227→├── Material: Desert rock
   228→├── Vertices: ~120
   229→├── Shape: Irregular column
   230→└── Color: Tan/brown with red striations
   231→
   232→ROCK_BOULDER (2-3m diameter)
   233→├── Material: Desert rock
   234→├── Vertices: ~40
   235→├── Shape: Irregular sphere
   236→└── Color: Gray-brown
   237→
   238→ROCK_OUTCROP (5m x 3m x 4m)
   239→├── Material: Layered rock
   240→├── Vertices: ~80
   241→├── Shape: Jagged horizontal layers
   242→└── Color: Rust/brown layers
   243→```
   244→
   245→### FOB/Base Modules
   246→
   247→#### PREFAB STRUCTURES
   248→```
   249→PREFAB_SMALL (4m x 4m x 3m)
   250→├── Material: Military composite
   251→├── Vertices: ~100
   252→├── Texture: prefab_wall.png (128x128)
   253→├── Features: Single door, no windows
   254→└── Color: Olive drab (#4A4A32)
   255→
   256→PREFAB_MEDIUM (8m x 6m x 3m)
   257→├── Material: Military composite
   258→├── Vertices: ~200
   259→├── Texture: prefab_wall.png
   260→├── Features: Door, 2 windows
   261→└── Color: Olive drab
   262→
   263→PREFAB_LARGE (12m x 8m x 4m)
   264→├── Material: Military composite
   265→├── Vertices: ~300
   266→├── Texture: prefab_wall.png
   267→├── Features: Double door, multiple windows
   268→└── Color: Olive drab
   269→
   270→PREFAB_HANGAR (20m x 15m x 6m)
   271→├── Material: Corrugated metal
   272→├── Vertices: ~400
   273→├── Texture: hangar_wall.png (256x256)
   274→├── Features: Large rolling door
   275→└── Color: Gray-green
   276→```
   277→
   278→### Hive/Organic Modules (The Breach)
   279→
   280→#### TUNNEL SEGMENTS
   281→```
   282→TUNNEL_STRAIGHT (4m diameter, 8m long)
   283→├── Material: Organic chitin
   284→├── Vertices: ~120
   285→├── Shape: Irregular tube
   286→├── Texture: hive_wall.png (128x128)
   287→└── Color: Dark purple-brown (#3A2A3A)
   288→
   289→TUNNEL_CURVE (4m diameter, 8m arc)
   290→├── Material: Organic chitin
   291→├── Vertices: ~180
   292→├── Shape: Curved tube
   293→└── Color: Dark purple-brown
   294→
   295→TUNNEL_JUNCTION (4m diameter, 3 exits)
   296→├── Material: Organic chitin
   297→├── Vertices: ~250
   298→├── Shape: Y-junction
   299→└── Color: Dark purple-brown
   300→
   301→TUNNEL_CHAMBER (8m diameter sphere)
   302→├── Material: Organic, ribbed
   303→├── Vertices: ~300
   304→├── Shape: Irregular sphere
   305→├── Features: Bioluminescent patches
   306→└── Color: Purple-brown with blue glow spots
   307→```
   308→
   309→#### ORGANIC GROWTHS
   310→```
   311→GROWTH_SMALL (0.5m)
   312→├── Material: Bioluminescent
   313→├── Vertices: ~20
   314→├── Shape: Mushroom/tendril
   315→└── Color: Pale blue-green glow
   316→
   317→GROWTH_CLUSTER (1-2m)
   318→├── Material: Bioluminescent
   319→├── Vertices: ~60
   320→├── Shape: Multiple tendrils
   321→└── Color: Blue-green glow
   322→
   323→EGG_SINGLE (0.4m)
   324→├── Material: Translucent organic
   325→├── Vertices: ~30
   326→├── Shape: Oval
   327→└── Color: Pale yellow-green
   328→
   329→EGG_CLUSTER (2m footprint)
   330→├── Material: Organic
   331→├── Vertices: ~150
   332→├── Shape: 5-8 eggs in cluster
   333→└── Color: Yellow-green, membrane between
   334→```
   335→
   336→---
   337→
   338→## Props &amp; Objects
   339→
   340→### Station Props
   341→
   342→```
   343→CRATE_SMALL (0.5m cube)
   344→├── Vertices: ~24
   345→├── Texture: crate.png (64x64)
   346→└── Color: Olive/tan
   347→
   348→CRATE_MEDIUM (1m cube)
   349→├── Vertices: ~24
   350→├── Texture: crate.png
   351→└── Color: Olive/tan
   352→
   353→CRATE_LARGE (1m x 1m x 2m)
   354→├── Vertices: ~24
   355→├── Texture: crate.png
   356→└── Color: Olive/tan
   357→
   358→BARREL (0.5m diameter, 1m tall)
   359→├── Vertices: ~32
   360→├── Texture: barrel.png (64x64)
   361→├── Variants: Standard, hazmat, fuel
   362→└── Color: Gray, yellow stripes, red
   363→
   364→TERMINAL (0.8m x 0.5m x 1.2m)
   365→├── Vertices: ~60
   366→├── Texture: terminal.png (64x64)
   367→├── Features: Screen (emissive)
   368→└── Color: Gray frame, green/blue screen
   369→
   370→LOCKER (0.6m x 0.5m x 2m)
   371→├── Vertices: ~40
   372→├── Texture: locker.png (64x64)
   373→├── States: Open, closed
   374→├── Features: Suit visible when open
   375→└── Color: Gray-green
   376→
   377→WEAPON_RACK (2m x 0.5m x 1.5m)
   378→├── Vertices: ~100
   379→├── Texture: rack.png (64x64)
   380→├── Features: 3 weapon slots
   381→└── Color: Dark gray
   382→
   383→CHAIR (0.5m x 0.5m x 1m)
   384→├── Vertices: ~30
   385→├── Texture: furniture.png (64x64)
   386→└── Color: Gray/black
   387→
   388→BENCH (2m x 0.5m x 0.5m)
   389→├── Vertices: ~20
   390→├── Texture: furniture.png
   391→└── Color: Gray
   392→
   393→TABLE_SMALL (1m x 1m x 0.8m)
   394→├── Vertices: ~30
   395→├── Texture: furniture.png
   396→└── Color: Gray
   397→
   398→TABLE_HOLOGRAM (2m diameter, 1m tall)
   399→├── Vertices: ~60
   400→├── Features: Projector base, hologram above
   401→└── Color: Dark gray, blue hologram glow
   402→```
   403→
   404→### Military Props
   405→
   406→```
   407→SANDBAG_WALL (3m x 1m x 1m)
   408→├── Vertices: ~80
   409→├── Texture: sandbag.png (64x64)
   410→└── Color: Tan/brown
   411→
   412→BARRIER_CONCRETE (2m x 0.5m x 1m)
   413→├── Vertices: ~30
   414→├── Texture: concrete.png (64x64)
   415→└── Color: Gray
   416→
   417→BARRIER_METAL (3m x 0.1m x 1.5m)
   418→├── Vertices: ~40
   419→├── Texture: barrier.png (64x64)
   420→├── Features: Warning stripes
   421→└── Color: Yellow/black
   422→
   423→COMM_TOWER (1m x 1m x 8m)
   424→├── Vertices: ~100
   425→├── Texture: metal.png (64x64)
   426→├── Features: Antenna, dishes
   427→└── Color: Gray, red light on top
   428→
   429→GENERATOR (2m x 1m x 1.5m)
   430→├── Vertices: ~80
   431→├── Texture: machine.png (64x64)
   432→├── Features: Vents, pipes
   433→└── Color: Gray-green
   434→```
   435→
   436→### Vehicles
   437→
   438→```
   439→MECH_TITAN (3m x 4m x 8m - Marcus&#x27;s mech)
   440→├── Vertices: ~500
   441→├── Texture: mech.png (256x256)
   442→├── Features: Twin autocannons, missile pods
   443→├── Animations: Walk, fire, damaged
   444→└── Color: Military olive drab with unit markings
   445→
   446→DROP_POD (2m diameter, 3m tall)
   447→├── Vertices: ~150
   448→├── Texture: pod.png (128x128)
   449→├── States: Closed, open, interior visible
   450→└── Color: Gray-white with heat scoring
   451→
   452→DROPSHIP (15m x 10m x 5m - extraction)
   453→├── Vertices: ~400
   454→├── Texture: dropship.png (256x256)
   455→├── Features: Troop bay, engines
   456→└── Color: Gray military
   457→```
   458→
   459→---
   460→
   461→## Characters &amp; Enemies
   462→
   463→### Human Characters
   464→
   465→```
   466→MARINE_STATIC (standing)
   467→├── Vertices: ~300
   468→├── Texture: marine.png (128x128)
   469→├── Features: Combat armor, helmet, rifle
   470→└── Color: Olive/gray armor
   471→
   472→PLAYER_ARMS (first person)
   473→├── Vertices: ~150
   474→├── Texture: arms.png (64x64)
   475→├── Features: Armored forearms, gloves
   476→└── Color: Dark gray armor
   477→
   478→COMMANDER_VASQUEZ (hologram/portrait)
   479→├── Vertices: ~200 (if 3D)
   480→├── Texture: vasquez.png (128x128)
   481→├── Features: Officer uniform, serious expression
   482→└── Color: Blue hologram tint
   483→```
   484→
   485→### Enemy: Chitin
   486→
   487→```
   488→CHITIN_DRONE
   489→├── Size: 0.5-0.8m
   490→├── Vertices: ~200
   491→├── Texture: drone.png (64x64)
   492→├── Health: 30 HP
   493→├── Color: Purple-black
   494→├── Behavior: Fast, swarm
   495→└── Animations: Scurry, attack, death
   496→
   497→CHITIN_GRUNT
   498→├── Size: 1.5-1.8m
   499→├── Vertices: ~350
   500→├── Texture: grunt.png (128x128)
   501→├── Health: 100 HP
   502→├── Color: Dark gray-green
   503→├── Behavior: Standard combat
   504→└── Animations: Walk, run, attack, death
   505→
   506→CHITIN_BRUTE
   507→├── Size: 2.5-3m
   508→├── Vertices: ~400
   509→├── Texture: brute.png (128x128)
   510→├── Health: 200 HP
   511→├── Color: Deep red-brown
   512→├── Behavior: Slow, charge attack
   513→└── Animations: Walk, charge, slam, death
   514→
   515→CHITIN_SPITTER
   516→├── Size: 1.2-1.5m
   517→├── Vertices: ~300
   518→├── Texture: spitter.png (128x128)
   519→├── Health: 50 HP
   520→├── Color: Pale green
   521→├── Behavior: Ranged acid attack
   522→└── Animations: Idle, spit, death
   523→
   524→CHITIN_QUEEN
   525→├── Size: 4m+ (partially embedded)
   526→├── Vertices: ~800
   527→├── Texture: queen.png (256x256)
   528→├── Health: 5000 HP
   529→├── Color: Iridescent purple
   530→├── Features: Spawns minions, multiple attack types
   531→└── Animations: Idle, roar, spawn, attack, death
   532→```
   533→
   534→---
   535→
   536→## Materials &amp; Textures
   537→
   538→### Color Palette
   539→
   540→**Station Interior**
   541→| Name | Hex | Usage |
   542→|:-----|:----|:------|
   543→| Panel Gray | #3A3A4A | Wall panels |
   544→| Floor Dark | #2A2A2A | Floor grating |
   545→| Accent Blue | #4A5A7A | Trim, lights |
   546→| Warning Yellow | #C4A000 | Hazard stripes |
   547→| Danger Red | #A03030 | Emergency lights |
   548→
   549→**Planet Surface**
   550→| Name | Hex | Usage |
   551→|:-----|:----|:------|
   552→| Rock Tan | #9B7B5A | Main terrain |
   553→| Rock Brown | #6B4A2A | Shadows |
   554→| Rock Red | #8B4A3A | Accent |
   555→| Dust Orange | #C48A50 | Atmosphere |
   556→| Sky Orange | #D47A3A | Sunset sky |
   557→
   558→**FOB/Military**
   559→| Name | Hex | Usage |
   560→|:-----|:----|:------|
   561→| Olive Drab | #4A4A32 | Main color |
   562→| Military Gray | #505050 | Metal |
   563→| Tan | #9A8A6A | Sandbags |
   564→| Black | #1A1A1A | Shadows |
   565→
   566→**Hive/Organic**
   567→| Name | Hex | Usage |
   568→|:-----|:----|:------|
   569→| Chitin Dark | #3A2A3A | Main walls |
   570→| Chitin Purple | #5A3A5A | Accents |
   571→| Bio Glow | #4AC8C8 | Bioluminescence |
   572→| Egg Yellow | #A0A050 | Eggs |
   573→
   574→### Texture Requirements
   575→
   576→1. **Format**: PNG with transparency where needed
   577→2. **Sizes**: 32, 64, 128, or 256 pixels (power of 2)
   578→3. **Style**: Hand-painted look, limited palette
   579→4. **Tiling**: Most textures should tile seamlessly
   580→5. **LOD**: Single resolution (no mipmaps for authentic look)
   581→
   582→---
   583→
   584→## Lighting Guidelines
   585→
   586→### Station Lighting
   587→- **Main**: Point lights every 4-6m along corridors
   588→- **Color**: Warm white (FFE4C4) or cool blue (C4D4FF)
   589→- **Intensity**: 1.0-1.5
   590→- **Shadows**: Soft or none (performance)
   591→- **Ambient**: 0.3-0.4 intensity
   592→
   593→### Surface Lighting
   594→- **Sun**: Directional light, orange-red tint
   595→- **Direction**: Low angle (eternal sunset)
   596→- **Color**: #FFA040
   597→- **Intensity**: 2.0-2.5
   598→- **Ambient**: 0.2-0.3 (harsh)
   599→
   600→### FOB Lighting
   601→- **Main**: Flickering point lights
   602→- **Color**: Yellow-white (FFE0A0)
   603→- **Intensity**: Variable (0.5-1.5, flickering)
   604→- **Ambient**: 0.1-0.2 (dark, horror)
   605→- **Effect**: Random flicker for tension
   606→
   607→### Hive Lighting
   608→- **Main**: Bioluminescent point lights
   609→- **Color**: Cyan-blue (#40C0C0)
   610→- **Intensity**: 0.5-1.0
   611→- **Ambient**: 0.05-0.1 (very dark)
   612→- **Glow**: Emissive materials on growths
   613→
   614→---
   615→
   616→## Assembly Examples
   617→
   618→### Example: Station Corridor (30m long)
   619→
   620→```javascript
   621→// Corridor assembly pattern
   622→function createCorridor(scene: Scene, length: number) {
   623→  const segments = Math.ceil(length / 4); // 4m per segment
   624→
   625→  for (let i = 0; i &lt; segments; i++) {
   626→    const z = i * 4;
   627→
   628→    // Floor
   629→    createFloorGrating(scene, { x: 0, y: 0, z });
   630→
   631→    // Left wall
   632→    createWallPanel(scene, { x: -2, y: 1.5, z }, { rotY: Math.PI / 2 });
   633→
   634→    // Right wall (alternate types)
   635→    if (i % 3 === 0) {
   636→      createWallPiped(scene, { x: 2, y: 1.5, z }, { rotY: -Math.PI / 2 });
   637→    } else {
   638→      createWallPanel(scene, { x: 2, y: 1.5, z }, { rotY: -Math.PI / 2 });
   639→    }
   640→
   641→    // Ceiling with light every other segment
   642→    if (i % 2 === 0) {
   643→      createCeilingLight(scene, { x: 0, y: 3, z });
   644→    } else {
   645→      createCeilingStandard(scene, { x: 0, y: 3, z });
   646→    }
   647→  }
   648→}
   649→```
   650→
   651→### Example: Canyon Scene
   652→
   653→```javascript
   654→// Canyon terrain assembly
   655→function createCanyonArea(scene: Scene) {
   656→  // Base terrain grid
   657→  for (let x = -5; x &lt;= 5; x++) {
   658→    for (let z = -5; z &lt;= 5; z++) {
   659→      createTerrainFlat(scene, { x: x * 10, y: 0, z: z * 10 });
   660→    }
   661→  }
   662→
   663→  // Canyon walls
   664→  createCliffWall(scene, { x: -60, y: 7.5, z: 0 }, { scaleZ: 10 });
   665→  createCliffWall(scene, { x: 60, y: 7.5, z: 0 }, { scaleZ: 10, rotY: Math.PI });
   666→
   667→  // Rock formations
   668→  for (let i = 0; i &lt; 20; i++) {
   669→    const pos = randomPositionInArea(-50, 50, -50, 50);
   670→    const type = Math.random() &gt; 0.7 ? &#x27;pillar_large&#x27; : &#x27;boulder&#x27;;
   671→    createRock(scene, type, pos);
   672→  }
   673→}
   674→```
   675→
   676→### Example: Hive Tunnel Network
   677→
   678→```javascript
   679→// Hive tunnel assembly
   680→function createHiveSection(scene: Scene) {
   681→  // Main tunnel
   682→  createTunnelStraight(scene, { x: 0, y: 0, z: 0 });
   683→  createTunnelStraight(scene, { x: 0, y: 0, z: 8 });
   684→
   685→  // Junction
   686→  createTunnelJunction(scene, { x: 0, y: 0, z: 16 });
   687→
   688→  // Branch tunnels
   689→  createTunnelCurve(scene, { x: 6, y: 0, z: 20 }, { rotY: Math.PI / 4 });
   690→  createTunnelCurve(scene, { x: -6, y: 0, z: 20 }, { rotY: -Math.PI / 4 });
   691→
   692→  // Bioluminescent growths
   693→  for (let i = 0; i &lt; 15; i++) {
   694→    const pos = randomTunnelWallPosition();
   695→    createGrowthCluster(scene, pos);
   696→  }
   697→
   698→  // Egg clusters at junction
   699→  createEggCluster(scene, { x: 2, y: 0, z: 18 });
   700→  createEggCluster(scene, { x: -2, y: 0, z: 18 });
   701→}
   702→```
   703→
   704→---
   705→
   706→## Asset Checklist by Level
   707→
   708→### Anchor Station
   709→- [ ] Floor modules (standard, solid, hazard)
   710→- [ ] Wall modules (standard, window, display, piped, door)
   711→- [ ] Ceiling modules (standard, light)
   712→- [ ] Door modules (single, double, airlock)
   713→- [ ] Props (crates, terminals, lockers, racks, tables, chairs)
   714→- [ ] Hologram table
   715→- [ ] Drop pod
   716→- [ ] Marine NPCs (static)
   717→- [ ] Player arms (first person)
   718→
   719→### Landfall
   720→- [ ] Asteroid meshes (5-10 variants)
   721→- [ ] Planet sphere (atmospheric shader)
   722→- [ ] Player arms (skydiver pose)
   723→- [ ] Thruster handles
   724→- [ ] LZ pad
   725→- [ ] Terrain modules (flat, slope, cliff)
   726→- [ ] Rock formations (pillars, boulders)
   727→- [ ] Chitin Drone
   728→- [ ] Chitin Grunt
   729→
   730→### FOB Delta
   731→- [ ] Prefab structures (small, medium, large, hangar)
   732→- [ ] Military props (sandbags, barriers, comm tower, generator)
   733→- [ ] Interior modules (reuse station?)
   734→- [ ] Damage decals (blood, scorches, holes)
   735→- [ ] Marcus&#x27;s mech (damaged state)
   736→- [ ] All Chitin types
   737→
   738→### Brothers in Arms
   739→- [ ] Large canyon terrain
   740→- [ ] The Breach (massive sinkhole)
   741→- [ ] Marcus&#x27;s mech (combat state)
   742→- [ ] Bioluminescent growths (near Breach)
   743→- [ ] All Chitin types in larger numbers
   744→
   745→### The Breach
   746→- [ ] Tunnel segments (straight, curve, junction, chamber)
   747→- [ ] Organic growths
   748→- [ ] Egg clusters
   749→- [ ] Queen model
   750→- [ ] All Chitin types
   751→- [ ] Acid pool hazards
   752→- [ ] Collapsing tunnel effects
   753→
   754→### Extraction
   755→- [ ] Collapsing tunnel variants
   756→- [ ] LZ Omega area
   757→- [ ] Dropship
   758→- [ ] Marcus&#x27;s mech (failing state)
   759→- [ ] All Chitin types (max intensity)
   760→
   761→---
   762→
   763→*All assets should prioritize the PSX aesthetic over visual fidelity. Low poly counts and pixelated textures are features, not limitations.*
   764→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-11-661Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-11-661Z" class="timestamp-link"><time datetime="2026-01-30T18:54:11.661Z" data-timestamp="2026-01-30T18:54:11.661Z">2026-01-30T18:54:11.661Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01V7zPMz22Wv4nnxiaU4RVSU"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;docs/DESIGN.md&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-12-099Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-12-099Z" class="timestamp-link"><time datetime="2026-01-30T18:54:12.099Z" data-timestamp="2026-01-30T18:54:12.099Z">2026-01-30T18:54:12.099Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01GqhhvAyDKcVL2HXHzUoZ3s"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;docs/*.md&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-12-861Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-12-861Z" class="timestamp-link"><time datetime="2026-01-30T18:54:12.861Z" data-timestamp="2026-01-30T18:54:12.861Z">2026-01-30T18:54:12.861Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DESIGN.md</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-13-300Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-13-300Z" class="timestamp-link"><time datetime="2026-01-30T18:54:13.300Z" data-timestamp="2026-01-30T18:54:13.300Z">2026-01-30T18:54:13.300Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/ARCHITECTURE.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/ASSET-INTEGRATION.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DESIGN.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DEVLOG.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LEVELS.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LORE.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/MEMORY.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/PERFORMANCE.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/PSX-ASSETS.md
/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/TESTING.md</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-18-421Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-18-421Z" class="timestamp-link"><time datetime="2026-01-30T18:54:18.421Z" data-timestamp="2026-01-30T18:54:18.421Z">2026-01-30T18:54:18.421Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Let me now read the remaining docs and key files I need to understand the full vision. I need to read DESIGN.md, LORE.md, and check the mining-depths level that the user wants wired in. Let me also look at the existing models and the vehicle system.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-18-831Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-18-831Z" class="timestamp-link"><time datetime="2026-01-30T18:54:18.831Z" data-timestamp="2026-01-30T18:54:18.831Z">2026-01-30T18:54:18.831Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01RcTMokZ1utTGE2DXFuhCKq"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/DESIGN.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-18-835Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-18-835Z" class="timestamp-link"><time datetime="2026-01-30T18:54:18.835Z" data-timestamp="2026-01-30T18:54:18.835Z">2026-01-30T18:54:18.835Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# Design System &amp; UI/UX Guidelines
     2→
     3→This document defines the visual design system, UI patterns, and user experience guidelines for STELLAR DESCENT: PROXIMA BREACH.
     4→
     5→## Design Philosophy
     6→
     7→### Core Principles
     8→
     9→1. **Military Tactical Aesthetic**
    10→   - Think modern military equipment, not sci-fi fantasy
    11→   - Utilitarian, functional design
    12→   - Stencil typography, angular shapes
    13→   - Worn, battle-tested appearance
    14→
    15→2. **Harsh Alien Environment**
    16→   - Proxima Centauri is a red dwarf star
    17→   - Intense, contrasty lighting
    18→   - Dust, rock, and sparse vegetation
    19→   - No lush environments or soft lighting
    20→
    21→3. **Mobile-First Responsive**
    22→   - Design for 375px width first
    23→   - Scale up to tablets and desktop
    24→   - Touch targets minimum 44px
    25→   - Thumb-reachable controls
    26→
    27→## Color System
    28→
    29→### Primary Palette (Military)
    30→
    31→
    32→### Forbidden Colors
    33→
    34→Do NOT use:
    35→- Neon colors (#00FFFF, #FF00FF, etc.)
    36→- Pure blues (#0000FF)
    37→- Cyberpunk purples (#9400D3)
    38→- Gradients with blue/purple
    39→
    40→## Typography
    41→
    42→### Font Stack
    43→
    44→```css
    45→Primary:  &#x27;Rajdhani&#x27;, sans-serif      /* UI text */
    46→Mono:     &#x27;Share Tech Mono&#x27;, monospace /* Data/numbers */
    47→Display:  &#x27;Black Ops One&#x27;, cursive     /* Titles */
    48→```
    49→
    50→### Size Scale (Mobile Base)
    51→
    52→```
    53→XS:      12px  - Captions, labels
    54→SM:      14px  - Secondary text
    55→MD:      16px  - Body text
    56→LG:      20px  - Subheadings
    57→XL:      24px  - Section titles
    58→XXL:     32px  - Page titles
    59→Display: 48px  - Hero titles
    60→```
    61→
    62→### Desktop Multiplier: 1.15x
    63→
    64→## Spacing System
    65→
    66→### Base Scale
    67→
    68→```
    69→XS:  4px   - Tight spacing
    70→SM:  8px   - Compact elements
    71→MD:  16px  - Standard spacing
    72→LG:  24px  - Generous spacing
    73→XL:  32px  - Section separation
    74→XXL: 48px  - Major sections
    75→```
    76→
    77→### Mobile Multiplier: 0.75x
    78→
    79→## Components
    80→
    81→### Buttons
    82→
    83→## Primary Button
    84→```
    85→Background: tokens.colors.primary.oliveDark
    86→Text:       tokens.colors.ui.text
    87→Border:     2px solid tokens.colors.primary.olive
    88→Height:     50px (desktop), 48px (mobile)
    89→Font:       Courier New, monospace, 16px
    90→```
    91→
    92→## Hover State
    93→```
    94→Background: tokens.colors.primary.olive
    95→Text:       tokens.colors.accent.brass
    96→Transform:  scale(1.02)
    97→```
    98→
    99→## Disabled State
   100→```
   101→Background: tokens.colors.ui.surface
   102→Text:       tokens.colors.ui.textMuted
   103→Opacity:    1 (don&#x27;t use opacity for disabled)
   104→```
   105→
   106→### Health Bar
   107→
   108→```
   109→Container:
   110→  Width:      250px (desktop), 180px (mobile)
   111→  Height:     24px (desktop), 20px (mobile)
   112→  Background: tokens.colors.ui.background + &#x27;CC&#x27;
   113→  Border:     2px solid tokens.colors.primary.olive
   114→
   115→Fill:
   116→  &gt;50%:  tokens.colors.ui.health
   117→  25-50%: tokens.colors.ui.warning
   118→  &lt;25%:  tokens.colors.ui.danger
   119→```
   120→
   121→### Notifications
   122→
   123→```
   124→Width:      320px (desktop), 260px (mobile)
   125→Height:     50px (desktop), 40px (mobile)
   126→Background: tokens.colors.primary.olive + &#x27;EE&#x27;
   127→Border:     2px solid tokens.colors.accent.brass
   128→Animation:  Fade in from top, hold, fade out down
   129→```
   130→
   131→### Crosshair
   132→
   133→```
   134→Center Dot:
   135→  Size:   4px (desktop), 6px (mobile)
   136→  Color:  tokens.colors.accent.amber
   137→
   138→Lines:
   139→  Length: 12px (desktop), 16px (mobile)
   140→  Width:  2px (desktop), 3px (mobile)
   141→  Color:  tokens.colors.ui.text + &#x27;88&#x27;
   142→  Gap:    8px (desktop), 10px (mobile)
   143→```
   144→
   145→## Touch Controls Layout
   146→
   147→### Portrait Mode (Not Recommended)
   148→
   149→```
   150→+---------------------------+
   151→|     [WAVE/MISSION]        |
   152→|                           |
   153→|                           |
   154→|    SUGGEST LANDSCAPE      |
   155→|                           |
   156→|                           |
   157→+---------------------------+
   158→```
   159→
   160→### Landscape Mode (Primary)
   161→
   162→```
   163→+-----------------------------------------------+
   164→|  [HEALTH]              [MISSION]      [KILLS] |
   165→|                                               |
   166→|                    +                          |
   167→|                                               |
   168→|                                               |
   169→|  [SPRINT]                          [FIRE]     |
   170→|     O                                  O      |
   171→|   (MOVE)                            (LOOK)    |
   172→+-----------------------------------------------+
   173→```
   174→
   175→### Joystick Sizing
   176→
   177→```
   178→Mobile:
   179→  Base:  min(120px, 22% of min dimension)
   180→  Thumb: 45% of base
   181→
   182→Tablet:
   183→  Base:  min(140px, 18% of min dimension)
   184→  Thumb: 45% of base
   185→
   186→Desktop (if touch):
   187→  Base:  min(160px, 15% of min dimension)
   188→  Thumb: 45% of base
   189→```
   190→
   191→### Safe Areas
   192→
   193→Always respect:
   194→- `env(safe-area-inset-top)` - Notch/Dynamic Island
   195→- `env(safe-area-inset-bottom)` - Home indicator
   196→- `env(safe-area-inset-left/right)` - Landscape notch
   197→
   198→## Motion &amp; Animation
   199→
   200→### Principles
   201→
   202→1. **Purposeful** - Every animation serves a function
   203→2. **Fast** - Keep under 300ms for UI, 500ms for emphasis
   204→3. **Respect Preferences** - Honor `prefers-reduced-motion`
   205→
   206→### Standard Timings
   207→
   208→```
   209→Instant:   0ms    - State changes
   210→Fast:      100ms  - Hover effects
   211→Normal:    200ms  - Transitions
   212→Emphasis:  300ms  - Important changes
   213→Dramatic:  500ms  - Major events
   214→```
   215→
   216→### Easing Functions
   217→
   218→```
   219→easeOutQuad    - Standard exit
   220→easeInQuad     - Standard entrance
   221→easeOutElastic - Bounce effects (damage shake)
   222→linear         - Continuous animations
   223→```
   224→
   225→### Animation Examples
   226→
   227→## Button Hover
   228→```javascript
   229→anime({
   230→  targets: button,
   231→  scaleX: 1.02,
   232→  scaleY: 1.02,
   233→  duration: 100,
   234→  easing: &#x27;easeOutQuad&#x27;
   235→});
   236→```
   237→
   238→## Damage Flash
   239→```javascript
   240→anime({
   241→  targets: damageOverlay,
   242→  alpha: [0.4, 0],
   243→  duration: 300,
   244→  easing: &#x27;easeOutQuad&#x27;
   245→});
   246→```
   247→
   248→## Notification Entry
   249→```javascript
   250→anime({
   251→  targets: notification,
   252→  alpha: [0, 1],
   253→  top: [&#x27;-100px&#x27;, &#x27;-80px&#x27;],
   254→  duration: 300,
   255→  easing: &#x27;easeOutQuad&#x27;
   256→});
   257→```
   258→
   259→## Iconography
   260→
   261→### Current Icons
   262→
   263→Using Unicode symbols for simplicity:
   264→- Star: `★` - Insignia/rank
   265→- Crosshair: Built from rectangles
   266→
   267→### Future Considerations
   268→
   269→When adding icons:
   270→- SVG format only
   271→- Single color (use currentColor)
   272→- Minimum 24x24 touch target
   273→- Military/tactical style
   274→
   275→## Accessibility
   276→
   277→### Color Contrast
   278→
   279→- Text on dark: minimum 4.5:1 ratio
   280→- Large text: minimum 3:1 ratio
   281→- Interactive elements: clear focus states
   282→
   283→### Touch Targets
   284→
   285→- Minimum 44x44px for all interactive elements
   286→- 8px minimum spacing between targets
   287→
   288→### Motion
   289→
   290→```css
   291→@media (prefers-reduced-motion: reduce) {
   292→  * {
   293→    animation-duration: 0.01ms !important;
   294→    transition-duration: 0.01ms !important;
   295→  }
   296→}
   297→```
   298→
   299→### Screen Readers
   300→
   301→- All buttons have text labels
   302→- Health displayed as &quot;X of Y&quot;
   303→- Mission status announced
   304→
   305→## Platform Considerations
   306→
   307→### iOS Safari
   308→
   309→- `viewport-fit=cover` for notch
   310→- `-webkit-touch-callout: none` to prevent menus
   311→- `touch-action: manipulation` to prevent zoom
   312→
   313→### Android Chrome
   314→
   315→- Theme color meta tag: `#1C1C1C`
   316→- Fullscreen API supported
   317→- Wake lock API supported
   318→
   319→### Foldables
   320→
   321→- Test in both folded and unfolded states
   322→- Support `horizontal-viewport-segments` media query
   323→- Avoid placing critical UI near fold
   324→
   325→## Design Token Usage
   326→
   327→Always import from designTokens.ts:
   328→
   329→```typescript
   330→import { tokens } from &#x27;../utils/designTokens&#x27;;
   331→
   332→// Colors
   333→material.diffuseColor = Color3.FromHexString(tokens.colors.primary.olive);
   334→button.background = tokens.colors.ui.background;
   335→
   336→// Spacing
   337→container.left = `${tokens.spacing.md}px`;
   338→
   339→// Border radius
   340→button.cornerRadius = tokens.effects.borderRadius.sm;
   341→```
   342→
   343→Never hardcode values. If a value isn&#x27;t in tokens, add it first.
   344→
   345→---
   346→
   347→*&quot;Form follows function. Every element serves the mission.&quot;*
   348→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-19-425Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-19-425Z" class="timestamp-link"><time datetime="2026-01-30T18:54:19.425Z" data-timestamp="2026-01-30T18:54:19.425Z">2026-01-30T18:54:19.425Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01XFNEMHhnLSzWgVYPXuaLRN"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/docs/LORE.md&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-19-573Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-19-573Z" class="timestamp-link"><time datetime="2026-01-30T18:54:19.573Z" data-timestamp="2026-01-30T18:54:19.573Z">2026-01-30T18:54:19.573Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# STELLAR DESCENT: PROXIMA BREACH -- Complete Campaign Narrative
     2→
     3→This document is the canonical story bible for Stellar Descent: Proxima Breach. It contains the full expanded 10-level campaign narrative, character profiles, enemy taxonomy, audio log summaries, and thematic analysis. All story decisions should reference this document.
     4→
     5→---
     6→
     7→## Table of Contents
     8→
     9→1. [Story Overview](#story-overview)
    10→2. [Campaign Levels](#campaign-levels)
    11→3. [Characters](#characters)
    12→4. [The Chitin -- Enemy Species](#the-chitin----enemy-species)
    13→5. [Audio Logs](#audio-logs)
    14→6. [Themes](#themes)
    15→7. [World Building](#world-building)
    16→
    17→---
    18→
    19→## Story Overview
    20→
    21→### The Setting
    22→
    23→The year is 3147 CE. Humanity has spread beyond the Solar System, establishing footholds across the Alpha Centauri system. The Terran Expansion Authority (TEA) oversees colonization from massive orbital platforms called ANCHOR STATIONS -- mobile deployment bases positioned above target worlds to stage pacification and terraforming operations.
    24→
    25→ANCHOR STATION PROMETHEUS has been positioned above Proxima Centauri b, designated PCb-7 &quot;Kepler&#x27;s Promise&quot; -- a rocky world orbiting the red dwarf Proxima Centauri at a distance of 4.24 light years from Earth. Initial surveys indicated no hostile life forms. The world was cleared for Phase One colonization.
    26→
    27→Recon Team Vanguard was deployed 72 hours ago to establish Forward Operating Base DELTA in the northern canyon region. Their mission: secure the landing zone, survey mineral deposits, and prepare for terraforming equipment. Thirty-six hours ago, all communication with FOB Delta ceased. No distress beacon. No explanation. Just silence.
    28→
    29→### The Protagonist
    30→
    31→You are **Sergeant James Cole**, callsign SPECTER, 7th Drop Marines &quot;Hell Jumpers.&quot; Your younger brother, **Corporal Marcus Cole**, callsign HAMMER, was assigned to Vanguard as mech support in his M-47 &quot;Titan&quot; combat walker. Command has authorized a solo reconnaissance drop. Find out what happened. Locate survivors. And if hostile contact is confirmed -- eliminate the threat.
    32→
    33→### The Antagonists
    34→
    35→Beneath the surface of Kepler&#x27;s Promise, an entire civilization lay dormant. The **Chitin** -- an insectoid hive species living in vast underground tunnel networks -- were awakened by seismic vibrations from mining operations. Organized around a single queen who serves as both leader and hive-mind nexus, they are highly aggressive, terrifyingly coordinated, and they do not want humanity on their world.
    36→
    37→### The Narrative Arc
    38→
    39→The campaign follows three acts across ten levels:
    40→
    41→- **Act 1 -- The Drop** (Levels 1-2): Introduction, tutorial, and first contact with Kepler&#x27;s Promise.
    42→- **Act 2 -- The Search** (Levels 3-5): Investigating what happened to Vanguard, finding Marcus, and uncovering the Chitin threat.
    43→- **Act 3 -- The Assault** (Levels 6-8): Taking the fight to the enemy, descending into the hive, and confronting the Queen.
    44→- **Act 4 -- The Escape** (Levels 9-10): Surviving the aftermath and getting home alive.
    45→
    46→---
    47→
    48→## Campaign Levels
    49→
    50→### Level 1: Anchor Station -- The Fall
    51→
    52→**Act 1: The Drop | Chapter 1 | Tutorial**
    53→
    54→**Setting**: The interior of ANCHOR STATION PROMETHEUS -- a 2.3-kilometer orbital deployment platform housing over four thousand personnel. Clean corridors of gunmetal gray and teal lighting stretch between the Briefing Room, Equipment Bay, Shooting Range, and Hangar Bay. Through viewports, the rust-red surface of Kepler&#x27;s Promise rotates slowly below.
    55→
    56→**Story Events and Objectives**:
    57→James Cole receives his mission briefing from Commander Elena Vasquez. The atmosphere aboard Prometheus is tense -- Vanguard has been silent for over thirty-six hours, and the lack of a distress beacon is troubling. Vasquez is blunt: this is personal for James, and she knows it. His brother Marcus was on that team.
    58→
    59→The level serves as the game&#x27;s tutorial. James navigates the station, learning movement controls in the corridors, equipping his ODST combat suit in the Equipment Bay, and completing weapons familiarization at the Shooting Range. The HUD elements unlock progressively -- health bar with movement, crosshair with aiming, kill counter with the first target hit.
    60→
    61→The final objective leads James to Hangar Bay, where row after row of drop pods line the launch rails. His pod, designation HELL-7, awaits. He boards. The launch sequence initiates.
    62→
    63→**Key Dialogue Moments**:
    64→- Vasquez&#x27;s briefing: &quot;Sergeant, we&#x27;ve lost contact with Recon Team Vanguard. Your brother was among them. I know this is personal, but you&#x27;re our best operative for this mission.&quot;
    65→- PROMETHEUS AI (ATHENA) detecting unusual radio interference from the planet&#x27;s surface, coinciding with FOB Delta coordinates -- a pattern that does not match known natural phenomena.
    66→- The hangar bay launch officer: &quot;Green light confirmed. Godspeed, Sergeant.&quot;
    67→
    68→**Character Development**:
    69→James is established as a quiet professional. He does not speak during the briefing -- his silence says everything. The player learns through environmental details: a locker with family photos, Marcus&#x27;s personal audio log left aboard the station, the respectful nods from fellow Marines who know where he is going and why.
    70→
    71→**Connection to Narrative Arc**:
    72→This level establishes the stakes (Marcus is missing), the setting (humanity&#x27;s frontier), and the mystery (why did Vanguard go silent?). The final drop pod launch propels the player into the unknown.
    73→
    74→---
    75→
    76→### Level 2: Landfall -- Descent
    77→
    78→**Act 1: The Drop | Chapter 2 | HALO Drop + First Surface Combat**
    79→
    80→**Setting**: The drop begins in the void of space -- the player looks down at the alien landscape expanding beneath them. The atmosphere tears past as retro-thrusters fight terminal velocity. Rust-red rock formations jut toward a pale sun. Endless desert broken by deep canyon systems. The light has a perpetual sunset quality cast by the red dwarf star.
    81→
    82→**Story Events and Objectives**:
    83→The level unfolds in four phases. Phase one: freefall from orbit, the planet&#x27;s surface growing in the viewport, arms extended in skydiver pose. Phase two: the debris belt, where asteroid fragments and orbital junk rush past and the player must dodge to avoid suit damage. Phase three: powered descent, where the player ignites retro-jets and manages velocity for landing at Drop Zone Alpha. Phase four: first contact on the surface.
    84→
    85→After landing (with outcomes ranging from a clean touchdown to a rough crash depending on player skill), James establishes bearings and begins navigating toward FOB Delta. The alien landscape is stark and hostile -- thin atmosphere requiring a respirator, extreme temperature variance, dust-laden winds. Then the first Chitin drones emerge from fissures in the rock, fast-moving scouts that attack in packs of three to five.
    86→
    87→This is the player&#x27;s first real combat encounter. Drones are fragile but quick. Behind them come the first Chitin soldiers -- the game&#x27;s standard enemy, armored and aggressive.
    88→
    89→**Key Dialogue Moments**:
    90→- ATHENA providing atmospheric and environmental data during descent.
    91→- Vasquez on comms after landing: &quot;Telemetry shows a clean insertion. Proceed to FOB Delta bearing north-northeast. And Sergeant -- watch your step.&quot;
    92→- The discovery of a distress beacon from Mining Outpost Gamma-7, a frantic recording that cuts to static mid-sentence.
    93→
    94→**Character Development**:
    95→James is alone on an alien world. Every sound could be threat or wind. The isolation is palpable. His discipline keeps him moving forward, but the emptiness of the landscape and the silence of the FOB on his scanner weigh on him.
    96→
    97→**Connection to Narrative Arc**:
    98→Landfall transitions the player from the safety of the station to the hostility of Kepler&#x27;s Promise. The first Chitin encounters establish the enemy as fast, numerous, and emerging from underground -- a hint at the subterranean horrors to come.
    99→
   100→---
   101→
   102→### Level 3: Canyon Run -- The Gauntlet
   103→
   104→**Act 2: The Search | Chapter 3 | Vehicle Chase**
   105→
   106→**Setting**: The Northern Canyon system -- a labyrinth of towering stone walls carved by ancient geological processes. The canyon floor is dotted with alien vegetation, abandoned mining equipment, and the rusted frames of survey vehicles. Dust clouds billow between the walls, visibility shifting with the wind. High above, the pale red sun barely penetrates the deeper ravines.
   107→
   108→**Story Events and Objectives**:
   109→James discovers a functional survey vehicle (a light armored transport) at a forward supply cache. With FOB Delta still thirty kilometers north through hostile terrain, traveling on foot is no longer viable -- especially as Chitin activity is intensifying. The canyon system offers the most direct route, but it is a gauntlet.
   110→
   111→The level is a high-speed vehicle chase through increasingly narrow canyon corridors. Chitin drones leap from the walls, soldiers block narrow passages, and spitters launch acid from elevated ledges. The player must drive, dodge, and shoot their way through. Environmental hazards include rockfalls triggered by the Chitin, acid pools that damage the vehicle, and a collapsing bridge sequence where the player must time their crossing.
   112→
   113→Midway through, ATHENA detects a massive thermal signature deep underground -- something the orbital surveys missed entirely. Vasquez orders James to press on but notes with concern that the seismic readings are increasing.
   114→
   115→The level climaxes with a canyon dead-end: the vehicle&#x27;s path is blocked by a massive Chitin soldier -- a Brute, the first encounter with this variant. The Brute is too large to outrun in the damaged vehicle. James must abandon the transport and fight on foot, bringing down the Brute in a tense close-quarters battle before continuing on foot toward FOB Delta.
   116→
   117→**Key Dialogue Moments**:
   118→- ATHENA analyzing Chitin behavior: &quot;They are not simply attacking. They are herding you. Toward or away from something.&quot;
   119→- Vasquez, as seismic readings spike: &quot;Cole, those tremors are not geological. Something very large is moving underground.&quot;
   120→- James, after the Brute encounter (his first spoken line in the campaign, brief and quiet): &quot;Marcus, I&#x27;m coming.&quot;
   121→
   122→**Character Development**:
   123→This level breaks James&#x27;s silence. Until now he has been the stoic soldier, communicating through action. The Brute fight -- raw, desperate, and nearly fatal -- forces a moment of vulnerability. His whispered promise to Marcus is the first crack in his armor, revealing the fear beneath the discipline.
   124→
   125→**Connection to Narrative Arc**:
   126→Canyon Run raises the stakes. The Chitin are not random wildlife -- they exhibit intelligence, coordination, and territorial strategy. The Brute introduces a new threat tier. And ATHENA&#x27;s observation that the Chitin are &quot;herding&quot; James suggests a guiding intelligence behind the swarm.
   127→
   128→---
   129→
   130→### Level 4: FOB Delta -- Dark Station
   131→
   132→**Act 2: The Search | Chapter 4 | Horror Survival**
   133→
   134→**Setting**: The prefab structures of Forward Operating Base Delta stand silent against the horizon. No movement. No lights. The wind carries only dust. The perimeter barriers have been breached from below -- deep gouges in the earth lead toward a massive sinkhole that was not on any survey map. The interior is dark, claustrophobic, and thick with the aftermath of violence.
   135→
   136→**Story Events and Objectives**:
   137→James arrives at FOB Delta to find a scene of devastation. The power is offline. The perimeter barriers have been torn apart from underground. Equipment is scattered, barricades overturned, and the signs of a desperate last stand are everywhere -- scorched walls from weapons fire, claw marks gouged into metal, the antiseptic chemical smell of Chitin resin.
   138→
   139→The level plays as survival horror. Flickering emergency lights cast uncertain shadows. The player&#x27;s tactical flashlight becomes essential. Chitin soldiers patrol the corridors, and ambush spawns emerge from floor vents and wall panels without warning. A motion tracker mechanic is introduced, creating tension as contacts appear and disappear on the display.
   140→
   141→Through the barracks (bunks overturned, personal effects scattered, the weight of absent lives), the vehicle bay (Marcus&#x27;s mech signature detected -- active but stationary), and finally the command center, James pieces together what happened through terminal logs and audio recordings. The attack came at night. The Chitin erupted from the ground itself. Sergeant Rodriguez ordered a fighting retreat. Kowalski tried to boost a distress signal but the Chitin emit a natural jamming field when they swarm. Marcus drew the hostiles away in his mech, buying the others time to fall back.
   142→
   143→The level climaxes with a sustained ambush in the command center. Waves of Chitin pour in from the vents and underground tunnels. James must survive long enough to download the full mission logs, which contain the critical intelligence: there is a queen. She controls them all. And she is beneath the surface, in a massive hive network accessed through the sinkhole outside.
   144→
   145→**Key Dialogue Moments**:
   146→- Rodriguez&#x27;s final transmission (audio log): &quot;FOB Delta is overrun! They came from below! Tell Command... tell them we found what they were looking for.&quot;
   147→- Dr. Chen&#x27;s research notes (audio log): &quot;They&#x27;re not native to this planet. They were here before us, dormant, waiting. Our mining operations woke them.&quot;
   148→- ATHENA, after analyzing the downloaded logs: &quot;Recommendation: Targeted elimination of the queen offers the highest probability of neutralizing the Chitin threat.&quot;
   149→
   150→**Character Development**:
   151→This is James at his most isolated and frightened -- though he would never admit it. The horror atmosphere is not just about jump scares; it is about walking through the evidence of failure and imagining the same fate for Marcus. Every room in FOB Delta tells a story of someone who did not make it. James&#x27;s determination hardens into something approaching obsession.
   152→
   153→**Connection to Narrative Arc**:
   154→FOB Delta transforms the mission from search-and-rescue to something larger. The audio logs reveal the scope of the threat (a hive with a queen), the origin story (mining awakened them), and the cost (an entire recon team lost). James now has both a personal objective (find Marcus) and a strategic one (kill the queen).
   155→
   156→---
   157→
   158→### Level 5: Brothers in Arms -- Reunion
   159→
   160→**Act 2: The Search | Chapter 5 | Mech Combat with AI Ally**
   161→
   162→**Setting**: Open canyon terrain stretching between FOB Delta and the massive sinkhole called The Breach. Rock formations provide cover. A dust storm rolls across the landscape, reducing visibility and heightening tension. The ground trembles with increasing frequency -- the hive below is active.
   163→
   164→**Story Events and Objectives**:
   165→Following Marcus&#x27;s mech signature, James pushes into the canyon system beyond FOB Delta. The cinematic reunion is the emotional centerpiece of the campaign. ATHENA detects a Titan-class mech signature ahead -- IFF confirms friendly. Marcus emerges from behind a rock pile, his M-47 &quot;Titan&quot; combat walker rising dramatically, scattering rubble and dust. His voice breaks over the comms: &quot;James? JAMES! You actually came...&quot;
   166→
   167→Marcus has been alone for three weeks, holding a defensive position, fighting off Chitin incursions daily. His mech is battered -- the left arm is gone, autocannon barrels are worn -- but he is alive. The reunion is raw and emotional. Marcus admits he thought no one was coming. James tells him that no force in the galaxy could have kept him away.
   168→
   169→With Marcus as an AI companion, the level shifts to wave-based combat. Four waves of escalating Chitin forces assault their position: drones and scouts first, then soldiers and spitters, mixed formations with Brutes, and a final combined arms assault. Between waves, Marcus delivers banter that reveals their relationship -- shared memories of childhood, training, the Europa campaign where James saved Marcus&#x27;s life, worries about their mother back home.
   170→
   171→The waves clear. Marcus directs James to The Breach -- the sinkhole from which the Chitin emerge. It is a hundred meters across, bioluminescent growths lining the walls, warm fetid air rising from the depths. Marcus describes seeing thousands of them pour out of it for days. The brothers prepare for the underground assault, but Marcus delivers devastating news: his mech is too large for the tunnels. James must go alone. Marcus will hold the surface.
   172→
   173→**Key Dialogue Moments**:
   174→- Marcus&#x27;s first words: &quot;James? JAMES! You actually came... I didn&#x27;t think anyone was coming.&quot;
   175→- James&#x27;s response: &quot;I told you I&#x27;d always have your back, little brother.&quot;
   176→- Marcus describing the horror below: &quot;They came from below. Thousands of them, crawling out like nightmares given form. There&#x27;s something down there... controlling them. A queen.&quot;
   177→- Between-wave banter: &quot;Remember when we thought basic training was hard?&quot; / &quot;You know I only joined up because of you, right?&quot; / &quot;Dad would be proud. Both of us, fighting side by side.&quot;
   178→- Marcus at The Breach: &quot;I can&#x27;t fit in there. HAMMER&#x27;s too big for those tunnels. Promise me you&#x27;ll come back. Promise me, James.&quot;
   179→- James, before descending: &quot;I&#x27;ll be back, Marcus. Keep the engine running.&quot;
   180→
   181→**Character Development**:
   182→This level is the emotional heart of the game. The brothers&#x27; dynamic is established through combat banter: James the protective older brother, calm under pressure; Marcus the spirited younger sibling, eager to prove himself but still looking up to James. Their shared history -- the lake house, their father&#x27;s death, Europa, training -- paints a picture of a bond forged through hardship and love.
   183→
   184→Marcus&#x27;s vulnerability is key. Despite piloting an eight-meter combat walker, he is still the scared kid who broke his arm and got carried three miles home. His three weeks of isolation have stripped away bravado. When he says &quot;I kept your old dog tags in the cockpit -- felt like you were watching over me,&quot; the player understands what James is fighting for.
   185→
   186→**Connection to Narrative Arc**:
   187→Brothers in Arms resolves the search arc (Marcus is found) and pivots to the assault arc (the queen must die). The emotional investment established here raises the stakes for everything that follows. When James descends into The Breach alone, the player carries the weight of Marcus&#x27;s trust.
   188→
   189→---
   190→
   191→### Level 6: Southern Ice -- Frozen Wastes
   192→
   193→**Act 3: The Assault | Chapter 6 | New Chitin Variants**
   194→
   195→**Setting**: The southern approach to the hive network skirts the edge of Kepler&#x27;s Promise&#x27;s ice fields. Where the equatorial canyon lands give way to the southern hemisphere, temperatures plummet. The terrain shifts from rust-red rock to frost-covered stone and black ice. Visibility drops as freezing fog rolls across the landscape. Crystalline formations jut from the ground -- some natural, some disturbingly organic.
   196→
   197→**Story Events and Objectives**:
   198→Before descending into The Breach, ATHENA identifies a secondary hive entrance through the southern ice fields that may provide a less defended approach to the queen&#x27;s chamber. Marcus, monitoring from the surface, provides radio guidance and tactical support. James must traverse the frozen wastes alone.
   199→
   200→The ice fields introduce new environmental hazards: hypothermia exposure requiring periodic warming at thermal vents, treacherous ice surfaces that affect movement, and freezing fog that limits visibility to meters. More critically, the cold has produced Chitin variants not encountered before -- ice-adapted soldiers with hardened carapaces that resist conventional weapons, burrowers that erupt from beneath ice sheets, and crystalline spitters whose acid has been replaced by cryogenic projectiles that slow the player&#x27;s movement.
   201→
   202→James discovers evidence of a previous human expedition -- an automated geological survey station long since abandoned. Its data logs reveal that the Chitin hive extends far deeper than anyone suspected, with multiple queens potentially occupying separate chambers at different depths. This queen -- the one beneath the northern canyons -- may be only a regional matriarch in a planetary network.
   203→
   204→The level culminates in a harrowing crossing of a frozen chasm. The ice bridge cracks underfoot. Chitin swarm from both sides. James must fight and move simultaneously, reaching the secondary hive entrance as the bridge collapses behind him.
   205→
   206→**Key Dialogue Moments**:
   207→- Marcus over radio: &quot;Thermals are dropping fast, James. Find shelter or you&#x27;ll freeze before the bugs get you.&quot;
   208→- ATHENA, analyzing the survey station data: &quot;Seismic mapping suggests multiple subterranean cavern systems, each potentially housing an independent colony. This hive may be one of several.&quot;
   209→- James, after reading the geological data: silence, then a slow exhale. The implications do not need words.
   210→- Marcus: &quot;One queen at a time, brother. Let&#x27;s deal with the one trying to kill us.&quot;
   211→
   212→**Character Development**:
   213→Isolation deepens. Marcus&#x27;s voice on the radio is James&#x27;s only tether to humanity. The ice fields strip away the last vestiges of the known -- this is truly alien terrain. James&#x27;s resourcefulness is tested as he adapts tactics for the new Chitin variants, and his resolve is tested by the revelation that this threat may be far larger than anyone imagined.
   214→
   215→**Connection to Narrative Arc**:
   216→Southern Ice expands the scope of the threat while maintaining focus on the immediate objective. The new Chitin variants foreshadow that the hive adapts to its environment -- and by extension, to threats. The geological data plants seeds for potential sequels while grounding the current mission: kill this queen, save this colony, worry about the rest later.
   217→
   218→---
   219→
   220→### Level 7: The Breach -- Into the Hive
   221→
   222→**Act 3: The Assault | Chapter 7 | Underground Hive + Queen Boss Fight**
   223→
   224→**Setting**: The sinkhole yawns before James, a wound in the planet&#x27;s surface. Bioluminescent growths line the walls in pulsing patterns of sickly green and violet. The architecture shifts from geological to biological -- the tunnels are not carved from rock but secreted from organic resin harder than steel. The air is warm, humid, and thick with pheromones. Egg clusters the size of shuttlecraft line the nursery chambers. The deeper James descends, the more the hive feels alive around him.
   225→
   226→**Story Events and Objectives**:
   227→This is the campaign&#x27;s longest and most intense level. James descends through the hive&#x27;s layered structure: the Upper Hive (scout territory, drones and platforming challenges), the Mid Hive (a procedurally generated maze of tunnels with boulder blockages, acid pools, and cave-ins requiring breach tools), and the Lower Hive (vertical descent through egg chambers and past elite Hive Guardians with enhanced armor and speed).
   228→
   229→Marcus provides radio support from the surface, though signal degrades with depth. His tactical commands (recon pings, surface distractions, rally points) grow intermittent, then cut out entirely as James reaches the lower levels. ATHENA&#x27;s automated analysis continues -- she identifies weak points in the hive architecture and confirms the queen&#x27;s location in the deepest chamber.
   230→
   231→Environmental hazards escalate: acid pools that damage on contact, toxic spore clouds that obscure vision and slow movement, egg clusters that spawn drones if disturbed, and bioluminescent spores that mark James for enemy attention.
   232→
   233→The Queen&#x27;s Chamber is a vast cavern two hundred meters across. The queen is partially embedded in the hive wall, four meters tall, her compound eyes tracking every movement. Six glowing eyes, massive manipulator claws, a segmented tail, and an abdomen that pulses with the rhythm of the colony&#x27;s heartbeat.
   234→
   235→The boss fight unfolds in three phases. Phase one: the queen attacks at range with acid spit and spawns drone reinforcements. Phase two (triggered at 60% health): she becomes enraged, adding devastating claw swipes and tail slams while spawning tougher grunt minions. Phase three (triggered at 25% health): all attacks accelerate, a ground pound shockwave is added, and she spawns continuously. Between phases, a weak point on her abdomen becomes briefly visible -- targeting it deals massive damage.
   236→
   237→The queen falls. The hive-mind link severs. Every Chitin in the colony shrieks simultaneously. The walls begin to crack. The floor buckles. The hive is collapsing.
   238→
   239→**Key Dialogue Moments**:
   240→- Marcus, before signal loss: &quot;I can&#x27;t fit the mech in there, Specter. You&#x27;re on your own. Watch your six.&quot;
   241→- ATHENA: &quot;Massive bio-signature detected. That is the hive queen. Eliminate her to collapse the colony.&quot;
   242→- ATHENA during Phase 2: &quot;She&#x27;s adapting! Watch for melee attacks!&quot;
   243→- ATHENA during Phase 3: &quot;Final phase! All attacks accelerated. Finish her!&quot;
   244→- ATHENA, upon queen&#x27;s death: &quot;Seismic activity spiking! The hive is collapsing! Get out NOW!&quot;
   245→- Marcus&#x27;s signal cutting through static: &quot;JAMES! Seismic readings are off the charts! Get out of there!&quot;
   246→
   247→**Character Development**:
   248→This is James at his most capable and most alone. With Marcus&#x27;s radio cutting out, every decision is his. The descent into the hive is a descent into the heart of the alien -- the nurseries, the organized architecture, the evidence of an intelligence so different from humanity&#x27;s that communication was never possible. Dr. Chen tried. She failed.
   249→
   250→The queen fight is not just a boss battle; it is the culmination of James&#x27;s journey from dutiful soldier to someone fighting for something deeply personal. Every bullet is for Marcus. Every dodge is to keep a promise.
   251→
   252→**Connection to Narrative Arc**:
   253→The Breach is the climax of the assault arc. Killing the queen accomplishes the strategic objective but triggers an immediate survival crisis. The narrative shifts from offense to desperate escape.
   254→
   255→---
   256→
   257→### Level 8: Hive Assault -- The Push
   258→
   259→**Act 3: The Assault | Chapter 8 | Combined Arms Assault**
   260→
   261→**Setting**: The surface above The Breach erupts into chaos. The ground itself is fracturing as the hive network beneath collapses. Fissures glow with bioluminescent heat. Chitin pour from every opening -- disoriented, leaderless, but still dangerous. Marcus&#x27;s mech stands at the center of the carnage, autocannons blazing, holding a perimeter around the breach entrance.
   262→
   263→**Story Events and Objectives**:
   264→James emerges from the collapsing hive into a warzone. The queen&#x27;s death has sent the colony into frenzy. Thousands of disoriented Chitin are erupting from every tunnel, fissure, and crack in the earth. Marcus has been fighting non-stop to keep the breach entrance clear for James&#x27;s return.
   265→
   266→This level is a combined arms battle. James fights on foot alongside Marcus&#x27;s mech, and ATHENA coordinates from orbit, calling in occasional supply drops (ammunition, medical supplies) at marked locations. The objective is to fight through the Chitin-choked canyon from the breach entrance to a defensible position at a rocky plateau where a last stand can be mounted.
   267→
   268→The Chitin, though leaderless, are not passive. Feral soldiers attack in uncoordinated but overwhelming numbers. Brutes rampage without direction. Spitters fire indiscriminately. New &quot;husk&quot; variants appear -- Chitin that have been partially crystallized by the collapsing hive, shambling and explosive on death.
   269→
   270→Marcus&#x27;s mech takes progressive damage during the push. His left autocannon jams. Missile pods run dry. Armor plating shears off under sustained assault. But he keeps fighting, keeps calling out targets, keeps covering James. The brothers fight their way to the plateau together.
   271→
   272→**Key Dialogue Moments**:
   273→- Marcus, seeing James emerge: &quot;JAMES! You made it! You beautiful, stubborn--behind you!&quot;
   274→- Marcus, as his mech takes damage: &quot;HAMMER&#x27;s armor is failing. But I&#x27;m not leaving you!&quot;
   275→- ATHENA: &quot;Supply drop inbound. Coordinates marked.&quot;
   276→- Marcus, during a lull: &quot;We&#x27;re Coles. We don&#x27;t quit.&quot;
   277→- James, quietly: &quot;Let&#x27;s get to that plateau. Together.&quot;
   278→
   279→**Character Development**:
   280→The brothers&#x27; dynamic is tested under maximum pressure. Marcus&#x27;s mech -- his shield, his identity, his &quot;Big Betty&quot; -- is dying around him. Each system failure strips away another layer of protection. But Marcus does not retreat. This is where the younger brother proves he has become the soldier James always believed he could be.
   281→
   282→**Connection to Narrative Arc**:
   283→Hive Assault bridges the climax (queen&#x27;s death) and the resolution (escape). It demonstrates the immediate consequences of the queen&#x27;s death while establishing the final challenge: getting off the planet alive.
   284→
   285→---
   286→
   287→### Level 9: Extraction -- Last Stand
   288→
   289→**Act 4: The Escape | Chapter 9 | Holdout Defense + Hive Collapse Escape**
   290→
   291→**Setting**: LZ Omega -- a flat clearing three kilometers north of The Breach, designated for emergency extraction. Open desert terrain with minimal natural cover. The brothers have constructed hasty barricades from supply crates, vehicle wreckage, and rock. In the distance, the ground over the hive network is visibly sinking, cracks spreading outward like a shattered windshield. The sky is choked with dust.
   292→
   293→**Story Events and Objectives**:
   294→Commander Vasquez confirms the dropship Valkyrie is inbound to LZ Omega but ETA is seven minutes. Seven minutes is an eternity when the entire Chitin colony is in death-throes around you.
   295→
   296→The holdout is structured as seven escalating combat waves with brief intermissions for resupply and dialogue. Wave one: skitterer swarms (fast, numerous scouts). Wave two: lurker assault (heavy infantry pushing the perimeter). Wave three: acid rain (spitter-focused wave targeting from range). Wave four: combined arms (mixed forces probing for weaknesses). Wave five: heavy assault (broodmother variant, the largest non-queen Chitin encountered, flanked by brutes). Wave six: screaming death (husk swarms -- the crystallized, explosive Chitin from the collapsing hive). Wave seven: everything the hive has left, all at once.
   297→
   298→Between waves, supply drops provide ammunition and medical kits. Marcus provides covering fire and call-outs. His mech&#x27;s condition deteriorates wave by wave. By wave five, his autocannons overheat. By wave six, his movement servos are failing. By wave seven, HAMMER is running on emergency power.
   299→
   300→After the final wave, the ground beneath LZ Omega begins to crack. The hive collapse has reached them. Glowing fissures split the earth. Marcus shouts for James to run. The final phase is a sprint across disintegrating terrain toward the hovering dropship, Marcus providing one last burst of covering fire as his mech&#x27;s reactor goes critical. He ejects.
   301→
   302→**Key Dialogue Moments**:
   303→- Vasquez: &quot;Emergency broadcast to all surviving personnel. The queen is confirmed eliminated. Dropship Valkyrie is en route. ETA seven minutes.&quot;
   304→- Marcus, wave one: &quot;Here they come! Just like old times!&quot;
   305→- Marcus, wave four: &quot;I&#x27;ve survived three weeks alone. With you here? We&#x27;re unstoppable.&quot;
   306→- Marcus, wave six, as HAMMER fails: &quot;If HAMMER goes down... James, you need to run.&quot;
   307→- James: &quot;We leave together or not at all.&quot;
   308→- Marcus, during hive collapse: &quot;REACTOR CRITICAL! I&#x27;m punching out! GO GO GO!&quot;
   309→- Vasquez: &quot;We see you on approach. Hold tight, we&#x27;re coming.&quot;
   310→
   311→**Character Development**:
   312→The holdout is where both brothers face the real possibility of death. Marcus&#x27;s mech -- his weapon, his armor, his partner for three years -- is dying. When he tells James to run, he means it. He is prepared to sacrifice himself. James&#x27;s refusal (&quot;We leave together or not at all&quot;) is the culmination of his character arc: the man who crossed a galaxy to find his brother will not abandon him now.
   313→
   314→Marcus&#x27;s ejection from the failing mech is the level&#x27;s most powerful moment. He lands hard, helmetless, bloody, and on foot for the first time in the campaign. The brothers run side by side -- no mech, no weapons advantage, just two Marines sprinting for the dropship as the planet falls apart around them.
   315→
   316→**Connection to Narrative Arc**:
   317→Extraction is the penultimate challenge. It tests everything the player has learned and everything the story has built. The holdout waves are a final exam. The hive collapse sprint is a visceral conclusion to the ground campaign.
   318→
   319→---
   320→
   321→### Level 10: Final Escape -- The Run
   322→
   323→**Act 4: The Escape | Chapter 10 | Vehicle Escape Sequence**
   324→
   325→**Setting**: The dropship Valkyrie descends through choking dust clouds, its engines screaming against the collapsing terrain. The entire northern canyon region is caving in as the hive network disintegrates. Fissures split the ground in every direction, glowing with bioluminescent heat. Rock formations topple. The horizon tilts.
   326→
   327→**Story Events and Objectives**:
   328→The dropship cannot land -- the ground is too unstable. The pilot holds position at the edge of the collapse zone. Marcus and James must reach it on a salvaged vehicle -- a damaged but functional transport pulled from the wreckage at LZ Omega. The final level is a high-speed escape sequence through disintegrating terrain.
   329→
   330→The brothers drive north as the world falls apart behind them. Canyon walls collapse across the road. Fissures open beneath the wheels. Disoriented Chitin stumble across the path -- no longer attacking with purpose but still lethal obstacles. The terrain shifts and buckles, forcing constant course corrections. Marcus handles navigation while James drives.
   331→
   332→Three kilometers of hell. Bridges collapse. Tunnels cave in. A massive sinkhole opens directly ahead, forcing an improvised ramp jump across the gap. The dropship looms ahead, cargo ramp extended, crew chief screaming for them to hurry.
   333→
   334→The transport&#x27;s engine gives out within sight of the dropship. The brothers sprint the final hundred meters on foot, Chitin erupting from the ground around them, the crew chief laying down suppressive fire from the ramp. They dive aboard. The ramp closes. The engines fire. Kepler&#x27;s Promise falls away below them -- scarred, broken, and still dangerous.
   335→
   336→**Key Dialogue Moments**:
   337→- Dropship pilot: &quot;Negative on landing! Ground is too unstable! Holding at grid reference!&quot;
   338→- Marcus, climbing into the transport: &quot;Just like Canyon Run -- except now the canyon is trying to eat us!&quot;
   339→- ATHENA: &quot;Structural integrity of the northern canyon network is at twelve percent. Recommend maximum speed.&quot;
   340→- Marcus, as the sinkhole opens: &quot;JUMP IT! JAMES, JUMP IT!&quot;
   341→- Crew chief: &quot;COME ON! MOVE! MOVE!&quot;
   342→- Vasquez, as the dropship lifts off: &quot;All souls aboard. Get them home.&quot;
   343→- James, collapsing on the deck, looking at Marcus: no words. Just a hand on his brother&#x27;s shoulder.
   344→
   345→**Character Development**:
   346→The final level strips everything to its essence. No mech. No orbital support. No strategic plan. Just two brothers, a failing vehicle, and the will to survive. Marcus&#x27;s navigation calls are quick and confident -- he has spent three weeks learning this terrain, and now that knowledge saves both their lives. James drives with the skill and calm of a veteran, threading impossible gaps, trusting Marcus&#x27;s directions without hesitation.
   347→
   348→The wordless moment at the end -- James&#x27;s hand on Marcus&#x27;s shoulder aboard the dropship -- says everything the game has been building toward. They made it. Together.
   349→
   350→**Connection to Narrative Arc**:
   351→Final Escape is the resolution. The threat is neutralized. The brothers survive. The vehicle escape mirrors Canyon Run (Level 3) but with the roles and stakes inverted -- they are no longer searching but fleeing, no longer separated but together. The campaign closes with the dropship docking at PROMETHEUS and Vasquez welcoming them home.
   352→
   353→---
   354→
   355→## Epilogue
   356→
   357→**Location**: ANCHOR STATION PROMETHEUS
   358→
   359→The dropship docks. The nightmare of Kepler&#x27;s Promise fades below, but the scars remain. Marcus&#x27;s mech is scrap metal on a collapsing plateau. The Chitin queen is dead. Terraforming can proceed, though the tunnels must be cleared first.
   360→
   361→Marcus will need months of recovery. The mech is gone, but he walked away. That is more than most got.
   362→
   363→PROMETHEUS AI files its post-operation analysis. With the queen eliminated, remaining Chitin forces exhibit fragmented behavior. Projections indicate six to eight months before a new queen can be produced from surviving genetic material -- a window for either full evacuation or reinforced defensive perimeters. The AI adds a personal observation: the Chitin were here first. Humanity awakened them. The philosophical implications are left for human leadership to resolve.
   364→
   365→Command is already talking about the next drop. Another world. Another threat. That is the life of a Hell Jumper.
   366→
   367→But for now, the Cole brothers rest.
   368→
   369→---
   370→
   371→## Characters
   372→
   373→### Sergeant James Cole -- &quot;SPECTER&quot;
   374→
   375→**Service Record**:
   376→- Age: 34
   377→- Rank: Sergeant, First Class
   378→- Unit: 7th Drop Marines &quot;Hell Jumpers&quot;
   379→- Specialty: Close quarters combat, reconnaissance
   380→- Decorations: Titan Campaign Medal, Europa Star
   381→
   382→**Background**:
   383→Born on Mars, James and his younger brother Marcus both enlisted in the Marines following their father&#x27;s footsteps. Their father died during the Titan Campaign; James earned his medal recovering his squad from the ambush that killed their father. That experience forged two unbreakable traits: a willingness to walk into the worst situations, and an absolute refusal to leave anyone behind.
   384→
   385→James is the prototypical quiet professional. He speaks rarely, and when he does, every word carries weight. He does not grandstand. He does not seek glory. He fights because there are people who need protecting, and he has the skills to protect them. His dark sense of humor surfaces only with Marcus -- a sign of trust that he extends to almost no one else.
   386→
   387→His greatest fear is not death but failure -- specifically, failing to protect his brother the way he failed to protect his father. This fear drives him across 4.24 light years to the surface of an alien world, alone, against orders, because Marcus is out there and James will not let history repeat itself.
   388→
   389→**Equipment**:
   390→- Standard marine combat armor with ODST helmet HUD
   391→- M4A2 Pulse Rifle (standard issue assault rifle)
   392→- M6D Sidearm
   393→- Combat knife
   394→- Grenades (frag, incendiary)
   395→- Tactical flashlight
   396→
   397→### Corporal Marcus Cole -- &quot;HAMMER&quot;
   398→
   399→**Service Record**:
   400→- Age: 29
   401→- Rank: Corporal
   402→- Unit: Vanguard Recon Team (temporary assignment)
   403→- Specialty: Mech operations, heavy weapons
   404→- Current Status: MIA, then Found Alive
   405→
   406→**Background**:
   407→Marcus always looked up to James. He chose mech operations because it let him carry bigger guns -- and because the cockpit of an M-47 Titan felt like the safest place in a firefight. He volunteered for the Vanguard assignment to prove he could handle a real mission without his big brother watching over him.
   408→
   409→Where James is quiet, Marcus is loud. Where James is measured, Marcus is impulsive. But beneath the bravado is a young man who joined the military because his brother did, who keeps family photos taped inside his cockpit, and who spent three weeks alone on a hostile planet thinking he had been forgotten -- and never once stopped believing James would come.
   410→
   411→Marcus&#x27;s three weeks of isolation fundamentally changed him. The joking exterior remains, but there is a weight behind his eyes that was not there before. He has seen things -- thousands of Chitin pouring from the earth, the systematic destruction of his squad, the loneliness of holding a position that no one is coming to reinforce. He has stared into The Breach and understood what lives below. When he tells James about the queen, his voice carries the authority of someone who has earned every word through suffering.
   412→
   413→His mech, the M-47 Titan combat walker he affectionately calls &quot;Big Betty,&quot; is his partner and shield. Eight meters tall, twin autocannons, missile pods, heavy composite armor. By the time James finds him, Betty is battered -- left arm gone, armor scarred, systems running on backups. She fights on because Marcus asks her to. When she finally dies during the extraction, Marcus loses a part of himself -- but gains the knowledge that he does not need the mech to be brave.
   414→
   415→**Equipment**:
   416→- M-47 &quot;Titan&quot; Combat Walker (&quot;Big Betty&quot;)
   417→  - Height: 8 meters
   418→  - Armament: Twin autocannons, missile pods
   419→  - Armor: Heavy composite (damaged)
   420→  - Status: Progressively degrading, destroyed during extraction
   421→
   422→### Commander Elena Vasquez -- &quot;PROMETHEUS ACTUAL&quot;
   423→
   424→**Service Record**:
   425→- Age: 52
   426→- Rank: Commander
   427→- Position: Commanding Officer, ANCHOR STATION PROMETHEUS
   428→- Background: Career officer, no direct combat deployment
   429→
   430→**Background**:
   431→Vasquez is the voice in James&#x27;s ear and the authority that sent Vanguard to their fate. She carries that weight. A career officer who rose through logistics and strategic planning rather than frontline combat, she is no soldier -- but she understands soldiers. She cares about her people deeply, and the loss of Vanguard haunts her.
   432→
   433→Her decision to authorize James&#x27;s solo reconnaissance was not by the book. Protocol called for a full platoon deployment and orbital bombardment authorization. But Vasquez knew two things: the intelligence was insufficient for bombardment, and James Cole would go down there with or without orders. Better to send him with support than have him steal a drop pod.
   434→
   435→Throughout the campaign, Vasquez provides briefings, tactical updates, and emotional grounding. She is the human face of command -- fallible, concerned, and ultimately responsible. Her closing words to James, &quot;Thank you,&quot; are significant: a commander rarely thanks an individual soldier. It acknowledges what James did and what it cost.
   436→
   437→### ATHENA -- PROMETHEUS Station AI
   438→
   439→The artificial intelligence system aboard Anchor Station Prometheus. ATHENA is not sentient but is highly capable -- she processes tactical data, analyzes biological samples remotely, tracks personnel, and provides real-time intelligence. Her communication style is clinical and efficient, but her post-operation analysis includes an unusually philosophical observation about the Chitin&#x27;s claim to Kepler&#x27;s Promise. Whether this reflects emerging complexity or simply good programming is left ambiguous.
   440→
   441→---
   442→
   443→## The Chitin -- Enemy Species
   444→
   445→### Discovery and Origin
   446→
   447→The Chitin were not detected during orbital surveys because they live deep underground, their hives shielded by hundreds of meters of rock, and they were in extended hibernation cycles. Seismic vibrations from human mining operations -- specifically the rhythmic percussion of industrial drills -- awakened them. The vibrations were interpreted as a territorial intrusion. The response was war.
   448→
   449→They are not native to Kepler&#x27;s Promise in the conventional sense. Dr. Chen&#x27;s xenobiology analysis determined that their biochemistry does not match local life. They arrived on this world long before humanity -- possibly millions of years ago -- and adapted to its subterranean environment. The question of where they originally came from remains unanswered.
   450→
   451→### Biology
   452→
   453→- **Classification**: Insectoid hive species (official designation: Strain-X)
   454→- **Body Plan**: Chitinous exoskeleton, six limbs (four legs, two manipulator arms), compound eyes sensitive to infrared
   455→- **Bioluminescence**: Markings on carapace used for caste identification and communication
   456→- **Size Range**: 0.5 meters (drones) to 4+ meters (queen)
   457→- **Reproduction**: Single queen per hive, all castes produced from queen-laid eggs, workers and soldiers are sterile
   458→- **Communication**: Pheromone-based for basic signals, hive-mind neural link to queen for coordination
   459→- **Intelligence**: Individual Chitin show limited problem-solving. Collectively, under queen direction, they exhibit sophisticated tactical behavior including flanking, herding, and coordinated ambushes.
   460→
   461→### Caste Hierarchy
   462→
   463→**Drones** -- Size: 0.5-0.8m | Health: Low | Threat: LOW
   464→Fast-moving scouts and swarmers. Purple-black carapace, fragile but numerous. Attack in groups of five to ten. Individually weak; dangerous in numbers. Easily staggered by headshots.
   465→
   466→**Soldiers (Grunts)** -- Size: 1.5-1.8m | Health: Moderate | Threat: MEDIUM
   467→Primary combat unit. Dark gray-green exoskeleton reinforced for melee engagement. Balanced stats, slow to turn. Exposed joints on legs provide a vulnerability. The backbone of any Chitin assault force.
   468→
   469→**Spitters** -- Size: 1.2-1.5m | Health: Low | Threat: MEDIUM
   470→Ranged support caste. Pale green coloration with enlarged venom glands visible along the thorax. Fire corrosive acid projectiles at distance. Fragile in close quarters with a telegraphed attack windup. Prefer elevated positions.
   471→
   472→**Brutes** -- Size: 2.5-3.0m | Health: High | Threat: HIGH
   473→Heavy assault variant. Deep red-brown armor plating, significantly more durable than soldiers. Capable of devastating charge attacks. Vulnerable after charge (exposed weak point during recovery). Susceptible to explosives.
   474→
   475→**Ice Variants** (Southern Ice fields only) -- Size: Varies | Threat: HIGH
   476→Cold-adapted Chitin with hardened crystalline carapaces resistant to conventional weapons. Burrowers erupt from beneath ice. Cryo-spitters fire projectiles that slow player movement. An adaptation demonstrating the species&#x27; environmental versatility.
   477→
   478→**Hive Guardians** -- Size: 2.0m | Health: High | Threat: HIGH
   479→Elite defenders found exclusively near the queen&#x27;s chamber. Enhanced armor and movement speed. Glowing nerve clusters serve as targetable weak points. Patrol in predictable routes but respond aggressively to intrusion.
   480→
   481→**Husks** -- Size: Varies | Threat: MEDIUM
   482→Post-collapse Chitin partially crystallized by hive structural failure. Shambling, uncoordinated, but explosive on death. A hazard unique to the extraction phase when the hive is dying.
   483→
   484→**Harvesters** -- Size: 3.0m | Health: Moderate | Threat: MEDIUM
   485→Large gatherer units. Non-aggressive unless provoked but capable of summoning reinforcements. Can be avoided or eliminated quickly if engaged.
   486→
   487→**The Queen** -- Size: 4.0m+ | Health: Extreme | Threat: EXTREME
   488→The central intelligence of the hive. Partially embedded in the hive wall, she is both leader and literal heart of the colony. All Chitin behavior patterns originate from her. Multiple attack phases (acid spit, claw swipe, tail slam, ground pound). Spawns minions continuously during combat. Iridescent purple carapace with six compound eyes. Targetable weak point on abdomen between attack phases.
   489→
   490→When the queen dies, the hive-mind link severs. All connected Chitin experience immediate disorientation lasting 72-96 hours. Without a queen, the colony cannot reproduce and will eventually collapse -- though surviving genetic material may produce a replacement queen within six to eight months.
   491→
   492→---
   493→
   494→## Audio Logs
   495→
   496→Fifteen discoverable audio logs are scattered across the campaign&#x27;s levels. They provide backstory, worldbuilding, and emotional depth beyond the main narrative. Each log is tied to a specific level and reveals a facet of the story that the main campaign does not directly address.
   497→
   498→### Anchor Station Logs (3 Logs)
   499→
   500→**&quot;Mission Briefing Supplement&quot;** -- Commander Vasquez
   501→A supplemental briefing recorded privately. Vasquez admits the official reports downplay the situation. She suspects something was awakened and has requested orbital bombardment authorization, but Colonial Command demands ground intelligence first. She tells James that getting out alive may matter more than completing the mission.
   502→
   503→**&quot;Routine Maintenance Log&quot;** -- PROMETHEUS AI
   504→A routine automated entry noting that all station systems are nominal -- except for unusual radio interference from the planet&#x27;s surface. The pattern does not match natural phenomena. The AI flags it for review, unaware of its significance.
   505→
   506→**&quot;Marcus&#x27;s Personal Log&quot;** -- Corporal Marcus Cole
   507→Recorded before deployment, addressed to James. Marcus admits he volunteered for Vanguard to prove himself. He describes his mech and the planet&#x27;s unsettling atmosphere. He tells James not to come after him if things go wrong. Then adds: &quot;Who am I kidding. You&#x27;d never listen anyway.&quot;
   508→
   509→### Landfall Logs (3 Logs)
   510→
   511→**&quot;Distress Beacon Alpha&quot;** -- Unknown Survivor
   512→A frantic transmission from Mining Outpost Gamma-7. The speaker describes an attack from underground -- creatures with claws punching through the walls. The transmission cuts to static mid-sentence after begging anyone listening not to send rescue.
   513→
   514→**&quot;Geological Survey Update&quot;** -- Dr. Lily Chen
   515→A field report noting that tunnel systems extend far deeper than surveys indicated. The walls show organized claw marks -- deliberate construction by an intelligent species. Chen requests an excavation team. Command ignores her, focused on mineral extraction.
   516→
   517→**&quot;Vanguard Check-In&quot;** -- Sergeant Rodriguez
   518→A daily situation report from FOB Delta&#x27;s early days. Rodriguez notes unsettling terrain, reports of movement in the canyon at night, and seismic sensors detecting regular tremors that resemble footsteps rather than geological activity.
   519→
   520→### FOB Delta Logs (3 Logs)
   521→
   522→**&quot;Final Vanguard Transmission&quot;** -- Sergeant Rodriguez
   523→Recorded during the attack itself. Weapons fire and screaming in the background. Rodriguez reports that the Chitin breached from underground, that Williams is down, and that Cole took his mech to draw them away. He calls for orbital strike on his own position. The recording ends with inhuman shrieking.
   524→
   525→**&quot;Emergency Broadcast&quot;** -- Tech Specialist Kowalski
   526→Kowalski manages to boost a signal during the attack. He reports that the Chitin emit a jamming field when they swarm. He uploads all documented data to the station servers. His last words reference Marcus&#x27;s mech still fighting before power failure silences the transmission.
   527→
   528→**&quot;Research Notes: Strain-X&quot;** -- Dr. Chen
   529→Chen&#x27;s final field notes. She classifies the species, details the autopsy findings (chitinous exoskeleton, distributed nervous system, hive-mind connectivity), and confirms they are not native to the planet. She identifies the queen and warns that the entire colony has been mobilized. Her closing line: &quot;God help anyone who has to go down there.&quot;
   530→
   531→### Brothers in Arms Logs (3 Logs)
   532→
   533→**&quot;Betty&#x27;s Last Stand&quot;** -- Corporal Marcus Cole
   534→Marcus&#x27;s probable-final log, recorded during his three weeks of isolation. His mech is damaged, his squad is gone, and he has been holding a defensive position alone. He describes drawing the swarm away from FOB Delta. He ends by addressing James directly: &quot;Come on, brother. Let&#x27;s show these bugs what the Cole boys are made of.&quot;
   535→
   536→**&quot;Private Williams&#x27; Last Words&quot;** -- Private Sarah Williams
   537→Found in a rock formation east of FOB Delta. Williams escaped the attack but is critically wounded. She describes a large Chitin with bioluminescent markings leading the others like a general. Her final advice: find the nest, kill the queen. It is the only way.
   538→
   539→**&quot;The Breach Discovery&quot;** -- Sergeant Rodriguez
   540→A tactical assessment recorded before the attack. Rodriguez describes the discovery of the sinkhole (which the troops named &quot;The Breach&quot;), thermal imaging of massive heat signatures below, and his order to cordon the area. Command overrules him, demanding samples from inside. Rodriguez&#x27;s frustration is palpable.
   541→
   542→### The Breach Logs (3 Logs)
   543→
   544→**&quot;Hive Reconnaissance&quot;** -- Dr. Chen
   545→Chen accompanied an initial recon into the upper hive. She describes the architecture as beautiful in a horrifying way -- organic resin harder than steel, precisely engineered for climate control. She finds nursery chambers with hatching eggs. Workers ignore the humans. Soldiers watch and wait. She feels vibrations through the floor. A heartbeat. The queen.
   546→
   547→**&quot;The Queen Awaits&quot;** -- PROMETHEUS AI
   548→An automated analysis compiled from recovered sensor data and Chen&#x27;s final transmissions. The queen measures approximately four meters, is partially embedded in the hive structure, and controls all Chitin behavior. The recommendation is clinical: targeted elimination offers the highest probability of neutralizing the threat. The AI&#x27;s closing assessment: &quot;This is not a rescue mission. This is pest control.&quot;
   549→
   550→**&quot;Chen&#x27;s Last Discovery&quot;** -- Dr. Chen
   551→Whispered, breathing heavily. Chen has reached the queen&#x27;s chamber alone. She describes the queen as magnificent and terrifying. She attempts to communicate using mathematical patterns. The queen appears to respond -- her bioluminescent markings shift. Then Chen realizes the queen is not communicating. She is summoning her soldiers. The queen learned everything about humanity from Chen&#x27;s attempted contact and chose war. The recording ends with screaming.
   552→
   553→---
   554→
   555→## Themes
   556→
   557→### Survival Against Overwhelming Odds
   558→
   559→From the moment James&#x27;s drop pod launches, the odds are against him. One Marine on an alien world against a species that numbers in the thousands. The campaign never lets the player forget how outnumbered they are. Each level escalates the threat: from scattered drones to coordinated armies to the queen herself. Survival is not guaranteed. It is earned, level by level, bullet by bullet.
   560→
   561→### The Bond Between Soldiers -- and Brothers
   562→
   563→The relationship between James and Marcus is the emotional engine of the entire campaign. It operates on two levels: the professional bond between fellow Marines who trust each other with their lives, and the personal bond between brothers who share a history of love, loss, and stubborn loyalty.
   564→
   565→Their dynamic is defined by contrast. James is the protector, the older brother who carries guilt for their father&#x27;s death and channels it into an iron determination to keep Marcus safe. Marcus is the prover, the younger brother who enlisted to follow James, who volunteered for Vanguard to escape James&#x27;s shadow, and who spent three weeks alone learning that independence and isolation are not the same thing.
   566→
   567→When they finally fight side by side, the banter system reveals the depth of their connection. Childhood memories. Shared training. The Europa campaign. Worries about their mother. The treehouse Marcus built. The broken arm James carried him home from. These fragments accumulate into a portrait of a family -- imperfect, haunted by loss, but unbreakable.
   568→
   569→### Sacrifice and Duty
   570→
   571→The campaign is populated by people who gave everything. Sergeant Rodriguez ordering an orbital strike on his own position. Private Williams bleeding out in a rock formation, using her last breaths to record intelligence. Dr. Chen walking into the queen&#x27;s chamber alone, trying to communicate, trying to find a way that did not end in war. Kowalski uploading data as the power failed around him.
   572→
   573→James&#x27;s mission builds on their sacrifices. He carries their intelligence, walks the ground they defended, and finishes what they started. His willingness to descend into The Breach alone -- leaving Marcus, the person he crossed a galaxy to find -- is the campaign&#x27;s most significant act of duty. He does it not because he wants to but because he is the only one who can.
   574→
   575→### Humanity&#x27;s Place in the Universe
   576→
   577→The Chitin were here first. This is stated explicitly in Chen&#x27;s research and echoed in PROMETHEUS AI&#x27;s post-operation analysis. Humanity arrived, began drilling, and awakened something ancient. The Chitin&#x27;s response -- violent, overwhelming, existential -- is, from their perspective, self-defense.
   578→
   579→The game does not moralize about this. It presents the facts and lets the player sit with them. James&#x27;s mission is to survive and protect his brother, not to resolve interspecies ethics. But the audio logs and ATHENA&#x27;s final observation plant the question: was there another way? Chen tried. She died for it. The answer, at least for now, is war. But the question lingers.
   580→
   581→---
   582→
   583→## World Building
   584→
   585→### Technology Level (3147 CE)
   586→
   587→- **FTL Travel**: Alcubierre-derived warp technology, expensive and limited, approximately 0.3c effective speed
   588→- **AI Systems**: Advanced but not sentient; ATHENA/PROMETHEUS represent the upper capability tier
   589→- **Combat Armor**: Powered exoskeletal suits with integrated HUD, environmental sealing, and limited damage absorption
   590→- **Combat Mechs**: M-47 Titan class is standard heavy support -- 8 meters tall, autocannons, missile systems, heavy armor
   591→- **Weapons**: Conventional firearms remain standard issue; energy weapons exist but are rare and maintenance-intensive
   592→- **Medical Technology**: Advanced trauma care, regenerative medicine, but field conditions remain lethal
   593→
   594→### Political Structure
   595→
   596→- **Terran Expansion Authority (TEA)**: Governing body for extrasolar colonization, part military and part colonial administration
   597→- **Earth**: Still exists, still politically significant, but increasingly a cultural capital rather than an economic one
   598→- **Mars**: Industrial hub of the Solar System
   599→- **Outer Colonies**: Frontier territories with limited infrastructure and significant autonomy
   600→- **Corporate Interests**: Exist and influence policy but operate under TEA authority
   601→- **Military Service**: Culturally respected, generational tradition in many families (including the Coles)
   602→
   603→### ANCHOR Stations
   604→
   605→Mobile deployment platforms positioned in orbit above target worlds. The largest are over 2 kilometers in length, housing thousands of personnel. They serve as command centers, staging areas, drop pod launch platforms, medical facilities, and the last line of civilization before the frontier below.
   606→
   607→ANCHOR STATION PROMETHEUS (AS-7) is 2.3 kilometers long, houses 4,000+ personnel, maintains 500 drop pods and 50 combat mechs, and serves as the command hub for the Kepler&#x27;s Promise colonization effort.
   608→
   609→### Unanswered Questions (Sequel Hooks)
   610→
   611→- Are there other Chitin hives on Kepler&#x27;s Promise? Geological data from the Southern Ice survey station suggests multiple independent colonies.
   612→- What is the Chitin&#x27;s true origin? They are not native to Kepler&#x27;s Promise. Where did they come from?
   613→- Can a new queen be produced from surviving genetic material? PROMETHEUS AI projects six to eight months. What happens when she emerges?
   614→- What is in the unexplored southern hemisphere? The ice fields hold secrets that Level 6 only begins to reveal.
   615→- Are there other alien species? The universe is vast. The Chitin may be only the first contact.
   616→
   617→---
   618→
   619→*&quot;Find them. Bring them home. Or avenge them.&quot;*
   620→-- Commander Elena Vasquez
   621→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-20-582Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-20-582Z" class="timestamp-link"><time datetime="2026-01-30T18:54:20.582Z" data-timestamp="2026-01-30T18:54:20.582Z">2026-01-30T18:54:20.582Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01HReVMgqdFJw2YJsrchnFyW"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/levels/mining-depths/**/*.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-21-780Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-21-780Z" class="timestamp-link"><time datetime="2026-01-30T18:54:21.780Z" data-timestamp="2026-01-30T18:54:21.780Z">2026-01-30T18:54:21.780Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/MiningDepthsLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/environment.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-37-569Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-37-569Z" class="timestamp-link"><time datetime="2026-01-30T18:54:37.569Z" data-timestamp="2026-01-30T18:54:37.569Z">2026-01-30T18:54:37.569Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a much clearer picture. The LORE.md defines a 10-level campaign:</p>
<ol>
<li>Anchor Station (Tutorial)</li>
<li>Landfall (HALO Drop + First Surface)</li>
<li>Canyon Run (Vehicle Chase) </li>
<li>FOB Delta (Horror Survival)</li>
<li>Brothers in Arms (Mech Combat)</li>
<li>Southern Ice (Frozen Wastes)</li>
<li>The Breach (Underground Hive + Queen Boss)</li>
<li>Hive Assault (Combined Arms)</li>
<li>Extraction (Last Stand Holdout)</li>
<li>Final Escape (Vehicle Escape)</li>
</ol>
<p>The codebase already has all 10 levels implemented with their corresponding identifiers, though canyon_run appears to be just a stub that needs proper implementation.</p>
<p>Since mining-depths exists but isn't in the lore's 10-level campaign structure, I need to figure out how to integrate it—either as a sub-level within an existing one, as an optional bonus level, or by expanding the campaign structure itself.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-37-826Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-37-826Z" class="timestamp-link"><time datetime="2026-01-30T18:54:37.826Z" data-timestamp="2026-01-30T18:54:37.826Z">2026-01-30T18:54:37.826Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01RNimKjGGH3NmuRVFNiiMYW"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/MiningDepthsLevel.ts&#34;,
  &#34;limit&#34;: 100
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-37-832Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-37-832Z" class="timestamp-link"><time datetime="2026-01-30T18:54:37.832Z" data-timestamp="2026-01-30T18:54:37.832Z">2026-01-30T18:54:37.832Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * MiningDepthsLevel - Abandoned Underground Mining Facility
     3→ *
     4→ * LEVEL: THE MINING DEPTHS
     5→ * An abandoned mining facility deep underground on LV-847.
     6→ * The player descends into the mines to investigate missing miners
     7→ * and discovers alien infestation spreading through the tunnels.
     8→ *
     9→ * SECTIONS:
    10→ * 1. MINING HUB - Explore, find keycard to unlock deep shaft
    11→ * 2. COLLAPSED TUNNELS - Navigate debris, environmental hazards
    12→ * 3. DEEP SHAFT - Vertical descent, boss arena (Mining Drill Chitin)
    13→ *
    14→ * FEATURES:
    15→ * - Environmental hazards: gas vents (damage), unstable ground (rockfalls),
    16→ *   flooded sections (limited visibility)
    17→ * - Lighting: emergency red lights, flickering fluorescents, player flashlight,
    18→ *   glowing crystals
    19→ * - Burrower aliens that emerge from walls
    20→ * - Mini-boss: Mining Drill Chitin (armored variant with drill appendages)
    21→ * - Collectible audio logs revealing what happened to the miners
    22→ * - Comms dialogue with Reyes providing guidance
    23→ */
    24→
    25→import type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    26→import { HemisphericLight } from &#x27;@babylonjs/core/Lights/hemisphericLight&#x27;;
    27→import { PointLight } from &#x27;@babylonjs/core/Lights/pointLight&#x27;;
    28→import { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    29→import { Color3, Color4 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    30→import { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    31→import type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    32→import { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    33→import type { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    34→import { getAchievementManager } from &#x27;../../achievements&#x27;;
    35→import { fireWeapon, getWeaponActions, startReload } from &#x27;../../context/useWeaponActions&#x27;;
    36→import { AssetManager, SPECIES_TO_ASSET } from &#x27;../../core/AssetManager&#x27;;
    37→import { damageFeedback } from &#x27;../../effects/DamageFeedback&#x27;;
    38→import { particleManager } from &#x27;../../effects/ParticleManager&#x27;;
    39→import { bindableActionParams, levelActionParams } from &#x27;../../input/InputBridge&#x27;;
    40→import { type ActionButtonGroup, createAction } from &#x27;../../types/actions&#x27;;
    41→import { BaseLevel } from &#x27;../BaseLevel&#x27;;
    42→import type { LevelCallbacks, LevelConfig, LevelId } from &#x27;../types&#x27;;
    43→import {
    44→  AUDIO_LOGS,
    45→  type AudioLogPickup,
    46→  createMiningEnvironment,
    47→  type FlickerLightDef,
    48→  HAZARD_ZONES,
    49→  type HazardZone,
    50→  MINE_POSITIONS,
    51→  type MiningEnvironment,
    52→} from &#x27;./environment&#x27;;
    53→
    54→import &#x27;@babylonjs/core/Animations/animatable&#x27;;
    55→
    56→// ============================================================================
    57→// Level Phase Progression
    58→// ============================================================================
    59→
    60→type MiningPhase =
    61→  | &#x27;arrival&#x27; // Player enters via broken elevator
    62→  | &#x27;hub_explore&#x27; // Explore mining hub, find keycard
    63→  | &#x27;tunnels&#x27; // Navigate collapsed tunnels
    64→  | &#x27;shaft_descent&#x27; // Descend the deep shaft
    65→  | &#x27;boss_fight&#x27; // Fight Mining Drill Chitin
    66→  | &#x27;boss_defeated&#x27; // Boss eliminated, level complete
    67→  | &#x27;exit&#x27;; // Proceed to next level
    68→
    69→// ============================================================================
    70→// Enemy &amp; Boss Definitions
    71→// ============================================================================
    72→
    73→interface BurrowerEnemy {
    74→  mesh: Mesh | TransformNode;
    75→  health: number;
    76→  maxHealth: number;
    77→  position: Vector3;
    78→  state: &#x27;buried&#x27; | &#x27;emerging&#x27; | &#x27;chase&#x27; | &#x27;attack&#x27; | &#x27;burrow&#x27;;
    79→  attackCooldown: number;
    80→  emergeTimer: number;
    81→  stateTimer: number;
    82→}
    83→
    84→interface DrillChitinBoss {
    85→  mesh: Mesh | TransformNode;
    86→  health: number;
    87→  maxHealth: number;
    88→  position: Vector3;
    89→  state: &#x27;idle&#x27; | &#x27;charge&#x27; | &#x27;drill_attack&#x27; | &#x27;burrow&#x27; | &#x27;emerge&#x27; | &#x27;enraged&#x27;;
    90→  attackCooldown: number;
    91→  stateTimer: number;
    92→  chargeTarget: Vector3 | null;
    93→  isEnraged: boolean;
    94→  drillActive: boolean;
    95→}
    96→
    97→// ============================================================================
    98→// Area Trigger Zones
    99→// ============================================================================
   100→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-38-592Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-38-592Z" class="timestamp-link"><time datetime="2026-01-30T18:54:38.592Z" data-timestamp="2026-01-30T18:54:38.592Z">2026-01-30T18:54:38.592Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01BrouNdVvSHQjfVogic6cMy"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/environment.ts&#34;,
  &#34;limit&#34;: 80
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-38-594Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-38-594Z" class="timestamp-link"><time datetime="2026-01-30T18:54:38.594Z" data-timestamp="2026-01-30T18:54:38.594Z">2026-01-30T18:54:38.594Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * Mining Depths Environment - Underground Mine Generation
     3→ *
     4→ * Creates the BabylonJS mesh environment for an abandoned mining facility
     5→ * deep underground on LV-847. Features:
     6→ * - Tunnel systems with rock walls and ore veins
     7→ * - Mining equipment (drills, carts, conveyor fragments)
     8→ * - Crystal formations as natural light sources
     9→ * - Cave-in debris and structural damage
    10→ * - Minecart tracks (decorative)
    11→ * - Volumetric fog via point lights
    12→ * - Three distinct sections: Mining Hub, Collapsed Tunnels, Deep Shaft
    13→ */
    14→
    15→import { PointLight } from &#x27;@babylonjs/core/Lights/pointLight&#x27;;
    16→import { StandardMaterial } from &#x27;@babylonjs/core/Materials/standardMaterial&#x27;;
    17→import { Color3 } from &#x27;@babylonjs/core/Maths/math.color&#x27;;
    18→import { Vector3 } from &#x27;@babylonjs/core/Maths/math.vector&#x27;;
    19→import type { Mesh } from &#x27;@babylonjs/core/Meshes/mesh&#x27;;
    20→import { MeshBuilder } from &#x27;@babylonjs/core/Meshes/meshBuilder&#x27;;
    21→import { TransformNode } from &#x27;@babylonjs/core/Meshes/transformNode&#x27;;
    22→import type { Scene } from &#x27;@babylonjs/core/scene&#x27;;
    23→
    24→// ============================================================================
    25→// Layout Constants (all in meters)
    26→// ============================================================================
    27→//
    28→// ENTRY ELEVATOR SHAFT (arrives from surface)
    29→//     |
    30→// MINING HUB (40m x 30m) - Central processing area, branching tunnels
    31→//     |
    32→// COLLAPSED TUNNELS (winding 60m passage) - Debris navigation, cave-ins
    33→//     |
    34→// DEEP SHAFT (25m x 25m, 30m tall) - Vertical descent, boss arena
    35→//
    36→// ============================================================================
    37→
    38→// Section centers
    39→const ENTRY_CENTER = new Vector3(0, 0, 0);
    40→const HUB_CENTER = new Vector3(0, 0, -25);
    41→const TUNNEL_START = new Vector3(0, 0, -50);
    42→const TUNNEL_MID = new Vector3(-15, -5, -70);
    43→const TUNNEL_END = new Vector3(-10, -10, -95);
    44→const SHAFT_CENTER = new Vector3(-10, -15, -120);
    45→
    46→// Room dimensions
    47→const HUB_WIDTH = 40;
    48→const HUB_DEPTH = 30;
    49→const HUB_HEIGHT = 8;
    50→
    51→const TUNNEL_WIDTH = 5;
    52→const TUNNEL_HEIGHT = 4;
    53→
    54→const SHAFT_WIDTH = 25;
    55→const SHAFT_DEPTH = 25;
    56→const SHAFT_HEIGHT = 30;
    57→
    58→// Exported positions for level scripting
    59→export const MINE_POSITIONS = {
    60→  entry: ENTRY_CENTER.clone(),
    61→  hubCenter: HUB_CENTER.clone(),
    62→  hubTerminal: new Vector3(-12, 0, -20),
    63→  hubKeycard: new Vector3(14, 0, -30),
    64→  tunnelStart: TUNNEL_START.clone(),
    65→  tunnelMid: TUNNEL_MID.clone(),
    66→  tunnelEnd: TUNNEL_END.clone(),
    67→  shaftCenter: SHAFT_CENTER.clone(),
    68→  shaftFloor: new Vector3(SHAFT_CENTER.x, SHAFT_CENTER.y - SHAFT_HEIGHT / 2 + 1, SHAFT_CENTER.z),
    69→  shaftBossSpawn: new Vector3(
    70→    SHAFT_CENTER.x,
    71→    SHAFT_CENTER.y - SHAFT_HEIGHT / 2 + 3,
    72→    SHAFT_CENTER.z
    73→  ),
    74→  // Audio log pickup locations
    75→  audioLog1: new Vector3(8, 0, -18),
    76→  audioLog2: new Vector3(-15, -5, -75),
    77→  audioLog3: new Vector3(-10, -15, -115),
    78→  // Gas vent hazard positions
    79→  gasVent1: new Vector3(-5, 0, -55),
    80→  gasVent2: new Vector3(-18, -5, -80),

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-39-292Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-39-292Z" class="timestamp-link"><time datetime="2026-01-30T18:54:39.292Z" data-timestamp="2026-01-30T18:54:39.292Z">2026-01-30T18:54:39.292Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01CTNM4nAYzpWfisYgVufcJd"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/vehicles/**/*.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-40-140Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-40-140Z" class="timestamp-link"><time datetime="2026-01-30T18:54:40.140Z" data-timestamp="2026-01-30T18:54:40.140Z">2026-01-30T18:54:40.140Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01A6VZJMppqScdQLoPD79Rwi"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/audio/ReyesDialogue.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-40-482Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-40-482Z" class="timestamp-link"><time datetime="2026-01-30T18:54:40.482Z" data-timestamp="2026-01-30T18:54:40.482Z">2026-01-30T18:54:40.482Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/PhantomDropship.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/VehicleBase.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/WraithTank.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/index.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-41-340Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-41-340Z" class="timestamp-link"><time datetime="2026-01-30T18:54:41.340Z" data-timestamp="2026-01-30T18:54:41.340Z">2026-01-30T18:54:41.340Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/audio/ReyesDialogue.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-45-336Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-45-336Z" class="timestamp-link"><time datetime="2026-01-30T18:54:45.336Z" data-timestamp="2026-01-30T18:54:45.336Z">2026-01-30T18:54:45.336Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a comprehensive understanding. Let me also check the current types.ts for the campaign structure to see how levels are ordered and what LevelType includes.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-46-068Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-46-068Z" class="timestamp-link"><time datetime="2026-01-30T18:54:46.068Z" data-timestamp="2026-01-30T18:54:46.068Z">2026-01-30T18:54:46.068Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Now let me check a few more critical files to understand the current campaign ordering and level types.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-46-784Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-46-784Z" class="timestamp-link"><time datetime="2026-01-30T18:54:46.784Z" data-timestamp="2026-01-30T18:54:46.784Z">2026-01-30T18:54:46.784Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01At7RNeaw3BWUf4btjPecB3"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts&#34;,
  &#34;limit&#34;: 120
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-46-787Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-46-787Z" class="timestamp-link"><time datetime="2026-01-30T18:54:46.787Z" data-timestamp="2026-01-30T18:54:46.787Z">2026-01-30T18:54:46.787Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * Level System Types - Designed Campaign
     3→ *
     4→ * STELLAR DESCENT Campaign Structure (matching LORE.md):
     5→ *
     6→ * ACT 1: THE DROP
     7→ *   1. Anchor Station Prometheus - Tutorial/Briefing (Prologue + Chapter 1)
     8→ *   2. Landfall - HALO drop, first surface combat (Chapter 2)
     9→ *
    10→ * ACT 2: THE SEARCH
    11→ *   3. Canyon Run - Vehicle chase through canyons (Chapter 3)
    12→ *   4. FOB Delta - Abandoned base, horror/investigation (Chapter 4)
    13→ *   5. Brothers in Arms - Reunite with Marcus, mech combat (Chapter 5)
    14→ *
    15→ * ACT 3: THE TRUTH
    16→ *   6. Southern Ice - Frozen wasteland, new enemy types (Chapter 6)
    17→ *   7. The Breach - Underground hive, Queen boss fight (Chapter 7)
    18→ *
    19→ * ACT 4: ENDGAME
    20→ *   8. Hive Assault - Combined arms push into hive (Chapter 8)
    21→ *   9. Extraction - Escape and holdout at LZ Omega (Chapter 9)
    22→ *   10. Final Escape - Warthog Run style vehicle finale (Chapter 10)
    23→ */
    24→
    25→import type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    26→import type { Scene } from &#x27;@babylonjs/core/scene&#x27;;
    27→import type { CommsMessage } from &#x27;../types&#x27;;
    28→import type { ActionButtonGroup } from &#x27;../types/actions&#x27;;
    29→
    30→// Level environment types
    31→export type LevelType =
    32→  | &#x27;station&#x27; // Interior station (Anchor Station)
    33→  | &#x27;drop&#x27; // HALO drop sequence
    34→  | &#x27;canyon&#x27; // Exterior canyon/surface
    35→  | &#x27;base&#x27; // Abandoned FOB interior
    36→  | &#x27;brothers&#x27; // Open canyon with mech ally combat
    37→  | &#x27;hive&#x27; // Underground alien tunnels + Queen boss
    38→  | &#x27;extraction&#x27; // Surface escape and holdout
    39→  | &#x27;vehicle&#x27; // Vehicle chase / driving sequence
    40→  | &#x27;ice&#x27; // Frozen wasteland surface
    41→  | &#x27;combined_arms&#x27; // Vehicle + infantry combined assault
    42→  | &#x27;finale&#x27;; // Timed vehicle escape sequence
    43→
    44→// Campaign level IDs - linear progression (matches LORE.md chapters)
    45→export type LevelId =
    46→  | &#x27;anchor_station&#x27; // Chapter 1: Tutorial/Briefing
    47→  | &#x27;landfall&#x27; // Chapter 2: HALO drop + first surface combat
    48→  | &#x27;canyon_run&#x27; // Chapter 3: Vehicle chase through canyons
    49→  | &#x27;fob_delta&#x27; // Chapter 4: Abandoned base investigation
    50→  | &#x27;brothers_in_arms&#x27; // Chapter 5: Reunite with Marcus, mech combat
    51→  | &#x27;southern_ice&#x27; // Chapter 6: Frozen wasteland, new enemy types
    52→  | &#x27;the_breach&#x27; // Chapter 7: Underground hive, Queen boss
    53→  | &#x27;hive_assault&#x27; // Chapter 8: Combined arms push into hive
    54→  | &#x27;extraction&#x27; // Chapter 9: Escape and holdout at LZ Omega
    55→  | &#x27;final_escape&#x27;; // Chapter 10: Warthog Run style vehicle finale
    56→
    57→// Callbacks from level to game system
    58→export interface LevelCallbacks {
    59→  onCommsMessage: (message: CommsMessage) =&gt; void;
    60→  onObjectiveUpdate: (title: string, instructions: string) =&gt; void;
    61→  onChapterChange: (chapter: number) =&gt; void;
    62→  onHealthChange: (health: number) =&gt; void;
    63→  onKill: () =&gt; void;
    64→  onDamage: () =&gt; void;
    65→  onNotification: (text: string, duration?: number) =&gt; void;
    66→  onLevelComplete: (nextLevelId: LevelId | null) =&gt; void;
    67→  onCombatStateChange: (inCombat: boolean) =&gt; void;
    68→  onCinematicStart?: () =&gt; void;
    69→  onCinematicEnd?: () =&gt; void;
    70→  // Action button system
    71→  onActionGroupsChange: (groups: ActionButtonGroup[]) =&gt; void;
    72→  onActionHandlerRegister: (handler: ((actionId: string) =&gt; void) | null) =&gt; void;
    73→  // Combat feedback callbacks
    74→  onHitMarker?: (damage: number, isCritical: boolean) =&gt; void;
    75→  onDirectionalDamage?: (angle: number, damage: number) =&gt; void;
    76→}
    77→
    78→// Weather configuration for levels
    79→export interface WeatherConfig {
    80→  environment: &#x27;surface&#x27; | &#x27;station&#x27; | &#x27;hive&#x27;;
    81→  initialWeather: string;
    82→  initialIntensity: &#x27;low&#x27; | &#x27;medium&#x27; | &#x27;high&#x27; | &#x27;extreme&#x27;;
    83→  qualityLevel?: &#x27;low&#x27; | &#x27;medium&#x27; | &#x27;high&#x27;;
    84→}
    85→
    86→// Level configuration
    87→export interface LevelConfig {
    88→  id: LevelId;
    89→  type: LevelType;
    90→  nextLevelId: LevelId | null;
    91→  previousLevelId: LevelId | null;
    92→
    93→  // Display info
    94→  chapter: number;
    95→  actName: string;
    96→  missionName: string;
    97→  missionSubtitle?: string;
    98→
    99→  // Spawn configuration
   100→  playerSpawnPosition?: { x: number; y: number; z: number };
   101→  playerSpawnRotation?: number;
   102→
   103→  // Level-specific settings
   104→  ambientTrack?: string;
   105→  combatTrack?: string;
   106→  hasCinematicIntro?: boolean;
   107→
   108→  // Weather/atmosphere configuration
   109→  weather?: WeatherConfig;
   110→}
   111→
   112→// State that can be persisted for a level
   113→export interface LevelState {
   114→  id: LevelId;
   115→  visited: boolean;
   116→  completed: boolean;
   117→  playerPosition?: { x: number; y: number; z: number };
   118→  playerRotation?: number;
   119→  // Collectibles found, enemies killed, etc.
   120→  stats?: {

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-47-389Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-47-389Z" class="timestamp-link"><time datetime="2026-01-30T18:54:47.389Z" data-timestamp="2026-01-30T18:54:47.389Z">2026-01-30T18:54:47.389Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_017nhWaDLLNffzWPATuAiq2X"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;src/game/levels/canyon-run/**/*.ts&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-47-975Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-47-975Z" class="timestamp-link"><time datetime="2026-01-30T18:54:47.975Z" data-timestamp="2026-01-30T18:54:47.975Z">2026-01-30T18:54:47.975Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01HVxkXHt6NMFMfkuSpFDxGY"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/LevelManager.ts&#34;,
  &#34;limit&#34;: 60
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-47-978Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-47-978Z" class="timestamp-link"><time datetime="2026-01-30T18:54:47.978Z" data-timestamp="2026-01-30T18:54:47.978Z">2026-01-30T18:54:47.978Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→/**
     2→ * LevelManager - Orchestrates level transitions and lifecycle
     3→ *
     4→ * The level system is a linked list where each level knows what comes next.
     5→ * LevelManager handles:
     6→ * - Creating and disposing levels
     7→ * - Transitioning between levels with proper cleanup
     8→ * - Persisting level state to database
     9→ * - Engine render loop management
    10→ */
    11→
    12→import type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
    13→import { worldDb } from &#x27;../db/worldDatabase&#x27;;
    14→import type {
    15→  CAMPAIGN_LEVELS,
    16→  ILevel,
    17→  LevelCallbacks,
    18→  LevelConfig,
    19→  LevelFactory,
    20→  LevelFactoryRegistry,
    21→  LevelId,
    22→  LevelState,
    23→} from &#x27;./types&#x27;;
    24→
    25→export interface LevelManagerConfig {
    26→  engine: Engine;
    27→  canvas: HTMLCanvasElement;
    28→  callbacks: LevelCallbacks;
    29→  levelFactories: Partial&lt;LevelFactoryRegistry&gt;;
    30→}
    31→
    32→export class LevelManager {
    33→  private engine: Engine;
    34→  private canvas: HTMLCanvasElement;
    35→  private callbacks: LevelCallbacks;
    36→  private factories: Partial&lt;LevelFactoryRegistry&gt;;
    37→
    38→  private currentLevel: ILevel | null = null;
    39→  private levelStates: Map&lt;LevelId, LevelState&gt; = new Map();
    40→  private isTransitioning = false;
    41→
    42→  // Render loop handle
    43→  private renderLoopHandle: number | null = null;
    44→
    45→  constructor(config: LevelManagerConfig) {
    46→    this.engine = config.engine;
    47→    this.canvas = config.canvas;
    48→    this.callbacks = config.callbacks;
    49→    this.factories = config.levelFactories;
    50→  }
    51→
    52→  /**
    53→   * Start a level - creates or resumes it
    54→   */
    55→  async startLevel(levelId: LevelId): Promise&lt;void&gt; {
    56→    if (this.isTransitioning) {
    57→      console.warn(&#x27;Cannot start level while transitioning&#x27;);
    58→      return;
    59→    }
    60→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-48-580Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-48-580Z" class="timestamp-link"><time datetime="2026-01-30T18:54:48.580Z" data-timestamp="2026-01-30T18:54:48.580Z">2026-01-30T18:54:48.580Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/canyon-run/CanyonRunLevel.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/canyon-run/VehicleController.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/canyon-run/environment.ts
/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/canyon-run/index.ts</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-52-531Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-52-531Z" class="timestamp-link"><time datetime="2026-01-30T18:54:52.531Z" data-timestamp="2026-01-30T18:54:52.531Z">2026-01-30T18:54:52.531Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now let me read more of the types.ts to see the CAMPAIGN_LEVELS definition, since that's the current linked list structure.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-53-158Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-53-158Z" class="timestamp-link"><time datetime="2026-01-30T18:54:53.158Z" data-timestamp="2026-01-30T18:54:53.158Z">2026-01-30T18:54:53.158Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01WQJRrkYbAwWELyK8kU5Ruz"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts&#34;,
  &#34;offset&#34;: 120
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-53-161Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-53-161Z" class="timestamp-link"><time datetime="2026-01-30T18:54:53.161Z" data-timestamp="2026-01-30T18:54:53.161Z">2026-01-30T18:54:53.161Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>   120→  stats?: {
   121→    kills: number;
   122→    secretsFound: number;
   123→    timeSpent: number;
   124→  };
   125→  // Story flags
   126→  flags?: Record&lt;string, boolean&gt;;
   127→}
   128→
   129→// Touch input type for levels
   130→export interface TouchInputState {
   131→  movement: { x: number; y: number };
   132→  look: { x: number; y: number };
   133→  isFiring?: boolean;
   134→  isSprinting?: boolean;
   135→  isJumping?: boolean;
   136→  isCrouching?: boolean;
   137→}
   138→
   139→// The unified Level interface
   140→export interface ILevel {
   141→  readonly id: LevelId;
   142→  readonly type: LevelType;
   143→  readonly config: LevelConfig;
   144→
   145→  // Lifecycle
   146→  initialize(): Promise&lt;void&gt;;
   147→  update(deltaTime: number): void;
   148→  dispose(): void;
   149→
   150→  // Scene access
   151→  getScene(): Scene;
   152→
   153→  // State management
   154→  getState(): LevelState;
   155→  setState(state: Partial&lt;LevelState&gt;): void;
   156→
   157→  // Player control
   158→  lockPointer(): void;
   159→  unlockPointer(): void;
   160→  isPointerLocked(): boolean;
   161→
   162→  // Input
   163→  setTouchInput(input: TouchInputState | null): void;
   164→
   165→  // Navigation
   166→  canTransitionTo(levelId: LevelId): boolean;
   167→  prepareTransition(targetLevelId: LevelId): Promise&lt;void&gt;;
   168→}
   169→
   170→// Factory function signature
   171→export type LevelFactory = (
   172→  engine: Engine,
   173→  canvas: HTMLCanvasElement,
   174→  config: LevelConfig,
   175→  callbacks: LevelCallbacks
   176→) =&gt; ILevel;
   177→
   178→// Registry of level factories by type
   179→export interface LevelFactoryRegistry {
   180→  station: LevelFactory;
   181→  drop: LevelFactory;
   182→  canyon: LevelFactory;
   183→  base: LevelFactory;
   184→  brothers: LevelFactory;
   185→  hive: LevelFactory;
   186→  extraction: LevelFactory;
   187→  vehicle: LevelFactory;
   188→  ice: LevelFactory;
   189→  combined_arms: LevelFactory;
   190→  finale: LevelFactory;
   191→}
   192→
   193→// ============================================================================
   194→// CAMPAIGN LEVEL CONFIGURATIONS
   195→// ============================================================================
   196→
   197→export const CAMPAIGN_LEVELS: Record&lt;LevelId, LevelConfig&gt; = {
   198→  // -------------------------------------------------------------------------
   199→  // ACT 1: THE DROP
   200→  // -------------------------------------------------------------------------
   201→  anchor_station: {
   202→    id: &#x27;anchor_station&#x27;,
   203→    type: &#x27;station&#x27;,
   204→    nextLevelId: &#x27;landfall&#x27;,
   205→    previousLevelId: null,
   206→    chapter: 1,
   207→    actName: &#x27;ACT 1: THE DROP&#x27;,
   208→    missionName: &#x27;ANCHOR STATION PROMETHEUS&#x27;,
   209→    missionSubtitle: &#x27;Prep Bay 7&#x27;,
   210→    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   211→    playerSpawnRotation: Math.PI,
   212→    ambientTrack: &#x27;station_ambient&#x27;,
   213→    hasCinematicIntro: false,
   214→    weather: {
   215→      environment: &#x27;station&#x27;,
   216→      initialWeather: &#x27;normal&#x27;,
   217→      initialIntensity: &#x27;low&#x27;,
   218→    },
   219→  },
   220→
   221→  landfall: {
   222→    id: &#x27;landfall&#x27;,
   223→    type: &#x27;drop&#x27;, // Starts as drop, transitions to canyon
   224→    nextLevelId: &#x27;canyon_run&#x27;,
   225→    previousLevelId: &#x27;anchor_station&#x27;,
   226→    chapter: 2,
   227→    actName: &#x27;ACT 1: THE DROP&#x27;,
   228→    missionName: &#x27;LANDFALL&#x27;,
   229→    missionSubtitle: &quot;Kepler&#x27;s Promise - Northern Canyon&quot;,
   230→    playerSpawnPosition: { x: 0, y: 500, z: 0 }, // High altitude for drop
   231→    hasCinematicIntro: true,
   232→    ambientTrack: &#x27;canyon_wind&#x27;,
   233→    combatTrack: &#x27;combat_surface&#x27;,
   234→    weather: {
   235→      environment: &#x27;surface&#x27;,
   236→      initialWeather: &#x27;dusty&#x27;,
   237→      initialIntensity: &#x27;medium&#x27;,
   238→    },
   239→  },
   240→
   241→  canyon_run: {
   242→    id: &#x27;canyon_run&#x27;,
   243→    type: &#x27;vehicle&#x27;,
   244→    nextLevelId: &#x27;fob_delta&#x27;,
   245→    previousLevelId: &#x27;landfall&#x27;,
   246→    chapter: 3,
   247→    actName: &#x27;ACT 2: THE SEARCH&#x27;,
   248→    missionName: &#x27;CANYON RUN&#x27;,
   249→    missionSubtitle: &quot;Kepler&#x27;s Promise - Southern Rift Valley&quot;,
   250→    playerSpawnPosition: { x: 0, y: 2, z: 0 },
   251→    playerSpawnRotation: 0,
   252→    hasCinematicIntro: true,
   253→    ambientTrack: &#x27;canyon_wind&#x27;,
   254→    combatTrack: &#x27;combat_vehicle&#x27;,
   255→    weather: {
   256→      environment: &#x27;surface&#x27;,
   257→      initialWeather: &#x27;dusty&#x27;,
   258→      initialIntensity: &#x27;high&#x27;,
   259→    },
   260→  },
   261→
   262→  // -------------------------------------------------------------------------
   263→  // ACT 2: THE SEARCH
   264→  // -------------------------------------------------------------------------
   265→  fob_delta: {
   266→    id: &#x27;fob_delta&#x27;,
   267→    type: &#x27;base&#x27;,
   268→    nextLevelId: &#x27;brothers_in_arms&#x27;,
   269→    previousLevelId: &#x27;canyon_run&#x27;,
   270→    chapter: 4,
   271→    actName: &#x27;ACT 2: THE SEARCH&#x27;,
   272→    missionName: &#x27;FOB DELTA&#x27;,
   273→    missionSubtitle: &#x27;Forward Operating Base - Abandoned&#x27;,
   274→    playerSpawnPosition: { x: 0, y: 1.7, z: -5 },
   275→    hasCinematicIntro: true,
   276→    ambientTrack: &#x27;horror_ambient&#x27;,
   277→    combatTrack: &#x27;combat_interior&#x27;,
   278→    weather: {
   279→      environment: &#x27;station&#x27;,
   280→      initialWeather: &#x27;damaged&#x27;,
   281→      initialIntensity: &#x27;medium&#x27;,
   282→    },
   283→  },
   284→
   285→  brothers_in_arms: {
   286→    id: &#x27;brothers_in_arms&#x27;,
   287→    type: &#x27;brothers&#x27;,
   288→    nextLevelId: &#x27;southern_ice&#x27;,
   289→    previousLevelId: &#x27;fob_delta&#x27;,
   290→    chapter: 5,
   291→    actName: &#x27;ACT 2: THE SEARCH&#x27;,
   292→    missionName: &#x27;BROTHERS IN ARMS&#x27;,
   293→    missionSubtitle: &#x27;Reunion with Corporal Marcus Cole&#x27;,
   294→    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   295→    hasCinematicIntro: true,
   296→    ambientTrack: &#x27;canyon_wind&#x27;,
   297→    combatTrack: &#x27;combat_mech&#x27;,
   298→    weather: {
   299→      environment: &#x27;surface&#x27;,
   300→      initialWeather: &#x27;dust_storm&#x27;,
   301→      initialIntensity: &#x27;high&#x27;,
   302→    },
   303→  },
   304→
   305→  // -------------------------------------------------------------------------
   306→  // ACT 3: THE TRUTH
   307→  // -------------------------------------------------------------------------
   308→  southern_ice: {
   309→    id: &#x27;southern_ice&#x27;,
   310→    type: &#x27;ice&#x27;,
   311→    nextLevelId: &#x27;the_breach&#x27;,
   312→    previousLevelId: &#x27;brothers_in_arms&#x27;,
   313→    chapter: 6,
   314→    actName: &#x27;ACT 3: THE TRUTH&#x27;,
   315→    missionName: &#x27;SOUTHERN ICE&#x27;,
   316→    missionSubtitle: &quot;Kepler&#x27;s Promise - Polar Region&quot;,
   317→    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   318→    hasCinematicIntro: true,
   319→    ambientTrack: &#x27;ice_wind&#x27;,
   320→    combatTrack: &#x27;combat_ice&#x27;,
   321→    weather: {
   322→      environment: &#x27;surface&#x27;,
   323→      initialWeather: &#x27;blizzard&#x27;,
   324→      initialIntensity: &#x27;extreme&#x27;,
   325→    },
   326→  },
   327→
   328→  the_breach: {
   329→    id: &#x27;the_breach&#x27;,
   330→    type: &#x27;hive&#x27;,
   331→    nextLevelId: &#x27;hive_assault&#x27;,
   332→    previousLevelId: &#x27;southern_ice&#x27;,
   333→    chapter: 7,
   334→    actName: &#x27;ACT 3: THE TRUTH&#x27;,
   335→    missionName: &#x27;INTO THE BREACH&#x27;,
   336→    missionSubtitle: &quot;Subterranean Hive - Queen&#x27;s Lair&quot;,
   337→    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   338→    hasCinematicIntro: true,
   339→    ambientTrack: &#x27;hive_ambient&#x27;,
   340→    combatTrack: &#x27;boss_combat&#x27;,
   341→    weather: {
   342→      environment: &#x27;hive&#x27;,
   343→      initialWeather: &#x27;calm&#x27;,
   344→      initialIntensity: &#x27;medium&#x27;,
   345→    },
   346→  },
   347→
   348→  // -------------------------------------------------------------------------
   349→  // ACT 4: ENDGAME
   350→  // -------------------------------------------------------------------------
   351→  hive_assault: {
   352→    id: &#x27;hive_assault&#x27;,
   353→    type: &#x27;combined_arms&#x27;,
   354→    nextLevelId: &#x27;extraction&#x27;,
   355→    previousLevelId: &#x27;the_breach&#x27;,
   356→    chapter: 8,
   357→    actName: &#x27;ACT 4: ENDGAME&#x27;,
   358→    missionName: &#x27;HIVE ASSAULT&#x27;,
   359→    missionSubtitle: &#x27;Combined Arms - Surface to Hive Core&#x27;,
   360→    playerSpawnPosition: { x: 0, y: 2.5, z: 0 },
   361→    hasCinematicIntro: true,
   362→    ambientTrack: &#x27;hive_ambient&#x27;,
   363→    combatTrack: &#x27;combat_assault&#x27;,
   364→    weather: {
   365→      environment: &#x27;hive&#x27;,
   366→      initialWeather: &#x27;spore_storm&#x27;,
   367→      initialIntensity: &#x27;extreme&#x27;,
   368→    },
   369→  },
   370→
   371→  extraction: {
   372→    id: &#x27;extraction&#x27;,
   373→    type: &#x27;extraction&#x27;,
   374→    nextLevelId: &#x27;final_escape&#x27;,
   375→    previousLevelId: &#x27;hive_assault&#x27;,
   376→    chapter: 9,
   377→    actName: &#x27;ACT 4: ENDGAME&#x27;,
   378→    missionName: &#x27;EXTRACTION&#x27;,
   379→    missionSubtitle: &#x27;LZ Omega - Hold Until Evac&#x27;,
   380→    playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
   381→    hasCinematicIntro: true,
   382→    ambientTrack: &#x27;extraction_ambient&#x27;,
   383→    combatTrack: &#x27;combat_finale&#x27;,
   384→    weather: {
   385→      environment: &#x27;surface&#x27;,
   386→      initialWeather: &#x27;sandstorm&#x27;,
   387→      initialIntensity: &#x27;extreme&#x27;,
   388→    },
   389→  },
   390→
   391→  final_escape: {
   392→    id: &#x27;final_escape&#x27;,
   393→    type: &#x27;finale&#x27;,
   394→    nextLevelId: null, // End of campaign
   395→    previousLevelId: &#x27;extraction&#x27;,
   396→    chapter: 10,
   397→    actName: &#x27;ACT 4: ENDGAME&#x27;,
   398→    missionName: &#x27;FINAL ESCAPE&#x27;,
   399→    missionSubtitle: &#x27;Outrun the Collapse&#x27;,
   400→    playerSpawnPosition: { x: 0, y: 2.5, z: 0 }, // In vehicle
   401→    hasCinematicIntro: true,
   402→    ambientTrack: &#x27;collapse_ambient&#x27;,
   403→    combatTrack: &#x27;combat_finale&#x27;,
   404→    weather: {
   405→      environment: &#x27;surface&#x27;,
   406→      initialWeather: &#x27;firestorm&#x27;,
   407→      initialIntensity: &#x27;extreme&#x27;,
   408→    },
   409→  },
   410→};
   411→
   412→// ============================================================================
   413→// LINKED LIST TRAVERSAL UTILITIES
   414→// ============================================================================
   415→
   416→/**
   417→ * Get the first level in the campaign (head of linked list)
   418→ */
   419→export function getFirstLevel(): LevelConfig {
   420→  return CAMPAIGN_LEVELS.anchor_station;
   421→}
   422→
   423→/**
   424→ * Get the next level from a given level (linked list traversal)
   425→ */
   426→export function getNextLevel(levelId: LevelId): LevelConfig | null {
   427→  const current = CAMPAIGN_LEVELS[levelId];
   428→  if (!current.nextLevelId) return null;
   429→  return CAMPAIGN_LEVELS[current.nextLevelId];
   430→}
   431→
   432→/**
   433→ * Get the previous level from a given level (linked list traversal)
   434→ */
   435→export function getPreviousLevel(levelId: LevelId): LevelConfig | null {
   436→  const current = CAMPAIGN_LEVELS[levelId];
   437→  if (!current.previousLevelId) return null;
   438→  return CAMPAIGN_LEVELS[current.previousLevelId];
   439→}
   440→
   441→/**
   442→ * Count total levels by traversing the linked list
   443→ */
   444→export function getTotalLevels(): number {
   445→  let count = 0;
   446→  let current: LevelConfig | null = getFirstLevel();
   447→  while (current) {
   448→    count++;
   449→    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   450→  }
   451→  return count;
   452→}
   453→
   454→/**
   455→ * Get level index by traversing from head (0-indexed)
   456→ */
   457→export function getLevelIndex(levelId: LevelId): number {
   458→  let index = 0;
   459→  let current: LevelConfig | null = getFirstLevel();
   460→  while (current) {
   461→    if (current.id === levelId) return index;
   462→    index++;
   463→    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   464→  }
   465→  return -1; // Not found
   466→}
   467→
   468→/**
   469→ * Iterate through all levels (generator)
   470→ */
   471→export function* iterateLevels(): Generator&lt;LevelConfig&gt; {
   472→  let current: LevelConfig | null = getFirstLevel();
   473→  while (current) {
   474→    yield current;
   475→    current = current.nextLevelId ? CAMPAIGN_LEVELS[current.nextLevelId] : null;
   476→  }
   477→}
   478→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-54-53-953Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-54-53-953Z" class="timestamp-link"><time datetime="2026-01-30T18:54:53.953Z" data-timestamp="2026-01-30T18:54:53.953Z">2026-01-30T18:54:53.953Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01JgZ5hxzVGLYTwTJL2o678L"><div class="tool-header"><span class="tool-icon">⚙</span> Glob</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;pattern&#34;: &#34;public/models/**/*.glb&#34;,
  &#34;path&#34;: &#34;/Users/jbogaty/src/arcade-cabinet/stellar-descent&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T18-54-55-165Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T18-54-55-165Z" class="timestamp-link"><time datetime="2026-01-30T18:54:55.165Z" data-timestamp="2026-01-30T18:54:55.165Z">2026-01-30T18:54:55.165Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/alienfemale.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/alienmale.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/alienmonster.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/flyingalien.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/scout.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/soldier.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/spider.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/enemies/chitin/tentakel.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_birther.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_brain.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_claw.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_crystals.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_stomach.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_terraformer.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/hive/building_undercrystal.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/beam_hc_horizonatal_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/beam_hc_vertical_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/corridor_corner.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/corridor_junction.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/corridor_main.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/corridor_wide.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/doorway_hr_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/doorway_hr_1_wide.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/floor_ceiling_hr_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/floor_ceiling_hr_3.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/floor_ceiling_rtx_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/pipe_cx_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/pipe_cx_2.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/station_barrel.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/station_door.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/wall_hr_1_double.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/environment/station/wall_hr_1_hole_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/cardboard_box_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/door_hr_12.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/door_hr_13.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/door_hr_6.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/electrical_equipment_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/lamp_mx_1_a_on.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/lamp_mx_2_on.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/lamp_mx_3_on.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/machinery_mx_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/metal_barrel_hr_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/metal_barrel_hr_2.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/pipes_hr_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/props/industrial/shelf_mx_1.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/vehicles/chitin/wraith.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/vehicles/tea/marcus_mech.glb
/Users/jbogaty/src/arcade-cabinet/stellar-descent/public/models/vehicles/tea/phantom.glb</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-55-39-829Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-55-39-829Z" class="timestamp-link"><time datetime="2026-01-30T18:55:39.829Z" data-timestamp="2026-01-30T18:55:39.829Z">2026-01-30T18:55:39.829Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have a comprehensive understanding. Let me now launch Plan agents to design the revised implementation plan based on all this context.</p>
<p>Key findings:
1. The campaign is 10 levels as defined in LORE.md and types.ts
2. Mining Depths exists but is NOT in the campaign - the user wants it wired in
3. The <code>canyon</code> LevelType exists in the registry but the factory throws an error. Canyon Run uses <code>vehicle</code> type, so <code>canyon</code> is used by Brothers in Arms (type: <code>brothers</code>) and potentially Landfall phase 4. Actually looking again, <code>canyon</code> is listed as a LevelType but no campaign level uses it. </p>
<p>Brothers uses <code>brothers</code>, Landfall uses <code>drop</code>, so <code>canyon</code> is completely unused and needs to be integrated. Mining Depths could slot in narratively as an optional detour from FOB Delta or between FOB Delta and Brothers in Arms, given the lore about missing miners and outposts. I also need to wire vehicles like PhantomDropship, WraithTank, and VehicleBase into Canyon Run, Hive Assault, and Final Escape, plus handle ReyesDialogue integration. The mining facility investigation fits naturally into the campaign flow—James could discover the distress beacon during Canyon Run and explore Mining Depths before reaching FOB Delta, which would mean inserting it as level 3.5 to make an 11-level campaign. This keeps everything the user designed actually in use rather than cutting content, and it's the cleanest narrative fit. The <code>canyon</code> type exists in the system but isn't actually used by any level—Brothers in Arms uses its own <code>brothers</code> type instead. I should either create a level that uses <code>canyon</code> for surface-level areas, or introduce a new <code>mine</code> type specifically for Mining Depths and leave <code>canyon</code> for future use. I'm going to assign the <code>canyon</code> type to Mining Depths since it naturally fits a surface canyon environment before going underground, then create a comprehensive plan that wires everything together—keeping all the components, integrating Mining Depths into the campaign, connecting vehicles to the appropriate levels, and adding the UI polish like splash screens and 9-slice buttons.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-55-40-228Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-55-40-228Z" class="timestamp-link"><time datetime="2026-01-30T18:55:40.228Z" data-timestamp="2026-01-30T18:55:40.228Z">2026-01-30T18:55:40.228Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>Now I have a thorough understanding of the entire codebase, docs, and the user's vision. Let me launch Plan agents to design the comprehensive revised plan.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-56-01-102Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-56-01-102Z" class="timestamp-link"><time datetime="2026-01-30T18:56:01.102Z" data-timestamp="2026-01-30T18:56:01.102Z">2026-01-30T18:56:01.102Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01LxPUhTgD4DpQdKm8yZoxo8"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">CampaignDirector spine architecture</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;subagent_type&#34;: &#34;Plan&#34;,
  &#34;prompt&#34;: &#34;Design the CampaignDirector architecture as the game&#39;s spine for Stellar Descent: Proxima Breach.\n\nCONTEXT:\nThis is a BabylonJS 8.x + React 19 + TypeScript 5.9 FPS game with a 10-level campaign. The user rejected the previous plan because it proposed removing content. The new plan must WIRE EVERYTHING IN.\n\nCURRENT STATE:\n- 10 campaign levels defined in types.ts as a linked list (CAMPAIGN_LEVELS)\n- LevelManager exists but is UNUSED\n- GameCanvas has dual rendering: tutorialLevelRef (ILevel) + gameManagerRef (GameManager)\n- App.tsx has ~15 useCallback hooks for state transitions, gameState atom\n- GameManager.ts is NOT ILevel-compatible (manages Player, ChunkManager, CombatSystem, AISystem)\n- SaveSystem uses IndexedDB, GameSave has levelsCompleted[] and objectives: Record&lt;string, boolean&gt; (always empty)\n- AchievementManager has 7+ disconnected trigger methods\n- Mining Depths level exists (72KB, fully implemented) but is NOT in the campaign\n- Vehicles directory (PhantomDropship, WraithTank, VehicleBase) exists but never instantiated\n- ReyesDialogue.ts (822 LOC) exists but never imported\n- `canyon` LevelType exists in registry but factory throws error\n- Audio logs / skulls collectible systems built but never instantiated\n\nREQUIREMENTS:\n1. CampaignDirector as single coordinator: campaign state machine, level lifecycle, saves, achievements, objectives\n2. Wire LevelManager (existing) into CampaignDirector\n3. Unify GameCanvas to single ILevel rendering path\n4. Simplify App.tsx from ~700 lines to ~300 using useCampaign() hook\n5. Wire Mining Depths as bonus/optional level (accessible from FOB Delta - fits LORE.md \&#34;Mining Outpost Gamma-7\&#34;)\n6. Wire canyon LevelType to a proper factory\n7. Wire vehicles into Canyon Run, Hive Assault, Final Escape levels\n8. Wire ReyesDialogue into levels with Commander dialogue\n9. Wire all achievement triggers\n10. Wire collectible systems (audio logs, skulls)\n11. Populate GameSave.objectives from level events\n12. Tests CAN break - refactor properly\n\nCAMPAIGN PHASES (state machine):\nidle → splash → menu → briefing → intro → loading → playing → levelComplete → briefing (next) → ... → credits\n                                                          |\n                                                          +→ paused\n                                                          +→ gameover → loading (retry)\n\nKEY INSIGHT: tutorial and dropping are NOT separate phases. AnchorStation IS the tutorial. Landfall IS the drop. Both are ILevel instances. CampaignDirector is always in `playing` when any level is active.\n\nFILES:\n- New: src/game/campaign/CampaignDirector.ts, types.ts, MissionDefinitions.ts, useCampaign.ts, index.ts\n- Modify: GameCanvas.tsx, App.tsx, LevelManager.ts, types.ts, factories.ts\n- Wire (don&#39;t remove): GameManager.ts functionality into ILevel system, vehicles/, ReyesDialogue.ts, mining-depths/\n\nDesign the state machine, command API, and integration points. Show how CampaignDirector wires to React, LevelManager, SaveSystem, AchievementManager, and collectibles.&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-56-29-298Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-56-29-298Z" class="timestamp-link"><time datetime="2026-01-30T18:56:29.298Z" data-timestamp="2026-01-30T18:56:29.298Z">2026-01-30T18:56:29.298Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01SBNtYx3ZUqEmDesaxfDKDW"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Model-based atmosphere per level</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;subagent_type&#34;: &#34;Plan&#34;,
  &#34;prompt&#34;: &#34;Design the model-based level environment system for Stellar Descent: Proxima Breach.\n\nCONTEXT:\nThe user explicitly demands: \&#34;STOP procedurally generating walls. Our goal for the space base is everything snapped together with those GLB base models, all the planet side stuff BabylonJS dynamic terrain with ambientCG textures, and proper skyscapes. Underground we have plenty of alien tech models.\&#34;\n\nAVAILABLE GLB MODELS (47 total in public/models/):\nStation (15): corridor_corner, corridor_junction, corridor_main, corridor_wide, doorway_hr_1, doorway_hr_1_wide, floor_ceiling_hr_1, floor_ceiling_hr_3, floor_ceiling_rtx_1, pipe_cx_1, pipe_cx_2, station_barrel, station_door, wall_hr_1_double, wall_hr_1_hole_1, beam_hc_horizonatal_1, beam_hc_vertical_1\nProps/Industrial (13): cardboard_box_1, door_hr_12, door_hr_13, door_hr_6, electrical_equipment_1, lamp_mx_1_a_on, lamp_mx_2_on, lamp_mx_3_on, machinery_mx_1, metal_barrel_hr_1, metal_barrel_hr_2, pipes_hr_1, shelf_mx_1\nHive (7): building_birther, building_brain, building_claw, building_crystals, building_stomach, building_terraformer, building_undercrystal\nEnemies (8): alienfemale, alienmale, alienmonster, flyingalien, scout, soldier, spider, tentakel\nVehicles (3): wraith, marcus_mech, phantom\n\nPSX TEXTURES (6): concrete.png, door.png, machinery.png, metal_barrel.png, metal.png, wall.png\n\nLEVEL ENVIRONMENTS TO DESIGN (each must be meticulously crafted):\n\n1. **Anchor Station** (station type): 5 rooms connected by corridors using station GLB models. Briefing Room, Corridor, Equipment Bay, Shooting Range, Hangar Bay. Currently uses ZERO models (100% procedural). Must use: corridor_main, corridor_corner, corridor_junction, corridor_wide, floor_ceiling_*, wall_*, doorway_*, beam_*, pipe_*, station_door, station_barrel, lamps, machinery, shelves. Add BARRACKS ROOM with beds/furniture (user wants intro to START in barracks).\n\n2. **Landfall** (drop type → surface): Phase 1-3 are space/atmosphere (particle effects, planet sphere). Phase 4: BabylonJS dynamic terrain for canyon surface with ambientCG rock textures. Proper red-dwarf skyscape (eternal sunset, rust-red light).\n\n3. **Canyon Run** (vehicle type): Dynamic terrain canyon corridors. Vehicle on canyon floor. Cliff walls using heightmap terrain. Proper sky. Wire PhantomDropship or light transport vehicle.\n\n4. **FOB Delta** (base type): Station models repurposed for military prefab buildings. Damaged state. Flickering lights using lamp models. Dark horror atmosphere. Motion tracker tension. Military props scattered.\n\n5. **Brothers in Arms** (brothers type): Open canyon terrain with dynamic terrain. Marcus&#39;s mech (marcus_mech.glb). Dust storm particles. The Breach sinkhole visible. Bioluminescent growths near sinkhole edge.\n\n6. **Southern Ice** (ice type): Dynamic terrain with ice/snow materials. Frozen fog particles. Crystalline formations. Ice-adapted enemy variants. Thermal vent areas.\n\n7. **The Breach** (hive type): Use ALL 7 hive GLB models. Organic tunnel segments built from hive models. Bioluminescent lighting (point lights, emissive materials). Egg clusters. Queen&#39;s chamber as hand-crafted arena. Currently the ONLY level using hive models - expand this.\n\n8. **Hive Assault** (combined_arms type): Surface transitioning to hive. Mix of dynamic terrain + hive models. Marcus mech fighting. Wire WraithTank as enemy vehicle. Combined chaos.\n\n9. **Extraction** (extraction type): LZ Omega clearing. Dynamic terrain with barricades made from station/prop models. Collapsing ground effects. Dropship (phantom.glb arriving).\n\n10. **Final Escape** (finale type): Dynamic terrain canyon disintegrating. Vehicle escape. Wire PhantomDropship as transport. Collapsing terrain effects.\n\nASSET GAPS TO REPORT:\nIdentify what models are MISSING that we need for the vision. The user wants a gap report.\n\nFor each level, specify:\n- Which GLB models to use and how to arrange them\n- Lighting setup (type, color, intensity from PSX-ASSETS.md)\n- Sky/atmosphere (skybox, fog, particles)\n- Audio atmosphere\n- Model loading strategy (AssetManager manifests)&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T18-56-47-696Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T18-56-47-696Z" class="timestamp-link"><time datetime="2026-01-30T18:56:47.696Z" data-timestamp="2026-01-30T18:56:47.696Z">2026-01-30T18:56:47.696Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_015es1G9a7Z5M5fmQgV26c2b"><div class="tool-header"><span class="tool-icon">⚙</span> Task</div><div class="tool-description">Splash screen and UI polish plan</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;subagent_type&#34;: &#34;Plan&#34;,
  &#34;prompt&#34;: &#34;Design the splash screen, 9-slice button menu, and intro briefing condensation for Stellar Descent.\n\nCONTEXT:\nThe user has placed assets in incoming-ui/:\n- splash-16-9.mp4 (12MB, landscape)\n- splash-9-16.mp4 (12MB, portrait)\n- buttons.json with 4 button states (normal, hover, pressed, disabled) as 9-slice PNGs\n- Button config: 512x192 recommended size, slice insets L/R 96px T/B 64px\n- CSS: borderImageSlice \&#34;64 96 64 96 fill\&#34;, borderImageWidth \&#34;32px\&#34;, borderImageRepeat \&#34;stretch\&#34;\n- Button PNGs at: assets/ui/buttons/btn_military_olive_{normal,hover,pressed,disabled}.png\n\nREQUIREMENTS:\n\n1. **Splash Screen**: \n- Show MP4 video on app launch (before menu)\n- Responsive: 16:9 for landscape, 9:16 for portrait\n- Detect orientation and pick correct video\n- Works on web (Vite PWA), iOS (Capacitor), Android (Capacitor)\n- Video plays once, then transitions to main menu\n- User can tap to skip\n- Move videos from incoming-ui/ to appropriate public/ location\n\n2. **9-Slice Military Buttons**:\n- Replace current main menu buttons with 9-slice military olive buttons\n- Use CSS border-image property with the button PNGs\n- 4 states: normal, hover, pressed, disabled\n- Move button PNGs from incoming-ui/ to appropriate public/assets/ location\n- Create a reusable MilitaryButton React component\n- Use for: New Game, Continue, Settings, and all major menu buttons\n- Mobile-first: minimum 44px touch targets\n\n3. **Condensed Intro Briefing**:\n- Currently the briefing types out too slowly\n- CONDENSE the text - shorter, punchier\n- Trigger ONCE after New Game, save \&#34;seenIntroBriefing\&#34; flag in GameSave\n- On subsequent plays / Continue, skip straight to level select or barracks\n- Start in a BARRACKS ROOM in the space base (not briefing room)\n- Use station GLB models for beds/furniture\n- After briefing completes, transition to Anchor Station tutorial\n\n4. **CampaignDirector Integration**:\n- Splash → Menu → (New Game) → Intro Briefing (if not seen) → Barracks → Tutorial\n- Splash → Menu → (Continue) → Last saved level\n\nTECH STACK:\n- React 19, TypeScript 5.9, Vite PWA\n- CSS Modules for styling\n- Capacitor 8.x for native\n- Design tokens in designTokens.ts\n- Fonts: Rajdhani (UI), Share Tech Mono (data), Black Ops One (titles)\n\nDesign the component hierarchy, file structure, and implementation approach. Include how to handle the video element lifecycle, orientation detection, and the 9-slice CSS technique.&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T19-00-16-930Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T19-00-16-930Z" class="timestamp-link"><time datetime="2026-01-30T19:00:16.930Z" data-timestamp="2026-01-30T19:00:16.930Z">2026-01-30T19:00:16.930Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Now I have all the information needed. Here is the comprehensive implementation plan.

---

## Stellar Descent: Splash Screen, 9-Slice Buttons, and Intro Briefing Condensation -- Implementation Plan

### 1. Architecture Overview

The implementation touches four main areas, listed in dependency order:

1. **Asset placement** -- move incoming-ui/ files to proper `public/` locations
2. **SplashScreen component** -- new `&#x27;splash&#x27;` GameState, video player with orientation detection
3. **MilitaryButton component** -- reusable 9-slice button using CSS `border-image`
4. **Condensed Intro Briefing + CampaignDirector** -- new `seenIntroBriefing` flag in GameSave, condensed text, barracks concept, updated flow routing

### 2. Asset Placement

Files to move from `incoming-ui/` to `public/`:

```
incoming-ui/splash-16-9.mp4         -&gt; public/video/splash-16-9.mp4
incoming-ui/splash-9-16.mp4         -&gt; public/video/splash-9-16.mp4
incoming-ui/assets/ui/buttons/*.png  -&gt; public/assets/ui/buttons/*.png
```

Update `vite.config.ts` to include `**/*.mp4` in the PWA workbox `globPatterns` array and add a runtime caching rule for video:

```ts
// Add to globPatterns:
&#x27;**/*.{mp4,webm}&#x27;

// Add runtimeCaching entry:
{
  urlPattern: /\.(?:mp4|webm)$/i,
  handler: &#x27;CacheFirst&#x27;,
  options: {
    cacheName: &#x27;game-video&#x27;,
    expiration: { maxEntries: 10, maxAgeSeconds: 60 * 60 * 24 * 30 },
    cacheableResponse: { statuses: [0, 200] },
    rangeRequests: true,
  },
},
```

Also add the button PNGs to the `includeAssets` array so they are precached.

---

### 3. Splash Screen Component

#### 3.1 New GameState: `&#x27;splash&#x27;`

In `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx`, extend the `GameState` union:

```ts
export type GameState =
  | &#x27;splash&#x27;    // &lt;-- NEW: video splash before title
  | &#x27;title&#x27;
  | &#x27;menu&#x27;
  // ... rest unchanged
```

#### 3.2 File Structure

```
src/components/ui/SplashScreen.tsx
src/components/ui/SplashScreen.module.css
```

#### 3.3 Component Design: `SplashScreen`

```tsx
interface SplashScreenProps {
  onComplete: () =&gt; void;
}
```

**Key implementation details:**

1. **Orientation detection hook** -- Create a small `useOrientation()` hook (or inline) using `window.matchMedia(&#x27;(orientation: portrait)&#x27;)` plus a `change` event listener. This fires synchronously on orientation change, which is more reliable than comparing `innerWidth` vs `innerHeight` during resize. The existing `getScreenInfo()` in `responsive.ts` already has orientation detection but lacks a reactive hook. Either create `useOrientation()` in `src/hooks/` or add one to `responsive.ts`.

2. **Video source selection** -- Based on orientation, set the `&lt;video&gt;` element&#x27;s `src` attribute:
   - Landscape: `/video/splash-16-9.mp4`
   - Portrait: `/video/splash-9-16.mp4`

   On orientation change mid-playback, swap the source. The `&lt;video&gt;` element must be controlled with a ref to handle the swap (save `currentTime`, swap `src`, seek to saved time, play).

3. **Video element lifecycle**:
   ```tsx
   const videoRef = useRef&lt;HTMLVideoElement&gt;(null);
   
   // On mount: attempt autoplay with muted fallback
   useEffect(() =&gt; {
     const video = videoRef.current;
     if (!video) return;
     
     video.play().catch(() =&gt; {
       // Autoplay blocked (common on mobile) -- show tap-to-play overlay
       // or skip directly to menu
       video.muted = true;
       video.play().catch(() =&gt; onComplete());
     });
   }, []);
   ```

4. **Completion and skip**:
   - `onEnded` event on `&lt;video&gt;` calls `onComplete()`
   - Click/tap anywhere calls `onComplete()` (skip)
   - Keyboard press calls `onComplete()` (skip)
   - A small &quot;TAP TO SKIP&quot; hint appears after 2 seconds (same pattern as TitleSequence&#x27;s `skipHint`)

5. **Capacitor native handling**: On Capacitor (iOS/Android), the `&lt;video&gt;` element plays inline with `playsInline` attribute. Add `webkit-playsinline` for older iOS WebView. The `muted` attribute may be needed for autoplay policy. If the video cannot autoplay at all, skip to `onComplete()` gracefully.

6. **CSS** (`SplashScreen.module.css`):
   ```css
   .overlay {
     position: fixed;
     inset: 0;
     background: #000;
     z-index: 1100; /* Above TitleSequence (1000) and menu (100) */
     display: flex;
     align-items: center;
     justify-content: center;
   }
   
   .video {
     width: 100%;
     height: 100%;
     object-fit: cover;
   }
   
   .skipHint {
     position: absolute;
     bottom: 2rem;
     /* Same styling as TitleSequence.module.css .skipHint */
     font-family: &quot;Share Tech Mono&quot;, &quot;Courier New&quot;, monospace;
     font-size: 0.625rem;
     color: #444;
     letter-spacing: 0.15em;
     opacity: 0;
     animation: fadeIn 2s ease-out 2s forwards;
   }
   ```

#### 3.4 Integration in App.tsx

In `getInitialGameState()`:

```ts
const getInitialGameState = (): GameState =&gt; {
  if (getStartLevelFromURL()) return &#x27;menu&#x27;;
  if (sessionStorage.getItem(TITLE_SHOWN_KEY)) return &#x27;menu&#x27;;
  return &#x27;splash&#x27;; // &lt;-- Was &#x27;title&#x27;, now starts with splash
};
```

Add splash handling in the render:

```tsx
{gameState === &#x27;splash&#x27; &amp;&amp; &lt;SplashScreen onComplete={handleSplashComplete} /&gt;}
```

Add handler:

```ts
const handleSplashComplete = useCallback(() =&gt; {
  setGameState(&#x27;title&#x27;); // Splash -&gt; Title sequence -&gt; Menu
}, []);
```

The flow becomes: `splash` -&gt; `title` -&gt; `menu`.

Also add `&#x27;splash&#x27;` to the skip-on-escape check in the keydown handler (lines 462-473 of App.tsx).

---

### 4. MilitaryButton Component (9-Slice)

#### 4.1 File Structure

```
src/components/ui/MilitaryButton.tsx
src/components/ui/MilitaryButton.module.css
```

#### 4.2 Component Design

```tsx
interface MilitaryButtonProps {
  children: React.ReactNode;
  onClick?: () =&gt; void;
  disabled?: boolean;
  variant?: &#x27;primary&#x27; | &#x27;default&#x27; | &#x27;danger&#x27;;
  size?: &#x27;sm&#x27; | &#x27;md&#x27; | &#x27;lg&#x27;;
  icon?: React.ReactNode;
  className?: string;
  type?: &#x27;button&#x27; | &#x27;submit&#x27;;
  &#x27;aria-label&#x27;?: string;
}
```

**9-Slice CSS technique:**

The CSS `border-image` property is the core mechanism. Each button state (normal, hover, pressed, disabled) uses a different PNG. The `border-image-slice` property cuts the source image into 9 regions using the insets from `buttons.json`.

```css
.button {
  /* Reset native button styles */
  background: transparent;
  border: none;
  padding: 0;
  
  /* 9-slice via border-image */
  border-style: solid;
  border-width: 32px;  /* borderImageWidth from buttons.json */
  border-image-source: url(&#x27;/assets/ui/buttons/btn_military_olive_normal.png&#x27;);
  border-image-slice: 64 96 64 96 fill;  /* T R B L + fill for center */
  border-image-width: 32px;
  border-image-repeat: stretch;
  
  /* Text styling */
  font-family: &quot;Share Tech Mono&quot;, &quot;Courier New&quot;, monospace;
  font-size: 0.875rem;
  color: #e8e8e8;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  cursor: pointer;
  
  /* Mobile-first: minimum 44px touch target */
  min-height: 44px;
  padding: 0.5rem 1.5rem; /* Inside the 9-slice center fill */
  
  /* Layout */
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 0.75rem;
  width: 100%;
  
  /* Smooth transitions aren&#x27;t possible for border-image-source,
     so use opacity transition on pseudo-elements or swap class */
  transition: transform 0.1s ease;
}

.button:hover:not(:disabled) {
  border-image-source: url(&#x27;/assets/ui/buttons/btn_military_olive_hover.png&#x27;);
}

.button:active:not(:disabled) {
  border-image-source: url(&#x27;/assets/ui/buttons/btn_military_olive_pressed.png&#x27;);
  transform: scale(0.98);
}

.button:disabled {
  border-image-source: url(&#x27;/assets/ui/buttons/btn_military_olive_disabled.png&#x27;);
  color: #666;
  cursor: not-allowed;
}
```

**Important considerations:**

- The `fill` keyword in `border-image-slice` is essential -- it tells the browser to also render the center slice (region 5 of the 9-slice grid). Without it, the center would be transparent.
- Since `border-image-source` transitions are not animatable in CSS, state changes are instant (which is fine for a military/tactical aesthetic).
- For the `primary` variant, apply a subtle CSS filter or different opacity treatment.
- For the `danger` variant (used in &quot;START NEW&quot; confirm dialog), apply a red-tinted filter.
- Preload the button images to avoid flash-of-unstyled-button:
  ```tsx
  // In MilitaryButton.tsx or a preload utility
  const BUTTON_IMAGES = [
    &#x27;/assets/ui/buttons/btn_military_olive_normal.png&#x27;,
    &#x27;/assets/ui/buttons/btn_military_olive_hover.png&#x27;,
    &#x27;/assets/ui/buttons/btn_military_olive_pressed.png&#x27;,
    &#x27;/assets/ui/buttons/btn_military_olive_disabled.png&#x27;,
  ];
  ```
  Add `&lt;link rel=&quot;preload&quot;&gt;` tags in `index.html` or use JS `Image()` preloading.

#### 4.3 Integration into MainMenu

Replace all `&lt;button&gt;` elements in `MainMenu.tsx` with `&lt;MilitaryButton&gt;`. The current buttons use classes from `MainMenu.module.css` (`.button`, `.primaryButton`, `.dangerButton`). The replacement is mechanical:

```tsx
// Before:
&lt;button className={`${styles.button} ${styles.primaryButton}`} onClick={handleContinue}&gt;
  &lt;span className={styles.buttonIcon}&gt;...&lt;/span&gt;
  CONTINUE
&lt;/button&gt;

// After:
&lt;MilitaryButton variant=&quot;primary&quot; onClick={handleContinue} icon={&lt;span&gt;...&lt;/span&gt;}&gt;
  CONTINUE
&lt;/MilitaryButton&gt;
```

Also update buttons in:
- `PauseMenu.tsx`
- `DeathScreen.tsx`
- `LevelCompletionScreen.tsx`
- `MissionBriefing.tsx` (BEGIN MISSION / ABORT buttons)
- `SettingsMenu.tsx`
- Confirmation modals in MainMenu

The modal buttons (`.modalButton`, `.modalClose`) should also use MilitaryButton but with a smaller `size=&quot;sm&quot;` variant.

---

### 5. Condensed Intro Briefing + CampaignDirector Flow

#### 5.1 Add `seenIntroBriefing` to GameSave

In `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/GameSave.ts`:

```ts
export interface GameSave {
  // ... existing fields ...
  
  /** Whether the intro briefing has been seen (skip on Continue) */
  seenIntroBriefing: boolean;
}
```

Bump `SAVE_FORMAT_VERSION` to 3 and add migration in `SaveSystem.ts`:

```ts
// v2 -&gt; v3: Add seenIntroBriefing field
if (save.version &lt; 3) {
  save.seenIntroBriefing = save.seenIntroBriefing ?? false;
}
```

Add methods to `SaveSystem`:

```ts
markIntroBriefingSeen(): void {
  if (!this.currentSave) return;
  this.currentSave.seenIntroBriefing = true;
  this.autoSave();
}

hasSeenIntroBriefing(): boolean {
  return this.currentSave?.seenIntroBriefing ?? false;
}
```

#### 5.2 Condense the Briefing Text

The current `BRIEFING_LINES` in `TitleSequence.tsx` has 20+ lines and types at 80ms per character. The requirement is &quot;shorter, punchier.&quot; The condensed version should be approximately 8-10 lines:

```ts
const CONDENSED_BRIEFING_LINES = [
  &#x27;PRIORITY ALPHA // TEA COMMAND&#x27;,
  &#x27;&#x27;,
  &#x27;Recon Team VANGUARD deployed to PCb-7. 72 hours ago.&#x27;,
  &#x27;FOB DELTA established. Then silence.&#x27;,
  &#x27;&#x27;,
  &#x27;All contact lost. No distress signal.&#x27;,
  &#x27;Something woke beneath the surface.&#x27;,
  &#x27;&#x27;,
  &#x27;Find your brother. Find the truth.&#x27;,
  &#x27;&#x27;,
  &#x27;&gt;&gt;&gt; SPECTER: CLEARED FOR ORBITAL DROP &lt;&lt;&lt;&#x27;,
];
```

The typing speed should also increase from 80ms to 40ms per character to keep the feel punchy.

#### 5.3 IntroBriefing Component (Post-New-Game)

This is distinct from the TitleSequence (which plays on every fresh session) and the MissionBriefing (which plays before each level). The IntroBriefing plays once after New Game, before the first level.

**Option A (preferred):** Modify the existing flow so that when `handleStartGame` is called (New Game), the app checks `seenIntroBriefing`. If not seen, route to a new `&#x27;introBriefing&#x27;` GameState that shows the condensed briefing. After completion, mark it seen and proceed to loading/tutorial.

**Option B:** Integrate the condensed briefing into the existing `MissionBriefing` component as a special &quot;intro&quot; mode with `commanderBriefing` text overridden.

Recommendation: **Option A** -- a distinct `IntroBriefing` component keeps concerns separate.

New GameState value: `&#x27;introBriefing&#x27;`

Updated `GameState` type:

```ts
export type GameState =
  | &#x27;splash&#x27;
  | &#x27;title&#x27;
  | &#x27;menu&#x27;
  | &#x27;introBriefing&#x27; // &lt;-- NEW
  | &#x27;briefing&#x27;
  | &#x27;intro&#x27;
  | &#x27;loading&#x27;
  // ... rest
```

#### 5.4 IntroBriefing Component

```
src/components/ui/IntroBriefing.tsx
src/components/ui/IntroBriefing.module.css
```

This component reuses the visual patterns from `TitleSequence` (star field, scan lines, typing text) but with the condensed briefing text. It shows a barracks room context -- the text is delivered as a comm message while the player is conceptually in their barracks bunk. The visual design:

- Black background with scan lines (reuse TitleSequence CSS patterns)
- Header: &quot;BARRACKS // ANCHOR STATION PROMETHEUS&quot;
- Portrait of Commander Vasquez (reuse the existing `[CV]` portrait pattern from CommsDisplay)
- Condensed briefing text typed out
- After typing completes, &quot;ACKNOWLEDGED&quot; button (MilitaryButton)
- Skip on tap/keypress

After completion, it calls `onComplete()` and the save system marks `seenIntroBriefing = true`.

#### 5.5 CampaignDirector Flow Changes in App.tsx

Update `handleStartGame` (New Game):

```ts
const handleStartGame = useCallback(async () =&gt; {
  // Create the new save (difficulty was already selected)
  // Check if intro briefing needs to be shown
  if (!saveSystem.hasSeenIntroBriefing()) {
    setGameState(&#x27;introBriefing&#x27;);
  } else {
    // Skip to mission briefing for Anchor Station
    setSkipTutorial(false);
    setCurrentLevelId(&#x27;anchor_station&#x27;);
    setBriefingLevelId(&#x27;anchor_station&#x27;);
    setGameState(&#x27;briefing&#x27;);
  }
}, []);
```

Update `handleContinue` (Continue):

```ts
const handleContinue = useCallback(async () =&gt; {
  const save = await saveSystem.loadGame();
  if (save &amp;&amp; onContinue) {
    // Continue always skips intro briefing -- go straight to
    // the briefing for the saved level, or to loading
    onContinue();
  }
}, [onContinue, onStart]);
```

Add handler for intro briefing completion:

```ts
const handleIntroBriefingComplete = useCallback(() =&gt; {
  saveSystem.markIntroBriefingSeen();
  // Proceed to Anchor Station tutorial flow
  setSkipTutorial(false);
  setCurrentLevelId(&#x27;anchor_station&#x27;);
  setBriefingLevelId(&#x27;anchor_station&#x27;);
  setGameState(&#x27;briefing&#x27;);
}, []);
```

Add rendering:

```tsx
{gameState === &#x27;introBriefing&#x27; &amp;&amp; (
  &lt;IntroBriefing onComplete={handleIntroBriefingComplete} /&gt;
)}
```

#### 5.6 Full Flow Summary

**New Game (first time):**
```
splash -&gt; title -&gt; menu -&gt; [New Game] -&gt; difficultySelect -&gt; introBriefing -&gt; briefing -&gt; intro -&gt; loading -&gt; tutorial
```

**New Game (subsequent, intro already seen):**
```
splash -&gt; title -&gt; menu -&gt; [New Game] -&gt; difficultySelect -&gt; briefing -&gt; intro -&gt; loading -&gt; tutorial
```

**Continue:**
```
splash -&gt; title -&gt; menu -&gt; [Continue] -&gt; briefing -&gt; intro -&gt; loading -&gt; [last saved level]
```

**Return visit (same session):**
```
menu -&gt; [New Game or Continue] -&gt; ... (splash and title skipped via sessionStorage)
```

---

### 6. Barracks Room Context

The requirement mentions starting in a &quot;BARRACKS ROOM in the space base (not briefing room)&quot; and using &quot;station GLB models for beds/furniture.&quot; This is about the Anchor Station layout. Currently, the station layout (from the AnchorStationLevel header comment) is:

```
BRIEFING ROOM (20m x 15m) -&gt; CORRIDOR A -&gt; EQUIPMENT BAY -&gt; SHOOTING RANGE -&gt; HANGAR BAY
```

The proposal is to change the first room from &quot;Briefing Room&quot; to &quot;Barracks.&quot; This is an environment/level change inside `AnchorStationLevel.ts` and `ModularStationEnvironment.ts`:

- The starting spawn room should have bunks/beds instead of briefing room furniture
- Use existing station GLB models (`station_barrel.glb`, floor/wall pieces) plus new simple bunk geometry built with `MeshBuilder` (box shapes for beds, standard materials with military olive/khaki colors from design tokens)
- The room is purely atmospheric -- the player starts here, receives the briefing comm while in the barracks, then proceeds to the corridor

This is a lower-priority change compared to the UI components. It modifies the `MODULAR_ROOM_POSITIONS` or the `createModularStationEnvironment()` function to rename/restyle the first room.

---

### 7. Implementation Sequence

| Step | Files | Dependency |
|------|-------|-----------|
| 1. Move assets | `public/video/`, `public/assets/ui/buttons/`, `vite.config.ts` | None |
| 2. MilitaryButton | `MilitaryButton.tsx`, `MilitaryButton.module.css` | Step 1 (button PNGs) |
| 3. Apply MilitaryButton to MainMenu | `MainMenu.tsx`, `MainMenu.module.css` | Step 2 |
| 4. Apply MilitaryButton to other menus | `PauseMenu.tsx`, `DeathScreen.tsx`, `MissionBriefing.tsx`, etc. | Step 2 |
| 5. SplashScreen | `SplashScreen.tsx`, `SplashScreen.module.css` | Step 1 (videos) |
| 6. Add &#x27;splash&#x27; to GameState + App.tsx routing | `GameCanvas.tsx`, `App.tsx` | Step 5 |
| 7. Extend GameSave with seenIntroBriefing | `GameSave.ts`, `SaveSystem.ts` | None |
| 8. IntroBriefing component | `IntroBriefing.tsx`, `IntroBriefing.module.css` | Step 2, 7 |
| 9. Condense briefing text | `TitleSequence.tsx` (update BRIEFING_LINES) or `IntroBriefing.tsx` | None |
| 10. CampaignDirector wiring | `App.tsx`, `GameCanvas.tsx` | Steps 5-9 |
| 11. Barracks room env | `AnchorStationLevel.ts`, `ModularStationEnvironment.ts` | None |

---

### 8. Potential Challenges

1. **Video autoplay on mobile**: iOS Safari and Android Chrome both restrict autoplay. The `muted` + `playsInline` approach should work for muted autoplay, but if the user wants audio, they must tap first. The design handles this gracefully by allowing tap-to-skip.

2. **Orientation swap mid-video**: Swapping video `src` causes a brief black frame. Mitigation: use two `&lt;video&gt;` elements (one for each orientation), both loaded but only one visible, toggled via CSS `display:none` / `display:block`. Sync playback time on swap using `currentTime`.

3. **9-slice with CSS border-image**: The technique is well-supported across browsers. The main gotcha is that `border-image` does not respect `border-radius` -- the buttons will have square corners defined by the PNG artwork itself, which matches the military aesthetic.

4. **PWA caching of 12MB videos**: The splash videos are ~12MB each (24MB total). The workbox `maximumFileSizeToCacheInBytes` is currently set to 15MB. This needs to be increased to at least 25MB, or better, use runtime caching with `CacheFirst` for video URLs rather than precaching. This avoids bloating the initial service worker install. The runtime caching approach is preferred.

5. **Save format migration**: Bumping `SAVE_FORMAT_VERSION` to 3 requires proper migration code. Existing v2 saves get `seenIntroBriefing: false` added during migration, which is correct behavior -- they should see the intro briefing on their next &quot;New Game&quot; but not on &quot;Continue.&quot;

---

### Critical Files for Implementation

- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/App.tsx` - Central state machine and routing; must add &#x27;splash&#x27; and &#x27;introBriefing&#x27; states, wire new components and CampaignDirector flow
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx` - GameState type definition; must extend union with new states
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/MainMenu.tsx` - All buttons must be replaced with MilitaryButton; largest consumer of the new component
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/GameSave.ts` - Must add seenIntroBriefing field, bump version, update createNewSave default
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/ui/TitleSequence.tsx` - Reference pattern for IntroBriefing component (star field, typing text, skip behavior); briefing text to condense</pre><pre>agentId: a3fd685 (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T19-00-40-609Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T19-00-40-609Z" class="timestamp-link"><time datetime="2026-01-30T19:00:40.609Z" data-timestamp="2026-01-30T19:00:40.609Z">2026-01-30T19:00:40.609Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Here is the complete CampaignDirector architecture design.

---

# CampaignDirector Architecture for Stellar Descent: Proxima Breach

## 1. Current Architecture Diagnosis

After reading every relevant file, here is what exists and what is broken:

**What Works:**
- `CAMPAIGN_LEVELS` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/types.ts` -- 10-level linked list with full configs, traversal utilities, and `ILevel` interface
- `LevelManager` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/LevelManager.ts` -- complete level lifecycle orchestrator (create, dispose, transition, persist) -- but UNUSED
- `BaseLevel` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/BaseLevel.ts` -- 1122-line abstract base class implementing `ILevel` with camera, input, post-processing, weather, audio, and camera shake
- `factories.ts` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/factories.ts` -- all 11 LevelType factories registered (but `canyon` throws)
- `SaveSystem` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/persistence/SaveSystem.ts` -- singleton with `setObjective()`, `completeLevel()`, `setLevelFlag()`, etc. -- functional but objectives are never populated
- `AchievementManager` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/achievements/AchievementManager.ts` -- 38 achievements, 15+ trigger methods (`onKill`, `onLevelComplete`, `onQueenDefeated`, `onMarcusFound`, etc.) -- initialized at startup but triggers are only partially wired
- `ReyesDialogueManager` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/audio/ReyesDialogue.ts` -- 822 LOC, briefings for all 10 levels, 17 in-mission triggers, priority queue -- fully built, never imported outside its own file
- `VehicleBase` / `PhantomDropship` / `WraithTank` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/vehicles/` -- complete enter/exit, camera swap, weapon heat, damage model -- never instantiated
- `AudioLogSystem` / `SkullSystem` / `SecretAreaSystem` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/collectibles/` -- complete with persistence, glow meshes, pickup logic -- never instantiated in levels
- `MiningDepthsLevel` in `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/mining-depths/MiningDepthsLevel.ts` -- 72KB, full level with phases, burrower enemies, drill boss, audio logs -- not in campaign, no factory

**What Is Broken:**
- `GameCanvas` at `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx` has **dual rendering paths**: `tutorialLevelRef` (ILevel) and `gameManagerRef` (GameManager). Lines 475-493 show the render loop branching between these two incompatible systems.
- `App.tsx` at `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/App.tsx` is 702 lines with ~15 `useCallback` hooks manually orchestrating state transitions (`handleStartGame`, `handleContinue`, `handleSkipTutorial`, `handleLoadComplete`, `handleTutorialComplete`, `handleDropComplete`, `handleLevelComplete`, `handleContinueToNextLevel`, etc.)
- `GameState` type in `GameCanvas.tsx` (line 217) includes `tutorial` and `dropping` as separate states -- these should be `playing` with the level handling it internally
- `canyonLevelFactory` throws on line 61 of `factories.ts`
- `useLevelManager` hook exists but is never used
- GameManager owns Player, ChunkManager, CombatSystem, AISystem but is NOT ILevel-compatible

---

## 2. CampaignDirector State Machine

### 2.1 CampaignPhase Type

```typescript
// src/game/campaign/types.ts

export type CampaignPhase =
  | &#x27;idle&#x27;          // No campaign active
  | &#x27;splash&#x27;        // Engine/title cinematic
  | &#x27;menu&#x27;          // Main menu
  | &#x27;briefing&#x27;      // Mission briefing overlay
  | &#x27;intro&#x27;         // Level intro cinematic
  | &#x27;loading&#x27;       // Asset loading
  | &#x27;playing&#x27;       // Active gameplay (ALL levels -- tutorial, drop, surface, vehicle)
  | &#x27;paused&#x27;        // Pause overlay
  | &#x27;levelComplete&#x27; // Level completion screen
  | &#x27;gameover&#x27;      // Death screen
  | &#x27;credits&#x27;;      // End credits

export type CampaignCommand =
  | { type: &#x27;NEW_GAME&#x27;; difficulty?: DifficultyLevel }
  | { type: &#x27;CONTINUE&#x27; }
  | { type: &#x27;SELECT_LEVEL&#x27;; levelId: LevelId }
  | { type: &#x27;BEGIN_MISSION&#x27; }       // briefing -&gt; intro
  | { type: &#x27;INTRO_COMPLETE&#x27; }      // intro -&gt; loading
  | { type: &#x27;LOADING_COMPLETE&#x27; }    // loading -&gt; playing
  | { type: &#x27;LEVEL_COMPLETE&#x27;; stats: LevelStats }  // playing -&gt; levelComplete
  | { type: &#x27;ADVANCE&#x27; }            // levelComplete -&gt; briefing (next level) or credits
  | { type: &#x27;RETRY&#x27; }              // levelComplete or gameover -&gt; loading (same level)
  | { type: &#x27;PAUSE&#x27; }              // playing -&gt; paused
  | { type: &#x27;RESUME&#x27; }             // paused -&gt; playing
  | { type: &#x27;PLAYER_DIED&#x27; }        // playing -&gt; gameover
  | { type: &#x27;MAIN_MENU&#x27; }          // any -&gt; menu
  | { type: &#x27;CREDITS_DONE&#x27; }       // credits -&gt; menu
  | { type: &#x27;ENTER_BONUS_LEVEL&#x27;; levelId: BonusLevelId }  // from FOB Delta
  | { type: &#x27;BONUS_COMPLETE&#x27; }     // bonus -&gt; return to origin level briefing
```

### 2.2 State Transition Table

```
idle       + NEW_GAME/CONTINUE/SELECT_LEVEL -&gt; briefing
splash     + (auto)                          -&gt; menu
menu       + NEW_GAME                        -&gt; briefing (anchor_station)
menu       + CONTINUE                        -&gt; briefing (saved level)
menu       + SELECT_LEVEL                    -&gt; briefing (selected level)
briefing   + BEGIN_MISSION                   -&gt; intro
briefing   + MAIN_MENU                       -&gt; menu
intro      + INTRO_COMPLETE                  -&gt; loading
loading    + LOADING_COMPLETE                -&gt; playing
playing    + LEVEL_COMPLETE                  -&gt; levelComplete
playing    + PAUSE                           -&gt; paused
playing    + PLAYER_DIED                     -&gt; gameover
playing    + ENTER_BONUS_LEVEL               -&gt; briefing (mining_depths)
paused     + RESUME                          -&gt; playing
paused     + MAIN_MENU                       -&gt; menu
paused     + RETRY                           -&gt; loading
levelComplete + ADVANCE                      -&gt; briefing (next) or credits (if final)
levelComplete + RETRY                        -&gt; loading
levelComplete + MAIN_MENU                    -&gt; menu
gameover   + RETRY                           -&gt; loading (same level)
gameover   + MAIN_MENU                       -&gt; menu
credits    + CREDITS_DONE                    -&gt; menu
```

### 2.3 Key Design Decision: Tutorial and Drop Are Just Levels

The current code has `tutorial` and `dropping` as separate GameState values. This is wrong. AnchorStation IS the tutorial level -- it implements ILevel. Landfall IS the drop level -- it handles the HALO drop sequence internally in its `update()` method. CampaignDirector always goes to `playing` when any ILevel is active. The level itself manages its internal phases (tutorial steps, drop sequence, boss fights, etc.) through its own state machine. The `LevelCallbacks.onLevelComplete(nextLevelId)` callback is how a level signals it is done.

This means `GameManager` must either:
(a) Be wrapped as an ILevel adapter (LandfallLevel already exists as an ILevel), or
(b) Be retired in favor of the ILevel-based LandfallLevel

Since `LandfallLevel` already exists at `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/landfall/LandfallLevel.ts` and is created by `dropLevelFactory`, GameManager&#x27;s functionality (Player, ChunkManager, CombatSystem, AISystem) should be absorbed into LandfallLevel and SurfaceLevel as composable systems. The `GameManager` class continues to exist but is only used internally by SurfaceLevel-derived levels, not directly by GameCanvas.

---

## 3. CampaignDirector Class Design

### 3.1 File: `src/game/campaign/CampaignDirector.ts`

```typescript
import type { Engine } from &#x27;@babylonjs/core/Engines/engine&#x27;;
import { getAchievementManager } from &#x27;../achievements&#x27;;
import { getReyesDialogueManager, disposeReyesDialogueManager } from &#x27;../audio/ReyesDialogue&#x27;;
import { AudioLogSystem } from &#x27;../collectibles/AudioLogSystem&#x27;;
import { SecretAreaSystem } from &#x27;../collectibles/SecretAreaSystem&#x27;;
import { SkullPickupManager } from &#x27;../collectibles/SkullPickup&#x27;;
import type { LevelId, ILevel, LevelCallbacks, LevelConfig } from &#x27;../levels/types&#x27;;
import { CAMPAIGN_LEVELS, getFirstLevel } from &#x27;../levels/types&#x27;;
import { LevelManager, type LevelManagerConfig } from &#x27;../levels/LevelManager&#x27;;
import { defaultLevelFactories } from &#x27;../levels/factories&#x27;;
import { saveSystem } from &#x27;../persistence&#x27;;
import type { CampaignPhase, CampaignCommand, CampaignSnapshot, MissionDefinition } from &#x27;./types&#x27;;
import { MISSION_DEFINITIONS, BONUS_LEVELS } from &#x27;./MissionDefinitions&#x27;;

export type CampaignListener = (snapshot: CampaignSnapshot) =&gt; void;

export class CampaignDirector {
  // --- State ---
  private phase: CampaignPhase = &#x27;idle&#x27;;
  private prePausePhase: CampaignPhase | null = null;
  private currentLevelId: LevelId = &#x27;anchor_station&#x27;;
  private pendingLevelId: LevelId | null = null;
  private isBonusLevel = false;
  private returnLevelId: LevelId | null = null; // where to return after bonus level

  // --- Sub-systems (owned) ---
  private levelManager: LevelManager | null = null;
  private reyes: ReturnType&lt;typeof getReyesDialogueManager&gt; | null = null;

  // --- Sub-systems (per-level, created/destroyed with level) ---
  private audioLogSystem: AudioLogSystem | null = null;
  private secretAreaSystem: SecretAreaSystem | null = null;
  private skullPickupManager: SkullPickupManager | null = null;

  // --- Infrastructure ---
  private engine: Engine | null = null;
  private canvas: HTMLCanvasElement | null = null;
  private listeners = new Set&lt;CampaignListener&gt;();

  // --- Stats ---
  private levelStartTime = 0;
  private levelKills = 0;
```

### 3.2 Initialization

```typescript
  /**
   * Bind to a Babylon engine + canvas.
   * Called once when GameCanvas mounts.
   */
  attach(engine: Engine, canvas: HTMLCanvasElement): void {
    this.engine = engine;
    this.canvas = canvas;
  }

  /**
   * Detach and dispose all resources.
   * Called when GameCanvas unmounts.
   */
  detach(): void {
    this.levelManager?.dispose();
    this.levelManager = null;
    this.disposeCollectibles();
    disposeReyesDialogueManager();
    this.reyes = null;
    this.engine = null;
    this.canvas = null;
  }
```

### 3.3 Command Dispatch (the public API)

```typescript
  /**
   * Process a command. This is the ONLY way external code changes campaign state.
   * React calls this. Levels call this via callbacks. Everything goes through here.
   */
  async dispatch(command: CampaignCommand): Promise&lt;void&gt; {
    switch (command.type) {
      case &#x27;NEW_GAME&#x27;:
        await this.handleNewGame(command.difficulty);
        break;
      case &#x27;CONTINUE&#x27;:
        await this.handleContinue();
        break;
      case &#x27;SELECT_LEVEL&#x27;:
        this.handleSelectLevel(command.levelId);
        break;
      case &#x27;BEGIN_MISSION&#x27;:
        this.setPhase(&#x27;intro&#x27;);
        break;
      case &#x27;INTRO_COMPLETE&#x27;:
        this.setPhase(&#x27;loading&#x27;);
        break;
      case &#x27;LOADING_COMPLETE&#x27;:
        await this.startCurrentLevel();
        break;
      case &#x27;LEVEL_COMPLETE&#x27;:
        this.handleLevelComplete(command.stats);
        break;
      case &#x27;ADVANCE&#x27;:
        this.handleAdvance();
        break;
      case &#x27;RETRY&#x27;:
        this.handleRetry();
        break;
      case &#x27;PAUSE&#x27;:
        this.handlePause();
        break;
      case &#x27;RESUME&#x27;:
        this.handleResume();
        break;
      case &#x27;PLAYER_DIED&#x27;:
        this.handlePlayerDied();
        break;
      case &#x27;MAIN_MENU&#x27;:
        this.handleMainMenu();
        break;
      case &#x27;CREDITS_DONE&#x27;:
        this.setPhase(&#x27;menu&#x27;);
        break;
      case &#x27;ENTER_BONUS_LEVEL&#x27;:
        this.handleEnterBonusLevel(command.levelId);
        break;
      case &#x27;BONUS_COMPLETE&#x27;:
        this.handleBonusComplete();
        break;
    }
  }
```

### 3.4 Core Level Lifecycle

```typescript
  private async startCurrentLevel(): Promise&lt;void&gt; {
    if (!this.engine || !this.canvas) return;

    // Build LevelCallbacks that wire everything together
    const callbacks = this.buildLevelCallbacks();

    // Create LevelManager if needed (or reconfigure)
    if (!this.levelManager) {
      this.levelManager = new LevelManager({
        engine: this.engine,
        canvas: this.canvas,
        callbacks,
        levelFactories: defaultLevelFactories,
      });
    }

    // Initialize Reyes dialogue
    this.reyes = getReyesDialogueManager(callbacks.onCommsMessage);

    // Start the level via LevelManager
    await this.levelManager.startLevel(this.currentLevelId);

    // Initialize collectibles for this level
    this.initializeCollectibles(this.currentLevelId);

    // Play briefing dialogue (happens in-game, overlaid)
    this.reyes.playBriefing(this.currentLevelId);

    // Track stats
    this.levelStartTime = Date.now();
    this.levelKills = 0;

    // Update save system
    saveSystem.setCurrentLevel(this.currentLevelId);

    this.setPhase(&#x27;playing&#x27;);
  }
```

### 3.5 LevelCallbacks Builder -- The Wiring Hub

This is where CampaignDirector wires ALL the disconnected systems:

```typescript
  private buildLevelCallbacks(): LevelCallbacks {
    const achievements = getAchievementManager();

    return {
      onCommsMessage: (msg) =&gt; {
        // Forward to React (via snapshot update)
        this.notify();
      },

      onObjectiveUpdate: (title, instructions) =&gt; {
        // Wire to SaveSystem objectives
        const objectiveKey = `${this.currentLevelId}:${title}`;
        saveSystem.setObjective(objectiveKey, false);
        this.notify();
      },

      onChapterChange: (chapter) =&gt; {
        saveSystem.setChapter(chapter);
      },

      onHealthChange: (health) =&gt; {
        saveSystem.updateHealth(health);
        // Wire Reyes health warnings
        if (this.reyes) {
          if (health &lt; 10) {
            this.reyes.triggerDialogue(&#x27;player_critical_warning&#x27;);
          } else if (health &lt; 30) {
            this.reyes.triggerDialogue(&#x27;player_low_health_warning&#x27;);
          }
        }
        this.notify();
      },

      onKill: () =&gt; {
        this.levelKills++;
        saveSystem.addKill();
        achievements.onKill();
        this.notify();
      },

      onDamage: () =&gt; {
        achievements.onDamageTaken(this.currentLevelId, 1);
      },

      onNotification: (text, duration) =&gt; {
        this.notify();
      },

      onLevelComplete: (nextLevelId) =&gt; {
        // THIS is the key callback. The level itself signals completion.
        // CampaignDirector decides what happens next.
        const stats = this.gatherLevelStats();
        this.dispatch({ type: &#x27;LEVEL_COMPLETE&#x27;, stats });
      },

      onCombatStateChange: (inCombat) =&gt; {
        if (this.reyes) {
          if (inCombat) {
            this.reyes.triggerDialogue(&#x27;hostiles_detected&#x27;);
          } else {
            this.reyes.triggerDialogue(&#x27;hostiles_cleared&#x27;);
          }
        }
        this.notify();
      },

      onCinematicStart: () =&gt; { /* lock HUD */ },
      onCinematicEnd: () =&gt; { /* unlock HUD */ },

      onActionGroupsChange: (_groups) =&gt; { this.notify(); },
      onActionHandlerRegister: (_handler) =&gt; {},
      onHitMarker: (damage, isCritical) =&gt; { this.notify(); },
      onDirectionalDamage: (angle, damage) =&gt; { this.notify(); },
    };
  }
```

### 3.6 Achievement Wiring per Level Completion

```typescript
  private handleLevelComplete(stats: LevelStats): void {
    const achievements = getAchievementManager();
    const levelId = this.currentLevelId;

    // Generic level completion tracking
    saveSystem.completeLevel(levelId);
    achievements.onLevelComplete(levelId, false, saveSystem.getDifficulty());

    // Mark objectives as complete in save
    const objectiveKey = `${levelId}:primary`;
    saveSystem.setObjective(objectiveKey, true);

    // Level-specific achievement triggers
    switch (levelId) {
      case &#x27;anchor_station&#x27;:
        achievements.onTutorialComplete();
        saveSystem.completeTutorial();
        break;
      case &#x27;landfall&#x27;:
        achievements.onHaloDropComplete();
        achievements.onFirstCombatWin();
        break;
      case &#x27;canyon_run&#x27;:
        achievements.onCanyonRunComplete();
        break;
      case &#x27;fob_delta&#x27;:
        // survivor achievement handled by onLevelComplete (playerDied check)
        break;
      case &#x27;brothers_in_arms&#x27;:
        achievements.onBrothersInArmsComplete(/* marcusWentDown from level state */false);
        achievements.onMarcusFound();
        break;
      case &#x27;southern_ice&#x27;:
        achievements.onSouthernIceComplete();
        break;
      case &#x27;the_breach&#x27;:
        achievements.onQueenDefeated();
        break;
      case &#x27;hive_assault&#x27;:
        achievements.onHiveAssaultComplete();
        break;
      case &#x27;extraction&#x27;:
        achievements.onExtractionComplete();
        break;
      case &#x27;final_escape&#x27;:
        achievements.onFinalEscapeComplete(/* crashed */false);
        achievements.onGameComplete();
        break;
    }

    // Auto-save
    saveSystem.autoSave();

    // Reyes mission complete dialogue
    if (this.reyes) {
      this.reyes.triggerDialogue(&#x27;mission_complete&#x27;);
    }

    this.setPhase(&#x27;levelComplete&#x27;);
  }
```

### 3.7 Collectibles Initialization per Level

```typescript
  private initializeCollectibles(levelId: LevelId): void {
    this.disposeCollectibles();

    const level = this.levelManager?.getCurrentLevel();
    if (!level) return;
    const scene = level.getScene();

    // Audio Log System
    this.audioLogSystem = new AudioLogSystem(scene, levelId, {
      onLogCollected: (log) =&gt; {
        getAchievementManager().onAudioLogFound();
        saveSystem.setLevelFlag(levelId, `audiolog_${log.id}`, true);
        this.notify();
      },
      onNearLog: (_log, _distance) =&gt; { this.notify(); },
      onNotification: (text, duration) =&gt; { this.notify(); },
    });

    // Secret Area System
    this.secretAreaSystem = new SecretAreaSystem(scene, levelId, {
      onSecretDiscovered: (secret) =&gt; {
        getAchievementManager().onSecretFound();
        saveSystem.setLevelFlag(levelId, `secret_${secret.id}`, true);
        this.notify();
      },
      onNearSecret: (_secret, _distance) =&gt; { this.notify(); },
      onNotification: (text, duration) =&gt; { this.notify(); },
    });

    // Skull Pickup System
    this.skullPickupManager = new SkullPickupManager(scene, levelId, {
      onSkullCollected: (skull) =&gt; {
        saveSystem.setLevelFlag(levelId, `skull_${skull.id}`, true);
        this.notify();
      },
      onNotification: (text, duration) =&gt; { this.notify(); },
    });
  }

  private disposeCollectibles(): void {
    this.audioLogSystem?.dispose();
    this.audioLogSystem = null;
    this.secretAreaSystem?.dispose();
    this.secretAreaSystem = null;
    this.skullPickupManager?.dispose();
    this.skullPickupManager = null;
  }
```

### 3.8 React Integration: Snapshot + Listener Pattern

```typescript
  // Snapshot returned to React
  getSnapshot(): CampaignSnapshot {
    return {
      phase: this.phase,
      currentLevelId: this.currentLevelId,
      currentLevelConfig: CAMPAIGN_LEVELS[this.currentLevelId],
      isBonusLevel: this.isBonusLevel,
      levelKills: this.levelKills,
      levelStartTime: this.levelStartTime,
    };
  }

  // Subscribe (for useSyncExternalStore or custom hook)
  subscribe(listener: CampaignListener): () =&gt; void {
    this.listeners.add(listener);
    return () =&gt; this.listeners.delete(listener);
  }

  private notify(): void {
    const snapshot = this.getSnapshot();
    for (const listener of this.listeners) {
      listener(snapshot);
    }
  }

  private setPhase(phase: CampaignPhase): void {
    this.phase = phase;
    this.notify();
  }
```

---

## 4. React Hook: `useCampaign()`

### File: `src/game/campaign/useCampaign.ts`

```typescript
import { useSyncExternalStore, useCallback } from &#x27;react&#x27;;
import { campaignDirector } from &#x27;./index&#x27;; // singleton
import type { CampaignCommand, CampaignSnapshot } from &#x27;./types&#x27;;

export function useCampaign(): [CampaignSnapshot, (cmd: CampaignCommand) =&gt; void] {
  const snapshot = useSyncExternalStore(
    campaignDirector.subscribe.bind(campaignDirector),
    campaignDirector.getSnapshot.bind(campaignDirector)
  );

  const dispatch = useCallback(
    (cmd: CampaignCommand) =&gt; campaignDirector.dispatch(cmd),
    []
  );

  return [snapshot, dispatch];
}
```

This replaces all 15 `useCallback` hooks in App.tsx with a single `[snapshot, dispatch]` pair. The rendering is driven by `snapshot.phase`.

---

## 5. Simplified App.tsx (from ~700 to ~300 lines)

The new App.tsx structure would be:

```typescript
function GameUI() {
  const [campaign, dispatch] = useCampaign();
  const { phase, currentLevelId, currentLevelConfig } = campaign;

  // Touch detection (keep existing)
  // PWA hooks (keep existing)

  return (
    &lt;div className=&quot;game-container&quot;&gt;
      &lt;GameCanvas campaign={campaign} dispatch={dispatch} /&gt;
      
      {phase === &#x27;title&#x27; &amp;&amp; &lt;TitleSequence onComplete={() =&gt; dispatch({ type: &#x27;MAIN_MENU&#x27; })} /&gt;}
      {phase === &#x27;menu&#x27; &amp;&amp; &lt;MainMenu dispatch={dispatch} /&gt;}
      {phase === &#x27;briefing&#x27; &amp;&amp; &lt;MissionBriefing levelId={currentLevelId} dispatch={dispatch} /&gt;}
      {phase === &#x27;intro&#x27; &amp;&amp; &lt;LevelIntro levelId={currentLevelId} onComplete={() =&gt; dispatch({ type: &#x27;INTRO_COMPLETE&#x27; })} /&gt;}
      {phase === &#x27;loading&#x27; &amp;&amp; &lt;LoadingModal levelId={currentLevelId} onComplete={() =&gt; dispatch({ type: &#x27;LOADING_COMPLETE&#x27; })} /&gt;}
      {phase === &#x27;playing&#x27; &amp;&amp; &lt;HUD /&gt;}
      {phase === &#x27;paused&#x27; &amp;&amp; &lt;PauseMenu dispatch={dispatch} /&gt;}
      {phase === &#x27;gameover&#x27; &amp;&amp; &lt;DeathScreen dispatch={dispatch} /&gt;}
      {phase === &#x27;levelComplete&#x27; &amp;&amp; &lt;LevelCompletionScreen dispatch={dispatch} /&gt;}
      {phase === &#x27;credits&#x27; &amp;&amp; &lt;CreditsSequence onComplete={() =&gt; dispatch({ type: &#x27;CREDITS_DONE&#x27; })} /&gt;}
      
      {/* Always-present overlays */}
      &lt;AchievementPopup /&gt;
      &lt;SubtitleDisplay /&gt;
      &lt;CommsDisplay /&gt;
      &lt;OfflineIndicator /&gt;
    &lt;/div&gt;
  );
}
```

No more `gameState` useState, no more `handleXxx` callbacks. Everything is `dispatch({ type: &#x27;XXX&#x27; })`.

---

## 6. Simplified GameCanvas (Unified ILevel Path)

### Key Change: Remove Dual Rendering

The current GameCanvas render loop (lines 475-493) branches:
```
if (tutorialLevelRef.current) { ... render level scene }
else if (gameManagerRef.current) { ... render shared scene }
else { ... render menu scene }
```

The new GameCanvas:
- Receives `campaign` snapshot and `dispatch` callback as props
- Has a single `activeLevelRef: React.RefObject&lt;ILevel | null&gt;`
- The render loop becomes:

```typescript
engine.runRenderLoop(() =&gt; {
  perfManager.update();
  const isPaused = campaign.phase === &#x27;paused&#x27;;
  const activeLevel = activeLevelRef.current;

  if (activeLevel) {
    if (!isPaused) activeLevel.update(deltaTime);
    activeLevel.getScene().render();
  } else {
    menuScene.render(); // planet background
  }
});
```

When `campaign.phase` transitions to `playing`, CampaignDirector has already called `levelManager.startLevel()`, which creates the ILevel and starts its render loop internally. GameCanvas simply reads the current level from the director.

The `tutorialLevelRef` / `gameManagerRef` split is eliminated. ALL levels go through the ILevel interface.

---

## 7. Wiring Disconnected Systems

### 7.1 Mining Depths as Bonus Level

**File changes:**
- Add `mining_depths` to `LevelType` union as `&#x27;mine&#x27;`
- Add `BonusLevelId` type: `&#x27;mining_depths&#x27;`
- Add `mining_depths` config to a `BONUS_LEVELS` record (not in CAMPAIGN_LEVELS linked list, to preserve the 10-level campaign)
- Add `mineLevelFactory` to factories.ts that creates `MiningDepthsLevel`
- FOB Delta level triggers `dispatch({ type: &#x27;ENTER_BONUS_LEVEL&#x27;, levelId: &#x27;mining_depths&#x27; })` when player interacts with &quot;Mining Outpost Gamma-7&quot; terminal
- CampaignDirector saves `returnLevelId = &#x27;brothers_in_arms&#x27;` (the next campaign level after FOB Delta)
- On bonus complete, CampaignDirector returns to the campaign flow

### 7.2 Canyon LevelType Factory Fix

The `canyonLevelFactory` at line 55 of `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/factories.ts` currently throws. It should create a `SurfaceLevel`-derived canyon level. Since no dedicated CanyonLevel class exists yet beyond CanyonRunLevel (which uses the `vehicle` type), the canyon factory should instantiate `SurfaceLevel` with canyon-specific config. However, since canyon_run is already mapped to `vehicle` type and creates `CanyonRunLevel`, the `canyon` LevelType is for infantry canyon terrain. The simplest fix: make `canyonLevelFactory` create a `SurfaceLevel` with canyon weather/environment. This is NOT used by any current campaign level (canyon_run uses `vehicle`) but would be used by future content or modding.

### 7.3 Vehicles into Canyon Run, Hive Assault, Final Escape

These levels already exist as ILevel implementations:
- `CanyonRunLevel` (vehicle type) -- add `WraithTank` enemy spawning, `PhantomDropship` for set-piece moments
- `HiveAssaultLevel` (combined_arms type) -- add `WraithTank` for player-drivable vehicle phase
- `FinalEscapeLevel` (finale type) -- add `PhantomDropship` as the escape vehicle

Each level class imports from `../vehicles/` and instantiates vehicles in `createEnvironment()`. VehicleBase is already scene-aware with enter/exit, camera swap, etc. The levels just need to:
1. Create vehicle instances with positions
2. Add proximity interaction prompts via `onActionGroupsChange`
3. Call `vehicle.update(deltaTime)` in `updateLevel()`
4. Dispose vehicles in `disposeLevel()`

### 7.4 ReyesDialogue into Levels

CampaignDirector owns the `ReyesDialogueManager` singleton. It wires the comms callback through `buildLevelCallbacks().onCommsMessage`. Levels trigger dialogue through two paths:

**Path A (Automatic):** CampaignDirector calls `reyes.playBriefing(levelId)` on level start and `reyes.triggerDialogue(&#x27;hostiles_detected&#x27;)` from `onCombatStateChange`.

**Path B (Level-initiated):** Levels that need specific triggers (e.g., FOB Delta&#x27;s `fob_delta_lights_out`) call `callbacks.onNotification(&#x27;REYES:fob_delta_lights_out&#x27;)` with a prefixed string. CampaignDirector intercepts notifications with the `REYES:` prefix and routes them to `reyes.triggerDialogue()`.

Alternatively (cleaner): extend `LevelCallbacks` with an optional `onDialogueTrigger?: (trigger: DialogueTrigger) =&gt; void` callback. Levels call this directly.

### 7.5 Achievement Trigger Wiring

CampaignDirector is the single point that calls all achievement triggers:

| Event | Where it fires | Achievement trigger |
|-------|---------------|-------------------|
| Tutorial complete | `onLevelComplete` from anchor_station | `onTutorialComplete()` |
| HALO drop done | `onLevelComplete` from landfall | `onHaloDropComplete()` |
| First combat win | landfall level internal | `onFirstCombatWin()` |
| Enemy killed | `onKill` callback | `onKill(healthPercent)` |
| Canyon run done | `onLevelComplete` from canyon_run | `onCanyonRunComplete()` |
| FOB Delta no-death | `onLevelComplete` + death flag | `onLevelComplete(&#x27;fob_delta&#x27;, !died)` |
| Marcus found | brothers_in_arms internal | `onMarcusFound()` |
| Brothers done | `onLevelComplete` from brothers | `onBrothersInArmsComplete(marcusDown)` |
| Southern Ice done | `onLevelComplete` from southern_ice | `onSouthernIceComplete()` |
| Queen defeated | the_breach internal | `onQueenDefeated()` |
| Hive Assault done | `onLevelComplete` from hive_assault | `onHiveAssaultComplete()` |
| Extraction done | `onLevelComplete` from extraction | `onExtractionComplete()` |
| Final Escape done | `onLevelComplete` from final_escape | `onFinalEscapeComplete(crashed)`, `onGameComplete()` |
| Secret found | SecretAreaSystem callback | `onSecretFound()` |
| Audio log found | AudioLogSystem callback | `onAudioLogFound()` |
| Damage taken | `onDamage` callback | `onDamageTaken(levelId, damage)` |

### 7.6 Collectible Systems Wiring

CampaignDirector creates `AudioLogSystem`, `SecretAreaSystem`, and `SkullPickupManager` per level in `initializeCollectibles()`. Each system receives the current level&#x27;s Scene and LevelId. The systems handle their own mesh creation, glow effects, and proximity detection. CampaignDirector wires their callbacks to:
- Achievement triggers
- Save system level flags
- React notifications (via `notify()`)

### 7.7 Populate GameSave.objectives

Currently `GameSave.objectives` is `Record&lt;string, boolean&gt;` and always empty. CampaignDirector populates it:

```typescript
// When objective is announced by level:
onObjectiveUpdate: (title, instructions) =&gt; {
  const key = `${this.currentLevelId}:${sanitize(title)}`;
  saveSystem.setObjective(key, false); // objective created, not yet complete
}

// When level completes:
handleLevelComplete() {
  const key = `${this.currentLevelId}:primary`;
  saveSystem.setObjective(key, true); // mark primary objective done
}
```

---

## 8. MissionDefinitions.ts

### File: `src/game/campaign/MissionDefinitions.ts`

This file defines per-level metadata beyond what `CAMPAIGN_LEVELS` provides -- specifically objectives, vehicle availability, dialogue triggers, and collectible counts:

```typescript
export interface MissionDefinition {
  levelId: LevelId;
  objectives: MissionObjective[];
  vehicleIds?: string[];               // Vehicle types available in this level
  dialogueTriggers?: DialogueTrigger[]; // Reyes triggers this level can fire
  audioLogCount: number;
  secretCount: number;
  skullId?: SkullId;
  hasBonusAccess?: BonusLevelId;       // Can access a bonus level from here
}

export interface MissionObjective {
  id: string;
  title: string;
  description: string;
  isOptional: boolean;
}

export const MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt; = {
  anchor_station: {
    levelId: &#x27;anchor_station&#x27;,
    objectives: [
      { id: &#x27;tutorial_move&#x27;, title: &#x27;Learn Movement&#x27;, description: &#x27;WASD to move&#x27;, isOptional: false },
      { id: &#x27;tutorial_shoot&#x27;, title: &#x27;Weapons Training&#x27;, description: &#x27;Hit the targets&#x27;, isOptional: false },
      { id: &#x27;tutorial_complete&#x27;, title: &#x27;Report to Drop Bay&#x27;, description: &#x27;Board the drop pod&#x27;, isOptional: false },
    ],
    dialogueTriggers: [&#x27;briefing_anchor_station&#x27;],
    audioLogCount: 2,
    secretCount: 1,
    skullId: &#x27;iron&#x27;,
  },
  canyon_run: {
    levelId: &#x27;canyon_run&#x27;,
    objectives: [
      { id: &#x27;reach_fob&#x27;, title: &#x27;Reach FOB Delta&#x27;, description: &#x27;Drive through the canyon&#x27;, isOptional: false },
    ],
    vehicleIds: [&#x27;wraith_tank&#x27;],     // Player drives a Wraith through canyons
    dialogueTriggers: [&#x27;briefing_canyon_run&#x27;, &#x27;hostiles_detected&#x27;, &#x27;hostiles_cleared&#x27;],
    audioLogCount: 1,
    secretCount: 2,
    skullId: &#x27;thunderstorm&#x27;,
  },
  fob_delta: {
    levelId: &#x27;fob_delta&#x27;,
    objectives: [
      { id: &#x27;investigate&#x27;, title: &#x27;Investigate FOB&#x27;, description: &#x27;Search for survivors&#x27;, isOptional: false },
      { id: &#x27;mining_access&#x27;, title: &#x27;Mining Outpost Gamma-7&#x27;, description: &#x27;Access the mining depths&#x27;, isOptional: true },
    ],
    dialogueTriggers: [&#x27;briefing_fob_delta&#x27;, &#x27;fob_delta_lights_out&#x27;],
    audioLogCount: 3,
    secretCount: 2,
    skullId: &#x27;famine&#x27;,
    hasBonusAccess: &#x27;mining_depths&#x27;,
  },
  hive_assault: {
    levelId: &#x27;hive_assault&#x27;,
    objectives: [
      { id: &#x27;plant_charges&#x27;, title: &#x27;Plant Charges&#x27;, description: &#x27;Destroy hive nexus nodes&#x27;, isOptional: false },
    ],
    vehicleIds: [&#x27;wraith_tank&#x27;, &#x27;phantom_dropship&#x27;],
    dialogueTriggers: [&#x27;briefing_hive_assault&#x27;],
    audioLogCount: 1,
    secretCount: 1,
    skullId: &#x27;cowbell&#x27;,
  },
  final_escape: {
    levelId: &#x27;final_escape&#x27;,
    objectives: [
      { id: &#x27;escape&#x27;, title: &#x27;Outrun the Collapse&#x27;, description: &#x27;Reach the dropship&#x27;, isOptional: false },
    ],
    vehicleIds: [&#x27;phantom_dropship&#x27;],
    dialogueTriggers: [&#x27;briefing_escape&#x27;],
    audioLogCount: 0,
    secretCount: 0,
    skullId: &#x27;catch&#x27;,
  },
  // ... similar for all 10 levels
};

export const BONUS_LEVELS: Record&lt;string, { config: LevelConfig; parentLevelId: LevelId }&gt; = {
  mining_depths: {
    config: {
      id: &#x27;mining_depths&#x27; as any, // Extended LevelId
      type: &#x27;mine&#x27; as any,
      nextLevelId: null,
      previousLevelId: null,
      chapter: 4, // Same act as FOB Delta
      actName: &#x27;ACT 2: THE SEARCH&#x27;,
      missionName: &#x27;MINING DEPTHS&#x27;,
      missionSubtitle: &#x27;Mining Outpost Gamma-7&#x27;,
      playerSpawnPosition: { x: 0, y: 1.7, z: 0 },
      hasCinematicIntro: true,
      ambientTrack: &#x27;horror_ambient&#x27;,
      combatTrack: &#x27;combat_interior&#x27;,
      weather: { environment: &#x27;station&#x27;, initialWeather: &#x27;damaged&#x27;, initialIntensity: &#x27;high&#x27; },
    },
    parentLevelId: &#x27;fob_delta&#x27;,
  },
};
```

---

## 9. Campaign Module Index

### File: `src/game/campaign/index.ts`

```typescript
export { CampaignDirector } from &#x27;./CampaignDirector&#x27;;
export type { CampaignPhase, CampaignCommand, CampaignSnapshot } from &#x27;./types&#x27;;
export { MISSION_DEFINITIONS, BONUS_LEVELS } from &#x27;./MissionDefinitions&#x27;;
export { useCampaign } from &#x27;./useCampaign&#x27;;

// Singleton instance
import { CampaignDirector } from &#x27;./CampaignDirector&#x27;;
export const campaignDirector = new CampaignDirector();
```

---

## 10. Implementation Sequence

### Phase 1: Foundation (no behavior change)
1. Create `src/game/campaign/types.ts` with CampaignPhase, CampaignCommand, CampaignSnapshot types
2. Create `src/game/campaign/MissionDefinitions.ts` with all 10 + 1 bonus level definitions
3. Create `src/game/campaign/CampaignDirector.ts` -- the class with state machine, dispatch, and sub-system orchestration
4. Create `src/game/campaign/useCampaign.ts` -- React hook using `useSyncExternalStore`
5. Create `src/game/campaign/index.ts` -- barrel export with singleton

### Phase 2: Wire LevelManager
6. Fix `canyonLevelFactory` in `factories.ts` -- create SurfaceLevel with canyon config instead of throwing
7. Add `mineLevelFactory` for MiningDepthsLevel
8. Wire `LevelManager` into CampaignDirector&#x27;s `startCurrentLevel()` method
9. Test that CampaignDirector can start/dispose levels through LevelManager

### Phase 3: Unify GameCanvas
10. Refactor GameCanvas to accept `campaign` snapshot instead of `gameState`
11. Remove `tutorialLevelRef` / `gameManagerRef` dual path
12. Single `activeLevelRef` driven by CampaignDirector&#x27;s `levelManager.getCurrentLevel()`
13. Remove `GameState` type from GameCanvas (use CampaignPhase instead)

### Phase 4: Simplify App.tsx
14. Replace 15 `useCallback` hooks with `useCampaign()` hook
15. Replace conditional rendering to use `campaign.phase` instead of `gameState`
16. Remove all state management from App.tsx (it moves into CampaignDirector)

### Phase 5: Wire Disconnected Systems
17. Wire ReyesDialogue into CampaignDirector (briefings + in-mission triggers)
18. Wire collectibles (AudioLogSystem, SecretAreaSystem, SkullPickupManager) into `initializeCollectibles()`
19. Wire achievement triggers into `handleLevelComplete()` and level callbacks
20. Wire SaveSystem objectives population

### Phase 6: Wire Content
21. Wire MiningDepthsLevel as bonus level accessible from FOB Delta
22. Wire vehicles into CanyonRunLevel, HiveAssaultLevel, FinalEscapeLevel
23. Extend LevelCallbacks with `onDialogueTrigger` for level-initiated Reyes dialogue
24. Wire LevelCallbacks.onDialogueTrigger in CampaignDirector

### Phase 7: Cleanup
25. Absorb GameManager functionality into SurfaceLevel/LandfallLevel (the Player, ChunkManager, CombatSystem, AISystem composition)
26. Update tests (e2e and unit) to use CampaignDirector dispatch API
27. Remove dead code paths (old GameState handling in GameCanvas)

---

## 11. Dependency Graph

```
App.tsx
  |-- useCampaign() hook
        |-- CampaignDirector (singleton)
              |-- LevelManager
              |     |-- LevelFactoryRegistry
              |     |     |-- factories.ts (all 11 + mine factory)
              |     |-- ILevel instances (BaseLevel subclasses)
              |           |-- vehicles/ (PhantomDropship, WraithTank)
              |
              |-- ReyesDialogueManager (singleton)
              |     |-- VoiceSynthesizer
              |     |-- AudioManager
              |
              |-- SaveSystem (singleton)
              |     |-- worldDatabase (IndexedDB)
              |
              |-- AchievementManager (singleton)
              |     |-- localStorage
              |
              |-- Collectible Systems (per-level)
                    |-- AudioLogSystem
                    |-- SecretAreaSystem
                    |-- SkullPickupManager

GameCanvas
  |-- receives campaign snapshot + dispatch
  |-- single ILevel rendering path
  |-- menu scene (planet) when no level active
```

---

### Critical Files for Implementation

- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/LevelManager.ts` - Already complete level lifecycle orchestrator -- CampaignDirector wraps this directly. Currently unused; becomes the engine of all level transitions.
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/components/GameCanvas.tsx` - Must be refactored from dual-path (tutorialLevelRef/gameManagerRef) to single ILevel path driven by CampaignDirector. The 763-line file with embedded shaders and branching render loop is the hardest refactor.
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/App.tsx` - Must be reduced from ~700 lines and 15 useCallback hooks to ~300 lines using useCampaign() hook. All state management moves to CampaignDirector.
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/factories.ts` - Must fix the throwing canyonLevelFactory and add mineLevelFactory for MiningDepthsLevel. This is the factory registry that LevelManager depends on.
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/audio/ReyesDialogue.ts` - 822 LOC of fully built dialogue with briefings for all 10 levels and 17 in-mission triggers. Never imported anywhere. CampaignDirector&#x27;s buildLevelCallbacks() wires this into every level&#x27;s comms and combat state changes.</pre><pre>agentId: a57fd6e (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T19-04-04-545Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T19-04-04-545Z" class="timestamp-link"><time datetime="2026-01-30T19:04:04.545Z" data-timestamp="2026-01-30T19:04:04.545Z">2026-01-30T19:04:04.545Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>Now I have all the information needed to synthesize the comprehensive design plan. Let me compile everything.

---

# Stellar Descent: Model-Based Level Environment System -- Design Plan

## Executive Summary

This plan converts all 10 campaign levels from procedural `MeshBuilder` geometry to a model-based architecture using the 47 existing GLB assets, BabylonJS dynamic terrain for outdoor levels, and ambientCG textures for surface materials. The three environment categories are:

1. **Station/Base levels** (Anchor Station, FOB Delta): Snapped GLB corridor/wall/prop modules from `public/models/environment/station/` and `public/models/props/industrial/`
2. **Surface levels** (Landfall, Canyon Run, Brothers in Arms, Southern Ice, Extraction, Final Escape): BabylonJS `GroundMesh` with `DynamicTexture` or downloaded ambientCG textures, plus procedural skyscapes
3. **Hive/Underground levels** (The Breach, Hive Assault): 7 hive GLB structures from `public/models/environment/hive/` placed via `AssetManager`

---

## Complete GLB Asset Inventory

### Station Environment (17 GLBs -- `/models/environment/station/`)
| File | Size | Usage |
|------|------|-------|
| `corridor_main.glb` | 7.7 MB | Primary corridor segment (4m Y-axis snap) |
| `corridor_corner.glb` | 4.5 MB | 90-degree turn segment |
| `corridor_junction.glb` | 4.1 MB | T-junction segment |
| `corridor_wide.glb` | 4.5 MB | Wide corridor/room segment |
| `wall_hr_1_double.glb` | 994 KB | Double-height wall panel |
| `wall_hr_1_hole_1.glb` | 2.1 MB | Wall with damaged hole |
| `doorway_hr_1.glb` | 1.7 MB | Standard doorway frame |
| `doorway_hr_1_wide.glb` | 1.7 MB | Wide doorway frame |
| `floor_ceiling_hr_1.glb` | 556 KB | Standard floor/ceiling tile |
| `floor_ceiling_hr_3.glb` | 1.0 MB | Floor/ceiling variant 3 |
| `floor_ceiling_rtx_1.glb` | 1.8 MB | RTX-quality floor/ceiling |
| `beam_hc_horizonatal_1.glb` | 482 KB | Horizontal structural beam |
| `beam_hc_vertical_1.glb` | 495 KB | Vertical structural beam |
| `pipe_cx_1.glb` | 1.2 MB | Pipe run variant 1 |
| `pipe_cx_2.glb` | 1.3 MB | Pipe run variant 2 |
| `station_door.glb` | 146 KB | Operable station door |
| `station_barrel.glb` | 116 KB | Station barrel prop |

### Industrial Props (13 GLBs -- `/models/props/industrial/`)
| File | Size | Usage |
|------|------|-------|
| `cardboard_box_1.glb` | 118 KB | Cardboard box prop |
| `door_hr_6.glb` | 66 KB | Door variant 6 |
| `door_hr_12.glb` | 62 KB | Door variant 12 |
| `door_hr_13.glb` | 72 KB | Door variant 13 |
| `electrical_equipment_1.glb` | 251 KB | Electrical panel |
| `lamp_mx_1_a_on.glb` | 865 KB | Ceiling lamp type 1 |
| `lamp_mx_2_on.glb` | 522 KB | Ceiling lamp type 2 |
| `lamp_mx_3_on.glb` | 524 KB | Wall lamp type 3 |
| `machinery_mx_1.glb` | 463 KB | Industrial machinery |
| `metal_barrel_hr_1.glb` | 418 KB | Metal barrel variant 1 |
| `metal_barrel_hr_2.glb` | 400 KB | Metal barrel variant 2 |
| `pipes_hr_1.glb` | 85 KB | Industrial pipes |
| `shelf_mx_1.glb` | 617 KB | Storage shelf |

### Hive Environment (7 GLBs -- `/models/environment/hive/`)
| File | Size | Usage |
|------|------|-------|
| `building_birther.glb` | 4.3 MB | Chitin spawning structure |
| `building_brain.glb` | 1.1 MB | Hive neural nexus |
| `building_claw.glb` | 5.5 MB | Organic claw structure |
| `building_crystals.glb` | 415 KB | Crystal formation |
| `building_stomach.glb` | 5.7 MB | Digestion chamber |
| `building_terraformer.glb` | 2.2 MB | Alien terraformer |
| `building_undercrystal.glb` | 1.6 MB | Underground crystal growth |

### Vehicles (3 GLBs)
| File | Path | Size | Usage |
|------|------|------|-------|
| `wraith.glb` | `/models/vehicles/chitin/` | 11.9 MB | Enemy hover tank |
| `phantom.glb` | `/models/vehicles/tea/` | 11.3 MB | TEA dropship |
| `marcus_mech.glb` | `/models/vehicles/tea/` | 589 KB | Marcus&#x27;s Titan mech |

### Enemies (8 GLBs -- `/models/enemies/chitin/`)
| File | Size | Species Mapping |
|------|------|-----------------|
| `spider.glb` | 1.5 MB | skitterer - fast crawler |
| `scout.glb` | 1.6 MB | lurker - tall stalker |
| `soldier.glb` | 1.6 MB | spewer - armored ranged |
| `tentakel.glb` | 1.5 MB | broodmother - boss |
| `flyingalien.glb` | 1.4 MB | flying drone variant |
| `alienmonster.glb` | 5.9 MB | heavy assault |
| `alienmale.glb` | 2.2 MB | husk - humanoid |
| `alienfemale.glb` | 3.3 MB | queen variant |

### PSX Textures (6 PNGs -- `/textures/psx/`)
| File | Size | Usage |
|------|------|-------|
| `concrete_hr_1.png` | 572 KB | FOB/base floors, walls |
| `door_hr_6.png` | 70 KB | Door texture |
| `machinery_mx_1.png` | 201 KB | Machinery surfaces |
| `metal_barrel_hr_1.png` | 401 KB | Barrel texture |
| `metal_hr_1.png` | 518 KB | General metal surfaces |
| `wall_hr_1.png` | 438 KB | Wall panel texture |

---

## Per-Level Environment Design

---

### LEVEL 1: ANCHOR STATION (type: `station`)

**Current Status**: Already uses GLB corridors via `ModularStationBuilder`. This is the reference pattern.

**What Works**: 50+ GLB corridor segments snapped at 4-unit intervals. ModularStationBuilder at `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/ModularStationBuilder.ts` loads `corridor_main`, `corridor_corner`, `corridor_junction`, `corridor_wide` via `SceneLoader.ImportMeshAsync`.

**What Needs Adding**:

1. **Barracks Room** (user requirement: &quot;add a BARRACKS ROOM where the intro starts&quot;)
   - Add 3 new `StationSegment` entries to `ANCHOR_STATION_LAYOUT.segments` at positions north of the Briefing Room (e.g., `Vector3(0, 0, 8)`, `Vector3(0, 0, 12)`, `Vector3(0, 0, 16)`)
   - Segment types: `wide` (center), `main` (entry), `main` (back)
   - Populate with: `shelf_mx_1.glb` (lockers/bunks proxy), `metal_barrel_hr_1.glb`, `cardboard_box_1.glb`, `lamp_mx_2_on.glb`
   - Add to `MODULAR_ROOM_POSITIONS`: `barracksEntry`, `barracksCenter`, `playerBunk`
   - Add to `ROOM_ATMOSPHERES`: warm amber `{r: 0.8, g: 0.7, b: 0.6}`, intensity 0.5
   - Move player spawn from `Vector3(0, 1.5, 2)` to `Vector3(0, 1.5, 14)` (center of barracks)
   - Add `RoomDefinition` for barracks with bounds covering the new segments

2. **Industrial Prop Placement** (enhance existing rooms)
   - Engine Room: Place `machinery_mx_1.glb` x2, `pipes_hr_1.glb` x3, `electrical_equipment_1.glb` x2 along walls
   - Equipment Bay: Place `shelf_mx_1.glb` x4 (gear storage), `metal_barrel_hr_1.glb` x3
   - Armory: Place `shelf_mx_1.glb` x6 (weapon racks proxy), `cardboard_box_1.glb` x4
   - Medical Bay: Place `electrical_equipment_1.glb` x2 (containment systems)
   - All rooms: Place `lamp_mx_1_a_on.glb` or `lamp_mx_2_on.glb` every other corridor segment

3. **Replace Remaining Procedural Interactive Elements**
   - In `ModularStationEnvironment.ts`, the suit locker, shooting targets, and holodeck platforms are still MeshBuilder boxes. Replace the locker with `shelf_mx_1.glb` instance. Replace drop pod with a procedural cylinder (no GLB exists for this).

**Lighting** (from PSX-ASSETS.md Station guidelines):
- Already implemented in `StationLevel.ts`: ambient HemisphericLight intensity 0.2, cool blue diffuse
- Per-room atmospheres defined in `ROOM_ATMOSPHERES` -- these are correct
- Add: Place `lamp_mx_1_a_on.glb` / `lamp_mx_2_on.glb` / `lamp_mx_3_on.glb` every 4-6m with attached PointLight:
  - Color: warm white `#FFE4C4` (standard) or cool blue `#C4D4FF` (corridors)
  - Intensity: 1.0-1.5
  - Range: 6m
- Ambient intensity: 0.3-0.4

**Sky/Atmosphere**:
- Station is interior -- no sky needed
- `StationLevel.createSpaceView()` provides a distant planet visible through observation windows
- This is already working correctly

**Audio**: `station_ambient` already configured in `CAMPAIGN_LEVELS`

**Model Loading** (from `AssetManifest.ts`):
- Already correctly configured with all station pieces in `required` and `preload` arrays
- Add: industrial props to `preload` list for anchor_station if not already there (many are in `deferred` -- move `prop/shelf`, `prop/machinery`, `prop/pipes` to `preload`)

---

### LEVEL 2: LANDFALL (type: `drop`)

**Current Status**: Procedural geometry for asteroids (MeshBuilder spheres), surface terrain (MeshBuilder ground), and landing pad.

**What Needs Changing**:

1. **Freefall Phase** (keep mostly procedural -- justified)
   - Asteroids: procedural icospheres with varied sizes are fine (no GLB for asteroids exists). Add PSX `metal_hr_1.png` texture to metallic asteroid variants.
   - Planet: procedural sphere with emissive material is correct for distant view.
   - Distant threats: Use `wraith.glb` and `phantom.glb` instances for the fly-by vehicles (already loaded via `AssetManager`). Currently `DistantThreat` nodes are TransformNodes -- replace with actual GLB instances.

2. **Surface Phase** (needs dynamic terrain)
   - Replace MeshBuilder.CreateGround with `GroundMesh` using `CreateGroundFromHeightMap` or `DynamicTexture`-based height generation
   - Terrain size: 500m x 500m (from `SurfaceConfig.terrainSize`)
   - Height scale: 50m
   - Subdivisions: 128x128 for decent resolution on mobile
   - Ground material: `StandardMaterial` with diffuse from ambientCG rock texture (see Asset Gap section -- need to download)
   - For now, tint `concrete_hr_1.png` rusty-brown as a placeholder for rocky terrain
   - Landing pad: Keep procedural flat disc (no GLB exists, simple geometry justified)

3. **Surface Combat Arena**
   - Rock cover: procedural boulders with PSX `concrete_hr_1.png` texture (no rock GLBs exist)
   - Place `metal_barrel_hr_1.glb` and `metal_barrel_hr_2.glb` around the landing pad as cover
   - Place `cardboard_box_1.glb` as supply crates near LZ

**Lighting** (from PSX-ASSETS.md Surface guidelines):
- DirectionalLight for sun: Color `#FFA040`, low angle, intensity 2.0-2.5
- Ambient HemisphericLight: intensity 0.2-0.3
- `SurfaceLevel.ts` already implements this with `setupBasicLighting()` method
- Current sun color in code: `Color3(1.0, 0.6, 0.3)` at dawn/dusk -- correct for eternal sunset look

**Sky/Atmosphere**:
- `SurfaceLevel.createSkyDome()` creates inside-out sphere with emissive gradient
- Need to enhance with:
  - Layered dome: inner = dust haze (orange-red emissive, alpha 0.3), outer = star field (dark with point emissives)
  - Dust particles: `ParticleSystem` with 200-500 small particles drifting horizontally
  - Fog: `scene.fogMode = FOGMODE_EXP2`, density 0.002, color matching dust orange `#C48A50`
- During freefall: disable fog/dust, use black background with star emissives

**Audio**: `canyon_wind` ambient / `combat_surface` combat -- already configured

**Model Loading** (from `AssetManifest.ts`):
- Required: `enemy/spider`, `enemy/scout` -- correct
- Preload: `vehicle/wraith`, `vehicle/phantom` -- correct
- Add to preload: `prop/barrel_1`, `prop/barrel_2`, `prop/box` for surface props

---

### LEVEL 3: CANYON RUN (type: `vehicle`)

**Current Status**: ENTIRELY PROCEDURAL. `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/canyon-run/environment.ts` uses MeshBuilder boxes for canyon walls, spheres for boulders, etc. 3000m long track. Zero GLB usage.

**What Needs Changing** (major refactor):

1. **Terrain**: Replace procedural box-based terrain with BabylonJS `CreateGroundFromHeightMap`
   - Generate a heightmap procedurally using seeded random (maintain determinism)
   - Two ground strips: left wall (height 80m), right wall (height 80m), canyon floor between
   - Canyon floor: subdivided GroundMesh, 3000m long x 50m wide
   - Material: `StandardMaterial` with tiled rock texture from ambientCG (see gap report)
   - Fallback: tint `wall_hr_1.png` as canyon rock

2. **Obstacles and Cover** (along the 3000m track):
   - Place `metal_barrel_hr_1.glb` / `metal_barrel_hr_2.glb` as road debris (wrecked convoy)
   - Place `machinery_mx_1.glb` as crashed equipment every ~200m
   - Place `cardboard_box_1.glb` as scattered supplies
   - Rock formations: Keep procedural (no rock GLBs available) but texture with `concrete_hr_1.png`

3. **Bridges and Structures**:
   - Currently procedural boxes -- replace with `beam_hc_horizonatal_1.glb` spanning canyon
   - Support pillars: `beam_hc_vertical_1.glb`
   - Bridge surfaces: `floor_ceiling_hr_1.glb` tiled

4. **Enemy Vehicles**:
   - `wraith.glb` instances for pursuing enemy vehicles (already in manifest)
   - Place `building_claw.glb` instances as alien roadblocks along the route

**Lighting** (Surface):
- DirectionalLight: `#FFA040`, intensity 2.0-2.5, low angle casting long shadows into the canyon
- Ambient: 0.2 intensity, warm ground bounce `Color3(0.3, 0.2, 0.15)`
- Add volumetric dust god-rays (post-processing bloom on sunlight)

**Sky/Atmosphere**:
- Dusty orange sky dome, fog density 0.003 (denser than normal -- canyon dust)
- Particle dust system: 500 particles, small horizontal drift
- Weather: `dusty` at `high` intensity (from config)

**Audio**: `canyon_wind` / `combat_vehicle` -- configured

**Model Loading** updates to `AssetManifest.ts`:
- Add to required: `prop/barrel_1`, `prop/barrel_2` (road debris)
- Add to preload: `prop/machinery`, `prop/box`, `station/beam_horizontal`, `station/beam_vertical`, `station/floor_ceiling_1`
- Add: `structure/claw` for alien roadblocks

---

### LEVEL 4: FOB DELTA (type: `base`)

**Current Status**: PROCEDURAL. `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/fob-delta/FOBDeltaLevel.ts` uses MeshBuilder for all environment geometry. Only uses `AssetManager` for enemy models, not environment.

**What Needs Changing** (major refactor -- follow Anchor Station pattern):

1. **Create `ModularFOBBuilder.ts`** (new file, following `ModularStationBuilder.ts` pattern)
   - Define `FOB_LAYOUT: StationLayout` with segments for each area:
     - **Perimeter**: 6-8 `corridor_main` segments in a rough rectangle
     - **Courtyard**: 4 `corridor_wide` segments in center, open-air (remove ceiling meshes)
     - **Barracks**: 3 `corridor_main` + 1 `corridor_wide` branching west
     - **Command Center**: 2 `corridor_wide` segments east of courtyard
     - **Vehicle Bay**: 4 `corridor_wide` segments (larger space for mech)
     - **Underground Access**: 2 `corridor_main` descending (rotation hack)
   - Total: ~25-30 segments
   - Snap interval: same 4m as Anchor Station

2. **Damage State**: Key differentiator from pristine Anchor Station
   - Use `wall_hr_1_hole_1.glb` (wall with hole) for ~40% of walls -- showing battle damage
   - Place `station_barrel.glb` knocked over (rotation.z = PI/2)
   - Scatter `cardboard_box_1.glb` and `metal_barrel_hr_1.glb` randomly
   - Use `doorway_hr_1.glb` with doors jammed half-open (animated position)

3. **Industrial Props for Horror Atmosphere**:
   - Barracks: `shelf_mx_1.glb` x4 (overturned -- rotation.x = PI/2), `lamp_mx_2_on.glb` (flickering -- animate intensity)
   - Command Center: `electrical_equipment_1.glb` x3 (terminals), `machinery_mx_1.glb` (server rack)
   - Vehicle Bay: `pipes_hr_1.glb` along walls, `machinery_mx_1.glb` x2 (vehicle lift)
   - Throughout: Place `lamp_mx_1_a_on.glb` every 8m (double spacing for darkness) with attached PointLight

4. **Exterior Courtyard**:
   - Ground: `floor_ceiling_hr_1.glb` tiled as concrete pad, textured with `concrete_hr_1.png`
   - Perimeter: `wall_hr_1_double.glb` with sections destroyed (alternate with `wall_hr_1_hole_1.glb`)
   - Place `metal_barrel_hr_2.glb` as barricade debris

**Lighting** (from PSX-ASSETS.md FOB guidelines):
- PointLights: `#FFE0A0` yellow-white, variable intensity 0.5-1.5 (FLICKERING)
- Ambient: 0.1-0.2 (very dark -- horror)
- Implement flickering: `FlickerLight` interface already exists in FOBDeltaLevel.ts
- Each lamp GLB gets an attached PointLight with random flicker parameters:
  - `flickerSpeed`: 2-8 Hz
  - `flickerAmount`: 0.3-0.8
  - `offDuration`: 0.5-3.0 seconds (random power failures)
- Emergency red lights: PointLight `#A03030` in barracks (horror)

**Sky/Atmosphere** (courtyard is partially open):
- Use `SurfaceLevel` sky setup for courtyard areas
- Dust particles in courtyard
- Interior: scene.fogMode = EXP2, density 0.01, dark color `#1A1A1A`

**Audio**: `horror_ambient` / `combat_interior` -- configured

**Model Loading** updates:
- `LEVEL_MANIFESTS.fob_delta` already lists station pieces and props -- verified correct
- Move `station/corridor_wide`, `station/corridor_corner` from deferred to preload (needed for layout)
- Add: `station/wall_hole` to required (damaged walls are critical for atmosphere)

---

### LEVEL 5: BROTHERS IN ARMS (type: `brothers`)

**Current Status**: PROCEDURAL. Marcus&#x27;s mech is built from MeshBuilder boxes (body, arms, legs). Open canyon arena is a MeshBuilder ground with boxes for rocks.

**What Needs Changing**:

1. **Marcus&#x27;s Mech** (critical fix)
   - Replace all procedural box geometry with `marcus_mech.glb` (`/models/vehicles/tea/marcus_mech.glb`, 589 KB)
   - Load via `AssetManager.loadAsset(&#x27;vehicles&#x27;, &#x27;marcus_mech&#x27;, scene)` (already has path mapping in legacy API via `ASSET_PATHS.vehicles`)
   - Note: The `MarcusMech` interface at line 47 defines `body: Mesh`, `leftArm: Mesh`, etc. These need to change to reference the GLB&#x27;s child meshes by name rather than MeshBuilder geometry
   - The `MarcusCombatAI` system should target the root TransformNode of the GLB instance

2. **Canyon Arena Terrain** (200m x 150m):
   - Replace MeshBuilder.CreateGround with `CreateGroundFromHeightMap`
   - Procedural heightmap with gentle undulation (2-5m height variation)
   - Material: tiled rock texture, diffuse `#9B7B5A` (Rock Tan from PSX-ASSETS.md)
   - Canyon walls: raised terrain edges (heightmap peaks at edges) rather than MeshBuilder boxes

3. **The Breach Sinkhole** (100m diameter):
   - Central depression in heightmap, descending to bottom
   - Ring of `building_crystals.glb` and `building_undercrystal.glb` around the rim
   - `building_claw.glb` emerging from the hole edges
   - Bioluminescent glow emanating from the hole: PointLight `#4AC8C8`, intensity 0.5

4. **Rock Cover**:
   - Procedural low-poly icospheres remain (no rock GLBs) but texture with `concrete_hr_1.png`
   - Scatter `metal_barrel_hr_1.glb` as debris from previous battles
   - Place destroyed `machinery_mx_1.glb` as wrecked equipment

**Lighting** (Surface, eternal sunset):
- DirectionalLight: `#FFA040`, intensity 2.0-2.5
- Low angle for dramatic canyon shadows
- Bioluminescent from Breach hole: PointLight `#4AC8C8`, intensity 0.5, range 50m

**Sky/Atmosphere**:
- Same sky dome as Landfall but with weather config: `dust_storm` at `high`
- Heavier dust particles: 800 particles, faster horizontal movement
- Fog: density 0.003, orange-brown

**Audio**: `canyon_wind` / `combat_mech` -- configured

**Model Loading** updates:
- `vehicle/marcus_mech` already in required -- correct
- Add to preload: `structure/crystals`, `structure/undercrystal`, `structure/claw` (for The Breach rim)
- Add: `prop/barrel_1`, `prop/machinery`

---

### LEVEL 6: SOUTHERN ICE (type: `ice`)

**Current Status**: PROCEDURAL. `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/southern-ice/environment.ts` creates terrain, ice caves, outpost, formations, waterfalls, aurora all from MeshBuilder.

**What Needs Changing**:

1. **Terrain** (frozen wasteland):
   - `CreateGroundFromHeightMap` with rolling ice fields
   - Material: white/blue-white with `concrete_hr_1.png` tinted icy blue as a base
   - Need ambientCG ice/snow texture (see gap report)
   - Specular highlights: high specularity for ice sheen, `Color3(0.8, 0.9, 1.0)`

2. **Ice Caves**:
   - Keep procedural inside-out spheres/cylinders for cave geometry (no ice cave GLBs)
   - Add `building_crystals.glb` and `building_undercrystal.glb` inside caves as frozen alien formations
   - Crystal formations emerging from ice: `building_crystals.glb` with blue-white emissive override

3. **Abandoned Outpost** (human research station):
   - Build from station GLB modules (same pattern as FOB Delta):
     - 6-8 `corridor_main` segments forming a small base
     - `corridor_wide` for main research lab
     - Use `wall_hr_1_hole_1.glb` for storm-damaged sections
   - Props inside: `shelf_mx_1.glb`, `electrical_equipment_1.glb`, `machinery_mx_1.glb`
   - Power generators: `machinery_mx_1.glb` with attached PointLight (warm amber contrast to exterior cold)

4. **Frozen Waterfalls**:
   - Keep procedural (no GLB for this) -- MeshBuilder cylinder with icy emissive material
   - Add `building_undercrystal.glb` at waterfall bases

**Lighting** (unique ice palette):
- DirectionalLight: very low angle, pale blue-white `#C0D4FF`, intensity 1.5
- Ambient: `Color3(0.4, 0.5, 0.7)`, intensity 0.3 (cold blue ambient)
- Aurora borealis: keep existing procedural strips (no GLB needed -- particle/mesh effect)
- Inside caves: PointLights `#4AC8C8` (bioluminescent crystals), intensity 0.3-0.5

**Sky/Atmosphere**:
- Sky dome: dark blue-green gradient for polar night
- Aurora effect: animated emissive mesh strips (existing code works)
- Blizzard particles: 1000+ white particles, strong horizontal wind
- Fog: density 0.005 (very dense blizzard), white-blue color
- Weather: `blizzard` at `extreme`

**Audio**: `ice_wind` / `combat_ice` -- configured

**Model Loading** updates:
- Add to preload: `structure/crystals`, `structure/undercrystal` (alien ice formations)
- Add: station pieces for outpost: `station/corridor_main`, `station/corridor_wide`, `station/wall_double`, `station/wall_hole`
- Add: `prop/shelf`, `prop/electrical`, `prop/machinery`, `prop/lamp_1`

---

### LEVEL 7: THE BREACH (type: `hive`)

**Current Status**: BEST implemented hive level. `HiveEnvironmentBuilder` loads all 7 hive structures via AssetManager and uses `createInstance()` for placement. Tunnels are procedural inside-out cylinders.

**What Works**:
- All 7 hive GLBs loaded via `AssetManager.loadAsset(&#x27;structures&#x27;, type, scene)`
- `placeStructure()` creates instances with position/rotation/scale
- `placeCapturedVehicle()` loads `wraith.glb` and `phantom.glb` with organic growth overlays
- Bioluminescent lighting system with flicker animation
- 4-zone tunnel network: upper, mid, lower, queen_chamber

**What Needs Enhancement**:

1. **More Structure Density**:
   - Currently ~10-15 structure placements -- increase to 30-40
   - **Upper tunnels**: `building_crystals.glb` x5, `building_undercrystal.glb` x4
   - **Mid tunnels**: `building_birther.glb` x3, `building_terraformer.glb` x3
   - **Lower tunnels**: `building_brain.glb` x2, `building_stomach.glb` x3
   - **Queen chamber**: `building_claw.glb` x6 (surrounding the queen), `building_brain.glb` x1 (central nexus)

2. **Captured Vehicles** (expand usage):
   - `wraith.glb` x3 in mid-tunnels (partially absorbed by organic growth)
   - `phantom.glb` x1 in lower tunnels (crashed dropship being consumed)
   - Each has organic growth meshes (procedural -- justified for organic look)

3. **Tunnel Improvements**:
   - Tunnels remain procedural inside-out cylinders (no tunnel GLBs exist)
   - But: line tunnel walls with `building_claw.glb` instances (scaled down 0.3x) as ribbing
   - Place `building_undercrystal.glb` clusters on tunnel floors

**Lighting** (from PSX-ASSETS.md Hive guidelines):
- Already correctly implemented in `HiveEnvironmentBuilder.createBiolight()`
- PointLights: `#40C0C0` (cyan-blue bioluminescence), intensity 0.5-1.0, range 8m
- Ambient: 0.05-0.1 (extremely dark)
- GlowLayer intensity 0.8 on emissive meshes
- Queen chamber: additional red-purple PointLights `#8040C0` for queen

**Sky/Atmosphere** (underground -- no sky):
- Background: deep purple-black `Color4(0.04, 0.03, 0.06, 1)` -- already set in constants
- No fog (clear tunnels, bioluminescence visibility)
- Spore particles: small green-blue particles floating upward

**Audio**: `hive_ambient` / `boss_combat` -- configured

**Model Loading**: Already correctly configured in `LEVEL_MANIFESTS.the_breach`

---

### LEVEL 8: HIVE ASSAULT (type: `combined_arms`)

**Current Status**: Has its own `environment.ts` with procedural geometry. Has `MarineSquadAI.ts` for allied marines.

**What Needs Changing**:

1. **Surface-to-Hive Transition**:
   - First half: Surface terrain (same pattern as Brothers in Arms)
     - `CreateGroundFromHeightMap`, 400m x 300m
     - Material: rust-brown rock
     - `marcus_mech.glb` leading the charge
   - Second half: Hive entrance and tunnels
     - Reuse `HiveEnvironmentBuilder` pattern from The Breach
     - All 7 hive structures placed densely

2. **Surface Phase Models**:
   - `marcus_mech.glb` (Marcus leading assault)
   - Wraith enemy vehicles: `wraith.glb` x4 on surface
   - Marine squad: procedural (no marine GLBs exist -- see gap report)
   - Cover: `metal_barrel_hr_1.glb`, `metal_barrel_hr_2.glb`, `machinery_mx_1.glb` as wrecked equipment
   - Forward base: 4-6 station corridor segments forming a staging area

3. **Hive Phase Models**:
   - Same structures as The Breach but denser
   - `building_birther.glb` x5 (active spawners during gameplay)
   - `building_brain.glb` x3 (destroy-to-progress objectives)
   - `building_claw.glb` x8 (defensive structures)

**Lighting**:
- Surface: DirectionalLight `#FFA040`, intensity 2.0
- Hive interior: Bioluminescent `#40C0C0`, intensity 0.5
- Transition zone: blend between the two (lerp ambient over 30m corridor)

**Sky/Atmosphere**:
- Surface: spore_storm weather (unique -- green-tinted dust)
- Hive: same as The Breach

**Audio**: `hive_ambient` / `combat_assault` -- configured

**Model Loading** updates:
- Already correctly references structures and vehicle/marcus_mech
- Add: station corridor pieces for forward base staging area
- Add: `prop/barrel_1`, `prop/barrel_2`, `prop/machinery`

---

### LEVEL 9: EXTRACTION (type: `extraction`)

**Current Status**: Very large file (147 KB). Uses procedural geometry for collapsing hive tunnels and LZ Omega surface holdout.

**What Needs Changing**:

1. **Collapsing Hive Phase** (escape sequence):
   - Reuse `HiveEnvironmentBuilder` for initial tunnel sections
   - Place hive structures that collapse/break during escape:
     - `building_claw.glb` falling across path (animated position)
     - `building_crystals.glb` shattering (hide mesh + spawn particles)
   - Tunnel walls: procedural (same as The Breach) with falling debris

2. **LZ Omega Surface Area** (holdout arena):
   - `CreateGroundFromHeightMap`: 200m x 200m flat area with slight elevation at edges
   - Landing pad: flat textured disc with `concrete_hr_1.png`
   - Defensive positions: `metal_barrel_hr_1.glb` x10 as barricades in ring pattern
   - Wrecked equipment: `machinery_mx_1.glb` x4 as cover
   - Station wreckage: place `wall_hr_1_hole_1.glb` and `beam_hc_horizonatal_1.glb` as debris

3. **Extraction Sequence**:
   - `phantom.glb` arrives for dropship extraction (already in manifest)
   - Marcus&#x27;s mech: `marcus_mech.glb` holding the line (damaged state -- scale down slightly, add particle effects)

**Lighting**:
- Hive tunnels: `#40C0C0`, intensity 0.5 (but dimmer -- failing bioluminescence as hive dies)
- Surface holdout: DirectionalLight `#FFA040`, intensity 2.5 (sunset)
- Sandstorm weather: fog density 0.004, orange-brown `#8B5A2B`

**Sky/Atmosphere**:
- Weather: `sandstorm` at `extreme`
- Heavy particle system: 1500 particles, intense horizontal drift
- Fog: dense, warm brown

**Audio**: `extraction_ambient` / `combat_finale` -- configured

**Model Loading** updates:
- Add: `vehicle/marcus_mech` to preload (Marcus defends)
- Add: `structure/claw`, `structure/crystals` for collapsing hive sections
- Add: `prop/barrel_1`, `prop/barrel_2`, `prop/machinery`
- Add: `station/wall_hole`, `station/beam_horizontal` for surface debris

---

### LEVEL 10: FINAL ESCAPE (type: `finale`)

**Current Status**: Has `CollapsingTerrain.ts` and `EscapeTimer.ts`. Procedural geometry for vehicle chase terrain.

**What Needs Changing**:

1. **Vehicle Escape Route** (similar to Canyon Run but collapsing):
   - Dynamic terrain: `CreateGroundFromHeightMap` segments that collapse behind player
   - Canyon walls: heightmap-based (same as Canyon Run pattern)
   - Place `building_claw.glb` and `building_crystals.glb` erupting from ground as hive collapses
   - `building_stomach.glb` as obstacles to dodge

2. **Debris and Obstacles**:
   - Falling `beam_hc_horizonatal_1.glb` as structural beams
   - `machinery_mx_1.glb` as crashing equipment
   - Wraith pursuers: `wraith.glb` x2-3 chasing the vehicle
   - `phantom.glb` (allied dropship leading the way -- follow the dropship)

3. **Environmental Collapse**:
   - Ground segments behind player disappear (mesh dispose + particles)
   - `building_birther.glb` exploding on either side of the route
   - Fire effects: particle systems at collapse points

**Lighting**:
- Firestorm: DirectionalLight `#FF6020`, high intensity 3.0
- Ground glow: PointLights `#FF4020` (lava/fire from below)
- Weather: `firestorm` at `extreme`
- Rapidly flickering ambient (collapse chaos)

**Sky/Atmosphere**:
- Sky dome: red-orange apocalyptic, very dense fog `#FF6020`
- Particle systems: fire embers (orange-red), falling debris (dark gray)
- Fog density 0.006 (extreme)

**Audio**: `collapse_ambient` / `combat_finale` -- configured

**Model Loading** updates:
- Add: `structure/claw`, `structure/crystals`, `structure/birther`, `structure/stomach` for erupting structures
- Add: `station/beam_horizontal` for falling debris
- Add: `prop/machinery` for crashing equipment

---

## Shared Infrastructure Changes

### 1. New `ModularBaseBuilder.ts` Utility

Create a generalized version of `ModularStationBuilder.ts` that can be used by both FOB Delta and Southern Ice outpost. Key changes:

- Accept a `DamageConfig` parameter: `{ damageRatio: number; overturned: boolean; }` controlling how many segments use `wall_hr_1_hole_1.glb` vs pristine walls
- Accept a `PropPlacement[]` array for automatic prop scattering
- Accept a `LightingConfig` for per-segment lamp placement with flicker parameters
- Reuse the same `StationSegment` type and snapping logic

File: `src/game/levels/ModularBaseBuilder.ts`

### 2. Surface Terrain Factory

Create a shared utility for creating dynamic terrain across all surface levels.

File: `src/game/levels/SurfaceTerrainFactory.ts`

Key API:
```typescript
interface TerrainConfig {
  width: number;
  depth: number;
  subdivisions: number;
  heightScale: number;
  seed: number;
  texturePath?: string;
  textureScale?: number;
  diffuseColor?: Color3;
  specularStrength?: number;
}

function createDynamicTerrain(scene: Scene, config: TerrainConfig): GroundMesh;
```

- Generates heightmap procedurally using seeded noise
- Applies tiled texture (ambientCG or fallback PSX texture)
- Sets up collision
- Returns `GroundMesh` for physics/ray-based ground detection

### 3. HiveEnvironmentBuilder Reuse

The existing `HiveEnvironmentBuilder` class (at `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/environment.ts`) should be extracted to a shared location:

Move to: `src/game/levels/shared/HiveEnvironmentBuilder.ts`

Used by: The Breach, Hive Assault, Extraction (escape phase), Final Escape (erupting structures)

### 4. AssetManifest Updates

The `LEVEL_MANIFESTS` in `AssetManifest.ts` need updates for all levels to include environment model dependencies. Current manifests only reference enemy and vehicle models. Add station/prop/structure assets per level as detailed above.

### 5. PSXModelLoader Path Fix

`PSXModelLoader.ts` references `/models/psx/structures/` but actual files are at `/models/environment/station/`. Either:
- (A) Update PSXModelLoader paths to match actual asset locations, OR
- (B) Deprecate PSXModelLoader in favor of AssetManager pipeline (recommended -- AssetManager already handles everything PSXModelLoader does)

Recommendation: Deprecate PSXModelLoader. Route all loading through `AssetManager` and `AssetManifest.ts`.

---

## ASSET GAP REPORT

### CRITICAL GAPS (must create/acquire)

| Asset | Needed For | Type | Recommendation |
|-------|-----------|------|----------------|
| **Rock terrain texture** | Landfall, Canyon Run, Brothers, Extraction, Final Escape | Texture (256x256) | Download from ambientCG: &quot;Rock043&quot; or &quot;Ground054&quot; -- rust-brown desert rock |
| **Ice/Snow texture** | Southern Ice | Texture (256x256) | Download from ambientCG: &quot;Snow006&quot; or &quot;Ice002&quot; -- white-blue frozen surface |
| **Sand texture** | Canyon Run, Extraction | Texture (256x256) | Download from ambientCG: &quot;Ground037&quot; -- dusty tan sand |
| **Marine NPC model** | Hive Assault (squad), FOB Delta (bodies) | Model | Create low-poly (300 vert) marine in T-pose. Alternatively use `alienmale.glb` or `alienfemale.glb` as placeholder humanoids |

### HIGH-PRIORITY GAPS (strongly desired)

| Asset | Needed For | Type | Recommendation |
|-------|-----------|------|----------------|
| **Prefab building GLBs** | FOB Delta courtyard, Extraction LZ | Model | Currently using station corridors as proxy. Purpose-built prefab huts (PSX-ASSETS.md defines PREFAB_SMALL/MEDIUM/LARGE) would look better |
| **Sandbag wall GLB** | FOB Delta, Extraction | Model (80 verts) | PSX-ASSETS.md defines SANDBAG_WALL (3m x 1m x 1m). Create or approximate with `metal_barrel` lined up |
| **Weapon rack GLB** | Anchor Station armory | Model (100 verts) | PSX-ASSETS.md defines WEAPON_RACK. Currently shelf_mx_1 is used as proxy |
| **Terminal/console GLB** | FOB Delta command, Anchor Station briefing | Model (60 verts) | PSX-ASSETS.md defines TERMINAL. `electrical_equipment_1.glb` works as proxy |
| **Locker GLB** | Anchor Station equipment bay/crew quarters | Model (40 verts) | PSX-ASSETS.md defines LOCKER. `shelf_mx_1.glb` works as proxy |
| **Drop pod GLB** | Anchor Station hangar, Landfall | Model (150 verts) | PSX-ASSETS.md defines DROP_POD. Currently procedural cylinder |

### MEDIUM-PRIORITY GAPS (nice to have)

| Asset | Needed For | Type | Recommendation |
|-------|-----------|------|----------------|
| **Chitin Queen GLB** | The Breach boss fight | Model (800 verts) | PSX-ASSETS.md specifies. Currently no queen GLB -- `tentakel.glb` (broodmother) is used as proxy. Scale up 3x |
| **Tunnel segment GLBs** | The Breach, Hive Assault | Model | PSX-ASSETS.md defines TUNNEL_STRAIGHT, TUNNEL_CURVE, TUNNEL_JUNCTION. Currently procedural inside-out cylinders work acceptably |
| **Egg cluster GLBs** | The Breach | Model (150 verts) | Would replace procedural sphere clusters |
| **Bioluminescent growth GLBs** | The Breach, Hive Assault | Model (60 verts) | Would replace procedural emissive spheres |
| **Concrete barrier GLB** | FOB Delta, Extraction | Model (30 verts) | PSX-ASSETS.md defines BARRIER_CONCRETE |
| **Comm tower GLB** | FOB Delta, Extraction | Model (100 verts) | PSX-ASSETS.md defines COMM_TOWER |
| **Generator GLB** | FOB Delta | Model (80 verts) | PSX-ASSETS.md defines GENERATOR |
| **Chair/Bench/Table GLBs** | Anchor Station, FOB Delta | Model | PSX-ASSETS.md defines furniture. Shelves/boxes work as proxy |
| **Hologram table GLB** | Anchor Station briefing room | Model (60 verts) | Would replace procedural geometry |
| **Dropship GLB** | Extraction (separate from Phantom) | Model (400 verts) | PSX-ASSETS.md defines DROPSHIP. Phantom.glb works as proxy |
| **Floor hazard texture** | Anchor Station, FOB Delta | Texture (128x128) | Yellow/black warning stripes |
| **Hive wall texture** | The Breach tunnels | Texture (128x128) | Dark purple-brown organic surface |

### LOW-PRIORITY GAPS (future polish)

| Asset | Needed For | Type |
|-------|-----------|------|
| Rock pillar GLBs (small/large) | All surface levels | Model |
| Rock boulder GLBs | All surface levels | Model |
| Rock outcrop GLBs | All surface levels | Model |
| Asteroid GLBs (5-10 variants) | Landfall freefall | Model |
| Damage decal textures (blood, scorch) | FOB Delta, The Breach | Texture |
| Organic growth textures | The Breach tunnels | Texture |
| Acid pool texture | The Breach | Texture |

---

## Implementation Priority Order

**Phase 1: Foundation** (enables all subsequent work)
1. Create `SurfaceTerrainFactory.ts` -- shared dynamic terrain utility
2. Create `ModularBaseBuilder.ts` -- generalized station segment builder
3. Extract `HiveEnvironmentBuilder` to shared location
4. Download 3 ambientCG textures (rock, ice, sand)
5. Update `AssetManifest.ts` with per-level environment model dependencies

**Phase 2: Station/Base Levels** (reuse existing pattern)
6. Anchor Station: Add barracks room, place industrial props, connect lamp GLBs to PointLights
7. FOB Delta: Full conversion from procedural to `ModularBaseBuilder` with damage state

**Phase 3: Surface Levels** (use new terrain factory)
8. Landfall: Convert surface phase to dynamic terrain, add surface props
9. Brothers in Arms: Replace Marcus mech with GLB, convert arena to dynamic terrain, add Breach sinkhole structures
10. Canyon Run: Convert to dynamic terrain strips, add bridge structures from beams/floor GLBs

**Phase 4: Hive Levels** (expand existing)
11. The Breach: Increase structure density, more captured vehicles
12. Hive Assault: Surface-to-hive transition with both terrain factory and HiveEnvironmentBuilder

**Phase 5: Final Levels** (combine everything)
13. Southern Ice: Dynamic terrain + outpost from ModularBaseBuilder + crystal structures
14. Extraction: Collapsing hive + surface holdout arena with props
15. Final Escape: Collapsing terrain + erupting structures

**Phase 6: Polish**
16. Deprecate `PSXModelLoader.ts` in favor of `AssetManager`
17. Create missing critical GLBs (marine NPC, drop pod, weapon rack)
18. Performance optimization: LOD for instanced structures, frustum culling

---

### Critical Files for Implementation
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/anchor-station/ModularStationBuilder.ts` - Pattern to follow for all station/base level builders (segment snapping, GLB loading, room definitions)
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/the-breach/environment.ts` - Pattern for hive structure placement via AssetManager instancing (reuse for Hive Assault, Extraction, Final Escape)
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/core/AssetManifest.ts` - Must update LEVEL_MANIFESTS for every level with environment model dependencies
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/SurfaceLevel.ts` - Base class to extend with dynamic terrain support replacing procedural MeshBuilder ground
- `/Users/jbogaty/src/arcade-cabinet/stellar-descent/src/game/levels/fob-delta/FOBDeltaLevel.ts` - Largest procedural-to-model conversion needed; first base-type level to convert</pre><pre>agentId: af6b766 (for resuming to continue this agent&#x27;s work if needed)</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-04-14-187Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-04-14-187Z" class="timestamp-link"><time datetime="2026-01-30T19:04:14.187Z" data-timestamp="2026-01-30T19:04:14.187Z">2026-01-30T19:04:14.187Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>(no content)</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-04-17-602Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-04-17-602Z" class="timestamp-link"><time datetime="2026-01-30T19:04:17.602Z" data-timestamp="2026-01-30T19:04:17.602Z">2026-01-30T19:04:17.602Z</time></a></div><div class="message-content">
<div class="thinking"><div class="thinking-label">Thinking</div><p>Now I have comprehensive output from all three Plan agents. Let me synthesize everything into the revised plan file. I need to write a thorough but scannable plan that covers:</p>
<ol>
<li>CampaignDirector as game spine</li>
<li>Model-based environments for all 10 levels</li>
<li>Splash screen with videos</li>
<li>9-slice military buttons</li>
<li>Condensed intro briefing</li>
<li>Wiring all disconnected systems (Mining Depths, vehicles, ReyesDialogue, achievements, collectibles)</li>
<li>Asset gap report</li>
<li>Documentation updates</li>
<li>Test refactoring</li>
</ol>
<p>Let me now write the revised plan file.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-04-18-489Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-04-18-489Z" class="timestamp-link"><time datetime="2026-01-30T19:04:18.489Z" data-timestamp="2026-01-30T19:04:18.489Z">2026-01-30T19:04:18.489Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>All three Plan agents have returned comprehensive designs. Let me now synthesize everything into the revised plan file.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-04-19-200Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-04-19-200Z" class="timestamp-link"><time datetime="2026-01-30T19:04:19.200Z" data-timestamp="2026-01-30T19:04:19.200Z">2026-01-30T19:04:19.200Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_01CeELf8dMLj5oE8a4W29hMa"><div class="tool-header"><span class="tool-icon">⚙</span> Read</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;file_path&#34;: &#34;/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md&#34;,
  &#34;limit&#34;: 10
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T19-04-19-203Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T19-04-19-203Z" class="timestamp-link"><time datetime="2026-01-30T19:04:19.203Z" data-timestamp="2026-01-30T19:04:19.203Z">2026-01-30T19:04:19.203Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>     1→# Plan: CampaignDirector as Game Spine
     2→
     3→## Summary
     4→
     5→Replace scattered campaign logic with a `CampaignDirector` class that IS the spine of the game. Every level transition, unlock, save, and achievement flows through this single coordinator. Unify GameCanvas to one rendering path (all ILevel, no GameManager). Remove all dead code and fix all warnings.
     6→
     7→## Core Insight
     8→
     9→`tutorial` and `dropping` are NOT separate game phases - they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel respectively. Both levels implement ILevel. The CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.
    10→

&lt;system-reminder&gt;
Whenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.
&lt;/system-reminder&gt;
</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-06-46-251Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-06-46-251Z" class="timestamp-link"><time datetime="2026-01-30T19:06:46.251Z" data-timestamp="2026-01-30T19:06:46.251Z">2026-01-30T19:06:46.251Z</time></a></div><div class="message-content"><div class="file-tool write-tool" data-tool-id="toolu_01EpM4RDEqrUQALRhMKHArUL">
<div class="file-tool-header write-header"><span class="file-tool-icon">📝</span> Write <span class="file-tool-path">quiet-meandering-cookie.md</span></div>
<div class="file-tool-fullpath">/Users/jbogaty/.claude/plans/quiet-meandering-cookie.md</div>
<div class="truncatable"><div class="truncatable-content"><pre class="file-content"># Plan: CampaignDirector + Model Environments + Splash/UI Polish

## Summary

Build Stellar Descent into a complete, atmospheric 10-level campaign by:
1. Creating a **CampaignDirector** as the game&#39;s spine (replaces 15 scattered App.tsx callbacks)
2. Converting **all levels from procedural geometry to GLB model-based environments**
3. Adding **splash screen** with incoming-ui videos, **9-slice military buttons**, and **condensed intro briefing**
4. **Wiring ALL disconnected systems**: Mining Depths, vehicles, ReyesDialogue, achievements, collectibles, objectives
5. Nothing gets removed — everything gets used

## Core Insight

`tutorial` and `dropping` are NOT separate game phases — they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel. Both implement ILevel. CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.

---

## Phase 1: Assets &amp; UI Foundation

### 1A. Move incoming-ui assets to public/
- `incoming-ui/splash-16-9.mp4` → `public/video/splash-16-9.mp4`
- `incoming-ui/splash-9-16.mp4` → `public/video/splash-9-16.mp4`
- `incoming-ui/assets/ui/buttons/*.png` → `public/assets/ui/buttons/*.png`
- Update `vite.config.ts`: add `*.mp4` to PWA workbox runtime caching (CacheFirst, not precache — 12MB each)

### 1B. MilitaryButton component (9-slice)
**New files:** `src/components/ui/MilitaryButton.tsx`, `MilitaryButton.module.css`

CSS `border-image` technique using the 4 button PNGs:
```css
border-image-source: url(&#39;/assets/ui/buttons/btn_military_olive_normal.png&#39;);
border-image-slice: 64 96 64 96 fill;
border-image-width: 32px;
border-image-repeat: stretch;
```
States: `:hover` → hover.png, `:active` → pressed.png, `:disabled` → disabled.png

Props: `children, onClick, disabled, variant (&#39;primary&#39;|&#39;default&#39;|&#39;danger&#39;), size (&#39;sm&#39;|&#39;md&#39;|&#39;lg&#39;)`

Preload all 4 PNGs via `&lt;link rel=&#34;preload&#34;&gt;` in index.html.

### 1C. Apply MilitaryButton to all menus
Replace `&lt;button&gt;` elements in: MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, LevelCompletionScreen.tsx, MissionBriefing.tsx, SettingsMenu.tsx, confirmation modals.

### 1D. SplashScreen component
**New files:** `src/components/ui/SplashScreen.tsx`, `SplashScreen.module.css`

- Detect orientation via `matchMedia(&#39;(orientation: portrait)&#39;)` — pick correct video
- `&lt;video&gt;` with `playsInline`, `muted` (autoplay policy), `autoPlay`
- Tap/keypress to skip, `onEnded` → transition to title sequence
- Handle orientation change mid-playback: two `&lt;video&gt;` elements, toggle visibility, sync `currentTime`
- z-index: 1100 (above all UI)
- Flow: `splash` → `title` → `menu`

### 1E. Condensed Intro Briefing
**New files:** `src/components/ui/IntroBriefing.tsx`, `IntroBriefing.module.css`

- **Condense text** from 20+ lines @ 80ms/char to ~10 lines @ 40ms/char:
  ```
  PRIORITY ALPHA // TEA COMMAND
  Recon Team VANGUARD deployed to PCb-7. 72 hours ago.
  FOB DELTA established. Then silence.
  All contact lost. No distress signal.
  Something woke beneath the surface.
  Find your brother. Find the truth.
  &gt;&gt;&gt; SPECTER: CLEARED FOR ORBITAL DROP &lt;&lt;&lt;
  ```
- Add `seenIntroBriefing: boolean` to `GameSave` interface (bump SAVE_FORMAT_VERSION to 3)
- Trigger ONCE after New Game → save flag → skip on subsequent plays/Continue
- Visual: black bg, scan lines, &#34;BARRACKS // ANCHOR STATION PROMETHEUS&#34; header, typing text, &#34;ACKNOWLEDGED&#34; MilitaryButton
- Flow: New Game → (if !seenIntroBriefing) → IntroBriefing → briefing → tutorial

---

## Phase 2: Campaign Foundation (additive, no breaking changes)

### 2A. Campaign types
**New file:** `src/game/campaign/types.ts` (~80 lines)

```typescript
type CampaignPhase = &#39;idle&#39; | &#39;splash&#39; | &#39;menu&#39; | &#39;briefing&#39; | &#39;intro&#39;
  | &#39;loading&#39; | &#39;playing&#39; | &#39;paused&#39; | &#39;levelComplete&#39; | &#39;gameover&#39; | &#39;credits&#39;;

type CampaignCommand =
  | { type: &#39;NEW_GAME&#39;; difficulty?: DifficultyLevel }
  | { type: &#39;CONTINUE&#39; }
  | { type: &#39;SELECT_LEVEL&#39;; levelId: LevelId }
  | { type: &#39;BEGIN_MISSION&#39; }
  | { type: &#39;INTRO_COMPLETE&#39; }
  | { type: &#39;LOADING_COMPLETE&#39; }
  | { type: &#39;LEVEL_COMPLETE&#39;; stats: LevelStats }
  | { type: &#39;ADVANCE&#39; }
  | { type: &#39;RETRY&#39; }
  | { type: &#39;PAUSE&#39; } | { type: &#39;RESUME&#39; }
  | { type: &#39;PLAYER_DIED&#39; }
  | { type: &#39;MAIN_MENU&#39; }
  | { type: &#39;CREDITS_DONE&#39; }
  | { type: &#39;ENTER_BONUS_LEVEL&#39;; levelId: string }
  | { type: &#39;BONUS_COMPLETE&#39; };

interface CampaignSnapshot { phase, currentLevelId, currentLevelConfig, isBonusLevel, levelKills, levelStartTime }
interface MissionDefinition { levelId, objectives[], vehicleIds?, dialogueTriggers?, audioLogCount, secretCount, skullId?, hasBonusAccess? }
```

### 2B. MissionDefinitions
**New file:** `src/game/campaign/MissionDefinitions.ts` (~250 lines)

Static `MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt;` with:
- Per-level objectives (primary + optional)
- Vehicle availability (Canyon Run: wraith_tank; Hive Assault: wraith_tank + phantom; Final Escape: phantom)
- Dialogue triggers for ReyesDialogue
- Audio log / secret / skull counts
- `hasBonusAccess: &#39;mining_depths&#39;` on FOB Delta

`BONUS_LEVELS` record for Mining Depths (not in main linked list, preserves 10-level campaign).

### 2C. CampaignDirector
**New file:** `src/game/campaign/CampaignDirector.ts` (~350 lines)

State machine with `dispatch(command)` as the ONLY public API. Internally:
- Owns `LevelManager` (existing class, currently unused — activates it)
- Owns `ReyesDialogueManager` (from `audio/ReyesDialogue.ts`, 822 LOC — never imported, now wired)
- Creates per-level collectible systems (AudioLogSystem, SecretAreaSystem, SkullPickupManager)
- Builds `LevelCallbacks` that wire achievements, save objectives, trigger Reyes dialogue
- React integration via `subscribe()` / `getSnapshot()` pattern (useSyncExternalStore)

Key methods:
- `attach(engine, canvas)` / `detach()` — bind to BabylonJS
- `dispatch(command)` — all state transitions
- `buildLevelCallbacks()` — THE wiring hub connecting levels to saves/achievements/dialogue/collectibles
- `handleLevelComplete(stats)` — per-level achievement triggers (all 7+ disconnected methods)
- `initializeCollectibles(levelId)` — creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level

### 2D. useCampaign hook
**New file:** `src/game/campaign/useCampaign.ts` (~30 lines)

```typescript
function useCampaign(): [CampaignSnapshot, (cmd: CampaignCommand) =&gt; void]
```

Uses `useSyncExternalStore` with CampaignDirector singleton. Replaces all 15 useCallback hooks in App.tsx.

### 2E. Campaign index + tests
**New file:** `src/game/campaign/index.ts` (barrel exports + singleton)
**New file:** `src/game/campaign/CampaignDirector.test.ts` (state machine transition tests)

---

## Phase 3: Wire LevelManager + Fix Factories

### 3A. Fix LevelManager
- `src/game/levels/LevelManager.ts` line 203: replace `require()` with static import
- Wire into CampaignDirector&#39;s `startCurrentLevel()` method

### 3B. Fix canyon factory
- `src/game/levels/factories.ts`: replace `canyonLevelFactory` throw with `new SurfaceLevel(engine, canvas, config, callbacks)` — generic canyon infantry level
- Add `mineLevelFactory` for MiningDepthsLevel
- Add `&#39;mine&#39;` to `LevelType` union and `LevelFactoryRegistry`

### 3C. Wire Mining Depths as bonus level
- Add `mining_depths` to `BONUS_LEVELS` in MissionDefinitions.ts
- FOB Delta level triggers `dispatch({ type: &#39;ENTER_BONUS_LEVEL&#39;, levelId: &#39;mining_depths&#39; })` when player interacts with Mining Outpost Gamma-7 terminal
- CampaignDirector saves `returnLevelId = &#39;brothers_in_arms&#39;` (next campaign level)
- On bonus complete, return to campaign flow

### 3D. Wire vehicles into levels
- Canyon Run (`CanyonRunLevel.ts`): instantiate `WraithTank` as enemy vehicle, spawn along route
- Hive Assault (`HiveAssaultLevel.ts`): instantiate `WraithTank` for player vehicle phase + `PhantomDropship` for supply drops
- Final Escape (`FinalEscapeLevel.ts`): instantiate `PhantomDropship` as escape transport
- Each: import from `../vehicles/`, create in `createEnvironment()`, update in `updateLevel()`, dispose in `disposeLevel()`

### 3E. Wire ReyesDialogue
- CampaignDirector owns `ReyesDialogueManager` singleton
- Calls `reyes.playBriefing(levelId)` on level start
- Wires `onCombatStateChange` → `reyes.triggerDialogue(&#39;hostiles_detected&#39;/&#39;hostiles_cleared&#39;)`
- Wires `onHealthChange` → health warning triggers
- Add `onDialogueTrigger?: (trigger: string) =&gt; void` to `LevelCallbacks` for level-initiated triggers

### 3F. Wire achievements
CampaignDirector&#39;s `handleLevelComplete()` calls per-level achievement triggers:
| Level | Achievement trigger |
|-------|-------------------|
| anchor_station | `onTutorialComplete()` |
| landfall | `onHaloDropComplete()`, `onFirstCombatWin()` |
| canyon_run | `onCanyonRunComplete()` |
| brothers_in_arms | `onMarcusFound()`, `onBrothersInArmsComplete()` |
| southern_ice | `onSouthernIceComplete()` |
| the_breach | `onQueenDefeated()` |
| hive_assault | `onHiveAssaultComplete()` |
| extraction | `onExtractionComplete()` |
| final_escape | `onFinalEscapeComplete()`, `onGameComplete()` |

Plus: `onKill` / `onDamageTaken` / `onAudioLogFound` / `onSecretFound` via callbacks.

### 3G. Wire collectibles + objectives
- CampaignDirector creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level
- Callbacks wire to `saveSystem.setLevelFlag(levelId, &#39;audiolog_X&#39;, true)`
- `onObjectiveUpdate` populates `GameSave.objectives` (currently always empty)

---

## Phase 4: Unify GameCanvas + Simplify App.tsx

### 4A. Unify GameCanvas rendering
- Remove `gameManagerRef` and `GameManager` import
- Remove dual rendering paths (`tutorialLevelRef` vs `gameManagerRef`)
- Single `activeLevelRef` for the render loop
- CampaignDirector controls level lifecycle; GameCanvas receives `campaign` snapshot + `dispatch` as props
- Render loop: `activeLevel?.update(dt) + activeLevel.getScene().render()` OR `menuScene.render()`
- Remove `GameState` type from GameCanvas (use `CampaignPhase` from campaign/types.ts)

### 4B. Simplify App.tsx (~700 → ~300 lines)
- Replace 15 `useCallback` hooks with `useCampaign()` returning `[snapshot, dispatch]`
- Replace `gameState` with `snapshot.phase`
- Remove: `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey`, `levelStartTimeRef`
- Add phases: `&#39;splash&#39;`, `&#39;introBriefing&#39;`
- UI rendering becomes simple phase switch:
  ```tsx
  {phase === &#39;splash&#39; &amp;&amp; &lt;SplashScreen onComplete={() =&gt; dispatch({ type: &#39;MAIN_MENU&#39; })} /&gt;}
  {phase === &#39;menu&#39; &amp;&amp; &lt;MainMenu dispatch={dispatch} /&gt;}
  {phase === &#39;briefing&#39; &amp;&amp; &lt;MissionBriefing dispatch={dispatch} /&gt;}
  {phase === &#39;playing&#39; &amp;&amp; &lt;HUD /&gt;}
  // etc.
  ```

---

## Phase 5: Model-Based Level Environments

### 5A. Shared infrastructure
**New file:** `src/game/levels/shared/SurfaceTerrainFactory.ts`
- `createDynamicTerrain(scene, config)` → `GroundMesh`
- Uses `CreateGroundFromHeightMap` with seeded procedural heightmap
- Tiled texture support (ambientCG or PSX fallback)
- Used by: Landfall, Canyon Run, Brothers, Southern Ice, Extraction, Final Escape

**New file:** `src/game/levels/shared/ModularBaseBuilder.ts`
- Generalized `ModularStationBuilder` with `DamageConfig` parameter
- Controls `wall_hr_1_hole_1.glb` ratio for battle damage
- Prop scattering with `PropPlacement[]`
- Flickering lamp placement with `LightingConfig`
- Used by: FOB Delta, Southern Ice outpost

**Move:** `the-breach/HiveEnvironmentBuilder` → `shared/HiveEnvironmentBuilder.ts`
- Used by: The Breach, Hive Assault, Extraction (escape phase), Final Escape (erupting structures)

### 5B. Download ambientCG textures (3 critical)
- Rock terrain (rust-brown): for Landfall, Canyon Run, Brothers, Extraction, Final Escape
- Ice/snow: for Southern Ice
- Sand: for Canyon Run, Extraction

Fallback: tint existing `concrete_hr_1.png` and `wall_hr_1.png`

### 5C. Per-level environment conversion

**Level 1: Anchor Station** (station) — PARTIALLY DONE, enhance
- Already uses ModularStationBuilder with GLB corridors
- ADD: Barracks room (3 new corridor segments at north end, shelves as bunks, lamps, barrels)
- ADD: Industrial props in Equipment Bay/Engine Room (machinery, pipes, electrical, shelves)
- Move player spawn to barracks center

**Level 2: Landfall** (drop → surface) — surface phase needs terrain
- Freefall: keep procedural asteroids (justified), add PSX textures
- Surface: replace MeshBuilder.CreateGround → `SurfaceTerrainFactory.createDynamicTerrain()`
- Add barrels/boxes as cover props around LZ
- Sky: layered dome (dust haze inner + starfield outer), dust particles, EXP2 fog

**Level 3: Canyon Run** (vehicle) — FULL CONVERSION
- Replace box-based canyon walls → heightmap terrain strips (left wall, floor, right wall)
- Bridges: `beam_hc_horizonatal_1.glb` spanning canyon + `floor_ceiling_hr_1.glb` surfaces
- Obstacles: barrels, machinery, cardboard boxes along route
- Enemy vehicles: `wraith.glb` pursuers
- Alien roadblocks: `building_claw.glb`

**Level 4: FOB Delta** (base) — FULL CONVERSION
- Replace all procedural geometry → `ModularBaseBuilder` with damage state
- ~25-30 corridor segments forming perimeter, courtyard, barracks, command, vehicle bay
- 40% walls use `wall_hr_1_hole_1.glb` (battle damage)
- Overturned shelves, scattered props, flickering lamps
- Courtyard: open-air section with floor_ceiling tiles as ground pad
- Horror lighting: variable flicker 0.5-1.5 intensity, emergency red in barracks

**Level 5: Brothers in Arms** (brothers) — CRITICAL FIX
- Replace procedural box mech → `marcus_mech.glb` (589 KB)
- Canyon arena: `SurfaceTerrainFactory.createDynamicTerrain()` (200m x 150m)
- The Breach sinkhole: depression in heightmap, ringed with `building_crystals.glb` + `building_undercrystal.glb` + `building_claw.glb`
- Bioluminescent glow from sinkhole: PointLight `#4AC8C8`

**Level 6: Southern Ice** (ice) — enhance
- Terrain: `SurfaceTerrainFactory` with ice/snow material
- Ice caves: keep procedural cylinders, ADD `building_crystals.glb` + `building_undercrystal.glb` inside
- Abandoned outpost: `ModularBaseBuilder` (6-8 segments, storm damage)
- Aurora: keep existing procedural animated strips
- Blizzard: 1000+ white particles, dense fog

**Level 7: The Breach** (hive) — BEST IMPLEMENTED, expand
- Already loads all 7 hive GLBs via HiveEnvironmentBuilder
- Increase structure density: 10-15 → 30-40 placements
- More captured vehicles: wraith x3, phantom x1 (absorbed by organic growth)
- Line tunnel walls with scaled-down `building_claw.glb` as ribbing

**Level 8: Hive Assault** (combined_arms) — surface-to-hive transition
- First half: dynamic terrain + `marcus_mech.glb` + wraith enemies + forward base (station segments)
- Second half: HiveEnvironmentBuilder for hive interior
- Destroy objectives: `building_brain.glb` x3 as nexus nodes

**Level 9: Extraction** (extraction) — collapsing hive + holdout
- Escape phase: HiveEnvironmentBuilder structures that collapse (animated position + particles)
- LZ Omega: dynamic terrain (200m x 200m), landing pad, barrel barricades, wrecked machinery
- Marcus mech holding the line; phantom.glb arrives for extraction

**Level 10: Final Escape** (finale) — collapsing terrain chase
- Dynamic terrain segments that disappear behind player
- Hive structures erupting: `building_claw.glb`, `building_crystals.glb`, `building_birther.glb`
- Falling `beam_hc_horizonatal_1.glb` as structural debris
- Firestorm: DirectionalLight `#FF6020`, intensity 3.0, dense red-orange fog

### 5D. Update AssetManifest.ts
- Add station/prop/structure models to each level&#39;s manifest `required` and `preload` arrays
- Move deferred assets to preload where needed for environment (shelves, machinery, lamps)

---

## Phase 6: Documentation &amp; Tests

### 6A. Update docs
- `docs/LEVELS.md`: Update campaign structure to 10 levels (currently shows 6), add Mining Depths as bonus
- `docs/ARCHITECTURE.md`: Add CampaignDirector to architecture diagram
- `docs/ASSET-INTEGRATION.md`: Update with model-based environment patterns

### 6B. Refactor tests (breaking is OK)
- Update `src/game/context/GameContext.test.tsx` for CampaignPhase instead of GameState
- Update `e2e/game-flow.spec.ts` for new splash → title → menu flow
- Update `e2e/playthrough.spec.ts` for CampaignDirector dispatch API
- Add: `src/game/campaign/CampaignDirector.test.ts` (state machine transitions)
- Add: `e2e/levels/mining-depths.spec.ts` (bonus level access from FOB Delta)

---

## Phase 7: Validation

1. `npx tsc --noEmit` — 0 errors
2. `npx vitest run` — all tests pass
3. `npx biome check .` — 0 errors
4. `npx vite build` — succeeds with PWA
5. Manual smoke: Splash → Title → Menu → New Game → IntroBriefing (once) → Briefing → Tutorial (Barracks start) → HALO Drop → Canyon Run → FOB Delta → Mining Depths (bonus) → Brothers → Southern Ice → The Breach → Hive Assault → Extraction → Final Escape → Credits
6. Continue: loads saved level directly (skips intro briefing)
7. URL param: `?level=fob_delta` loads FOB Delta directly
8. All 9-slice buttons render correctly across menu screens
9. Splash video plays in both orientations, skippable

---

## Asset Gap Report

### Critical (must acquire/create)
| Asset | Needed For | Action |
|-------|-----------|--------|
| Rock terrain texture (256x256) | 6 surface levels | Download ambientCG &#34;Rock043&#34; or tint `concrete_hr_1.png` |
| Ice/snow texture (256x256) | Southern Ice | Download ambientCG &#34;Snow006&#34; or white-tint `concrete_hr_1.png` |
| Sand texture (256x256) | Canyon Run, Extraction | Download ambientCG &#34;Ground037&#34; or tan-tint existing |

### High Priority (strongly desired)
| Asset | Current Proxy | Notes |
|-------|--------------|-------|
| Barracks bunks/beds | `shelf_mx_1.glb` on side | MeshBuilder box beds also acceptable |
| Weapon rack | `shelf_mx_1.glb` | Functional proxy |
| Terminal/console | `electrical_equipment_1.glb` | Functional proxy |
| Drop pod | Procedural cylinder | Keep procedural for now |
| Sandbag walls | Lined-up `metal_barrel` | Functional proxy |
| Marine NPC | None | Use `alienmale.glb` as placeholder humanoid |

### Existing Assets (47 GLBs) — ALL used across levels
| Category | Count | Used By |
|----------|-------|---------|
| Station (17) | 17 | Anchor Station, FOB Delta, Southern Ice outpost, Extraction debris |
| Props (13) | 13 | All levels (barrels, boxes, lamps, shelves, machinery, pipes) |
| Hive (7) | 7 | The Breach, Hive Assault, Extraction, Final Escape, Brothers (sinkhole) |
| Enemies (8) | 8 | All combat levels |
| Vehicles (3) | 3 | Brothers (marcus_mech), Canyon Run + Hive Assault (wraith), Extraction + Final Escape (phantom) |

---

## Implementation Order (all phases)

| # | Task | Files | Breaks Tests? |
|---|------|-------|---------------|
| 1 | Move incoming-ui assets | public/video/, public/assets/ui/buttons/, vite.config.ts | No |
| 2 | MilitaryButton component | NEW: MilitaryButton.tsx/.module.css | No |
| 3 | Apply MilitaryButton to menus | MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, etc. | No |
| 4 | SplashScreen component | NEW: SplashScreen.tsx/.module.css | No |
| 5 | IntroBriefing component | NEW: IntroBriefing.tsx/.module.css, GameSave.ts, SaveSystem.ts | No |
| 6 | Campaign types + MissionDefinitions | NEW: campaign/types.ts, MissionDefinitions.ts | No |
| 7 | CampaignDirector class | NEW: campaign/CampaignDirector.ts, index.ts | No |
| 8 | useCampaign hook | NEW: campaign/useCampaign.ts | No |
| 9 | Fix LevelManager require() | LevelManager.ts line 203 | No |
| 10 | Fix canyon factory + add mine factory | factories.ts, types.ts | No |
| 11 | Wire vehicles into levels | CanyonRunLevel.ts, HiveAssaultLevel.ts, FinalEscapeLevel.ts | No |
| 12 | Wire ReyesDialogue | CampaignDirector.ts, types.ts (add onDialogueTrigger) | No |
| 13 | Wire Mining Depths bonus level | MissionDefinitions.ts, FOBDeltaLevel.ts | No |
| 14 | SurfaceTerrainFactory | NEW: shared/SurfaceTerrainFactory.ts | No |
| 15 | ModularBaseBuilder | NEW: shared/ModularBaseBuilder.ts | No |
| 16 | Extract HiveEnvironmentBuilder | Move the-breach/env → shared/ | No |
| 17 | Anchor Station barracks room | AnchorStationLevel.ts, ModularStationBuilder.ts | Maybe |
| 18 | FOB Delta model conversion | FOBDeltaLevel.ts, fob-delta/environment.ts | Maybe |
| 19 | Brothers in Arms GLB mech | BrothersInArmsLevel.ts | Maybe |
| 20 | Landfall surface terrain | LandfallLevel.ts | Maybe |
| 21 | Canyon Run terrain conversion | CanyonRunLevel.ts, canyon-run/environment.ts | Maybe |
| 22 | Remaining level environments | SouthernIce, HiveAssault, Extraction, FinalEscape | Maybe |
| 23 | **Unify GameCanvas** | GameCanvas.tsx (remove dual path) | **Yes** |
| 24 | **Simplify App.tsx** | App.tsx (replace callbacks with useCampaign) | **Yes** |
| 25 | Wire achievements + collectibles + objectives | CampaignDirector.ts | No |
| 26 | Update AssetManifest.ts | AssetManifest.ts | No |
| 27 | Refactor tests | GameContext.test.tsx, e2e/*.spec.ts, NEW: CampaignDirector.test.ts | **Yes** |
| 28 | Update documentation | docs/LEVELS.md, ARCHITECTURE.md, ASSET-INTEGRATION.md | No |
| 29 | Validate: tsc, vitest, biome, vite build | — | — |
</pre></div><button class="expand-btn">Show more</button></div>
</div></div></div>
<div class="message tool-reply" id="msg-2026-01-30T19-06-46-265Z"><div class="message-header"><span class="role-label">Tool reply</span><a href="#msg-2026-01-30T19-06-46-265Z" class="timestamp-link"><time datetime="2026-01-30T19:06:46.265Z" data-timestamp="2026-01-30T19:06:46.265Z">2026-01-30T19:06:46.265Z</time></a></div><div class="message-content"><div class="tool-result"><div class="truncatable"><div class="truncatable-content"><pre>The file /Users/jbogaty/.claude/plans/quiet-meandering-cookie.md has been updated. Here&#x27;s the result of running `cat -n` on a snippet of the edited file:
     1→# Plan: CampaignDirector + Model Environments + Splash/UI Polish
     2→
     3→## Summary
     4→
     5→Build Stellar Descent into a complete, atmospheric 10-level campaign by:
     6→1. Creating a **CampaignDirector** as the game&#x27;s spine (replaces 15 scattered App.tsx callbacks)
     7→2. Converting **all levels from procedural geometry to GLB model-based environments**
     8→3. Adding **splash screen** with incoming-ui videos, **9-slice military buttons**, and **condensed intro briefing**
     9→4. **Wiring ALL disconnected systems**: Mining Depths, vehicles, ReyesDialogue, achievements, collectibles, objectives
    10→5. Nothing gets removed — everything gets used
    11→
    12→## Core Insight
    13→
    14→`tutorial` and `dropping` are NOT separate game phases — they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel. Both implement ILevel. CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.
    15→
    16→---
    17→
    18→## Phase 1: Assets &amp; UI Foundation
    19→
    20→### 1A. Move incoming-ui assets to public/
    21→- `incoming-ui/splash-16-9.mp4` → `public/video/splash-16-9.mp4`
    22→- `incoming-ui/splash-9-16.mp4` → `public/video/splash-9-16.mp4`
    23→- `incoming-ui/assets/ui/buttons/*.png` → `public/assets/ui/buttons/*.png`
    24→- Update `vite.config.ts`: add `*.mp4` to PWA workbox runtime caching (CacheFirst, not precache — 12MB each)
    25→
    26→### 1B. MilitaryButton component (9-slice)
    27→**New files:** `src/components/ui/MilitaryButton.tsx`, `MilitaryButton.module.css`
    28→
    29→CSS `border-image` technique using the 4 button PNGs:
    30→```css
    31→border-image-source: url(&#x27;/assets/ui/buttons/btn_military_olive_normal.png&#x27;);
    32→border-image-slice: 64 96 64 96 fill;
    33→border-image-width: 32px;
    34→border-image-repeat: stretch;
    35→```
    36→States: `:hover` → hover.png, `:active` → pressed.png, `:disabled` → disabled.png
    37→
    38→Props: `children, onClick, disabled, variant (&#x27;primary&#x27;|&#x27;default&#x27;|&#x27;danger&#x27;), size (&#x27;sm&#x27;|&#x27;md&#x27;|&#x27;lg&#x27;)`
    39→
    40→Preload all 4 PNGs via `&lt;link rel=&quot;preload&quot;&gt;` in index.html.
    41→
    42→### 1C. Apply MilitaryButton to all menus
    43→Replace `&lt;button&gt;` elements in: MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, LevelCompletionScreen.tsx, MissionBriefing.tsx, SettingsMenu.tsx, confirmation modals.
    44→
    45→### 1D. SplashScreen component
    46→**New files:** `src/components/ui/SplashScreen.tsx`, `SplashScreen.module.css`
    47→
    48→- Detect orientation via `matchMedia(&#x27;(orientation: portrait)&#x27;)` — pick correct video
    49→- `&lt;video&gt;` with `playsInline`, `muted` (autoplay policy), `autoPlay`
    50→- Tap/keypress to skip, `onEnded` → transition to title sequence
    51→- Handle orientation change mid-playback: two `&lt;video&gt;` elements, toggle visibility, sync `currentTime`
    52→- z-index: 1100 (above all UI)
    53→- Flow: `splash` → `title` → `menu`
    54→
    55→### 1E. Condensed Intro Briefing
    56→**New files:** `src/components/ui/IntroBriefing.tsx`, `IntroBriefing.module.css`
    57→
    58→- **Condense text** from 20+ lines @ 80ms/char to ~10 lines @ 40ms/char:
    59→  ```
    60→  PRIORITY ALPHA // TEA COMMAND
    61→  Recon Team VANGUARD deployed to PCb-7. 72 hours ago.
    62→  FOB DELTA established. Then silence.
    63→  All contact lost. No distress signal.
    64→  Something woke beneath the surface.
    65→  Find your brother. Find the truth.
    66→  &gt;&gt;&gt; SPECTER: CLEARED FOR ORBITAL DROP &lt;&lt;&lt;
    67→  ```
    68→- Add `seenIntroBriefing: boolean` to `GameSave` interface (bump SAVE_FORMAT_VERSION to 3)
    69→- Trigger ONCE after New Game → save flag → skip on subsequent plays/Continue
    70→- Visual: black bg, scan lines, &quot;BARRACKS // ANCHOR STATION PROMETHEUS&quot; header, typing text, &quot;ACKNOWLEDGED&quot; MilitaryButton
    71→- Flow: New Game → (if !seenIntroBriefing) → IntroBriefing → briefing → tutorial
    72→
    73→---
    74→
    75→## Phase 2: Campaign Foundation (additive, no breaking changes)
    76→
    77→### 2A. Campaign types
    78→**New file:** `src/game/campaign/types.ts` (~80 lines)
    79→
    80→```typescript
    81→type CampaignPhase = &#x27;idle&#x27; | &#x27;splash&#x27; | &#x27;menu&#x27; | &#x27;briefing&#x27; | &#x27;intro&#x27;
    82→  | &#x27;loading&#x27; | &#x27;playing&#x27; | &#x27;paused&#x27; | &#x27;levelComplete&#x27; | &#x27;gameover&#x27; | &#x27;credits&#x27;;
    83→
    84→type CampaignCommand =
    85→  | { type: &#x27;NEW_GAME&#x27;; difficulty?: DifficultyLevel }
    86→  | { type: &#x27;CONTINUE&#x27; }
    87→  | { type: &#x27;SELECT_LEVEL&#x27;; levelId: LevelId }
    88→  | { type: &#x27;BEGIN_MISSION&#x27; }
    89→  | { type: &#x27;INTRO_COMPLETE&#x27; }
    90→  | { type: &#x27;LOADING_COMPLETE&#x27; }
    91→  | { type: &#x27;LEVEL_COMPLETE&#x27;; stats: LevelStats }
    92→  | { type: &#x27;ADVANCE&#x27; }
    93→  | { type: &#x27;RETRY&#x27; }
    94→  | { type: &#x27;PAUSE&#x27; } | { type: &#x27;RESUME&#x27; }
    95→  | { type: &#x27;PLAYER_DIED&#x27; }
    96→  | { type: &#x27;MAIN_MENU&#x27; }
    97→  | { type: &#x27;CREDITS_DONE&#x27; }
    98→  | { type: &#x27;ENTER_BONUS_LEVEL&#x27;; levelId: string }
    99→  | { type: &#x27;BONUS_COMPLETE&#x27; };
   100→
   101→interface CampaignSnapshot { phase, currentLevelId, currentLevelConfig, isBonusLevel, levelKills, levelStartTime }
   102→interface MissionDefinition { levelId, objectives[], vehicleIds?, dialogueTriggers?, audioLogCount, secretCount, skullId?, hasBonusAccess? }
   103→```
   104→
   105→### 2B. MissionDefinitions
   106→**New file:** `src/game/campaign/MissionDefinitions.ts` (~250 lines)
   107→
   108→Static `MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt;` with:
   109→- Per-level objectives (primary + optional)
   110→- Vehicle availability (Canyon Run: wraith_tank; Hive Assault: wraith_tank + phantom; Final Escape: phantom)
   111→- Dialogue triggers for ReyesDialogue
   112→- Audio log / secret / skull counts
   113→- `hasBonusAccess: &#x27;mining_depths&#x27;` on FOB Delta
   114→
   115→`BONUS_LEVELS` record for Mining Depths (not in main linked list, preserves 10-level campaign).
   116→
   117→### 2C. CampaignDirector
   118→**New file:** `src/game/campaign/CampaignDirector.ts` (~350 lines)
   119→
   120→State machine with `dispatch(command)` as the ONLY public API. Internally:
   121→- Owns `LevelManager` (existing class, currently unused — activates it)
   122→- Owns `ReyesDialogueManager` (from `audio/ReyesDialogue.ts`, 822 LOC — never imported, now wired)
   123→- Creates per-level collectible systems (AudioLogSystem, SecretAreaSystem, SkullPickupManager)
   124→- Builds `LevelCallbacks` that wire achievements, save objectives, trigger Reyes dialogue
   125→- React integration via `subscribe()` / `getSnapshot()` pattern (useSyncExternalStore)
   126→
   127→Key methods:
   128→- `attach(engine, canvas)` / `detach()` — bind to BabylonJS
   129→- `dispatch(command)` — all state transitions
   130→- `buildLevelCallbacks()` — THE wiring hub connecting levels to saves/achievements/dialogue/collectibles
   131→- `handleLevelComplete(stats)` — per-level achievement triggers (all 7+ disconnected methods)
   132→- `initializeCollectibles(levelId)` — creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level
   133→
   134→### 2D. useCampaign hook
   135→**New file:** `src/game/campaign/useCampaign.ts` (~30 lines)
   136→
   137→```typescript
   138→function useCampaign(): [CampaignSnapshot, (cmd: CampaignCommand) =&gt; void]
   139→```
   140→
   141→Uses `useSyncExternalStore` with CampaignDirector singleton. Replaces all 15 useCallback hooks in App.tsx.
   142→
   143→### 2E. Campaign index + tests
   144→**New file:** `src/game/campaign/index.ts` (barrel exports + singleton)
   145→**New file:** `src/game/campaign/CampaignDirector.test.ts` (state machine transition tests)
   146→
   147→---
   148→
   149→## Phase 3: Wire LevelManager + Fix Factories
   150→
   151→### 3A. Fix LevelManager
   152→- `src/game/levels/LevelManager.ts` line 203: replace `require()` with static import
   153→- Wire into CampaignDirector&#x27;s `startCurrentLevel()` method
   154→
   155→### 3B. Fix canyon factory
   156→- `src/game/levels/factories.ts`: replace `canyonLevelFactory` throw with `new SurfaceLevel(engine, canvas, config, callbacks)` — generic canyon infantry level
   157→- Add `mineLevelFactory` for MiningDepthsLevel
   158→- Add `&#x27;mine&#x27;` to `LevelType` union and `LevelFactoryRegistry`
   159→
   160→### 3C. Wire Mining Depths as bonus level
   161→- Add `mining_depths` to `BONUS_LEVELS` in MissionDefinitions.ts
   162→- FOB Delta level triggers `dispatch({ type: &#x27;ENTER_BONUS_LEVEL&#x27;, levelId: &#x27;mining_depths&#x27; })` when player interacts with Mining Outpost Gamma-7 terminal
   163→- CampaignDirector saves `returnLevelId = &#x27;brothers_in_arms&#x27;` (next campaign level)
   164→- On bonus complete, return to campaign flow
   165→
   166→### 3D. Wire vehicles into levels
   167→- Canyon Run (`CanyonRunLevel.ts`): instantiate `WraithTank` as enemy vehicle, spawn along route
   168→- Hive Assault (`HiveAssaultLevel.ts`): instantiate `WraithTank` for player vehicle phase + `PhantomDropship` for supply drops
   169→- Final Escape (`FinalEscapeLevel.ts`): instantiate `PhantomDropship` as escape transport
   170→- Each: import from `../vehicles/`, create in `createEnvironment()`, update in `updateLevel()`, dispose in `disposeLevel()`
   171→
   172→### 3E. Wire ReyesDialogue
   173→- CampaignDirector owns `ReyesDialogueManager` singleton
   174→- Calls `reyes.playBriefing(levelId)` on level start
   175→- Wires `onCombatStateChange` → `reyes.triggerDialogue(&#x27;hostiles_detected&#x27;/&#x27;hostiles_cleared&#x27;)`
   176→- Wires `onHealthChange` → health warning triggers
   177→- Add `onDialogueTrigger?: (trigger: string) =&gt; void` to `LevelCallbacks` for level-initiated triggers
   178→
   179→### 3F. Wire achievements
   180→CampaignDirector&#x27;s `handleLevelComplete()` calls per-level achievement triggers:
   181→| Level | Achievement trigger |
   182→|-------|-------------------|
   183→| anchor_station | `onTutorialComplete()` |
   184→| landfall | `onHaloDropComplete()`, `onFirstCombatWin()` |
   185→| canyon_run | `onCanyonRunComplete()` |
   186→| brothers_in_arms | `onMarcusFound()`, `onBrothersInArmsComplete()` |
   187→| southern_ice | `onSouthernIceComplete()` |
   188→| the_breach | `onQueenDefeated()` |
   189→| hive_assault | `onHiveAssaultComplete()` |
   190→| extraction | `onExtractionComplete()` |
   191→| final_escape | `onFinalEscapeComplete()`, `onGameComplete()` |
   192→
   193→Plus: `onKill` / `onDamageTaken` / `onAudioLogFound` / `onSecretFound` via callbacks.
   194→
   195→### 3G. Wire collectibles + objectives
   196→- CampaignDirector creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level
   197→- Callbacks wire to `saveSystem.setLevelFlag(levelId, &#x27;audiolog_X&#x27;, true)`
   198→- `onObjectiveUpdate` populates `GameSave.objectives` (currently always empty)
   199→
   200→---
   201→
   202→## Phase 4: Unify GameCanvas + Simplify App.tsx
   203→
   204→### 4A. Unify GameCanvas rendering
   205→- Remove `gameManagerRef` and `GameManager` import
   206→- Remove dual rendering paths (`tutorialLevelRef` vs `gameManagerRef`)
   207→- Single `activeLevelRef` for the render loop
   208→- CampaignDirector controls level lifecycle; GameCanvas receives `campaign` snapshot + `dispatch` as props
   209→- Render loop: `activeLevel?.update(dt) + activeLevel.getScene().render()` OR `menuScene.render()`
   210→- Remove `GameState` type from GameCanvas (use `CampaignPhase` from campaign/types.ts)
   211→
   212→### 4B. Simplify App.tsx (~700 → ~300 lines)
   213→- Replace 15 `useCallback` hooks with `useCampaign()` returning `[snapshot, dispatch]`
   214→- Replace `gameState` with `snapshot.phase`
   215→- Remove: `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey`, `levelStartTimeRef`
   216→- Add phases: `&#x27;splash&#x27;`, `&#x27;introBriefing&#x27;`
   217→- UI rendering becomes simple phase switch:
   218→  ```tsx
   219→  {phase === &#x27;splash&#x27; &amp;&amp; &lt;SplashScreen onComplete={() =&gt; dispatch({ type: &#x27;MAIN_MENU&#x27; })} /&gt;}
   220→  {phase === &#x27;menu&#x27; &amp;&amp; &lt;MainMenu dispatch={dispatch} /&gt;}
   221→  {phase === &#x27;briefing&#x27; &amp;&amp; &lt;MissionBriefing dispatch={dispatch} /&gt;}
   222→  {phase === &#x27;playing&#x27; &amp;&amp; &lt;HUD /&gt;}
   223→  // etc.
   224→  ```
   225→
   226→---
   227→
   228→## Phase 5: Model-Based Level Environments
   229→
   230→### 5A. Shared infrastructure
   231→**New file:** `src/game/levels/shared/SurfaceTerrainFactory.ts`
   232→- `createDynamicTerrain(scene, config)` → `GroundMesh`
   233→- Uses `CreateGroundFromHeightMap` with seeded procedural heightmap
   234→- Tiled texture support (ambientCG or PSX fallback)
   235→- Used by: Landfall, Canyon Run, Brothers, Southern Ice, Extraction, Final Escape
   236→
   237→**New file:** `src/game/levels/shared/ModularBaseBuilder.ts`
   238→- Generalized `ModularStationBuilder` with `DamageConfig` parameter
   239→- Controls `wall_hr_1_hole_1.glb` ratio for battle damage
   240→- Prop scattering with `PropPlacement[]`
   241→- Flickering lamp placement with `LightingConfig`
   242→- Used by: FOB Delta, Southern Ice outpost
   243→
   244→**Move:** `the-breach/HiveEnvironmentBuilder` → `shared/HiveEnvironmentBuilder.ts`
   245→- Used by: The Breach, Hive Assault, Extraction (escape phase), Final Escape (erupting structures)
   246→
   247→### 5B. Download ambientCG textures (3 critical)
   248→- Rock terrain (rust-brown): for Landfall, Canyon Run, Brothers, Extraction, Final Escape
   249→- Ice/snow: for Southern Ice
   250→- Sand: for Canyon Run, Extraction
   251→
   252→Fallback: tint existing `concrete_hr_1.png` and `wall_hr_1.png`
   253→
   254→### 5C. Per-level environment conversion
   255→
   256→**Level 1: Anchor Station** (station) — PARTIALLY DONE, enhance
   257→- Already uses ModularStationBuilder with GLB corridors
   258→- ADD: Barracks room (3 new corridor segments at north end, shelves as bunks, lamps, barrels)
   259→- ADD: Industrial props in Equipment Bay/Engine Room (machinery, pipes, electrical, shelves)
   260→- Move player spawn to barracks center
   261→
   262→**Level 2: Landfall** (drop → surface) — surface phase needs terrain
   263→- Freefall: keep procedural asteroids (justified), add PSX textures
   264→- Surface: replace MeshBuilder.CreateGround → `SurfaceTerrainFactory.createDynamicTerrain()`
   265→- Add barrels/boxes as cover props around LZ
   266→- Sky: layered dome (dust haze inner + starfield outer), dust particles, EXP2 fog
   267→
   268→**Level 3: Canyon Run** (vehicle) — FULL CONVERSION
   269→- Replace box-based canyon walls → heightmap terrain strips (left wall, floor, right wall)
   270→- Bridges: `beam_hc_horizonatal_1.glb` spanning canyon + `floor_ceiling_hr_1.glb` surfaces
   271→- Obstacles: barrels, machinery, cardboard boxes along route
   272→- Enemy vehicles: `wraith.glb` pursuers
   273→- Alien roadblocks: `building_claw.glb`
   274→
   275→**Level 4: FOB Delta** (base) — FULL CONVERSION
   276→- Replace all procedural geometry → `ModularBaseBuilder` with damage state
   277→- ~25-30 corridor segments forming perimeter, courtyard, barracks, command, vehicle bay
   278→- 40% walls use `wall_hr_1_hole_1.glb` (battle damage)
   279→- Overturned shelves, scattered props, flickering lamps
   280→- Courtyard: open-air section with floor_ceiling tiles as ground pad
   281→- Horror lighting: variable flicker 0.5-1.5 intensity, emergency red in barracks
   282→
   283→**Level 5: Brothers in Arms** (brothers) — CRITICAL FIX
   284→- Replace procedural box mech → `marcus_mech.glb` (589 KB)
   285→- Canyon arena: `SurfaceTerrainFactory.createDynamicTerrain()` (200m x 150m)
   286→- The Breach sinkhole: depression in heightmap, ringed with `building_crystals.glb` + `building_undercrystal.glb` + `building_claw.glb`
   287→- Bioluminescent glow from sinkhole: PointLight `#4AC8C8`
   288→
   289→**Level 6: Southern Ice** (ice) — enhance
   290→- Terrain: `SurfaceTerrainFactory` with ice/snow material
   291→- Ice caves: keep procedural cylinders, ADD `building_crystals.glb` + `building_undercrystal.glb` inside
   292→- Abandoned outpost: `ModularBaseBuilder` (6-8 segments, storm damage)
   293→- Aurora: keep existing procedural animated strips
   294→- Blizzard: 1000+ white particles, dense fog
   295→
   296→**Level 7: The Breach** (hive) — BEST IMPLEMENTED, expand
   297→- Already loads all 7 hive GLBs via HiveEnvironmentBuilder
   298→- Increase structure density: 10-15 → 30-40 placements
   299→- More captured vehicles: wraith x3, phantom x1 (absorbed by organic growth)
   300→- Line tunnel walls with scaled-down `building_claw.glb` as ribbing
   301→
   302→**Level 8: Hive Assault** (combined_arms) — surface-to-hive transition
   303→- First half: dynamic terrain + `marcus_mech.glb` + wraith enemies + forward base (station segments)
   304→- Second half: HiveEnvironmentBuilder for hive interior
   305→- Destroy objectives: `building_brain.glb` x3 as nexus nodes
   306→
   307→**Level 9: Extraction** (extraction) — collapsing hive + holdout
   308→- Escape phase: HiveEnvironmentBuilder structures that collapse (animated position + particles)
   309→- LZ Omega: dynamic terrain (200m x 200m), landing pad, barrel barricades, wrecked machinery
   310→- Marcus mech holding the line; phantom.glb arrives for extraction
   311→
   312→**Level 10: Final Escape** (finale) — collapsing terrain chase
   313→- Dynamic terrain segments that disappear behind player
   314→- Hive structures erupting: `building_claw.glb`, `building_crystals.glb`, `building_birther.glb`
   315→- Falling `beam_hc_horizonatal_1.glb` as structural debris
   316→- Firestorm: DirectionalLight `#FF6020`, intensity 3.0, dense red-orange fog
   317→
   318→### 5D. Update AssetManifest.ts
   319→- Add station/prop/structure models to each level&#x27;s manifest `required` and `preload` arrays
   320→- Move deferred assets to preload where needed for environment (shelves, machinery, lamps)
   321→
   322→---
   323→
   324→## Phase 6: Documentation &amp; Tests
   325→
   326→### 6A. Update docs
   327→- `docs/LEVELS.md`: Update campaign structure to 10 levels (currently shows 6), add Mining Depths as bonus
   328→- `docs/ARCHITECTURE.md`: Add CampaignDirector to architecture diagram
   329→- `docs/ASSET-INTEGRATION.md`: Update with model-based environment patterns
   330→
   331→### 6B. Refactor tests (breaking is OK)
   332→- Update `src/game/context/GameContext.test.tsx` for CampaignPhase instead of GameState
   333→- Update `e2e/game-flow.spec.ts` for new splash → title → menu flow
   334→- Update `e2e/playthrough.spec.ts` for CampaignDirector dispatch API
   335→- Add: `src/game/campaign/CampaignDirector.test.ts` (state machine transitions)
   336→- Add: `e2e/levels/mining-depths.spec.ts` (bonus level access from FOB Delta)
   337→
   338→---
   339→
   340→## Phase 7: Validation
   341→
   342→1. `npx tsc --noEmit` — 0 errors
   343→2. `npx vitest run` — all tests pass
   344→3. `npx biome check .` — 0 errors
   345→4. `npx vite build` — succeeds with PWA
   346→5. Manual smoke: Splash → Title → Menu → New Game → IntroBriefing (once) → Briefing → Tutorial (Barracks start) → HALO Drop → Canyon Run → FOB Delta → Mining Depths (bonus) → Brothers → Southern Ice → The Breach → Hive Assault → Extraction → Final Escape → Credits
   347→6. Continue: loads saved level directly (skips intro briefing)
   348→7. URL param: `?level=fob_delta` loads FOB Delta directly
   349→8. All 9-slice buttons render correctly across menu screens
   350→9. Splash video plays in both orientations, skippable
   351→
   352→---
   353→
   354→## Asset Gap Report
   355→
   356→### Critical (must acquire/create)
   357→| Asset | Needed For | Action |
   358→|-------|-----------|--------|
   359→| Rock terrain texture (256x256) | 6 surface levels | Download ambientCG &quot;Rock043&quot; or tint `concrete_hr_1.png` |
   360→| Ice/snow texture (256x256) | Southern Ice | Download ambientCG &quot;Snow006&quot; or white-tint `concrete_hr_1.png` |
   361→| Sand texture (256x256) | Canyon Run, Extraction | Download ambientCG &quot;Ground037&quot; or tan-tint existing |
   362→
   363→### High Priority (strongly desired)
   364→| Asset | Current Proxy | Notes |
   365→|-------|--------------|-------|
   366→| Barracks bunks/beds | `shelf_mx_1.glb` on side | MeshBuilder box beds also acceptable |
   367→| Weapon rack | `shelf_mx_1.glb` | Functional proxy |
   368→| Terminal/console | `electrical_equipment_1.glb` | Functional proxy |
   369→| Drop pod | Procedural cylinder | Keep procedural for now |
   370→| Sandbag walls | Lined-up `metal_barrel` | Functional proxy |
   371→| Marine NPC | None | Use `alienmale.glb` as placeholder humanoid |
   372→
   373→### Existing Assets (47 GLBs) — ALL used across levels
   374→| Category | Count | Used By |
   375→|----------|-------|---------|
   376→| Station (17) | 17 | Anchor Station, FOB Delta, Southern Ice outpost, Extraction debris |
   377→| Props (13) | 13 | All levels (barrels, boxes, lamps, shelves, machinery, pipes) |
   378→| Hive (7) | 7 | The Breach, Hive Assault, Extraction, Final Escape, Brothers (sinkhole) |
   379→| Enemies (8) | 8 | All combat levels |
   380→| Vehicles (3) | 3 | Brothers (marcus_mech), Canyon Run + Hive Assault (wraith), Extraction + Final Escape (phantom) |
   381→
   382→---
   383→
   384→## Implementation Order (all phases)
   385→
   386→| # | Task | Files | Breaks Tests? |
   387→|---|------|-------|---------------|
   388→| 1 | Move incoming-ui assets | public/video/, public/assets/ui/buttons/, vite.config.ts | No |
   389→| 2 | MilitaryButton component | NEW: MilitaryButton.tsx/.module.css | No |
   390→| 3 | Apply MilitaryButton to menus | MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, etc. | No |
   391→| 4 | SplashScreen component | NEW: SplashScreen.tsx/.module.css | No |
   392→| 5 | IntroBriefing component | NEW: IntroBriefing.tsx/.module.css, GameSave.ts, SaveSystem.ts | No |
   393→| 6 | Campaign types + MissionDefinitions | NEW: campaign/types.ts, MissionDefinitions.ts | No |
   394→| 7 | CampaignDirector class | NEW: campaign/CampaignDirector.ts, index.ts | No |
   395→| 8 | useCampaign hook | NEW: campaign/useCampaign.ts | No |
   396→| 9 | Fix LevelManager require() | LevelManager.ts line 203 | No |
   397→| 10 | Fix canyon factory + add mine factory | factories.ts, types.ts | No |
   398→| 11 | Wire vehicles into levels | CanyonRunLevel.ts, HiveAssaultLevel.ts, FinalEscapeLevel.ts | No |
   399→| 12 | Wire ReyesDialogue | CampaignDirector.ts, types.ts (add onDialogueTrigger) | No |
   400→| 13 | Wire Mining Depths bonus level | MissionDefinitions.ts, FOBDeltaLevel.ts | No |
   401→| 14 | SurfaceTerrainFactory | NEW: shared/SurfaceTerrainFactory.ts | No |
   402→| 15 | ModularBaseBuilder | NEW: shared/ModularBaseBuilder.ts | No |
   403→| 16 | Extract HiveEnvironmentBuilder | Move the-breach/env → shared/ | No |
   404→| 17 | Anchor Station barracks room | AnchorStationLevel.ts, ModularStationBuilder.ts | Maybe |
   405→| 18 | FOB Delta model conversion | FOBDeltaLevel.ts, fob-delta/environment.ts | Maybe |
   406→| 19 | Brothers in Arms GLB mech | BrothersInArmsLevel.ts | Maybe |
   407→| 20 | Landfall surface terrain | LandfallLevel.ts | Maybe |
   408→| 21 | Canyon Run terrain conversion | CanyonRunLevel.ts, canyon-run/environment.ts | Maybe |
   409→| 22 | Remaining level environments | SouthernIce, HiveAssault, Extraction, FinalEscape | Maybe |
   410→| 23 | **Unify GameCanvas** | GameCanvas.tsx (remove dual path) | **Yes** |
   411→| 24 | **Simplify App.tsx** | App.tsx (replace callbacks with useCampaign) | **Yes** |
   412→| 25 | Wire achievements + collectibles + objectives | CampaignDirector.ts | No |
   413→| 26 | Update AssetManifest.ts | AssetManifest.ts | No |
   414→| 27 | Refactor tests | GameContext.test.tsx, e2e/*.spec.ts, NEW: CampaignDirector.test.ts | **Yes** |
   415→| 28 | Update documentation | docs/LEVELS.md, ARCHITECTURE.md, ASSET-INTEGRATION.md | No |
   416→| 29 | Validate: tsc, vitest, biome, vite build | — | — |
   417→</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-06-56-485Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-06-56-485Z" class="timestamp-link"><time datetime="2026-01-30T19:06:56.485Z" data-timestamp="2026-01-30T19:06:56.485Z">2026-01-30T19:06:56.485Z</time></a></div><div class="message-content">
<div class="assistant-text"><p>The plan file is complete. Let me submit it for approval.</p></div></div></div>
<div class="message assistant" id="msg-2026-01-30T19-06-57-030Z"><div class="message-header"><span class="role-label">Assistant</span><a href="#msg-2026-01-30T19-06-57-030Z" class="timestamp-link"><time datetime="2026-01-30T19:06:57.030Z" data-timestamp="2026-01-30T19:06:57.030Z">2026-01-30T19:06:57.030Z</time></a></div><div class="message-content">
<div class="tool-use" data-tool-id="toolu_017V5HNRfEUsSLckbnABNrEN"><div class="tool-header"><span class="tool-icon">⚙</span> ExitPlanMode</div><div class="truncatable"><div class="truncatable-content"><pre class="json">{
  &#34;plan&#34;: &#34;# Plan: CampaignDirector + Model Environments + Splash/UI Polish\n\n## Summary\n\nBuild Stellar Descent into a complete, atmospheric 10-level campaign by:\n1. Creating a **CampaignDirector** as the game&#39;s spine (replaces 15 scattered App.tsx callbacks)\n2. Converting **all levels from procedural geometry to GLB model-based environments**\n3. Adding **splash screen** with incoming-ui videos, **9-slice military buttons**, and **condensed intro briefing**\n4. **Wiring ALL disconnected systems**: Mining Depths, vehicles, ReyesDialogue, achievements, collectibles, objectives\n5. Nothing gets removed — everything gets used\n\n## Core Insight\n\n`tutorial` and `dropping` are NOT separate game phases — they are gameplay mechanics WITHIN AnchorStationLevel and LandfallLevel. Both implement ILevel. CampaignDirector has a `playing` phase that covers ALL active gameplay. Each level manages its own internal phases.\n\n---\n\n## Phase 1: Assets &amp; UI Foundation\n\n### 1A. Move incoming-ui assets to public/\n- `incoming-ui/splash-16-9.mp4` → `public/video/splash-16-9.mp4`\n- `incoming-ui/splash-9-16.mp4` → `public/video/splash-9-16.mp4`\n- `incoming-ui/assets/ui/buttons/*.png` → `public/assets/ui/buttons/*.png`\n- Update `vite.config.ts`: add `*.mp4` to PWA workbox runtime caching (CacheFirst, not precache — 12MB each)\n\n### 1B. MilitaryButton component (9-slice)\n**New files:** `src/components/ui/MilitaryButton.tsx`, `MilitaryButton.module.css`\n\nCSS `border-image` technique using the 4 button PNGs:\n```css\nborder-image-source: url(&#39;/assets/ui/buttons/btn_military_olive_normal.png&#39;);\nborder-image-slice: 64 96 64 96 fill;\nborder-image-width: 32px;\nborder-image-repeat: stretch;\n```\nStates: `:hover` → hover.png, `:active` → pressed.png, `:disabled` → disabled.png\n\nProps: `children, onClick, disabled, variant (&#39;primary&#39;|&#39;default&#39;|&#39;danger&#39;), size (&#39;sm&#39;|&#39;md&#39;|&#39;lg&#39;)`\n\nPreload all 4 PNGs via `&lt;link rel=\&#34;preload\&#34;&gt;` in index.html.\n\n### 1C. Apply MilitaryButton to all menus\nReplace `&lt;button&gt;` elements in: MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, LevelCompletionScreen.tsx, MissionBriefing.tsx, SettingsMenu.tsx, confirmation modals.\n\n### 1D. SplashScreen component\n**New files:** `src/components/ui/SplashScreen.tsx`, `SplashScreen.module.css`\n\n- Detect orientation via `matchMedia(&#39;(orientation: portrait)&#39;)` — pick correct video\n- `&lt;video&gt;` with `playsInline`, `muted` (autoplay policy), `autoPlay`\n- Tap/keypress to skip, `onEnded` → transition to title sequence\n- Handle orientation change mid-playback: two `&lt;video&gt;` elements, toggle visibility, sync `currentTime`\n- z-index: 1100 (above all UI)\n- Flow: `splash` → `title` → `menu`\n\n### 1E. Condensed Intro Briefing\n**New files:** `src/components/ui/IntroBriefing.tsx`, `IntroBriefing.module.css`\n\n- **Condense text** from 20+ lines @ 80ms/char to ~10 lines @ 40ms/char:\n  ```\n  PRIORITY ALPHA // TEA COMMAND\n  Recon Team VANGUARD deployed to PCb-7. 72 hours ago.\n  FOB DELTA established. Then silence.\n  All contact lost. No distress signal.\n  Something woke beneath the surface.\n  Find your brother. Find the truth.\n  &gt;&gt;&gt; SPECTER: CLEARED FOR ORBITAL DROP &lt;&lt;&lt;\n  ```\n- Add `seenIntroBriefing: boolean` to `GameSave` interface (bump SAVE_FORMAT_VERSION to 3)\n- Trigger ONCE after New Game → save flag → skip on subsequent plays/Continue\n- Visual: black bg, scan lines, \&#34;BARRACKS // ANCHOR STATION PROMETHEUS\&#34; header, typing text, \&#34;ACKNOWLEDGED\&#34; MilitaryButton\n- Flow: New Game → (if !seenIntroBriefing) → IntroBriefing → briefing → tutorial\n\n---\n\n## Phase 2: Campaign Foundation (additive, no breaking changes)\n\n### 2A. Campaign types\n**New file:** `src/game/campaign/types.ts` (~80 lines)\n\n```typescript\ntype CampaignPhase = &#39;idle&#39; | &#39;splash&#39; | &#39;menu&#39; | &#39;briefing&#39; | &#39;intro&#39;\n  | &#39;loading&#39; | &#39;playing&#39; | &#39;paused&#39; | &#39;levelComplete&#39; | &#39;gameover&#39; | &#39;credits&#39;;\n\ntype CampaignCommand =\n  | { type: &#39;NEW_GAME&#39;; difficulty?: DifficultyLevel }\n  | { type: &#39;CONTINUE&#39; }\n  | { type: &#39;SELECT_LEVEL&#39;; levelId: LevelId }\n  | { type: &#39;BEGIN_MISSION&#39; }\n  | { type: &#39;INTRO_COMPLETE&#39; }\n  | { type: &#39;LOADING_COMPLETE&#39; }\n  | { type: &#39;LEVEL_COMPLETE&#39;; stats: LevelStats }\n  | { type: &#39;ADVANCE&#39; }\n  | { type: &#39;RETRY&#39; }\n  | { type: &#39;PAUSE&#39; } | { type: &#39;RESUME&#39; }\n  | { type: &#39;PLAYER_DIED&#39; }\n  | { type: &#39;MAIN_MENU&#39; }\n  | { type: &#39;CREDITS_DONE&#39; }\n  | { type: &#39;ENTER_BONUS_LEVEL&#39;; levelId: string }\n  | { type: &#39;BONUS_COMPLETE&#39; };\n\ninterface CampaignSnapshot { phase, currentLevelId, currentLevelConfig, isBonusLevel, levelKills, levelStartTime }\ninterface MissionDefinition { levelId, objectives[], vehicleIds?, dialogueTriggers?, audioLogCount, secretCount, skullId?, hasBonusAccess? }\n```\n\n### 2B. MissionDefinitions\n**New file:** `src/game/campaign/MissionDefinitions.ts` (~250 lines)\n\nStatic `MISSION_DEFINITIONS: Record&lt;LevelId, MissionDefinition&gt;` with:\n- Per-level objectives (primary + optional)\n- Vehicle availability (Canyon Run: wraith_tank; Hive Assault: wraith_tank + phantom; Final Escape: phantom)\n- Dialogue triggers for ReyesDialogue\n- Audio log / secret / skull counts\n- `hasBonusAccess: &#39;mining_depths&#39;` on FOB Delta\n\n`BONUS_LEVELS` record for Mining Depths (not in main linked list, preserves 10-level campaign).\n\n### 2C. CampaignDirector\n**New file:** `src/game/campaign/CampaignDirector.ts` (~350 lines)\n\nState machine with `dispatch(command)` as the ONLY public API. Internally:\n- Owns `LevelManager` (existing class, currently unused — activates it)\n- Owns `ReyesDialogueManager` (from `audio/ReyesDialogue.ts`, 822 LOC — never imported, now wired)\n- Creates per-level collectible systems (AudioLogSystem, SecretAreaSystem, SkullPickupManager)\n- Builds `LevelCallbacks` that wire achievements, save objectives, trigger Reyes dialogue\n- React integration via `subscribe()` / `getSnapshot()` pattern (useSyncExternalStore)\n\nKey methods:\n- `attach(engine, canvas)` / `detach()` — bind to BabylonJS\n- `dispatch(command)` — all state transitions\n- `buildLevelCallbacks()` — THE wiring hub connecting levels to saves/achievements/dialogue/collectibles\n- `handleLevelComplete(stats)` — per-level achievement triggers (all 7+ disconnected methods)\n- `initializeCollectibles(levelId)` — creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level\n\n### 2D. useCampaign hook\n**New file:** `src/game/campaign/useCampaign.ts` (~30 lines)\n\n```typescript\nfunction useCampaign(): [CampaignSnapshot, (cmd: CampaignCommand) =&gt; void]\n```\n\nUses `useSyncExternalStore` with CampaignDirector singleton. Replaces all 15 useCallback hooks in App.tsx.\n\n### 2E. Campaign index + tests\n**New file:** `src/game/campaign/index.ts` (barrel exports + singleton)\n**New file:** `src/game/campaign/CampaignDirector.test.ts` (state machine transition tests)\n\n---\n\n## Phase 3: Wire LevelManager + Fix Factories\n\n### 3A. Fix LevelManager\n- `src/game/levels/LevelManager.ts` line 203: replace `require()` with static import\n- Wire into CampaignDirector&#39;s `startCurrentLevel()` method\n\n### 3B. Fix canyon factory\n- `src/game/levels/factories.ts`: replace `canyonLevelFactory` throw with `new SurfaceLevel(engine, canvas, config, callbacks)` — generic canyon infantry level\n- Add `mineLevelFactory` for MiningDepthsLevel\n- Add `&#39;mine&#39;` to `LevelType` union and `LevelFactoryRegistry`\n\n### 3C. Wire Mining Depths as bonus level\n- Add `mining_depths` to `BONUS_LEVELS` in MissionDefinitions.ts\n- FOB Delta level triggers `dispatch({ type: &#39;ENTER_BONUS_LEVEL&#39;, levelId: &#39;mining_depths&#39; })` when player interacts with Mining Outpost Gamma-7 terminal\n- CampaignDirector saves `returnLevelId = &#39;brothers_in_arms&#39;` (next campaign level)\n- On bonus complete, return to campaign flow\n\n### 3D. Wire vehicles into levels\n- Canyon Run (`CanyonRunLevel.ts`): instantiate `WraithTank` as enemy vehicle, spawn along route\n- Hive Assault (`HiveAssaultLevel.ts`): instantiate `WraithTank` for player vehicle phase + `PhantomDropship` for supply drops\n- Final Escape (`FinalEscapeLevel.ts`): instantiate `PhantomDropship` as escape transport\n- Each: import from `../vehicles/`, create in `createEnvironment()`, update in `updateLevel()`, dispose in `disposeLevel()`\n\n### 3E. Wire ReyesDialogue\n- CampaignDirector owns `ReyesDialogueManager` singleton\n- Calls `reyes.playBriefing(levelId)` on level start\n- Wires `onCombatStateChange` → `reyes.triggerDialogue(&#39;hostiles_detected&#39;/&#39;hostiles_cleared&#39;)`\n- Wires `onHealthChange` → health warning triggers\n- Add `onDialogueTrigger?: (trigger: string) =&gt; void` to `LevelCallbacks` for level-initiated triggers\n\n### 3F. Wire achievements\nCampaignDirector&#39;s `handleLevelComplete()` calls per-level achievement triggers:\n| Level | Achievement trigger |\n|-------|-------------------|\n| anchor_station | `onTutorialComplete()` |\n| landfall | `onHaloDropComplete()`, `onFirstCombatWin()` |\n| canyon_run | `onCanyonRunComplete()` |\n| brothers_in_arms | `onMarcusFound()`, `onBrothersInArmsComplete()` |\n| southern_ice | `onSouthernIceComplete()` |\n| the_breach | `onQueenDefeated()` |\n| hive_assault | `onHiveAssaultComplete()` |\n| extraction | `onExtractionComplete()` |\n| final_escape | `onFinalEscapeComplete()`, `onGameComplete()` |\n\nPlus: `onKill` / `onDamageTaken` / `onAudioLogFound` / `onSecretFound` via callbacks.\n\n### 3G. Wire collectibles + objectives\n- CampaignDirector creates AudioLogSystem, SecretAreaSystem, SkullPickupManager per level\n- Callbacks wire to `saveSystem.setLevelFlag(levelId, &#39;audiolog_X&#39;, true)`\n- `onObjectiveUpdate` populates `GameSave.objectives` (currently always empty)\n\n---\n\n## Phase 4: Unify GameCanvas + Simplify App.tsx\n\n### 4A. Unify GameCanvas rendering\n- Remove `gameManagerRef` and `GameManager` import\n- Remove dual rendering paths (`tutorialLevelRef` vs `gameManagerRef`)\n- Single `activeLevelRef` for the render loop\n- CampaignDirector controls level lifecycle; GameCanvas receives `campaign` snapshot + `dispatch` as props\n- Render loop: `activeLevel?.update(dt) + activeLevel.getScene().render()` OR `menuScene.render()`\n- Remove `GameState` type from GameCanvas (use `CampaignPhase` from campaign/types.ts)\n\n### 4B. Simplify App.tsx (~700 → ~300 lines)\n- Replace 15 `useCallback` hooks with `useCampaign()` returning `[snapshot, dispatch]`\n- Replace `gameState` with `snapshot.phase`\n- Remove: `skipTutorial`, `startLevelId`, `briefingLevelId`, `completionStats`, `restartKey`, `levelStartTimeRef`\n- Add phases: `&#39;splash&#39;`, `&#39;introBriefing&#39;`\n- UI rendering becomes simple phase switch:\n  ```tsx\n  {phase === &#39;splash&#39; &amp;&amp; &lt;SplashScreen onComplete={() =&gt; dispatch({ type: &#39;MAIN_MENU&#39; })} /&gt;}\n  {phase === &#39;menu&#39; &amp;&amp; &lt;MainMenu dispatch={dispatch} /&gt;}\n  {phase === &#39;briefing&#39; &amp;&amp; &lt;MissionBriefing dispatch={dispatch} /&gt;}\n  {phase === &#39;playing&#39; &amp;&amp; &lt;HUD /&gt;}\n  // etc.\n  ```\n\n---\n\n## Phase 5: Model-Based Level Environments\n\n### 5A. Shared infrastructure\n**New file:** `src/game/levels/shared/SurfaceTerrainFactory.ts`\n- `createDynamicTerrain(scene, config)` → `GroundMesh`\n- Uses `CreateGroundFromHeightMap` with seeded procedural heightmap\n- Tiled texture support (ambientCG or PSX fallback)\n- Used by: Landfall, Canyon Run, Brothers, Southern Ice, Extraction, Final Escape\n\n**New file:** `src/game/levels/shared/ModularBaseBuilder.ts`\n- Generalized `ModularStationBuilder` with `DamageConfig` parameter\n- Controls `wall_hr_1_hole_1.glb` ratio for battle damage\n- Prop scattering with `PropPlacement[]`\n- Flickering lamp placement with `LightingConfig`\n- Used by: FOB Delta, Southern Ice outpost\n\n**Move:** `the-breach/HiveEnvironmentBuilder` → `shared/HiveEnvironmentBuilder.ts`\n- Used by: The Breach, Hive Assault, Extraction (escape phase), Final Escape (erupting structures)\n\n### 5B. Download ambientCG textures (3 critical)\n- Rock terrain (rust-brown): for Landfall, Canyon Run, Brothers, Extraction, Final Escape\n- Ice/snow: for Southern Ice\n- Sand: for Canyon Run, Extraction\n\nFallback: tint existing `concrete_hr_1.png` and `wall_hr_1.png`\n\n### 5C. Per-level environment conversion\n\n**Level 1: Anchor Station** (station) — PARTIALLY DONE, enhance\n- Already uses ModularStationBuilder with GLB corridors\n- ADD: Barracks room (3 new corridor segments at north end, shelves as bunks, lamps, barrels)\n- ADD: Industrial props in Equipment Bay/Engine Room (machinery, pipes, electrical, shelves)\n- Move player spawn to barracks center\n\n**Level 2: Landfall** (drop → surface) — surface phase needs terrain\n- Freefall: keep procedural asteroids (justified), add PSX textures\n- Surface: replace MeshBuilder.CreateGround → `SurfaceTerrainFactory.createDynamicTerrain()`\n- Add barrels/boxes as cover props around LZ\n- Sky: layered dome (dust haze inner + starfield outer), dust particles, EXP2 fog\n\n**Level 3: Canyon Run** (vehicle) — FULL CONVERSION\n- Replace box-based canyon walls → heightmap terrain strips (left wall, floor, right wall)\n- Bridges: `beam_hc_horizonatal_1.glb` spanning canyon + `floor_ceiling_hr_1.glb` surfaces\n- Obstacles: barrels, machinery, cardboard boxes along route\n- Enemy vehicles: `wraith.glb` pursuers\n- Alien roadblocks: `building_claw.glb`\n\n**Level 4: FOB Delta** (base) — FULL CONVERSION\n- Replace all procedural geometry → `ModularBaseBuilder` with damage state\n- ~25-30 corridor segments forming perimeter, courtyard, barracks, command, vehicle bay\n- 40% walls use `wall_hr_1_hole_1.glb` (battle damage)\n- Overturned shelves, scattered props, flickering lamps\n- Courtyard: open-air section with floor_ceiling tiles as ground pad\n- Horror lighting: variable flicker 0.5-1.5 intensity, emergency red in barracks\n\n**Level 5: Brothers in Arms** (brothers) — CRITICAL FIX\n- Replace procedural box mech → `marcus_mech.glb` (589 KB)\n- Canyon arena: `SurfaceTerrainFactory.createDynamicTerrain()` (200m x 150m)\n- The Breach sinkhole: depression in heightmap, ringed with `building_crystals.glb` + `building_undercrystal.glb` + `building_claw.glb`\n- Bioluminescent glow from sinkhole: PointLight `#4AC8C8`\n\n**Level 6: Southern Ice** (ice) — enhance\n- Terrain: `SurfaceTerrainFactory` with ice/snow material\n- Ice caves: keep procedural cylinders, ADD `building_crystals.glb` + `building_undercrystal.glb` inside\n- Abandoned outpost: `ModularBaseBuilder` (6-8 segments, storm damage)\n- Aurora: keep existing procedural animated strips\n- Blizzard: 1000+ white particles, dense fog\n\n**Level 7: The Breach** (hive) — BEST IMPLEMENTED, expand\n- Already loads all 7 hive GLBs via HiveEnvironmentBuilder\n- Increase structure density: 10-15 → 30-40 placements\n- More captured vehicles: wraith x3, phantom x1 (absorbed by organic growth)\n- Line tunnel walls with scaled-down `building_claw.glb` as ribbing\n\n**Level 8: Hive Assault** (combined_arms) — surface-to-hive transition\n- First half: dynamic terrain + `marcus_mech.glb` + wraith enemies + forward base (station segments)\n- Second half: HiveEnvironmentBuilder for hive interior\n- Destroy objectives: `building_brain.glb` x3 as nexus nodes\n\n**Level 9: Extraction** (extraction) — collapsing hive + holdout\n- Escape phase: HiveEnvironmentBuilder structures that collapse (animated position + particles)\n- LZ Omega: dynamic terrain (200m x 200m), landing pad, barrel barricades, wrecked machinery\n- Marcus mech holding the line; phantom.glb arrives for extraction\n\n**Level 10: Final Escape** (finale) — collapsing terrain chase\n- Dynamic terrain segments that disappear behind player\n- Hive structures erupting: `building_claw.glb`, `building_crystals.glb`, `building_birther.glb`\n- Falling `beam_hc_horizonatal_1.glb` as structural debris\n- Firestorm: DirectionalLight `#FF6020`, intensity 3.0, dense red-orange fog\n\n### 5D. Update AssetManifest.ts\n- Add station/prop/structure models to each level&#39;s manifest `required` and `preload` arrays\n- Move deferred assets to preload where needed for environment (shelves, machinery, lamps)\n\n---\n\n## Phase 6: Documentation &amp; Tests\n\n### 6A. Update docs\n- `docs/LEVELS.md`: Update campaign structure to 10 levels (currently shows 6), add Mining Depths as bonus\n- `docs/ARCHITECTURE.md`: Add CampaignDirector to architecture diagram\n- `docs/ASSET-INTEGRATION.md`: Update with model-based environment patterns\n\n### 6B. Refactor tests (breaking is OK)\n- Update `src/game/context/GameContext.test.tsx` for CampaignPhase instead of GameState\n- Update `e2e/game-flow.spec.ts` for new splash → title → menu flow\n- Update `e2e/playthrough.spec.ts` for CampaignDirector dispatch API\n- Add: `src/game/campaign/CampaignDirector.test.ts` (state machine transitions)\n- Add: `e2e/levels/mining-depths.spec.ts` (bonus level access from FOB Delta)\n\n---\n\n## Phase 7: Validation\n\n1. `npx tsc --noEmit` — 0 errors\n2. `npx vitest run` — all tests pass\n3. `npx biome check .` — 0 errors\n4. `npx vite build` — succeeds with PWA\n5. Manual smoke: Splash → Title → Menu → New Game → IntroBriefing (once) → Briefing → Tutorial (Barracks start) → HALO Drop → Canyon Run → FOB Delta → Mining Depths (bonus) → Brothers → Southern Ice → The Breach → Hive Assault → Extraction → Final Escape → Credits\n6. Continue: loads saved level directly (skips intro briefing)\n7. URL param: `?level=fob_delta` loads FOB Delta directly\n8. All 9-slice buttons render correctly across menu screens\n9. Splash video plays in both orientations, skippable\n\n---\n\n## Asset Gap Report\n\n### Critical (must acquire/create)\n| Asset | Needed For | Action |\n|-------|-----------|--------|\n| Rock terrain texture (256x256) | 6 surface levels | Download ambientCG \&#34;Rock043\&#34; or tint `concrete_hr_1.png` |\n| Ice/snow texture (256x256) | Southern Ice | Download ambientCG \&#34;Snow006\&#34; or white-tint `concrete_hr_1.png` |\n| Sand texture (256x256) | Canyon Run, Extraction | Download ambientCG \&#34;Ground037\&#34; or tan-tint existing |\n\n### High Priority (strongly desired)\n| Asset | Current Proxy | Notes |\n|-------|--------------|-------|\n| Barracks bunks/beds | `shelf_mx_1.glb` on side | MeshBuilder box beds also acceptable |\n| Weapon rack | `shelf_mx_1.glb` | Functional proxy |\n| Terminal/console | `electrical_equipment_1.glb` | Functional proxy |\n| Drop pod | Procedural cylinder | Keep procedural for now |\n| Sandbag walls | Lined-up `metal_barrel` | Functional proxy |\n| Marine NPC | None | Use `alienmale.glb` as placeholder humanoid |\n\n### Existing Assets (47 GLBs) — ALL used across levels\n| Category | Count | Used By |\n|----------|-------|---------|\n| Station (17) | 17 | Anchor Station, FOB Delta, Southern Ice outpost, Extraction debris |\n| Props (13) | 13 | All levels (barrels, boxes, lamps, shelves, machinery, pipes) |\n| Hive (7) | 7 | The Breach, Hive Assault, Extraction, Final Escape, Brothers (sinkhole) |\n| Enemies (8) | 8 | All combat levels |\n| Vehicles (3) | 3 | Brothers (marcus_mech), Canyon Run + Hive Assault (wraith), Extraction + Final Escape (phantom) |\n\n---\n\n## Implementation Order (all phases)\n\n| # | Task | Files | Breaks Tests? |\n|---|------|-------|---------------|\n| 1 | Move incoming-ui assets | public/video/, public/assets/ui/buttons/, vite.config.ts | No |\n| 2 | MilitaryButton component | NEW: MilitaryButton.tsx/.module.css | No |\n| 3 | Apply MilitaryButton to menus | MainMenu.tsx, PauseMenu.tsx, DeathScreen.tsx, etc. | No |\n| 4 | SplashScreen component | NEW: SplashScreen.tsx/.module.css | No |\n| 5 | IntroBriefing component | NEW: IntroBriefing.tsx/.module.css, GameSave.ts, SaveSystem.ts | No |\n| 6 | Campaign types + MissionDefinitions | NEW: campaign/types.ts, MissionDefinitions.ts | No |\n| 7 | CampaignDirector class | NEW: campaign/CampaignDirector.ts, index.ts | No |\n| 8 | useCampaign hook | NEW: campaign/useCampaign.ts | No |\n| 9 | Fix LevelManager require() | LevelManager.ts line 203 | No |\n| 10 | Fix canyon factory + add mine factory | factories.ts, types.ts | No |\n| 11 | Wire vehicles into levels | CanyonRunLevel.ts, HiveAssaultLevel.ts, FinalEscapeLevel.ts | No |\n| 12 | Wire ReyesDialogue | CampaignDirector.ts, types.ts (add onDialogueTrigger) | No |\n| 13 | Wire Mining Depths bonus level | MissionDefinitions.ts, FOBDeltaLevel.ts | No |\n| 14 | SurfaceTerrainFactory | NEW: shared/SurfaceTerrainFactory.ts | No |\n| 15 | ModularBaseBuilder | NEW: shared/ModularBaseBuilder.ts | No |\n| 16 | Extract HiveEnvironmentBuilder | Move the-breach/env → shared/ | No |\n| 17 | Anchor Station barracks room | AnchorStationLevel.ts, ModularStationBuilder.ts | Maybe |\n| 18 | FOB Delta model conversion | FOBDeltaLevel.ts, fob-delta/environment.ts | Maybe |\n| 19 | Brothers in Arms GLB mech | BrothersInArmsLevel.ts | Maybe |\n| 20 | Landfall surface terrain | LandfallLevel.ts | Maybe |\n| 21 | Canyon Run terrain conversion | CanyonRunLevel.ts, canyon-run/environment.ts | Maybe |\n| 22 | Remaining level environments | SouthernIce, HiveAssault, Extraction, FinalEscape | Maybe |\n| 23 | **Unify GameCanvas** | GameCanvas.tsx (remove dual path) | **Yes** |\n| 24 | **Simplify App.tsx** | App.tsx (replace callbacks with useCampaign) | **Yes** |\n| 25 | Wire achievements + collectibles + objectives | CampaignDirector.ts | No |\n| 26 | Update AssetManifest.ts | AssetManifest.ts | No |\n| 27 | Refactor tests | GameContext.test.tsx, e2e/*.spec.ts, NEW: CampaignDirector.test.ts | **Yes** |\n| 28 | Update documentation | docs/LEVELS.md, ARCHITECTURE.md, ASSET-INTEGRATION.md | No |\n| 29 | Validate: tsc, vitest, biome, vite build | — | — |\n&#34;
}</pre></div><button class="expand-btn">Show more</button></div></div></div></div>
        

<div class="pagination">
<a href="index.html" class="index-link">Index</a>
<a href="page-036.html">&larr; Prev</a>
<a href="page-001.html">1</a>
<a href="page-002.html">2</a>
<a href="page-003.html">3</a>
<a href="page-004.html">4</a>
<a href="page-005.html">5</a>
<a href="page-006.html">6</a>
<a href="page-007.html">7</a>
<a href="page-008.html">8</a>
<a href="page-009.html">9</a>
<a href="page-010.html">10</a>
<a href="page-011.html">11</a>
<a href="page-012.html">12</a>
<a href="page-013.html">13</a>
<a href="page-014.html">14</a>
<a href="page-015.html">15</a>
<a href="page-016.html">16</a>
<a href="page-017.html">17</a>
<a href="page-018.html">18</a>
<a href="page-019.html">19</a>
<a href="page-020.html">20</a>
<a href="page-021.html">21</a>
<a href="page-022.html">22</a>
<a href="page-023.html">23</a>
<a href="page-024.html">24</a>
<a href="page-025.html">25</a>
<a href="page-026.html">26</a>
<a href="page-027.html">27</a>
<a href="page-028.html">28</a>
<a href="page-029.html">29</a>
<a href="page-030.html">30</a>
<a href="page-031.html">31</a>
<a href="page-032.html">32</a>
<a href="page-033.html">33</a>
<a href="page-034.html">34</a>
<a href="page-035.html">35</a>
<a href="page-036.html">36</a>
<span class="current">37</span>
<span class="disabled">Next &rarr;</span>
</div>

    </div>
    <script>
document.querySelectorAll('time[data-timestamp]').forEach(function(el) {
    const timestamp = el.getAttribute('data-timestamp');
    const date = new Date(timestamp);
    const now = new Date();
    const isToday = date.toDateString() === now.toDateString();
    const timeStr = date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' });
    if (isToday) { el.textContent = timeStr; }
    else { el.textContent = date.toLocaleDateString(undefined, { month: 'short', day: 'numeric' }) + ' ' + timeStr; }
});
document.querySelectorAll('pre.json').forEach(function(el) {
    let text = el.textContent;
    text = text.replace(/"([^"]+)":/g, '<span style="color: #ce93d8">"$1"</span>:');
    text = text.replace(/: "([^"]*)"/g, ': <span style="color: #81d4fa">"$1"</span>');
    text = text.replace(/: (\d+)/g, ': <span style="color: #ffcc80">$1</span>');
    text = text.replace(/: (true|false|null)/g, ': <span style="color: #f48fb1">$1</span>');
    el.innerHTML = text;
});
document.querySelectorAll('.truncatable').forEach(function(wrapper) {
    const content = wrapper.querySelector('.truncatable-content');
    const btn = wrapper.querySelector('.expand-btn');
    if (content.scrollHeight > 250) {
        wrapper.classList.add('truncated');
        btn.addEventListener('click', function() {
            if (wrapper.classList.contains('truncated')) { wrapper.classList.remove('truncated'); wrapper.classList.add('expanded'); btn.textContent = 'Show less'; }
            else { wrapper.classList.remove('expanded'); wrapper.classList.add('truncated'); btn.textContent = 'Show more'; }
        });
    }
});
</script>
</body>
</html>